<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: k8s - Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Warner&#039;s Wiki"><meta property="og:url" content="https://cqmmm.github.io/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cqmmm.github.io/img/og_image.png"><meta property="article:author" content="Warner"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cqmmm.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqmmm.github.io"},"headline":"Warner's Wiki","image":["https://cqmmm.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Warner"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://cqmmm.github.io/logo.jpg"}},"description":""}</script><link rel="icon" href="/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">k8s</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-03-30T13:23:16.000Z" title="3/30/2024, 9:23:16 PM">2024-03-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-03-30T15:52:40.200Z" title="3/30/2024, 11:52:40 PM">2024-03-30</time></span><span class="level-item">13 minutes read (About 2013 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/03/30/CoreDNS%E5%92%8CNodeLocalDNS%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/">CoreDNSå’ŒNodeLocalDNSçš„åŸŸåè§£æ</a></p><div class="content"><p>åœ¨ K8s ä¸­ï¼ŒDNS çš„è§£æä¸»è¦ç”¨è¿™ä¸¤ä¸ªå·¥å…·:</p>
<ol>
<li>CoreDNS: ä¸»è¦è´Ÿè´£é›†ç¾¤å†…éƒ¨åŸŸåè§£æ</li>
<li>NodeLocalDNS: æä¾› DNS ç¼“å­˜</li>
</ol>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹é›†ç¾¤ä¸­èŠ‚ç‚¹çš„ <code>/etc/resolv.conf</code> é…ç½®æ–‡ä»¶<br><a href="node-resolv-conf.png">node-resolv-conf</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šäº†æœç´¢åŸŸï¼Œå½“ä½¿ç”¨åŸŸåè§£æä¸»æœºåæ—¶ï¼Œå¦‚æœä¸»æœºåæ²¡æœ‰å®Œå…¨é™å®šï¼Œç³»ç»Ÿä¼šä¾æ¬¡å°è¯•åœ¨æŒ‡å®šçš„æœç´¢åŸŸä¸­è¿½åŠ æœç´¢åç¼€è¿›è¡Œè§£æ</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚è§£æ testï¼Œåˆ™ä¼šå°è¯•è§£æ test.default.svc.cluster.local å’Œ test.svc.cluster.local</span></span><br><span class="line">search default.svc.cluster.local svc.cluster.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># nodelocaldns æœåŠ¡å™¨çš„åœ°å€ï¼Œå¦‚æœé›†ç¾¤ä¸­æ²¡æœ‰ nodelocaldnsï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å°±ä¼šæ›¿æ¢æˆ CoreDNS çš„ SVC ClusterIP</span></span><br><span class="line">nameserver 169.254.25.10</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä»– DNS æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">nameserver 192.168.0.5</span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£æçš„åŸŸåæœ€å¤šåŒ…æ¶µ 2 ä¸ªç‚¹ï¼Œæœ€å¤šè¶…æ—¶ 2sï¼Œæœ€å¤šé‡è¯• 2 æ¬¡</span></span><br><span class="line"><span class="comment"># å‡è®¾è§£æaï¼Œä¼šå°è¯•è¿½åŠ  default.svc.cluster.local å’Œ svc.cluster.local</span></span><br><span class="line"><span class="comment"># å‡è®¾è§£æa.bï¼Œåˆ™ä¸ä¼šï¼Œé™¤é ndots &gt; 2</span></span><br><span class="line">options ndots:2 <span class="built_in">timeout</span>:2 attempts:2</span><br></pre></td></tr></table></figure>

<p>åœ¨ K8s ä¸­ï¼Œworkload çš„ dnsPolicy æœ‰å››ç§ç±»å‹:</p>
<ol>
<li>ClusterFirst: ä¸é…ç½®çš„é›†ç¾¤åŸŸåç¼€ä¸åŒ¹é…çš„ä»»ä½• DNS æŸ¥è¯¢ï¼ˆä¾‹å¦‚ â€œ<a target="_blank" rel="noopener" href="http://www.kubernetes.io")/">www.kubernetes.io&quot;ï¼‰</a> éƒ½ä¼šç”± DNS æœåŠ¡å™¨è½¬å‘åˆ°ä¸Šæ¸¸åç§°æœåŠ¡å™¨</li>
<li>Default: ä»è¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹ç»§æ‰¿åç§°è§£æé…ç½®</li>
<li>ClusterFirstWithHostNet: å¯¹äºä»¥ <code>hostNetwork</code> æ–¹å¼è¿è¡Œçš„ Podï¼Œåº”å°†å…¶ DNS ç­–ç•¥æ˜¾å¼è®¾ç½®ä¸º <code>ClusterFirstWithHostNet</code>ã€‚å¦åˆ™ï¼Œä»¥ <code>hostNetwork</code> æ–¹å¼å’Œ <code>ClusterFirst</code> ç­–ç•¥è¿è¡Œçš„ Pod å°†ä¼šåšå‡ºå›é€€è‡³ <code>Default</code> ç­–ç•¥çš„è¡Œä¸º</li>
<li>None: ä¼šä½¿ç”¨ <code>dnsConfig</code> æä¾›çš„ DNS é…ç½®</li>
</ol>
<h2 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h2><p>CoreDNS ä¸»è¦æ˜¯å¤æ‚é›†ç¾¤å†…éƒ¨åŸŸåçš„è§£æï¼Œä¿è¯ Pod ä¸ Pod åªè§å¯ä»¥é€šè¿‡ Service Name è¿›è¡Œé€šä¿¡ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä¸ºå®ƒæ·»åŠ é…ç½®ï¼Œä½¿å…¶èƒ½å¤Ÿè§£æé™æ€çš„ä¸€äº› Host ğŸ‘‡</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors &#123;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        health &#123;</span></span><br><span class="line"><span class="string">            lameduck 5s</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ready</span></span><br><span class="line"><span class="string">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span></span><br><span class="line"><span class="string">          pods insecure</span></span><br><span class="line"><span class="string">          fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        prometheus :9153</span></span><br><span class="line"><span class="string">        forward . /etc/resolv.conf &#123;</span></span><br><span class="line"><span class="string">          prefer_udp</span></span><br><span class="line"><span class="string">          max_concurrent 1000</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        hosts /etc/coredns/Hosts &#123;</span></span><br><span class="line"><span class="string">          ttl 60</span></span><br><span class="line"><span class="string">          reload 1m</span></span><br><span class="line"><span class="string">          fallthrough</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        loop</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">Hosts:</span> <span class="string">|+</span></span><br><span class="line">    <span class="number">192.168</span><span class="number">.0</span><span class="number">.10</span> <span class="string">cqm.com</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ª dnsPolicy ä¸º <code>ClusterFirst</code> çš„ busybox<br><img src="/bosybox.png" alt="bosybox"></p>
<p>é€šè¿‡è¿™ä¸ª busybox è§£æé›†ç¾¤å†…éƒ¨åŸŸåï¼Œé€šè¿‡ <code>tcpdump</code> è·å– 53 ç«¯å£çš„åŒ…<br><img src="/2024/03/30/CoreDNS%E5%92%8CNodeLocalDNS%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/%E9%80%9A%E8%BF%87coredns%E8%A7%A3%E6%9E%90%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8%E5%9F%9F%E5%90%8D.png" alt="é€šè¿‡corednsè§£æé›†ç¾¤å†…éƒ¨åŸŸå"></p>
<p>å¯ä»¥çœ‹åˆ°ä¼šæ ¹æ® search å¯¹ CoreDNS å‘èµ·å¤šæ¬¡è¯·æ±‚</p>
<p><code>Pod -&gt; CoreDNS -&gt; Pod</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@controller-node-1 ~]<span class="comment"># tcpdump -i any host 10.233.0.3 and 10.233.74.83 and port 53 -nnvvv</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">22:52:20.447820 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 37856, offset 0, flags [DF], proto UDP (17), length 82)</span><br><span class="line">    10.233.74.83.58663 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x6077 -&gt; 0x753d!] 33482+ A? kubernetes.default.svc.cluster.local. (54)</span><br><span class="line">22:52:20.447950 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 37857, offset 0, flags [DF], proto UDP (17), length 74)</span><br><span class="line">    10.233.74.83.58663 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x606f -&gt; 0xdd2e!] 53027+ A? kubernetes.svc.cluster.local. (46)</span><br><span class="line">22:52:20.447978 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 37858, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    10.233.74.83.58663 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x606b -&gt; 0x0aa3!] 30769+ A? kubernetes.cluster.local. (42)</span><br><span class="line">22:52:20.447999 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 37859, offset 0, flags [DF], proto UDP (17), length 82)</span><br><span class="line">    10.233.74.83.58663 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x6077 -&gt; 0x2dde!] 51726+ AAAA? kubernetes.default.svc.cluster.local. (54)</span><br><span class="line">22:52:20.448017 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 37860, offset 0, flags [DF], proto UDP (17), length 74)</span><br><span class="line">    10.233.74.83.58663 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x606f -&gt; 0xba24!] 61970+ AAAA? kubernetes.svc.cluster.local. (46)</span><br><span class="line">22:52:20.448038 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 37861, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    10.233.74.83.58663 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x606b -&gt; 0x7758!] 2913+ AAAA? kubernetes.cluster.local. (42)</span><br><span class="line">22:52:20.448407 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 32091, offset 0, flags [DF], proto UDP (17), length 163)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.58663: [bad udp <span class="built_in">cksum</span> 0x60c8 -&gt; 0xd926!] 2913 NXDomain*- q: AAAA? kubernetes.cluster.local. 0/1/0 ns: cluster.local. [5s] SOA ns.dns.cluster.local. hostmaster.cluster.local. 1711809447 7200 1800 86400 5 (135)</span><br><span class="line">22:52:20.448557 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 32092, offset 0, flags [DF], proto UDP (17), length 175)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.58663: [bad udp <span class="built_in">cksum</span> 0x60d4 -&gt; 0x8faf!] 51726*- q: AAAA? kubernetes.default.svc.cluster.local. 0/1/0 ns: cluster.local. [5s] SOA ns.dns.cluster.local. hostmaster.cluster.local. 1711809447 7200 1800 86400 5 (147)</span><br><span class="line">22:52:20.448654 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 32093, offset 0, flags [DF], proto UDP (17), length 163)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.58663: [bad udp <span class="built_in">cksum</span> 0x60c8 -&gt; 0x6c71!] 30769 NXDomain*- q: A? kubernetes.cluster.local. 0/1/0 ns: cluster.local. [5s] SOA ns.dns.cluster.local. hostmaster.cluster.local. 1711809447 7200 1800 86400 5 (135)</span><br><span class="line">22:52:20.448699 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 32094, offset 0, flags [DF], proto UDP (17), length 167)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.58663: [bad udp <span class="built_in">cksum</span> 0x60cc -&gt; 0x1bf3!] 61970 NXDomain*- q: AAAA? kubernetes.svc.cluster.local. 0/1/0 ns: cluster.local. [5s] SOA ns.dns.cluster.local. hostmaster.cluster.local. 1711809447 7200 1800 86400 5 (139)</span><br><span class="line">22:52:20.448761 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 32095, offset 0, flags [DF], proto UDP (17), length 134)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.58663: [bad udp <span class="built_in">cksum</span> 0x60ab -&gt; 0x24fc!] 33482*- q: A? kubernetes.default.svc.cluster.local. 1/0/0 kubernetes.default.svc.cluster.local. [5s] A 10.233.0.1 (106)</span><br><span class="line">22:52:20.448811 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 32096, offset 0, flags [DF], proto UDP (17), length 167)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.58663: [bad udp <span class="built_in">cksum</span> 0x60cc -&gt; 0x3efd!] 53027 NXDomain*- q: A? kubernetes.svc.cluster.local. 0/1/0 ns: cluster.local. [5s] SOA ns.dns.cluster.local. hostmaster.cluster.local. 1711809447 7200 1800 86400 5 (139)</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™ä¸ª busybox è§£æé›†ç¾¤å…¬ç½‘åŸŸå<br><img src="/2024/03/30/CoreDNS%E5%92%8CNodeLocalDNS%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/%E9%80%9A%E8%BF%87coredns%E8%A7%A3%E6%9E%90%E9%9B%86%E7%BE%A4%E5%85%AC%E7%BD%91%E5%9F%9F%E5%90%8D.png" alt="é€šè¿‡corednsè§£æé›†ç¾¤å…¬ç½‘åŸŸå"></p>
<p>å¯ä»¥çœ‹åˆ°å¯¹ <code>www.baidu.com</code> åŸŸåçš„è§£æè¿”å›ç»“æœï¼Œæ˜¯é€šè¿‡ <code>192.168.0.5</code> è·å–åˆ°çš„</p>
<p><code>Pod -&gt; CoreDNS -&gt; 192.168.0.5 -&gt; CoreDNS -&gt; Pod</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@controller-node-1 ~]<span class="comment">#  tcpdump -i any host 10.233.74.83 and 10.233.0.3 or 192.168.0.5 and port 53 -nnvvv</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">22:58:29.405332 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 48447, offset 0, flags [DF], proto UDP (17), length 59)</span><br><span class="line">    10.233.74.83.38430 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x6060 -&gt; 0xdcc6!] 28765+ A? www.baidu.com. (31)</span><br><span class="line">22:58:29.405423 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 48448, offset 0, flags [DF], proto UDP (17), length 59)</span><br><span class="line">    10.233.74.83.38430 &gt; 10.233.0.3.53: [bad udp <span class="built_in">cksum</span> 0x6060 -&gt; 0xcdcd!] 25686+ AAAA? www.baidu.com. (31)</span><br><span class="line">22:58:29.405881 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 42712, offset 0, flags [DF], proto UDP (17), length 59)</span><br><span class="line">    10.233.74.66.56555 &gt; 192.168.0.5.53: [bad udp <span class="built_in">cksum</span> 0x1611 -&gt; 0x2f90!] 1558+ AAAA? www.baidu.com. (31)</span><br><span class="line">22:58:29.405950 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 42712, offset 0, flags [DF], proto UDP (17), length 59)</span><br><span class="line">    192.168.159.41.56555 &gt; 192.168.0.5.53: [bad udp <span class="built_in">cksum</span> 0x20b8 -&gt; 0x24e9!] 1558+ AAAA? www.baidu.com. (31)</span><br><span class="line">22:58:29.406110 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 42713, offset 0, flags [DF], proto UDP (17), length 59)</span><br><span class="line">    10.233.74.66.58403 &gt; 192.168.0.5.53: [bad udp <span class="built_in">cksum</span> 0x1611 -&gt; 0xf518!] 21589+ A? www.baidu.com. (31)</span><br><span class="line">22:58:29.406191 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 42713, offset 0, flags [DF], proto UDP (17), length 59)</span><br><span class="line">    192.168.159.41.58403 &gt; 192.168.0.5.53: [bad udp <span class="built_in">cksum</span> 0x20b8 -&gt; 0xea71!] 21589+ A? www.baidu.com. (31)</span><br><span class="line">22:58:29.410592 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 39983, offset 0, flags [DF], proto UDP (17), length 118)</span><br><span class="line">    192.168.0.5.53 &gt; 192.168.159.41.58403: [udp <span class="built_in">sum</span> ok] 21589 q: A? www.baidu.com. 3/0/0 www.baidu.com. [2m9s] CNAME www.a.shifen.com., www.a.shifen.com. [2m9s] A 183.2.172.185, www.a.shifen.com. [2m9s] A 183.2.172.42 (90)</span><br><span class="line">22:58:29.410637 IP (tos 0x0, ttl 62, <span class="built_in">id</span> 39983, offset 0, flags [DF], proto UDP (17), length 118)</span><br><span class="line">    192.168.0.5.53 &gt; 10.233.74.66.58403: [udp <span class="built_in">sum</span> ok] 21589 q: A? www.baidu.com. 3/0/0 www.baidu.com. [2m9s] CNAME www.a.shifen.com., www.a.shifen.com. [2m9s] A 183.2.172.185, www.a.shifen.com. [2m9s] A 183.2.172.42 (90)</span><br><span class="line">22:58:29.410972 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 64831, offset 0, flags [DF], proto UDP (17), length 166)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.38430: [bad udp <span class="built_in">cksum</span> 0x60cb -&gt; 0xe43e!] 28765 q: A? www.baidu.com. 3/0/0 www.baidu.com. [30s] CNAME www.a.shifen.com., www.a.shifen.com. [30s] A 183.2.172.42, www.a.shifen.com. [30s] A 183.2.172.185 (138)</span><br><span class="line">22:58:29.413159 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 39984, offset 0, flags [DF], proto UDP (17), length 142)</span><br><span class="line">    192.168.0.5.53 &gt; 192.168.159.41.56555: [udp <span class="built_in">sum</span> ok] 1558 q: AAAA? www.baidu.com. 3/0/0 www.baidu.com. [3m29s] CNAME www.a.shifen.com., www.a.shifen.com. [3m29s] AAAA 240e:ff:e020:9ae:0:ff:b014:8e8b, www.a.shifen.com. [3m29s] AAAA 240e:ff:e020:966:0:ff:b042:f296 (114)</span><br><span class="line">22:58:29.413203 IP (tos 0x0, ttl 62, <span class="built_in">id</span> 39984, offset 0, flags [DF], proto UDP (17), length 142)</span><br><span class="line">    192.168.0.5.53 &gt; 10.233.74.66.56555: [udp <span class="built_in">sum</span> ok] 1558 q: AAAA? www.baidu.com. 3/0/0 www.baidu.com. [3m29s] CNAME www.a.shifen.com., www.a.shifen.com. [3m29s] AAAA 240e:ff:e020:9ae:0:ff:b014:8e8b, www.a.shifen.com. [3m29s] AAAA 240e:ff:e020:966:0:ff:b042:f296 (114)</span><br><span class="line">22:58:29.413922 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 64833, offset 0, flags [DF], proto UDP (17), length 190)</span><br><span class="line">    10.233.0.3.53 &gt; 10.233.74.83.38430: [bad udp <span class="built_in">cksum</span> 0x60e3 -&gt; 0x9ac9!] 25686 q: AAAA? www.baidu.com. 3/0/0 www.baidu.com. [30s] CNAME www.a.shifen.com., www.a.shifen.com. [30s] AAAA 240e:ff:e020:966:0:ff:b042:f296, www.a.shifen.com. [30s] AAAA 240e:ff:e020:9ae:0:ff:b014:8e8b (162)</span><br></pre></td></tr></table></figure>

<h2 id="NodeLocalDNS"><a href="#NodeLocalDNS" class="headerlink" title="NodeLocalDNS"></a>NodeLocalDNS</h2><p>æ¥è‡ªå®˜æ–¹æ–‡æ¡£: NodeLocal DNSCache é€šè¿‡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šä½œä¸º DaemonSet è¿è¡Œ DNS ç¼“å­˜ä»£ç†æ¥æé«˜é›†ç¾¤ DNS æ€§èƒ½ã€‚</p>
<p>NodeLocalDNS Pod ä¸­çš„ <code>/etc/resolv.conf</code> ä¸å®¿ä¸»æœºæ˜¯ç›¸åŒçš„<br><img src="/2024/03/30/CoreDNS%E5%92%8CNodeLocalDNS%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/nodelocaldns%E7%9A%84resolv%E9%85%8D%E7%BD%AE.png" alt="nodelocaldnsçš„resolvé…ç½®"></p>
<p>èŠ‚ç‚¹ä¸Šä¹Ÿä¼šæœ‰å¯¹åº”çš„ç½‘å¡ï¼Œè¿™ä¸ªåœ°å€å–å†³äºå¯åŠ¨å‚æ•°<br><img src="/2024/03/30/CoreDNS%E5%92%8CNodeLocalDNS%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/nodelocaldns%E7%BD%91%E5%8D%A1.png" alt="nodelocaldnsç½‘å¡"></p>
<p>åœ¨é›†ç¾¤æœ‰ NodeLocalDNS çš„æƒ…å†µä¸‹ï¼Œåœ¨å¯¹é›†ç¾¤å†…éƒ¨åŸŸåè¿›è¡Œè§£æï¼Œå¯ä»¥çœ‹åˆ° DNS è¯·æ±‚ä¼šå…ˆç»è¿‡ NodeLocalDNSï¼Œç„¶åç›´æ¥è¿”å›è¯·æ±‚ï¼Œæµé‡æ— éœ€å‡ºèŠ‚ç‚¹</p>
<p><code>Pod -&gt; NodeLocalDNS -&gt; Pod</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@controller-node-1 ~]<span class="comment"># tcpdump -i any host 10.233.74.83 and 169.254.25.10 or 10.233.0.3 and port 53 -nnvvv</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">23:19:46.273718 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 61227, offset 0, flags [DF], proto UDP (17), length 82)</span><br><span class="line">    10.233.74.83.36711 &gt; 169.254.25.10.53: [bad udp <span class="built_in">cksum</span> 0x1894 -&gt; 0x3f9b!] 22032+ A? kubernetes.default.svc.cluster.local. (54)</span><br><span class="line">23:19:46.273793 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 61228, offset 0, flags [DF], proto UDP (17), length 82)</span><br><span class="line">    10.233.74.83.36711 &gt; 169.254.25.10.53: [bad udp <span class="built_in">cksum</span> 0x1894 -&gt; 0xb26b!] 58148+ AAAA? kubernetes.default.svc.cluster.local. (54)</span><br><span class="line">23:19:46.275678 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 60479, offset 0, flags [DF], proto UDP (17), length 134)</span><br><span class="line">    169.254.25.10.53 &gt; 10.233.74.83.36711: [bad udp <span class="built_in">cksum</span> 0x18c8 -&gt; 0xef59!] 22032*- q: A? kubernetes.default.svc.cluster.local. 1/0/0 kubernetes.default.svc.cluster.local. [5s] A 10.233.0.1 (106)</span><br><span class="line">23:19:46.275946 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 60480, offset 0, flags [DF], proto UDP (17), length 175)</span><br><span class="line">    169.254.25.10.53 &gt; 10.233.74.83.36711: [bad udp <span class="built_in">cksum</span> 0x18f1 -&gt; 0x5d58!] 58148*- q: AAAA? kubernetes.default.svc.cluster.local. 0/1/0 ns: cluster.local. [5s] SOA ns.dns.cluster.local. hostmaster.cluster.local. 1711802462 7200 1800 86400 5 (147)</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨å¯¹é›†ç¾¤å¤–éƒ¨åŸŸåè¿›è¡Œè§£æ</p>
<p><code>Pod -&gt; NodeLocalDNS -&gt; CoreDNS -&gt; 192.168.0.5 -&gt; CoreDNS -&gt; NodeLocalDNS -&gt; Pod</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">23:27:25.569362 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 36019, offset 0, flags [DF], proto UDP (17), length 60)</span><br><span class="line">    10.233.74.83.42419 &gt; 169.254.25.10.53: [bad udp <span class="built_in">cksum</span> 0x187e -&gt; 0x94cd!] 7676+ A? www.google.com. (32)</span><br><span class="line">23:27:25.569423 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 36020, offset 0, flags [DF], proto UDP (17), length 60)</span><br><span class="line">    10.233.74.83.42419 &gt; 169.254.25.10.53: [bad udp <span class="built_in">cksum</span> 0x187e -&gt; 0xb5c9!] 64740+ AAAA? www.google.com. (32)</span><br><span class="line">23:27:25.569823 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 65347, offset 0, flags [DF], proto UDP (17), length 71)</span><br><span class="line">    192.168.159.11.57457 &gt; 192.168.0.5.53: [bad udp <span class="built_in">cksum</span> 0x20a6 -&gt; 0x7971!] 52418+ [1au] AAAA? www.google.com. ar: . OPT UDPsize=2048 DO (43)</span><br><span class="line">23:27:25.569841 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 65348, offset 0, flags [DF], proto UDP (17), length 71)</span><br><span class="line">    192.168.159.11.33304 &gt; 192.168.0.5.53: [bad udp <span class="built_in">cksum</span> 0x20a6 -&gt; 0xa430!] 120+ [1au] A? www.google.com. ar: . OPT UDPsize=2048 DO (43)</span><br><span class="line">23:27:25.571423 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 18081, offset 0, flags [DF], proto UDP (17), length 152)</span><br><span class="line">    192.168.0.5.53 &gt; 192.168.159.11.57457: [udp <span class="built_in">sum</span> ok] 52418 q: AAAA? www.google.com. 0/1/1 ns: www.google.com. [10s] SOA fake-for-negative-caching.adguard.com. hostmaster.www.google.com. 100500 1800 60 604800 86400 ar: . OPT UDPsize=2048 DO (124)</span><br><span class="line">23:27:25.571763 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 40563, offset 0, flags [DF], proto UDP (17), length 172)</span><br><span class="line">    169.254.25.10.53 &gt; 10.233.74.83.42419: [bad udp <span class="built_in">cksum</span> 0x18ee -&gt; 0x3576!] 64740 q: AAAA? www.google.com. 0/1/0 ns: www.google.com. [10s] SOA fake-for-negative-caching.adguard.com. hostmaster.www.google.com. 100500 1800 60 604800 86400 (144)</span><br><span class="line">23:27:25.573701 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 18082, offset 0, flags [DF], proto UDP (17), length 87)</span><br><span class="line">    192.168.0.5.53 &gt; 192.168.159.11.33304: [udp <span class="built_in">sum</span> ok] 120 q: A? www.google.com. 1/0/1 www.google.com. [1m30s] A 216.58.203.68 ar: . OPT UDPsize=2048 DO (59)</span><br><span class="line">23:27:25.573927 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 40564, offset 0, flags [DF], proto UDP (17), length 90)</span><br><span class="line">    169.254.25.10.53 &gt; 10.233.74.83.42419: [bad udp <span class="built_in">cksum</span> 0x189c -&gt; 0xe2c7!] 7676 q: A? www.google.com. 1/0/0 www.google.com. [30s] A 216.58.203.68 (62)</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-03-30T11:51:11.000Z" title="3/30/2024, 7:51:11 PM">2024-03-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-03-30T13:19:17.874Z" title="3/30/2024, 9:19:17 PM">2024-03-30</time></span><span class="level-item">5 minutes read (About 785 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">kube-proxyå·¥ä½œåŸç†</a></p><div class="content"><p>kube-proxy ä»¥ DaemonSet çš„å½¢å¼è¿è¡Œåœ¨é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¸­ï¼Œè´Ÿè´£ç®¡ç†é›†ç¾¤å¤–åˆ° Serviceï¼Œä»¥åŠ Service åˆ° Pod çš„æµé‡è½¬å‘ã€‚</p>
<p>kube-proxy æœ‰ä¸‰ç§æ¨¡å¼:</p>
<ol>
<li>userspace</li>
<li>iptables</li>
<li>ipvs</li>
</ol>
<h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><p>é€šè¿‡ kube-proxy çš„ cm å¯ä»¥æŸ¥çœ‹ mode<br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/iptables-mode.png" alt="iptables-mode"></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ SVC æœ‰å¤šç§ç±»å‹ï¼Œå¸¸ç”¨çš„æœ‰ ClusterIPã€NodePortã€Headlessã€LoadBalancer ç­‰ç­‰ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡åˆ›å»ºç±»å‹çš„ SVCï¼ŒæŸ¥çœ‹ kube-proxy ä¸‹å‘çš„iptables è§„åˆ™</p>
<p><strong>ClusterIP</strong><br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/clusterip-svc.png" alt="clusterip-svc"></p>
<p>é€šè¿‡ iptables-save å‘½ä»¤æ‰“å°è¿™ä¸ª SVC çš„è§„åˆ™<br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/clusterip-iptables.png" alt="clusterip-iptables"></p>
<p>PodIP: 10.233.74.106<br>ClusterIP: 10.233.54.175</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ¥è‡ª Pod IP 10.233.74.106 çš„æµé‡æ ‡è®°ä¸ºæœåŠ¡ default/nginxï¼Œå¹¶è½¬å‘åˆ° KUBE-MARK-MASQ é“¾ä¸­</span></span><br><span class="line">-A KUBE-SEP-EUB75IW55XDW6EHN -s 10.233.74.106/32 -m comment --comment <span class="string">&quot;default/nginx:tcp-80&quot;</span> -j KUBE-MARK-MASQ</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åŒ¹é…çš„ TCP æµé‡è¿›è¡Œ DNATï¼Œè½¬å‘åˆ°åç«¯ Pod 10.233.74.106:80</span></span><br><span class="line">-A KUBE-SEP-EUB75IW55XDW6EHN -p tcp -m comment --comment <span class="string">&quot;default/nginx:tcp-80&quot;</span> -m tcp -j DNAT --to-destination 10.233.74.106:80</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒ¹é…ç›®æ ‡åœ°å€ä¸ºæœåŠ¡ default/nginx çš„ cluster IP 10.233.54.175 çš„ TCP 80 ç«¯å£æµé‡</span></span><br><span class="line">-A KUBE-SERVICES -d 10.233.54.175/32 -p tcp -m comment --comment <span class="string">&quot;default/nginx:tcp-80 cluster IP&quot;</span> -m tcp --dport 80 -j KUBE-SVC-XX3NNXKPRC7N6OJH</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ‡è®°æ¥è‡ªå¤–éƒ¨ç½‘ç»œï¼ˆé™¤äº† PodCIDR 10.233.64.0/18ï¼‰çš„ã€ç›®æ ‡åœ°å€ä¸ºæœåŠ¡ default/nginx çš„ cluster IP 10.233.54.175 çš„ TCP 80 ç«¯å£çš„æµé‡</span></span><br><span class="line">-A KUBE-SVC-XX3NNXKPRC7N6OJH ! -s 10.233.64.0/18 -d 10.233.54.175/32 -p tcp -m comment --comment <span class="string">&quot;default/nginx:tcp-80 cluster IP&quot;</span> -m tcp --dport 80 -j KUBE-MARK-MASQ</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åŒ¹é…çš„æµé‡è½¬å‘åˆ° KUBE-SEP-EUB75IW55XDW6EHN é“¾ä¸­ï¼Œè¿›è¡Œ DNAT åœ°å€è½¬æ¢</span></span><br><span class="line">-A KUBE-SVC-XX3NNXKPRC7N6OJH -m comment --comment <span class="string">&quot;default/nginx:tcp-80 -&gt; 10.233.74.106:80&quot;</span> -j KUBE-SEP-EUB75IW55XDW6EHN</span><br></pre></td></tr></table></figure>

<p><strong>NodePort</strong></p>
<p>æŠŠè¿™ä¸ª SVC ç±»å‹æ”¹æˆ NodePort<br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/nodeport-svc.png" alt="nodeport-svc"></p>
<p>é€šè¿‡ <code>iptables-save</code> å‘½ä»¤æ‰“å°è¿™ä¸ª SVC çš„è§„åˆ™ï¼Œå¤šäº†ä¸¤æ¡è§„åˆ™<br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/nodeport-iptables.png" alt="nodeport-iptables"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨äºæ ‡è®°æ¥è‡ªå¤–éƒ¨çš„ã€ç›®æ ‡åœ°å€ä¸ºæœåŠ¡ default/nginx çš„ NodePort æµé‡</span></span><br><span class="line">-A KUBE-EXT-XX3NNXKPRC7N6OJH -m comment --comment <span class="string">&quot;masquerade traffic for default/nginx:tcp-80 external destinations&quot;</span> -j KUBE-MARK-MASQ</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨äºåŒ¹é…ç›®æ ‡ç«¯å£ä¸º 32594 çš„ TCP æµé‡ï¼Œå¹¶å°†è¯¥æµé‡è½¬å‘åˆ°ä¸Šé¢çš„è§„åˆ™è¿›è¡Œ MASQ æ ‡è®°</span></span><br><span class="line">-A KUBE-NODEPORTS -p tcp -m comment --comment <span class="string">&quot;default/nginx:tcp-80&quot;</span> -m tcp --dport 32594 -j KUBE-EXT-XX3NNXKPRC7N6OJH</span><br></pre></td></tr></table></figure>

<h2 id="IPVS"><a href="#IPVS" class="headerlink" title="IPVS"></a>IPVS</h2><p>é€šè¿‡ kube-proxy çš„ cm å¯ä»¥æŸ¥çœ‹ mode<br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/ipvs-mode.png" alt="ipvs-mode"></p>
<p>æ¥è‡ª GPT çš„å›ç­”: IPVS æ˜¯ Linux å†…æ ¸ä¸­å®ç°çš„è™šæ‹ŸæœåŠ¡å™¨æŠ€æœ¯ï¼Œå®ƒå¯ä»¥å°†ç½‘ç»œæµé‡è´Ÿè½½å‡è¡¡åˆ°å¤šå°æœåŠ¡å™¨ä¸Šï¼Œä»è€Œæé«˜æœåŠ¡æ€§èƒ½å’Œå¯é æ€§ã€‚</p>
<p><strong>ClusterIP</strong></p>
<p>PodIP: 10.233.76.138<br>ClusterIP: 10.233.27.36</p>
<p>é€šè¿‡ <code>ipvsadm</code> å‘½ä»¤æŸ¥çœ‹è¿™ä¸ªè™šæ‹ŸæœåŠ¡å™¨<br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/clusterip-ipvs.png" alt="clusterip-ipvs"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç›®æ ‡åœ°å€ä¸º nginx.default.svc.cluster.lo:80 çš„ TCP æµé‡è½¬å‘åˆ°åç«¯ Pod 10.233.76.138:80</span></span><br><span class="line">TCP  nginx.default.svc.cluster.lo rr</span><br><span class="line">  -&gt; 10-233-76-138.nginx.default. Masq    1      0          0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç›®æ ‡åœ°å€ä¸º 10.233.27.36:80 çš„ TCP æµé‡è½¬å‘åˆ°åç«¯ Pod 10.233.76.138:80</span></span><br><span class="line">TCP  10.233.27.36:80 rr</span><br><span class="line">  -&gt; 10.233.76.138:80             Masq    1      0          0</span><br></pre></td></tr></table></figure>

<p><strong>NodePort</strong></p>
<p>é€šè¿‡ <code>ipvsadm</code> å‘½ä»¤æŸ¥çœ‹è¿™ä¸ªè™šæ‹ŸæœåŠ¡å™¨ï¼Œå¤šäº†ä¸‰æ¡è§„åˆ™<br><img src="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/nodeport-ipvs.png" alt="nodeport-ipvs"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nodelocaldns ä¼šæ·»åŠ ä¸€æ¡ A è®°å½•ï¼Œå°†æœåŠ¡åç§°è§£æä¸º NodePort ç«¯å£ï¼Œå³ nginx.default.svc.cluster.local è§£æä¸º 169.254.25.10:30229ï¼Œç›´æ¥è½¬å‘åˆ°å¯¹åº”çš„ Podï¼Œå‡å°‘é“¾è·¯</span></span><br><span class="line">TCP  169.254.25.10:30229 rr</span><br><span class="line">  -&gt; 10.233.76.138:80             Masq    1      0          0</span><br><span class="line"></span><br><span class="line"><span class="comment"># èŠ‚ç‚¹IP</span></span><br><span class="line">TCP  192.168.159.11:30229 rr</span><br><span class="line">  -&gt; 10.233.76.138:80             Masq    1      0          0</span><br><span class="line"></span><br><span class="line"><span class="comment"># NodePort æµé‡å¦‚æœç»è¿‡ tun0 éš§é“ç½‘å¡ï¼Œåˆ™ç›´æ¥è½¬å‘åˆ°å¯¹åº”çš„ Podï¼Œå‡å°‘é“¾è·¯</span></span><br><span class="line">TCP  10.233.74.64:30229 rr</span><br><span class="line">  -&gt; 10.233.76.138:80             Masq    1      0</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-03-30T11:07:40.000Z" title="3/30/2024, 7:07:40 PM">2024-03-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-03-30T11:33:31.332Z" title="3/30/2024, 7:33:31 PM">2024-03-30</time></span><span class="level-item">a few seconds read (About 81 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/03/30/CNI%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/">CNIå·¥ä½œæµç¨‹</a></p><div class="content"><p>CNI å³å®¹å™¨ç½‘ç»œæ¥å£ï¼Œé€šè¿‡ CNI èƒ½å¤Ÿä½¿ K8s æ”¯æŒä¸åŒçš„ç½‘ç»œæ¨¡å¼ã€‚</p>
<p>CNI å¸¸è§çš„å®ç°æ¨¡å¼å¤§è‡´åˆ†ä¸ºä¸¤ç§:</p>
<ol>
<li>overlay: é€šè¿‡éš§é“æ‰“é€šç½‘ç»œï¼Œä¸ä¾èµ–åº•å±‚ç½‘ç»œï¼Œå¦‚ calico</li>
<li>underlay: é€šè¿‡åº•å±‚æ‰“é€šç½‘ç»œï¼Œå¼ºä¾èµ–åº•å±‚ç½‘ç»œï¼Œå¦‚ macvlan</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-03-30T09:01:48.000Z" title="3/30/2024, 5:01:48 PM">2024-03-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-03-30T10:48:28.561Z" title="3/30/2024, 6:48:28 PM">2024-03-30</time></span><span class="level-item">6 minutes read (About 839 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/03/30/CSI%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/">CSIå·¥ä½œæµç¨‹</a></p><div class="content"><p>CSI å³å®¹å™¨å­˜å‚¨æ¥å£ï¼Œå€ŸåŠ© CSI å°±å¯ä»¥å¾ˆå®¹æ˜“çš„ç»™å·¥ä½œè´Ÿè½½æä¾›å­˜å‚¨ä½¿ç”¨ã€‚K8s çš„å­˜å‚¨æ’ä»¶åˆåˆ†ä¸º in-tree å’Œ out-of-tree ä¸¤ç§ç±»å‹ï¼Œå‰è€…æ˜¯ä¸ K8s ä¸»åº“å…±åŒè¿­ä»£ç»´æŠ¤ï¼Œåè€…åˆ™æ˜¯ç‹¬ç«‹ç»´æŠ¤çš„å­˜å‚¨æ’ä»¶ã€‚</p>
<p>out-of-tree ç±»å‹çš„æ’ä»¶åˆ™æ˜¯é€šè¿‡ gRPC ä¸ K8s çš„ç»„ä»¶è¿›è¡Œäº¤äº’ï¼Œä¸ºäº†ç®€åŒ– CSI çš„å¼€å‘ä¸éƒ¨ç½²ï¼ŒK8s ä¹Ÿæä¾›äº†å¤šä¸ª sidecar ç»„ä»¶:</p>
<ol>
<li>node-driver-registrar: ç›‘å¬æ¥è‡ª kubelet çš„ gRPC è¯·æ±‚ï¼Œä» CSI driver è·å–é©±åŠ¨ç¨‹åºä¿¡æ¯ï¼ˆé€šè¿‡ <code>NodeGetInfo</code> æ–¹æ³•ï¼‰ï¼Œå¹¶ä½¿ç”¨ kubelet æ’ä»¶æ³¨å†Œæœºåˆ¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„ kubelet ä¸­å¯¹å…¶è¿›è¡Œæ³¨å†Œ</li>
<li>provisioner: ç›‘å¬æ¥è‡ª kube-apiserver çš„ gRPC è¯·æ±‚ï¼Œç›‘å¬ PVC çš„åˆ›å»ºå’Œåˆ é™¤ï¼Œè°ƒç”¨ CSI driver åˆ›å»ºå’Œåˆ é™¤ PVï¼ˆé€šè¿‡ <code>CreateVolume</code> å’Œ <code>Delete Volume</code>ï¼‰æ–¹æ³•</li>
<li>attacher: ç›‘å¬æ¥è‡ª kube-apiserver çš„ gRPC è¯·æ±‚ï¼Œç›‘å¬ volumeAttachment å¯¹è±¡å¹¶è§¦å‘ CSI æ‰§è¡Œ <code>ControllerPublishVolume</code> å’Œ <code>ControllerUnpublishVolume</code> çš„æ“ä½œ</li>
<li>resizer: ç›‘å¬æ¥è‡ª kube-apiserver çš„ gRPC è¯·æ±‚ï¼Œç›‘å¬ PVC çš„ä¿®æ”¹ï¼Œè°ƒç”¨ CSI Controller æ‰§è¡Œ <code>ExpandVolume</code> æ–¹æ³•ï¼Œæ¥è°ƒæ•´ Volume çš„å¤§å°</li>
<li>livenessProbe: æ£€æŸ¥ CSI ç¨‹åºçš„å¥åº·çŠ¶æ€ï¼Œå¦‚ä¸å¥åº·åˆ™ä¼šè¿›è¡Œé‡å¯</li>
</ol>
<h2 id="CSI-å·¥ä½œæµç¨‹"><a href="#CSI-å·¥ä½œæµç¨‹" class="headerlink" title="CSI å·¥ä½œæµç¨‹"></a>CSI å·¥ä½œæµç¨‹</h2><p>CSI çš„å·¥ä½œæµåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ:</p>
<ol>
<li>Provision&#x2F;Delete</li>
<li>Attach&#x2F;Detach</li>
<li>Mount&#x2F;Unmount</li>
</ol>
<p>è¿™ä¸‰ä¸ªé˜¶æ®µä¼šç”¨åˆ° Sidecar ç»„ä»¶ï¼Œä¹Ÿä¼šç”¨åˆ° K8s çš„ PV Controller å’Œ AD Controller ç»„ä»¶</p>
<p>å½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰çš„ CSI éƒ½ä¼šç»å†è¿™ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚ NFS CSI çš„å·¥ä½œæµå°±æ²¡æœ‰æ¶‰åŠ volumeAttachment<br><img src="/2024/03/30/CSI%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/nfs-csi.png" alt="nfs-csi"></p>
<h3 id="Privision-é˜¶æ®µ"><a href="#Privision-é˜¶æ®µ" class="headerlink" title="Privision é˜¶æ®µ"></a>Privision é˜¶æ®µ</h3><p>åœ¨æ­¤é˜¶æ®µï¼ŒSidecar provisioner å’Œ PV Controller éƒ½ä¼šç›‘å¬ PVC èµ„æº</p>
<ol>
<li>å½“ PV Controller è§‚å¯Ÿåˆ°æ–°çš„ PVC è¢«åˆ›å»ºæ—¶ï¼Œå°±ä¼šå»åˆ¤æ–­æ˜¯å¦æœ‰ä¸ä¹‹åŒ¹é…çš„ in-tree æ’ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ¤å®šä¸º out-of-treeï¼Œå¹¶ä¸ºè¯¥ PVC æ·»åŠ  annotation<br><img src="/2024/03/30/CSI%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/pvc-annotation.png" alt="pvc-annotation"></li>
<li>provisioner è§‚å¯Ÿåˆ° PVC çš„ annotation ä¸è‡ªå·±çš„ CSI æ˜¯ç›¸åŒ¹é…çš„æ—¶å€™ï¼Œå°±ä¼šå»è°ƒç”¨ <code>CreateVolume</code> æ–¹æ³•</li>
<li>å½“ <code>CreateVolume</code> è°ƒç”¨è¿”å›æˆåŠŸæ—¶ï¼Œprovisioner å°±ä¼šåˆ›å»º PV</li>
<li>PV Controller ç›‘å¬åˆ°è¯¥ PV æ—¶ï¼Œå°±ä¼šå°†å…¶ä¸ PVC åšç»‘å®š</li>
</ol>
<h3 id="Attach-é˜¶æ®µ"><a href="#Attach-é˜¶æ®µ" class="headerlink" title="Attach é˜¶æ®µ"></a>Attach é˜¶æ®µ</h3><p>åœ¨æ­¤é˜¶æ®µï¼Œä¼šå°†æ•°æ®å·é™„åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Š</p>
<ol>
<li>AD Controller ç›‘å¬åˆ° Pod è¢«è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹åï¼Œä¼šè°ƒç”¨ in-tree å†…éƒ¨æ¥å£åˆ›å»º volumeAttachment èµ„æº</li>
<li>attacher ç›‘å¬åˆ° volumeAttachment å°±ä¼šè°ƒç”¨ <code>ControllerPublishVolume</code> æ¥å£</li>
<li>å½“æ¥å£è¿”å›æˆåŠŸæ—¶å°±ä¼šå°† volumeAttachment èµ„æºçš„ status.attached è®¾ç½®ä¸º true<br><img src="/2024/03/30/CSI%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/volume-attachment-status.png" alt="volume-attachment-status"></li>
</ol>
<h3 id="Mount-é˜¶æ®µ"><a href="#Mount-é˜¶æ®µ" class="headerlink" title="Mount é˜¶æ®µ"></a>Mount é˜¶æ®µ</h3><p>åœ¨æ­¤é˜¶æ®µï¼Œä¼šå°†æ•°æ®å·æŒ‚è½½åˆ° Pod ä¸Š</p>
<ol>
<li>kubelet è§‚å¯Ÿåˆ° volumeAttachment èµ„æºçš„ status.attached è®¾ç½®ä¸º true æ—¶ï¼Œå°±ä¼šè°ƒç”¨ in-tree å†…éƒ¨æ¥å£è¿›è¡Œå®é™…çš„å·æŒ‚è½½æ“ä½œ</li>
</ol>
<h3 id="Unmount-é˜¶æ®µ"><a href="#Unmount-é˜¶æ®µ" class="headerlink" title="Unmount é˜¶æ®µ"></a>Unmount é˜¶æ®µ</h3><p>åœ¨æ­¤é˜¶æ®µï¼Œä¼šå°†æ•°æ®å·ä» Pod ä¸Šå–æ¶ˆæŒ‚è½½</p>
<ol>
<li>kubelet ç›‘å¬åˆ°èŠ‚ç‚¹ä¸Šçš„ Pod è¢«åˆ é™¤ï¼Œå°±ä¼šè°ƒç”¨ in-tree å†…éƒ¨æ¥å£è¿›è¡Œå®é™…çš„å·å¸è½½æ“ä½œ</li>
</ol>
<h3 id="Detach-é˜¶æ®µ"><a href="#Detach-é˜¶æ®µ" class="headerlink" title="Detach é˜¶æ®µ"></a>Detach é˜¶æ®µ</h3><p>åœ¨æ­¤é˜¶æ®µï¼Œä¼šå°†å¯¹åº”çš„ volumeAttachment èµ„æºåˆ é™¤</p>
<ol>
<li>attacher ä¼šè®²è¢«åˆ é™¤ Pod å¯¹åº”çš„ volumeAttachment è¿›è¡Œåˆ é™¤</li>
<li>AD Controller ç›‘å¬åˆ° volumeAttachment è¢«åˆ é™¤åï¼Œä¼šå»æ›´æ–°èŠ‚ç‚¹çš„ status.volumesInUseï¼Œå°†å¯¹åº”çš„å·ä¿¡æ¯æ‘˜é™¤</li>
</ol>
<h3 id="Delete-é˜¶æ®µ"><a href="#Delete-é˜¶æ®µ" class="headerlink" title="Delete é˜¶æ®µ"></a>Delete é˜¶æ®µ</h3><p>åœ¨æ­¤é˜¶æ®µï¼Œä¼šåˆ¤æ–­ PV çš„å›æ”¶ç­–ç•¥è¿›è¡Œä¸åŒçš„æ“ä½œ</p>
<ol>
<li>provisioner è§‚å¯Ÿ PV çš„ persistentVolumeReclaimPolicyï¼Œå¦‚æœä¸º Retain åˆ™ä¿ç•™ï¼ŒDelete åˆ™åˆ é™¤</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-03-11T09:15:48.000Z" title="3/11/2024, 5:15:48 PM">2024-03-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-03-11T09:47:44.678Z" title="3/11/2024, 5:47:44 PM">2024-03-11</time></span><span class="level-item">2 minutes read (About 262 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/03/11/Pod%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%9E%E7%94%9F%E7%9A%84/">Podæ˜¯æ€ä¹ˆè¯ç”Ÿçš„</a></p><div class="content"><p>K8s æœ¬èº«ä¸æä¾›å®¹å™¨åˆ›å»ºçš„å®ç°ï¼Œå®¹å™¨çš„åˆ›å»ºæ˜¯é€šè¿‡ CRI æ¥å£è°ƒç”¨å¤–éƒ¨æ’ä»¶å®ç°çš„ï¼Œå¸¸è§çš„ CRI æœ‰è¿™å‡ ç§:</p>
<ol>
<li>docker</li>
<li>containerd</li>
<li>cri-dockerd</li>
</ol>
<h2 id="Pod-æ˜¯å¦‚ä½•è¢«åˆ›å»ºå‡ºæ¥çš„"><a href="#Pod-æ˜¯å¦‚ä½•è¢«åˆ›å»ºå‡ºæ¥çš„" class="headerlink" title="Pod æ˜¯å¦‚ä½•è¢«åˆ›å»ºå‡ºæ¥çš„"></a>Pod æ˜¯å¦‚ä½•è¢«åˆ›å»ºå‡ºæ¥çš„</h2><ol>
<li>å®¢æˆ·ç«¯é€šè¿‡ kubectl ç­‰å°†åˆ›å»º pod çš„è¯·æ±‚å‘é€ç»™ kube-apiserver</li>
<li>kube-apiserver å°† pod ä¿¡æ¯å†™å…¥ etcdï¼Œetcd å°†å†™å…¥çš„ç»“æœè¿”å›ç»™ kube-apiserverï¼Œç„¶å kube-apiserver å†è¿”å›ç»™å®¢æˆ·ç«¯</li>
<li>kube-scheduler é€šè¿‡ kube-apiserver çš„ watch æ¥å£ï¼Œè·å–åˆ°æœªè¢«è°ƒåº¦çš„ pod ä¿¡æ¯ï¼Œæ ¹æ®è°ƒåº¦ç®—æ³•é€‰æ‹©é›†ç¾¤å†…çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå°†èŠ‚ç‚¹ä¿¡æ¯å‘é€ç»™ kube-apiserver</li>
<li>kube-apiserver å°†è¿™ä¸ª pod å’ŒèŠ‚ç‚¹çš„ç»‘å®šä¿¡æ¯å†™å…¥åˆ° etcdï¼Œetcd å°†ç»“æœè¿”å›ç»™ kube-apiserver</li>
<li>kubelet é€šè¿‡ kube-apiserver çš„ watch æ¥å£ï¼Œè·å–åˆ°æœ¬èŠ‚ç‚¹æœ‰åˆ›å»º pod çš„ä¿¡æ¯ï¼Œç„¶åä¼šè°ƒç”¨ CRI åˆ›å»ºå®¹å™¨ï¼Œå¹¶å°† pod çš„è¿è¡ŒçŠ¶æ€å‘é€ç»™ kube-apiserver</li>
<li>kube-apiserver å°† pod çŠ¶æ€ä¿¡æ¯æ›´æ–°åˆ° etcd</li>
</ol>
<p><img src="/2024/03/11/Pod%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%9E%E7%94%9F%E7%9A%84/pod%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B.png" alt="podåˆ›å»ºæµç¨‹"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:10:43.920Z" title="2/18/2024, 5:10:43 PM">2024-02-18</time></span><span class="level-item">6 minutes read (About 882 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/cka/">CKA</a></p><div class="content"><p>è®°å½•åˆ·é¢˜- -</p>
<p>Jobï¼šåˆ›å»ºä¸€ä¸ªå›ºå®šç»“æŸæ¬¡æ•°çš„å¹¶è¡Œ Jobï¼Œå…± 2 ä¸ª podï¼Œè¿è¡Œ 45 completionï¼ŒJob pod æ‰“å°â€œBeijingâ€ï¼Œé•œåƒè‡ªé€‰ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">45</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;sh&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;-c&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;echo Beijing&#x27;</span></span><br></pre></td></tr></table></figure>

<p>initContainerï¼špod çš„ container åœ¨å¯åŠ¨æ—¶ä¼šæ£€æŸ¥ volume ä¸­æŸä¸ªç›®å½•æ˜¯å¦å­˜åœ¨æŸä¸ªæ–‡ä»¶ï¼Œè‹¥ä¸å­˜åœ¨åˆ™é€€å‡ºï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™è¿è¡Œã€‚è¦æ±‚ä¿®æ”¹ pod çš„ yamlï¼Œé€šè¿‡ initContainer åˆ›å»ºè¯¥æ–‡ä»¶ï¼Œä½¿podè¿è¡Œã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°†åä¸º ek8s-node-1 çš„ node è®¾ç½®ä¸ºä¸å¯ç”¨ï¼Œå¹¶é‡æ–°è°ƒåº¦è¯¥ node ä¸Šæ‰€æœ‰è¿è¡Œçš„ podsã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cordon:å°†nodeè®¾ç½®ä¸ºä¸å¯ç”¨ï¼Œå°†é˜»æ­¢æ–°podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¹‹ä¸Šï¼Œä½†ä¸ä¼šå½±å“ä»»ä½•å·²ç»åœ¨å…¶ä¸Šçš„ podï¼Œè¿™æ˜¯é‡å¯èŠ‚ç‚¹æˆ–è€…æ‰§è¡Œå…¶ä»–ç»´æŠ¤æ“ä½œä¹‹å‰çš„ä¸€ä¸ªæœ‰ç”¨çš„å‡†å¤‡æ­¥éª¤ï¼ŒDaemonSetåˆ›å»ºçš„podèƒ½å¤Ÿå®¹å¿èŠ‚ç‚¹çš„ä¸å¯è°ƒåº¦å±æ€§ã€‚</span></span><br><span class="line">kubectl cordon ek8s-node-1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">drain:ä»èŠ‚ç‚¹å®‰å…¨çš„é©±é€æ‰€æœ‰podsã€‚</span></span><br><span class="line">kubectl drain ek8s-node-1 --delete-local-data --ignore-daemonsets --force</span><br></pre></td></tr></table></figure>

<p>åœ¨ç°æœ‰çš„ namespace app-team1 ä¸­åˆ›å»ºä¸€ä¸ªåä¸º cicd-token çš„æ–° ServiceAccountï¼Œåˆ›å»ºä¸€ä¸ª deployment-clusterrole ä¸”åªèƒ½å¤Ÿåˆ›å»º Deploymentã€DaemonSetã€StatefulSet èµ„æºçš„ Cluster Roleï¼Œå¹¶å°†æ–°çš„ deployment-clusterrole ç»‘å®šåˆ° cicd-tokenã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create sa cicd-token -n app-team1</span><br><span class="line"></span><br><span class="line">kubectl create clusterrole deployment-clusterrole --verb=create --resource=Deployment,StatefulSet,DaemonSet</span><br><span class="line"></span><br><span class="line">kubectl create rolebinding cicd-rolebinding --clusterrole=deployment-clusterrolr --serviceaccount=app-team1:cicd-token</span><br></pre></td></tr></table></figure>

<p>k8s master 1.20.0 å‡çº§åˆ° 1.20.1ï¼Œå¹¶å‡çº§ kubeletã€kubectlã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†èŠ‚ç‚¹è®¾ä¸ºä¸å¯è°ƒåº¦æ€§</span></span><br><span class="line">kubectl cordon mk8s-master-0</span><br><span class="line">kubectl drain mk8s-master-0 --igonre-daemonsets</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡çº§</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get -y install kubeadm=1.20.1-00</span><br><span class="line">kubeadm update apply v1.20.1 --etcd-upgrade=false</span><br><span class="line">apt-get -y install kubelet=1.20.1-00 kubectl=1.20.1-00</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†ä¸å¯è°ƒåº¦æ€§å»é™¤</span></span><br><span class="line">kubectl uncordon mk8s-master-0</span><br></pre></td></tr></table></figure>

<p>etcd å¤‡ä»½&#x2F;æ¢å¤ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤‡ä»½</span></span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=&lt;trusted-ca-file&gt; --cert=&lt;cert-file&gt; --key=&lt;key-file&gt; snapshot save &lt;backup-file-location&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¢å¤</span></span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=&lt;trusted-ca-file&gt; --cert=&lt;cert-file&gt; --key=&lt;key-file&gt; snapshot restore &lt;backup-file-location&gt;</span><br></pre></td></tr></table></figure>

<p>åœ¨ internal çš„å‘½åç©ºé—´ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º allow-port-from-namespace çš„ NetworkPolicyï¼Œæ­¤ NetworkPolicy å…è®¸ internal ä¸­çš„ pod è®¿é—® echo å‘½åç©ºé—´ä¸­ 9000 çš„ç«¯å£ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…ˆè·å–<span class="built_in">echo</span>ç§Ÿæˆ·çš„labels</span></span><br><span class="line">kubectl get ns echo --show-labels</span><br><span class="line">echo-key: echo-value</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-port-from-namespace</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">internal</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">echo-key:</span> <span class="string">echo-value</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ ing-internal ä¸‹åˆ›å»ºä¸€ä¸ª ingress åä¸º pingï¼Œé€šè¿‡ 5678 ç«¯å£æš´éœ² hello svc ä¸‹çš„ &#x2F;helloã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ping</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ing-internal</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/hello</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">5678</span></span><br></pre></td></tr></table></figure>

<p>å°† deployment webserver æ‰©å±•è‡³ 6 podsã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment webserver --replicas 6</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªåä¸º nginx-kusc00401 çš„ podï¼Œé•œåƒä¸º nginxï¼Œè°ƒåº¦åˆ° disk&#x3D;ssd çš„èŠ‚ç‚¹ä¸Šã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-kusc00401</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20.1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">NodeSelector:</span></span><br><span class="line">    <span class="string">disk=ssd</span></span><br></pre></td></tr></table></figure>

<p>å°†ä¸€ä¸ªç°æœ‰çš„ pod é›†æˆåˆ° k8s å†…ç½®æ—¥å¿—è®°å½•ä½“ç³»ç»“æ„ä¸­ï¼ˆkubectl logsï¼‰ï¼Œä½¿ç”¨ busybox æ¥å°†åä¸º sidecar å®¹å™¨æ·»åŠ åˆ°åä¸º 11-factor-app çš„ pod ä¸­ï¼Œsidecar éœ€è¿è¡Œ <code>/bin/sh -c tail -n+1 -f /var/log/11-factor-app.log</code> ï¼Œä½¿ç”¨å®‰è£…åœ¨ &#x2F;var&#x2F;log çš„ volumeï¼Œä½¿æ—¥å¿—æ–‡ä»¶ 11-factor-app.log å¯ç”¨äº sidecar å®¹å™¨ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="number">11</span><span class="string">-factor-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">count</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      i=0;</span></span><br><span class="line"><span class="string">      while true;</span></span><br><span class="line"><span class="string">      do</span></span><br><span class="line"><span class="string">        echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/11-factor-app.log;</span></span><br><span class="line"><span class="string">        i=$((i+1));</span></span><br><span class="line"><span class="string">        sleep 1;</span></span><br><span class="line"><span class="string">      done</span></span><br><span class="line"><span class="string"></span>    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;tail -n+1 -f /var/log/11-factor-app.log&#x27;</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ pod label name&#x3D;cpu-utilizer å¯»æ‰¾ cpu å ç”¨æœ€å¤šçš„ podï¼Œå¹¶å†™å…¥ <code>/opt/tmp/tmp.txt</code>ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl top pod -A -l name=cpu-utilizer --sort-by=cpu &gt;&gt; /opt/tmp/tmp.txt</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T10:59:10.989Z" title="2/18/2024, 6:59:10 PM">2024-02-18</time></span><span class="level-item">3 hours read (About 31093 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/kubernetes/">Kubernetes</a></p><div class="content"><h2 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h2><h3 id="1-1-k8sæ¦‚è¿°"><a href="#1-1-k8sæ¦‚è¿°" class="headerlink" title="1.1 k8sæ¦‚è¿°"></a>1.1 k8sæ¦‚è¿°</h3><p>Kubernetes æ˜¯ä¸€ä¸ªå¯ç§»æ¤çš„ã€å¯æ‰©å±•çš„å¼€æºå¹³å°ï¼Œç”¨äºç®¡ç†å®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½å’ŒæœåŠ¡ï¼Œå¯ä¿ƒè¿›å£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åŒ–ã€‚ Kubernetes æ‹¥æœ‰ä¸€ä¸ªåºå¤§ä¸”å¿«é€Ÿå¢é•¿çš„ç”Ÿæ€ç³»ç»Ÿã€‚Kubernetes çš„æœåŠ¡ã€æ”¯æŒå’Œå·¥å…·å¹¿æ³›å¯ç”¨ã€‚</p>
<p><img src="/2024/02/18/kubernetes/k8s%E5%9B%BE%E6%A0%87.jpg" alt="k8så›¾æ ‡"></p>
<p>å®¹å™¨æ˜¯æ‰“åŒ…å’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„å¥½æ–¹å¼ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ éœ€è¦ç®¡ç†è¿è¡Œåº”ç”¨ç¨‹åºçš„å®¹å™¨ï¼Œå¹¶ç¡®ä¿ä¸ä¼šåœæœºã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨å‘ç”Ÿæ•…éšœï¼Œåˆ™éœ€è¦å¯åŠ¨å¦ä¸€ä¸ªå®¹å™¨ã€‚å¦‚æœç³»ç»Ÿå¤„ç†æ­¤è¡Œä¸ºï¼Œä¼šä¸ä¼šæ›´å®¹æ˜“ï¼Ÿ</p>
<p>è¿™å°±æ˜¯ Kubernetes æ¥è§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ³•ï¼ Kubernetes ä¸ºä½ æä¾›äº†ä¸€ä¸ªå¯å¼¹æ€§è¿è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¡†æ¶ã€‚ Kubernetes ä¼šæ»¡è¶³ä½ çš„æ‰©å±•è¦æ±‚ã€æ•…éšœè½¬ç§»ã€éƒ¨ç½²æ¨¡å¼ç­‰ã€‚ ä¾‹å¦‚ï¼ŒKubernetes å¯ä»¥è½»æ¾ç®¡ç†ç³»ç»Ÿçš„ Canary éƒ¨ç½²ã€‚</p>
<p>Kubernetes ç®€ç§° k8sï¼Œä¸»è¦åŠŸèƒ½æœ‰ï¼š</p>
<ul>
<li>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</li>
<li>å­˜å‚¨ç¼–æ’</li>
<li>è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š</li>
<li>è‡ªåŠ¨å®Œæˆè£…ç®±è®¡ç®—</li>
<li>è‡ªæˆ‘ä¿®å¤</li>
<li>å¯†é’¥ä¸é…ç½®ç®¡ç†</li>
</ul>
<h3 id="1-2-k8sç»„ä»¶"><a href="#1-2-k8sç»„ä»¶" class="headerlink" title="1.2 k8sç»„ä»¶"></a>1.2 k8sç»„ä»¶</h3><p>ä¸€ä¸ª Kubernetes é›†ç¾¤ç”±ä¸€ç»„è¢«ç§°ä½œèŠ‚ç‚¹çš„æœºå™¨ç»„æˆã€‚è¿™äº›èŠ‚ç‚¹ä¸Šè¿è¡Œ Kubernetes æ‰€ç®¡ç†çš„å®¹å™¨åŒ–åº”ç”¨ã€‚é›†ç¾¤å…·æœ‰è‡³å°‘ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚</p>
<p>å·¥ä½œèŠ‚ç‚¹æ‰˜ç®¡ä½œä¸ºåº”ç”¨è´Ÿè½½çš„ç»„ä»¶çš„ Pod ã€‚æ§åˆ¶å¹³é¢ç®¡ç†é›†ç¾¤ä¸­çš„å·¥ä½œèŠ‚ç‚¹å’Œ Pod ã€‚ ä¸ºé›†ç¾¤æä¾›æ•…éšœè½¬ç§»å’Œé«˜å¯ç”¨æ€§ï¼Œè¿™äº›æ§åˆ¶å¹³é¢ä¸€èˆ¬è·¨å¤šä¸»æœºè¿è¡Œï¼Œé›†ç¾¤è·¨å¤šä¸ªèŠ‚ç‚¹è¿è¡Œã€‚</p>
<p><img src="/2024/02/18/kubernetes/k8s%E6%9E%B6%E6%9E%84.svg" alt="k8sæ¶æ„"></p>
<h4 id="1-2-1-æ§åˆ¶å¹³é¢ç»„ä»¶"><a href="#1-2-1-æ§åˆ¶å¹³é¢ç»„ä»¶" class="headerlink" title="1.2.1 æ§åˆ¶å¹³é¢ç»„ä»¶"></a>1.2.1 æ§åˆ¶å¹³é¢ç»„ä»¶</h4><p><strong>kube-apiserverï¼š</strong></p>
<p>API æœåŠ¡å™¨æ˜¯ Kubernetes æ§åˆ¶é¢çš„ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å…¬å¼€äº† Kubernetes APIã€‚API æœåŠ¡å™¨æ˜¯ Kubernetes æ§åˆ¶é¢çš„å‰ç«¯ã€‚</p>
<p><strong>etcdï¼š</strong></p>
<p>etcd æ˜¯å…¼å…·ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§çš„é”®å€¼æ•°æ®åº“ï¼Œå¯ä»¥ä½œä¸ºä¿å­˜ Kubernetes æ‰€æœ‰é›†ç¾¤æ•°æ®çš„åå°æ•°æ®åº“ã€‚</p>
<p><strong>kube-schedulerï¼š</strong></p>
<p>æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œè´Ÿè´£ç›‘è§†æ–°åˆ›å»ºçš„ã€æœªæŒ‡å®šè¿è¡ŒèŠ‚ç‚¹ï¼ˆnodeï¼‰çš„ Podsï¼Œé€‰æ‹©èŠ‚ç‚¹è®© Pod åœ¨ä¸Šé¢è¿è¡Œã€‚</p>
<p>è°ƒåº¦å†³ç­–è€ƒè™‘çš„å› ç´ åŒ…æ‹¬å•ä¸ª Pod å’Œ Pod é›†åˆçš„èµ„æºéœ€æ±‚ã€ç¡¬ä»¶&#x2F;è½¯ä»¶&#x2F;ç­–ç•¥çº¦æŸã€äº²å’Œæ€§å’Œåäº²å’Œæ€§è§„èŒƒã€æ•°æ®ä½ç½®ã€å·¥ä½œè´Ÿè½½é—´çš„å¹²æ‰°å’Œæœ€åæ—¶é™ã€‚</p>
<p><strong>kube-controller-managerï¼š</strong></p>
<p>åœ¨ä¸»èŠ‚ç‚¹ä¸Šè¿è¡Œæ§åˆ¶å™¨çš„ç»„ä»¶ã€‚</p>
<p>æ§åˆ¶å™¨åŒ…æ‹¬ï¼š</p>
<ul>
<li>èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆNode Controllerï¼‰: è´Ÿè´£åœ¨èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº”</li>
<li>ä»»åŠ¡æ§åˆ¶å™¨ï¼ˆJob controllerï¼‰: ç›‘æµ‹ä»£è¡¨ä¸€æ¬¡æ€§ä»»åŠ¡çš„ Job å¯¹è±¡ï¼Œç„¶ååˆ›å»º Pods æ¥è¿è¡Œè¿™äº›ä»»åŠ¡ç›´è‡³å®Œæˆ</li>
<li>ç«¯ç‚¹æ§åˆ¶å™¨ï¼ˆEndpoints Controllerï¼‰: å¡«å……ç«¯ç‚¹(Endpoints)å¯¹è±¡(å³åŠ å…¥ Service ä¸ Pod)</li>
<li>æœåŠ¡å¸æˆ·å’Œä»¤ç‰Œæ§åˆ¶å™¨ï¼ˆService Account &amp; Token Controllersï¼‰: ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œ</li>
</ul>
<p><strong>cloud-controller-managerï¼š</strong></p>
<p>äº‘æ§åˆ¶å™¨ç®¡ç†å™¨æ˜¯æŒ‡åµŒå…¥ç‰¹å®šäº‘çš„æ§åˆ¶é€»è¾‘çš„æ§åˆ¶å¹³é¢ç»„ä»¶ã€‚äº‘æ§åˆ¶å™¨ç®¡ç†å™¨å…è®¸æ‚¨é“¾æ¥èšåˆåˆ°äº‘æä¾›å•†çš„åº”ç”¨ç¼–ç¨‹æ¥å£ä¸­ï¼Œå¹¶åˆ†ç¦»å‡ºç›¸äº’ä½œç”¨çš„ç»„ä»¶ä¸æ‚¨çš„é›†ç¾¤äº¤äº’çš„ç»„ä»¶ã€‚</p>
<p>ä¸‹é¢çš„æ§åˆ¶å™¨éƒ½åŒ…å«å¯¹äº‘å¹³å°é©±åŠ¨çš„ä¾èµ–ï¼š</p>
<ul>
<li>èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆNode Controllerï¼‰: ç”¨äºåœ¨èŠ‚ç‚¹ç»ˆæ­¢å“åº”åæ£€æŸ¥äº‘æä¾›å•†ä»¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦å·²è¢«åˆ é™¤</li>
<li>è·¯ç”±æ§åˆ¶å™¨ï¼ˆRoute Controllerï¼‰: ç”¨äºåœ¨åº•å±‚äº‘åŸºç¡€æ¶æ„ä¸­è®¾ç½®è·¯ç”±</li>
<li>æœåŠ¡æ§åˆ¶å™¨ï¼ˆService Controllerï¼‰: ç”¨äºåˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤äº‘æä¾›å•†è´Ÿè½½å‡è¡¡å™¨</li>
</ul>
<h4 id="1-2-2-Nodeç»„ä»¶"><a href="#1-2-2-Nodeç»„ä»¶" class="headerlink" title="1.2.2 Nodeç»„ä»¶"></a>1.2.2 Nodeç»„ä»¶</h4><p>èŠ‚ç‚¹ç»„ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç»´æŠ¤è¿è¡Œçš„ Pod å¹¶æä¾› Kubernetes è¿è¡Œç¯å¢ƒã€‚</p>
<p><strong>kubeletï¼š</strong></p>
<p>ä¸€ä¸ªåœ¨é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ä¸Šè¿è¡Œçš„ä»£ç†ã€‚å®ƒä¿è¯å®¹å™¨ï¼ˆcontainersï¼‰éƒ½è¿è¡Œåœ¨ Pod ä¸­ã€‚</p>
<p>kubelet æ¥æ”¶ä¸€ç»„é€šè¿‡å„ç±»æœºåˆ¶æä¾›ç»™å®ƒçš„ PodSpecsï¼Œç¡®ä¿è¿™äº› PodSpecs ä¸­æè¿°çš„å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ä¸”å¥åº·ã€‚ kubelet ä¸ä¼šç®¡ç†ä¸æ˜¯ç”± Kubernetes åˆ›å»ºçš„å®¹å™¨ã€‚</p>
<p><strong>å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰ï¼š</strong></p>
<p>å®¹å™¨è¿è¡Œç¯å¢ƒæ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶ï¼Œä¾‹å¦‚ Docker ã€‚</p>
<h4 id="1-2-3-æ’ä»¶ï¼ˆAddonsï¼‰"><a href="#1-2-3-æ’ä»¶ï¼ˆAddonsï¼‰" class="headerlink" title="1.2.3 æ’ä»¶ï¼ˆAddonsï¼‰"></a>1.2.3 æ’ä»¶ï¼ˆAddonsï¼‰</h4><p>æ’ä»¶ä½¿ç”¨ Kubernetes èµ„æºï¼ˆDaemonSetã€Deploymentç­‰ï¼‰å®ç°é›†ç¾¤åŠŸèƒ½ã€‚ å› ä¸ºè¿™äº›æ’ä»¶æä¾›é›†ç¾¤çº§åˆ«çš„åŠŸèƒ½ï¼Œæ’ä»¶ä¸­å‘½åç©ºé—´åŸŸçš„èµ„æºå±äº <code>kube-system</code> å‘½åç©ºé—´ã€‚</p>
<p><strong>DNSï¼š</strong></p>
<p>å°½ç®¡å…¶ä»–æ’ä»¶éƒ½å¹¶éä¸¥æ ¼æ„ä¹‰ä¸Šçš„å¿…éœ€ç»„ä»¶ï¼Œä½†å‡ ä¹æ‰€æœ‰ Kubernetes é›†ç¾¤éƒ½åº”è¯¥ æœ‰é›†ç¾¤ DNSï¼Œ å› ä¸ºå¾ˆå¤šç¤ºä¾‹éƒ½éœ€è¦ DNS æœåŠ¡ã€‚</p>
<p><strong>Web ç•Œé¢ï¼ˆä»ªè¡¨ç›˜ï¼‰ï¼š</strong></p>
<p>Dashboard æ˜¯Kubernetes é›†ç¾¤çš„é€šç”¨çš„ã€åŸºäº Web çš„ç”¨æˆ·ç•Œé¢ã€‚ å®ƒä½¿ç”¨æˆ·å¯ä»¥ç®¡ç†é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºä»¥åŠé›†ç¾¤æœ¬èº«å¹¶è¿›è¡Œæ•…éšœæ’é™¤ã€‚</p>
<p><strong>å®¹å™¨èµ„æºç›‘æ§ï¼š</strong></p>
<p>å®¹å™¨èµ„æºç›‘æ§å°†å…³äºå®¹å™¨çš„ä¸€äº›å¸¸è§çš„æ—¶é—´åºåˆ—åº¦é‡å€¼ä¿å­˜åˆ°ä¸€ä¸ªé›†ä¸­çš„æ•°æ®åº“ä¸­ï¼Œå¹¶æä¾›ç”¨äºæµè§ˆè¿™äº›æ•°æ®çš„ç•Œé¢ã€‚</p>
<p><strong>é›†ç¾¤å±‚é¢æ—¥å¿—ï¼š</strong></p>
<p>é›†ç¾¤å±‚é¢æ—¥å¿—æœºåˆ¶è´Ÿè´£å°†å®¹å™¨çš„æ—¥å¿—æ•°æ® ä¿å­˜åˆ°ä¸€ä¸ªé›†ä¸­çš„æ—¥å¿—å­˜å‚¨ä¸­ï¼Œè¯¥å­˜å‚¨èƒ½å¤Ÿæä¾›æœç´¢å’Œæµè§ˆæ¥å£ã€‚</p>
<h3 id="1-3-Pod"><a href="#1-3-Pod" class="headerlink" title="1.3 Pod"></a>1.3 Pod</h3><h4 id="1-3-1-Podæ¦‚å¿µ"><a href="#1-3-1-Podæ¦‚å¿µ" class="headerlink" title="1.3.1 Podæ¦‚å¿µ"></a>1.3.1 Podæ¦‚å¿µ</h4><p>Pod æ˜¯ k8s ä¸­çš„æœ€å°å•å…ƒï¼Œä¸€ä¸ª Pod åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œä¸€ä¸ª Pod ä¸ä¼šè·¨è¶Šå¤šä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ã€‚</p>
<p>è€Œæ¯ä¸ª Pod é‡Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ ¹å®¹å™¨ pauseï¼ŒPod ä¸­çš„å…¶ä»–å®¹å™¨éƒ½å…±äº« pause æ ¹å®¹å™¨çš„ç½‘ç»œæ ˆå’ŒvolumeæŒ‚è½½å·ï¼Œå› æ­¤å®¹å™¨ä¹‹é—´çš„é€šä¿¡å’Œæ•°æ®äº¤æ¢ä¼šæ›´ä¸ºé«˜æ•ˆã€‚</p>
<h4 id="1-3-2-RCã€RSã€Deployment"><a href="#1-3-2-RCã€RSã€Deployment" class="headerlink" title="1.3.2 RCã€RSã€Deployment"></a>1.3.2 RCã€RSã€Deployment</h4><p>k8s ç®¡ç† Pod ä¸»è¦ç”¨åˆ°ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>Replication Controllerï¼ˆRCï¼‰ï¼šç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œå¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod æ¥ä»£æ›¿ï¼Œå¦‚æœæœ‰å¼‚å¸¸å¤šå‡ºçš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚</li>
<li>ReplicaSetï¼ˆRSï¼‰ï¼šç›¸æ¯” RC å¤šäº†æ”¯æŒ selectorï¼Œæ¨èä½¿ç”¨ RSã€‚</li>
<li>Deploymentï¼šç”¨æ¥ç®¡ç† RSã€‚</li>
</ul>
<p>æ¥çœ‹çœ‹ Deployment å’Œ RS æ˜¯å¦‚ä½•å®ç°æ›´æ–°çš„ï¼š</p>
<ol>
<li>Deployment åˆ›å»ºæ–°çš„ RS</li>
</ol>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%B8%80.png" alt="RSå’ŒDeploymentå®ç°æ›´æ–°ä¸€"></p>
<ol start="2">
<li>RS1åˆ é™¤ä¸€ä¸ªå®¹å™¨ï¼Œæ¥ç€ RS2 æ–°å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ Pod</li>
</ol>
<p>	</p>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%BA%8C.png" alt="RSå’ŒDeploymentå®ç°æ›´æ–°äºŒ"></p>
<ol start="3">
<li>å…¨éƒ¨æ›´æ–°å®Œä¹‹åï¼ŒRS1 å¹¶ä¸ä¼šåˆ é™¤ï¼Œè€Œæ˜¯ä¿ç•™ç€å¤„äºåœç”¨çŠ¶æ€ï¼Œå¦‚æœæ–°ç‰ˆæœ¬å‡ºäº†é—®é¢˜éœ€è¦å›æ»šï¼Œå°±å¯ä»¥åè¿‡æ¥æ“ä½œå®ç°å›æ»š</li>
</ol>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%B8%89.png" alt="RSå’ŒDeploymentå®ç°æ›´æ–°ä¸‰"></p>
<h4 id="1-3-3-Horizontal-Pod-Autoscaler"><a href="#1-3-3-Horizontal-Pod-Autoscaler" class="headerlink" title="1.3.3 Horizontal Pod Autoscaler"></a>1.3.3 Horizontal Pod Autoscaler</h4><p>Horizontal Pod Autoscalerï¼ˆHPAï¼‰åœ¨k8sé›†ç¾¤ä¸­ç”¨äº Pod æ°´å¹³è‡ªåŠ¨å¼¹æ€§ä¼¸ç¼©ï¼Œå®ƒæ˜¯åŸºäº CPU å’Œå†…å­˜åˆ©ç”¨ç‡å¯¹ Deployment å’Œ RS ä¸­çš„ Pod æ•°é‡è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆé™¤äº† CPU å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥åŸºäºå…¶ä»–åº”ç¨‹åºæä¾›çš„åº¦é‡æŒ‡æ ‡ custom metrics è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰ã€‚</p>
<p>å‡å¦‚ HPA æ£€æµ‹åˆ°å½“å‰ Deployment å’Œ RS æ‰€ç®¡ç†çš„ Pod çš„ CPU æˆ–å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡äº†è®¾å®šä¹‹åï¼Œå°±ä¼šåˆ›å»ºæ–°çš„ Pod æ¥å®ç°é™å‹ï¼Œæ–°å»º Pod çš„æ•°é‡é™åˆ¶ç”± Max å’Œ Min è®¾å®šã€‚</p>
<p><img src="/2024/02/18/kubernetes/HPA.png" alt="HPA"></p>
<h4 id="1-3-4-StatefulSet"><a href="#1-3-4-StatefulSet" class="headerlink" title="1.3.4 StatefulSet"></a>1.3.4 StatefulSet</h4><p>RS å’Œ Deployment éƒ½æ˜¯é¢å‘æ— çŠ¶æ€çš„æœåŠ¡ï¼Œå®ƒä»¬æ‰€ç®¡ç†çš„ Pod çš„ IPã€åå­—ï¼Œå¯åœé¡ºåºç­‰éƒ½æ˜¯éšæœºçš„ï¼Œè€Œ StatefulSet æ˜¯æœ‰çŠ¶æ€çš„é›†åˆï¼Œç®¡ç†æ‰€æœ‰æœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œæ¯”å¦‚ MySQLã€MongoDB é›†ç¾¤ç­‰ã€‚</p>
<p>StatefulSet çš„ç‰¹ç‚¹æœ‰ï¼š</p>
<p>Pod çš„ä¸€è‡´æ€§ï¼šåŒ…å«æ¬¡åºï¼ˆå¯åœé¡ºåºï¼Œä¾‹å¦‚ mysql -&gt; php-fpm -&gt; nginx çš„å¯åŠ¨é¡ºåºï¼‰ã€ç½‘ç»œä¸€è‡´æ€§ï¼ˆä¸ Pod ç›¸å…³ï¼Œä¸è¢«è°ƒåº¦çš„ Node èŠ‚ç‚¹æ— å…³ï¼‰ã€‚</p>
<p>ç¨³å®šçš„å­˜å‚¨ï¼šå³ Pod é‡æ–°è°ƒåº¦ä¹‹åè¿˜æ˜¯è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäº PVCï¼ˆPV æ˜¯é›†ç¾¤ä¸­ç”±ç®¡ç†å‘˜æä¾›æˆ–ä½¿ç”¨å­˜å‚¨ç±»åŠ¨æ€æä¾›çš„ä¸€å—å­˜å‚¨ã€‚å®ƒæ˜¯é›†ç¾¤ä¸­çš„èµ„æºï¼Œå°±åƒèŠ‚ç‚¹æ˜¯é›†ç¾¤èµ„æºä¸€æ ·ã€‚è€Œ PVC æ˜¯ç”¨æˆ·å¯¹å­˜å‚¨çš„è¯·æ±‚ã€‚å®ƒç±»ä¼¼äº Podï¼ŒPod æ¶ˆè€— Node èµ„æºï¼Œè€Œ PVC æ¶ˆè€— PV èµ„æºã€‚ï¼‰ æ¥å®ç°ã€‚</p>
<p>ç¨³å®šçš„æ¬¡åºï¼šå¯¹äºNä¸ªå‰¯æœ¬çš„ StatefulSetï¼Œæ¯ä¸ª Pod éƒ½åœ¨ [0ï¼ŒN) çš„èŒƒå›´å†…åˆ†é…ä¸€ä¸ªæ•°å­—åºå·ï¼Œä¸”æ˜¯å”¯ä¸€çš„ã€‚</p>
<p>ç¨³å®šçš„ç½‘ç»œï¼šPod çš„ hostname æ¨¡å¼ä¸ºï¼š( StatefulSet åç§° ) - ( åºå· )ã€‚</p>
<h4 id="1-3-5-DaemonSet"><a href="#1-3-5-DaemonSet" class="headerlink" title="1.3.5 DaemonSet"></a>1.3.5 DaemonSet</h4><p>DaemonSet ç¡®ä¿å…¨éƒ¨æˆ–è€…ä¸€éƒ¨åˆ† Node ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ï¼Œå½“æœ‰ Node åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Podï¼Œå½“è¿™äº› Node é€€å‡ºé›†ç¾¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚</p>
<p>DaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š</p>
<ul>
<li>è¿è¡Œé›†ç¾¤å­˜å‚¨ daemonï¼Œä¾‹å¦‚åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œ glusterdã€cephç­‰ã€‚</li>
<li>è¿è¡Œæ—¥å¿—æ”¶é›†daemonï¼Œä¾‹å¦‚fluentdã€logstashç­‰ã€‚</li>
<li>è¿è¡Œç›‘æ§daemonï¼Œä¾‹å¦‚ Prometheus çš„ Node exporterã€zabbixç­‰ã€‚</li>
</ul>
<h4 id="1-3-6-Jobå’ŒCron-Job"><a href="#1-3-6-Jobå’ŒCron-Job" class="headerlink" title="1.3.6 Jobå’ŒCron Job"></a>1.3.6 Jobå’ŒCron Job</h4><p>Job è´Ÿè´£æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå³ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª Pod æˆåŠŸç»“æŸã€‚</p>
<p>è¿™é‡Œå¯èƒ½æœ‰äººä¼šæƒ³ï¼Œé‚£åœ¨ linux ä¸Šç›´æ¥æ‰§è¡Œè„šæœ¬ä¸å°±è¡Œäº†å—ï¼Ÿå…¶å®è¿™å°±ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœè„šæœ¬æ‰§è¡Œå¤±è´¥é‚£ä¹ˆä¹…é€€å‡ºä¸”ä¸ä¼šå†æ‰§è¡Œäº†ï¼Œéœ€è¦æ‰§è¡Œå°±å¿…é¡»æ‰‹åŠ¨ï¼Œä½† Job è®¾ç½®çš„ä»»åŠ¡åªæœ‰åœ¨æ­£å¸¸æ‰§è¡Œç»“æŸåæ‰ä¼šç»“æŸï¼Œå¦åˆ™ä¸€ç›´æ‰§è¡Œåˆ°æˆåŠŸä¸ºæ­¢ã€‚Job ä¹Ÿå¯ä»¥è®¾ç½®æˆåŠŸçš„æ¬¡æ•°è¦è¾¾åˆ°å‡ æ¬¡æ‰å…è®¸é€€å‡ºã€‚</p>
<p>Cron Job æ˜¯åŸºäºæ—¶é—´ç®¡ç†æ§åˆ¶ Jobï¼Œå³åœ¨ç»™å®šçš„æ—¶é—´åªè¿è¡Œä¸€æ¬¡ã€å‘¨æœŸæ€§çš„åœ¨æŒ‡å®šæ—¶é—´è¿è¡Œã€‚</p>
<h4 id="1-3-7-Service"><a href="#1-3-7-Service" class="headerlink" title="1.3.7 Service"></a>1.3.7 Service</h4><p>Pod çš„ç”Ÿå‘½æ˜¯æœ‰é™çš„ï¼Œå¦‚æœ Pod é‡å¯ IP ä¹Ÿå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœæˆ‘ä»¬å°† Pod çš„ IP å†™æ­»ï¼ŒPod å¦‚æœæŒ‚äº†æˆ–é‡å¯ï¼Œå…¶å®ƒçš„æœåŠ¡ä¹Ÿä¼šä¸å¯ç”¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæˆ‘ä»¬çš„æœåŠ¡ï¼ˆå„ç§ Podï¼‰æ³¨å†Œåˆ°æœåŠ¡å‘ç°ä¸­å¿ƒå»ï¼Œè®©æœåŠ¡å‘ç°ä¸­å¿ƒå»åŠ¨æ€æ›´æ–°å…¶å®ƒæœåŠ¡çš„é…ç½®å°±å¯ä»¥äº†ï¼Œk8s å°±ç»™æˆ‘ä»¬æä¾›äº†è¿™ä¹ˆä¸€ä¸ªæœåŠ¡ï¼Œå³ Serviceã€‚</p>
<p>æˆ‘ä»¬è¿™æ ·å°±å¯ä»¥ä¸ç”¨å»ç®¡åç«¯çš„ Pod å¦‚ä½•å˜åŒ–ï¼Œåªéœ€è¦æŒ‡å®š Service çš„åœ°å€å°±å¯ä»¥äº†ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸­é—´æ·»åŠ äº†ä¸€å±‚æœåŠ¡å‘ç°çš„ä¸­é—´ä»¶ï¼ŒPod é”€æ¯æˆ–è€…é‡å¯åï¼ŒæŠŠè¿™ä¸ª Pod çš„åœ°å€æ³¨å†Œåˆ°è¿™ä¸ªæœåŠ¡å‘ç°ä¸­å¿ƒå»ã€‚</p>
<p><img src="/2024/02/18/kubernetes/service.png" alt="service"></p>
<h3 id="1-4-k8sçš„ç½‘ç»œé€šè®¯æ–¹å¼"><a href="#1-4-k8sçš„ç½‘ç»œé€šè®¯æ–¹å¼" class="headerlink" title="1.4 k8sçš„ç½‘ç»œé€šè®¯æ–¹å¼"></a>1.4 k8sçš„ç½‘ç»œé€šè®¯æ–¹å¼</h3><p>k8s çš„ç½‘ç»œæ¨¡å‹å‡å®šäº†æ‰€æœ‰çš„ Pod éƒ½åœ¨ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿é€šçš„æ‰å¹³åŒ–ç½‘ç»œç©ºé—´ä¸­ï¼Œåœ¨è¿™ GCEï¼ˆGoogle Compute Engineï¼‰é‡Œé¢æ˜¯ç°æˆçš„ç½‘ç»œæ¨¡å‹ã€‚</p>
<p>Flannel æ˜¯ CoreOS å›¢é˜Ÿé’ˆå¯¹ Kubernetes è®¾è®¡ä¸€ä¸ªç½‘ç»œè§„åˆ’æœåŠ¡ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯è®©é›†ç¾¤ä¸­çš„ä¸åŒèŠ‚ç‚¹ä¸»æœºåˆ›å»º Docker å®¹å™¨éƒ½å…·æœ‰å…¨é›†ç¾¤å”¯ä¸€çš„è™šæ‹Ÿ IP åœ°å€ã€‚è€Œä¸”å®ƒè¿˜èƒ½åœ¨è¿™äº› IP åœ°å€ä¹‹é—´å»ºç«‹ä¸€ä¸ªè¦†ç›–ç½‘ç»œï¼ˆOverlay Networkï¼‰ï¼Œé€šè¿‡è¦†ç›–ç½‘ç»œå°†æ•°æ®åŒ…åŸå°ä¸åŠ¨çš„ä¼ é€’åˆ°ç›®æ ‡å®¹å™¨å†…ã€‚</p>
<p>é€šè¿‡ä¸€ä¸ªæ¶æ„å›¾æ¥çœ‹çœ‹ä¸åŒæƒ…å†µä¸‹çš„é€šè®¯æ˜¯æ€ä¹ˆæ ·çš„ï¼š</p>
<p><img src="/2024/02/18/kubernetes/%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="ç½‘ç»œé€šè®¯æ–¹å¼æ¶æ„å›¾"></p>
<p>é€šè®¯æƒ…å†µä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p>
<ol>
<li>åŒä¸€ Pod ä¸åŒå®¹å™¨ä¹‹é—´çš„é€šä¿¡ï¼šé‡‡ç”¨ pause ç½‘ç»œæ ˆã€‚</li>
<li>åŒä¸€ Node ä¸åŒ Pod ä¹‹é—´çš„é€šä¿¡ï¼šé€šè¿‡ docker0 ç½‘æ¡¥è¿›è¡Œé€šä¿¡ã€‚</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E5%90%8C%E4%B8%80Node%E5%86%85%E4%B8%8D%E5%90%8CPod%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E8%AE%AF.png" alt="åŒä¸€Nodeå†…ä¸åŒPodä¹‹é—´çš„é€šè®¯"></p>
<ol>
<li>ä¸åŒ Node çš„ Pod ä¹‹é—´çš„é€šä¿¡ï¼šä¸åŒ Node çš„ Pod ä¹‹é—´çš„é€šä¿¡æ˜¯ k8s ç½‘ç»œé€šä¿¡çš„éš¾ç‚¹ï¼Œæ˜¯é€šè¿‡ Flannel ç½‘ç»œé€šè®¯æ–¹å¼æ¥å®ç°çš„ï¼Œé€šè®¯çš„è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š<ul>
<li>æ•°æ®åŒ…ä» Node1 çš„ Pod åˆ°è¾¾ docker0 ç½‘æ¡¥</li>
<li>Flanneld ä¼šå¼€å¯ä¸€ä¸ª Flannel0 çš„ç½‘æ¡¥ï¼Œç”¨æ¥æŠ“å–åˆ°è¾¾ docker0 çš„æ•°æ®ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé’©å­å‡½æ•°</li>
<li>Flanneld ä¼šæœ‰å¾ˆå¤šè·¯ç”±è¡¨ä¿¡æ¯ï¼Œæ˜¯å­˜å‚¨åœ¨ etcd ä¸­ç”± Flanneld è‡ªåŠ¨è·å–çš„ï¼Œé€šè¿‡è·¯ç”±è¡¨çŸ¥é“äº†è½¬å‘ä¿¡æ¯åå°±é€šè¿‡ç‰©ç†ç½‘å¡è¿›è¡Œè½¬å‘</li>
<li>å‘é€åˆ°ç›®æ ‡ä¸»æœºçš„ç‰©ç†ç½‘å¡åï¼Œå°±ä¼šå†é€šè¿‡ Flanneld -&gt; Flannel0ç½‘æ¡¥ -&gt; docker0ç½‘æ¡¥ï¼Œæœ€ç»ˆåˆ°è¾¾ç›®çš„ Pod</li>
</ul>
</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E4%B8%8D%E5%90%8CNode%E7%9A%84Pod%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1.png" alt="ä¸åŒNodeçš„Podä¹‹é—´çš„é€šä¿¡"></p>
<ol>
<li>Pod ä¸ service ä¹‹é—´çš„é€šä¿¡ï¼šé‡‡ç”¨å„èŠ‚ç‚¹çš„ iptables è§„åˆ™æ¥å®ç°ã€‚</li>
<li>Pod åˆ°å¤–ç½‘ï¼šé€šè¿‡ Flanneld åˆ°è¾¾ç‰©ç†ç½‘å¡ï¼Œç»è¿‡è·¯ç”±é€‰æ‹©åï¼Œiptables æ‰§è¡Œ Masqueradeï¼ŒæŠŠPod çš„è™šæ‹Ÿ IP æ”¹ä¸º ç‰©ç†ç½‘å¡çš„ IPï¼Œåœ¨å‘å¤–ç½‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ã€‚</li>
<li>å¤–ç½‘åˆ° Podï¼šé€šè¿‡ service è¿›è¡Œè®¿é—®ï¼Œä¸€èˆ¬ä½¿ç”¨ NodePortã€‚</li>
</ol>
<h2 id="äºŒã€k8séƒ¨ç½²"><a href="#äºŒã€k8séƒ¨ç½²" class="headerlink" title="äºŒã€k8séƒ¨ç½²"></a>äºŒã€k8séƒ¨ç½²</h2><p>æœ¬æ¬¡ k8s éƒ¨ç½²ä¸ºä»¥ä¸‹ç¯å¢ƒ</p>
<p><img src="/2024/02/18/kubernetes/k8s%E9%83%A8%E7%BD%B2%E6%9D%A1%E4%BB%B6.png" alt="k8séƒ¨ç½²æ¡ä»¶"></p>
<h3 id="2-1-åŸºæœ¬ç¯å¢ƒé…ç½®ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"><a href="#2-1-åŸºæœ¬ç¯å¢ƒé…ç½®ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰" class="headerlink" title="2.1 åŸºæœ¬ç¯å¢ƒé…ç½®ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"></a>2.1 åŸºæœ¬ç¯å¢ƒé…ç½®ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3><ol>
<li>åœ¨å„ä¸»æœºè®¾ç½®ä¸»æœºåä»¥åŠhostæ–‡ä»¶è§£æ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master01</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br><span class="line">hostnamectl set-hostname k8s-node02</span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.88.10 k8s-master01</span><br><span class="line">192.168.88.20 k8s-node01</span><br><span class="line">192.168.88.21 k8s-node02</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å®‰è£…ä¾èµ–</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install conntrack ntpdate ntp ipvsadm ipset jp iptables curl stsstat libseccomp wget vim net-tools git</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>è®¾ç½®é˜²ç«å¢™ä¸ºiptableså¹¶è®¾ç½®ç©ºè§„åˆ™</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line">yum -y install iptables-services</span><br><span class="line">systemctl start iptables</span><br><span class="line">systemctl enable iptables</span><br><span class="line">iptables -F &amp;&amp; service iptables save</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å…³é—­è™šæ‹Ÿå†…å­˜å’Œselinux</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sed -i &#x27;/ swap / s/^\(.*\)$/#/g&#x27; /etc/fstab</span><br><span class="line">setenforce 0 &amp;&amp; sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>è°ƒæ•´å†…æ ¸å‚æ•°</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ipv6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0 # ç¦ç”¨swapï¼Œåªæœ‰ç³»ç»ŸOOMæ—¶æ‰å…è®¸ä½¿ç”¨</span><br><span class="line">vm.overcommit_memory=1 # ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨</span><br><span class="line">vm.panic_on_oom=0 # å¼€å¯OOM</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line">cp kubernetes.conf /etc/sysctl.d/kubernetes.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>è°ƒæ•´ç³»ç»Ÿæ—¶åŒº</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ä¸ºä¸­å›½/ä¸Šæµ·</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†å½“å‰UTCæ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</span></span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯ä¾èµ–äºæ—¶é—´çš„æœåŠ¡</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>å…³é—­ä¸éœ€è¦çš„æœåŠ¡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…³é—­é‚®ä»¶æœåŠ¡</span></span><br><span class="line">systemctl stop postfix &amp;&amp; systemctl disable postfix</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>è®¾ç½®rsyslogå’Œsystemd journald</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒä¹…åŒ–ä¿å­˜æ—¥å¿—ç›®å½•</span></span><br><span class="line">mkdir /var/log/journal</span><br><span class="line">mkdir /etc/systemd/journald.conf.d</span><br><span class="line">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF</span><br><span class="line">[Journal]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜</span></span><br><span class="line">Storage=persistent</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å‹ç¼©å†å²æ—¥å¿—</span></span><br><span class="line">Compress=yes</span><br><span class="line"> </span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æœ€å¤§å ç”¨ç©ºé—´ 10G</span></span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 200M</span></span><br><span class="line">SystemMaxFileSize=200M</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨</span></span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¸å°†æ—¥å¿—è½¬å‘åˆ° syslog</span></span><br><span class="line">ForwardToSyslog=no</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>å‡çº§å†…æ ¸</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯¼å…¥å…¬é’¥</span></span><br><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…elrepoæº</span></span><br><span class="line">yum -y install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡çº§å†…æ ¸</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span></span><br><span class="line">grub2-set-default &quot;CentOS Linux (5.4.116-1.e17.elrepo.x86_64) 7 (Core)&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹å†…æ ¸å¯åŠ¨é¡¹</span></span><br><span class="line">grub2-editenv list</span><br></pre></td></tr></table></figure>

<h3 id="2-2-kubeadméƒ¨ç½²ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"><a href="#2-2-kubeadméƒ¨ç½²ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰" class="headerlink" title="2.2 kubeadméƒ¨ç½²ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"></a>2.2 kubeadméƒ¨ç½²ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3><ol>
<li>kube-proxyå¼€å¯ipvså‰ç½®æ¡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">vim /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack&quot;</span><br><span class="line"></span><br><span class="line">for kernel_module in $&#123;ipvs_modules&#125;;</span><br><span class="line">do</span><br><span class="line">    /sbin/modinfo -F filename $&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe $&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å®‰è£…docker</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum -y install yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce docker-ce-cli</span><br><span class="line"></span><br><span class="line">mkdir /etc/docker</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">        &quot;registry-mirrors&quot;: [&quot;http://f1361db2.m.daocloud.io&quot;],</span><br><span class="line">        &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">        &quot;log-driver&quot;:&quot;json-file&quot;,</span><br><span class="line">        &quot;log-opts&quot;:&#123;</span><br><span class="line">                &quot;max-size&quot;:&quot;100m&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker</span><br></pre></td></tr></table></figure>

<h3 id="2-3-å®‰è£…kubeadmï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"><a href="#2-3-å®‰è£…kubeadmï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰" class="headerlink" title="2.3 å®‰è£…kubeadmï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"></a>2.3 å®‰è£…kubeadmï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3><ol>
<li>å®‰è£… kubeadm kubectl kubelet</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum -y install kubeadm kubectl kubelet</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é€šè¿‡kubeadmæŸ¥çœ‹ç›®å‰å„é•œåƒç‰ˆæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.21.0</span><br><span class="line">k8s.gcr.io/pause:3.4.1</span><br><span class="line">k8s.gcr.io/etcd:3.4.13-0</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.0</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™è„šæœ¬ï¼Œé€šè¿‡é˜¿é‡Œé•œåƒå®‰è£…</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim k8s_images.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">apiserver_var=v1.21.0</span><br><span class="line">controller_manager_var=v1.21.0</span><br><span class="line">scheduler_var=v1.21.0</span><br><span class="line">proxy_var=v1.21.0</span><br><span class="line">pause_var=3.4.1</span><br><span class="line">etcd_var=3.4.13-0</span><br><span class="line">coredns_var=v1.8.0</span><br><span class="line">image_aliyun=(kube-apiserver:$apiserver_var kube-controller-manager:$controller_manager_var kube-scheduler:$scheduler_var kube-proxy:$proxy_var pause:$pause_var etcd:$etcd_var coredns/coredns:$coredns_var)</span><br><span class="line"></span><br><span class="line">for image in $&#123;image_aliyun[@]&#125;</span><br><span class="line">do</span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$image</span><br><span class="line">    docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/$image k8s.gcr.io/$&#123;image&#125;</span><br><span class="line">    docker rmi  registry.cn-hangzhou.aliyuncs.com/google_containers/$image</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">./k8s_images.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é—®é¢˜</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”±äºæ­å·é˜¿é‡Œæºé‡Œç›®å‰æ²¡æœ‰coredns:v1.8.0ç‰ˆæœ¬ï¼Œæ‰€ä»¥åœ¨åŒ—äº¬é˜¿é‡Œæºä¸‹è½½</span></span><br><span class="line">docker pull registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0</span><br><span class="line">docker tag  registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0 k8s.gcr.io/coredns/coredns:v1.8.0</span><br><span class="line">docker rmi  registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0</span><br></pre></td></tr></table></figure>

<h3 id="2-4-åˆå§‹åŒ–MasterèŠ‚ç‚¹"><a href="#2-4-åˆå§‹åŒ–MasterèŠ‚ç‚¹" class="headerlink" title="2.4 åˆå§‹åŒ–MasterèŠ‚ç‚¹"></a>2.4 åˆå§‹åŒ–MasterèŠ‚ç‚¹</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults &gt; kubeadm.config.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">kubeadm.config.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="comment"># æ”¹æˆmasterèŠ‚ç‚¹IPåœ°å€</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.10</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.21</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="comment"># æ·»åŠ è¿™ä¸€æ®µ</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">kubeproxy:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">ipvs</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm.config.yml --upload-certs | tee kubeadm-init.log</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆå§‹åŒ–åæ“ä½œ</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<h3 id="2-5-éƒ¨ç½²ç½‘ç»œ"><a href="#2-5-éƒ¨ç½²ç½‘ç»œ" class="headerlink" title="2.5 éƒ¨ç½²ç½‘ç»œ"></a>2.5 éƒ¨ç½²ç½‘ç»œ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p k8s/plugin/flannel &amp;&amp; cd k8s/plugin/flannel</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl create -f kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>kube-flannel.ymlæ–‡ä»¶å†…å®¹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp.flannel.unprivileged</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">seccomp.security.alpha.kubernetes.io/allowedProfileNames:</span> <span class="string">docker/default</span></span><br><span class="line">    <span class="attr">seccomp.security.alpha.kubernetes.io/defaultProfileName:</span> <span class="string">docker/default</span></span><br><span class="line">    <span class="attr">apparmor.security.beta.kubernetes.io/allowedProfileNames:</span> <span class="string">runtime/default</span></span><br><span class="line">    <span class="attr">apparmor.security.beta.kubernetes.io/defaultProfileName:</span> <span class="string">runtime/default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configMap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secret</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">emptyDir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hostPath</span></span><br><span class="line">  <span class="attr">allowedHostPaths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/etc/cni/net.d&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/etc/kube-flannel&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/run/flannel&quot;</span></span><br><span class="line">  <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Users and groups</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="comment"># Privilege Escalation</span></span><br><span class="line">  <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">defaultAllowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Capabilities</span></span><br><span class="line">  <span class="attr">allowedCapabilities:</span> [<span class="string">&#x27;NET_ADMIN&#x27;</span>, <span class="string">&#x27;NET_RAW&#x27;</span>]</span><br><span class="line">  <span class="attr">defaultAddCapabilities:</span> []</span><br><span class="line">  <span class="attr">requiredDropCapabilities:</span> []</span><br><span class="line">  <span class="comment"># Host namespaces</span></span><br><span class="line">  <span class="attr">hostPID:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostIPC:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostPorts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">min:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">max:</span> <span class="number">65535</span></span><br><span class="line">  <span class="comment"># SELinux</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="comment"># SELinux is unused in CaaSP</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">&#x27;RunAsAny&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;extensions&#x27;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&#x27;podsecuritypolicies&#x27;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&#x27;use&#x27;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&#x27;psp.flannel.unprivileged&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/os</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.14.0-rc1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.14.0-rc1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/flannel</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br></pre></td></tr></table></figure>

<p>éƒ¨ç½²å®Œåå¯ä»¥çœ‹åˆ° flannel ç½‘å¡</p>
<p><img src="/2024/02/18/kubernetes/flannel%E7%BD%91%E5%8D%A1.png" alt="flannelç½‘å¡"></p>
<p>é€šè¿‡å‘½ä»¤æŸ¥çœ‹å„æ¨¡å—è¿è¡Œæƒ…å†µ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/k8s%E5%90%84%E6%A8%A1%E5%9D%97%E8%BF%90%E8%A1%8C%E6%83%85%E5%86%B5.png" alt="k8så„æ¨¡å—è¿è¡Œæƒ…å†µ"></p>
<h3 id="2-6-æ·»åŠ NodeèŠ‚ç‚¹"><a href="#2-6-æ·»åŠ NodeèŠ‚ç‚¹" class="headerlink" title="2.6 æ·»åŠ NodeèŠ‚ç‚¹"></a>2.6 æ·»åŠ NodeèŠ‚ç‚¹</h3><ol>
<li>æŸ¥çœ‹kubeadm-init.log</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">kubeadm join 192.168.88.10:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:37c9645a7a2ee75301f132537240157ecd4f464494022cc442f77489c1978989</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨nodeä¸»æœºä¸Šæ‰§è¡Œ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.88.10:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:37c9645a7a2ee75301f132537240157ecd4f464494022cc442f77489c1978989</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åœ¨masterä¸»æœºæŸ¥çœ‹æ˜¯å¦åŠ å…¥æˆåŠŸ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">...</span><br><span class="line">kubectl get pod -n kube-system -o wide</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h2 id="ä¸‰ã€k8sèµ„æºæ¸…å•"><a href="#ä¸‰ã€k8sèµ„æºæ¸…å•" class="headerlink" title="ä¸‰ã€k8sèµ„æºæ¸…å•"></a>ä¸‰ã€k8sèµ„æºæ¸…å•</h2><p>åœ¨ k8s ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨ yaml æ ¼å¼çš„æ–‡ä»¶æ¥åˆ›å»ºç¬¦åˆæˆ‘ä»¬é¢„æœŸæœŸæœ›çš„ podï¼Œè¿™æ ·çš„ yaml æ–‡ä»¶æˆ‘ä»¬ä¸€èˆ¬ç§°ä¸ºèµ„æºæ¸…å•ã€‚</p>
<h3 id="3-1-èµ„æºç±»å‹"><a href="#3-1-èµ„æºç±»å‹" class="headerlink" title="3.1 èµ„æºç±»å‹"></a>3.1 èµ„æºç±»å‹</h3><p><strong>åç§°ç©ºé—´çº§åˆ«</strong></p>
<p>å·¥ä½œè´Ÿè½½å‹èµ„æºï¼šPodã€RSã€Deploymentã€StatefulSetã€DaemonSetã€Jobã€CronJob</p>
<p>æœåŠ¡å‘ç°åŠè´Ÿè½½å‡è¡¡å‹èµ„æºï¼šService</p>
<p>é…ç½®ä¸å­˜å‚¨å‹èµ„æºï¼šVolumeã€CSI</p>
<p>ç‰¹æ®Šç±»å‹çš„å­˜å‚¨å·ï¼šConfigMap(å½“é…ç½®ä¸­å¿ƒæ¥ä½¿ç”¨çš„èµ„æºç±»å‹)ã€Secret(ä¿å­˜æ•æ„Ÿæ•°æ®)ã€DownwarAPI(æŠŠå¤–éƒ¨ç¯å¢ƒä¸­çš„ä¿¡æ¯è¾“å‡ºç»™å®¹å™¨)</p>
<p>é›†ç¾¤çº§èµ„æºï¼šNamespaceã€Nodeã€Roleã€ClusterRoleã€RoleBindingã€ClusterRoleBinding</p>
<p>å…ƒæ•°æ®å‹èµ„æºï¼šHPAã€PodTemplateã€LimitRange</p>
<h3 id="3-2-å¸¸ç”¨å­—æ®µ"><a href="#3-2-å¸¸ç”¨å­—æ®µ" class="headerlink" title="3.2 å¸¸ç”¨å­—æ®µ"></a>3.2 å¸¸ç”¨å­—æ®µ</h3><p><strong>å¿…è¦å±æ€§</strong></p>
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>å­—æ®µç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>apiVersion</td>
<td>String</td>
<td>K8S API çš„ç‰ˆæœ¬ï¼Œç›®å‰åŸºæœ¬æ˜¯v1ï¼Œå¯ä»¥ç”¨ kubectl api-versions å‘½ä»¤æŸ¥è¯¢</td>
</tr>
<tr>
<td>kind</td>
<td>String</td>
<td>è¿™é‡ŒæŒ‡çš„æ˜¯ yaml æ–‡ä»¶å®šä¹‰çš„èµ„æºç±»å‹å’Œè§’è‰²ï¼Œæ¯”å¦‚: Pod</td>
</tr>
<tr>
<td>metadata</td>
<td>Object</td>
<td>å…ƒæ•°æ®å¯¹è±¡ï¼Œå›ºå®šå€¼å†™ metadata</td>
</tr>
<tr>
<td>metadata.name</td>
<td>String</td>
<td>å…ƒæ•°æ®å¯¹è±¡çš„åå­—ï¼Œè¿™é‡Œç”±æˆ‘ä»¬ç¼–å†™ï¼Œæ¯”å¦‚å‘½åPodçš„åå­—</td>
</tr>
<tr>
<td>metadata.namespace</td>
<td>String</td>
<td>å…ƒæ•°æ®å¯¹è±¡çš„å‘½åç©ºé—´ï¼Œç”±æˆ‘ä»¬è‡ªèº«å®šä¹‰</td>
</tr>
<tr>
<td>spec</td>
<td>Object</td>
<td>è¯¦ç»†å®šä¹‰å¯¹è±¡ï¼Œå›ºå®šå€¼å†™Spec</td>
</tr>
<tr>
<td>spec.containers[]</td>
<td>list</td>
<td>è¿™é‡Œæ˜¯Specå¯¹è±¡çš„å®¹å™¨åˆ—è¡¨å®šä¹‰ï¼Œæ˜¯ä¸ªåˆ—è¡¨</td>
</tr>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>è¿™é‡Œå®šä¹‰å®¹å™¨çš„åå­—</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>è¿™é‡Œå®šä¹‰è¦ç”¨åˆ°çš„é•œåƒåç§°</td>
</tr>
</tbody></table>
<p><strong>spec ä¸»è¦å¯¹è±¡</strong></p>
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>å­—æ®µç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>å®šä¹‰å®¹å™¨çš„åå­—</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>å®šä¹‰è¦ç”¨åˆ°çš„é•œåƒçš„åç§°</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>String</td>
<td>å®šä¹‰é•œåƒæ‹‰å–ç­–ç•¥ï¼Œæœ‰ Alwaysï¼ŒNeverï¼ŒIfNotPresent ä¸‰ä¸ªå€¼è¯¾é€‰ ï¼ˆ1ï¼‰Alwaysï¼šæ„æ€æ˜¯æ¯æ¬¡å°è¯•é‡æ–°æ‹‰å–é•œåƒ ï¼ˆ2ï¼‰Neverï¼šè¡¨ç¤ºä»…ä½¿ç”¨æœ¬åœ°é•œåƒ ï¼ˆ3ï¼‰IfNotPresentï¼šå¦‚æœæœ¬åœ°æœ‰é•œåƒå°±æ˜¯ç”¨æœ¬åœ°é•œåƒï¼Œæ²¡æœ‰å°±æ‹‰å–åœ¨çº¿é•œåƒã€‚ä¸Šé¢ä¸‰ä¸ªå€¼éƒ½æ²¡è®¾ç½®çš„è¯ï¼Œé»˜è®¤æ˜¯ Always</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>æŒ‡å®šå®¹å™¨å¯åŠ¨å‘½ä»¤ï¼Œå› ä¸ºæ˜¯æ•°ç»„å¯ä»¥æŒ‡å®šå¤šä¸ªï¼Œä¸æŒ‡å®šåˆ™ä½¿ç”¨é•œåƒæ‰“åŒ…æ—¶ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>æŒ‡å®šå®¹å™¨å¯åŠ¨å‘½ä»¤å‚æ•°ï¼Œå› ä¸ºæ˜¯æ•°ç»„å¯ä»¥æŒ‡å®šå¤šä¸ª</td>
</tr>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>æŒ‡å®šå®¹å™¨çš„å·¥ä½œç›®å½•</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>æŒ‡å®šå®¹å™¨å†…éƒ¨çš„å­˜å‚¨å·é…ç½®</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>æŒ‡å®šå¯ä»¥è¢«å®¹å™¨æŒ‚è½½çš„å­˜å‚¨å·çš„åç§°</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>æŒ‡å®šå¯ä»¥è¢«å®¹å™¨æŒ‚è½½çš„å®¹å™¨å·çš„è·¯å¾„</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].readOnly</td>
<td>String</td>
<td>è®¾ç½®å­˜å‚¨å·è·¯å¾„çš„è¯»å†™æ¨¡å¼ï¼Œtrue æˆ–è€… falseï¼Œé»˜è®¤ä¸ºè¯»å†™æ¨¡å¼</td>
</tr>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>æŒ‡å®šå®¹å™¨éœ€è¦ç”¨åˆ°çš„ç«¯å£åˆ—è¡¨</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>æŒ‡å®šç«¯å£åç§°</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>æŒ‡å®šå®¹å™¨éœ€è¦ç›‘å¬çš„ç«¯å£å·</td>
</tr>
<tr>
<td>spec.containers[].ports.hostPort</td>
<td>String</td>
<td>æŒ‡å®šå®¹å™¨æ‰€åœ¨ä¸»æœºéœ€è¦ç›‘å¬çš„ç«¯å£å·ï¼Œé»˜è®¤è·Ÿä¸Šé¢ containerPort ç›¸åŒï¼Œæ³¨æ„è®¾ç½®äº† hostPort åŒä¸€å°ä¸»æœºæ— æ³•å¯åŠ¨è¯¥å®¹å™¨çš„ç›¸åŒå‰¯æœ¬ï¼ˆå› ä¸ºä¸»æœºçš„ç«¯å£å·ä¸èƒ½ç›¸åŒï¼Œè¿™æ ·ä¼šå†²çªï¼‰</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>æŒ‡å®šç«¯å£åè®®ï¼Œæ”¯æŒTCPå’ŒUDPï¼Œé»˜è®¤å€¼ä¸ºTCP</td>
</tr>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>æŒ‡å®šå®¹å™¨è¿è¡Œåƒéœ€è®¾ç½®çš„ç¯å¢ƒå˜é‡åˆ—è¡¨</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>æŒ‡å®šç¯å¢ƒå˜é‡åç§°</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>æŒ‡å®šç¯å¢ƒå˜é‡å€¼</td>
</tr>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>æŒ‡å®šèµ„æºé™åˆ¶å’Œèµ„æºè¯·æ±‚çš„å€¼ï¼ˆè¿™é‡Œå¼€å§‹å°±æ˜¯è®¾ç½®å®¹å™¨çš„èµ„æºä¸Šé™ï¼‰</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>æŒ‡å®šè®¾ç½®å®¹å™¨è¿è¡Œæ—¶èµ„æºçš„è¿è¡Œä¸Šé™</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>æŒ‡å®šCPUçš„é™åˆ¶ï¼Œå•ä½ä¸º core æ•°ï¼Œå°†ç”¨äº docker run â€“cpu-shares å‚æ•°</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>æŒ‡å®š MEM å†…å­˜çš„é™åˆ¶ï¼Œå•ä½ä¸º MIBï¼ŒGIB</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>æŒ‡å®šå®¹å™¨å¯åŠ¨å’Œè°ƒåº¦å®¤çš„é™åˆ¶è®¾ç½®</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPUè¯·æ±‚ï¼Œå•ä½ä¸º core æ•°ï¼Œå®¹å™¨å¯åŠ¨æ—¶åˆå§‹åŒ–å¯ç”¨æ•°é‡</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>å†…å­˜è¯·æ±‚ï¼Œå•ä½ä¸º MIBï¼ŒGIB å®¹å™¨å¯åŠ¨çš„åˆå§‹åŒ–å¯ç”¨æ•°é‡</td>
</tr>
</tbody></table>
<p><strong>é¢å¤–çš„å‚æ•°é¡¹</strong></p>
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>å­—æ®µç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>å®šä¹‰Podé‡å¯ç­–ç•¥ï¼Œå¯ä»¥é€‰æ‹©å€¼ä¸º Alwaysã€OnFailureã€Neverï¼Œé»˜è®¤å€¼ä¸º Alwaysã€‚1. Alwaysï¼šPodä¸€æ—¦ç»ˆæ­¢è¿è¡Œï¼Œåˆ™æ— è®ºå®¹å™¨æ˜¯å¦‚ä½•ç»ˆæ­¢çš„ï¼Œkubelet æœåŠ¡éƒ½å°†é‡å¯å®ƒã€‚2. OnFailureï¼šåªæœ‰ Pod ä»¥éé›¶é€€å‡ºç ç»ˆæ­¢æ—¶ï¼Œkubelet æ‰ä¼šé‡å¯è¯¥å®¹å™¨ã€‚å¦‚æœå®¹å™¨æ­£å¸¸ç»“æŸï¼ˆé€€å‡ºç ä¸º0ï¼‰ï¼Œåˆ™ kubelet å°†ä¸ä¼šé‡å¯å®ƒã€‚3. Neverï¼šPod ç»ˆæ­¢åï¼Œkubelet å°†é€€å‡ºç æŠ¥å‘Šç»™ Masterï¼Œä¸ä¼šé‡å¯è¯¥ Podã€‚</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>å®šä¹‰ Node çš„ Label è¿‡æ»¤æ ‡ç­¾ï¼Œä»¥ key:value æ ¼å¼æŒ‡å®š</td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>Object</td>
<td>å®šä¹‰pull é•œåƒæ˜¯ä½¿ç”¨ secret åç§°ï¼Œä»¥ name:secretkey æ ¼å¼æŒ‡å®š</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>å®šä¹‰æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤å€¼ä¸º falseã€‚è®¾ç½® true è¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼Œä¸ä½¿ç”¨ docker ç½‘æ¡¥ï¼ŒåŒæ—¶è®¾ç½®äº† true å°†æ— æ³•åœ¨åŒä¸€å°å®¿ä¸»æœºä¸Šå¯åŠ¨ç¬¬äºŒä¸ªå‰¯æœ¬ã€‚</td>
</tr>
</tbody></table>
<p><strong>è¾…åŠ©å‘½ä»¤</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹èµ„æºå¯¹è±¡ç”¨æ³•</span></span><br><span class="line">kubectl explain &lt;èµ„æºå¯¹è±¡&gt; </span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ï¼š</p>
<ol>
<li>åˆ›å»º yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx.yaml</span></span><br><span class="line"><span class="comment"># æ­¤å¤„åªæœ‰å¿…è¦å­—æ®µ</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºpod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æŸ¥çœ‹çŠ¶æ€</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æ˜¯å¦ç”Ÿæˆpod</span></span><br><span class="line">kubectl get pod</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹podè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">kubectl describe pod nginx-pod</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æµ‹è¯•èƒ½å¦è®¿é—®</span></span><br><span class="line">curl 10.244.1.2 # æ­¤å¤„ä¸ºflannelåˆ†é…çš„åœ°å€</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="3-3-å®¹å™¨ç”Ÿå‘½å‘¨æœŸ"><a href="#3-3-å®¹å™¨ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="3.3 å®¹å™¨ç”Ÿå‘½å‘¨æœŸ"></a>3.3 å®¹å™¨ç”Ÿå‘½å‘¨æœŸ</h3><p>æ¯ä¸€ä¸ª Pod è¢«æˆåŠŸåˆ›ç«‹ä¹‹å‰ï¼Œéƒ½ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œä¼šè¿è¡Œé›¶ä¸ªæˆ–è‹¥å¹²ä¸ª init å®¹å™¨ï¼Œinit å®¹å™¨è¿è¡Œå®Œå°±é‡Šæ”¾ï¼Œæ¥ç€æ‰ä¼šè¿è¡Œ main ä¸»å®¹å™¨ï¼Œå½“ç„¶åœ¨ init å®¹å™¨è¿è¡Œä¹‹å‰ä¼šå…ˆè¿è¡Œ pause å®¹å™¨ï¼Œä»¥ä¿è¯å­˜å‚¨å’Œç½‘ç»œçš„å¯ç”¨ã€‚</p>
<p>init å®¹å™¨ä¸æ™®é€šçš„å®¹å™¨éå¸¸ç›¸ä¼¼ï¼Œé™¤äº†ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ul>
<li>init å®¹å™¨æ€»æ˜¯è¿è¡Œåˆ°å®Œæˆã€‚</li>
<li>æ¯ä¸ª init å®¹å™¨éƒ½è¦åœ¨ä¸‹ä¸€ä¸ªå®¹å™¨å¯åŠ¨ä¹‹å‰å®Œæˆã€‚</li>
</ul>
<p>å¦‚æœ Pod çš„ Init å®¹å™¨å¤±è´¥ï¼Œkubelet ä¼šä¸æ–­åœ°é‡å¯è¯¥ Init å®¹å™¨ç›´åˆ°è¯¥å®¹å™¨æˆåŠŸä¸ºæ­¢ã€‚ ç„¶è€Œï¼Œå¦‚æœ Pod å¯¹åº”çš„ <code>restartPolicy</code> å€¼ä¸º â€œNeverâ€ï¼ŒKubernetes ä¸ä¼šé‡æ–°å¯åŠ¨ Podã€‚</p>
<p>å¦‚æœä¸ºä¸€ä¸ª Pod æŒ‡å®šäº†å¤šä¸ª Init å®¹å™¨ï¼Œè¿™äº›å®¹å™¨ä¼šæŒ‰é¡ºåºé€ä¸ªè¿è¡Œã€‚ æ¯ä¸ª Init å®¹å™¨å¿…é¡»è¿è¡ŒæˆåŠŸï¼Œä¸‹ä¸€ä¸ªæ‰èƒ½å¤Ÿè¿è¡Œã€‚å½“æ‰€æœ‰çš„ Init å®¹å™¨è¿è¡Œå®Œæˆæ—¶ï¼Œ Kubernetes æ‰ä¼šä¸º Pod åˆå§‹åŒ–åº”ç”¨å®¹å™¨å¹¶åƒå¹³å¸¸ä¸€æ ·è¿è¡Œã€‚</p>
<p><strong>init å®¹å™¨çš„ä½¿ç”¨</strong></p>
<p>å› ä¸º Init å®¹å™¨å…·æœ‰ä¸åº”ç”¨å®¹å™¨åˆ†ç¦»çš„å•ç‹¬é•œåƒï¼Œå…¶å¯åŠ¨ç›¸å…³ä»£ç å…·æœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p>
<ul>
<li>Init å®¹å™¨å¯ä»¥åŒ…å«ä¸€äº›å®‰è£…è¿‡ç¨‹ä¸­åº”ç”¨å®¹å™¨ä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–ä¸ªæ€§åŒ–ä»£ç ã€‚ ä¾‹å¦‚ï¼Œæ²¡æœ‰å¿…è¦ä»…ä¸ºäº†åœ¨å®‰è£…è¿‡ç¨‹ä¸­ä½¿ç”¨ç±»ä¼¼ <code>sed</code>ã€<code>awk</code>ã€<code>python</code> æˆ– <code>dig</code> è¿™æ ·çš„å·¥å…·è€Œå» <code>FROM</code> ä¸€ä¸ªé•œåƒæ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„é•œåƒã€‚</li>
<li>Init å®¹å™¨å¯ä»¥å®‰å…¨åœ°è¿è¡Œè¿™äº›å·¥å…·ï¼Œé¿å…è¿™äº›å·¥å…·å¯¼è‡´åº”ç”¨é•œåƒçš„å®‰å…¨æ€§é™ä½ã€‚</li>
<li>åº”ç”¨é•œåƒçš„åˆ›å»ºè€…å’Œéƒ¨ç½²è€…å¯ä»¥å„è‡ªç‹¬ç«‹å·¥ä½œï¼Œè€Œæ²¡æœ‰å¿…è¦è”åˆæ„å»ºä¸€ä¸ªå•ç‹¬çš„åº”ç”¨é•œåƒã€‚</li>
<li>Init å®¹å™¨èƒ½ä»¥ä¸åŒäº Pod å†…åº”ç”¨å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾è¿è¡Œã€‚å› æ­¤ï¼ŒInit å®¹å™¨å¯ä»¥è®¿é—®åº”ç”¨å®¹å™¨ä¸èƒ½è®¿é—®çš„ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">Secret</a> çš„æƒé™ã€‚</li>
<li>ç”±äº Init å®¹å™¨å¿…é¡»åœ¨åº”ç”¨å®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œå®Œæˆï¼Œå› æ­¤ Init å®¹å™¨æä¾›äº†ä¸€ç§æœºåˆ¶æ¥é˜»å¡æˆ–å»¶è¿Ÿåº”ç”¨å®¹å™¨çš„å¯åŠ¨ï¼Œç›´åˆ°æ»¡è¶³äº†ä¸€ç»„å…ˆå†³æ¡ä»¶ã€‚ ä¸€æ—¦å‰ç½®æ¡ä»¶æ»¡è¶³ï¼ŒPod å†…çš„æ‰€æœ‰çš„åº”ç”¨å®¹å™¨ä¼šå¹¶è¡Œå¯åŠ¨ã€‚</li>
</ul>
<p><strong>init å®¹å™¨ä½¿ç”¨ä¾‹å­</strong></p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">busybox.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="comment"># å®šä¹‰äº†ä¸€ä¸ª Pod å« busybox-podï¼Œbusybox å°è£…äº† linux çš„å¤§é‡å‘½ä»¤</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line"><span class="comment"># å®šä¹‰è¯¥ Pod ä¸‹çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯å®¹å™¨</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># å®šä¹‰äº†ä¸€ä¸ª busybox å®¹å™¨</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo The busybox app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">  <span class="comment"># å®šä¹‰ init å®¹å™¨ï¼Œinit å®¹å™¨å…¨éƒ¨æ‰§è¡Œå®Œå‰ä¸ä¼šæ‰§è¡Œ busybox å®¹å™¨</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="comment"># ç¬¬ä¸€ä¸ª init å®¹å™¨ï¼Œå¦‚æœæ£€æŸ¥ service ä¸­æ²¡æœ‰æ³¨å†Œ myserviceï¼Œåˆ™ä¼‘çœ 2ç§’ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done&#x27;</span>]</span><br><span class="line">    <span class="comment"># ç¬¬ä¸€ä¸ª init å®¹å™¨è¿è¡Œå®Œå°±è¿è¡Œè¯¥ init å®¹å™¨ï¼Œæ£€æŸ¥ service ä¸­æœ‰æ²¡æœ‰æ³¨å†Œ mydb</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mydb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until nslookup mydb; do echo waiting for mydb; sleep 2; done&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è¿è¡Œ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f busybox.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯ä»¥çœ‹åˆ°ä¸€ç›´å¤„äº <code>Init:0/2</code> çŠ¶æ€ï¼Œå› ä¸ºç¬¬ä¸€ä¸ª init å®¹å™¨ä¸€ç›´æ²¡å®Œæˆ</li>
</ol>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="initå®¹å™¨æµ‹è¯•ä¸€"></p>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="initå®¹å™¨æµ‹è¯•äºŒ"></p>
<ol start="4">
<li>ç¼–å†™ yaml æ–‡ä»¶æ·»åŠ  service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9377</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>è¿è¡Œ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f service.yaml</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ª init å®¹å™¨éƒ½æ‰§è¡Œå®Œï¼Œmain ä¸»å®¹å™¨ä¹Ÿå°±è¿è¡Œäº†</li>
</ol>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="initå®¹å™¨æµ‹è¯•ä¸‰"></p>
<h3 id="3-4-æ¢é’ˆ"><a href="#3-4-æ¢é’ˆ" class="headerlink" title="3.4 æ¢é’ˆ"></a>3.4 æ¢é’ˆ</h3><p>æ¢é’ˆï¼ˆprobeï¼‰æ˜¯ç”± kubelet å¯¹å®¹å™¨æ‰§è¡Œçš„å®šæœŸè¯Šæ–­ã€‚ è¦æ‰§è¡Œè¯Šæ–­ï¼Œkubelet è°ƒç”¨ç”±å®¹å™¨å®ç°çš„ <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#handler-v1-core">Handler</a> ï¼ˆå¤„ç†ç¨‹åºï¼‰ã€‚æœ‰ä¸‰ç§ç±»å‹çš„å¤„ç†ç¨‹åºï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#execaction-v1-core">ExecAction</a>ï¼š åœ¨å®¹å™¨å†…æ‰§è¡ŒæŒ‡å®šå‘½ä»¤ã€‚å¦‚æœå‘½ä»¤é€€å‡ºæ—¶è¿”å›ç ä¸º 0 åˆ™è®¤ä¸ºè¯Šæ–­æˆåŠŸã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#tcpsocketaction-v1-core">TCPSocketAction</a>ï¼š å¯¹å®¹å™¨çš„ IP åœ°å€ä¸Šçš„æŒ‡å®šç«¯å£æ‰§è¡Œ TCP æ£€æŸ¥ã€‚å¦‚æœç«¯å£æ‰“å¼€ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#httpgetaction-v1-core">HTTPGetAction</a>ï¼š å¯¹å®¹å™¨çš„ IP åœ°å€ä¸ŠæŒ‡å®šç«¯å£å’Œè·¯å¾„æ‰§è¡Œ HTTP Get è¯·æ±‚ã€‚å¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº 200 ä¸”å°äº 400ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚</li>
</ul>
<p>æ¯æ¬¡æ¢æµ‹éƒ½å°†è·å¾—ä»¥ä¸‹ä¸‰ç§ç»“æœä¹‹ä¸€ï¼š</p>
<ul>
<li><code>Success</code>ï¼ˆæˆåŠŸï¼‰ï¼šå®¹å™¨é€šè¿‡äº†è¯Šæ–­ã€‚</li>
<li><code>Failure</code>ï¼ˆå¤±è´¥ï¼‰ï¼šå®¹å™¨æœªé€šè¿‡è¯Šæ–­ã€‚</li>
<li><code>Unknown</code>ï¼ˆæœªçŸ¥ï¼‰ï¼šè¯Šæ–­å¤±è´¥ï¼Œå› æ­¤ä¸ä¼šé‡‡å–ä»»ä½•è¡ŒåŠ¨ã€‚</li>
</ul>
<p>æ¢é’ˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p>
<ul>
<li><code>livenessProbe</code>ï¼šæŒ‡ç¤ºå®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚å¦‚æœå­˜æ´»æ€æ¢æµ‹å¤±è´¥ï¼Œåˆ™ kubelet ä¼šæ€æ­»å®¹å™¨ï¼Œ å¹¶ä¸”å®¹å™¨å°†æ ¹æ®å…¶<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">é‡å¯ç­–ç•¥</a>å†³å®šæœªæ¥ã€‚å¦‚æœå®¹å™¨ä¸æä¾›å­˜æ´»æ¢é’ˆï¼Œ åˆ™é»˜è®¤çŠ¶æ€ä¸º <code>Success</code>ã€‚</li>
<li><code>readinessProbe</code>ï¼šæŒ‡ç¤ºå®¹å™¨æ˜¯å¦å‡†å¤‡å¥½ä¸ºè¯·æ±‚æä¾›æœåŠ¡ã€‚å¦‚æœå°±ç»ªæ€æ¢æµ‹å¤±è´¥ï¼Œ ç«¯ç‚¹æ§åˆ¶å™¨å°†ä»ä¸ Pod åŒ¹é…çš„æ‰€æœ‰æœåŠ¡çš„ç«¯ç‚¹åˆ—è¡¨ä¸­åˆ é™¤è¯¥ Pod çš„ IP åœ°å€ã€‚ åˆå§‹å»¶è¿Ÿä¹‹å‰çš„å°±ç»ªæ€çš„çŠ¶æ€å€¼é»˜è®¤ä¸º <code>Failure</code>ã€‚ å¦‚æœå®¹å™¨ä¸æä¾›å°±ç»ªæ€æ¢é’ˆï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º <code>Success</code>ã€‚</li>
<li><code>startupProbe</code>: æŒ‡ç¤ºå®¹å™¨ä¸­çš„åº”ç”¨æ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœæä¾›äº†å¯åŠ¨æ¢é’ˆï¼Œåˆ™æ‰€æœ‰å…¶ä»–æ¢é’ˆéƒ½ä¼šè¢«ç¦ç”¨ï¼Œç›´åˆ°æ­¤æ¢é’ˆæˆåŠŸä¸ºæ­¢ã€‚å¦‚æœå¯åŠ¨æ¢æµ‹å¤±è´¥ï¼Œ<code>kubelet</code> å°†æ€æ­»å®¹å™¨ï¼Œè€Œå®¹å™¨ä¾å…¶<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">é‡å¯ç­–ç•¥</a>è¿›è¡Œé‡å¯ã€‚ å¦‚æœå®¹å™¨æ²¡æœ‰æä¾›å¯åŠ¨æ¢æµ‹ï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º <code>Success</code>ã€‚</li>
</ul>
<h4 id="3-4-1-readinessProbeå°±ç»ªæ£€æµ‹"><a href="#3-4-1-readinessProbeå°±ç»ªæ£€æµ‹" class="headerlink" title="3.4.1 readinessProbeå°±ç»ªæ£€æµ‹"></a>3.4.1 readinessProbeå°±ç»ªæ£€æµ‹</h4><ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">readinessProbe.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readiness-httpget-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="comment"># è°ƒç”¨readinessProbeæ¢é’ˆ</span></span><br><span class="line">      <span class="attr">readinessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="comment"># æ£€æŸ¥80ç«¯å£</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="comment"># æ£€æŸ¥è¯¥ç›®å½•ä¸‹çš„ç½‘é¡µ</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/test.html</span></span><br><span class="line">        <span class="comment"># å®¹å™¨å¯åŠ¨1ç§’åæ‰è¿›è¡Œæ£€æµ‹</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># æ¯3ç§’æ£€æµ‹ä¸€æ¬¡</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f readinessProbe.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯ä»¥çœ‹åˆ°è™½ç„¶ Pod è¿è¡Œäº†ï¼Œä½† ready çŠ¶æ€æ˜¯ä¸å¯¹çš„</li>
</ol>
<p><img src="/2024/02/18/kubernetes/readinessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="readinessProbeæ¢é’ˆæµ‹è¯•ä¸€"></p>
<ol start="4">
<li>è¿›å…¥å®¹å™¨åˆ›å»ºæ–‡ä»¶ï¼Œé—®é¢˜å³å¯è§£å†³</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it readiness-httpget-pod -- /bin/sh</span><br><span class="line">echo &#x27;this is test&#x27; &gt; /usr/share/nginx/html/test.html</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-livenessProbeå­˜æ´»æ£€æµ‹"><a href="#3-4-2-livenessProbeå­˜æ´»æ£€æµ‹" class="headerlink" title="3.4.2 livenessProbeå­˜æ´»æ£€æµ‹"></a>3.4.2 livenessProbeå­˜æ´»æ£€æµ‹</h4><p><strong>livenessProbe-exec</strong></p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_exec.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-exec-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;touch /tmp/test; sleep 60; rm -rf /tmp/test; sleep 3600&#x27;</span>]</span><br><span class="line">    <span class="comment"># æŸ¥çœ‹æœ¬åœ°æ˜¯å¦æœ‰é•œåƒï¼Œæœ‰åˆ™ä½¿ç”¨ï¼Œæ²¡æœ‰åˆ™ä¸‹è½½</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;-e&#x27;</span>,<span class="string">&#x27;/tmp/test&#x27;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯ä»¥çœ‹åˆ°å½“ test æ–‡ä»¶ç»™åˆ é™¤çš„æ—¶å€™ï¼ŒPod å°±ä¼šé‡å¯ï¼Œé‡å¯ååˆä¼šæœ‰ test æ–‡ä»¶ï¼Œä¸€ç›´å¾ªç¯ä¸‹å»</li>
</ol>
<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="livenessProbeæ¢é’ˆæµ‹è¯•ä¸€"></p>
<p><strong>livenessProbe-httpget</strong></p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_httpget.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-httpget-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># Podç”Ÿæˆ1ç§’ä¹‹åä¼šæ¯3ç§’æ£€æµ‹ä¸€æ¬¡æ˜¯å¦å­˜åœ¨index.htmlæ–‡ä»¶ï¼Œå¦‚æœè¶…è¿‡10ç§’æ²¡æœ‰åˆ™é‡å¯Pod</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line">        <span class="comment"># å…è®¸è¶…æ—¶æ—¶é—´</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºå®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯åœ¨æ­£å¸¸è¿è¡Œçš„</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe_httpget.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="livenessProbeæ¢é’ˆæµ‹è¯•ä¸‰"></p>
<ol start="3">
<li>åˆ é™¤ index.html æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä¼šæ‰§è¡Œé‡å¯</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it liveness-httpget-pod -- /bin/sh</span><br><span class="line">rm -rf /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E5%9B%9B.png" alt="livenessProbeæ¢é’ˆæµ‹è¯•å››"></p>
<p><strong>livenessProbe-tcp</strong></p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_tcp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-tcp-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-tcp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ Podï¼Œä¼šå‘ç°ä¸€ç›´å¤„äºé‡å¯çŠ¶æ€</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe_tcp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%BA%94.png" alt="livenessProbeæ¢é’ˆæµ‹è¯•äº”"></p>
<h4 id="3-4-3-Start-å’Œ-Stop"><a href="#3-4-3-Start-å’Œ-Stop" class="headerlink" title="3.4.3 Start å’Œ Stop"></a>3.4.3 Start å’Œ Stop</h4><p>Start å’Œ Stop æ˜¯æŒ‡ Pod åœ¨ç”Ÿæˆåæ‰§è¡Œå’Œç»“æŸå‰æ‰§è¡Œçš„å‘½ä»¤</p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">start_stop.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">start-stop-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start-stop-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo this is postStart test &gt; /usr/share/message&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo this is preStop test &gt; /usr/share/message&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ Podï¼Œè¿›å…¥ Pod å¯ä»¥çœ‹åˆ° Start æ‰§è¡Œçš„å‘½ä»¤ï¼Œç”±äº Pod åœæ­¢åå°±æ²¡æœ‰äº†ï¼Œæ‰€ä»¥çœ‹ä¸åˆ° Stop æ‰§è¡Œçš„å‘½ä»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it start-stop-pod -- /bin/sh</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/start_stop%E6%B5%8B%E8%AF%95.png" alt="start_stopæµ‹è¯•"></p>
<h2 id="å››ã€k8sæ§åˆ¶å™¨"><a href="#å››ã€k8sæ§åˆ¶å™¨" class="headerlink" title="å››ã€k8sæ§åˆ¶å™¨"></a>å››ã€k8sæ§åˆ¶å™¨</h2><h3 id="4-1-ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨"><a href="#4-1-ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨" class="headerlink" title="4.1 ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨"></a>4.1 ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨</h3><p>k8s ä¸­å†…ç½®äº†å¾ˆå¤š controllerï¼Œç”¨æ¥æ§åˆ¶ Pod çš„å…·ä½“çŠ¶æ€å’Œè¡Œä¸ºã€‚</p>
<p>æ§åˆ¶å™¨çš„ç±»å‹æœ‰ï¼š</p>
<ul>
<li>ReplicationControllerï¼ˆå·²å¼ƒç”¨ï¼‰ å’Œ ReplicaSet</li>
<li>Deployment</li>
<li>DaemonSet</li>
<li>StateFulSet</li>
<li>Job å’Œ CronJob</li>
<li>Horizontal Pod Autoscaling</li>
</ul>
<h3 id="4-2-RS-ä¸-Deployment"><a href="#4-2-RS-ä¸-Deployment" class="headerlink" title="4.2 RS ä¸ Deployment"></a>4.2 RS ä¸ Deployment</h3><p>k8s ç®¡ç† Pod ä¸»è¦ç”¨åˆ°ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>Replication Controllerï¼ˆRCï¼‰ï¼šç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œå¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod æ¥ä»£æ›¿ï¼Œå¦‚æœæœ‰å¼‚å¸¸å¤šå‡ºçš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚</li>
<li>ReplicaSetï¼ˆRSï¼‰ï¼šç›¸æ¯” RC å¤šäº†æ”¯æŒ selectorï¼Œæ¨èä½¿ç”¨ RSã€‚</li>
<li>Deploymentï¼šç”¨æ¥ç®¡ç† RSã€‚</li>
</ul>
<p><strong>RS å•ç‹¬ä½¿ç”¨</strong></p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">rs_test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># RSåç§°</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rs-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># è®¾ç½®å‰¯æœ¬æ•°</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># è®¾ç½®æ ‡ç­¾</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">rs-test</span></span><br><span class="line">  <span class="comment"># è®¾ç½®æ¨¡æ¿ï¼Œä¼šæ ¹æ®æ­¤æ¨¡æ¿ç”ŸæˆPod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># ä¸ä¸Šè¾¹RSè®¾ç½®çš„æ ‡ç­¾ç›¸å¯¹åº”ï¼Œè¯´æ˜æ ¹æ®è¯¥æ¨¡æ¿åˆ›å»ºçš„Podéƒ½ç”±æ ‡ç­¾ç›¸å¯¹RSç®¡ç†</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">rs-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rs-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ RSï¼Œå¯ä»¥çœ‹åˆ°ä¼šæ ¹æ® <code>replicas</code>è®¾ç½®çš„æ•°é‡åˆ›å»º Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f rs_test.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RS%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="RSæµ‹è¯•ä¸€"></p>
<ol start="3">
<li>åˆ é™¤è¿™äº› Podï¼ŒRS ä¹Ÿä¼šæŒ‰ç…§å‰¯æœ¬æ•°é‡æ–°å»ºç«‹æ–°çš„ Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod --all</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RS%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="RSæµ‹è¯•äºŒ"></p>
<p><strong>RS ä¸ Deployment</strong></p>
<p><img src="/2024/02/18/kubernetes/Deployment%E5%92%8CRS.png" alt="Deploymentå’ŒRS"></p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="comment"># Deploymentè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># å‰¯æœ¬æ•°</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># é€‰æ‹©æ ‡ç­¾</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># æ ‡ç­¾åŒ¹é…ï¼Œä¸Deploymentå¯¹åº”</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="comment"># Podæ¨¡æ¿</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># å®šä¹‰æ ‡ç­¾</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-deployment-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment.yaml --record</span><br><span class="line">record:è®°å½•å‘½ä»¤ï¼Œæ–¹ä¾¿æ¯æ¬¡ reversion çš„å˜åŒ–</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯ä»¥çœ‹åˆ°ä¼šç”Ÿæˆå¯¹åº”çš„ RS å’Œ Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/deployment%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="deploymentæµ‹è¯•ä¸€"></p>
<ol start="4">
<li>æ‰©å®¹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas 5</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>æ›´æ–°é•œåƒ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment/nginx-deployment nginx-deployment-container=daocloud.io/library/nginx:1.19.1</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ RSï¼Œä»¥å®ç°ç°åº¦æ›´æ–°</p>
<p><img src="/2024/02/18/kubernetes/deployment%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="deploymentæµ‹è¯•äºŒ"></p>
<ol start="6">
<li>å›æ»š</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>æŸ¥çœ‹å›æ»šçŠ¶æ€</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>æŸ¥çœ‹å†å²ç‰ˆæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout history deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>å›åˆ°å†å²æŒ‡å®šç‰ˆæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=1</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>æš‚åœæ›´æ–°</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout pause deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<h3 id="4-3-DaemonSet"><a href="#4-3-DaemonSet" class="headerlink" title="4.3 DaemonSet"></a>4.3 DaemonSet</h3><p>DaemonSet ç¡®ä¿å…¨éƒ¨æˆ–è€…ä¸€éƒ¨åˆ† Node ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ï¼Œå½“æœ‰ Node åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Podï¼Œå½“è¿™äº› Node é€€å‡ºé›†ç¾¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚</p>
<p>DaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š</p>
<ul>
<li>è¿è¡Œé›†ç¾¤å­˜å‚¨ daemonï¼Œä¾‹å¦‚åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œ glusterdã€cephç­‰ã€‚</li>
<li>è¿è¡Œæ—¥å¿—æ”¶é›†daemonï¼Œä¾‹å¦‚fluentdã€logstashç­‰ã€‚</li>
<li>è¿è¡Œç›‘æ§daemonï¼Œä¾‹å¦‚ Prometheus çš„ Node exporterã€zabbixç­‰ã€‚</li>
</ul>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">daemonset_test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># DaemonSetåç§°</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">daemonset-test</span></span><br><span class="line">  <span class="comment"># è®¾ç½®æ ‡ç­¾</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">daemonset-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># è¯¥æ ‡ç­¾è¦ä¸ä¸Šè¾¹æ ‡ç­¾ä¸€è‡´</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">daemonset-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">daemonset-nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">daemonset-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ DaemonSet</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f daemonset_test.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/daemonset%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="daemonsetæµ‹è¯•ä¸€"></p>
<ol start="3">
<li>åˆ é™¤ä¸€ä¸ª Pod ä¹‹å DaemonSet ä¸ºä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½è‡³å°‘æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œå°±ä¼šé‡æ–°åˆ›å»ºæ–°çš„ Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/daemonset%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="daemonsetæµ‹è¯•äºŒ"></p>
<h3 id="4-4-Job-å’Œ-CronJob"><a href="#4-4-Job-å’Œ-CronJob" class="headerlink" title="4.4 Job å’Œ CronJob"></a>4.4 Job å’Œ CronJob</h3><h4 id="4-4-1-Job"><a href="#4-4-1-Job" class="headerlink" title="4.4.1 Job"></a>4.4.1 Job</h4><p>Job è´Ÿè´£æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå³ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª Pod æˆåŠŸç»“æŸã€‚</p>
<p><strong>Job spec</strong></p>
<ul>
<li><p><code>spec.template</code>æ ¼å¼åŒ Pod ç›¸åŒ</p>
</li>
<li><p><code>RestartPolicy</code>ä»…æ”¯æŒ<code>Never</code>å’Œ<code>OnFailure</code></p>
</li>
<li><p>å•ä¸ª Pod æ—¶ï¼Œé»˜è®¤ Pod æˆåŠŸè¿è¡Œå Job å³ç»“æŸ</p>
</li>
<li><p><code>spec.completions</code>æ ‡å¿— Job ç»“æŸæ—¶éœ€è¦æˆåŠŸè¿è¡Œçš„ Pod ä¸ªæ•°ï¼Œé»˜è®¤ä¸º1</p>
</li>
<li><p><code>spec.parallelism</code>æ ‡å¿—å¹¶è¡Œè¿è¡Œçš„ Pod ä¸ªæ•°ï¼Œé»˜è®¤ä¸º1</p>
</li>
<li><p><code>spec.activeDeadlineSeconds</code>æ ‡å¿—å¤±è´¥ Pod çš„é‡è¯•æœ€å¤§æ—¶é—´ï¼Œè¶…è¿‡è¯¥æ—¶é—´å°±ä¸ä¼šå†é‡è¯•</p>
</li>
</ul>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">job.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">job-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="comment"># é€šè¿‡perlè¯­è¨€è¿›è¡Œåœ†å‘¨ç‡è®¡ç®—ï¼Œè®¡ç®—å°æ•°ç‚¹å2000ä½</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;perl&#x27;</span>,<span class="string">&#x27;-Mbignum=bpi&#x27;</span>,<span class="string">&#x27;-wle&#x27;</span>,<span class="string">&#x27;print bpi(2000)&#x27;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ Jobï¼Œå¯ä»¥çœ‹åˆ°å¼€å§‹æ˜¯ Runningï¼Œæ¥ç€å°±æ˜¯ Completedï¼Œä»£è¡¨ Job å·²ç»å®Œæˆ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f job.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/job%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="jobæµ‹è¯•ä¸€"></p>
<ol start="3">
<li>æŸ¥çœ‹æ—¥å¿—å¯ä»¥çœ‹åˆ°è®¡ç®—å¥½çš„åœ†å‘¨ç‡</li>
</ol>
<p><img src="/2024/02/18/kubernetes/job%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="jobæµ‹è¯•äºŒ"></p>
<h4 id="4-4-2-CronJob"><a href="#4-4-2-CronJob" class="headerlink" title="4.4.2 CronJob"></a>4.4.2 CronJob</h4><p>Cron Job æ˜¯åŸºäºæ—¶é—´ç®¡ç†æ§åˆ¶ Jobï¼Œå³åœ¨ç»™å®šçš„æ—¶é—´åªè¿è¡Œä¸€æ¬¡ã€å‘¨æœŸæ€§çš„åœ¨æŒ‡å®šæ—¶é—´è¿è¡Œã€‚</p>
<p><strong>CronJob spec</strong></p>
<ul>
<li>æ‰€æœ‰ CronJob çš„ <code>schedule:</code> æ—¶é—´éƒ½æ˜¯åŸºäº kube-controller-manager çš„æ—¶åŒºã€‚</li>
<li><code>.spec.schedule</code> æ˜¯ <code>.spec</code> éœ€è¦çš„åŸŸã€‚å®ƒä½¿ç”¨äº† Cron æ ¼å¼ä¸²ï¼Œä¾‹å¦‚ <code>0 * * * *</code> or <code>@hourly</code> ï¼Œåšä¸ºå®ƒçš„ä»»åŠ¡è¢«åˆ›å»ºå’Œæ‰§è¡Œçš„è°ƒåº¦æ—¶é—´ã€‚</li>
<li><code>.spec.jobTemplate</code>æ˜¯ä»»åŠ¡çš„æ¨¡ç‰ˆï¼Œæ˜¯å¿…é¡»é¡¹ã€‚</li>
<li><code>.spec.startingDeadlineSeconds</code> åŸŸæ˜¯å¯é€‰é¡¹ã€‚å®ƒè¡¨ç¤ºä»»åŠ¡å¦‚æœç”±äºæŸç§åŸå› é”™è¿‡äº†è°ƒåº¦æ—¶é—´ï¼Œå¼€å§‹è¯¥ä»»åŠ¡çš„æˆªæ­¢æ—¶é—´çš„ç§’æ•°ã€‚è¿‡äº†æˆªæ­¢æ—¶é—´ï¼ŒCronJob å°±ä¸ä¼šå¼€å§‹ä»»åŠ¡ã€‚ ä¸æ»¡è¶³è¿™ç§æœ€åæœŸé™çš„ä»»åŠ¡ä¼šè¢«ç»Ÿè®¡ä¸ºå¤±è´¥ä»»åŠ¡ã€‚å¦‚æœè¯¥åŸŸæ²¡æœ‰å£°æ˜ï¼Œé‚£ä»»åŠ¡å°±æ²¡æœ‰æœ€åæœŸé™ã€‚</li>
<li><code>.spec.suspend</code>åŸŸä¹Ÿæ˜¯å¯é€‰çš„ã€‚å¦‚æœè®¾ç½®ä¸º <code>true</code> ï¼Œåç»­å‘ç”Ÿçš„æ‰§è¡Œéƒ½ä¼šæŒ‚èµ·ã€‚ è¿™ä¸ªè®¾ç½®å¯¹å·²ç»å¼€å§‹çš„æ‰§è¡Œä¸èµ·ä½œç”¨ã€‚é»˜è®¤æ˜¯å…³é—­çš„ã€‚</li>
<li><code>.spec.successfulJobsHistoryLimit</code> å’Œ <code>.spec.failedJobsHistoryLimit</code>æ˜¯å¯é€‰çš„ã€‚ è¿™ä¸¤ä¸ªå­—æ®µæŒ‡å®šåº”ä¿ç•™å¤šå°‘å·²å®Œæˆå’Œå¤±è´¥çš„ä»»åŠ¡ã€‚ é»˜è®¤è®¾ç½®ä¸º3å’Œ1ã€‚é™åˆ¶è®¾ç½®ä¸º0ä»£è¡¨ç›¸åº”ç±»å‹çš„ä»»åŠ¡å®Œæˆåä¸ä¼šä¿ç•™ã€‚</li>
</ul>
<p><strong>å¹¶å‘æ€§è§„åˆ™</strong></p>
<p><code>.spec.concurrencyPolicy</code>å£°æ˜äº† CronJob åˆ›å»ºçš„ä»»åŠ¡æ‰§è¡Œæ—¶å‘ç”Ÿé‡å å¦‚ä½•å¤„ç†ã€‚ spec ä»…èƒ½å£°æ˜ä¸‹åˆ—è§„åˆ™ä¸­çš„ä¸€ç§ï¼š</p>
<ul>
<li><code>Allow</code> (é»˜è®¤)ï¼šCronJob å…è®¸å¹¶å‘ä»»åŠ¡æ‰§è¡Œã€‚</li>
<li><code>Forbid</code>ï¼š CronJob ä¸å…è®¸å¹¶å‘ä»»åŠ¡æ‰§è¡Œï¼›å¦‚æœæ–°ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´åˆ°äº†è€Œè€ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œï¼ŒCronJob ä¼šå¿½ç•¥æ–°ä»»åŠ¡çš„æ‰§è¡Œã€‚</li>
<li><code>Replace</code>ï¼šå¦‚æœæ–°ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´åˆ°äº†è€Œè€ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œï¼ŒCronJob ä¼šç”¨æ–°ä»»åŠ¡æ›¿æ¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚</li>
</ul>
<p>å¹¶å‘æ€§è§„åˆ™ä»…é€‚ç”¨äºç›¸åŒ CronJob åˆ›å»ºçš„ä»»åŠ¡ã€‚å¦‚æœæœ‰å¤šä¸ª CronJobï¼Œå®ƒä»¬ç›¸åº”çš„ä»»åŠ¡æ€»æ˜¯å…è®¸å¹¶å‘æ‰§è¡Œçš„ã€‚</p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">crontjob.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cronjob</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># CronJobå¿…è¦å­—æ®µï¼Œæ ¼å¼ä¸ºåˆ†æ—¶æ—¥æœˆå‘¨</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="comment"># jobæ¨¡æ¿</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">crontab-pod</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">&#x27;Welcome My K8s&#x27;</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆ CronJobï¼Œå¯ä»¥çœ‹åˆ°æ¯åˆ†é’Ÿéƒ½ä¼šåˆ›å»ºä¸€ä¸ª Job å’Œ Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cronjob.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/cronjob%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="cronjobæµ‹è¯•ä¸€"></p>
<p><img src="/2024/02/18/kubernetes/cronjob%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="cronjobæµ‹è¯•äºŒ"></p>
<h2 id="äº”ã€Service"><a href="#äº”ã€Service" class="headerlink" title="äº”ã€Service"></a>äº”ã€Service</h2><h3 id="5-1-ä»€ä¹ˆæ˜¯Service"><a href="#5-1-ä»€ä¹ˆæ˜¯Service" class="headerlink" title="5.1 ä»€ä¹ˆæ˜¯Service"></a>5.1 ä»€ä¹ˆæ˜¯Service</h3><p><img src="/2024/02/18/kubernetes/Service%E4%B8%80.png" alt="Serviceä¸€"></p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒDeployment ä¼šæ ¹æ® <code>replicas</code>ä¿è¯ Pod çš„æ•°é‡ï¼Œå½“ä¸Šå›¾çš„å…¶ä¸­ä¸€ä¸ª php-fpm Pod å‡ºç°é—®é¢˜æ—¶ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ªæ¥ä»£æ›¿ã€‚ä½†è¿™æ—¶å€™ä¼šä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œæ–°çš„ Pod çš„åœ°å€ä¸æ—§çš„å¾ˆå¯èƒ½ä¸ä¸€æ ·ï¼Œé‚£ nginx ä¹Ÿæ— æ³•è¿æ¥åˆ°æ–°çš„ Podï¼Œé™¤éä¿®æ”¹ nginx çš„é…ç½®ï¼Œè¿™æ ·çš„ k8s é›†ç¾¤æ•ˆç‡æ˜¯éå¸¸ä½çš„ã€‚</p>
<p>Service å°±èƒ½è§£å†³è¯¥é—®é¢˜ï¼Œåœ¨ nginx å’Œ php-fpm ä¸­é—´æ·»åŠ ä¸€ä¸ª Serviceï¼Œç”±è¯¥ Service æ¥ç®¡ç†å„ php-fpm Pod çš„ä¿¡æ¯ï¼Œæ¯ä¸ª Pod ä¼šè®¾ç½®ä¸€ä¸ªæ ‡ç­¾ï¼Œåªè¦ä¸ SVC ä¸­è®¾ç½®çš„æ ‡ç­¾ç›¸åŒ¹é…ï¼Œå°±å¯ä»¥è¿›è¡Œç®¡ç†ï¼Œå…¶å®ƒ Podï¼ˆä¾‹å¦‚ä¸‹å›¾çš„ nginxï¼‰æƒ³è¦è®¿é—®è¯¥ SVC ç®¡ç†çš„ Podï¼Œåªè¦é€šè¿‡ SVC çš„åœ°å€å°±å¯ä»¥è®¿é—®åˆ°ã€‚</p>
<p>Service å®šä¹‰äº†è¿™æ ·ä¸€ç§æŠ½è±¡ï¼šé€»è¾‘ä¸Šçš„ä¸€ç»„ Podï¼Œä¸€ç§å¯ä»¥è®¿é—®å®ƒä»¬çš„ç­–ç•¥ â€”â€” é€šå¸¸ç§°ä¸ºå¾®æœåŠ¡ã€‚</p>
<p><img src="/2024/02/18/kubernetes/Service%E4%BA%8C.png" alt="ServiceäºŒ"></p>
<h3 id="5-2-Serviceå‘å¸ƒæœåŠ¡ï¼ˆæœåŠ¡ç±»å‹"><a href="#5-2-Serviceå‘å¸ƒæœåŠ¡ï¼ˆæœåŠ¡ç±»å‹" class="headerlink" title="5.2 Serviceå‘å¸ƒæœåŠ¡ï¼ˆæœåŠ¡ç±»å‹)"></a>5.2 Serviceå‘å¸ƒæœåŠ¡ï¼ˆæœåŠ¡ç±»å‹)</h3><p>å¯¹ä¸€äº›åº”ç”¨çš„æŸäº›éƒ¨åˆ†ï¼ˆå¦‚å‰ç«¯ï¼‰ï¼Œå¯èƒ½å¸Œæœ›å°†å…¶æš´éœ²ç»™ Kubernetes é›†ç¾¤å¤–éƒ¨ çš„ IP åœ°å€ã€‚</p>
<p>Kubernetes <code>ServiceTypes</code> å…è®¸æŒ‡å®šä½ æ‰€éœ€è¦çš„ Service ç±»å‹ï¼Œé»˜è®¤æ˜¯ <code>ClusterIP</code>ã€‚</p>
<p><code>Type</code> çš„å–å€¼ä»¥åŠè¡Œä¸ºå¦‚ä¸‹ï¼š</p>
<ul>
<li><code>ClusterIP</code>ï¼šé€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼Œé€‰æ‹©è¯¥å€¼æ—¶æœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚ è¿™ä¹Ÿæ˜¯é»˜è®¤çš„ <code>ServiceType</code>ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#nodeport"><code>NodePort</code></a>ï¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ IP å’Œé™æ€ç«¯å£ï¼ˆ<code>NodePort</code>ï¼‰æš´éœ²æœåŠ¡ã€‚ <code>NodePort</code> æœåŠ¡ä¼šè·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ <code>ClusterIP</code> æœåŠ¡ã€‚ é€šè¿‡è¯·æ±‚ <code>&lt;èŠ‚ç‚¹ IP&gt;:&lt;èŠ‚ç‚¹ç«¯å£&gt;</code>ï¼Œä½ å¯ä»¥ä»é›†ç¾¤çš„å¤–éƒ¨è®¿é—®ä¸€ä¸ª <code>NodePort</code> æœåŠ¡ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer"><code>LoadBalancer</code></a>ï¼šä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ <code>NodePort</code> æœåŠ¡å’Œ <code>ClusterIP</code> æœåŠ¡ä¸Šã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#externalname"><code>ExternalName</code></a>ï¼šé€šè¿‡è¿”å› <code>CNAME</code> å’Œå¯¹åº”å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ° <code>externalName</code> å­—æ®µçš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œ<code>foo.bar.example.com</code>ï¼‰ã€‚ æ— éœ€åˆ›å»ºä»»ä½•ç±»å‹ä»£ç†ã€‚</li>
</ul>
<p><strong>ClusterIP</strong></p>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E7%B1%BB%E5%9E%8B.png" alt="ClusterIPç±»å‹"></p>
<p><strong>NodePort</strong></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E7%B1%BB%E5%9E%8B.png" alt="NodePortç±»å‹"></p>
<p><strong>LoadBalancer</strong></p>
<p><img src="/2024/02/18/kubernetes/LoadBalancer%E7%B1%BB%E5%9E%8B.png" alt="LoadBalancerç±»å‹"></p>
<p><strong>ExternalName</strong></p>
<p><img src="/2024/02/18/kubernetes/ExternalName%E7%B1%BB%E5%9E%8B.png" alt="ExternalNameç±»å‹"></p>
<h3 id="5-3-è™šæ‹Ÿ-IP-å’Œ-Service-ä»£ç†"><a href="#5-3-è™šæ‹Ÿ-IP-å’Œ-Service-ä»£ç†" class="headerlink" title="5.3 è™šæ‹Ÿ IP å’Œ Service ä»£ç†"></a>5.3 è™šæ‹Ÿ IP å’Œ Service ä»£ç†</h3><p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œæ¯ä¸ª Node è¿è¡Œä¸€ä¸ª <code>kube-proxy</code> è¿›ç¨‹ã€‚ <code>kube-proxy</code> è´Ÿè´£ä¸º Service å®ç°äº†ä¸€ç§ VIPï¼ˆè™šæ‹Ÿ IPï¼‰çš„å½¢å¼ï¼Œè€Œä¸æ˜¯ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#externalname"><code>ExternalName</code></a> çš„å½¢å¼ã€‚</p>
<p><strong>ä»£ç†æ¨¡å¼åˆ†ç±»ï¼š</strong></p>
<p><strong>userspace ä»£ç†æ¨¡å¼</strong></p>
<p>åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½è¦é€šè¿‡ kube-proxy è¿›è¡Œä¸€ä¸ªä»£ç†çš„æ“ä½œï¼Œkube-proxy çš„å‹åŠ›ç›¸å¯¹ä¼šè¾ƒå¤§ã€‚</p>
<p><img src="/2024/02/18/kubernetes/userspace%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="userspaceä»£ç†æ¨¡å¼"></p>
<p><strong>iptables ä»£ç†æ¨¡å¼</strong></p>
<p>åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„è®¿é—®éƒ½é€šè¿‡ iptables æ¥å¤„ç†ï¼Œkube-proxy çš„å‹åŠ›å°±ä¼šå‡å°å¾ˆå¤šã€‚</p>
<p><img src="/2024/02/18/kubernetes/iptables%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="iptablesä»£ç†æ¨¡å¼"></p>
<p><strong>IPVS ä»£ç†æ¨¡å¼</strong></p>
<p>åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œiptables æ¢æˆäº† IPVSï¼Œé€šè¿‡å†…æ ¸æ¨¡å—æ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚</p>
<p>åœ¨ <code>ipvs</code> æ¨¡å¼ä¸‹ï¼Œkube-proxy ç›‘è§† Kubernetes æœåŠ¡å’Œç«¯ç‚¹ï¼Œè°ƒç”¨ <code>netlink</code> æ¥å£ç›¸åº”åœ°åˆ›å»º IPVS è§„åˆ™ï¼Œ å¹¶å®šæœŸå°† IPVS è§„åˆ™ä¸ Kubernetes æœåŠ¡å’Œç«¯ç‚¹åŒæ­¥ã€‚ è¯¥æ§åˆ¶å¾ªç¯å¯ç¡®ä¿ IPVS çŠ¶æ€ä¸æ‰€éœ€çŠ¶æ€åŒ¹é…ã€‚è®¿é—®æœåŠ¡æ—¶ï¼ŒIPVS å°†æµé‡å®šå‘åˆ°åç«¯Podä¹‹ä¸€ã€‚</p>
<p>IPVSä»£ç†æ¨¡å¼åŸºäºç±»ä¼¼äº iptables æ¨¡å¼çš„ netfilter æŒ‚é’©å‡½æ•°ï¼Œ ä½†æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåŸºç¡€æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”åœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œã€‚ è¿™æ„å‘³ç€ï¼Œä¸ iptables æ¨¡å¼ä¸‹çš„ kube-proxy ç›¸æ¯”ï¼ŒIPVS æ¨¡å¼ä¸‹çš„ kube-proxy é‡å®šå‘é€šä¿¡çš„å»¶è¿Ÿè¦çŸ­ï¼Œå¹¶ä¸”åœ¨åŒæ­¥ä»£ç†è§„åˆ™æ—¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚ ä¸å…¶ä»–ä»£ç†æ¨¡å¼ç›¸æ¯”ï¼ŒIPVS æ¨¡å¼è¿˜æ”¯æŒæ›´é«˜çš„ç½‘ç»œæµé‡ååé‡ã€‚</p>
<p>IPVS æä¾›äº†æ›´å¤šé€‰é¡¹æ¥å¹³è¡¡åç«¯ Pod çš„æµé‡ã€‚ è¿™äº›æ˜¯ï¼š</p>
<ul>
<li><code>rr</code>ï¼šè½®æ›¿ï¼ˆRound-Robinï¼‰</li>
<li><code>lc</code>ï¼šæœ€å°‘é“¾æ¥ï¼ˆLeast Connectionï¼‰ï¼Œå³æ‰“å¼€é“¾æ¥æ•°é‡æœ€å°‘è€…ä¼˜å…ˆ</li>
<li><code>dh</code>ï¼šç›®æ ‡åœ°å€å“ˆå¸Œï¼ˆDestination Hashingï¼‰</li>
<li><code>sh</code>ï¼šæºåœ°å€å“ˆå¸Œï¼ˆSource Hashingï¼‰</li>
<li><code>sed</code>ï¼šæœ€çŸ­é¢„æœŸå»¶è¿Ÿï¼ˆShortest Expected Delayï¼‰</li>
<li><code>nq</code>ï¼šä»ä¸æ’é˜Ÿï¼ˆNever Queueï¼‰</li>
</ul>
<p>æ³¨æ„ï¼šå½“ kube-proxy ä»¥ IPVS ä»£ç†æ¨¡å¼å¯åŠ¨æ—¶ï¼Œå®ƒå°†éªŒè¯ IPVS å†…æ ¸æ¨¡å—æ˜¯å¦å¯ç”¨ã€‚ å¦‚æœæœªæ£€æµ‹åˆ° IPVS å†…æ ¸æ¨¡å—ï¼Œåˆ™ kube-proxy å°†é€€å›åˆ°ä»¥ iptables ä»£ç†æ¨¡å¼è¿è¡Œã€‚</p>
<p><img src="/2024/02/18/kubernetes/IPVS%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="IPVSä»£ç†æ¨¡å¼"></p>
<h3 id="5-4-ClusterIP"><a href="#5-4-ClusterIP" class="headerlink" title="5.4 ClusterIP"></a>5.4 ClusterIP</h3><p>ClusterIP ä¸»è¦åœ¨æ¯ä¸ª Node èŠ‚ç‚¹ä½¿ç”¨ iptables &#x2F; IPVSï¼Œå°†å‘å‘ ClusterIP å¯¹åº”ç«¯å£çš„æ•°æ®ï¼Œè½¬å‘åˆ° kube-proxy ä¸­ï¼Œkube-proxy å†…éƒ¨å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¹¶å¯ä»¥æŸ¥è¯¢åˆ°è¯¥ Service ä¸‹å¯¹åº” Pod çš„åœ°å€å’Œç«¯å£ï¼Œè¿›è€ŒæŠŠæ•°æ®è½¬å‘ç»™å¯¹åº”çš„ Pod çš„åœ°å€å’Œç«¯å£ã€‚</p>
<p><strong>ç¤ºä¾‹</strong></p>
<ol>
<li>åˆ›å»º Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_svc_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸¤ä¸ªæ ‡ç­¾</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="comment"># é‡Šæ”¾çš„ç«¯å£</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º Service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">clusterip_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-clusterip-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># ç”¨æ¥åŒ¹é…Podä¸­çš„æ ‡ç­¾ï¼Œå…¨éƒ¨åŒ¹é…æ‰ä¼šç®¡ç†è¯¥Pod</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯ä»¥çœ‹åˆ° Deployment å’Œ SVC éƒ½å·²ç»åˆ›å»ºæˆåŠŸï¼Œä¸”ç›´æ¥è®¿é—® SVC çš„ ClusterIP åœ°å€å°±å¯ä»¥è®¿é—®åˆ° Pod äº†</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="ClusterIPæµ‹è¯•ä¸€"></p>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="ClusterIPæµ‹è¯•äºŒ"></p>
<ol start="4">
<li>æµ‹è¯•è´Ÿè½½å‡è¡¡ï¼Œåœ¨å„å®¹å™¨å†…éƒ¨åˆ›å»ºä¸€ä¸ª html é¡µé¢</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-deployment-*** -- /bin/bash</span><br><span class="line">echo &#x27;this is node01-pod01&#x27; &gt; /usr/share/nginx/html/pod.html</span><br><span class="line">echo &#x27;this is node02-pod01&#x27; &gt; /usr/share/nginx/html/pod.html</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>å¯ä»¥çœ‹åˆ°æ˜¯å®ç°äº†è´Ÿè½½å‡è¡¡çš„</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="ClusterIPæµ‹è¯•ä¸‰"></p>
<h3 id="5-5-æ— å¤´æœåŠ¡ï¼ˆHeadless-Servicesï¼‰"><a href="#5-5-æ— å¤´æœåŠ¡ï¼ˆHeadless-Servicesï¼‰" class="headerlink" title="5.5 æ— å¤´æœåŠ¡ï¼ˆHeadless Servicesï¼‰"></a>5.5 æ— å¤´æœåŠ¡ï¼ˆHeadless Servicesï¼‰</h3><p>æœ‰æ—¶ä¸éœ€è¦æˆ–ä¸æƒ³è¦è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠå•ç‹¬çš„ Service IPã€‚ é‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š Cluster IPï¼ˆ<code>spec.clusterIP</code>ï¼‰çš„å€¼ä¸º <code>&quot;None&quot;</code> æ¥åˆ›å»º <code>Headless</code> Serviceã€‚</p>
<p>å¯ä»¥ä½¿ç”¨æ— å¤´ Service ä¸å…¶ä»–æœåŠ¡å‘ç°æœºåˆ¶è¿›è¡Œæ¥å£ï¼Œè€Œä¸å¿…ä¸ Kubernetes çš„å®ç°æ†ç»‘åœ¨ä¸€èµ·ã€‚</p>
<p>å¯¹è¿™æ— å¤´ Service å¹¶ä¸ä¼šåˆ†é… Cluster IPï¼Œkube-proxy ä¸ä¼šå¤„ç†å®ƒä»¬ï¼Œ è€Œä¸”å¹³å°ä¹Ÿä¸ä¼šä¸ºå®ƒä»¬è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œè·¯ç”±ã€‚ DNS å¦‚ä½•å®ç°è‡ªåŠ¨é…ç½®ï¼Œä¾èµ–äº Service æ˜¯å¦å®šä¹‰äº†é€‰æ‹©ç®—ç¬¦ã€‚</p>
<p><strong>ç¤ºä¾‹</strong></p>
<ol>
<li>åˆ›å»º Headless Service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">headless_service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">headless-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¯ä»¥çœ‹åˆ°æ˜¯æ²¡æœ‰åˆ†é… VIP çš„</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="æ— å¤´æœåŠ¡æµ‹è¯•ä¸€"></p>
<ol start="3">
<li>å®‰è£… bind-utils å·¥å…·æ¥æµ‹è¯•æ— å¤´æœåŠ¡çš„ä½œç”¨ï¼Œå¯ä»¥çœ‹åˆ°å³ä½¿æ²¡æœ‰äº† VIPï¼Œä½†ä¾æ—§å¯ä»¥é€šè¿‡åŸŸåæ¥è®¿é—®åˆ°ä¸åŒçš„ Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">k8så†…éƒ¨ä½¿ç”¨dnsè®¿é—®æ ¼å¼ï¼šSVCåç§°.å‘½åç©ºé—´.svc.é›†ç¾¤åŸŸ(é»˜è®¤é›†ç¾¤åŸŸä¸ºcluster.local)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">digå‘½ä»¤å¯ä»¥ç”¨æ¥è·å–åŸŸåçš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.244.0.37æ˜¯å…¶ä¸­ä¸€ä¸ªcorednsçš„åœ°å€</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-t A:æ˜¾ç¤ºAè®°å½•ï¼ŒAè®°å½•æ˜¯å°†åŸŸåæŒ‡å‘ä¸€ä¸ªIPv4åœ°å€ï¼Œå³ä¸€ä¸ªåŸŸåè§£æåˆ°ä¸€ä¸ªIPåœ°å€</span></span><br><span class="line">dig -t A headless-service.default.svc.cluster.local @10.244.0.37</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="æ— å¤´æœåŠ¡æµ‹è¯•äºŒ"></p>
<h3 id="5-6-NodePort"><a href="#5-6-NodePort" class="headerlink" title="5.6 NodePort"></a>5.6 NodePort</h3><p>NodePort çš„åŸç†åœ¨äºåœ¨ Node ä¸Šå¼€æ”¾äº†ä¸€ä¸ªç«¯å£ï¼Œå°†è¯¥ç«¯å£çš„æµé‡å¯¼å…¥åˆ° kube-proxy ä¸­ï¼Œç„¶åå†ç”± kube-proxy ä¼ é€ç»™ä¸åŒçš„ Podã€‚</p>
<p><strong>ç¤ºä¾‹</strong></p>
<ol>
<li>åˆ›å»º Serviceï¼Œè¿™é‡Œçš„æ ‡ç­¾ä»ä¸ä¸Šé¢ ClusterIP ä¸­çš„ Deployment åˆ›å»ºçš„ Pod ç›¸åŒ¹é…</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nodeport_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-nodeport-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¯ä»¥çœ‹åˆ°ä¼šæš´éœ²ä¸€ä¸ªç«¯å£ï¼Œå¤–éƒ¨é€šè¿‡è¿™ä¸ªç«¯å£å°±å¯ä»¥è®¿é—®åˆ°å†…éƒ¨çš„ Podï¼Œä¸”æ˜¯æ¯ä¸€ä¸ª Node éƒ½å¼€å¯äº†è¿™ä¸ªç«¯å£ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å®ç°è´Ÿè½½å‡è¡¡</li>
</ol>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="NodePortæµ‹è¯•ä¸€"></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="NodePortæµ‹è¯•ä¸€"></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="NodePortæµ‹è¯•ä¸‰"></p>
<ol start="3">
<li>åœ¨ iptables &#x2F; IPVS è§„åˆ™ä¸­å¯ä»¥çœ‹åˆ°å¼€å¯è¯¥ç«¯å£çš„è§„åˆ™</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -nvl | grep 31419</span><br><span class="line">ipvsadm -Ln | grep 31419</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E5%9B%9B.png" alt="NodePortæµ‹è¯•å››"></p>
<h3 id="5-7-LoadBalancer"><a href="#5-7-LoadBalancer" class="headerlink" title="5.7 LoadBalancer"></a>5.7 LoadBalancer</h3><p>LoadBalancer å°±æ˜¯åœ¨ NodePort çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ LAAS æ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œç”¨æˆ·æŒ‡è¦è®¿é—® LAASå³å¯ï¼ŒLAAS ä¼šå°†è¯·æ±‚é€šè¿‡è°ƒåº¦è½¬å‘ç»™ä¸åŒçš„ Nodeã€‚</p>
<h3 id="5-8-ExternalName"><a href="#5-8-ExternalName" class="headerlink" title="5.8 ExternalName"></a>5.8 ExternalName</h3><p>ExternalName é€šè¿‡è¿”å› CNAME å’Œå®ƒçš„å€¼ï¼Œå°†æœåŠ¡æ˜ å°„åˆ° ExternalName å­—æ®µçš„å†…å®¹ï¼ŒExternalName æ²¡æœ‰ selectorï¼Œä¹Ÿæ²¡æœ‰ç«¯å£çš„è®¾ç½®ï¼Œå¯¹äºè¿è¡Œåœ¨é›†ç¾¤ä¹‹å¤–çš„æœåŠ¡ï¼ŒExternalName æ˜¯é€šè¿‡è¯¥å¤–éƒ¨æœåŠ¡çš„åˆ«åæ¥æä¾›æœåŠ¡çš„ã€‚</p>
<p>å½“è¿™ä¸ª Service åˆ›å»ºæˆåŠŸæ—¶ï¼Œå°±ä¼šæœ‰ <code>externalname-service.default.svc.cluster.local</code> çš„ fqdn è¢«åˆ›å»ºï¼Œå¦‚æœæœ‰ç”¨æˆ·è®¿é—®åˆ°è¿™ä¸ª fqdnï¼Œå°±ä¼šè¢«æ”¹å†™æˆ <code>my.database.example.com</code>ï¼Œè¿™å°±æ˜¯ DNS å†…éƒ¨çš„ä¸€ä¸ª CNAME è®°å½•ï¼Œä¹Ÿå°±æ˜¯åˆ«åè®°å½•ã€‚</p>
<p><strong>ç¤ºä¾‹</strong></p>
<ol>
<li>åˆ›å»ºæµ‹è¯•ç”¨çš„ Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">curl-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">curl-pod-container</span></span><br><span class="line">    <span class="comment"># curlé•œåƒåŒ…å«æµ‹è¯•ç½‘ç»œå’ŒDNSçš„å·¥å…·</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/appropriate/curl</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;curl test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º ExternalName</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">externalname-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">externalname</span></span><br><span class="line">  <span class="comment"># å¼•å…¥ç™¾åº¦çš„ç½‘å€</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">www.baidu.com</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>è¿›å…¥ Pod å†…éƒ¨æµ‹è¯•å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ nslookup å¯ä»¥è§£æåˆ°ç™¾åº¦çš„åœ°å€</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nolookup SVCåç§°.å‘½åç©ºé—´.svc.é›†ç¾¤åŸŸ</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/externalname%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="externalnameæµ‹è¯•ä¸€"></p>
<h3 id="5-9-ingress"><a href="#5-9-ingress" class="headerlink" title="5.9 ingress"></a>5.9 ingress</h3><h4 id="5-9-1-ä»€ä¹ˆæ˜¯ingress"><a href="#5-9-1-ä»€ä¹ˆæ˜¯ingress" class="headerlink" title="5.9.1 ä»€ä¹ˆæ˜¯ingress"></a>5.9.1 ä»€ä¹ˆæ˜¯ingress</h4><p>ingress æ˜¯å¯¹é›†ç¾¤ä¸­æœåŠ¡çš„å¤–éƒ¨è®¿é—®è¿›è¡Œç®¡ç†çš„ API å¯¹è±¡ï¼Œå…¸å‹çš„è®¿é—®æ–¹å¼æ˜¯ HTTPã€‚</p>
<p>ingress å¯ä»¥æä¾›è´Ÿè½½å‡è¡¡ã€SSL ç»ˆç»“å’ŒåŸºäºåç§°çš„è™šæ‹Ÿæ‰˜ç®¡ã€‚</p>
<p>ingress ç”±ä¸¤éƒ¨åˆ†æ„æˆï¼š</p>
<ul>
<li>ingress controllerï¼šå°†æ–°åŠ å…¥çš„ ingress è½¬åŒ–æˆ Nginx çš„é…ç½®æ–‡ä»¶å¹¶ä½¿ä¹‹ç”Ÿæ•ˆã€‚</li>
<li>ingress æœåŠ¡ï¼šå°† Nginx çš„é…ç½®æŠ½è±¡æˆä¸€ä¸ª ingress å¯¹è±¡ï¼Œæ¯æ·»åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡åªéœ€å†™ä¸€ä¸ªæ–°çš„ ingress çš„ yaml æ–‡ä»¶å³å¯ã€‚</li>
</ul>
<p>ingress controller ä¸»è¦æœ‰ä¸¤ç§ï¼Œ<code>nginx-ingress</code>å’Œ<code>traefik-ingress</code>ï¼Œè¿™é‡Œä¸»è¦è®²<code>nginx-ingress</code>ã€‚</p>
<p>ingress å®˜æ–¹ç½‘å€ï¼š<a target="_blank" rel="noopener" href="https://kubernetes.github.io/nginx-ingress">https://kubernetes.github.io/nginx-ingress</a></p>
<p>ingress GitHub ç½‘å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/kubernetes/nginx-ingress">https://github.com/kubernetes/nginx-ingress</a></p>
<p><strong>nginx-ingressåŠŸèƒ½</strong></p>
<p><code>nginx-ingress</code>ä¸»è¦è´Ÿè´£å‘å¤–æš´éœ²æœåŠ¡ï¼ŒåŒæ—¶æä¾›è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ã€‚</p>
<p>Nginx å¯¹åç«¯è¿è¡Œçš„æœåŠ¡ï¼ˆService1ã€Service2ï¼‰æä¾›åå‘ä»£ç†ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†åŸŸåä¸åç«¯æœåŠ¡ Endpoints çš„å¯¹åº”å…³ç³»ã€‚å®¢æˆ·ç«¯é€šè¿‡ä½¿ç”¨ DNS æœåŠ¡æˆ–è€…ç›´æ¥é…ç½®æœ¬åœ°çš„ hosts æ–‡ä»¶ï¼Œå°†åŸŸåéƒ½æ˜ å°„åˆ° Nginx ä»£ç†æœåŠ¡å™¨ã€‚å½“å®¢æˆ·ç«¯è®¿é—® service1.com æ—¶ï¼Œæµè§ˆå™¨ä¼šæŠŠåŒ…å«åŸŸåçš„è¯·æ±‚å‘é€ç»™ Nginx æœåŠ¡å™¨ï¼ŒNginx æœåŠ¡å™¨æ ¹æ®ä¼ æ¥çš„åŸŸåï¼Œé€‰æ‹©å¯¹åº”çš„ Serviceï¼Œè¿™é‡Œå°±æ˜¯é€‰æ‹© Service1 åç«¯æœåŠ¡ï¼Œç„¶åæ ¹æ®ä¸€å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé€‰æ‹© Service1 ä¸­çš„æŸä¸ªå®¹å™¨æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶ä½œå‡ºå“åº”ã€‚è¿‡ç¨‹å¾ˆç®€å•ï¼ŒNginx åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ä»¿ä½›æ˜¯ä¸€å°æ ¹æ®åŸŸåè¿›è¡Œè¯·æ±‚è½¬å‘çš„â€œè·¯ç”±å™¨â€ã€‚</p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%80.png" alt="nginx-ingressä¸€"></p>
<p><strong>nginx-ingresså·¥ä½œè¿‡ç¨‹</strong></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%BA%8C.png" alt="nginx-ingressäºŒ"></p>
<p><code>nginx-ingress</code>æ¨¡å—åœ¨è¿è¡Œæ—¶ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªä¸»ä½“ï¼š</p>
<ul>
<li>Storeï¼šStore ä¼šä¸ APIServer ä»¥åç¨‹çš„ Pod æ–¹å¼è¿›è¡Œä¸€ä¸ªç›‘å¬çŠ¶æ€ï¼Œå‘ç”Ÿæ–°çš„äº‹ä»¶ä¼šå†™å…¥å¾ªç¯é˜Ÿåˆ—é‡Œã€‚</li>
<li>NginxControllerï¼šNginxController ä¼šç›‘å¬å¾ªç¯é˜Ÿåˆ—é‡Œçš„äº‹ä»¶ï¼Œå‘ç”Ÿä¸€ä¸ªå¾ªç¯å°±ä¼šæ›´æ–°ä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å†™å…¥ SyncQueue é‡Œã€‚</li>
<li>SyncQueueï¼šSyncQueue åç¨‹ä¼šå®šæœŸæ‹‰å–éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆå¦‚æœæœ‰å¿…è¦çš„åˆ™ç›´æ¥ä» Store æ‹‰å–è¿‡æ¥è¿›è¡Œä¿®æ”¹ï¼‰ï¼Œæ¥ç€åˆ¤æ–­æ˜¯å¦éœ€è¦ reload nginxï¼Œæœ€åä¼šä»¥ nginx æ¨¡å—è¿è¡Œã€‚</li>
</ul>
<h4 id="5-9-2-ingressè§„åˆ™"><a href="#5-9-2-ingressè§„åˆ™" class="headerlink" title="5.9.2 ingressè§„åˆ™"></a>5.9.2 ingressè§„åˆ™</h4><p>æ¯ä¸ª HTTP è§„åˆ™éƒ½åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li>å¯é€‰çš„ <code>host</code>ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒæœªæŒ‡å®š <code>host</code>ï¼Œå› æ­¤è¯¥è§„åˆ™é€‚ç”¨äºé€šè¿‡æŒ‡å®š IP åœ°å€çš„æ‰€æœ‰å…¥ç«™ HTTP é€šä¿¡ã€‚ å¦‚æœæä¾›äº† <code>host</code>ï¼ˆä¾‹å¦‚ <a target="_blank" rel="noopener" href="http://www.cqm.com),åˆ™/">www.cqm.comï¼‰ï¼Œåˆ™</a> <code>rules</code> é€‚ç”¨äºè¯¥ <code>host</code>ã€‚</li>
<li>è·¯å¾„åˆ—è¡¨ pathsï¼ˆä¾‹å¦‚ï¼Œ<code>/testpath</code>ï¼‰,æ¯ä¸ªè·¯å¾„éƒ½æœ‰ä¸€ä¸ªç”± <code>serviceName</code> å’Œ <code>servicePort</code> å®šä¹‰çš„å…³è”åç«¯ã€‚ åœ¨è´Ÿè½½å‡è¡¡å™¨å°†æµé‡å®šå‘åˆ°å¼•ç”¨çš„æœåŠ¡ä¹‹å‰ï¼Œä¸»æœºå’Œè·¯å¾„éƒ½å¿…é¡»åŒ¹é…ä¼ å…¥è¯·æ±‚çš„å†…å®¹ã€‚</li>
<li><code>backend</code>ï¼ˆåç«¯ï¼‰æ˜¯ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">Service æ–‡æ¡£</a> ä¸­æ‰€è¿°çš„æœåŠ¡å’Œç«¯å£åç§°çš„ç»„åˆã€‚ ä¸è§„åˆ™çš„ <code>host</code> å’Œ <code>path</code> åŒ¹é…çš„å¯¹ Ingress çš„ HTTPï¼ˆå’Œ HTTPS ï¼‰è¯·æ±‚å°†å‘é€åˆ°åˆ—å‡ºçš„ <code>backend</code>ã€‚</li>
</ul>
<p><strong>è·¯å¾„ç±»å‹</strong></p>
<p>Ingress ä¸­çš„æ¯ä¸ªè·¯å¾„éƒ½éœ€è¦æœ‰å¯¹åº”çš„è·¯å¾„ç±»å‹ï¼ˆPath Typeï¼‰ã€‚æœªæ˜ç¡®è®¾ç½® <code>pathType</code> çš„è·¯å¾„æ— æ³•é€šè¿‡åˆæ³•æ€§æ£€æŸ¥ã€‚å½“å‰æ”¯æŒçš„è·¯å¾„ç±»å‹æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li><code>ImplementationSpecific</code>ï¼šå¯¹äºè¿™ç§è·¯å¾„ç±»å‹ï¼ŒåŒ¹é…æ–¹æ³•å–å†³äº IngressClassã€‚ å…·ä½“å®ç°å¯ä»¥å°†å…¶ä½œä¸ºå•ç‹¬çš„ <code>pathType</code> å¤„ç†æˆ–è€…ä¸ <code>Prefix</code> æˆ– <code>Exact</code> ç±»å‹ä½œç›¸åŒå¤„ç†ã€‚</li>
<li><code>Exact</code>ï¼šç²¾ç¡®åŒ¹é… URL è·¯å¾„ï¼Œä¸”åŒºåˆ†å¤§å°å†™ã€‚</li>
<li><code>Prefix</code>ï¼šåŸºäºä»¥ <code>/</code> åˆ†éš”çš„ URL è·¯å¾„å‰ç¼€åŒ¹é…ã€‚åŒ¹é…åŒºåˆ†å¤§å°å†™ï¼Œå¹¶ä¸”å¯¹è·¯å¾„ä¸­çš„å…ƒç´ é€ä¸ªå®Œæˆã€‚ è·¯å¾„å…ƒç´ æŒ‡çš„æ˜¯ç”± <code>/</code> åˆ†éš”ç¬¦åˆ†éš”çš„è·¯å¾„ä¸­çš„æ ‡ç­¾åˆ—è¡¨ã€‚ å¦‚æœæ¯ä¸ª <em>p</em> éƒ½æ˜¯è¯·æ±‚è·¯å¾„ <em>p</em> çš„å…ƒç´ å‰ç¼€ï¼Œåˆ™è¯·æ±‚ä¸è·¯å¾„ <em>p</em> åŒ¹é…ã€‚</li>
</ul>
<h4 id="5-9-3-éƒ¨ç½²nginx-ingress"><a href="#5-9-3-éƒ¨ç½²nginx-ingress" class="headerlink" title="5.9.3 éƒ¨ç½²nginx-ingress"></a>5.9.3 éƒ¨ç½²nginx-ingress</h4><ol>
<li>é€šè¿‡ Bare-metalï¼ˆNodePortï¼‰ æ–¹å¼éƒ¨ç½²ï¼Œå…ˆä¸‹è½½ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ°å€ä¸€</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.46.0/deploy/static/provider/baremetal/deploy.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ°å€äºŒ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/baremetal/deploy.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”±äºé•œåƒåœ°å€ä¹Ÿåœ¨å›½å¤–ï¼Œæ‰€ä»¥é€šè¿‡å›½å†…é•œåƒæºæ‹‰å–</span></span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/nginx-ingress-controller:v0.46.0</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/nginx-ingress-controller:v0.46.0 k8s.gcr.io/ingress-nginx/controller:v0.46.0</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è·å–é•œåƒåœ°å€ï¼Œä¸‹è½½å¥½éœ€è¦çš„é•œåƒï¼Œå¹¶å¯¼å…¥é•œåƒåˆ°å…¶å®ƒ node ä¸Š</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%89.png" alt="nginx-ingressä¸‰"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%9B%9B.png" alt="nginx-ingresså››"></p>
<ol start="3">
<li>é€šè¿‡ deploy.yaml æ–‡ä»¶ç”Ÿæˆ svc</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deploy.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%BA%94.png" alt="nginx-ingressäº”"></p>
<h4 id="5-9-4-ingress-HTTPä»£ç†è®¿é—®"><a href="#5-9-4-ingress-HTTPä»£ç†è®¿é—®" class="headerlink" title="5.9.4 ingress HTTPä»£ç†è®¿é—®"></a>5.9.4 ingress HTTPä»£ç†è®¿é—®</h4><p> <img src="/2024/02/18/kubernetes/nginx-ingress%E5%85%AD.png" alt="nginx-ingresså…­"></p>
<p><code>ingress-nginx</code>ä¼šæ ¹æ®é…ç½®å¥½çš„ yaml æ–‡ä»¶ï¼Œè‡ªåŠ¨é…ç½® nginx.conf å’Œè™šæ‹Ÿä¸»æœºæ–‡ä»¶ã€‚</p>
<ol>
<li>åˆ›å»º deployment1ã€deployment2ã€service1ã€service2</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx2</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º nginx-ingress1ã€nginx-ingress2</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># è®¾ç½®è™šæ‹Ÿä¸»æœºï¼Œé€šè¿‡è¯¥åŸŸåè®¿é—®</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm1.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="comment"># è·¯å¾„åˆ—è¡¨</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="comment"># è·¯å¾„ç±»å‹</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="comment"># åç«¯</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="comment"># æŒ‡å®šè¿æ¥å“ªä¸ªSVC</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm2.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ›å»º</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment_svc1.yaml</span><br><span class="line">kubectl create -f nginx_deployment_svc2.yaml</span><br><span class="line">kubectl create -f nginx_ingress.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç»™æ¯ä¸ª Pod å†™å…¥ä¿¡æ¯ï¼Œæ–¹ä¾¿æŸ¥çœ‹è´Ÿè½½å‡è¡¡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-deployment-... -- /bin/bash</span><br><span class="line">echo &#x27;this is nginx-pod-1&#x27; &gt; /usr/share/nginx/html/pod.html</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>æŸ¥çœ‹ ingress-nginx æ‰€åˆ›å»ºçš„ svc æš´éœ²çš„ç«¯å£ï¼Œä»¥åŠ service1ã€service2ã€nginx-ingress1ã€nginx-ingress2</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl get ingress</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%83.png" alt="nginx-ingressä¸ƒ"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%85%AB.png" alt="nginx-ingresså…«"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B9%9D.png" alt="nginx-ingressä¹"></p>
<ol start="6">
<li>åœ¨ &#x2F;etc&#x2F;hosts æ–‡ä»¶ä¸‹å†™å…¥åŸŸåä¸ IP ç»‘å®šï¼Œè®¿é—®æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å®ç°äº†è´Ÿè½½å‡è¡¡</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81.png" alt="nginx-ingresså"></p>
<ol start="7">
<li>å¯ä»¥è¿›å…¥ ingress æ§åˆ¶å™¨å†…éƒ¨æŸ¥çœ‹ nginx é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°è‡ªåŠ¨æ·»åŠ çš„ä»£ç†é…ç½®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it -n ingress-nginx ingress-nginx-controller-... -- /bin/bash</span><br><span class="line">cat nginx.conf</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%80.png" alt="nginx-ingressåä¸€"></p>
<h4 id="5-9-5-ingress-HTTPSä»£ç†è®¿é—®"><a href="#5-9-5-ingress-HTTPSä»£ç†è®¿é—®" class="headerlink" title="5.9.5 ingress HTTPSä»£ç†è®¿é—®"></a>5.9.5 ingress HTTPSä»£ç†è®¿é—®</h4><p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%BA%8C.png" alt="nginx-ingressåäºŒ"></p>
<ol>
<li>åˆ›å»ºç§é’¥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=nginxsvc/O=nginxsvc&quot;</span><br><span class="line">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º deployment3ã€service3ã€nginx-ingress3</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc3.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx3</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">www.cqm3.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm3.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service3</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>åˆ›å»º</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment_svc3.yaml nginx_ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%89.png" alt="nginx-ingressåä¸‰"></p>
<ol start="5">
<li>åœ¨æ¯ä¸ª Pod å†™å…¥ pod.htmlï¼Œä¾¿äºæŸ¥çœ‹è´Ÿè½½å‡è¡¡æ•ˆæœï¼Œå¹¶æµ‹è¯•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it ingress-nginx-... -- /bin/bash</span><br><span class="line">echo &#x27;this is node01-pod&#x27; &gt; /usr/share/nginx/html/pod.html</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%9B%9B.png" alt="nginx-ingressåå››"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%BA%94.png" alt="nginx-ingressåäº”"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%85%AD.png" alt="nginx-ingressåå…­"></p>
<h4 id="5-9-5-Nginxè¿›è¡ŒåŸºç¡€è®¤è¯ï¼ˆBasicAuthï¼‰"><a href="#5-9-5-Nginxè¿›è¡ŒåŸºç¡€è®¤è¯ï¼ˆBasicAuthï¼‰" class="headerlink" title="5.9.5 Nginxè¿›è¡ŒåŸºç¡€è®¤è¯ï¼ˆBasicAuthï¼‰"></a>5.9.5 Nginxè¿›è¡ŒåŸºç¡€è®¤è¯ï¼ˆBasicAuthï¼‰</h4><ol>
<li>é€šè¿‡ Apache åˆ›å»ºç”¨æˆ·è®¤è¯æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">htpasswd -c auth cqm</span><br><span class="line">kubectl create secret generic basic-auth --from-file=auth</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º ingress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-auth</span></span><br><span class="line">  <span class="comment"># æ·»åŠ åŸºç¡€è®¤è¯å­—æ®µ</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required - cqm&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.cqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="comment"># è¿™é‡Œä½¿ç”¨HTTPä»£ç†å®éªŒçš„service1</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ›å»º ingress åæµ‹è¯•</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%83.png" alt="nginx-ingressåä¸ƒ"></p>
<h4 id="5-9-6-Nginxé‡å†™"><a href="#5-9-6-Nginxé‡å†™" class="headerlink" title="5.9.6  Nginxé‡å†™"></a>5.9.6  Nginxé‡å†™</h4><table>
<thead>
<tr>
<th>åç§°</th>
<th>æè¿°</th>
<th>ç±»å‹</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;rewrite-target</td>
<td>å¿…é¡»é‡å®šå‘æµé‡çš„ç›®æ ‡ URI</td>
<td>string</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-redirect</td>
<td>æŒ‡ç¤ºä½ç½®éƒ¨åˆ†æ˜¯å¦ä»…å¯è®¿é—® SSLï¼ˆå½“ Ingress åŒ…å«è¯ä¹¦æ—¶é»˜è®¤ä¸º Trueï¼‰</td>
<td>bool</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;force-ssl-redirect</td>
<td>å³ä½¿ Ingress æœªå¯ç”¨ TLSï¼Œä¹Ÿå¼ºåˆ¶é‡å®šå‘åˆ° HTTPS</td>
<td>bool</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;app-root</td>
<td>å®šä¹‰æ§åˆ¶å™¨å¿…é¡»é‡å®šå‘çš„åº”ç”¨ç¨‹åºæ ¹ï¼Œå¦‚æœå®ƒåœ¨â€œ&#x2F;â€ä¸Šä¸‹æ–‡ä¸­</td>
<td>string</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;use-regex</td>
<td>æŒ‡ç¤º Ingress ä¸Šå®šä¹‰çš„è·¯å¾„æ˜¯å¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</td>
<td>bool</td>
</tr>
</tbody></table>
<ol>
<li>å…ˆå‡†å¤‡å¥½è½¬å‘åçš„ deploymentã€ingressç­‰ï¼Œè¿™é‡Œç”¨ä¸Šè¾¹çš„ ingress1ï¼Œç”¨æˆ·è®¿é—® <a target="_blank" rel="noopener" href="http://www.rewritecqm.com/">www.rewritecqm.com</a> æ—¶å°±è·³è½¬åˆ° <a target="_blank" rel="noopener" href="http://www.cqm1.com/">www.cqm1.com</a></li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%85%AB.png" alt="nginx-ingressåå…«"></p>
<ol start="2">
<li>ç¼–å†™é‡å†™ ingress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">rewrite_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rewrite-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># è®¿é—® www.rewritecqm.com:30779 å°†è·³è½¬åˆ° http://www.cqm1.com:30779/pod.html</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">http://www.cqm1.com:30779/pod.html</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.rewritecqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æµ‹è¯•</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B9%9D.png" alt="nginx-ingressåä¹"></p>
<h2 id="å…­ã€k8så­˜å‚¨"><a href="#å…­ã€k8så­˜å‚¨" class="headerlink" title="å…­ã€k8så­˜å‚¨"></a>å…­ã€k8så­˜å‚¨</h2><h3 id="6-1-é…ç½®å­˜å‚¨å·"><a href="#6-1-é…ç½®å­˜å‚¨å·" class="headerlink" title="6.1 é…ç½®å­˜å‚¨å·"></a>6.1 é…ç½®å­˜å‚¨å·</h3><p>é…ç½®å­˜å‚¨å·å¹¶ä¸æ˜¯ç”¨æ¥è¿›è¡Œå®¹å™¨é—´ç›¸äº’äº¤äº’æˆ– Pod é—´æ•°æ®å…±äº«çš„ï¼Œè€Œæ˜¯ç”¨äºå‘å„ä¸ª Pod æ³¨å…¥é…ç½®ä¿¡æ¯çš„ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p>
<p>ConfigMapï¼šå¯ä¼ é€’æ™®é€šä¿¡æ¯</p>
<p>Secretï¼šå¯ä¼ é€’å¯†ç ç­‰æ•æ„Ÿçš„é…ç½®ä¿¡æ¯</p>
<p>DownwardAPIï¼šå¯ä¼ é€’ Pod å’Œå®¹å™¨è‡ªèº«çš„è¿è¡Œä¿¡æ¯</p>
<h4 id="6-1-1-ConfigMap"><a href="#6-1-1-ConfigMap" class="headerlink" title="6.1.1 ConfigMap"></a>6.1.1 ConfigMap</h4><p>è®¸å¤šåº”ç”¨ç¨‹åºéƒ½ä¼šä»é…ç½®æ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°æˆ–ç¯å¢ƒå˜é‡ä¸­è¯»å–é…ç½®ä¿¡æ¯ã€‚</p>
<p>ConfigMap API ç»™æˆ‘ä»¬æä¾›äº†å‘å®¹å™¨å†…éƒ¨æ³¨å…¥ä¿¡æ¯çš„æœºåˆ¶ï¼ŒConfigMap å¯ä»¥è¢«ç”¨æ¥ä¿å­˜å•ä¸ªå±æ€§ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜æ•´ä¸ªé…ç½®æ–‡ä»¶æˆ–è€… JSON äºŒè¿›åˆ¶å¯¹è±¡ã€‚</p>
<p>ConfigMap çš„åˆ›å»ºæ–¹å¼æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«ä¸ºåŸºäºç›®å½•ã€æ–‡ä»¶å’Œå­—é¢å€¼æ¥åˆ›å»ºã€‚</p>
<p><strong>åŸºäºç›®å½•åˆ›å»º ConfigMap</strong></p>
<ol>
<li>åˆ›å»ºæŒ‡å®šç›®å½•ï¼Œä¸‹è½½å®˜æ–¹æµ‹è¯•æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/k8s/plugin/configmap/dir || cd /root/k8s/plugin/configmap/dir</span><br><span class="line">wget https://kubernetes.io/examples/configmap/game.properties</span><br><span class="line">wget https://kubernetes.io/examples/configmap/ui.properties</span><br><span class="line">kubectl create configmap configmap1 --from-file=./</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æŸ¥çœ‹å‘½ä»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe cm configmap1</span><br><span class="line">kubectl get cm configmap1 -o yaml</span><br></pre></td></tr></table></figure>

<p><strong>åŸºäºæ–‡ä»¶åˆ›å»º ConfigMap</strong></p>
<ol>
<li>é€šè¿‡ game.properties å’Œ ui.properties åˆ›å»º</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap configmap2 --from-file=game.properties --from-file=ui.properties</span><br></pre></td></tr></table></figure>

<p><strong>åŸºäºå­—é¢å€¼åˆ›å»º ConfigMap</strong></p>
<ol>
<li>é€šè¿‡<code>--from-literal=é”®å=é”®å€¼</code>æ¥åˆ›å»º</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap configmap3 --from-literal=special.how=very</span><br></pre></td></tr></table></figure>

<h5 id="6-1-1-1-Podä¸­ä½¿ç”¨ConfigMap"><a href="#6-1-1-1-Podä¸­ä½¿ç”¨ConfigMap" class="headerlink" title="6.1.1.1 Podä¸­ä½¿ç”¨ConfigMap"></a>6.1.1.1 Podä¸­ä½¿ç”¨ConfigMap</h5><p><strong>ä½¿ç”¨ ConfigMap ä»£æ›¿ç¯å¢ƒå˜é‡</strong></p>
<ol>
<li>åˆ›å»ºä¸¤ä¸ª ConfigMap</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">special_cm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">special.how:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">special.type:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">env_cm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å°†è¿™ä¸¤ä¸ª ConfigMap æ³¨å…¥åˆ° Podä¸­</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod1-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span>]</span><br><span class="line">      <span class="comment"># env:å–æŸä¸ª ConfigMap ä¸­çš„æŸä¸ªé”®å€¼</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_HOW_KEY</span></span><br><span class="line">          <span class="comment"># å®šä¹‰ç¯å¢ƒå˜é‡</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="comment"># è¡¨ç¤ºä» ConfigMap ä¸­å¼•ç”¨</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="comment"># è¦å¼•ç”¨çš„ ConfigMap åç§°</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="comment"># å¼•ç”¨ ConfigMap ä¸­çš„å“ªä¸ªé”®å€¼å¯¹</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">      <span class="comment"># envFrom:å–æŸä¸ª ConfigMap çš„æ‰€æœ‰é”®å€¼</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç”Ÿæˆ Pod åæŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°æ³¨å…¥æˆåŠŸ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs pod1</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%B8%80.png" alt="ConfigMapä¸€"></p>
<p><strong>ä½¿ç”¨ ConfigMap è®¾ç½®å‘½ä»¤è¡Œå‚æ•°</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod2-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo $(SPECIAL_HOW_KEY) $(SPECIAL_TYPE_KEY)&quot;</span>]</span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_HOW_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p><strong>å°† ConfigMap æ•°æ®æ·»åŠ åˆ°ä¸€ä¸ªå·ä¸­</strong></p>
<ol>
<li>åˆ›å»º Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod3.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod3-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 1200&quot;</span> ]</span><br><span class="line">      <span class="comment"># æŒ‚è½½config-volumeï¼ŒæŒ‚è½½åœ¨/etc/configç›®å½•ä¸‹</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="comment"># åˆ›å»ºä¸€ä¸ªå·ï¼Œå°†special-cmå†…å®¹å†™å…¥config-volumeå·</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è¿›å…¥ Podï¼Œåœ¨æŒ‚è½½ç›®å½•ä¸‹æŸ¥çœ‹æ˜¯å¦å†™å…¥åˆ° config æ–‡ä»¶é‡Œ</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%BA%8C.png" alt="ConfigMapäºŒ"></p>
<h5 id="6-1-1-2-ConfigMapçƒ­æ›´æ–°"><a href="#6-1-1-2-ConfigMapçƒ­æ›´æ–°" class="headerlink" title="6.1.1.2 ConfigMapçƒ­æ›´æ–°"></a>6.1.1.2 ConfigMapçƒ­æ›´æ–°</h5><p>æœ¬ä¾‹å­é€šè¿‡ ConfigMap æ¥å®ç°çƒ­æ›´æ–°ï¼Œå¯ä»¥å®ç°çƒ­æ›´æ–° nginx.confï¼Œä½†éœ€è¿›å…¥å®¹å™¨å†…éƒ¨é‡è½½é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥é€šè¿‡çƒ­æ›´æ–°ä¸€ä¸ª html æ¥å±•ç¤ºæ•ˆæœã€‚</p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶ï¼Œå¹¶åˆ›å»º</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">hotupdate.yaml</span></span><br><span class="line"><span class="comment"># ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-hotupdate-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">test.html:</span> <span class="string">&#x27;this is the fist test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># æŒ‚è½½ä¸‹è¾¹åˆ›å»ºçš„volume</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-html-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="comment"># åˆ›å»ºä¸€ä¸ªvolumeï¼Œé€šè¿‡ConfigMapæ–¹å¼æŒ‚è½½ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„nginx-hotupdate-cm</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-html-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-hotupdate-cm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hotupdate.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æµ‹è¯•æ˜¯å¦èƒ½å¤Ÿè®¿é—®åˆ°</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%B8%89.png" alt="ConfigMapä¸‰"></p>
<ol start="3">
<li>ä¿®æ”¹ ConfigMapï¼Œå¹¶å†æ¬¡è®¿é—®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm nginx-hotupdate-cm</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/ConfigMap%E5%9B%9B.png" alt="ConfigMapå››"></p>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%BA%94.png" alt="ConfigMapäº”"></p>
<h4 id="6-1-2-Secret"><a href="#6-1-2-Secret" class="headerlink" title="6.1.2 Secret"></a>6.1.2 Secret</h4><p><code>Secret</code> å¯¹è±¡ç±»å‹ç”¨æ¥ä¿å­˜æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€OAuth ä»¤ç‰Œå’Œ SSH å¯†é’¥ã€‚ å°†è¿™äº›ä¿¡æ¯æ”¾åœ¨ <code>secret</code> ä¸­æ¯”æ”¾åœ¨ <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> çš„å®šä¹‰æˆ–è€… <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-image">å®¹å™¨é•œåƒ</a> ä¸­æ¥è¯´æ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚</p>
<p><strong>Secret çš„ç±»å‹</strong></p>
<table>
<thead>
<tr>
<th>å†…ç½®ç±»å‹</th>
<th>ç”¨æ³•</th>
</tr>
</thead>
<tbody><tr>
<td><code>Opaque</code></td>
<td>ç”¨æˆ·å®šä¹‰çš„ä»»æ„æ•°æ®</td>
</tr>
<tr>
<td><code>kubernetes.io/service-account-token</code></td>
<td>æœåŠ¡è´¦å·ä»¤ç‰Œ</td>
</tr>
<tr>
<td><code>kubernetes.io/dockercfg</code></td>
<td><code>~/.dockercfg</code> æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼</td>
</tr>
<tr>
<td><code>kubernetes.io/dockerconfigjson</code></td>
<td><code>~/.docker/config.json</code> æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼</td>
</tr>
<tr>
<td><code>kubernetes.io/basic-auth</code></td>
<td>ç”¨äºåŸºæœ¬èº«ä»½è®¤è¯çš„å‡­æ®</td>
</tr>
<tr>
<td><code>kubernetes.io/ssh-auth</code></td>
<td>ç”¨äº SSH èº«ä»½è®¤è¯çš„å‡­æ®</td>
</tr>
<tr>
<td><code>kubernetes.io/tls</code></td>
<td>ç”¨äº TLS å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ç«¯çš„æ•°æ®</td>
</tr>
<tr>
<td><code>bootstrap.kubernetes.io/token</code></td>
<td>å¯åŠ¨å¼•å¯¼ä»¤ç‰Œæ•°æ®</td>
</tr>
</tbody></table>
<h5 id="6-1-2-1-Opaque"><a href="#6-1-2-1-Opaque" class="headerlink" title="6.1.2.1 Opaque"></a>6.1.2.1 Opaque</h5><p>Opaque ä½¿ç”¨base64ç¼–ç å­˜å‚¨ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ <code>base64 --decode</code> è§£ç è·å¾—åŸå§‹æ•°æ®ï¼Œå› æ­¤å®‰å…¨æ€§å¼±ã€‚</p>
<p>ä½¿ç”¨ç¤ºä¾‹</p>
<ol>
<li>ç”Ÿæˆ base64 ç¼–ç </li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;admin&#x27; | base64</span><br><span class="line">YWRtaW4K</span><br><span class="line">echo &#x27;12345&#x27; | base64</span><br><span class="line">MTIzNDUK</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4K</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIzNDUK</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f opaque.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æŒ‚è½½åˆ° volume ä¸­ä½¿ç”¨ï¼ŒæŸ¥çœ‹æµ‹è¯•å¯ä»¥çœ‹åˆ°æŒ‚è½½åçš„ä¿¡æ¯è¢«è§£ç äº†</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque-pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opaque-pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opaque-pod1-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="comment"># æŒ‚è½½ä¸‹è¾¹åˆ›å»ºçš„volume-opaque</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-opaque</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/secrets</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># åˆ›å»ºä¸€ä¸ªsecretç±»å‹çš„volumeï¼Œå¼•ç”¨ä¸Šè¾¹åˆ›å»ºå¥½çš„secret-opaque</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-opaque</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">secret-opaque</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%B8%80.png" alt="secretä¸€"></p>
<ol start="4">
<li>å¯¼å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­å¹¶æµ‹è¯•</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque-pod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opaque-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">opaque-pod2</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opaque-pod2-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># å°†secretå¯¼å…¥ç¯å¢ƒå˜é‡ä¸­</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># å‘½åå˜é‡</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER</span></span><br><span class="line">          <span class="comment"># å¼•ç”¨secret-opaqueä¸­çš„usernameçš„é”®å€¼</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PASSWORD</span></span><br><span class="line">          <span class="comment"># å¼•ç”¨secret-opaqueä¸­çš„passwordçš„é”®å€¼</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%BA%8C.png" alt="secretäºŒ"></p>
<h5 id="6-1-2-2-ImagePullSecret"><a href="#6-1-2-2-ImagePullSecret" class="headerlink" title="6.1.2.2 ImagePullSecret"></a>6.1.2.2 ImagePullSecret</h5><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ç§ <code>type</code> å€¼ä¹‹ä¸€æ¥åˆ›å»º Secretï¼Œç”¨ä»¥å­˜æ”¾è®¿é—® Docker ä»“åº“æ¥ä¸‹è½½é•œåƒçš„å‡­æ®ã€‚</p>
<ul>
<li><code>kubernetes.io/dockercfg</code></li>
<li><code>kubernetes.io/dockerconfigjson</code></li>
</ul>
<p><code>kubernetes.io/dockerconfigjson</code> åˆ›å»º Secret ç¤ºä¾‹</p>
<ol>
<li>åˆ›å»º Secret</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry cqmregistry --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%B8%89.png" alt="secretä¸‰"></p>
<ol start="2">
<li>åœ¨ Pod ä¸­è¿ç”¨</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">  <span class="comment"># è°ƒç”¨åˆ›å»ºå¥½çš„Secret</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cqmregistry</span></span><br></pre></td></tr></table></figure>

<h5 id="6-1-2-3-Downward-API"><a href="#6-1-2-3-Downward-API" class="headerlink" title="6.1.2.3 Downward API"></a>6.1.2.3 Downward API</h5><p>æœ‰æ—¶å€™ Pod éœ€è¦è·å–è‡ªèº«çš„ä¿¡æ¯ï¼Œè¿™æ—¶å€™ Downward API å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p>
<p>Downward API æ˜¯é€šè¿‡ fieldRef å‚æ•°è·å–ä¿¡æ¯çš„ã€‚</p>
<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod1-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;EnvPodName:$&#123;EnvPodName&#125; EnvNodeName:$&#123;EnvNodeName&#125;&quot;, sleep 3600&#x27;</span> ]</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EnvPodName</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EnvNodeName</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹äºŒ</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod2-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;EnvPodName:$&#123;EnvPodName&#125; EnvNodeName:$&#123;EnvNodeName&#125;&quot;, sleep 3600&#x27;</span> ]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">downwardAPI:</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;PodName&#x27;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;NodeName&#x27;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-æœ¬åœ°å­˜å‚¨å·"><a href="#6-2-æœ¬åœ°å­˜å‚¨å·" class="headerlink" title="6.2 æœ¬åœ°å­˜å‚¨å·"></a>6.2 æœ¬åœ°å­˜å‚¨å·</h3><p>Container ä¸­çš„æ–‡ä»¶åœ¨ç£ç›˜ä¸Šæ˜¯ä¸´æ—¶å­˜æ”¾çš„ï¼Œè¿™ç»™ Container ä¸­è¿è¡Œçš„è¾ƒé‡è¦çš„åº”ç”¨ç¨‹åºå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚é—®é¢˜ä¹‹ä¸€æ˜¯å½“å®¹å™¨å´©æºƒæ—¶æ–‡ä»¶ä¸¢å¤±ã€‚kubelet ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ï¼Œ ä½†å®¹å™¨ä¼šä»¥å¹²å‡€çš„çŠ¶æ€é‡å¯ã€‚ ç¬¬äºŒä¸ªé—®é¢˜ä¼šåœ¨åŒä¸€ <code>Pod</code> ä¸­è¿è¡Œå¤šä¸ªå®¹å™¨å¹¶å…±äº«æ–‡ä»¶æ—¶å‡ºç°ã€‚ Kubernetes <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">Volume</a> è¿™ä¸€æŠ½è±¡æ¦‚å¿µèƒ½å¤Ÿè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<p>Kubernetes æ”¯æŒå¾ˆå¤šç±»å‹çš„å·ã€‚ <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> å¯ä»¥åŒæ—¶ä½¿ç”¨ä»»æ„æ•°ç›®çš„å·ç±»å‹ã€‚ ä¸´æ—¶å·ç±»å‹çš„ç”Ÿå‘½å‘¨æœŸä¸ Pod ç›¸åŒï¼Œä½†æŒä¹…å·å¯ä»¥æ¯” Pod çš„å­˜æ´»æœŸé•¿ã€‚ å½“ Pod ä¸å†å­˜åœ¨æ—¶ï¼ŒKubernetes ä¹Ÿä¼šé”€æ¯ä¸´æ—¶å·ï¼›ä¸è¿‡ Kubernetes ä¸ä¼šé”€æ¯æŒä¹…å·ã€‚å¯¹äºç»™å®š Pod ä¸­ä»»ä½•ç±»å‹çš„å·ï¼Œåœ¨å®¹å™¨é‡å¯æœŸé—´æ•°æ®éƒ½ä¸ä¼šä¸¢å¤±ã€‚</p>
<p><img src="/2024/02/18/kubernetes/volume%E4%B8%80.png" alt="volumeä¸€"></p>
<p>å·çš„ç±»å‹åˆ†ä¸ºå¾ˆå¤šç§ï¼Œå¯é€šè¿‡å®˜æ–¹æ–‡æ¡£æŸ¥çœ‹ï¼š<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">https://kubernetes.io/zh/docs/concepts/storage/volumes/</a></p>
<h4 id="6-2-1-emptyDir"><a href="#6-2-1-emptyDir" class="headerlink" title="6.2.1 emptyDir"></a>6.2.1 emptyDir</h4><p>å½“ Pod åˆ†æ´¾åˆ°æŸä¸ª Node ä¸Šæ—¶ï¼Œ<code>emptyDir</code> å·ä¼šè¢«åˆ›å»ºï¼Œå¹¶ä¸”åœ¨ Pod åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡ŒæœŸé—´ï¼Œå·ä¸€ç›´å­˜åœ¨ã€‚ å°±åƒå…¶åç§°è¡¨ç¤ºçš„é‚£æ ·ï¼Œå·æœ€åˆæ˜¯ç©ºçš„ã€‚ å°½ç®¡ Pod ä¸­çš„å®¹å™¨æŒ‚è½½ <code>emptyDir</code> å·çš„è·¯å¾„å¯èƒ½ç›¸åŒä¹Ÿå¯èƒ½ä¸åŒï¼Œè¿™äº›å®¹å™¨éƒ½å¯ä»¥è¯»å†™ <code>emptyDir</code> å·ä¸­ç›¸åŒçš„æ–‡ä»¶ã€‚ å½“ Pod å› ä¸ºæŸäº›åŸå› è¢«ä»èŠ‚ç‚¹ä¸Šåˆ é™¤æ—¶ï¼Œ<code>emptyDir</code> å·ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®¹å™¨å´©æºƒå¹¶ä¸ä¼šå¯¼è‡´ Pod è¢«ä»èŠ‚ç‚¹ä¸Šç§»é™¤ï¼Œå› æ­¤å®¹å™¨å´©æºƒæœŸé—´ <code>emptyDir</code> å·ä¸­çš„æ•°æ®æ˜¯å®‰å…¨çš„ã€‚</p>
<p><code>emptyDir</code> çš„ä¸€äº›ç”¨é€”ï¼š</p>
<ul>
<li>ç¼“å­˜ç©ºé—´ï¼Œä¾‹å¦‚åŸºäºç£ç›˜çš„å½’å¹¶æ’åºã€‚</li>
<li>ä¸ºè€—æ—¶è¾ƒé•¿çš„è®¡ç®—ä»»åŠ¡æä¾›æ£€æŸ¥ç‚¹ï¼Œä»¥ï¥¥ä»»åŠ¡èƒ½æ–¹ï¥¥åœ°ä»å´©æºƒå‰çŠ¶æ€æ¢å¤æ‰§ï¨ˆã€‚</li>
<li>åœ¨ Web æœåŠ¡å™¨å®¹å™¨æœåŠ¡æ•°æ®æ—¶ï¼Œä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨è·å–çš„æ–‡ä»¶ã€‚</li>
</ul>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">emptydir-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-container1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/empty1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-container2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 6000&#x27;</span>]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/empty2</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è¿›å…¥ Pod ä¸­çš„ä¸åŒå®¹å™¨æŸ¥çœ‹æ˜¯å¦å…±äº«åŒä¸€ä¸ª volumeï¼Œ</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E4%BA%8C.png" alt="volumeäºŒ"></p>
<p><img src="/2024/02/18/kubernetes/volume%E4%B8%89.png" alt="volumeä¸‰"></p>
<h4 id="6-2-2-hostPath"><a href="#6-2-2-hostPath" class="headerlink" title="6.2.2 hostPath"></a>6.2.2 hostPath</h4><p><code>hostPath</code> å·èƒ½å°†ä¸»æœºèŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ°ä½ çš„ Pod ä¸­ï¼Œç±»ä¼¼ docker ä¸­çš„ volume æŒ‚è½½ã€‚</p>
<p><code>hostPath</code> çš„ä¸€äº›ç”¨æ³•æœ‰ï¼š</p>
<ul>
<li>è¿è¡Œä¸€ä¸ªéœ€è¦è®¿é—® Docker å†…éƒ¨æœºåˆ¶çš„å®¹å™¨ï¼›å¯ä½¿ç”¨ <code>hostPath</code> æŒ‚è½½ <code>/var/lib/docker</code> è·¯å¾„ã€‚</li>
<li>åœ¨å®¹å™¨ä¸­è¿è¡Œ cAdvisorï¼ˆå®¹å™¨ç›‘æ§å·¥å…·ï¼‰ æ—¶ï¼Œä»¥ <code>hostPath</code> æ–¹å¼æŒ‚è½½ <code>/sys</code>ã€‚</li>
<li>å…è®¸ Pod æŒ‡å®šç»™å®šçš„ <code>hostPath</code> åœ¨è¿è¡Œ Pod ä¹‹å‰æ˜¯å¦åº”è¯¥å­˜åœ¨ï¼Œæ˜¯å¦åº”è¯¥åˆ›å»ºä»¥åŠåº”è¯¥ä»¥ï§½ä¹ˆæ–¹å¼å­˜åœ¨ã€‚</li>
</ul>
<p>é™¤äº†å¿…éœ€çš„ <code>path</code> å±æ€§ä¹‹å¤–ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æ€§åœ°ä¸º <code>hostPath</code> å·æŒ‡å®š <code>type</code>ã€‚</p>
<p>æ”¯æŒçš„ <code>type</code> å€¼å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">å–å€¼</th>
<th align="left">è¡Œä¸º</th>
</tr>
</thead>
<tbody><tr>
<td align="left"></td>
<td align="left">ç©ºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤ï¼‰ç”¨äºå‘åå…¼å®¹ï¼Œè¿™æ„å‘³ç€åœ¨å®‰è£… hostPath å·ä¹‹å‰ä¸ä¼šæ‰§è¡Œä»»ä½•æ£€æŸ¥ã€‚</td>
</tr>
<tr>
<td align="left"><code>DirectoryOrCreate</code></td>
<td align="left">å¦‚æœåœ¨ç»™å®šè·¯å¾„ä¸Šä»€ä¹ˆéƒ½ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°†æ ¹æ®éœ€è¦åˆ›å»ºç©ºç›®å½•ï¼Œæƒé™è®¾ç½®ä¸º 0755ï¼Œå…·æœ‰ä¸ kubelet ç›¸åŒçš„ç»„å’Œå±ä¸»ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td align="left"><code>Directory</code></td>
<td align="left">åœ¨ç»™å®šï¤·å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„ç›®å½•ã€‚</td>
</tr>
<tr>
<td align="left"><code>FileOrCreate</code></td>
<td align="left">å¦‚æœåœ¨ç»™å®šè·¯å¾„ä¸Šä»€ä¹ˆéƒ½ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°†åœ¨é‚£é‡Œæ ¹æ®éœ€è¦åˆ›å»ºç©ºæ–‡ä»¶ï¼Œæƒé™è®¾ç½®ä¸º 0644ï¼Œå…·æœ‰ä¸ kubelet ç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒã€‚</td>
</tr>
<tr>
<td align="left"><code>File</code></td>
<td align="left">åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„æ–‡ä»¶ã€‚</td>
</tr>
<tr>
<td align="left"><code>Socket</code></td>
<td align="left">åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„ UNIX å¥—æ¥å­—ã€‚</td>
</tr>
<tr>
<td align="left"><code>CharDevice</code></td>
<td align="left">åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å­—ç¬¦è®¾å¤‡ã€‚</td>
</tr>
<tr>
<td align="left"><code>BlockDevice</code></td>
<td align="left">åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å—è®¾å¤‡ã€‚</td>
</tr>
</tbody></table>
<p>æ³¨æ„ï¼šå…·æœ‰ç›¸åŒé…ç½®ï¼ˆä¾‹å¦‚åŸºäºåŒä¸€ PodTemplate åˆ›å»ºï¼‰çš„å¤šä¸ª Pod ä¼šç”±äºèŠ‚ç‚¹ä¸Šæ–‡ä»¶çš„ï¥§åŒè€Œåœ¨ï¥§åŒèŠ‚ç‚¹ä¸Šæœ‰ï¥§åŒçš„ï¨ˆä¸ºï¼Œå³å‡å¦‚åŒä¸€ä¸ª template åˆ›å»ºå‡ºæ¥çš„ Pod åˆ†é…åœ¨äº†ä¸åŒçš„ Node ä¸Šæ—¶ï¼Œä¼šå› ä¸ºèŠ‚ç‚¹çš„ä¸åŒè€Œäº§ç”Ÿä¸åŒçš„è¡Œä¸ºã€‚</p>
<ol>
<li>ç¼–å†™ yaml æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hostpath-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># å®¿ä¸»æœºè¢«æŒ‚è½½ç›®å½•</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># å¦‚æœæ²¡æœ‰/dataç›®å½•åˆ™ä¼šè¢«åˆ›å»º</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æŸ¥çœ‹æ˜¯å¦æŒ‚è½½æˆåŠŸ</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%9B%9B.png" alt="volumeå››"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>FileOrCreate</code>ä¸‹ï¼Œå¦‚æœè¢«æŒ‚è½½çš„ç›®å½•ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆä¸ä¼šè‡ªåŠ¨åˆ›å»ºè¯¥ç›®å½•ï¼Œ ä¸ºäº†ç¡®ä¿è¿™ç§æ¨¡å¼èƒ½å¤Ÿå·¥ä½œï¼Œå¯ä»¥å°è¯•æŠŠæ–‡ä»¶å’Œå®ƒå¯¹åº”çš„ç›®å½•åˆ†å¼€æŒ‚è½½ã€‚</p>
<p><strong>hostPath FileOrCreate é…ç½®ç¤ºä¾‹</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath-fileorcreate-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-fileorcreate-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mydir</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test/test.txt</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myfile</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydir</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># å¦‚æœå®¿ä¸»æœºæ²¡æœ‰/dataç›®å½•åˆ™ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfile</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/test.txt</span></span><br><span class="line">      <span class="comment"># å› ä¸ºä¸Šé¢å·²ç»ç¡®ä¿ä¼šæœ‰/dataç›®å½•ï¼Œæ‰€ä»¥è¯¥æ–‡ä»¶çš„æŒ‚è½½ä¸å—å½±å“</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-æŒä¹…å­˜å‚¨å·"><a href="#6-3-æŒä¹…å­˜å‚¨å·" class="headerlink" title="6.3 æŒä¹…å­˜å‚¨å·"></a>6.3 æŒä¹…å­˜å‚¨å·</h3><h4 id="6-3-1-PVå’ŒPVC"><a href="#6-3-1-PVå’ŒPVC" class="headerlink" title="6.3.1 PVå’ŒPVC"></a>6.3.1 PVå’ŒPVC</h4><p>PV å’Œ PVC æ˜¯ k8s æä¾›çš„ä¸¤ä¸ª api èµ„æºã€‚</p>
<p><strong>PV</strong></p>
<p>æŒä¹…å·ï¼ˆPersistentVolumeï¼ŒPVï¼‰æ˜¯é›†ç¾¤ä¸­çš„ä¸€å—å­˜å‚¨ï¼Œå¯ä»¥ç”±ç®¡ç†å‘˜äº‹å…ˆä¾›åº”ï¼Œæˆ–è€…ä½¿ç”¨<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">å­˜å‚¨ç±»</a>æ¥åŠ¨æ€ä¾›åº”ï¼ŒPV æ˜¯é›†ç¾¤èµ„æºï¼Œå’Œæ™®é€šçš„ Volume ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä½¿ç”¨å·æ’ä»¶æ¥å®ç°çš„ï¼Œåªæ˜¯å®ƒä»¬æ‹¥æœ‰ç‹¬ç«‹äºä»»ä½•ä½¿ç”¨ PV çš„ Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><img src="/2024/02/18/kubernetes/volume%E4%BA%94.png" alt="volumeäº”"></p>
<p><strong>PVC</strong></p>
<p>æŒä¹…å·ç”³é¢†ï¼ˆPersistentVolumeClaimï¼ŒPVCï¼‰è¡¨è¾¾çš„æ˜¯ç”¨æˆ·å¯¹å­˜å‚¨çš„è¯·æ±‚ã€‚æ¦‚å¿µä¸Šä¸ Pod ç±»ä¼¼ã€‚Pod ä¼šè€—ç”¨ Node èµ„æºï¼Œè€Œ PVC ç”³é¢†ä¼šè€—ç”¨ PV èµ„æºã€‚Pod å¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„èµ„æºï¼ˆCPU å’Œå†…å­˜ï¼‰ï¼ŒåŒæ · PVC ç”³é¢†ä¹Ÿå¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ã€‚</p>
<p><img src="/2024/02/18/kubernetes/volume%E5%85%AD.png" alt="volumeå…­"></p>
<p><strong>PV çš„ä¾›åº”æ–¹å¼æœ‰ä¸¤ç§ï¼š</strong></p>
<p><strong>é™æ€ä¾›åº”</strong></p>
<p>é›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºè‹¥å¹² PV å·ã€‚è¿™äº›å·å¯¹è±¡å¸¦æœ‰çœŸå®å­˜å‚¨çš„ç»†èŠ‚ä¿¡æ¯ï¼Œå¹¶ä¸”å¯¹é›†ç¾¤ç”¨æˆ·å¯ç”¨ï¼ˆå¯è§ï¼‰ã€‚PV å·å¯¹è±¡å­˜åœ¨äº Kubernetes API ä¸­ï¼Œå¯ä¾›ç”¨æˆ·æ¶ˆè´¹ï¼ˆä½¿ç”¨ï¼‰ã€‚</p>
<p><strong>åŠ¨æ€ä¾›åº”</strong></p>
<p>å¦‚æœç®¡ç†å‘˜æ‰€åˆ›å»ºçš„æ‰€æœ‰é™æ€ PV å·éƒ½æ— æ³•ä¸ç”¨æˆ·çš„ PersistentVolumeClaim åŒ¹é…ï¼Œ é›†ç¾¤å¯ä»¥å°è¯•ä¸ºè¯¥ PVC ç”³é¢†åŠ¨æ€ä¾›åº”ä¸€ä¸ªå­˜å‚¨å·ã€‚ è¿™ä¸€ä¾›åº”æ“ä½œæ˜¯åŸºäº StorageClass æ¥å®ç°çš„ï¼šPVC ç”³é¢†å¿…é¡»è¯·æ±‚æŸä¸ª <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">å­˜å‚¨ç±»</a>ï¼ŒåŒæ—¶é›†ç¾¤ç®¡ç†å‘˜å¿…é¡» å·²ç»åˆ›å»ºå¹¶é…ç½®äº†è¯¥ç±»ï¼Œè¿™æ ·åŠ¨æ€ä¾›åº”å·çš„åŠ¨ä½œæ‰ä¼šå‘ç”Ÿã€‚ å¦‚æœ PVC ç”³é¢†æŒ‡å®šå­˜å‚¨ç±»ä¸º <code>&quot;&quot;</code>ï¼Œåˆ™ç›¸å½“äºä¸ºè‡ªèº«ç¦æ­¢ä½¿ç”¨åŠ¨æ€ä¾›åº”çš„å·ã€‚</p>
<p>ä¸ºäº†åŸºäºå­˜å‚¨ç±»å®ŒæˆåŠ¨æ€çš„å­˜å‚¨ä¾›åº”ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦åœ¨ API æœåŠ¡å™¨ä¸Šå¯ç”¨ <code>DefaultStorageClass</code> <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#defaultstorageclass">å‡†å…¥æ§åˆ¶å™¨</a>ã€‚ ä¸¾ä¾‹è€Œè¨€ï¼Œå¯ä»¥é€šè¿‡ä¿è¯ <code>DefaultStorageClass</code> å‡ºç°åœ¨ API æœåŠ¡å™¨ç»„ä»¶çš„ <code>--enable-admission-plugins</code> æ ‡å¿—å€¼ä¸­å®ç°è¿™ç‚¹ï¼›è¯¥æ ‡å¿—çš„å€¼å¯ä»¥æ˜¯é€—å· åˆ†éš”çš„æœ‰åºåˆ—è¡¨ã€‚å…³äº API æœåŠ¡å™¨æ ‡å¿—çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver</a> æ–‡æ¡£ã€‚</p>
<p><strong>ç»‘å®š</strong></p>
<p>é€šä¿—ç†è§£å°±æ˜¯ä¸€æ—¦ PV ä¸ PVC è¿›è¡Œäº†ç»‘å®šï¼Œé‚£ä¹ˆè¯¥ PV å°±æ— æ³•ä¸å…¶å®ƒ PVC è¿›è¡Œç»‘å®šäº†ã€‚</p>
<p><strong>ä¿æŠ¤</strong></p>
<p>å½“ä¸€ä¸ª PV ä¸ PVC ç»‘å®šä¹‹åï¼Œå‡è®¾ Pod è¢«åˆ é™¤ï¼Œé‚£ä¹ˆè¯¥ PV ä¸ PVC ä¾æ—§ä¼šæ˜¯ä¸€ä¸ªç»‘å®šçš„å…³ç³»ã€‚</p>
<p><strong>æŒä¹…å·çš„ç±»å‹</strong></p>
<p>PV æŒä¹…å·æ˜¯ç”¨æ’ä»¶çš„å½¢å¼æ¥å®ç°çš„ã€‚Kubernetes ç›®å‰æ”¯æŒä»¥ä¸‹æ’ä»¶ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#awselasticblockstore"><code>awsElasticBlockStore</code></a> - AWS å¼¹æ€§å—å­˜å‚¨ï¼ˆEBSï¼‰</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#azuredisk"><code>azureDisk</code></a> - Azure Disk</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#azurefile"><code>azureFile</code></a> - Azure File</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#cephfs"><code>cephfs</code></a> - CephFS volume</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#csi"><code>csi</code></a> - å®¹å™¨å­˜å‚¨æ¥å£ (CSI)</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#fc"><code>fc</code></a> - Fibre Channel (FC) å­˜å‚¨</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#flexVolume"><code>flexVolume</code></a> - FlexVolume</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#flocker"><code>flocker</code></a> - Flocker å­˜å‚¨</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#gcepersistentdisk"><code>gcePersistentDisk</code></a> - GCE æŒä¹…åŒ–ç›˜</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#glusterfs"><code>glusterfs</code></a> - Glusterfs å·</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath"><code>hostPath</code></a> - HostPath å· ï¼ˆä»…ä¾›å•èŠ‚ç‚¹æµ‹è¯•ä½¿ç”¨ï¼›ä¸é€‚ç”¨äºå¤šèŠ‚ç‚¹é›†ç¾¤ï¼› è¯·å°è¯•ä½¿ç”¨ <code>local</code> å·ä½œä¸ºæ›¿ä»£ï¼‰</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#iscsi"><code>iscsi</code></a> - iSCSI (SCSI over IP) å­˜å‚¨</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local"><code>local</code></a> - èŠ‚ç‚¹ä¸ŠæŒ‚è½½çš„æœ¬åœ°å­˜å‚¨è®¾å¤‡</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#nfs"><code>nfs</code></a> - ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ (NFS) å­˜å‚¨</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#portworxvolume"><code>portworxVolume</code></a> - Portworx å·</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#quobyte"><code>quobyte</code></a> - Quobyte å·</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#rbd"><code>rbd</code></a> - Rados å—è®¾å¤‡ (RBD) å·</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#storageos"><code>storageos</code></a> - StorageOS å·</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#vspherevolume"><code>vsphereVolume</code></a> - vSphere VMDK å·</li>
</ul>
<p><strong>è®¿é—®æ¨¡å¼</strong></p>
<p>PV å·å¯ä»¥ç”¨èµ„æºæä¾›è€…æ‰€æ”¯æŒçš„ä»»ä½•æ–¹å¼æŒ‚è½½åˆ°å®¿ä¸»ç³»ç»Ÿä¸Šã€‚ å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œæä¾›è€…ï¼ˆé©±åŠ¨ï¼‰çš„èƒ½åŠ›ä¸åŒï¼Œæ¯ä¸ª PV å·çš„è®¿é—®æ¨¡å¼éƒ½ä¼šè®¾ç½®ä¸º å¯¹åº”å·æ‰€æ”¯æŒçš„æ¨¡å¼å€¼ã€‚ ä¾‹å¦‚ï¼ŒNFS å¯ä»¥æ”¯æŒå¤šä¸ªè¯»å†™å®¢æˆ·ï¼Œä½†æ˜¯æŸä¸ªç‰¹å®šçš„ NFS PV å·å¯èƒ½åœ¨æœåŠ¡å™¨ ä¸Šä»¥åªè¯»çš„æ–¹å¼å¯¼å‡ºã€‚æ¯ä¸ª PV å·éƒ½ä¼šè·å¾—è‡ªèº«çš„è®¿é—®æ¨¡å¼é›†åˆï¼Œæè¿°çš„æ˜¯ ç‰¹å®š PV å·çš„èƒ½åŠ›ã€‚</p>
<p>è®¿é—®æ¨¡å¼æœ‰ï¼š</p>
<ul>
<li>ReadWriteOnceï¼šå·å¯ä»¥è¢«ä¸€ä¸ªèŠ‚ç‚¹ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ï¼›</li>
<li>ReadOnlyManyï¼šå·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥åªè¯»æ–¹å¼æŒ‚è½½ï¼›</li>
<li>ReadWriteManyï¼šå·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ã€‚</li>
</ul>
<p>å¯¹äºä¸åŒç±»å‹çš„å­˜å‚¨å·è®¿é—®æ¨¡å¼ä¹Ÿæœ‰ä¸åŒï¼Œå¦‚ä¸‹è¡¨</p>
<table>
<thead>
<tr>
<th align="left">å·æ’ä»¶</th>
<th align="center">ReadWriteOnce</th>
<th align="center">ReadOnlyMany</th>
<th align="center">ReadWriteMany</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AWSElasticBlockStore</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">AzureFile</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
</tr>
<tr>
<td align="left">AzureDisk</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">CephFS</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
</tr>
<tr>
<td align="left">Cinder</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">CSI</td>
<td align="center">å–å†³äºé©±åŠ¨</td>
<td align="center">å–å†³äºé©±åŠ¨</td>
<td align="center">å–å†³äºé©±åŠ¨</td>
</tr>
<tr>
<td align="left">FC</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">FlexVolume</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">å–å†³äºé©±åŠ¨</td>
</tr>
<tr>
<td align="left">Flocker</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">GCEPersistentDisk</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">Glusterfs</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
</tr>
<tr>
<td align="left">HostPath</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">iSCSI</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">Quobyte</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
</tr>
<tr>
<td align="left">NFS</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
</tr>
<tr>
<td align="left">RBD</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">VsphereVolume</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">- (Pod è¿è¡ŒäºåŒä¸€èŠ‚ç‚¹ä¸Šæ—¶å¯è¡Œ)</td>
</tr>
<tr>
<td align="left">PortworxVolume</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">âœ“</td>
</tr>
<tr>
<td align="left">ScaleIO</td>
<td align="center">âœ“</td>
<td align="center">âœ“</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">StorageOS</td>
<td align="center">âœ“</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<p><strong>ç±»</strong></p>
<p>æ¯ä¸ª PV å¯ä»¥å±äºæŸä¸ªç±»ï¼ˆClassï¼‰ï¼Œé€šè¿‡å°†å…¶ <code>storageClassName</code> å±æ€§è®¾ç½®ä¸ºæŸä¸ª <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">StorageClass</a> çš„åç§°æ¥æŒ‡å®šã€‚ ç‰¹å®šç±»çš„ PV å·åªèƒ½ç»‘å®šåˆ°è¯·æ±‚è¯¥ç±»å­˜å‚¨å·çš„ PVC ç”³é¢†ã€‚ æœªè®¾ç½® <code>storageClassName</code> çš„ PV å·æ²¡æœ‰ç±»è®¾å®šï¼Œåªèƒ½ç»‘å®šåˆ°é‚£äº›æ²¡æœ‰æŒ‡å®šç‰¹å®šå­˜å‚¨ç±»çš„ PVC ç”³é¢†ã€‚</p>
<p><strong>å›æ”¶ç­–ç•¥</strong></p>
<p>ç›®å‰çš„å›æ”¶ç­–ç•¥æœ‰ï¼š</p>
<ul>
<li>Retainï¼ˆä¿ç•™ï¼‰ â€“ æ‰‹åŠ¨å›æ”¶</li>
<li>Recycleï¼ˆå›æ”¶ï¼‰â€“ åŸºæœ¬æ“¦é™¤ (<code>rm -rf /thevolume/*</code>)</li>
<li>Deleteï¼ˆåˆ é™¤ï¼‰â€“ è¯¸å¦‚ AWS EBSã€GCE PDã€Azure Disk æˆ– OpenStack Cinder å·è¿™ç±»å…³è”å­˜å‚¨èµ„äº§ä¹Ÿè¢«åˆ é™¤</li>
</ul>
<p>ç›®å‰ï¼Œä»… NFS å’Œ HostPath æ”¯æŒå›æ”¶ï¼ˆRecycleï¼‰ã€‚ AWS EBSã€GCE PDã€Azure Disk å’Œ Cinder å·éƒ½æ”¯æŒåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</p>
<p><strong>é˜¶æ®µï¼ˆçŠ¶æ€ï¼‰</strong></p>
<p>æ¯ä¸ªå·ä¼šå¤„äºä»¥ä¸‹é˜¶æ®µï¼ˆPhaseï¼‰ä¹‹ä¸€ï¼š</p>
<ul>
<li>Availableï¼ˆå¯ç”¨ï¼‰â€“ å·æ˜¯ä¸€ä¸ªç©ºé—²èµ„æºï¼Œå°šæœªç»‘å®šåˆ°ä»»ä½•ç”³é¢†ï¼›</li>
<li>Boundï¼ˆå·²ç»‘å®šï¼‰â€“ è¯¥å·å·²ç»ç»‘å®šåˆ°æŸç”³é¢†ï¼›</li>
<li>Releasedï¼ˆå·²é‡Šæ”¾ï¼‰â€“ æ‰€ç»‘å®šçš„ç”³é¢†å·²è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºå°šæœªè¢«é›†ç¾¤å›æ”¶ï¼›</li>
<li>Failedï¼ˆå¤±è´¥ï¼‰â€“ å·çš„è‡ªåŠ¨å›æ”¶æ“ä½œå¤±è´¥ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<p>è¿™ä¸ªå®ä¾‹æ˜¯å…ˆååˆ›å»º PVã€PVCã€Deployment</p>
<ol>
<li>åˆ›å»º PV</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º PVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ›å»º Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-deployment-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-deployment-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">test-pvc</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹äºŒ</strong></p>
<p>è¿™ä¸ªå®ä¾‹ä¼šç”± StatefulSet è‡ªåŠ¨åˆ›å»º PVC</p>
<p><img src="/2024/02/18/kubernetes/%E6%8C%81%E4%B9%85%E5%AD%98%E5%82%A8%E5%8D%B7%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="æŒä¹…å­˜å‚¨å·ç¤ºä¾‹å›¾"></p>
<ol>
<li>éƒ¨ç½² NFS æœåŠ¡å™¨ï¼Œå¹¶åœ¨æ¯ä¸ªèŠ‚ç‚¹å®‰è£…<code>nfs-utils</code></li>
<li>éƒ¨ç½² PVï¼Œè¿™é‡Œåˆ›å»ºäº†å››ä¸ª PV</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># PVå®¹é‡å¤§å°</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="comment"># æœåŠ¡æ¨¡å¼ä¸ºRWOï¼Œå·å¯ä»¥è¢«ä¸€ä¸ªèŠ‚ç‚¹ä»¥è¯»å†™æ–¹å¼æŒ‚è½½</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="comment"># å›æ”¶ç­–ç•¥ä¸ºRetainï¼Œå³æ‰‹åŠ¨å›æ”¶</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="comment"># ç±»ä¸ºnfs</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="comment"># åˆ¶å®šnfsæœåŠ¡å™¨åœ°å€å’Œè¢«æŒ‚è½½ç›®å½•</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadOnlyMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">slow-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/slow</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/volume%E4%B8%83.png" alt="volumeä¸ƒ"></p>
<ol start="2">
<li>åˆ›å»ºæ— å¤´ SVCã€StatefulSet</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-svc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># ä¸åˆ†é…ipåœ°å€ï¼Œä¸ºStatefulSetä½¿ç”¨</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="comment"># åŒ¹é…æ ‡ç­¾</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># åŒ¹é…æ ‡ç­¾</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nfs-pv-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-pv-pod</span></span><br><span class="line">      <span class="comment"># podæ ‡ç­¾</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pv-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># æŒ‚è½½æŒä¹…å·</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pv-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="comment"># PVCæ¨¡æ¿</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-pv-volume</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># åŒ¹é…è§„åˆ™</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&#x27;ReadWriteOnce&#x27;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å…ˆååˆ›å»ºåæŸ¥çœ‹ Pod åˆ›å»ºæƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°åªåˆ›å»ºäº†ä¸€ä¸ª Podï¼Œå› ä¸ºç°æœ‰çš„ PV åªæœ‰ä¸€ä¸ªç¬¦åˆåŒ¹é…æ¡ä»¶ï¼Œè€Œ StatefulSet æ˜¯å‰ä¸€ä¸ª Pod åˆ›å»ºæˆåŠŸæ‰ä¼šåˆ›å»ºä¸‹ä¸€ä¸ªï¼Œå› ä¸ºç¬¬äºŒä¸ª Pod åˆ›å»ºä¸æˆåŠŸï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ª Pod ä¸ä¼šè¢«åˆ›å»º</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%85%AB.png" alt="volumeå…«"></p>
<ol start="4">
<li>è¿›å…¥å®¹å™¨å†…éƒ¨å¯ä»¥çœ‹åˆ°æŒ‚è½½æˆåŠŸï¼Œå»åˆ° NFS æœåŠ¡å™¨çš„<code>/nfs1</code>ç›®å½•ä¸‹åˆ›å»º<code>test.html</code>æ–‡ä»¶æµ‹è¯•æˆåŠŸ</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E4%B9%9D.png" alt="volumeä¹"></p>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81.png" alt="volumeå"></p>
<ol start="5">
<li>åˆ é™¤åˆ›å»ºå¤±è´¥çš„ Pod ä»¥åŠå¯¹åº”çš„ PVCï¼Œåˆ›å»ºæ–°çš„ä¸¤ä¸ª PVï¼Œä»¥æ»¡è¶³ StatefulSet çš„æŒ‚è½½è¦æ±‚ï¼Œå‰©ä¸‹çš„ Pod å°±ä¼šé€ä¸€åˆ›å»ºæˆåŠŸ</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%80.png" alt="volumeåä¸€"></p>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%BA%8C.png" alt="volumeåäºŒ"></p>
<ol start="6">
<li>åˆ é™¤ä¸Šé¢æµ‹è¯•çš„ Podï¼ŒStatefulSet ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ª Podï¼Œä¸”æ•°æ®ä¸ä¼šä¸¢å¤±</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%89.png" alt="volumeåä¸‰"></p>
<p>è¿™é‡Œä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœåˆ é™¤äº† StatefulSetï¼Œé‚£ä¹ˆå¯¹åº”çš„ Pod ä¹Ÿä¼šè¢«åˆ é™¤ï¼Œå¯æ˜¯å·²ç»ç»‘å®šçš„ PV å¹¶ä¸ä¼šåˆ é™¤ï¼Œè¿™é‡Œå°±éœ€è¦æ‰‹åŠ¨å›æ”¶äº†ã€‚</p>
<p><strong>æ‰‹åŠ¨å›æ”¶</strong></p>
<ul>
<li><p>åˆ é™¤ StatefulSet</p>
</li>
<li><p>åˆ é™¤ PVC</p>
</li>
<li><p>ä¿®æ”¹ PV</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit pv pvåç§°</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ClaimRefçš„ä¿¡æ¯</span></span><br><span class="line">ClainRef:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="6-3-2-StorageClass"><a href="#6-3-2-StorageClass" class="headerlink" title="6.3.2 StorageClass"></a>6.3.2 StorageClass</h4><p>ä»¥ä¸Šçš„æ–¹æ³•éƒ½æ˜¯é™æ€åˆ›å»ºçš„ PVï¼Œä¼šå‡ºç° PVC æ‰¾ä¸åˆ°æ¡ä»¶ç¬¦åˆçš„ PV è¿›è¡Œç»‘å®šã€‚</p>
<p>è€Œ StorageClass çš„ä½œç”¨æ˜¯æ ¹æ® PVC çš„éœ€æ±‚åŠ¨æ€åˆ›å»º PVã€‚</p>
<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<p><img src="/2024/02/18/kubernetes/NFS%E5%AD%98%E5%82%A8%E5%88%86%E9%85%8D%E5%99%A8%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="NFSå­˜å‚¨åˆ†é…å™¨ç¤ºä¾‹å›¾"></p>
<ol>
<li>k8s åœ¨ 1.20 ç‰ˆæœ¬å¼€å§‹å°±ç¦ç”¨äº† selfLinkï¼Œæ‰€ä»¥éœ€åœ¨é…ç½®æ–‡ä»¶æ·»åŠ ä»¥ä¸‹å†…å®¹</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E5%9B%9B.png" alt="volumeåå››"></p>
<ol start="2">
<li>StorageClass æ˜¯é€šè¿‡å­˜å‚¨åˆ†é…å™¨æ¥åŠ¨æ€åˆ›å»º PV çš„ï¼Œä½† k8s å†…éƒ¨çš„å­˜å‚¨åˆ†é…å™¨ä¸æ”¯æŒ NFSï¼Œæ‰€ä»¥é¦–å…ˆè¦å®‰è£… NFS å­˜å‚¨åˆ†é…å™¨</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="comment"># è®¾ç½®å‡çº§ç­–ç•¥ä¸ºåˆ é™¤å†åˆ›å»º(é»˜è®¤ä¸ºæ»šåŠ¨æ›´æ–°)</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nfs-provision</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="comment"># nfså­˜å‚¨åˆ†é…å™¨åç§°</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">nfs-client</span></span><br><span class="line">            <span class="comment"># nfsæœåŠ¡å™¨åœ°å€</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">            <span class="comment"># nfså…±äº«ç›®å½•</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç»™ NFS å­˜å‚¨åˆ†é…å™¨æˆæƒ</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner_rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>åˆ›å»º StorageClass</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_storageclass.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># storageclassåç§°</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storageclass</span></span><br><span class="line"><span class="comment"># nfså­˜å‚¨åˆ†é…å™¨åç§°</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">nfs-client</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># è¡¨ç¤ºpvcåˆ é™¤æ—¶ï¼Œæ‰€ç»‘å®šçš„pvä¸ä¼šè¢«ä¿ç•™ï¼Œtrueç›¸å</span></span><br><span class="line">  <span class="attr">archieveOnDelete:</span> <span class="string">&#x27;false&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>åˆ›å»º PVCï¼Œå¯ä»¥çœ‹åˆ° NFS å­˜å‚¨åˆ†é…å™¨å·²ç»è‡ªåŠ¨åˆ›å»ºäº† PV ä¸ä¹‹ç»‘å®š</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_storageclass_pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="comment"># storageclassåç§°</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs-client&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%BA%94.png" alt="volumeåäº”"></p>
<ol start="6">
<li>åˆ›å»ºä¸€ä¸ª Deployment æµ‹è¯•æ˜¯å¦èƒ½ç”¨è¿™ä¸ª PVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-provisioner-deployment-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/test</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nfs-storageclass-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>åœ¨ NFS æœåŠ¡å™¨çš„å…±äº«ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª test.html</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E5%85%AD.png" alt="volumeåå…­"></p>
<ol start="8">
<li>è®¿é—® Deployment åˆ›å»ºå‡ºæ¥çš„ Podï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å¯ä»¥è®¿é—®çš„</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%83.png" alt="volumeåä¸ƒ"></p>
<h3 id="6-4-StatefulSet"><a href="#6-4-StatefulSet" class="headerlink" title="6.4 StatefulSet"></a>6.4 StatefulSet</h3><p>StatefulSet æ˜¯ä¸€ç§æä¾›æ’åºå’Œå”¯ä¸€æ€§ä¿è¯çš„ç‰¹æ®Š Pod æ§åˆ¶å™¨ï¼Œå½“æœ‰éƒ¨ç½²é¡ºåºã€æŒä¹…æ•°æ®æˆ–å›ºå®šç½‘ç»œç­‰ç›¸å…³çš„ç‰¹æ®Šéœ€æ±‚æ—¶ï¼Œå¯ä»¥ç”¨ StatefulSet æ§åˆ¶å™¨æ¥è¿›è¡Œæ§åˆ¶ã€‚</p>
<p>StatefulSet æä¾›æœ‰çŠ¶æ€æœåŠ¡ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®ç°ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼šé€šè¿‡ PVC æ¥å®ç°ï¼ŒPod ä¹‹é—´ä¸èƒ½å…±ç”¨ä¸€ä¸ªå­˜å‚¨å·ï¼Œæ¯ä¸ª Pod éƒ½è¦æœ‰ä¸€ä¸ªè‡ªå·±ä¸“ç”¨çš„å­˜å‚¨å·ã€‚</li>
<li>å®ç°ç¨³å®šçš„ç½‘ç»œæ ‡è¯†ï¼šPod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ï¼Œé€šè¿‡æ— å¤´ SVC æ¥å®ç°ã€‚</li>
<li>å®ç°æœ‰åºéƒ¨ç½²ã€æœ‰åºä¼¸ç¼©ï¼šPod æ˜¯æœ‰é¡ºåºçš„ï¼Œåªæœ‰å‰ä¸€ä¸ª Pod åˆ›å»ºæˆåŠŸæ‰ä¼šåˆ›å»ºä¸‹ä¸€ä¸ªï¼Œç›´åˆ°æœ€åã€‚</li>
<li>å®ç°æœ‰åºæ”¶ç¼©ã€æœ‰åºåˆ é™¤ï¼šä»æœ€åä¸€ä¸ªå¼€å§‹ï¼Œä¾æ¬¡åˆ é™¤åˆ°ç¬¬ä¸€ä¸ªã€‚</li>
<li>æ— å¤´ SVC ï¼šä¸º Pod ç”Ÿæˆå¯ä»¥è§£æçš„ DNS è®°å½•ã€‚</li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%B8%80.png" alt="statefulsetä¸€"></p>
<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<ol>
<li>åˆ›å»ºæ— å¤´ SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">statefulset_nginx_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-nginx-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º StatefulSet</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">statefulset_nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># åŒ¹é…æ— å¤´SVC</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">statefulset-nginx-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">statefulset-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># PVCæ¨¡æ¿</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">statefulset-nginx-pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&#x27;ReadWriteOnce&#x27;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs-storageclass&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">50Mi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯ä»¥çœ‹åˆ° Pod æ˜¯æœ‰åºåˆ›å»ºçš„ï¼Œä¸”æ¯ä¸ª Pod éƒ½æ˜¯å•ç‹¬ä½¿ç”¨ä¸€ä¸ª PVC å’Œ PVï¼Œåˆ é™¤ StatefulSet ä¹Ÿå¯ä»¥çœ‹åˆ° Pod æ˜¯æœ‰åºåˆ é™¤çš„ï¼Œä¸”åˆ é™¤å PVC ä¸ PV ä¾æ—§å­˜åœ¨ï¼Œé‡æ–°ç”Ÿæˆ StatefulSet å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™äº› PVC å’Œ PV</li>
</ol>
<p><strong>æœ‰åºåˆ›å»º</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%BA%8C.png" alt="statefulsetäºŒ"></p>
<p><strong>PVC ä¸ PV</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%B8%89.png" alt="statefulsetä¸‰"></p>
<p><strong>æœ‰åºåˆ é™¤</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E5%9B%9B.png" alt="statefulsetå››"></p>
<ol start="4">
<li>åˆ›å»ºä¸€ä¸ª Pod ç”¨æ¥æµ‹è¯•æ— å¤´ SVC æä¾›çš„ DNS æœåŠ¡</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;this is test&quot;; sleep 36000&#x27;</span> ]</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>è¿›å…¥ Pod åå¯ä»¥é€šè¿‡<code>nslookup</code>æµ‹è¯•ï¼Œå½¢å¼ä¸º<code>&#123;ServiceName&#125;.&#123;NameSpace&#125;.svc.&#123;ClusterDomain&#125;</code></li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%BA%94.png" alt="statefulsetäº”"></p>
<ol start="6">
<li>é€šè¿‡åŸŸåä¹Ÿå¯ä»¥è®¿é—®å„ä¸ª Podï¼Œå½¢å¼ä¸º<code>&#123;PodName&#125;&#123;ServiceName&#125;.&#123;NameSpace&#125;.svc.&#123;ClusterDomain&#125;</code></li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E5%85%AD.png" alt="statefulsetå…­"></p>
<h2 id="ä¸ƒã€k8sè°ƒåº¦å™¨"><a href="#ä¸ƒã€k8sè°ƒåº¦å™¨" class="headerlink" title="ä¸ƒã€k8sè°ƒåº¦å™¨"></a>ä¸ƒã€k8sè°ƒåº¦å™¨</h2><p>scheduler æ˜¯ k8s é›†ç¾¤çš„è°ƒåº¦å™¨ï¼Œå¯¹æ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ Pod æˆ–è€…æ˜¯æœªè¢«è°ƒåº¦çš„ Podï¼Œscheduler ä¼šé€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„ Node å»è¿è¡Œè¿™ä¸ª Podã€‚ç„¶è€Œï¼ŒPod å†…çš„æ¯ä¸€ä¸ªå®¹å™¨å¯¹èµ„æºéƒ½æœ‰ä¸åŒçš„éœ€æ±‚ï¼Œè€Œä¸” Pod æœ¬èº«ä¹Ÿæœ‰ä¸åŒçš„èµ„æºéœ€æ±‚ã€‚å› æ­¤ï¼ŒPod åœ¨è¢«è°ƒåº¦åˆ° Node ä¸Šä¹‹å‰ï¼Œ æ ¹æ®è¿™äº›ç‰¹å®šçš„èµ„æºè°ƒåº¦éœ€æ±‚ï¼Œéœ€è¦å¯¹é›†ç¾¤ä¸­çš„ Node è¿›è¡Œä¸€æ¬¡è¿‡æ»¤ã€‚</p>
<p>åœ¨åšè°ƒåº¦å†³å®šæ—¶éœ€è¦è€ƒè™‘çš„å› ç´ åŒ…æ‹¬ï¼šå•ç‹¬å’Œæ•´ä½“çš„èµ„æºè¯·æ±‚ã€ç¡¬ä»¶&#x2F;è½¯ä»¶&#x2F;ç­–ç•¥é™åˆ¶ã€ äº²å’Œä»¥åŠåäº²å’Œè¦æ±‚ã€æ•°æ®å±€åŸŸæ€§ã€è´Ÿè½½é—´çš„å¹²æ‰°ç­‰ç­‰ã€‚</p>
<p><strong>è°ƒåº¦æµç¨‹ï¼š</strong></p>
<ul>
<li>è¿‡æ»¤ï¼šè°ƒåº¦å™¨ä¼šå°†æ‰€æœ‰æ»¡è¶³ Pod è°ƒåº¦éœ€æ±‚çš„ Node é€‰å‡ºæ¥ã€‚</li>
<li>æ‰“åˆ†ï¼šè°ƒåº¦å™¨ä¼šä¸º Pod ä»æ‰€æœ‰å¯è°ƒåº¦èŠ‚ç‚¹ä¸­é€‰å–ä¸€ä¸ªæœ€åˆé€‚çš„ Nodeã€‚</li>
</ul>
<h3 id="7-1-äº²å’Œæ€§ä¸åäº²å’Œæ€§"><a href="#7-1-äº²å’Œæ€§ä¸åäº²å’Œæ€§" class="headerlink" title="7.1 äº²å’Œæ€§ä¸åäº²å’Œæ€§"></a>7.1 äº²å’Œæ€§ä¸åäº²å’Œæ€§</h3><h4 id="7-1-1-Nodeäº²å’Œæ€§"><a href="#7-1-1-Nodeäº²å’Œæ€§" class="headerlink" title="7.1.1 Nodeäº²å’Œæ€§"></a>7.1.1 Nodeäº²å’Œæ€§</h4><p>èŠ‚ç‚¹äº²å’Œæ€§æ˜¯é€šè¿‡<code>pod.spec.nodeAffinity</code>æ¥å®ç°çš„ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯ç­–ç•¥</li>
<li>requiredDuringSchedulingIgnoredDuringExecutionï¼šç¡¬ç­–ç•¥</li>
</ul>
<p><strong>requiredDuringSchedulingIgnoredDuringExecutionç¡¬ç­–ç•¥</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-required-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-required-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># äº²å’Œæ€§è®¾ç½®</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="comment"># èŠ‚ç‚¹äº²å’Œæ€§è®¾ç½®</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="comment"># èŠ‚ç‚¹é€‰æ‹©å™¨</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="comment"># åŒ¹é…è¡¨è¾¾å¼</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="comment"># åˆ¶å®škeyï¼Œå³ä»¥è¿™ä¸ªkeyçš„é”®å€¼ä¸ºåŒ¹é…æ¡ä»¶</span></span><br><span class="line">          <span class="comment"># é€šè¿‡kubectl get node --show-labelså¯ä»¥è·å¾—æ›´å¤šæ ‡ç­¾</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="comment"># In:labelçš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="comment"># NotIn:labelçš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="comment"># Gt:labelçš„å€¼å¤§äºæŸä¸ªå€¼</span></span><br><span class="line">            <span class="comment"># Lt:labelçš„å€¼å°äºæŸä¸ªå€¼</span></span><br><span class="line">            <span class="comment"># Exists:æŸä¸ªlabelå­˜åœ¨</span></span><br><span class="line">            <span class="comment"># DoesNotExist:æŸä¸ªlabelä¸å­˜åœ¨</span></span><br><span class="line">            <span class="comment"># è¿™é‡Œè®¾ç½®çš„æ„æ€æ˜¯ï¼Œæ ¹æ®kubernetes.io/hostnameçš„é”®å€¼ï¼Œæ°¸è¿œä¸åˆ†é…åˆ°é”®å€¼ä¸ºk8s-node01çš„èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node01</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºåå¯ä»¥çœ‹åˆ° Pod ä¸ä¼šè¢«åˆ›å»ºåœ¨ k8s-node01 èŠ‚ç‚¹ä¸Š<img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%80.png" alt="Nodeäº²å’Œæ€§ä¸€"></p>
<p><strong>preferredDuringSchedulingIgnoredDuringExecutionè½¯ç­–ç•¥</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-preferred-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-preferred-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="comment"># è½¯ç­–ç•¥</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="comment"># æƒé‡ï¼ŒèŒƒå›´ä¸º1-100</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># åå‘äº</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="comment"># åŒ¹é…è¡¨è¾¾å¼</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node03</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è™½ç„¶è¦æ±‚éƒ¨ç½²åˆ° k8s-node03 èŠ‚ç‚¹ä¸Šï¼Œä½†ç”±äºæœ¬ç¯å¢ƒæ²¡æœ‰è¯¥èŠ‚ç‚¹ï¼Œæ‰€ä»¥å°±è¢«åˆ†é…åˆ°å…¶å®ƒçš„èŠ‚ç‚¹äº†</p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BA%8C.png" alt="Nodeäº²å’Œæ€§äºŒ"></p>
<p><strong>è½¯ç¡¬åˆä½“ç‰ˆ</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-preandreq-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-preandreq-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">cpu</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">4core</span>] &#125;</span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">disktype</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">ssd</span>] &#125;</span><br></pre></td></tr></table></figure>

<p>è½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ä¸€èµ·ä½¿ç”¨å°±ä¼šå…ˆæ»¡è¶³ç¡¬ç­–ç•¥å†åˆ†æè½¯ç­–ç•¥ï¼Œå¯ä»¥çœ‹åˆ°ç°æœ‰çš„èŠ‚ç‚¹æ²¡æœ‰å¯ä»¥æ»¡è¶³ä»¥ä¸Šæ¡ä»¶çš„ï¼Œæ‰€ä»¥ Pod ä¸€ç›´å¤„äº Pending çŠ¶æ€</p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%89.png" alt="Nodeäº²å’Œæ€§ä¸‰"></p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E5%9B%9B.png" alt="Nodeäº²å’Œæ€§å››"></p>
<h4 id="7-1-2-Podäº²å’Œæ€§"><a href="#7-1-2-Podäº²å’Œæ€§" class="headerlink" title="7.1.2 Podäº²å’Œæ€§"></a>7.1.2 Podäº²å’Œæ€§</h4><p>æœ‰æ—¶å€™éœ€è¦å°†æŸäº› Pod ä¸æ­£åœ¨è¿è¡Œçš„å·²å…·æœ‰æŸäº›ç‰¹è´¨çš„ Pod è°ƒåº¦åˆ°ä¸€èµ·ï¼Œå› æ­¤å°±éœ€è¦ Pod äº²å’Œæ€§è°ƒåº¦æ–¹å¼ã€‚</p>
<p>Pod äº²å’Œæ€§æ˜¯é€šè¿‡<code>spec.affinity.podAffinity/podAntiAffinity</code>æ¥å®ç°çš„ï¼Œå‰è€…ä¸º<strong>äº²å’Œæ€§</strong>ï¼Œåè€…ä¸º<strong>åäº²å’Œæ€§</strong>ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯ç­–ç•¥</li>
<li>requiredDuringSchedulingIgnoredDuringExecutionï¼šç¡¬ç­–ç•¥</li>
</ul>
<p><strong>requiredDuringSchedulingIgnoredDuringExecutionç¡¬ç­–ç•¥</strong></p>
<ol>
<li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ ‡ç­¾ä¸º<code>app:nginx</code>çš„ Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod-container-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºç¡¬ç­–ç•¥äº²å’Œæ€§ Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-required</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-required-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># äº²å’Œæ€§è®¾ç½®</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="comment"># Podäº²å’Œæ€§è®¾ç½®</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="comment"># æ ‡ç­¾é€‰æ‹©å™¨</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="comment"># åˆ—å‡ºè§„åˆ™</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="comment"># ç”„é€‰appè¿™ä¸ªæ ‡ç­¾</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="comment"># In:labelçš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="comment"># NotIn:labelçš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="comment"># Exists:æŸä¸ªlabelå­˜åœ¨</span></span><br><span class="line">            <span class="comment"># DoesNotExist:æŸä¸ªlabelä¸å­˜åœ¨</span></span><br><span class="line">            <span class="comment"># è¡¨ç¤ºç¡¬æ€§åŒ¹é…æ ‡ç­¾ä¸ºapp=nginxçš„è¿™ä¸ªPod</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="comment"># é”®å€¼</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="comment"># åˆ†é…åˆ°ä¸è¿™ä¸ªPodæ‰€å±çš„èŠ‚ç‚¹kubernetes.io/hostnameå€¼ç›¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºåˆ†é…åˆ°åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œä½†å¯èƒ½æœ‰å¤šä¸ª</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¼šåˆ†é…åœ¨åŒä¸€èŠ‚ç‚¹ä¸Š</p>
<p><img src="/2024/02/18/kubernetes/Pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%80.png" alt="Podäº²å’Œæ€§ä¸€"></p>
<ol start="3">
<li>åˆ é™¤è¯¥ Podï¼Œå°†<code>podAffinity</code>æ”¹ä¸º<code>podAntiAffinity</code>ï¼Œå°†ä¸ä¼šåˆ†é…åˆ°ä¸€èµ·</li>
</ol>
<p><img src="/2024/02/18/kubernetes/Pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BA%8C.png" alt="Podäº²å’Œæ€§äºŒ"></p>
<h3 id="7-2-æ±¡ç‚¹å’Œå®¹å¿åº¦"><a href="#7-2-æ±¡ç‚¹å’Œå®¹å¿åº¦" class="headerlink" title="7.2 æ±¡ç‚¹å’Œå®¹å¿åº¦"></a>7.2 æ±¡ç‚¹å’Œå®¹å¿åº¦</h3><p>æ±¡ç‚¹ï¼ˆtaintï¼‰è¡¨ç¤ºä¸€ä¸ªèŠ‚ç‚¹ä¸Šå­˜åœ¨ä¸è‰¯çŠ¶å†µï¼Œæ±¡ç‚¹ä¼šå½±å“ Pod çš„è°ƒåº¦ï¼Œå…¶å®šä¹‰æ–¹å¼å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node &#123;èŠ‚ç‚¹åç§°&#125; &#123;æ±¡ç‚¹åç§°&#125;=&#123;æ±¡ç‚¹å€¼&#125;:&#123;æ±¡ç‚¹çš„å½±å“&#125;</span><br></pre></td></tr></table></figure>

<p>æ±¡ç‚¹çš„å½±å“æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>NoExecuteï¼šä¸å°† Pod è°ƒåº¦åˆ°å…·å¤‡è¯¥æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœ Pod å·²ç»åœ¨è¯¥èŠ‚ç‚¹è¿è¡Œï¼Œåˆ™ä¼šè¢«é©±é€ã€‚</li>
<li>NoScheduleï¼šä¸å°† Pod è°ƒåº¦åˆ°å…·å¤‡è¯¥æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœ Pod å·²ç»åœ¨è¯¥èŠ‚ç‚¹è¿è¡Œï¼Œä¸ä¼šè¢«é©±é€ã€‚</li>
<li>PreferNoScheduleï¼šä¸æ¨èå°† Pod è°ƒåº¦åˆ°å…·å¤‡è¯¥æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚</li>
</ul>
<p><strong>æ·»åŠ æ±¡ç‚¹</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E4%B8%80.png" alt="æ±¡ç‚¹å’Œå®¹å¿ä¸€"></p>
<p><strong>åˆ é™¤æ±¡ç‚¹</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute-</span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<ol>
<li>ç»™ k8s-node01 æ‰“ä¸Šæ±¡ç‚¹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»º Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">toleration-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">toleration-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># æ·»åŠ èŠ‚ç‚¹äº²å’Œæ€§ç¡¬ç­–ç•¥ï¼Œè®©è¯¥Podè°ƒåº¦åˆ°k8s-node01ä¸Š</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node01</span></span><br><span class="line">  <span class="comment"># å®¹å¿è®¾ç½®</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="comment"># å®¹å¿æ±¡ç‚¹</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;cpu&quot;</span></span><br><span class="line">    <span class="comment"># Equal:æŒ‡ç­‰äºè¯¥å€¼</span></span><br><span class="line">    <span class="comment"># Exist:æŒ‡æœ‰è¯¥keyå°±å¯ï¼Œå€¼æ— æ‰€è°“</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="comment"># æ±¡ç‚¹å½±å“</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">    <span class="comment"># å®¹å¿æ—¶é—´ï¼Œè¶…è¿‡è¯¥äº‹ä»¶å°±ä¼šè¢«é©±é™¤ï¼Œåªæœ‰æ±¡ç‚¹å½±å“è®¾ç½®ä¸ºNoExecuteæ‰å¯ç”¨</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">36</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¯¥ Pod ä¾æ—§å¯ä»¥è°ƒåº¦åˆ° k8s-node01 èŠ‚ç‚¹ä¸Šï¼Œä½†è¶…è¿‡ 3600 ç§’åå°±è¢«é©±é™¤äº†</p>
<p><img src="/2024/02/18/kubernetes/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E4%BA%8C.png" alt="æ±¡ç‚¹å’Œå®¹å¿äºŒ"></p>
<p>å®¹å¿åº¦è®¾ç½®ä¸€èˆ¬ç”¨äº DaemonSet æ§åˆ¶å™¨ï¼Œå› ä¸º DaemonSet æ§åˆ¶å™¨ä¸‹çš„åº”ç”¨ä¸€èˆ¬æ˜¯ä¸ºèŠ‚ç‚¹æœ¬èº«æä¾›æœåŠ¡çš„ã€‚</p>
<h3 id="7-3-ä¼˜å…ˆçº§å’ŒæŠ¢å å¼è°ƒåº¦"><a href="#7-3-ä¼˜å…ˆçº§å’ŒæŠ¢å å¼è°ƒåº¦" class="headerlink" title="7.3 ä¼˜å…ˆçº§å’ŒæŠ¢å å¼è°ƒåº¦"></a>7.3 ä¼˜å…ˆçº§å’ŒæŠ¢å å¼è°ƒåº¦</h3><p>å½“é›†ç¾¤çš„èµ„æºï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç­‰ï¼‰ä¸è¶³æ—¶ï¼Œæ–° Pod çš„åˆ›å»ºä¼šä¸€ç›´å¤„äº Pending çš„çŠ¶æ€ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé™¤äº†ç³»ç»Ÿå¤–çš„ Podï¼Œå…¶å®ƒ Pod çš„ä¼˜å…ˆçº§éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¦‚æœè°ƒé«˜äº† Pod çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°±ä¼šå°†ä½ä¼˜å…ˆçº§çš„ Pod é©±é€ï¼Œè…¾å‡ºç©ºé—´ç»™ä¼˜å…ˆçº§é«˜çš„ Podï¼Œè¿™å°±è¢«ç§°ä¸º<strong>æŠ¢å å¼è°ƒåº¦</strong>ã€‚</p>
<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<ol>
<li>è¦è°ƒæ•´ä¼˜å…ˆçº§ï¼Œéœ€è¦å…ˆåˆ›å»º PriorityClass</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-priorityclass</span></span><br><span class="line"><span class="comment"># ä¼˜å…ˆçº§è®¾ç½®</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000000</span></span><br><span class="line"><span class="comment"># æ˜¯å¦åœ¨å…¨å±€ä¸‹ä½¿ç”¨ï¼Œåªå¯è®¾ç½®ä¸€ä¸ª</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># æè¿°</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;this priorityclass is test&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨ Pod ä¸­è°ƒç”¨</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">priorityclass-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">priorityclass-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">priorityClassName:</span> <span class="string">test-priorityclass</span></span><br></pre></td></tr></table></figure>

<h3 id="7-4-ä¸ºPodè®¾ç½®è®¡ç®—èµ„æº"><a href="#7-4-ä¸ºPodè®¾ç½®è®¡ç®—èµ„æº" class="headerlink" title="7.4 ä¸ºPodè®¾ç½®è®¡ç®—èµ„æº"></a>7.4 ä¸ºPodè®¾ç½®è®¡ç®—èµ„æº</h3><p>å®¹å™¨è¿è¡Œæ—¶ä¼šæä¾›ä¸€äº›æœºåˆ¶æ¥é™åˆ¶å®¹å™¨å¯ä»¥ä½¿ç”¨çš„è®¡ç®—èµ„æºï¼ˆCPUã€å†…å­˜å’Œç£ç›˜ç­‰ï¼‰ï¼ŒPod æ¨¡æ¿ä¸­ä¹Ÿæä¾›äº†è¿™ä¸ªåŠŸèƒ½ï¼Œä¸»è¦å¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®—èµ„æºè®¾ç½®</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="comment"># èµ„æºé™åˆ¶è®¾ç½®ï¼Œè¶…è¿‡è®¾ç½®çš„å€¼å®¹å™¨ä¼šè¢«åœæ­¢</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="comment"># cpué™åˆ¶</span></span><br><span class="line">    <span class="attr">cpu:</span></span><br><span class="line">    <span class="comment"># å†…å­˜é™åˆ¶</span></span><br><span class="line">    <span class="attr">memory:</span></span><br><span class="line">  <span class="comment"># èµ„æºè¯·æ±‚è®¾ç½®ï¼Œè‡³å°‘éœ€è¦å¤šå°‘èµ„æºå®¹å™¨æ‰ä¼šè¢«è¿è¡Œ</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="comment"># cpuè¯·æ±‚</span></span><br><span class="line">    <span class="attr">cpu:</span></span><br><span class="line">    <span class="comment"># å†…å­˜è¯·æ±‚</span></span><br><span class="line">    <span class="attr">memory:</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resources-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">resources-container</span></span><br><span class="line">    <span class="comment"># å‹æµ‹å·¥å…·</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">vish/stress</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="comment"># è¿›è¡Œå‹æµ‹ï¼Œé˜ˆå€¼ä¸º150Mi,æ¯ä¸€ç§’å¢åŠ 5Miå‹åŠ›</span></span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;-mem-total&#x27;</span>,<span class="string">&#x27;150Mi&#x27;</span>,<span class="string">&#x27;-mem-alloc-size&#x27;</span>,<span class="string">&#x27;5Mi&#x27;</span>,<span class="string">&#x27;-mem-alloc-sleep&#x27;</span>,<span class="string">&#x27;1s&#x27;</span> ]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&#x27;100Mi&#x27;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&#x27;200m&#x27;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&#x27;50Mi&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° Pod æœ€åˆå¯ä»¥è¿è¡Œï¼Œä½†20ç§’åå°±ä¸è¡Œäº†</p>
<p><img src="/2024/02/18/kubernetes/%E4%B8%BAPod%E8%AE%BE%E7%BD%AE%E8%AE%A1%E7%AE%97%E8%B5%84%E6%BA%90%E4%B8%80.png" alt="ä¸ºPodè®¾ç½®è®¡ç®—èµ„æºä¸€"></p>
<h3 id="7-5-å‘½åç©ºé—´ç®¡ç†"><a href="#7-5-å‘½åç©ºé—´ç®¡ç†" class="headerlink" title="7.5 å‘½åç©ºé—´ç®¡ç†"></a>7.5 å‘½åç©ºé—´ç®¡ç†</h3><p>å‘½åç©ºé—´çš„ä¸»è¦ä½œç”¨æ˜¯å¯¹ k8s é›†ç¾¤çš„èµ„æºè¿›è¡Œåˆ’åˆ†ï¼Œè¿™ç§åˆ’åˆ†æ˜¯ä¸€ç§é€»è¾‘åˆ’åˆ†ï¼Œç”¨äºå®ç°å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ã€‚</p>
<p><strong>å‘½åç©ºé—´çš„åˆ›å»º</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace å‘½åç©ºé—´åç§°</span><br></pre></td></tr></table></figure>

<p><strong>å‘½åç©ºé—´çš„èµ„æºé…é¢</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span></span><br><span class="line">  <span class="attr">namespace:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="comment"># è®¡ç®—èµ„æºé…é¢</span></span><br><span class="line">    <span class="attr">limits.cpu:</span></span><br><span class="line">    <span class="attr">limits.memory:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span></span><br><span class="line">    <span class="attr">requests.memory:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å­˜å‚¨èµ„æºé…é¢</span></span><br><span class="line">    <span class="comment"># åœ¨æ‰€æœ‰PVCä¸­ï¼Œå­˜å‚¨èµ„æºçš„éœ€æ±‚ä¸èƒ½è¶…è¿‡è¯¥å€¼</span></span><br><span class="line">    <span class="attr">requests.storage:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„PVCæ•°é‡</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span></span><br><span class="line">    <span class="comment"># å…è®¸ä¸&#123;storage-class-name&#125;ç›¸å…³çš„PVCæ€»é‡</span></span><br><span class="line">    &#123;<span class="string">storage-class-name</span>&#125;<span class="string">.storageclass.storage.k8s.io/requests.storage:</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment"># å¯¹è±¡æ•°é‡é…é¢</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨ConfigMapæ•°é‡</span></span><br><span class="line">    <span class="attr">configmaps:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„éç»ˆæ­¢çŠ¶æ€çš„Podæ•°é‡</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„RCæ•°é‡</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„èµ„æºé…é¢æ•°é‡</span></span><br><span class="line">    <span class="attr">resourcequotas:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„SVCæ•°é‡</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„LoadBalancerç±»å‹çš„SVCæ•°é‡</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„NodePortç±»å‹çš„SVCæ•°é‡</span></span><br><span class="line">    <span class="attr">services.nodeports:</span></span><br><span class="line">    <span class="comment"># å…è®¸å­˜åœ¨çš„Secretæ•°é‡</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br></pre></td></tr></table></figure>

<h4 id="7-5-1-å‘½åç©ºé—´çš„èµ„æºé…é¢"><a href="#7-5-1-å‘½åç©ºé—´çš„èµ„æºé…é¢" class="headerlink" title="7.5.1 å‘½åç©ºé—´çš„èµ„æºé…é¢"></a>7.5.1 å‘½åç©ºé—´çš„èµ„æºé…é¢</h4><p><strong>ç¤ºä¾‹ä¸€</strong></p>
<ol>
<li>å…ˆåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace test-ns</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºèµ„æºé…é¢</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-rq</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&#x27;4&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ›å»ºä¸€ä¸ª Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-ns-depolyment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-ns-depolyment-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>é…é¢é™åˆ¶çš„ Pod æ•°é‡æ˜¯2ï¼Œä½† Deployment è®¾ç½®çš„å‰¯æœ¬æ•°æ˜¯3ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯åˆ›å»ºä¸äº†ç¬¬ä¸‰ä¸ª Pod çš„</p>
<p><img src="/2024/02/18/kubernetes/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E4%B8%80.png" alt="å‘½åç©ºé—´èµ„æºé…é¢ä¸€"></p>
<h4 id="7-5-2-å‘½åç©ºé—´å•ä¸ªèµ„æºçš„èµ„æºé…é¢"><a href="#7-5-2-å‘½åç©ºé—´å•ä¸ªèµ„æºçš„èµ„æºé…é¢" class="headerlink" title="7.5.2 å‘½åç©ºé—´å•ä¸ªèµ„æºçš„èµ„æºé…é¢"></a>7.5.2 å‘½åç©ºé—´å•ä¸ªèµ„æºçš„èµ„æºé…é¢</h4><p>é€šè¿‡è®¾ç½®èµ„æºé…é¢ï¼Œå¯ä»¥é™å®šä¸€ä¸ªå‘½åç©ºé—´ä¸‹ä½¿ç”¨çš„èµ„æºæ€»é‡ï¼Œä½†è¿™åªæ˜¯æ€»é‡é™åˆ¶ï¼Œå¯¹äºå•ä¸ªèµ„æºæ²¡æœ‰é™åˆ¶ï¼Œæœ‰æ—¶å€™ä¸€ä¸ª Pod å°±å¯èƒ½ç”¨å®Œæ•´ä¸ªå‘½åç©ºé—´æ‰€æŒ‡å®šçš„èµ„æºï¼Œä¸ºäº†é¿å…ï¼Œå¯ä»¥é€šè¿‡<code>LimitRange</code>æ¥å¯¹å•ä¸ªèµ„æºè¿›è¡Œé™å®šã€‚</p>
<p><strong>è®¾ç½®å®¹å™¨çš„é™é¢èŒƒå›´</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-container</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;200m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;300Mi&#x27;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;150Mi&#x27;</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;180m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;250Mi&#x27;</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;110m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;160Mi&#x27;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E4%BA%8C.png" alt="å‘½åç©ºé—´èµ„æºé…é¢äºŒ"></p>
<p>å½“ LimitRange åˆ›å»ºæˆåŠŸåï¼Œåˆ›å»ºè¯¥å‘½åç©ºé—´ä¸‹çš„ Pod æ—¶ï¼Œå„ä¸ªå®¹å™¨çš„<code>resource.limits</code>å’Œ<code>resource.requests</code>å¿…é¡»æ»¡è¶³ Max å’Œ Min ä¹‹é—´çš„èŒƒå›´ã€‚</p>
<p>è€Œ<code>default</code>å’Œ<code>defaultRequest</code>æ˜¯æŒ‡ï¼Œå½“åˆ›å»º Pod æ—¶æ²¡ç”¨è®¾ç½®é™é¢ï¼Œåˆ™æ ¹æ®æ­¤å±æ€§æ¥è®¾ç½®é™é¢ã€‚</p>
<p><strong>è®¾ç½® Pod çš„é™é¢èŒƒå›´</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;600Mi&#x27;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;500m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;300Mi&#x27;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<p>å½“ LimitRange åˆ›å»ºæˆåŠŸåï¼Œåˆ›å»ºè¯¥å‘½åç©ºé—´ä¸‹çš„ Pod æ—¶ï¼Œå„ä¸ª Pod çš„<code>resource.limits</code>å’Œ<code>resource.requests</code>å¿…é¡»æ»¡è¶³ Max å’Œ Min ä¹‹é—´çš„èŒƒå›´ã€‚</p>
<p><strong>è®¾ç½® PVC çš„é™é¢èŒƒå›´</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">200Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PersistentVolumeClaim</span></span><br></pre></td></tr></table></figure>

<p><strong>è®¾ç½® Pod æˆ–å®¹å™¨çš„æ¯”ä¾‹é™é¢èŒƒå›´</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-ratio</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">maxLimitRequestRatio:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<p>è®¾ç½®æ¯”ä¾‹é™é¢å¯ä»¥é™åˆ¶ Pod æˆ–å®¹å™¨è®¾ç½®çš„è¯·æ±‚èµ„æºå’Œä¸Šé™èµ„æºçš„æ¯”å€¼ï¼Œåœ¨è¯¥ç¤ºä¾‹ä¸­ï¼ŒPod æ‰€æœ‰å®¹å™¨çš„<code>resources.limits.memory</code>çš„æ€»å’Œè¦ &#x3D; Pod æ‰€æœ‰å®¹å™¨çš„<code>resources.requests.memory</code>çš„æ€»å’Œçš„ä¸¤å€ï¼Œ<strong>å³ä¸Šé™å¿…é¡»æ˜¯éœ€æ±‚çš„ä¸¤å€</strong>ï¼ŒPod æ‰èƒ½å¤Ÿåˆ›å»ºæˆåŠŸã€‚</p>
<h3 id="7-6-æ ‡ç­¾ã€é€‰æ‹©å™¨ã€æ³¨è§£"><a href="#7-6-æ ‡ç­¾ã€é€‰æ‹©å™¨ã€æ³¨è§£" class="headerlink" title="7.6 æ ‡ç­¾ã€é€‰æ‹©å™¨ã€æ³¨è§£"></a>7.6 æ ‡ç­¾ã€é€‰æ‹©å™¨ã€æ³¨è§£</h3><h4 id="7-6-1-æ ‡ç­¾"><a href="#7-6-1-æ ‡ç­¾" class="headerlink" title="7.6.1 æ ‡ç­¾"></a>7.6.1 æ ‡ç­¾</h4><p>k8s çš„æ ‡ç­¾ï¼ˆlabelï¼‰æ˜¯ä¸€ç§è¯­ä¹‰åŒ–æ ‡è®°æ ‡ç­¾ï¼Œå¯ä»¥é™„åŠ åˆ° k8s å¯¹è±¡ä¸Šï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ ‡è®°å’Œåˆ’åˆ†ã€‚</p>
<p>æ ‡ç­¾çš„å½¢å¼æ˜¯é”®å€¼å¯¹ï¼Œæ¯ä¸ªèµ„æºå¯¹è±¡éƒ½å¯ä»¥æ‹¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œä½†æ¯ä¸ªé”®éƒ½åªèƒ½æœ‰ä¸€ä¸ªå€¼ã€‚</p>
<p>å¯¹äºæ ‡ç­¾çš„è®¾ç½®ï¼Œæ˜¯é€šè¿‡<code>metadata</code>å±æ€§ä¸­å®ç°çš„ï¼Œå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">key1:</span> <span class="string">value1</span></span><br><span class="line">    <span class="attr">key2:</span> <span class="string">value2</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>è€Œå¯¹äºå·²æœ‰çš„èµ„æºï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ·»åŠ æˆ–åˆ é™¤æ ‡ç­¾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label èµ„æºç±»å‹ èµ„æºåç§° æ ‡ç­¾å=æ ‡ç­¾å€¼</span><br><span class="line">kubectl label èµ„æºç±»å‹ èµ„æºåç§° æ ‡ç­¾å=æ ‡ç­¾å€¼-</span><br></pre></td></tr></table></figure>

<h4 id="7-6-2-é€‰æ‹©å™¨"><a href="#7-6-2-é€‰æ‹©å™¨" class="headerlink" title="7.6.2 é€‰æ‹©å™¨"></a>7.6.2 é€‰æ‹©å™¨</h4><p>é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆselectorï¼‰å°±å¯ä»¥å¿«é€ŸæŸ¥æ‰¾åˆ°æŒ‡å®šæ ‡ç­¾çš„èµ„æºã€‚</p>
<p>é€šè¿‡<code>-l</code>æŸ¥æ‰¾æ–¹å¼å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l æ ‡ç­¾å=/!=æ ‡ç­¾å€¼</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>in</code> <code>notin</code>æŸ¥æ‰¾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l &#x27;æ ‡ç­¾å1 in/notin (æ ‡ç­¾å€¼1,æ ‡ç­¾å€¼2)&#x27;</span><br></pre></td></tr></table></figure>

<p>æ¯ç§åŸºäºæ§åˆ¶å™¨çš„å¯¹è±¡ä¹Ÿå¯ä»¥ä½¿ç”¨æ ‡ç­¾æ¥é€‰æ‹©éœ€è¦æ“ä½œçš„ Podï¼Œå¦‚ Jobã€Deploymentã€DaemonSet ç­‰éƒ½å¯ä»¥åœ¨<code>spec</code>ä¸­æŒ‡å®šé€‰æ‹©å™¨ï¼Œä»¥æŸ¥æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ Podï¼Œå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">stable</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">env</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">dev</span>] &#125;</span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">track</span>, <span class="attr">operator:</span> <span class="string">Exists</span> &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨åˆ›å»º SVC æ—¶ï¼Œéƒ½éœ€è¦åˆ¶å®šæ ‡ç­¾é€‰æ‹©å™¨æ¥ç¡®å®šéœ€è¦æ§åˆ¶çš„èµ„æºï¼Œå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">stable</span></span><br></pre></td></tr></table></figure>

<p>åœ¨åˆ›å»º PVC æ—¶ï¼Œé™¤äº†ç”¨ç±»åŒ¹é…ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨æ ‡ç­¾æ¥åŒ¹é…é€‚åˆçš„ PVï¼Œå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">pvnumber:</span> <span class="string">pv01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">pvnumber:</span> <span class="string">pv01</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="7-6-3-æ³¨è§£"><a href="#7-6-3-æ³¨è§£" class="headerlink" title="7.6.3 æ³¨è§£"></a>7.6.3 æ³¨è§£</h4><p>æ³¨è§£ï¼ˆannotationï¼‰ä¹Ÿæ˜¯ä¸€ç§ç±»ä¼¼æ ‡ç­¾çš„æœºåˆ¶ï¼Œä½†åªæ˜¯ç»™èµ„æºæ·»åŠ æ›´å¤šä¿¡æ¯çš„æ–¹å¼ï¼Œç±»ä¼¼æ³¨é‡Šã€‚</p>
<p>è®¾ç½®æ³¨è§£ï¼Œæ˜¯é€šè¿‡<code>metadata</code>æ¥å®ç°çš„ï¼Œå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line">  <span class="attr">annotation:</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">&#x27;cqm&#x27;</span></span><br><span class="line">    <span class="attr">phone:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">&#x27;123456@789.com&#x27;</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>



<h2 id="å…«ã€API-Server"><a href="#å…«ã€API-Server" class="headerlink" title="å…«ã€API Server"></a>å…«ã€API Server</h2><p>API Server æ˜¯é›†ç¾¤å†…å¸ƒå„ä¸ªç»„ä»¶é€šä¿¡çš„ä¸­ä»‹ï¼Œä¹Ÿæ˜¯å¤–éƒ¨æ§åˆ¶çš„å…¥å£ï¼Œk8s çš„å®‰å…¨æœºåˆ¶åŸºæœ¬éƒ½æ˜¯å›´ç»•ç€ä¿æŠ¤ API Server æ¥è®¾è®¡çš„ï¼Œé€šè¿‡<strong>è®¤è¯ã€é‰´æƒã€å‡†å…¥æ§åˆ¶</strong>ä¸‰æ­¥æ¥ä¿è¯ API Server çš„å®‰å…¨ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨ k8s æ—¶ï¼Œéƒ½æ˜¯é€šè¿‡<code>kubectl</code>å·¥å…·æ¥è®¿é—® API Server çš„ï¼Œ<code>kubectl</code>æŠŠå‘½ä»¤è½¬æ¢ä¸ºå¯¹ API Server çš„ REST API è°ƒç”¨ã€‚</p>
<p><img src="/2024/02/18/kubernetes/apiserver%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B.svg" alt="apiserverè®¿é—®æµç¨‹"></p>
<h3 id="8-1-èº«ä»½è®¤è¯"><a href="#8-1-èº«ä»½è®¤è¯" class="headerlink" title="8.1 èº«ä»½è®¤è¯"></a>8.1 èº«ä»½è®¤è¯</h3><p>èº«ä»½è®¤è¯ä¸»è¦ç”¨äºç¡®å®šç”¨æˆ·èƒ½ä¸èƒ½è®¿é—®ï¼Œæ˜¯è®¿é—® API Server çš„ç¬¬ä¸€ä¸ªå…³å¡ã€‚</p>
<p>é€šè¿‡å‘½ä»¤å¯ä»¥çœ‹åˆ°è®¤è¯æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ 6443 ç«¯å£è¿›è¡Œè®¿é—®çš„ã€‚</p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%80.png" alt="èº«ä»½è®¤è¯ä¸€"></p>
<p>è¦è®¿é—® API Serverï¼Œé¦–å…ˆå°±è¦è¿›è¡Œèº«ä»½è®¤è¯ï¼Œk8s çš„èº«ä»½è®¤è¯åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p>
<ul>
<li>å¸¸è§„ç”¨æˆ·è®¤è¯ï¼šä¸»è¦æä¾›äºæ™®é€šç”¨æˆ·æˆ–ç‹¬ç«‹äº k8s ä¹‹å¤–çš„å…¶ä»–å¤–éƒ¨åº”ç”¨ä½¿ç”¨ï¼Œä»¥ä¾¿èƒ½ä»å¤–éƒ¨è®¿é—® API Serverã€‚</li>
<li>ServiceAccount è®¤è¯ï¼šä¸»è¦æä¾›äºå†…éƒ¨çš„ Pod ä½¿ç”¨ã€‚</li>
</ul>
<h4 id="8-1-1-å¸¸è§„ç”¨æˆ·è®¤è¯"><a href="#8-1-1-å¸¸è§„ç”¨æˆ·è®¤è¯" class="headerlink" title="8.1.1 å¸¸è§„ç”¨æˆ·è®¤è¯"></a>8.1.1 å¸¸è§„ç”¨æˆ·è®¤è¯</h4><p>å¸¸è§„ç”¨æˆ·è®¤è¯ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š</p>
<ul>
<li><p>HTTPS è¯ä¹¦è®¤è¯ï¼šåŸºäº CA è¯ä¹¦ç­¾åçš„æ•°å­—è¯ä¹¦è®¤è¯ã€‚</p>
</li>
<li><p>HTTP ä»¤ç‰Œè®¤è¯ï¼šé€šè¿‡ä»¤ç‰Œæ¥è¯†åˆ«ç”¨æˆ·ã€‚</p>
</li>
<li><p>HTTP Base è®¤è¯ï¼šé€šè¿‡ç”¨æˆ·åå’Œå¯†ç è®¤è¯ã€‚</p>
</li>
</ul>
<ol>
<li>ä»¤ç‰Œè®¤è¯æ˜¯æœ€å®ç”¨ä¹Ÿæœ€æ™®åŠçš„æ–¹å¼ï¼Œé¦–å…ˆç”Ÿæˆä¸€ä¸ªéšæœºä»¤ç‰Œ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æ¥ç€ç»™ k8s åˆ›å»ºä»¤ç‰Œè®¤è¯æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/pki/token_auth_file</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¼å¼ä¸º:ä»¤ç‰Œ1,ç”¨æˆ·1,ç”¨æˆ·ID</span></span><br><span class="line">ec0f09bf9a3c40f9db1cc0f8e6664c12,cqm,1</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>è®¤è¯æ–‡ä»¶åˆ›å»ºå¥½åï¼Œåœ¨ API Server å¯åŠ¨æ–‡ä»¶ä¸­è¿›è¡Œå¼•ç”¨</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line"><span class="comment"># åœ¨specä¸­æ·»åŠ </span></span><br><span class="line"><span class="string">--token-auth-file=/etc/kubernetes/pki/token_auth_file</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æ¥ç€å°±å¯ä»¥ç”¨è®¤è¯å¥½çš„ç”¨æˆ·è®¿é—® API Server æ¥è·å– Pod çš„ä¿¡æ¯äº†</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer ec0f09bf9a3c40f9db1cc0f8e6664c12&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%BA%8C.png" alt="èº«ä»½è®¤è¯äºŒ"></p>
<p>ä½†å¯ä»¥çœ‹åˆ°è¿˜æ˜¯å¤±è´¥ï¼Œå› ä¸ºè¿˜æ²¡æœ‰è¿›è¡Œæˆæƒï¼Œåè¾¹å°†è¿›è¡Œæˆæƒã€‚</p>
<h4 id="8-1-2-ServiceAccountè®¤è¯"><a href="#8-1-2-ServiceAccountè®¤è¯" class="headerlink" title="8.1.2 ServiceAccountè®¤è¯"></a>8.1.2 ServiceAccountè®¤è¯</h4><p>ServiceAccount è®¤è¯ä¸»è¦æä¾›äºé›†ç¾¤å†…å¸ƒçš„ Pod ä¸­çš„è¿›ç¨‹ä½¿ç”¨ï¼Œå¸¸è§„ç”¨æˆ·è®¤è¯æ˜¯ä¸é™åˆ¶å‘½åç©ºé—´çš„ï¼Œä½† ServiceAccount è®¤è¯çš„å±€é™äºå®ƒæ‰€åœ¨çš„å‘½åç©ºé—´ä¸­ã€‚</p>
<p><strong>é»˜è®¤ ServiceAccount</strong></p>
<p>æ¯ä¸ªå‘½åç©ºé—´éƒ½æœ‰ä¸ªé»˜è®¤çš„ ServiceAccountï¼Œå¦‚æœåˆ›å»º Pod æ—¶æ²¡ç”¨æŒ‡å®šï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨é»˜è®¤çš„ ServiceAccountã€‚</p>
<ol>
<li>é€šè¿‡å‘½ä»¤å¯ä»¥çœ‹åˆ°é»˜è®¤çš„ ServiceAccount</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%89.png" alt="èº«ä»½è®¤è¯ä¸‰"></p>
<ol start="2">
<li>åˆ›å»ºä¸€ä¸ª Pod è¿›è¡Œæµ‹è¯•</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sa-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sa-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;this is sa test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æŸ¥çœ‹ Pod çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°è¢«æŒ‚è½½äº†ä¸€ä¸ª Secret ç±»å‹çš„å·ï¼Œå®é™…ä¸Šè¿™é‡Œé¢å°±å­˜æ”¾äº† ServiceAccount çš„è®¤è¯ä¿¡æ¯</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%9B%9B.png" alt="èº«ä»½è®¤è¯å››"></p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%BA%94.png" alt="èº«ä»½è®¤è¯äº”"></p>
<p>è¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œé€šè¿‡ä»¥ä¸Šåœ°å€æ˜ å°„ä»¤ç‰Œåœ¨è¿›è¡Œè®¿é—® API Serverï¼Œå¯ä»¥çœ‹åˆ°ç”±äºæœªæˆæƒä¾æ—§ä¸è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorizat</span><br><span class="line">ion:Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%85%AD.png" alt="èº«ä»½è®¤è¯å…­"></p>
<p><strong>è‡ªå®šä¹‰ ServiceAccount</strong></p>
<p>å¦‚æœæŸäº› Pod éœ€è¦è®¿é—® API Serverï¼Œé€šå¸¸ä¼šè®©å®ƒå¼•ç”¨è‡ªå®šä¹‰ ServiceAccountï¼Œå¹¶ä¸ºå…¶æˆæƒã€‚</p>
<ol>
<li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ ServiceAccount</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºå¥½åå¯ä»¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…å«äº†è¯ä¹¦å’Œä»¤ç‰Œç­‰</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%83.png" alt="èº«ä»½è®¤è¯ä¸ƒ"></p>
<ol start="3">
<li>åˆ›å»º Pod å¼•ç”¨</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-sa-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-sa-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;this is sa test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å°±å¯ä»¥çœ‹åˆ° Pod ä¸­å·²ç»å¼•ç”¨äº†</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%85%AB.png" alt="èº«ä»½è®¤è¯å…«"></p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B9%9D.png" alt="èº«ä»½è®¤è¯ä¹"></p>
<h3 id="8-2-RBACæˆæƒ"><a href="#8-2-RBACæˆæƒ" class="headerlink" title="8.2 RBACæˆæƒ"></a>8.2 RBACæˆæƒ</h3><p>k8s ä¸­æœ‰åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰ï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼ŒåŸºäº HTTP å›è°ƒæœºåˆ¶çš„è®¿é—®æ§åˆ¶ï¼ˆWebhookï¼‰ã€Node è®¤è¯ç­‰æˆæƒæ¨¡å¼ï¼Œä½†1.6ç‰ˆæœ¬å¼€å§‹å°±é»˜è®¤å¯ç”¨ RBAC æ¨¡å¼ã€‚</p>
<p>RBAC æˆæƒä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ul>
<li>è§’è‰²å®šä¹‰ï¼šæŒ‡å®šè§’è‰²åç§°ï¼Œå®šä¹‰å…è®¸è®¿é—®å“ªäº›èµ„æºä»¥åŠå…è®¸çš„è®¿é—®æ–¹å¼ã€‚</li>
<li>è§’è‰²ç»‘å®šï¼šå°†è§’è‰²ä¸ç”¨æˆ·ï¼ˆå¸¸è§„ç”¨æˆ·æˆ– ServiceAccountï¼‰è¿›è¡Œç»‘å®šã€‚</li>
</ul>
<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E5%8E%9F%E7%90%86.png" alt="RBACæˆæƒåŸç†"></p>
<p>è€Œè§’è‰²å®šä¹‰å’Œè§’è‰²ç»‘å®šåˆåˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>åªæœ‰å•ä¸€æŒ‡å®šå‘½åç©ºé—´è®¿é—®æƒé™çš„è§’è‰²ï¼šè§’è‰²å®šä¹‰å…³é”®å­—ä¸º Roleï¼Œè§’è‰²ç»‘å®šå…³é”®å­—ä¸º RoleBindingã€‚</li>
<li>æ‹¥æœ‰é›†ç¾¤çº§åˆ«ï¼ˆä¸é™å‘½åç©ºé—´ï¼‰è®¿é—®æƒé™çš„è§’è‰²ï¼šè§’è‰²å®šä¹‰ä¸º ClusterRoleï¼Œè§’è‰²ç»‘å®šå…³é”®å­—ä¸º ClusterRoleBindingã€‚</li>
</ul>
<h4 id="8-2-1-æ™®é€šè§’è‰²çš„å®šä¹‰ä¸ç»‘å®š"><a href="#8-2-1-æ™®é€šè§’è‰²çš„å®šä¹‰ä¸ç»‘å®š" class="headerlink" title="8.2.1 æ™®é€šè§’è‰²çš„å®šä¹‰ä¸ç»‘å®š"></a>8.2.1 æ™®é€šè§’è‰²çš„å®šä¹‰ä¸ç»‘å®š</h4><p><strong>æ™®é€šè§’è‰²å®šä¹‰</strong></p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªæ™®é€šè§’è‰²</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># è§’è‰²å</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># è§’è‰²è§„åˆ™å®šä¹‰</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># è¡¨ç¤ºå¯ä»¥å¯¹å“ªäº›APIç»„çš„èµ„æºè¿›è¡Œæ“ä½œï¼Œè¿™é‡Œä¸ºç©ºå³ä¸é™åˆ¶</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="comment"># å¯ä»¥è®¿é—®çš„èµ„æºåˆ—è¡¨ï¼Œè¿™é‡Œä¸ºPod</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="comment"># å¯ä»¥è¿›è¡Œçš„è®¿é—®æ–¹å¼</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è®¿é—®æ–¹å¼å¯ä»¥é€šè¿‡å¼€å¯<code>kubectl</code>åå‘ä»£ç†æŸ¥çœ‹ï¼Œå…¶ä¸­çš„<code>verb</code>å°±æ˜¯å¯ä»¥è®¿é—®çš„æ–¹å¼</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --port:8080</span><br><span class="line">curl http://localhost:8080/&#123;APIVersion&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ™®é€šè§’è‰²ç»‘å®š</strong></p>
<p>å®šä¹‰è§’è‰²åå°±å¯ä»¥è¿›è¡Œç»‘å®šè§’è‰²ï¼Œç»‘å®šå¯ä»¥é’ˆå¯¹å¸¸è§„ç”¨æˆ·è®¤è¯ï¼Œä¹Ÿå¯ä»¥è¿™å¯¹ ServiceAccount è®¤è¯ã€‚</p>
<ol>
<li>åˆ›å»ºè§’è‰²ç»‘å®š</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># å°†è§’è‰²ç»‘å®šç»™é‚£äº›è®¤è¯ä¸»ä½“ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå°†å¸¸è§„ç”¨æˆ·è®¤è¯cqmå’ŒServiceAccountè®¤è¯my-serviceaccountåŠ å…¥åˆ°rabc-roleè§’è‰²ä¸­</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="comment"># å¸¸è§„ç”¨æˆ·è®¤è¯ç»‘å®š</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># ServiceAccountè®¤è¯ç»‘å®š</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># è¦ç»‘å®šçš„è§’è‰²</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="comment"># æ™®é€šè§’è‰²</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E4%B8%80.png" alt="RBACæˆæƒä¸€"></p>
<ol start="2">
<li>å°è¯•ç”¨ä¹‹å‰åˆ›å»ºçš„å¸¸è§„ç”¨æˆ·è®¤è¯å’Œ ServiceAccount è®¤è¯æ¥è®¿é—® API Serverï¼Œå¯ä»¥å‘ç°å°±å¯ä»¥è®¿é—®äº†</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer ec0f09bf9a3c40f9db1cc0f8e6664c12&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer $(cat /var/run/secrets/kubern</span><br><span class="line">etes.io/serviceaccount/token)&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E4%BA%8C.png" alt="RBACæˆæƒäºŒ"></p>
<h4 id="8-2-2-é›†ç¾¤è§’è‰²çš„å®šä¹‰ä¸ç»‘å®š"><a href="#8-2-2-é›†ç¾¤è§’è‰²çš„å®šä¹‰ä¸ç»‘å®š" class="headerlink" title="8.2.2 é›†ç¾¤è§’è‰²çš„å®šä¹‰ä¸ç»‘å®š"></a>8.2.2 é›†ç¾¤è§’è‰²çš„å®šä¹‰ä¸ç»‘å®š</h4><p>é›†ç¾¤è§’è‰²ä¸æ™®é€šè§’è‰²çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½¿ç”¨çš„å…³é”®å­—ä¸åŒï¼šæ™®é€šè§’è‰²ä½¿ç”¨ Roleï¼Œç»‘å®šä½¿ç”¨ RoleBindingï¼Œé›†ç¾¤è§’è‰²ä½¿ç”¨ ClusterRoleï¼Œç»‘å®šä½¿ç”¨ ClusterRoleBindingã€‚</li>
<li>é›†ç¾¤è§’è‰²ä¸å±äºä»»ä½•å‘½åç©ºé—´ï¼Œæ¨¡æ¿ä¹Ÿä¸éœ€è¦æŒ‡å®šå‘½åç©ºé—´ï¼Œæ™®é€šè§’è‰²è¦æ±‚æŒ‡å®šå‘½åç©ºé—´ï¼Œå¦‚æœæ²¡æŒ‡å®šä¹é»˜è®¤ defaultã€‚</li>
<li>é›†ç¾¤è§’è‰²å¯ä»¥è®¿é—®æ‰€æœ‰å‘½åç©ºé—´ä¸‹çš„èµ„æºï¼Œä¹Ÿå¯ä»¥è®¿é—®ä¸åœ¨å‘½åç©ºé—´ä¸‹çš„èµ„æºã€‚</li>
</ul>
<p>é›†ç¾¤è§’è‰²åˆ›å»ºå’Œç»‘å®šå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é›†ç¾¤è§’è‰²å®šä¹‰</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># é›†ç¾¤è§’è‰²å</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrole</span></span><br><span class="line"><span class="comment"># è§„åˆ™</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># é›†ç¾¤è§’è‰²ç»‘å®š</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrolebinding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># ç”±äºmy-serviceaccountæ˜¯æŸä¸ªå‘½åç©ºé—´ä¸‹çš„ï¼Œæ‰€ä»¥è¦æŒ‡å®šå‘½åç©ºé—´</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">clusterrole</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä¸€æ¥ç”¨æˆ·ï¼ˆcqmï¼Œmy-serviceaccountï¼‰éƒ½å¯ä»¥è®¿é—®å…¨å±€çš„èµ„æºï¼Œå½“ç„¶ ClusterRole ä¹Ÿå¯ä»¥å’Œ RoleBinding ç»‘å®šåœ¨ä¸€èµ·ï¼Œå› ä¸º ClusterRole æ˜¯ä¸é™å‘½åç©ºé—´çš„ï¼Œå¦‚æœæ—¢æƒ³ç»™æŸä¸ªè®¤è¯ä¸»ä½“ç»‘å®š ClusterRoleï¼Œåˆæƒ³é™åˆ¶å®ƒèƒ½è®¿é—®çš„å‘½åç©ºé—´ï¼Œå°±å¯ä»¥é€šè¿‡ä¸ RoleBinding ç»‘å®šæ¥å®ç°ï¼Œæœ¬ä¾‹ä¸­æ˜¯æŒ‡<code>rbac-clusterrole</code>çš„è§’è‰²åœ¨ç»‘å®š<code>rbac-rolebinding</code>åï¼Œå¯ä»¥è®¿é—®åœ¨<code>default</code>å‘½åç©ºé—´ä¸‹çš„ä»»ä½•èµ„æºï¼Œå¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrole</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-åˆ›å»ºä¸€ä¸ªç”¨æˆ·åªèƒ½ç®¡ç†æŒ‡å®šçš„å‘½åç©ºé—´"><a href="#8-3-åˆ›å»ºä¸€ä¸ªç”¨æˆ·åªèƒ½ç®¡ç†æŒ‡å®šçš„å‘½åç©ºé—´" class="headerlink" title="8.3 åˆ›å»ºä¸€ä¸ªç”¨æˆ·åªèƒ½ç®¡ç†æŒ‡å®šçš„å‘½åç©ºé—´"></a>8.3 åˆ›å»ºä¸€ä¸ªç”¨æˆ·åªèƒ½ç®¡ç†æŒ‡å®šçš„å‘½åç©ºé—´</h3><p>åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒMaster çš„ç®¡ç†è€…å¯èƒ½æœ‰å¾ˆå¤šä¸ªï¼Œä½†ä¸å¯èƒ½ç»™äººäººéƒ½èµ‹äºˆ root çš„æƒé™ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ›å»ºæ–°ç”¨æˆ·ç»™å…¶ç®¡ç†æŒ‡å®šå‘½åç©ºé—´çš„æƒé™ã€‚</p>
<ol>
<li>åˆ›å»ºæ–°ç”¨æˆ·ï¼Œè¿™æ—¶å€™è¯¥ç”¨æˆ·æ˜¯ä½¿ç”¨ä¸äº† k8s çš„</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd cqm</span><br><span class="line">passwd cqm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E7%BB%99%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%9F%90%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%80.png" alt="ç»™ç”¨æˆ·ç®¡ç†æŸä¸ªå‘½åç©ºé—´ä¸€"></p>
<ol start="2">
<li>åˆ›å»ºè¯ä¹¦è¯·æ±‚</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim cqm-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cqm&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ShenZhen&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ShenZhen&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k8s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ä¸‹è½½è¯ä¹¦ç”Ÿæˆå·¥å…·</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssl_1.6.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssljson_1.6.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssl-certinfo_1.6.0_linux_amd64</span><br><span class="line">mv cfssl_1.6.0_linux_amd64 cfssl</span><br><span class="line">mv cfssl-certinfo_1.6.0_linux_amd64 cfssl-certinfo</span><br><span class="line">mv cfssljson_1.6.0_linux_amd64 cfssljson</span><br><span class="line">chmod a+x cfssl*</span><br><span class="line">mv cfssl* /usr/local/bin</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç”Ÿæˆè¯ä¹¦</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/pki</span><br><span class="line">cfssl gencert -ca=ca.crt -ca-key=ca.key -profile=kubernetes ~/cqm-csr.json | cfssljson -bare cqm</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>è®¾ç½®é›†ç¾¤å‚æ•°</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export KUBE_APISERVER=&quot;192.168.88.10:6443&quot;</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials cqm \</span><br><span class="line">--client-certificate=/etc/kubernetes/pki/cqm.pem  \</span><br><span class="line">--client-key=/etc/kubernetes/pki/cqm-key.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=cqm \</span><br><span class="line">--namespace=dev \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>è¿›è¡Œ RoleBindingï¼Œè¿™é‡Œçš„æ„æ€æ˜¯æŒ‡å°†å¸¸è§„ç”¨æˆ· cqm ä¸ ClusterRole çš„ admin è§’è‰²è¿›è¡Œç»‘å®šï¼Œä¸”æŒ‡å®š dev çš„å‘½åç©ºé—´ç»™ cqmï¼Œæœ€ç»ˆæ•ˆæœæ˜¯ cqm åªèƒ½å¤Ÿè®¿é—®å’Œç®¡ç† dev å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰èµ„æº</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E7%BB%99%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%9F%90%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%BA%8C.png" alt="ç»™ç”¨æˆ·ç®¡ç†æŸä¸ªå‘½åç©ºé—´äºŒ"></p>
<ol start="9">
<li>è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/cqm/.kube</span><br><span class="line">cp cqm.kubeconfig /home/cqm/.kube/config</span><br><span class="line">chown cqm:cqm /home/cqm/.kube/config</span><br><span class="line">su cqm</span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=/home/cqm/.kube/config</span><br></pre></td></tr></table></figure>



<h2 id="ä¹ã€k8sæ‰©å±•"><a href="#ä¹ã€k8sæ‰©å±•" class="headerlink" title="ä¹ã€k8sæ‰©å±•"></a>ä¹ã€k8sæ‰©å±•</h2><h3 id="9-1-å¯è§†åŒ–ç®¡ç†â€”â€”Kubernetes-Dashboard"><a href="#9-1-å¯è§†åŒ–ç®¡ç†â€”â€”Kubernetes-Dashboard" class="headerlink" title="9.1 å¯è§†åŒ–ç®¡ç†â€”â€”Kubernetes Dashboard"></a>9.1 å¯è§†åŒ–ç®¡ç†â€”â€”Kubernetes Dashboard</h3><p>Kubernetes Dashboard å¯ä»¥å®ç° k8s çš„å¯è§†åŒ–ç®¡ç†ï¼Œå¯ä»¥å®ç°å¯¹ Podã€æ§åˆ¶å™¨ã€Service ç­‰èµ„æºçš„åˆ›å»ºå’Œç»´æŠ¤ï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡ŒæŒç»­ç›‘æ§ã€‚</p>
<h4 id="9-1-1-å®‰è£…Kubernetes-Dashboard"><a href="#9-1-1-å®‰è£…Kubernetes-Dashboard" class="headerlink" title="9.1.1 å®‰è£…Kubernetes Dashboard"></a>9.1.1 å®‰è£…Kubernetes Dashboard</h4><ol>
<li>ä¸‹è½½</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æ¨¡æ¿æ–‡ä»¶å¦‚ä¸‹ï¼Œå°†æ‹‰å–é•œåƒçš„åœ°å€æ”¹ä¸ºå›½å†…åœ°å€ï¼ŒåŒæ—¶ä¿®æ”¹ SVC æ¨¡å¼ä¸º NodePortï¼Œè¿™æ ·åœ¨é›†ç¾¤ä¹‹å¤–ä¹Ÿå¯ä»¥è®¿é—® Dashboard</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-csrf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">csrf:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-key-holder</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-settings</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="string">&quot;kubernetes-dashboard-certs&quot;</span>, <span class="string">&quot;kubernetes-dashboard-csrf&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-settings&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services/proxy&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;http:heapster:&quot;</span>, <span class="string">&quot;https:heapster:&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>, <span class="string">&quot;http:dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;metrics.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registery.cn-hangzhou.aliyuncs.com/google_containers/dashboard:v2.3.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--namespace=kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">seccomp.security.alpha.kubernetes.io/pod:</span> <span class="string">&#x27;runtime/default&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registery.cn-hangzhou.aliyuncs.com/google_containers/metrics-scraper:v1.0.6</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å®‰è£…</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f Kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>åˆ›å»ºå®Œä¹‹åå¯ä»¥æŸ¥çœ‹å¯¹åº”çš„ SVCï¼Œå°±å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®äº†</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%B8%80.png" alt="dashboardä¸€"></p>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%BA%8C.png" alt="dashboardäºŒ"></p>
<ol start="5">
<li>RBAC æˆæƒ</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºServiceAccountè®¤è¯</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># åˆ›å»ºClusterRoleBindingå°†dashboard-adminä¸é›†ç¾¤è§’è‰²cluster-adminè¿›è¡Œç»‘å®š</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboardadmin-rbac</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>è·å–ä»¤ç‰Œå¹¶å¡«å…¥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe secret dashboard-admin -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/dashboard%E4%B8%89.png" alt="dashboardä¸‰"></p>
<h4 id="9-1-2-Kubernetes-Dashboardä½¿ç”¨"><a href="#9-1-2-Kubernetes-Dashboardä½¿ç”¨" class="headerlink" title="9.1.2 Kubernetes Dashboardä½¿ç”¨"></a>9.1.2 Kubernetes Dashboardä½¿ç”¨</h4><ol>
<li>åˆ›å»ºä¸€ä¸ªç®€å•çš„ Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E5%9B%9B.png" alt="dashboardå››"></p>
<ol start="2">
<li>æŸ¥çœ‹ Pod çŠ¶æ€</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%BA%94.png" alt="dashboardäº”"></p>
<h3 id="9-2-èµ„æºç›‘æ§â€”â€”Prometheuså’ŒGrafana"><a href="#9-2-èµ„æºç›‘æ§â€”â€”Prometheuså’ŒGrafana" class="headerlink" title="9.2 èµ„æºç›‘æ§â€”â€”Prometheuså’ŒGrafana"></a>9.2 èµ„æºç›‘æ§â€”â€”Prometheuså’ŒGrafana</h3><h4 id="9-2-1-å®‰è£…Prometheus"><a href="#9-2-1-å®‰è£…Prometheus" class="headerlink" title="9.2.1 å®‰è£…Prometheus"></a>9.2.1 å®‰è£…Prometheus</h4><ol>
<li>è¿›è¡Œ RBAC æˆæƒ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.rbac.yml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½® ConfigMap</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.configmap.yml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>é…ç½® Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.deployment.yml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>é…ç½® SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.service.yml</span><br></pre></td></tr></table></figure>

<h4 id="9-2-2-å®‰è£…Grafana"><a href="#9-2-2-å®‰è£…Grafana" class="headerlink" title="9.2.2 å®‰è£…Grafana"></a>9.2.2 å®‰è£…Grafana</h4><ol>
<li>é…ç½® Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/grafana.deployment.yml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½® SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/grafana.service.yml</span><br></pre></td></tr></table></figure>

<h4 id="9-2-3-Prometheuså’ŒGrafanaçš„ä½¿ç”¨"><a href="#9-2-3-Prometheuså’ŒGrafanaçš„ä½¿ç”¨" class="headerlink" title="9.2.3 Prometheuså’ŒGrafanaçš„ä½¿ç”¨"></a>9.2.3 Prometheuså’ŒGrafanaçš„ä½¿ç”¨</h4><ol>
<li>æ·»åŠ æ•°æ®æº</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%B8%80.png" alt="ç›‘æ§ä¸€"></p>
<ol start="2">
<li>ä½¿ç”¨æ¨¡æ¿ï¼Œè¿™é‡Œä½¿ç”¨ä»£å·ä¸º 315 çš„ k8s ç›‘æ§æ¨¡æ¿</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%BA%8C.png" alt="ç›‘æ§äºŒ"></p>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%B8%89.png" alt="ç›‘æ§ä¸‰"></p>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E5%9B%9B.png" alt="ç›‘æ§å››"></p>
<ol start="3">
<li>æ•ˆæœ</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%BA%94.png" alt="ç›‘æ§äº”"></p>
<h3 id="9-3-æ—¥å¿—ç®¡ç†â€”â€”ElasticSearchã€Fluentdã€Kibana"><a href="#9-3-æ—¥å¿—ç®¡ç†â€”â€”ElasticSearchã€Fluentdã€Kibana" class="headerlink" title="9.3 æ—¥å¿—ç®¡ç†â€”â€”ElasticSearchã€Fluentdã€Kibana"></a>9.3 æ—¥å¿—ç®¡ç†â€”â€”ElasticSearchã€Fluentdã€Kibana</h3><p>k8s æ¨èé‡‡ç”¨ ElasticSearchã€Fluentdã€Kibanaï¼ˆç®€ç§°EFKï¼‰ä¸‰è€…ç»„åˆçš„æ–¹å¼ï¼Œå¯¹é›†ç¾¤çš„æ—¥å¿—è¿›è¡Œæ‰‹æœºå’ŒæŸ¥è¯¢ï¼Œå…³ç³»å¦‚ä¸‹ï¼š</p>
<ul>
<li>ElasticSearch æ˜¯ä¸€ç§æœç´¢å¼•æ“ï¼Œç”¨äºå­˜å‚¨æ—¥å¿—å¹¶è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
<li>Fluentd ç”¨äºå°†æ—¥å¿—æ¶ˆæ¯ä» k8s å‘é€åˆ° ElasticSearchã€‚</li>
<li>Kibana æ˜¯ä¸€ç§å›¾å½¢ç•Œé¢ï¼Œç”¨äºæŸ¥è¯¢ ElasticSearch ä¸­çš„æ—¥å¿—ã€‚</li>
</ul>
<p><img src="/2024/02/18/kubernetes/%E6%97%A5%E5%BF%97%E6%9E%B6%E6%9E%84.png" alt="æ—¥å¿—æ¶æ„"></p>
<p>EFK ä¹‹é—´çš„äº¤äº’å¦‚ä¸‹ï¼š</p>
<ul>
<li>å®¹å™¨è¿è¡Œæ—¶ä¼šå°†æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œå¹¶ä»¥ â€-json.logâ€œ ç»“å°¾å°†æ—¥å¿—æ–‡ä»¶å­˜æ”¾åˆ° <code>/var/lib/docker/containers</code> ç›®å½•ä¸­ï¼Œè€Œ <code>/var/log</code> æ˜¯ linux ç³»ç»Ÿçš„æ—¥å¿—ã€‚</li>
<li>åœ¨å„ä¸ª Node ä¸Šè¿è¡Œçš„ Fluentd å°†æ˜¯æ”¶é›†è¿™äº›æ—¥å¿—ï¼Œå¹¶å‘é€ç»™ ElasticSearchã€‚</li>
<li>Kibana æ˜¯ç›´æ¥ä¸ç”¨æˆ·äº¤äº’çš„ç•Œé¢ï¼Œå¯ä»¥æŸ¥è¯¢ ElasticSearch ä¸­çš„æ—¥å¿—ã€‚</li>
</ul>
<h4 id="9-3-1-å®‰è£…EFK"><a href="#9-3-1-å®‰è£…EFK" class="headerlink" title="9.3.1 å®‰è£…EFK"></a>9.3.1 å®‰è£…EFK</h4><ol>
<li>é…ç½®å‘½åç©ºé—´</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/create-logging-namespace.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½® Fluentd çš„ ConfigMap</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/fluentd-es-configmap.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å®‰è£… Fluentd</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/fluentd-es-ds.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å®‰è£… ElasticSearch</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/es-statefulset.yaml</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>é…ç½® ElasticSearch çš„ SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/es-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>å®‰è£… Kibana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/kibana-deployment.yaml</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>é…ç½® Kibana çš„ SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl applt -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/kibana-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>è·å– Kibana è®¿é—®åœ°å€</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info | grep Kibana</span><br></pre></td></tr></table></figure>



<h2 id="åã€é¡¹ç›®éƒ¨ç½²"><a href="#åã€é¡¹ç›®éƒ¨ç½²" class="headerlink" title="åã€é¡¹ç›®éƒ¨ç½²"></a>åã€é¡¹ç›®éƒ¨ç½²</h2><h3 id="10-1-æ— çŠ¶æ€é¡¹ç›®éƒ¨ç½²"><a href="#10-1-æ— çŠ¶æ€é¡¹ç›®éƒ¨ç½²" class="headerlink" title="10.1 æ— çŠ¶æ€é¡¹ç›®éƒ¨ç½²"></a>10.1 æ— çŠ¶æ€é¡¹ç›®éƒ¨ç½²</h3><p>Guestbook æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„å¤šå±‚ Web åº”ç”¨ç¨‹åºï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„ç•™è¨€æ¿ç¨‹åºï¼ŒåŒ…å«ä¸€ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¹¶æ‹¥æœ‰è¯»å†™åˆ†ç¦»æœºåˆ¶ï¼š</p>
<ol>
<li>å‰ç«¯åº”ç”¨ï¼šGuestbook ç•™è¨€æ¿åº”ç”¨ï¼Œå°†éƒ¨ç½²å¤šä¸ªå®ä¾‹ä¾›ç”¨æˆ·è®¿é—®ã€‚</li>
<li>åç«¯å­˜å‚¨ï¼ˆå†™ï¼‰ï¼šRedis ä¸»åº”ç”¨ï¼Œç”¨äºå†™å…¥ç•™è¨€ä¿¡æ¯ï¼Œåªéƒ¨ç½²ä¸€ä¸ªæ¡ˆä¾‹ã€‚</li>
<li>åç«¯å­˜å‚¨ï¼ˆè¯»ï¼‰ï¼šRedis ä»å±åº”ç”¨ï¼Œç”¨åŸŸè¯»å–ç•™è¨€ä¿¡æ¯ï¼Œå°†éƒ¨ç½²å¤šä¸ªæ¡ˆä¾‹ã€‚</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" alt="æ— çŠ¶æ€æœåŠ¡æ¶æ„"></p>
<ol>
<li>éƒ¨ç½² Redis ä¸»å®ä¾‹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-master-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-master-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>éƒ¨ç½² Redis ä¸»å®ä¾‹ SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>éƒ¨ç½² Redis ä»å±å®ä¾‹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-slave-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-slave-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-slave-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>éƒ¨ç½² Redis ä»å±å®ä¾‹ SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-slave-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>éƒ¨ç½² Guestbook</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">guestbook-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">guestbook-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">guestbook-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubeguide/guestbook-php-frontend</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>éƒ¨ç½² Guestbook çš„ SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">guestbook-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30222</span></span><br></pre></td></tr></table></figure>

<h3 id="10-2-æœ‰çŠ¶æ€é¡¹ç›®éƒ¨ç½²"><a href="#10-2-æœ‰çŠ¶æ€é¡¹ç›®éƒ¨ç½²" class="headerlink" title="10.2 æœ‰çŠ¶æ€é¡¹ç›®éƒ¨ç½²"></a>10.2 æœ‰çŠ¶æ€é¡¹ç›®éƒ¨ç½²</h3><p>WordPress æ˜¯ä½¿ç”¨ PHP å¼€å‘çš„å¼€æºä¸ªäººåšå®¢å¹³å°ï¼Œæ˜¯ä¸€å¥—éå¸¸å®Œå–„çš„å†…å®¹ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒéå¸¸ä¸°å¯Œçš„æ’ä»¶å’Œæ¨¡æ¿ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>å‰ç«¯åº”ç”¨ï¼šWordPressã€‚</li>
<li>åç«¯åº”ç”¨ï¼šMySQL æ•°æ®åº“ï¼Œä½¿ç”¨ PVC æ¥å­˜å‚¨åšå®¢çš„æ•°æ®ã€‚</li>
</ul>
<p><img src="/2024/02/18/kubernetes/%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" alt="æœ‰çŠ¶æ€æœåŠ¡æ¶æ„"></p>
<ol>
<li>é¦–å…ˆç”Ÿæˆä¸€ä¸ªæ•°æ®åº“å¯†ç </li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &#x27;toortoor&#x27; | base64</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºä¸€ä¸ª Secret å­˜æ”¾å¯†ç </li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Qpaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mysql_password:</span> <span class="string">dG9vcnRvb3I=</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>éƒ¨ç½² nfs-clientï¼Œå®ç°è‡ªåŠ¨åˆ†é… PV ç»™ PVCï¼Œæ­¥éª¤å‚ç…§ 6.3.2</li>
<li>éƒ¨ç½² MySQL</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storageclass</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/mysql:5.7</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_password</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-datadir</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>éƒ¨ç½² WordPress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30111</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-pvc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storageclass</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">wordpress-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/daocloud/dao-wordpress:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œç”¨åˆ°äº†MySQLçš„å˜é‡å‚æ•°</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># Mysqlçš„SVCåç§°</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">mysql-service</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_password</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/www/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-datadir</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">wordpress-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>éƒ¨ç½² Ingressï¼Œé€šè¿‡ <code>www.cqm.com:30111</code> å°±èƒ½è®¿é—® WordPress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/var/www/html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">wordpress-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">30111</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>æµ‹è¯•</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E4%B8%80.png" alt="æœ‰çŠ¶æ€æœåŠ¡ä¸€"></p>
<h3 id="10-3-ä½¿ç”¨Helméƒ¨ç½²é¡¹ç›®"><a href="#10-3-ä½¿ç”¨Helméƒ¨ç½²é¡¹ç›®" class="headerlink" title="10.3 ä½¿ç”¨Helméƒ¨ç½²é¡¹ç›®"></a>10.3 ä½¿ç”¨Helméƒ¨ç½²é¡¹ç›®</h3><p>Helm æ˜¯ k8s çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œæ˜¯ä¸€ç§ k8s åŒ…ç®¡ç†å¹³å°ï¼Œå®ƒèƒ½å¤Ÿå®šä¹‰ã€éƒ¨ç½²ã€å‡çº§éå¸¸å¤æ‚çš„ k8s åº”ç”¨é›†åˆï¼Œå¹¶è¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚</p>
<p><img src="/2024/02/18/kubernetes/Helm%E6%9E%B6%E6%9E%84.png" alt="Helmæ¶æ„"></p>
<ul>
<li>Helm å®¢æˆ·ç«¯ï¼šæ˜¯ä¸€ç§è¿œç¨‹å‘½ä»¤å®¢æˆ·ç«¯å·¥å…·ï¼Œä¸»è¦ç”¨äº Chart æ–‡ä»¶çš„åˆ›å»ºã€æ‰“åŒ…å’Œå‘å¸ƒéƒ¨ç½²ï¼Œä»¥åŠå’Œ Chart ä»“åº“çš„ç®¡ç†ã€‚Helm å‘å‡ºçš„è¯·æ±‚ï¼Œæ ¹æ® Chart ç»“æ„ç”Ÿæˆå‘å¸ƒå¯¹è±¡ï¼Œå¹¶å°† Chart è§£ææˆå„ä¸ª k8s èµ„æºçš„å®é™…éƒ¨ç½²æ–‡ä»¶ï¼Œä¾› k8s åˆ›å»ºç›¸åº”èµ„æºï¼ŒåŒæ—¶è¿˜æä¾›å‘å¸ƒå¯¹è±¡çš„æ›´æ–°ã€å›æ»šã€ç»Ÿä¸€åˆ é™¤ç­‰åŠŸèƒ½ã€‚</li>
<li>Chartï¼šæ˜¯åº”ç”¨ç¨‹åºçš„éƒ¨ç½²å®šä¹‰ï¼ŒåŒ…å«å„ç§ yaml æ–‡ä»¶ï¼Œå¯ä»¥é‡‡ç”¨ TAR æ ¼å¼æ‰“åŒ…ã€‚</li>
<li>Chart ä»“åº“ï¼šHelm ä¸­å­˜æ”¾äº†å„ç§åº”ç”¨ç¨‹åºçš„ Chart åŒ…ä»¥ä¾›ç”¨æˆ·ä¸‹è½½ï¼ŒHelm å¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ª Chart ä»“åº“ï¼Œé»˜è®¤æƒ…å†µä¸‹ç®¡ç†ä¸€ä¸ªæœ¬åœ°ä»“åº“å’Œä¸€ä¸ªè¿œç¨‹ä»“åº“ã€‚</li>
<li>å‘å¸ƒå¯¹è±¡ï¼šåœ¨ k8s é›†ç¾¤ä¸­éƒ¨ç½²çš„ Chart ç§°ä¸ºå‘å¸ƒå¯¹è±¡ï¼ŒChart å’Œå‘å¸ƒå¯¹è±¡çš„å…³ç³»ç±»ä¼¼äºé•œåƒå’Œå®¹å™¨ï¼Œå‰è€…æ˜¯éƒ¨ç½²çš„å®šä¹‰ï¼Œåè€…æ˜¯å®é™…éƒ¨ç½²å¥½çš„åº”ç”¨ç¨‹åºã€‚</li>
</ul>
<h4 id="10-3-1-Helmå®‰è£…"><a href="#10-3-1-Helmå®‰è£…" class="headerlink" title="10.3.1 Helmå®‰è£…"></a>10.3.1 Helmå®‰è£…</h4><ol>
<li>å®‰è£…</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.6.2-linux-amd64.tar.gz</span><br><span class="line">tar -xf helm-v3.6.2-linux-amd64.tar.gz</span><br><span class="line">cp linux-amd64/helm /usr/local/bin/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è®¾ç½®ç¯å¢ƒå˜é‡ KUBECONFIG æ¥æŒ‡å®šå­˜æœ‰ ApiServre çš„åœ°å€ä¸ token çš„é…ç½®æ–‡ä»¶åœ°å€ï¼Œé»˜è®¤ä¸º~&#x2F;.kube&#x2F;config</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/root/.kube/config</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>é…ç½® Helm ä»“åº“</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">helm repo add incubator https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/</span><br></pre></td></tr></table></figure>

<h4 id="10-3-2-Helm-Chartçš„åŸºæœ¬æ“ä½œ"><a href="#10-3-2-Helm-Chartçš„åŸºæœ¬æ“ä½œ" class="headerlink" title="10.3.2 Helm Chartçš„åŸºæœ¬æ“ä½œ"></a>10.3.2 Helm Chartçš„åŸºæœ¬æ“ä½œ</h4><p><strong>Chart çš„åˆ›å»º</strong></p>
<ol>
<li>åˆ›å»º Chart</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create chartåç§°</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æ‰§è¡Œåä¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ç”¨ tree å‘½ä»¤æŸ¥çœ‹è¯¥ç›®å½•ç»“æ„</li>
</ol>
<p><img src="/2024/02/18/kubernetes/Helm%E4%B8%80.png" alt="Helmä¸€"></p>
<ul>
<li>charsï¼šå­˜æ”¾è¯¥ Chart ä»¥æ¥çš„æ‰€æœ‰å­ Chart çš„ç›®å½•ï¼Œè¿™äº›å­ Chart ä¹Ÿæ‹¥æœ‰è¿™ 4 ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæœ‰å­ Chart ï¼Œåˆ™éœ€è¦åœ¨çˆ¶ Chart åˆ›å»ºä¸€ä¸ª <code>requirements.yaml</code> æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­è®°å½•è¿™äº›å­ Chartã€‚</li>
<li>Chart.yamlï¼šè®°å½•è¯¥ Chart çš„ç›¸å…³ä¿¡æ¯ï¼Œå¹¶å®šä¹‰åœ¨æ–‡ä»¶ä¸­çš„ <code>.Chart</code> å¼€å¤´çš„å±æ€§å€¼ã€‚</li>
<li>templateï¼šå­˜æ”¾äº† k8s éƒ¨ç½²æ–‡ä»¶çš„ Helm æ¨¡æ¿ï¼Œå…¶ä¸­æ‰©å±•äº† Go Template è¯­æ³•ã€‚</li>
<li>values.yamlï¼šå®šä¹‰åœ¨æ–‡ä»¶ä¸­çš„ <code>.Values</code> å¼€å¤´çš„å±æ€§å€¼ã€‚</li>
<li>_helpers.tplï¼šå®ƒæ˜¯ä¸€ä¸ªiæ¨¡æ¿åŠ©æ‰‹æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰é€šç”¨ä¿¡æ¯ï¼Œç„¶ååœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚</li>
<li>NOTES.txtï¼šä¼šåœ¨ Chart éƒ¨ç½²å‘½ä»¤åï¼Œä»£å…¥å…·ä½“çš„å‚æ•°å€¼ï¼Œäº§ç”Ÿè¯´æ˜ä¿¡æ¯ã€‚</li>
<li>test-connection.yamlï¼šç”¨äºå®šä¹‰éƒ¨ç½²å®Œæˆåéœ€è¦æ‰§è¡Œçš„æµ‹è¯•å†…å®¹ï¼Œä»¥ä¾¿æµ‹è¯•æ˜¯å¦éƒ¨ç½²æˆåŠŸã€‚</li>
</ul>
<p><strong>Chart çš„éªŒè¯</strong></p>
<ol>
<li>åœ¨å‘å¸ƒ Chart ä¹‹å‰ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤æ£€æŸ¥ Chart æ–‡ä»¶æ˜¯å¦æœ‰è¯¯ï¼Œå¦‚ä¸‹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm lint chartç›®å½•/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åŒæ—¶ä¹Ÿå¯ä»¥ç”¨å‘½ä»¤å°†å„é¡¹å€¼ç»„åˆä¸º k8s çš„ yaml æ–‡ä»¶ï¼ŒæŸ¥çœ‹æ˜¯å¦ä¸ºé¢„æœŸå†…å®¹ï¼Œæ¯”å¦‚ä¸‹å›¾å°±æ˜¯å…¶ä¸­ Deployment çš„å†…å®¹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install --dry-run --debug å‘å¸ƒåç§° -name chartç›®å½•åç§°</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/Helm%E4%BA%8C.png" alt="HelmäºŒ"></p>
<p><strong>Chart çš„å‘å¸ƒ</strong></p>
<ol>
<li>Chart çš„å‘å¸ƒå‘½ä»¤å¦‚ä¸‹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install å‘å¸ƒç‰ˆæœ¬åç§° chartæ–‡ä»¶ç›®å½•</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æŸ¥çœ‹ç›®å‰å‘å¸ƒçš„ç‰ˆæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm list</span><br></pre></td></tr></table></figure>

<p><strong>å°† Chart æ‰“åŒ…åˆ°ä»“åº“ä¸­</strong></p>
<ol>
<li>æŸ¥çœ‹ä»“åº“å‘½ä»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æŸ¥çœ‹ä»“åº“ä¸­çš„åŒ…</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm search repo/hub</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¹Ÿå¯ä»¥åœ¨åé¢åŠ ä¸Šåº”ç”¨åï¼Œå¦‚</span></span><br><span class="line">helm search repo/hub nginx</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>é¦–å…ˆæ‰“åŒ…</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm package chartç›®å½•</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å®‰è£… Push æ’ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm plugin install https://github.com/chartmuseum/helm-push.git</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>ä¸Šä¼ </li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm push taråŒ…å ä»“åº“</span><br></pre></td></tr></table></figure>

<p><strong>å‘å¸ƒç‰ˆæœ¬çš„æ›´æ–°ã€å›æ»šå’Œåˆ é™¤</strong></p>
<ol>
<li>æ›´æ–°</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade å‘å¸ƒç‰ˆæœ¬åç§° chartç›®å½•æˆ–tar flags</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æŸ¥çœ‹å†å²ç‰ˆæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm history å‘å¸ƒç‰ˆæœ¬åç§°</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å›æ»š</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm rollback å‘å¸ƒç‰ˆæœ¬åç§° ç‰ˆæœ¬å·</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>åˆ é™¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete å‘å¸ƒç‰ˆæœ¬åç§°</span><br></pre></td></tr></table></figure>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/NUX_Octodex.gif" alt="Warner"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">25</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">18</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqmmm/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-30T13:23:16.000Z">2024-03-30</time></p><p class="title"><a href="/2024/03/30/CoreDNS%E5%92%8CNodeLocalDNS%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/">CoreDNSå’ŒNodeLocalDNSçš„åŸŸåè§£æ</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-30T11:51:11.000Z">2024-03-30</time></p><p class="title"><a href="/2024/03/30/kube-proxy%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">kube-proxyå·¥ä½œåŸç†</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-30T11:07:40.000Z">2024-03-30</time></p><p class="title"><a href="/2024/03/30/CNI%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/">CNIå·¥ä½œæµç¨‹</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-30T09:01:48.000Z">2024-03-30</time></p><p class="title"><a href="/2024/03/30/CSI%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/">CSIå·¥ä½œæµç¨‹</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-19T14:51:49.000Z">2024-03-19</time></p><p class="title"><a href="/2024/03/19/etcd-leader%E9%80%89%E4%B8%BE/">etcd leaderé€‰ä¸¾</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/container/"><span class="tag">container</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/containerd/"><span class="tag">containerd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/etcd/"><span class="tag">etcd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">é¦–é¡µ</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2024 Warner</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>