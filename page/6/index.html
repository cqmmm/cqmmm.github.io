<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Warner&#039;s Wiki"><meta property="og:url" content="https://cqmmm.github.io/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cqmmm.github.io/img/og_image.png"><meta property="article:author" content="Warner"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cqmmm.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqmmm.github.io"},"headline":"Warner's Wiki","image":["https://cqmmm.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Warner"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://cqmmm.github.io/logo.jpg"}},"description":""}</script><link rel="icon" href="/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T08:31:44.427Z" title="2/18/2024, 4:31:44 PM">2024-02-18</time></span><span class="level-item">2 hours read (About 13895 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/">linux基础网络服务</a></p><div class="content"><h2 id="一、DHCP服务"><a href="#一、DHCP服务" class="headerlink" title="一、DHCP服务"></a>一、DHCP服务</h2><h3 id="1-1-DHCP服务介绍"><a href="#1-1-DHCP服务介绍" class="headerlink" title="1.1 DHCP服务介绍"></a>1.1 DHCP服务介绍</h3><p>DHCP服务即动态主机配置协议，被运用在局域网中，主要的作用是分配IP地址。</p>
<p>DHCP服务采用的是UDP协议，发送采用UDP67端口，接受则采用UDP68端口。</p>
<h3 id="1-2-DHCP服务部署"><a href="#1-2-DHCP服务部署" class="headerlink" title="1.2 DHCP服务部署"></a>1.2 DHCP服务部署</h3><ol>
<li>安装DHCP</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install dhcp</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>DHCP配置文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/doc/dhcp*/dhcpd.conf.example /etc/dhcp/dhcpd.conf</span><br><span class="line">cat /etc/dhcp/dhcpd.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DHCP服务配置文件分为全局配置和作用域配置，很好区分：subnet的就是作用域 不在subnet里面的就是全局设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dhcpd.conf</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Sample configuration file for ISC dhcpd</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DNS全局选项，指定DNS服务器的地址，可以是IP，也可以是域名。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option definitions common to all supported networks...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DNS的域名</span></span><br><span class="line">option domain-name &quot;example.org&quot;;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">具体的DNS服务器</span></span><br><span class="line">option domain-name-servers ns1.example.org, ns2.example.org;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">租约设置，默认租约为600s</span></span><br><span class="line">default-lease-time 600;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">租约设置，最大租约为7200s，当客户端未请求明确的租约时间。</span></span><br><span class="line">max-lease-time 7200;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">动态DNS更新方式(none:不支持；interim:互动更新模式；ad-hoc:特殊更新模式)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Use this to enble / <span class="built_in">disable</span> dynamic dns updates globally.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ddns-update-style none;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果该DHCP服务器是本地官方DHCP就将此选项打开，避免其他DHCP服务器的干扰。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当一个客户端试图获得一个不是该DHCP服务器分配的IP信息，DHCP将发送一个拒绝消息，而不会等待请求超时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当请求被拒绝，客户端会重新向当前DHCP发送IP请求获得新地址。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保证IP是自己发出去的</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If this DHCP server is the official DHCP server for the local</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network, the authoritative directive should be uncommented.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启此项表权威DHCP</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">authoritative;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Use this to send dhcp <span class="built_in">log</span> messages to a different <span class="built_in">log</span> file (you also</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">have to hack syslog.conf to complete the redirection).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志级别</span></span><br><span class="line">log-facility local7;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">No service will be given on this subnet, but declaring it helps the</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DHCP server to understand the network topology.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">作用域相关设置指令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">subnet 定义一个作用域</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">netmask 定义作用域的掩码</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">range 允许发放的IP范围</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option routers 指定网关地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option domain-name-servers 指定DNS服务器地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option broadcast-address 广播地址</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例:定义一个作用域 网段为10.152.187.0 掩码为255.255.255.0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此作用域不提供任何服务</span></span><br><span class="line">subnet 10.152.187.0 netmask 255.255.255.0 &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a very basic subnet declaration.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例:定义一个基本的作用域</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网段10.254.239.0 掩码255.255.255.224</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分发范围10.254.239.10-20</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网关为rtr-239-0-1.example.org, rtr-239-0-2.example.org</span></span><br><span class="line">subnet 10.254.239.0 netmask 255.255.255.224 &#123;</span><br><span class="line">  range 10.254.239.10 10.254.239.20;</span><br><span class="line">  option routers rtr-239-0-1.example.org, rtr-239-0-2.example.org;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This declaration allows BOOTP clients to get dynamic addresses,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">which</span> we don<span class="string">&#x27;t really recommend.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:允许采用bootp协议的客户端动态获得地址</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">bootp DHCP的前身</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">BOOTP用于无盘工作站的局域网中，可以让无盘工作站从一个中心服务器上获得IP地址。通过BOOTP协议可以为局域网中的无盘工作站分配动态IP地址，</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">这样就不需要管理员去为每个用户去设置静态IP地址。</span></span></span><br><span class="line">subnet 10.254.239.32 netmask 255.255.255.224 &#123;</span><br><span class="line">  range dynamic-bootp 10.254.239.40 10.254.239.60;</span><br><span class="line">  option broadcast-address 10.254.239.31;</span><br><span class="line">  option routers rtr-239-32-1.example.org;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:一个简单的作用域案例</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">A slightly different configuration for an internal subnet.</span></span></span><br><span class="line">subnet 10.5.5.0 netmask 255.255.255.224 &#123;</span><br><span class="line">  range 10.5.5.26 10.5.5.30;</span><br><span class="line">  option domain-name-servers ns1.internal.example.org;</span><br><span class="line">  option domain-name &quot;internal.example.org&quot;;</span><br><span class="line">  option routers 10.5.5.1;</span><br><span class="line">  option broadcast-address 10.5.5.31;</span><br><span class="line">  default-lease-time 600;</span><br><span class="line">  max-lease-time 7200;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Hosts which require special configuration options can be listed in</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">host statements.   If no address is specified, the address will be</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">allocated dynamically (if possible), but the host-specific information</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">will still come from the host declaration.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># 保留地址:可以将指定的IP分发给指定的机器，根据网卡的MAC地址来做触发</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">host: 启用保留。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">hardware:指定客户端的mac地址</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">filename:指定文件名</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">server-name:指定下一跳服务器地址</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">fixed-address: 指定保留IP地址</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:这个案例中分发给客户端的不是IP地址信息，而是告诉客户端去找toccata.fugue.com服务器，并且下载vmunix.passacaglia文件</span></span></span><br><span class="line">host passacaglia &#123;</span><br><span class="line">  hardware ethernet 0:0:c0:5d:bd:95;</span><br><span class="line">  filename &quot;vmunix.passacaglia&quot;;</span><br><span class="line">  server-name &quot;toccata.fugue.com&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Fixed IP addresses can also be specified for hosts.   These addresses</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">should not also be listed as being available for dynamic assignment.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Hosts for which fixed IP addresses have been specified can boot using</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">BOOTP or DHCP.   Hosts for which no fixed address is specified can only</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">be booted with DHCP, unless there is an address range on the subnet</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">to which a BOOTP client is connected which has the dynamic-bootp flag</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">set.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:保留地址，将指定IP(fantasia.fugue.com对应的IP)分给指定客户端网卡(MAC:08:00:07:26:c0:a5)</span></span></span><br><span class="line">host fantasia &#123;</span><br><span class="line">  hardware ethernet 08:00:07:26:c0:a5;</span><br><span class="line">  fixed-address fantasia.fugue.com;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">超级作用域</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">超级作用域是DHCP服务中的一种管理功能，使用超级作用域，可以将多个作用域组合为单个管理实体。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">You can declare a class of clients and then do address allocation</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">based on that.   The example below shows a case where all clients</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">in a certain class get addresses on the 10.17.224/24 subnet, and all</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">other clients get addresses on the 10.0.29/24 subnet.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">在局域网中，可以配置策略根据各个机器的具体信息分配IP地址和其他的网络参数，客户机的具体信息：客户机能够给dhcp服务提供的信息由两个，</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">第一个就是网卡的dhcp-client-identifier（mac地址），</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">第二个就是设备的vendor-class-identifier。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">管理员可以根据这两个信息给不同的机器分组。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">按client某种类型分组DHCP,而不是按物理接口网段</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">例子: SUNW 分配地址段10.17.224.0/24</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">     非SUNW的主机,分配地址段10.0.29.0/24</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义一个dhcp类:foo</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">request广播中vendor-class-identifier字段对应的值前四个字节如果是&quot;SUNW&quot;,则视合法客户端.</span></span></span><br><span class="line">class &quot;foo&quot; &#123;</span><br><span class="line">  match if substring (option vendor-class-identifier, 0, 4) = &quot;SUNW&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义一个超级作用域: 224-29</span></span></span><br><span class="line">shared-network 224-29 &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义第一个作用域</span></span></span><br><span class="line">  subnet 10.17.224.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    option routers rtr-224.example.org;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义第二个作用域</span></span></span><br><span class="line">  subnet 10.0.29.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    option routers rtr-29.example.org;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">关连池,如果客户端匹配foo类，将获得该池地址</span></span></span><br><span class="line">  pool &#123;</span><br><span class="line">    allow members of &quot;foo&quot;;</span><br><span class="line">    range 10.17.224.10 10.17.224.250;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">关连池,如果客户端配置foo类，则拒绝获得该段地址</span></span></span><br><span class="line">  pool &#123;</span><br><span class="line">    deny members of &quot;foo&quot;;</span><br><span class="line">    range 10.0.29.10 10.0.29.230;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置作用域"><a href="#1-3-配置作用域" class="headerlink" title="1.3 配置作用域"></a>1.3 配置作用域</h3><ol>
<li>配置作用域</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">subnet 192.168.88.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    range 192.168.88.150 192.168.88.160; # 发放地址范围</span><br><span class="line">    option routers 192.168.88.0; # 网关</span><br><span class="line">    option broadcast-address 192.168.88.255; # 广播地址</span><br><span class="line">    option domain-name-servers 8.8.8.8, 114.114.114.114; # 设置DNS</span><br><span class="line">    default-lease-time 7200; # 默认租约2小时</span><br><span class="line">    max-lease-time 10800; # 最大租约3小时</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将另一台主机网卡设置为DHCP模式</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%B8%80.png" alt="DHCP一"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启网络服务</span></span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>用dhclient命令进行测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">释放IP</span></span><br><span class="line">dhclient -r ens33</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取IP</span></span><br><span class="line">dhclient -d ens33</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%BA%8C.png" alt="DHCP二"></p>
<ol start="4">
<li>查看是否获取了150-160网段内的地址</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%B8%89.png" alt="DHCP三"></p>
<h3 id="1-4-保留地址"><a href="#1-4-保留地址" class="headerlink" title="1.4 保留地址"></a>1.4 保留地址</h3><p>当租约到期的时候，client端只能乖乖交出IP地址，下一次获取就未必是同样的地址了，但公司中往往有些机器要用固定的地址，例如打印机、文件服务器等等，所以在DHCP中可以设置保留地址为其使用。</p>
<p>DHCP是根据主机网卡的MAC地址来做匹配，将保留的IP地址分给相应的主机网卡MAC地址。</p>
<ol>
<li>获取网卡MAC地址</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E5%9B%9B.png" alt="DHCP四"></p>
<ol start="2">
<li>添加保留地址配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dhcp/dhcpd.conf</span><br><span class="line">host fantasia &#123;</span><br><span class="line">    hardware ethernet 00:0c:29:6c:6f:0d;</span><br><span class="line">    fixed-address 192.168.88.155;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看是否获取相应地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dhclient -r ens37</span><br><span class="line">dhclient -d ens37</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%BA%94.png" alt="DHCP五"></p>
<h3 id="1-5-超级作用域"><a href="#1-5-超级作用域" class="headerlink" title="1.5 超级作用域"></a>1.5 超级作用域</h3><p>超级作用域简单来说就是将两个或两个以上的不同网段的作用域合成一个作用域。</p>
<ol>
<li>添加超级作用域</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加作用域之前DHCP必须拥有两个网段的网卡</span></span><br><span class="line">shared-network supernet &#123;</span><br><span class="line"></span><br><span class="line">   subnet 192.168.88.0 netmask 255.255.255.0 &#123;</span><br><span class="line">       range 192.168.88.150 192.168.88.160;</span><br><span class="line">       option routers 192.168.88.2;</span><br><span class="line">       option broadcast-address 192.168.88.255;</span><br><span class="line">       option domain-name-servers 8.8.8.8, 114.114.114.114;</span><br><span class="line">       default-lease-time 7200;</span><br><span class="line">       max-lease-time 10800;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   subnet 192.168.99.0 netmask 255.255.255.0 &#123;</span><br><span class="line">       range 192.168.99.150 192.168.99.160;</span><br><span class="line">       option routers 192.168.99.0;</span><br><span class="line">       option broadcast-address 192.168.99.255;</span><br><span class="line">       option domain-name-servers 8.8.8.8, 114.114.114.114;</span><br><span class="line">       default-lease-time 7200;</span><br><span class="line">       max-lease-time 10800;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="二、DNS服务"><a href="#二、DNS服务" class="headerlink" title="二、DNS服务"></a>二、DNS服务</h2><h3 id="2-1-DNS服务介绍"><a href="#2-1-DNS服务介绍" class="headerlink" title="2.1 DNS服务介绍"></a>2.1 DNS服务介绍</h3><p>DNS即域名系统，在互联网中为域名和IP地址进行相互映射的一个分布式数据库。</p>
<p>DNS采用UDP协议，使用UDP53端口进行传输。</p>
<p>DNS记录类型：</p>
<ul>
<li>A：ipv4 记录，将域名映射到 ipv4 地址</li>
<li>AAAA：ipv6 记录，将域名映射到 ipv6 地址</li>
<li>CNAME：别名记录，将域名映射到另一个域名</li>
<li>MX：电邮交互记录，将域名映射到邮件服务器地址</li>
<li>TXT：文本记录，是任意可读的文本 DNS 记录</li>
<li>SRV：服务器资源记录，用来标识某个服务器使用了某个服务，创建于微软系统的目录管理</li>
<li>NS：名称服务器记录，支持将子域名委托给其他 DNS 服务商解析</li>
<li>CAA：CAA 资源记录，可以限定域名颁发证书和 CA 之间的关系</li>
</ul>
<h3 id="2-2-DNS服务部署"><a href="#2-2-DNS服务部署" class="headerlink" title="2.2 DNS服务部署"></a>2.2 DNS服务部署</h3><ol>
<li>安装DNS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bind-chroot是<span class="built_in">bind</span>的一个功能,使<span class="built_in">bind</span>可以在一个<span class="built_in">chroot</span>的模式下运行.也就是说,<span class="built_in">bind</span>运行时的/(根)目录,并不是系统真正的/(根)目录,只是系统中的一个子目录而已.这样做的目的是为了提高安全性.因为在<span class="built_in">chroot</span>的模式下,<span class="built_in">bind</span>可以访问的范围仅限于这个子目录的范围里,无法进一步提升,进入到系统的其他目录中。<span class="built_in">bind</span>的默认启动方式就是<span class="built_in">chroot</span>方式。</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将配置文件和区域数据库文件拷贝到chroot目录下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp -p /etc/named.conf /var/named/chroot/etc/</span><br><span class="line">cp -pr /var/named/name* /var/named/chroot/var/named/</span><br><span class="line">chown -R named:named /var/named/chroot/*</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置文件 /var/named/chroot/etc/named.conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">区域数据库文件 /var/named/chroot/var/named/</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> Sample named.conf BIND DNS server &#x27;named&#x27; configuration file</span><br><span class="line"> for the Red Hat BIND distribution.</span><br><span class="line"> See the BIND Administrator&#x27;s Reference Manual (ARM) for details about the</span><br><span class="line"> configuration located in /usr/share/doc/bind-&#123;version&#125;/Bv9ARM.html</span><br><span class="line">*/</span><br><span class="line">options</span><br><span class="line">&#123;</span><br><span class="line">    // Put files that named is allowed to write in the data/ directory:</span><br><span class="line">        #指定区域数据库文件的路径目录</span><br><span class="line">    directory         &quot;/var/named&quot;;        // &quot;Working&quot; directory</span><br><span class="line">    #CACHE文件路径,指定服务器在收到rndc dump命令时，转储数据到文件的路径。默认named_dump.db</span><br><span class="line">    dump-file         &quot;data/cache_dump.db&quot;;</span><br><span class="line">    #静态文件路径,指定服务器在收到rndc stats命令时，追加统计数据的文件路径。默认named.stats</span><br><span class="line">        statistics-file     &quot;data/named_stats.txt&quot;;</span><br><span class="line">    #内存静态文件路径,服务器在退出时，将内存统计写到文件的路径。默认named.memstats</span><br><span class="line">        memstatistics-file     &quot;data/named_mem_stats.txt&quot;;</span><br><span class="line">    # 指定服务器在通过rndc recursing命令指定转储当前递归请求到的文件路径。默认named.recursing</span><br><span class="line">    recursing-file        &quot;data/named.recursing&quot;;</span><br><span class="line">    #在收到rndc secroots指令后，服务器转储安全根的目的文件的路径名。默认named.secroots</span><br><span class="line">    secroots-file        &quot;data/named.secroots&quot;;</span><br><span class="line">    /*</span><br><span class="line">      Specify listenning interfaces. You can use list of addresses (&#x27;;&#x27; is</span><br><span class="line">      delimiter) or keywords &quot;any&quot;/&quot;none&quot;</span><br><span class="line">    */</span><br><span class="line">    #IPV4监听端口为53,允许任何人连接</span><br><span class="line">    //listen-on port 53    &#123; any; &#125;;</span><br><span class="line">    #IPv4监听端口为53，只允许本机连接</span><br><span class="line">    listen-on port 53    &#123; 127.0.0.1; &#125;;</span><br><span class="line">    #IPV6监听端口为53,允许任何人连接</span><br><span class="line">    //listen-on-v6 port 53    &#123; any; &#125;;</span><br><span class="line">    #IPv6监听端口为53，只允许本机连接</span><br><span class="line">    listen-on-v6 port 53    &#123; ::1; &#125;;</span><br><span class="line">    /*</span><br><span class="line">      访问控制</span><br><span class="line">      Access restrictions</span><br><span class="line">          两个重要选项</span><br><span class="line">      There are two important options:</span><br><span class="line">        allow-query &#123; argument; &#125;;</span><br><span class="line">          - allow queries for authoritative data</span><br><span class="line">        允许查询来自权威数据</span><br><span class="line">        allow-query-cache &#123; argument; &#125;;</span><br><span class="line">          - allow queries for non-authoritative data (mostly cached data)</span><br><span class="line">        允许查询来自非权威数据</span><br><span class="line">      You can use address, network address or keywords &quot;any&quot;/&quot;localhost&quot;/&quot;none&quot; as argument</span><br><span class="line">      大括号中可以使用IP地址、网段、或者关键字 any任何人   localhost本机  none任何人不允许</span><br><span class="line">      Examples:</span><br><span class="line">        allow-query &#123; localhost; 10.0.0.1; 192.168.1.0/8; &#125;;</span><br><span class="line">        allow-query-cache &#123; ::1; fe80::5c63:a8ff:fe2f:4526; 10.0.0.1; &#125;;</span><br><span class="line">    */</span><br><span class="line">    #指定允许哪些主机可以进行普通的DNS查询,可以是关键字:any/localhost/none,也可以是IPV4,IPV6地址</span><br><span class="line">    allow-query        &#123; localhost; &#125;;</span><br><span class="line">    #指定允许哪些主机可以对缓存的访问</span><br><span class="line">    allow-query-cache    &#123; localhost; &#125;;</span><br><span class="line">    /* Enable/disable recursion - recursion yes/no;</span><br><span class="line">        递归查询开关</span><br><span class="line">     - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.</span><br><span class="line">    假如你建立的是一个权威DNS你不需要开启递归</span><br><span class="line">     - If you are building a RECURSIVE (caching) DNS server, you need to enable </span><br><span class="line">       recursion. </span><br><span class="line">    假如你建立的是一个递归DNS,你需要开启递归服务</span><br><span class="line">     - If your recursive DNS server has a public IP address, you MUST enable access </span><br><span class="line">    如果你的递归DNS是具有公网IP，你必须要设置访问控制来限制对合法用户的查询.</span><br><span class="line">       control to limit queries to your legitimate users. Failing to do so will</span><br><span class="line">       cause your server to become part of large scale DNS amplification </span><br><span class="line">    否者你的DNS会被大规模的攻击</span><br><span class="line">       attacks. Implementing BCP38 within your network would greatly</span><br><span class="line">    在您的网络中实现BCP38将非常重要减少此类攻击面</span><br><span class="line">       reduce such attack surface </span><br><span class="line">     */</span><br><span class="line">    #开启递归</span><br><span class="line">    recursion yes;</span><br><span class="line">    #Domain Name System Security Extensions (DNS安全扩展）</span><br><span class="line">    /* DNSSEC related options. See information about keys (&quot;Trusted keys&quot;, bellow) */</span><br><span class="line">    /* Enable serving of DNSSEC related data - enable on both authoritative</span><br><span class="line">        and recursive servers DNSSEC aware servers */</span><br><span class="line">    #开启DNSSEC在权威或者递归服务器之间信任服务</span><br><span class="line">    dnssec-enable yes;</span><br><span class="line">    /* Enable DNSSEC validation on recursive servers */</span><br><span class="line">    #开启DNSSEC验证在递归服务器</span><br><span class="line">    dnssec-validation yes;</span><br><span class="line">    /* In RHEL-7 we use /run/named instead of default /var/run/named</span><br><span class="line">       so we have to configure paths properly. */</span><br><span class="line">    #PID文件路径</span><br><span class="line">    pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">    #session-keyfile文件路径</span><br><span class="line">    session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">    #指定目录，其中保存着跟踪被管理DNSSEC密钥文件。默认为工作目录。</span><br><span class="line">    managed-keys-directory &quot;/var/named/dynamic&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">logging </span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启DNS日志记录</span></span><br><span class="line">/*      If you want to enable debugging, eg. using the &#x27;rndc trace&#x27; command,</span><br><span class="line"> *      named will try to write the &#x27;named.run&#x27; file in the $directory (/var/named).</span><br><span class="line"> *      By default, SELinux policy does not allow named to modify the /var/named directory,</span><br><span class="line"> *      so put the default debug log file in data/ :</span><br><span class="line"> */</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file &quot;data/named.run&quot;;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">/*</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#日志分为两种 告警和访问</span></span></span><br><span class="line">logging &#123;</span><br><span class="line">  channel warning &#123;</span><br><span class="line">    file &quot;data/dns_warning&quot; versions 10 size 10m;</span><br><span class="line">    severity warning;</span><br><span class="line">    print-category yes;</span><br><span class="line">    print-severity yes;</span><br><span class="line">    print-time yes;</span><br><span class="line">  &#125;;</span><br><span class="line">  channel general_dns &#123;</span><br><span class="line">    file &quot;data/dns_log&quot; versions 10 size 100m;</span><br><span class="line">    severity info;</span><br><span class="line">    print-category yes;</span><br><span class="line">    print-severity yes;</span><br><span class="line">    print-time yes;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">默认日志 warning</span></span><br><span class="line"> category default &#123;</span><br><span class="line">    warning;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">访问日志级别 general_dns info</span></span><br><span class="line">  category queries &#123;</span><br><span class="line">    general_dns;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">*/</span><br><span class="line">&#125;;</span><br><span class="line">/*</span><br><span class="line">通过Views指令配置智能查询DNS</span><br><span class="line"> Views let a name server answer a DNS query differently depending on who is asking.</span><br><span class="line"> By default, if named.conf contains no &quot;view&quot; clauses, all zones are in the </span><br><span class="line"> &quot;default&quot; view, which matches all clients.</span><br><span class="line"> Views are processed sequentially. The first match is used so the last view should</span><br><span class="line"> match &quot;any&quot; - it&#x27;s fallback and the most restricted view.</span><br><span class="line"> If named.conf contains any &quot;view&quot; clause, then all zones MUST be in a view.</span><br><span class="line">*/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置一个明称为localhost_resolver的智能访问视图</span></span><br><span class="line">view &quot;localhost_resolver&quot;</span><br><span class="line">&#123;</span><br><span class="line">/* This view sets up named to be a localhost resolver ( caching only nameserver ).</span><br><span class="line"> * If all you want is a caching-only nameserver, then you need only define this view:</span><br><span class="line"> */</span><br><span class="line">    #允许使用该视图解析的客户端   localhost本机   any 任何机器  或者网段</span><br><span class="line">    match-clients         &#123; localhost; &#125;;</span><br><span class="line">    #允许递归</span><br><span class="line">    recursion yes;</span><br><span class="line">    # all views must contain the root hints zone:</span><br><span class="line">    #根域</span><br><span class="line">    zone &quot;.&quot; IN &#123;</span><br><span class="line">        #域类型为hint,还有master slave forward等类型</span><br><span class="line">            type hint;</span><br><span class="line">        #区域数据库文件路径</span><br><span class="line">            file &quot;/var/named/named.ca&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">        /* these are zones that contain definitions for all the localhost</span><br><span class="line">         * names and addresses, as recommended in RFC1912 - these names should</span><br><span class="line">     * not leak to the other nameservers:</span><br><span class="line">     */</span><br><span class="line">    #包含子配置文件</span><br><span class="line">    include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义视图internal</span></span><br><span class="line">view &quot;internal&quot;</span><br><span class="line">&#123;</span><br><span class="line">/* This view will contain zones you want to serve only to &quot;internal&quot; clients</span><br><span class="line">   that connect via your directly attached LAN interfaces - &quot;localnets&quot; .</span><br><span class="line"> */</span><br><span class="line">    match-clients        &#123; localnets; &#125;;</span><br><span class="line">    recursion yes;</span><br><span class="line">    zone &quot;.&quot; IN &#123;</span><br><span class="line">            type hint;</span><br><span class="line">            file &quot;/var/named/named.ca&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">        /* these are zones that contain definitions for all the localhost</span><br><span class="line">         * names and addresses, as recommended in RFC1912 - these names should</span><br><span class="line">     * not leak to the other nameservers:</span><br><span class="line">     */</span><br><span class="line">    include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">    // These are your &quot;authoritative&quot; internal zones, and would probably</span><br><span class="line">    // also be included in the &quot;localhost_resolver&quot; view above :</span><br><span class="line">    /*</span><br><span class="line">      NOTE for dynamic DNS zones and secondary zones:</span><br><span class="line">      DO NOT USE SAME FILES IN MULTIPLE VIEWS!</span><br><span class="line">      If you are using views and DDNS/secondary zones it is strongly</span><br><span class="line">      recommended to read FAQ on ISC site (www.isc.org), section</span><br><span class="line">      &quot;Configuration and Setup Questions&quot;, questions</span><br><span class="line">      &quot;How do I share a dynamic zone between multIPle views?&quot; and</span><br><span class="line">      &quot;How can I make a server a slave for both an internal and an external</span><br><span class="line">       view at the same time?&quot;</span><br><span class="line">    */</span><br><span class="line">    zone &quot;my.internal.zone&quot; &#123; </span><br><span class="line">        type master;</span><br><span class="line">        file &quot;my.internal.zone.db&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    zone &quot;my.slave.internal.zone&quot; &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file &quot;slaves/my.slave.internal.zone.db&quot;;</span><br><span class="line">        masters &#123; /* put master nameserver IPs here */ 127.0.0.1; &#125; ;</span><br><span class="line">        // put slave zones in the slaves/ directory so named can update them</span><br><span class="line">    &#125;;    </span><br><span class="line">    zone &quot;my.ddns.internal.zone&quot; &#123;</span><br><span class="line">        type master;</span><br><span class="line">        allow-update &#123; key ddns_key; &#125;;</span><br><span class="line">        file &quot;dynamic/my.ddns.internal.zone.db&quot;;</span><br><span class="line">        // put dynamically updateable zones in the slaves/ directory so named can update them</span><br><span class="line">    &#125;;            </span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置DDNS_key</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主从复制加密使用</span></span><br><span class="line">key ddns_key</span><br><span class="line">&#123;</span><br><span class="line">    #加密方式 hmac-md5</span><br><span class="line">    algorithm hmac-md5;</span><br><span class="line">    secret &quot;use /usr/sbin/dnssec-keygen to generate TSIG keys&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;external&quot;</span><br><span class="line">&#123;</span><br><span class="line">/* This view will contain zones you want to serve only to &quot;external&quot; clients</span><br><span class="line"> * that have addresses that are not match any above view:</span><br><span class="line"> */</span><br><span class="line">    match-clients        &#123; any; &#125;;</span><br><span class="line">    zone &quot;.&quot; IN &#123;</span><br><span class="line">            type hint;</span><br><span class="line">            file &quot;/var/named/named.ca&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    recursion no;</span><br><span class="line">    // you&#x27;d probably want to deny recursion to external clients, so you don&#x27;t</span><br><span class="line">        // end up providing free DNS service to all takers</span><br><span class="line">    // These are your &quot;authoritative&quot; external zones, and would probably</span><br><span class="line">        // contain entries for just your web and mail servers:</span><br><span class="line">    zone &quot;my.external.zone&quot; &#123; </span><br><span class="line">        type master;</span><br><span class="line">        file &quot;my.external.zone.db&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">/* Trusted keys</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义信任的dnssec密钥。</span></span><br><span class="line">  This statement contains DNSSEC keys. If you want DNSSEC aware resolver you</span><br><span class="line">  have to configure at least one trusted key.</span><br><span class="line">  Note that no key written below is valid. Especially root key because root zone</span><br><span class="line">  is not signed yet.</span><br><span class="line">*/</span><br><span class="line">/*</span><br><span class="line">trusted-keys &#123;</span><br><span class="line">// Root Key</span><br><span class="line">&quot;.&quot; 257 3 3 &quot;BNY4wrWM1nCfJ+CXd0rVXyYmobt7sEEfK3clRbGaTwSJxrGkxJWoZu6I7PzJu/</span><br><span class="line">             E9gx4UC1zGAHlXKdE4zYIPRhaBKnvcC2U9mZhkdUpd1Vso/HAdjNe8LmMlnzY3</span><br><span class="line">             zy2Xy4klWOADTPzSv9eamj8V18PHGjBLaVtYvk/ln5ZApjYghf+6fElrmLkdaz</span><br><span class="line">             MQ2OCnACR817DF4BBa7UR/beDHyp5iWTXWSi6XmoJLbG9Scqc7l70KDqlvXR3M</span><br><span class="line">             /lUUVRbkeg1IPJSidmK3ZyCllh4XSKbje/45SKucHgnwU5jefMtq66gKodQj+M</span><br><span class="line">             iA21AfUVe7u99WzTLzY3qlxDhxYQQ20FQ97S+LKUTpQcq27R7AT3/V5hRQxScI</span><br><span class="line">             Nqwcz4jYqZD2fQdgxbcDTClU0CRBdiieyLMNzXG3&quot;;</span><br><span class="line">// Key for forward zone</span><br><span class="line">example.com. 257 3 5 &quot;AwEAAaxPMcR2x0HbQV4WeZB6oEDX+r0QM65KbhTjrW1ZaARmPhEZZe</span><br><span class="line">                      3Y9ifgEuq7vZ/zGZUdEGNWy+JZzus0lUptwgjGwhUS1558Hb4JKUbb</span><br><span class="line">                      OTcM8pwXlj0EiX3oDFVmjHO444gLkBO UKUf/mC7HvfwYH/Be22GnC</span><br><span class="line">                      lrinKJp1Og4ywzO9WglMk7jbfW33gUKvirTHr25GL7STQUzBb5Usxt</span><br><span class="line">                      8lgnyTUHs1t3JwCY5hKZ6CqFxmAVZP20igTixin/1LcrgX/KMEGd/b</span><br><span class="line">                      iuvF4qJCyduieHukuY3H4XMAcR+xia2 nIUPvm/oyWR8BW/hWdzOvn</span><br><span class="line">                      SCThlHf3xiYleDbt/o1OTQ09A0=&quot;;</span><br><span class="line">// Key for reverse zone.</span><br><span class="line">2.0.192.IN-ADDRPA.NET. 257 3 5 &quot;AQOnS4xn/IgOUpBPJ3bogzwcxOdNax071L18QqZnQQQA</span><br><span class="line">                                VVr+iLhGTnNGp3HoWQLUIzKrJVZ3zggy3WwNT6kZo6c0</span><br><span class="line">                                tszYqbtvchmgQC8CzKojM/W16i6MG/ea fGU3siaOdS0</span><br><span class="line">                                yOI6BgPsw+YZdzlYMaIJGf4M4dyoKIhzdZyQ2bYQrjyQ</span><br><span class="line">                                4LB0lC7aOnsMyYKHHYeRv PxjIQXmdqgOJGq+vsevG06</span><br><span class="line">                                zW+1xgYJh9rCIfnm1GX/KMgxLPG2vXTD/RnLX+D3T3UL</span><br><span class="line">                                7HJYHJhAZD5L59VvjSPsZJHeDCUyWYrvPZesZDIRvhDD</span><br><span class="line">                                52SKvbheeTJUm6EhkzytNN2SN96QRk8j/iI8ib&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vim /var/named/chroot/etc/named.conf</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 192.168.88.132; &#125;;</span><br><span class="line">        #listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        recursing-file  &quot;/var/named/data/named.recursing&quot;;</span><br><span class="line">        secroots-file   &quot;/var/named/data/named.secroots&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line"></span><br><span class="line">        recursion yes;</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">        pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">        session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">        type hint;</span><br><span class="line">        file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br><span class="line"></span><br><span class="line">systemctl start named-chroot</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>区域数据库文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正向解析 named.localhost</span></span><br><span class="line">;缓存时间</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">;@表示相应的域名</span><br><span class="line">@    IN SOA        @ rname.invalid. (</span><br><span class="line">;解析的域名   类型 授权域    授权域名服务器   管理员邮箱</span><br><span class="line">                    0    ; serial  序列号,每次更新该文件系列号都应该变大</span><br><span class="line">                    1D    ; refresh 刷新时间,即规定从域名服务器多长时间查询一个主服务器，以保证从服务器的数据是最新的</span><br><span class="line">                    1H    ; retry   重试时间,即当从服务试图在主服务器上查询更时，而连接失败了，则这个值规定了从服务多长时间后再试 </span><br><span class="line">                    1W    ; expire  过期时间,从服务器在向主服务更新失败后多长时间后清除对应的记录</span><br><span class="line">                    3H )    ; minimum 这个数据用来规定缓冲服务器不能与主服务联系上后多长时间清除相应的记录</span><br><span class="line">    NS   @</span><br><span class="line">    ;NS 名称服务器，表示这个主机为域名服务器</span><br><span class="line">    A    127.0.0.1</span><br><span class="line">;主机头  A记录   IP</span><br><span class="line">    AAAA    ::1</span><br><span class="line">;   AAAA 解析为IPV6地址</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">反向解析 named.loopback</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">@    IN SOA    @ rname.invalid. (</span><br><span class="line">                    0    ; serial</span><br><span class="line">                    1D    ; refresh</span><br><span class="line">                    1H    ; retry</span><br><span class="line">                    1W    ; expire</span><br><span class="line">                    3H )    ; minimum</span><br><span class="line">    NS    @</span><br><span class="line">    PTR    localhost</span><br><span class="line">;IP 反向指针     域名</span><br><span class="line">;PTR 反向指针 反解</span><br></pre></td></tr></table></figure>

<h3 id="2-3-正向解析"><a href="#2-3-正向解析" class="headerlink" title="2.3 正向解析"></a>2.3 正向解析</h3><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">	type master;</span><br><span class="line">	file &quot;cqm.com.zone&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cp /var/named/chroot/var/named/named.localhost /var/named/chroot/var/named/cqm.com.zone</span><br><span class="line">chgrp named cqm.com.zone</span><br><span class="line">vim /var/named/chroot/var/named/cqm.com.zone</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.    IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A:IPv4解析为域名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PTR:域名解析为IP</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MX</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CNAME:设置别名</span></span><br><span class="line">		NS      dns.cqm.com.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析dns为192.168.88.132</span></span><br><span class="line">dns		A		192.168.88.132</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析www为192.168.88.132</span></span><br><span class="line">www     A       192.168.88.132</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用news访问也解析为www</span></span><br><span class="line">news    CNAME   www</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检测文件是否有误</span></span><br><span class="line">named-checkzone cqm.com cqm.com.zone</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在客户端上配置DNS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/resolve.conf</span><br><span class="line">nameserver 192.168.88.132</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过host命令进行测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind-utils</span><br><span class="line">host www.cqm.com</span><br><span class="line">www.cqm.com has address 192.168.88.132</span><br><span class="line"></span><br><span class="line">host news.cqm.com</span><br><span class="line">news.cqm.com is an alias for www.cqm.com.</span><br><span class="line">www.cqm.com has address 192.168.88.132</span><br></pre></td></tr></table></figure>

<h3 id="2-4-反向解析"><a href="#2-4-反向解析" class="headerlink" title="2.4 反向解析"></a>2.4 反向解析</h3><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;88.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">	type master;</span><br><span class="line">	file &quot;192.168.88.arpa&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cp /var/named/chroot/var/named/named.loopback /var/named/chroot/var/named/192.168.88.arpa</span><br><span class="line">vim /var/named/chroot/var/named/192.168.88.arpa</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">88.168.192.in-addr.arpa.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">132     PTR     www.cqm.com.</span><br><span class="line"></span><br><span class="line">named-checkzone 88.168.192.in-addr.arpa 192.168.88.arpa</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host 192.168.88.132</span><br><span class="line">132.88.168.192.in-addr.arpa domain name pointer www.cqm.com.</span><br></pre></td></tr></table></figure>

<h3 id="2-5-主从同步"><a href="#2-5-主从同步" class="headerlink" title="2.5 主从同步"></a>2.5 主从同步</h3><p>即配置两台DNS服务器，由于上边我们以及配置过主DNS了，接下来再配置一台辅DNS服务器即可。</p>
<p>主DNS服务器IP：192.168.88.132</p>
<p>辅DNS服务器IP：192.168.88.135</p>
<ol>
<li>安装DNS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置主配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">scp root@192.168.88.132:/var/named/chroot/etc/named.conf /var/named/chroot/etc/named.conf</span><br><span class="line">chgrp named /var/named/chroot/etc/named.conf</span><br><span class="line">vim /var/named/chroot/etc/named.conf</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 192.168.88.135; &#125;;</span><br><span class="line">        #listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        recursing-file  &quot;/var/named/data/named.recursing&quot;;</span><br><span class="line">        secroots-file   &quot;/var/named/data/named.secroots&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line">        # 从主DNS服务器拷过来的数据不进行加密</span><br><span class="line">        masterfile-format text;</span><br><span class="line"></span><br><span class="line">        recursion yes;</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">        pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">        session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">        type hint;</span><br><span class="line">        file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file &quot;cqm.com.zone&quot;;</span><br><span class="line">        masters &#123; 192.168.88.132; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;88.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file &quot;192.168.88.arpa&quot;;</span><br><span class="line">        masters &#123; 192.168.88.132; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置和主DNS服务器相同的区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim cqm.com.zone</span><br><span class="line">...</span><br><span class="line">vim 192.168.88.arpa</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>将DNS服务器设为自己后进行测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/reslove.comf</span><br><span class="line">nameserver 192.168.88.135</span><br><span class="line">host www.cqm.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="2-6-智能解析"><a href="#2-6-智能解析" class="headerlink" title="2.6 智能解析"></a>2.6 智能解析</h3><p>在DNS中植入全世界的IP库以及IP对应的地域，当用户发来请求时，会根据用户属于哪个地区来找那个地区的区域数据库文件来进行解析，从而使得不同地域的用户解析不同。</p>
<p>例子：</p>
<p>部署一台智能解析DNS服务器，对cqm.com进行解析</p>
<p>深圳用户解析为1.1.1.1</p>
<p>广州用户解析为2.2.2.2</p>
<p>佛山用户解析为3.3.3.3</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 192.168.88.132; &#125;;</span><br><span class="line">        #listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        recursing-file  &quot;/var/named/data/named.recursing&quot;;</span><br><span class="line">        secroots-file   &quot;/var/named/data/named.secroots&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line"></span><br><span class="line">        recursion yes;</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">        pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">        session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl sz &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">假设该网段是深圳的IP地址段</span></span><br><span class="line">        192.168.77.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl gz &#123;</span><br><span class="line">        192.168.88.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl fs &#123;</span><br><span class="line">        192.168.99.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view shenzhen &#123;</span><br><span class="line">match-clients &#123; sz; &#125;;</span><br><span class="line">        zone &quot;.&quot; IN &#123;</span><br><span class="line">                type hint;</span><br><span class="line">                file &quot;named.ca&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file &quot;cqm.com.zone.SZ&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view guangzhou &#123;</span><br><span class="line">match-clients &#123; gz; &#125;;</span><br><span class="line">        zone &quot;.&quot; IN &#123;</span><br><span class="line">                type hint;</span><br><span class="line">                file &quot;named.ca&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file &quot;cqm.com.zone.GZ&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view foshan &#123;</span><br><span class="line">match-clients &#123; fs; &#125;;</span><br><span class="line">        zone &quot;.&quot; IN &#123;</span><br><span class="line">                type hint;</span><br><span class="line">                file &quot;named.ca&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file &quot;cqm.com.zone.FS&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cp cqm.com.zone cqm.com.zone.SZ</span><br><span class="line">cp cqm.com.zone cqm.com.zone.GZ</span><br><span class="line">cp cqm.com.zone cqm.com.zone.FS</span><br><span class="line">chgrp named cqm.com.zone.*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">深圳</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">dns     A       192.168.88.132</span><br><span class="line">www     A       1.1.1.1</span><br><span class="line">news    CNAME   www</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">广州</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">dns     A       192.168.88.132</span><br><span class="line">www     A       2.2.2.2</span><br><span class="line">news    CNAME   www</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">佛山</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">dns     A       192.168.88.132</span><br><span class="line">www     A       3.3.3.3</span><br><span class="line">news    CNAME   www</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试主机的地址段为192.168.88.0/24网段的，所以属于广州区域，即匹配解析到2.2.2.2</span></span><br><span class="line">host www.cqm.com</span><br><span class="line">www.cqm.com has address 2.2.2.2</span><br></pre></td></tr></table></figure>



<h2 id="三、FTP文件传输服务"><a href="#三、FTP文件传输服务" class="headerlink" title="三、FTP文件传输服务"></a>三、FTP文件传输服务</h2><h3 id="3-1-FTP服务介绍"><a href="#3-1-FTP服务介绍" class="headerlink" title="3.1 FTP服务介绍"></a>3.1 FTP服务介绍</h3><p>FTP即文件传输协议，是TCP&#x2F;IP协议组的协议之一。</p>
<p>FTP默认采用TCP20和21端口，20用于传输数据，21用于控制传输信息。</p>
<p>FTP分别有主动传输方式和被动传输方式两种，当FTP为主动传输方式时运用20和21端口，而当FTP为被动传输方式时则会随即打开一个大于1024的端口来进行数据的传输。</p>
<h3 id="3-2-FTP服务部署"><a href="#3-2-FTP服务部署" class="headerlink" title="3.2 FTP服务部署"></a>3.2 FTP服务部署</h3><ol>
<li>安装vsftpd</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vsftpd</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>主配文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example config file /etc/vsftpd/vsftpd.conf</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The default compiled in settings are fairly paranoid. This sample file</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">loosens things up a bit, to make the ftp daemon more usable.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Please see vsftpd.conf.5 <span class="keyword">for</span> all compiled <span class="keyword">in</span> defaults.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># READ THIS: This example file is NOT an exhaustive list of vsftpd options.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Please <span class="built_in">read</span> the vsftpd.conf.5 manual page to get a full idea of vsftpd<span class="string">&#x27;s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">capabilities.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">#匿名用户访问,YES是允许，NO是拒绝</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Allow anonymous FTP? (Beware - allowed by default if you comment this out).</span></span></span><br><span class="line">anonymous_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># Uncomment this to allow local users to log in.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">本地用户登录,YES是允许，NO是拒绝.默认访问的是本地用户家目录，如果你开启了selinux</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">请设置开启布尔值ftp_home_dir为ON</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">When SELinux is enforcing check for SE bool ftp_home_dir</span></span></span><br><span class="line">local_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">#允许本地用户上传</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Uncomment this to enable any form of FTP write command.</span></span></span><br><span class="line">write_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># Default umask for local users is 077. You may wish to change this to 022,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">上传的权限是022，使用的是umask权限。对应的目录是755，文件是644</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">if your users expect that (022 is used by most other ftpd&#x27;</span>s)</span></span><br><span class="line">local_umask=022</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Uncomment this to allow the anonymous FTP user to upload files. This only</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">has an effect <span class="keyword">if</span> the above global write <span class="built_in">enable</span> is activated. Also, you will</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">obviously need to create a directory writable by the FTP user.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">When SELinux is enforcing check <span class="keyword">for</span> SE bool allow_ftpd_anon_write, allow_ftpd_full_access</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启匿名用户上传功能，默认是拒绝的</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">anon_upload_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Uncomment this if you want the anonymous FTP user to be able to create</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">new directories.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启匿名用户创建文件或文件夹权限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">anon_mkdir_write_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Activate directory messages - messages given to remote users when they</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">go into a certain directory.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启目录欢迎消息，一般对命令行登陆有效</span></span><br><span class="line">dirmessage_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Activate logging of uploads/downloads.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启上传和下载日志记录功能</span></span><br><span class="line">xferlog_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#使用标准模式</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Make sure PORT transfer connections originate from port 20 (ftp-data).</span></span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you want, you can arrange for uploaded anonymous files to be owned by</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a different user. Note! Using <span class="string">&quot;root&quot;</span> <span class="keyword">for</span> uploaded files is not</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">recommended!</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">声明匿名用户上传文件的所有者</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许更改匿名用户上传文件的所有者</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">chown_uploads=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有者为whoever</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">chown_username=whoever</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may override where the log file goes if you like. The default is shown</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">below.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志文件路径</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">xferlog_file=/var/log/xferlog</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you want, you can have your log file in standard ftpd xferlog format.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that the default <span class="built_in">log</span> file location is /var/log/xferlog <span class="keyword">in</span> this <span class="keyword">case</span>.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志文件采用标准格斯</span></span><br><span class="line">xferlog_std_format=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may change the default value for timing out an idle session.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会话超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">idle_session_timeout=600</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may change the default value for timing out a data connection.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据传输超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">data_connection_timeout=120</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># It is recommended that you define on your system a unique user which the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ftp server can use as a totally isolated and unprivileged user.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">FTP子进程管理用户</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nopriv_user=ftpsecure</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Enable this and the server will recognise asynchronous ABOR requests. Not</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">recommended <span class="keyword">for</span> security (the code is non-trivial). Not enabling it,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">however, may confuse older FTP clients.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否允许客户端发起“async ABOR”请求，该操作是不安全的默认禁止。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">async_abor_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># By default the server will pretend to allow ASCII mode but in fact ignore</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the request. Turn on the below options to have the server actually <span class="keyword">do</span> ASCII</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mangling on files when <span class="keyword">in</span> ASCII mode. The vsftpd.conf(5) man page explains</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the behaviour when these options are disabled.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Beware that on some FTP servers, ASCII support allows a denial of service</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">attack (DoS) via the <span class="built_in">command</span> <span class="string">&quot;SIZE /big/file&quot;</span> <span class="keyword">in</span> ASCII mode. vsftpd</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">predicted this attack and has always been safe, reporting the size of the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">raw file.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ASCII mangling is a horrible feature of the protocol.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该选项用于指定是否允许上传时以ASCII模式传输数据</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ascii_upload_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该选项用于指定是否允许下载时以ASCII模式传输数据</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ascii_download_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may fully customise the login banner string:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">FTP文本界面登陆欢迎词</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ftpd_banner=Welcome to blah FTP service.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may specify a file of disallowed anonymous e-mail addresses. Apparently</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">useful <span class="keyword">for</span> combatting certain DoS attacks.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否开启拒绝的Email功能</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">deny_email_enable=YES</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(default follows)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定保存被拒接的Email地址的文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">banned_email_file=/etc/vsftpd/banned_emails</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may specify an explicit list of local users to chroot() to their home</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">directory. If chroot_local_user is YES, <span class="keyword">then</span> this list becomes a list of</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">users</span> to NOT <span class="built_in">chroot</span>().</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(Warning! <span class="built_in">chroot</span><span class="string">&#x27;ing can be very dangerous. If using chroot, make sure that</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">the user does not have write access to the top level directory within the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">chroot)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启对本地用户chroot的限制，YES为默认所有用户都不能切出家目录，NO代表默认用户都可以切出家目录</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">设置方法类似于：YES拒绝所有允许个别；NO允许所有拒绝个别</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">chroot_local_user=YES</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">开启特例列表</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">chroot_list_enable=YES</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">(default follows)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">如果chroot_local_user的值是YES则该文件中的用户是可以切出家目录，如果是NO，该文件中的用户则不能切出家目录</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">一行一个用户。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">chroot_list_file=/etc/vsftpd/chroot_list</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># You may activate the &quot;-R&quot; option to the builtin ls. This is disabled by</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">default to avoid remote users being able to cause excessive I/O on large</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">sites. However, some broken FTP clients such as &quot;ncftp&quot; and &quot;mirror&quot; assume</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">the presence of the &quot;-R&quot; option, so there is a strong case for enabling it.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启ls 递归查询功能 ls -R</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">ls_recurse_enable=YES</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># When &quot;listen&quot; directive is enabled, vsftpd runs in standalone mode and</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">listens on IPv4 sockets. This directive cannot be used in conjunction</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">with the listen_ipv6 directive.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启ftp独立模式在IPV4</span></span></span><br><span class="line">listen=NO</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># This directive enables listening on IPv6 sockets. By default, listening</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">on the IPv6 &quot;any&quot; address (::) will accept connections from both IPv6</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">and IPv4 clients. It is not necessary to listen on *both* IPv4 and IPv6</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">sockets. If you want that (perhaps because you want to listen on specific</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">addresses) then you must run two copies of vsftpd with two configuration</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">files.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Make sure, that one of the listen options is commented !!</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启ftp独立模式在ipv6</span></span></span><br><span class="line">listen_ipv6=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">启用pam模块验证</span></span></span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">是否开启userlist功能.</span></span></span><br><span class="line">定义对列表中的用户做定义</span><br><span class="line">userlist_deny=NO</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">NO拒绝所有人访问，对应列表中的用户可以访问，YES允许所有人访问，列表中的用户无法访问。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">只有userlist_file=/etc/vsftpd/user_list定义的用户才可以访问或拒绝访问</span></span></span><br><span class="line">userlist_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">是否开启tcp_wrappers管理，TCP_Wrappers是一个工作在第四层（传输层）的的安全工具，</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">对有状态连接的特定服务进行安全检测并实现访问控制</span></span></span><br><span class="line">tcp_wrappers=YES</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>匿名用户和本地用户</p>
<ul>
<li><p>需要注意的是，匿名用户访问的是&#x2F;var&#x2F;ftp，而本地用户访问的话是家目录。</p>
</li>
<li><p>关于权限，在主配文件中设置的权限是反码，文件实际权限 &#x3D; 666 - 反码。</p>
</li>
<li><p>假如主配文件中设置为022，那么文件实际权限 &#x3D; 666 - 022 &#x3D; 644，文件夹实际权限 &#x3D; 777 - 022 &#x3D; 755。</p>
</li>
<li><p>在linux端访问FTP服务器时，无论FTP服务器是否开启了匿名用户访问，客户访问时都要输入用户名和密码，匿名用户用户名ftp，密码随意，但是需要为带有@的email地址。</p>
</li>
</ul>
</li>
<li><p>开启chroot</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否开启对本地用户<span class="built_in">chroot</span>的限制，YES为默认所有用户都不能切出家目录，NO代表默认用户都可以切出家目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置方法类似于：YES拒绝所有允许个别；NO允许所有拒绝个别</span></span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">特例列表</span></span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果用户家目录有写权限的话，则该用户登陆不上</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果想在有写权限的家目录登录的话，需在配置文件加上</span></span><br><span class="line">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure>

<h3 id="3-3-FTP命令"><a href="#3-3-FTP命令" class="headerlink" title="3.3 FTP命令"></a>3.3 FTP命令</h3><p>登录到FTP服务器后，基本命令如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">help # 打印命令菜单</span><br><span class="line">!+linux命令 # 执行linux命令</span><br><span class="line">lcd 目录路径 # 切换linux当前路径</span><br><span class="line">put mput # 上传 批量上传</span><br><span class="line">get mget # 下载 批量下载</span><br><span class="line">ls dir # 列出目录内容</span><br><span class="line">mkdir cd delete rmdir # 创建目录 进入目录 删除文件 删除目录</span><br><span class="line">pwd # 现实FTP当前路径</span><br><span class="line">open close bye # 开启/关闭/退出FTP</span><br></pre></td></tr></table></figure>

<h3 id="3-4-虚拟用户"><a href="#3-4-虚拟用户" class="headerlink" title="3.4 虚拟用户"></a>3.4 虚拟用户</h3><p>由于FTP是采用本地用户来进行登录的，所以会将本地用户暴露在互联网中，如果没有相关安全设置，就会造成FTP不安全。</p>
<p>因此FTP可以设置虚拟用户来解决该问题。</p>
<p>在主配文件中开启虚拟用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">guest_enable=YES</span><br><span class="line">guest_username=cqm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">虚拟用户不用本地用户的权限</span></span><br><span class="line">virtual_use_local_privs=NO</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用户文件存放地址</span></span><br><span class="line">user_config_dir=/etc/vsftpd/vconf.d</span><br></pre></td></tr></table></figure>

<h3 id="3-5-基于虚拟用户配置的安全FTP"><a href="#3-5-基于虚拟用户配置的安全FTP" class="headerlink" title="3.5 基于虚拟用户配置的安全FTP"></a>3.5 基于虚拟用户配置的安全FTP</h3><p>案例要求：</p>
<ul>
<li>公司公共文件可以通过匿名下载</li>
<li>公式A部门、B部门、C部门分别由自己的文件夹，并相互隔离</li>
<li>部门之间只有主管拥有上传权限，部门员工只有下载权限</li>
<li>禁止用户查看家目录以外的数据</li>
<li>确保FTP账号安全</li>
</ul>
<ol>
<li>创建虚拟用户映射本地账号</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -d /var/tmp/vuser_ftp cqm</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建目录，所有操作都只能在此目录进行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod 500 /var/tmp/vuser_ftp</span><br><span class="line">mkdir /var/tmp/vuser_ftp/&#123;A,B,C&#125;</span><br><span class="line">chmod 700 /var/tmp/vuser_ftp/*</span><br><span class="line">chown -R cqm:cqm /var/tmp/vuser_ftp</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建虚拟用户账号密码文件，并生成db文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vuser</span><br><span class="line">A_01</span><br><span class="line">123</span><br><span class="line">B_01</span><br><span class="line">123</span><br><span class="line">C_01</span><br><span class="line">123</span><br><span class="line">A_02</span><br><span class="line">123</span><br><span class="line">B_02</span><br><span class="line">123</span><br><span class="line">C_02</span><br><span class="line">123</span><br><span class="line">db_load -T -t hash -f /etc/vsftpd/vuser /etc/vsftpd/vuser.db</span><br><span class="line">chmod 600 /etc/vsftpd/vuser.db</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>设置虚拟用户pam认证</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pam.d/vsftpd</span><br><span class="line">auth       sufficient   /lib64/security/pam_userdb.so db=/etc/vsftpd/vuser</span><br><span class="line">account    sufficient   /lib64/security/pam_userdb.so db=/etc/vsftpd/vuser</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>要求不能切出家目录，所以要设置chroot_list</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/chroot_list</span><br><span class="line">A_01</span><br><span class="line">B_01</span><br><span class="line">C_01</span><br><span class="line">A_02</span><br><span class="line">B_02</span><br><span class="line">C_02</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>创建子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/vsftpd/vconf.d</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A主管文件</span></span><br><span class="line">vim /etc/vsftpd/vconf.d/A_01</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定家目录</span></span><br><span class="line">local_root=/var/tmp/vuser_ftp/A</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定权限</span></span><br><span class="line">anon_umask=077</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载权限</span></span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传权限</span></span><br><span class="line">anon_upload_enable=YES</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建目录权限</span></span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除和重命名目录权限</span></span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A员工文件</span></span><br><span class="line">vim /etc/vsftpd/vconf.d/A_02</span><br><span class="line">local_root=/var/tmp/vuser_ftp/A</span><br><span class="line">anon_world_readable_only=NO</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>配置主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">anonymous_enable=YES</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line">listen=YES</span><br><span class="line">listen_ipv6=NO</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=cqm</span><br><span class="line">virtual_use_local_privs=NO</span><br><span class="line">user_config_dir=/etc/vsftpd/vconf.d</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>测试主管用户和员工用户的权限</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ftp 192.168.88.132</span><br><span class="line">A_01</span><br><span class="line">123</span><br><span class="line">230 Login successful</span><br></pre></td></tr></table></figure>



<h2 id="四、Samba服务"><a href="#四、Samba服务" class="headerlink" title="四、Samba服务"></a>四、Samba服务</h2><h3 id="4-1-Samba服务介绍"><a href="#4-1-Samba服务介绍" class="headerlink" title="4.1 Samba服务介绍"></a>4.1 Samba服务介绍</h3><p>Samba是可以实现不同计算机系统之间文件共享的服务，即是在Linux和UNIX系统上实现SMB协议的一个免费软件。</p>
<p>SMB（Server Messages Block，信息服务块）是一种在局域网上共享文件和打印机的一种通信协议，它为局域网内的不同计算机之间提供文件及打印机等资源的共享服务。</p>
<p>Samba采用到的端口有：</p>
<ul>
<li>UDP 137：NetBIOS 名字服务</li>
<li>UDP 138：NetBIOS 数据报服务</li>
<li>UDP 139：SMB</li>
<li>TCP 389：用于 LDAP (Active Directory Mode)</li>
<li>TCP 445：NetBIOS服务在windos 2000及以后版本使用此端口, (Common Internet File System，CIFS，它是SMB协议扩展到Internet后，实现Internet文件共享)</li>
<li>TCP 901：用于 SWAT，用于网页管理Samba</li>
</ul>
<h3 id="4-2-Samba服务部署"><a href="#4-2-Samba服务部署" class="headerlink" title="4.2 Samba服务部署"></a>4.2 Samba服务部署</h3><ol>
<li>安装samba</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install samba samba-client</span><br><span class="line">systemctl start smb nmb</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>主配文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/samba/smb.conf.example</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is the main Samba configuration file. For detailed information about the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">options listed here, refer to the smb.conf(5) manual page. Samba has a huge</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">number of configurable options, most of <span class="built_in">which</span> are not shown <span class="keyword">in</span> this example.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The Samba Wiki contains a lot of step-by-step guides installing, configuring,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and using Samba:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://wiki.samba.org/index.php/User_Documentation</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># In this file, lines starting with a semicolon (;) or a hash (#) are</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">comments and are ignored. This file uses hashes to denote commentary and</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">semicolons <span class="keyword">for</span> parts of the file you may wish to configure.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># <span class="doctag">NOTE:</span> Run the &quot;testparm&quot; command after modifying this file to check for basic</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">syntax errors.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#---------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#SAMBA selinux相关设置，如果你开启了selinux，请注意下面的说明</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Security-Enhanced Linux (SELinux) Notes:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Turn the samba_domain_controller Boolean on to allow a Samba PDC to use the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">useradd and groupadd family of binaries. Run the following <span class="built_in">command</span> as the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">root user to turn this Boolean on:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你在域环境中使用samba那么请设置下面的bool值</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_domain_controller on</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Turn the samba_enable_home_dirs Boolean on if you want to share home</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">directories via Samba. Run the following <span class="built_in">command</span> as the root user to turn this</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Boolean on:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 假如希望通过samba共享用户家目录请设置下面的bool值</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_enable_home_dirs on</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you create a new directory, such as a new top-level directory, label it</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">with samba_share_t so that SELinux allows Samba to <span class="built_in">read</span> and write to it. Do</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">not label system directories, such as /etc/ and /home/, with samba_share_t, as</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">such directories should already have an SELinux label.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#加入你想将目录通过samba共享，请确认其目录标签为sambe_share_t</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run the <span class="string">&quot;ls -ldZ /path/to/directory&quot;</span> <span class="built_in">command</span> to view the current SELinux</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">label <span class="keyword">for</span> a given directory.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Set SELinux labels only on files and directories you have created. Use the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chcon</span> <span class="built_in">command</span> to temporarily change a label:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">标签设置方法</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chcon</span> -t samba_share_t /path/to/directory</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Changes made via chcon are lost when the file system is relabeled or commands</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">such as restorecon are run.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Use the samba_export_all_ro or samba_export_all_rw Boolean to share system</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">directories. To share such directories and only allow read-only permissions:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对共享目录的权限的bool设置，只读或读写</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_export_all_ro on</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">To share such directories and allow <span class="built_in">read</span> and write permissions:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_export_all_rw on</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># To run scripts (preexec/root prexec/print command/...), copy them to the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/var/lib/samba/scripts/ directory so that SELinux will allow smbd to run them.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that <span class="keyword">if</span> you move the scripts to /var/lib/samba/scripts/, they retain</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">their existing SELinux labels, <span class="built_in">which</span> may be labels that SELinux does not allow</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">smbd to run. Copying the scripts will result <span class="keyword">in</span> the correct SELinux labels.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run the <span class="string">&quot;restorecon -R -v /var/lib/samba/scripts&quot;</span> <span class="built_in">command</span> as the root user to</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apply the correct SELinux labels to these files.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#--------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#======================= Global Settings =====================================</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">全局设置，对整个服务都生效</span></span><br><span class="line">[global]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">网络设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Network-Related Options -------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># workgroup = the Windows NT domain name or workgroup name, for example, MYGROUP.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># server string = the equivalent of the Windows NT Description field.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># netbios name = used to specify a server name that is not tied to the hostname,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">               maximum is 15 characters.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># interfaces = used to configure Samba to listen on multiple network interfaces.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If you have multiple interfaces, you can use the <span class="string">&quot;interfaces =&quot;</span> option to</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">configure <span class="built_in">which</span> of those interfaces Samba listens on. Never omit the localhost</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">interface (lo).</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># hosts allow = the hosts allowed to connect. This option can also be used on a</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">per-share basis.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># hosts deny = the hosts not allowed to connect. This option can also be used on</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a per-share basis.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#定义计算机的工作组,如果希望和windows共享，可以设置为workgroup，这样就可以在windows的网上邻居中找到linux计算机</span></span></span><br><span class="line">    workgroup = MYGROUP</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对samba服务器的描述信息</span></span><br><span class="line">    server string = Samba Server Version %v</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置netbios计算机名称</span></span><br><span class="line">;    netbios name = MYSERVER</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">samba使用本机的那块网卡</span></span><br><span class="line">;    interfaces = lo eth0 192.168.12.2/24 192.168.13.2/24</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">允许那个网段访问samba服务器共享</span></span><br><span class="line">;    hosts allow = 127. 192.168.12. 192.168.13.</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#日志选项</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------- Logging Options -----------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># log file = specify where log files are written to and how they are split.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># max log size = specify the maximum size log files are allowed to reach. Log</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">files are rotated when they reach the size specified with <span class="string">&quot;max log size&quot;</span>.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">    <span class="comment">#samba日志文件路径</span></span></span><br><span class="line">    # log files split per-machine:</span><br><span class="line">    log file = /var/log/samba/log.%m</span><br><span class="line">    #日志文件大小，0为不限制，注意不建议这样设置</span><br><span class="line">    # maximum size of 50KB per log file, then rotate:</span><br><span class="line">    max log size = 50</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">独立服务选项</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Standalone Server Options ------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># security = the mode Samba runs in. This can be set to user, share</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(deprecated), or server (deprecated).</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># passdb backend = the backend used to store user information in. New</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installations should use either tdbsam or ldapsam. No additional configuration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">is required <span class="keyword">for</span> tdbsam. The <span class="string">&quot;smbpasswd&quot;</span> utility is available <span class="keyword">for</span> backwards</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">compatibility.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#samba安全级别</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">share:  不需要账号密码，公开共享</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">user:   需要提供sam账号密码才能访问共享，私密共享</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">server：依靠其他Windows NT/2000或Samba Server来验证用户的账号和密码,是一种代理验证。此种安全模式下,系统管理员可以把所有的Windows用户和口令集中到一个NT系统上,&gt;使用Windows NT进行Samba认证, 远程服务器可以自动认证全部用户和口令,如果认证失败,Samba将使用用户级安全模式作为替代的方式。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">domain：域安全级别,使用主域控制器(PDC)来完成认证。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#一般情况下我们使用share和user的比较多，除非公司有完整的域环境</span></span></span><br><span class="line">    security = user</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该方式则是使用一个数据库文件来建立用户数据库。数据库文件叫passdb.tdb，默认在/etc/samba目录下。passdb.tdb 用户数据库可以使用smbpasswd –a来建立Samba用户，不过要建立的Samba用户必须先是系统用户。我们也可以使用pdbedit命令来建立Samba账户并由其pdbedit管理。</span></span><br><span class="line">    passdb backend = tdbsam</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">域成员选项</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Domain Members Options ------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># security = must be set to domain or ads.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># passdb backend = the backend used to store user information in. New</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installations should use either tdbsam or ldapsam. No additional configuration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">is required <span class="keyword">for</span> tdbsam. The <span class="string">&quot;smbpasswd&quot;</span> utility is available <span class="keyword">for</span> backwards</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">compatibility.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># realm = only use the realm option when the &quot;security = ads&quot; option is set.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The realm option specifies the Active Directory realm the host is a part of.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># password server = only use this option when the &quot;security = server&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option is <span class="built_in">set</span>, or <span class="keyword">if</span> you cannot use DNS to locate a Domain Controller. The</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">argument list can include My_PDC_Name, [My_BDC_Name], and [My_Next_BDC_Name]:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># password server = My_PDC_Name [My_BDC_Name] [My_Next_BDC_Name]</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Use &quot;password server = *&quot; to automatically locate Domain Controllers.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置域共享</span></span><br><span class="line">;    security = domain</span><br><span class="line">;    passdb backend = tdbsam</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义域名称</span></span><br><span class="line">;    realm = MY_REALM</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">域验证服务器</span></span><br><span class="line">;    password server = </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">域控选项</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Domain Controller Options ------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># security = must be set to user for domain controllers.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># passdb backend = the backend used to store user information in. New</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installations should use either tdbsam or ldapsam. No additional configuration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">is required <span class="keyword">for</span> tdbsam. The <span class="string">&quot;smbpasswd&quot;</span> utility is available <span class="keyword">for</span> backwards</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">compatibility.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># domain master = specifies Samba to be the Domain Master Browser, allowing</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Samba to collate browse lists between subnets. Do not use the <span class="string">&quot;domain master&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option <span class="keyword">if</span> you already have a Windows NT domain controller performing this task.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># domain logons = allows Samba to provide a network logon service for Windows</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">workstations.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># logon script = specifies a script to run at login time on the client. These</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scripts must be provided <span class="keyword">in</span> a share named NETLOGON.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># logon path = specifies (with a UNC path) where user profiles are stored.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line">;    security = user</span><br><span class="line">;    passdb backend = tdbsam</span><br><span class="line">;    domain master = yes</span><br><span class="line">;    domain logons = yes</span><br><span class="line">    # the following login script name is determined by the machine name</span><br><span class="line">    # (%m):</span><br><span class="line">;    logon script = %m.bat</span><br><span class="line">    # the following login script name is determined by the UNIX user used:</span><br><span class="line">;    logon script = %u.bat</span><br><span class="line">;    logon path = \\%L\Profiles\%u</span><br><span class="line">    # use an empty path to disable profile support:</span><br><span class="line">;    logon path =</span><br><span class="line">    # various scripts can be used on a domain controller or a stand-alone</span><br><span class="line">    # machine to add or delete corresponding UNIX accounts:</span><br><span class="line">;    add user script = /usr/sbin/useradd &quot;%u&quot; -n -g users</span><br><span class="line">;    add group script = /usr/sbin/groupadd &quot;%g&quot;</span><br><span class="line">;    add machine script = /usr/sbin/useradd -n -c &quot;Workstation (%u)&quot; -M -d /nohome -s /bin/false &quot;%u&quot;</span><br><span class="line">;    delete user script = /usr/sbin/userdel &quot;%u&quot;</span><br><span class="line">;    delete user from group script = /usr/sbin/userdel &quot;%u&quot; &quot;%g&quot;</span><br><span class="line">;    delete group script = /usr/sbin/groupdel &quot;%g&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这些设置选项主要用于SMB网络中进行浏览时，设置samba服务器的行为。缺省情况不让 samba服务器参加broswser的推举过程，为了使得samba服务器能成为browser，就需要设定<span class="built_in">local</span> master =<span class="built_in">yes</span>。然后samba服务就可以根据os level设置的权重进行推举，缺省的os level为0，这个权重不会赢得推举。但可以取消注释，将os level设置为33，这将在与所有Windows计算机（包括Windows NT）的推举竞赛中获得胜利，因为NT server的权重为32。设置比33更高的权重，只是在不同的samba 服务器之间进行选择时才有意义。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># preferred master  可以设置自己优先成为浏览服务器候选人</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ----------------------- Browser Control Options ----------------------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># local master = when set to no, Samba does not become the master browser on</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">your network. When <span class="built_in">set</span> to <span class="built_in">yes</span>, normal election rules apply.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># os level = determines the precedence the server has in master browser</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">elections. The default value should be reasonable.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># preferred master = when set to yes, Samba forces a local browser election at</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">start up (and gives itself a slightly higher chance of winning the election).</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">;    <span class="built_in">local</span> master = no</span></span><br><span class="line">;    os level = 33</span><br><span class="line">;    preferred master = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">wins服务，如果网络中配置了wins服务器可以在此设置wins相关项</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">----------------------------- Name Resolution -------------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This section details the support for the Windows Internet Name Service (WINS).</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Note: Samba can be either a WINS server or a WINS client, but not both.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># wins support = when set to yes, the NMBD component of Samba enables its WINS</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># wins server = tells the NMBD component of Samba to be a WINS client.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># wins proxy = when set to yes, Samba answers name resolution queries on behalf</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">of a non WINS capable client. For this to work, there must be at least one</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WINS server on the network. The default is no.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># dns proxy = when set to yes, Samba attempts to resolve NetBIOS names via DNS</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nslookups.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置nmb进程支持wins服务</span></span><br><span class="line">;    wins support = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置wins服务器ip</span></span><br><span class="line">;    wins server = w.x.y.z</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置wins代理IP</span></span><br><span class="line">;    wins proxy = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置Samba服务器是否在无法联系WINS服务器时通过DNS去解析主机的NetBIOS名</span></span><br><span class="line">;    dns proxy = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该部分包括Samba服务器打印机相关设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------- Printing Options -----------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The options in this section allow you to configure a non-default printing</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">system.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># load printers = when set you yes, the list of printers is automatically</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">loaded, rather than setting them up individually.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cups options = allows you to pass options to the CUPS library. Setting this</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option to raw, <span class="keyword">for</span> example, allows you to use drivers on your Windows clients.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># printcap name = used to specify an alternative printcap file.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#是否启用共享打印机</span></span></span><br><span class="line">    load printers = yes</span><br><span class="line">    cups options = raw</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打印机配置文件</span></span><br><span class="line">;    printcap name = /etc/printcap</span><br><span class="line">    # obtain a list of printers automatically on UNIX System V systems:</span><br><span class="line">;    printcap name = lpstat</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打印机的系统类型,现在支持的打印系统有：bsd, sysv, plp, lprng, aix, hpux, qnx,cups</span></span><br><span class="line">;    printing = cups</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该部分包括Samba服务器如何保留从Windows客户端复制或移动到Samba服务器共享目录文件的Windows文件属性的相关配置.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------- File System Options ---------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The options in this section can be un-commented if the file system supports</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">extended attributes, and those attributes are enabled (usually via the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;user_xattr&quot;</span> mount option). These options allow the administrator to specify</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">that DOS attributes are stored <span class="keyword">in</span> extended attributes and also make sure that</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Samba does not change the permission bits.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Note: These options can be used on a per-share basis. Setting them globally</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(<span class="keyword">in</span> the [global] section) makes them the default <span class="keyword">for</span> all shares.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的存档属性。默认no。</span></span><br><span class="line">;    map archive = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的隐藏属性。默认no。</span></span><br><span class="line">;    map hidden = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的只读属性。默认为no。</span></span><br><span class="line">;    map read only = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的系统文件属性。默认为no。</span></span><br><span class="line">;    map system = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的相关属性（只读、系统、隐藏、存档属性）。默认为<span class="built_in">yes</span>。</span></span><br><span class="line">;    store dos attributes = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">共享设置</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">============================ Share Definitions ==============================</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用户家目录共享</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">共享名称</span></span><br><span class="line">[homes]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">描述</span></span><br><span class="line">    comment = Home Directories</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否支持浏览</span></span><br><span class="line">    browseable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否允许写入</span></span><br><span class="line">    writable = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">允许访问该共享资源的smb用户，@组</span></span><br><span class="line">;    valid users = %S</span><br><span class="line">;    valid users = MYDOMAIN\%S</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打印机共享</span></span><br><span class="line">[printers]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">描述</span></span><br><span class="line">    comment = All Printers</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">路径</span></span><br><span class="line">    path = /var/spool/samba</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否可浏览，no类似隐藏共享</span></span><br><span class="line">    browseable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否支持guest访问，和public指令类似</span>    </span><br><span class="line">    guest ok = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否可写</span></span><br><span class="line">    writable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否允许打印</span></span><br><span class="line">    printable = yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Un-comment the following and create the netlogon directory <span class="keyword">for</span> Domain Logons:</span></span><br><span class="line">;    [netlogon]</span><br><span class="line">;    comment = Network Logon Service</span><br><span class="line">;    path = /var/lib/samba/netlogon</span><br><span class="line">;    guest ok = yes</span><br><span class="line">;    writable = no</span><br><span class="line">;    share modes = no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Un-comment the following to provide a specific roaming profile share.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The default is to use the user<span class="string">&#x27;s home directory:</span></span></span><br><span class="line">;    [Profiles]</span><br><span class="line">;    path = /var/lib/samba/profiles</span><br><span class="line">;    browseable = no</span><br><span class="line">;    guest ok = yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">A publicly accessible directory that is read only, except for users in the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;staff&quot; group (which have write permissions):</span></span></span><br><span class="line">;    [public]</span><br><span class="line">;    comment = Public Stuff</span><br><span class="line">;    path = /home/samba</span><br><span class="line">;    public = yes</span><br><span class="line">;    writable = no</span><br><span class="line">;    printable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">定义允许哪些smb用户写入</span></span></span><br><span class="line">;    write list = +staff</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Samba共享"><a href="#4-3-Samba共享" class="headerlink" title="4.3 Samba共享"></a>4.3 Samba共享</h3><p>案例：在Windows上访问Samba服务器，共享目录为&#x2F;common，指定用cqm1、cqm2用户才能访问，且只有cqm2有写权限。</p>
<ol>
<li>创建Samba用户</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">smbpasswd用户命令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-a 添加用户 smbpasswd -a cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-x 删除用户 smbpasswd -x cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-d 禁用帐号 smbpasswd -d cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-e 取消禁用 smbpasswd -e cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-n 清除密码 smbpasswd -a cqm</span></span><br><span class="line">useradd -s /sbin/nologin cqm1</span><br><span class="line">useradd -s /sbin/nologin cqm2</span><br><span class="line">smbpasswd -a cqm1</span><br><span class="line">smbpasswd -a cqm2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建共享目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /common</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置757是为了让cqm2有写权限</span></span><br><span class="line">chmod 757 /common</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">		workgroup = WORKGROUP</span><br><span class="line">		...</span><br><span class="line">[common]</span><br><span class="line">        comment = samba share directory</span><br><span class="line">        path = /common</span><br><span class="line">        browseable = YES</span><br><span class="line">        hosts allow = 10.0.0.0/8,192.168.88.0/24</span><br><span class="line">        valid users = cqm1,cqm2</span><br><span class="line">        writable = No</span><br><span class="line">        write list = cqm2</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在Windows中输入 \\192.168.88.132 访问</li>
</ol>
<p>首先是cqm1用户</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E4%B8%80.png" alt="Samba一"></p>
<p>可以看到cqm1用户没有写入权限</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E4%BA%8C.png" alt="Samba二"></p>
<p>cqm2用户</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E4%B8%89.png" alt="Samba三"></p>
<p>可以看到cqm2用户有创建文件夹的权限</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E5%9B%9B.png" alt="Samba四"></p>
<h3 id="4-4-Linux挂载"><a href="#4-4-Linux挂载" class="headerlink" title="4.4 Linux挂载"></a>4.4 Linux挂载</h3><ol>
<li>在客户端上安装samba-client</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install samba-client</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>通过smbclient命令访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //192.168.88.132/common -U cqm2%toortoor</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过mount命令挂载</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /common</span><br><span class="line">mount -o username=cqm2,password=toortoor -t cifs //192.168.88.132/common /common</span><br><span class="line">mount</span><br><span class="line">//192.168.88.132/common on /common type cifs (rw,relatime,vers=default,cache=strict,username=cqm2,domain=LOCALHOST,uid=0,noforceuid,gid=0,noforcegid,addr=192.168.88.132,file_mode=0755,dir_mode=0755,soft,nounix,serverino,mapposix,rsize=1048576,wsize=1048576,echo_interval=60,actimeo=1)</span><br></pre></td></tr></table></figure>



<h2 id="五、NFS文件服务"><a href="#五、NFS文件服务" class="headerlink" title="五、NFS文件服务"></a>五、NFS文件服务</h2><h3 id="5-1-NFS服务介绍"><a href="#5-1-NFS服务介绍" class="headerlink" title="5.1 NFS服务介绍"></a>5.1 NFS服务介绍</h3><p>NFS即网络文件系统，它允许网络中的计算机之间通过TCP&#x2F;IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。</p>
<p>NFS应用场景：</p>
<ul>
<li>共享存储服务器：图片服务器、视频服务器</li>
<li>家目录漫游：域用户家目录服务器</li>
<li>文件服务器：文件存储服务器</li>
</ul>
<h3 id="5-2-NFS实现共享"><a href="#5-2-NFS实现共享" class="headerlink" title="5.2 NFS实现共享"></a>5.2 NFS实现共享</h3><ol>
<li>安装NFS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nfs-utils</span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl start nfs</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x2F;etc&#x2F;exports共享文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享格式</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享目录绝对路径 IP地址或网段地址(权限1,权限2)</span></span><br><span class="line">/test 192.168.88.132(rw,sync)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">权限说明</span></span><br><span class="line">ro                      只读访问  </span><br><span class="line">rw                      读写访问  </span><br><span class="line">sync                    所有数据在请求时写入共享  </span><br><span class="line">async                   NFS在写入数据前可以相应请求  </span><br><span class="line">secure                  NFS通过1024以下的安全TCP/IP端口发送  </span><br><span class="line">insecure                NFS通过1024以上的端口发送  </span><br><span class="line">wdelay                  如果多个用户要写入NFS目录，则归组写入（默认）  </span><br><span class="line">no_wdelay               如果多个用户要写入NFS目录，则立即写入，当使用async时，无需此设置。  </span><br><span class="line">hide                    在NFS共享目录中不共享其子目录  </span><br><span class="line">no_hide                 共享NFS目录的子目录  </span><br><span class="line">subtree_check           如果共享/usr/bin之类的子目录时，强制NFS检查父目录的权限（默认）  </span><br><span class="line">no_subtree_check        和上面相对，不检查父目录权限  </span><br><span class="line">all_squash              共享文件的UID和GID映射匿名用户anonymous，适合公用目录。  </span><br><span class="line">no_all_squash           保留共享文件的UID和GID（默认）  </span><br><span class="line">root_squash             root用户的所有请求映射成如anonymous用户一样的权限（默认）  </span><br><span class="line">no_root_squash          root用户具有根目录的完全管理访问权限  </span><br><span class="line">anonuid=xxx          	指定NFS服务器/etc/passwd文件中匿名用户的UID  </span><br><span class="line">anongid=xxx          	指定NFS服务器/etc/passwd文件中匿名用户的GID</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>exportfs共享管理命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exportfs命令：</span><br><span class="line">-a     打开或取消所有目录共享。</span><br><span class="line">-o     options,... 指定一列共享选项，与 exports(5) 中讲到的类似。</span><br><span class="line">-i     忽略 /etc/exports 文件，从而只使用默认的和命令行指定的选项。</span><br><span class="line">-r     重新共享所有目录。它使/var/lib/nfs/xtab和/etc/exports同步。它将/etc/exports中已删除的条目从 /var/lib/nfs/xtab中删除，将内核共享表中任何不再有效的条目移除。</span><br><span class="line">-u     取消一个或多个目录的共享。</span><br><span class="line">-f     在“新”模式下，刷新内核共享表之外的任何东西。</span><br><span class="line">       任何活动的客户程序将在它们的下次请求中得到mountd 添加的新的共享条目。</span><br><span class="line">-v     输出详细信息。当共享或者取消共享时，显示在做什么。</span><br><span class="line">       显示当前共享列表的时候，同时显示共享的选项。</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>设置共享</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建被共享目录</span></span><br><span class="line">mkdir /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置exports</span></span><br><span class="line">vim /etc/exports</span><br><span class="line">/test 192.168.88.0/24(rw,sync)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享</span></span><br><span class="line">exportfs -r</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否共享</span></span><br><span class="line">exportfs -v</span><br><span class="line">showmount -e 192.168.88.132</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>客户端挂载</li>
</ol>
<p>客户端挂载是使用nfsnobody用户进行的，如果是root创建的共享目录，且客户端挂载后要进行读写的话，得给目录757的权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs 192.168.88.132:/test /test</span><br></pre></td></tr></table></figure>



<h2 id="六、iSCSI服务"><a href="#六、iSCSI服务" class="headerlink" title="六、iSCSI服务"></a>六、iSCSI服务</h2><h3 id="6-1-iSCSI介绍"><a href="#6-1-iSCSI介绍" class="headerlink" title="6.1 iSCSI介绍"></a>6.1 iSCSI介绍</h3><p>iSCSI即网络小型计算机系统接口，又被称为IPSAN。实际就是通过网络来共享设备。</p>
<p>数据存储技术：</p>
<ul>
<li>DSA（Direct Attached Storage 直接附加存储）：IDE SATA SAS SCSI（本地磁盘）</li>
<li>NSA（Network Attached Storage 网络附加存储）：Samba NFS（共享文件夹）</li>
<li>SAN（Storage Attached Network 网络附加存储）：iSCSI（共享设备）</li>
</ul>
<h3 id="6-2-iSCSI服务部署"><a href="#6-2-iSCSI服务部署" class="headerlink" title="6.2 iSCSI服务部署"></a>6.2 iSCSI服务部署</h3><ol>
<li>准备好要被挂载的磁盘，这里共享sdb1</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%B8%80.png" alt="iSCSI一"></p>
<ol start="2">
<li>安装iSCSI</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install targetcli</span><br><span class="line">sysetmctl start target</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过targetcli命令添加设备共享</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入命令行</span></span><br><span class="line">targetcli</span><br><span class="line">ls</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">backstores 代表后端存储,iscsi通过使用文件、逻辑卷或任何类型的磁盘作为底层存储来仿真呈现为目标的scsi设备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">block      后端存储是个块设备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">fileio     后端存储是一个文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pscsi      物理scsi设备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ramdisk    后端存储是内存上的空间，在内存上创建一个指定大小的ramdisk设备可以通过<span class="built_in">help</span>命令来打印可用命令</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将要共享的设备添加到backstores存储库中</span></span><br><span class="line">cd backstores/</span><br><span class="line">block/ creat block /dev/sdb1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置IQN标识</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式：iqn.年-月.二级域名倒写:共享名</span></span><br><span class="line">cd ..</span><br><span class="line">iscsi/ create iqn.2021-04.com.cqm:storage</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置TPG组中对应的三个问题 谁 从哪里 访问什么设备</span></span><br><span class="line">cd iscsi/iqn.2021-04.com.cqm:storage/tpg1/</span><br><span class="line">acls/ create iqn.2021-04.com.cqm:client</span><br><span class="line">luns/ create /backstores/block/block</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<h3 id="6-3-iSCSI客户端挂载"><a href="#6-3-iSCSI客户端挂载" class="headerlink" title="6.3 iSCSI客户端挂载"></a>6.3 iSCSI客户端挂载</h3><ol>
<li>安装iSCSI客户端</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install iscsi-initiator-utils</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置客户端名称</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/iscsi/initiatorname.iscsi</span><br><span class="line">InitiatorName=iqn.2021-04.com.cqm:client</span><br><span class="line">systemctl start iscsi</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>发现共享设备</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm --mode discoverydb --type sendtargets --portal 192.168.88.132:3260 --discover</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>连接远程设备</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.88.132:3260 --login</span><br><span class="line">lsblk</span><br><span class="line">...</span><br><span class="line">sdb</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>分区格式化</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/sdb</span><br><span class="line">...</span><br><span class="line">mkfs.ext4 /dev/sdb1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>挂载共享磁盘</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/sdb1</span><br><span class="line">vim /etc/fstab</span><br><span class="line">/dev/sdb1 /root/sdb1                            ext4    _netdev        0 0</span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure>

<h3 id="6-4-iSCSI取消挂载"><a href="#6-4-iSCSI取消挂载" class="headerlink" title="6.4 iSCSI取消挂载"></a>6.4 iSCSI取消挂载</h3><ol>
<li>客户端</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.88.132:3260 --logout</span><br><span class="line">rm -rf /var/lib/iscsi/nodes/iqn.2021-04.com.cqm\:storage/</span><br><span class="line">rm -rf /var/lib/iscsi/send_targets/192.168.88.132,3260/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>服务端</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">倒着删</span></span><br><span class="line">targetcli</span><br><span class="line">iscsi/iqn.2021-04.com.cqm:storage/tpg1/portals/ delete 0.0.0.0 3260</span><br><span class="line">iscsi/iqn.2021-04.com.cqm:storage/tpg1/luns/ delete lun=0</span><br><span class="line">iscsi/iqn.2021-04.com.cqm:storage/tpg1/acls/ delete iqn.2021-04.com.cqm:client</span><br><span class="line">iscsi/ delete iqn.2021-04.com.cqm:storage</span><br><span class="line">backstores/block/ delete block</span><br></pre></td></tr></table></figure>



<h2 id="七、IPSAN多链路部署"><a href="#七、IPSAN多链路部署" class="headerlink" title="七、IPSAN多链路部署"></a>七、IPSAN多链路部署</h2><p>在上边的环境中的共享设备是通过单链路共享的，如果这条链路出现了故障，那么就会出现连接不上共享设备的问题，所以在生产环境中都会配置多链路进行部署。</p>
<p>iSCSI服务端和客户端分别拥有两张不同网段的网卡，就可以配置多链路部署。</p>
<h3 id="7-1-部署多链路"><a href="#7-1-部署多链路" class="headerlink" title="7.1 部署多链路"></a>7.1 部署多链路</h3><ol>
<li>在服务端上设置共享设备，并用两个IP进行共享</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%BA%94.png" alt="iSCSI五"></p>
<ol start="2">
<li>在客户端发现共享设备</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/iscsi/initiatorname.iscsi</span><br><span class="line">InitiatorName=iqn.2021-04.com.cqm:client</span><br><span class="line"></span><br><span class="line">systemctl start iscsi</span><br><span class="line"></span><br><span class="line">iscsiadm --mode discoverydb --type sendtargets --portal 192.168.88.132:3260 --discover 192.168.88.132:3260,1 iqn.2021-04.com.cqm:storage 192.168.99.130:3260,1 iqn.2021-04.com.cqm:storage</span><br><span class="line"></span><br><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.88.132:3260 --login</span><br><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.99.130:3260 --login</span><br></pre></td></tr></table></figure>

<p>这时候通过lsblk命令可以看到多了两块设备，但其实是同一个设备不同名</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%B8%89.png" alt="iSCSI三"></p>
<ol start="3">
<li>安装多路径软件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install device-mapper-multipath</span><br><span class="line">cp /usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf /etc/</span><br><span class="line">systemctl start multipathd</span><br></pre></td></tr></table></figure>

<p>再用lsblk命令查看可发现</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E5%9B%9B.png" alt="iSCSI四"></p>
<ol start="4">
<li>配置多路径运行模式</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">multipath -ll</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wwid:36001405ac25fe1abdfd4eecb1d0624b2</span></span><br><span class="line">mpatha (36001405ac25fe1abdfd4eecb1d0624b2) dm-2 LIO-ORG ,block</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">vim /etc/multipath.conf</span><br><span class="line">multipaths &#123;</span><br><span class="line">        multipath &#123;</span><br><span class="line">                wwid                    36001405ac25fe1abdfd4eecb1d0624b2 # wwid</span><br><span class="line">                alias                   cqm # 起名</span><br><span class="line">                path_grouping_policy    multibus # 多路径组策略</span><br><span class="line">                path_selector           &quot;round-robin 0&quot; # 负载均衡模式</span><br><span class="line">                failback                manual</span><br><span class="line">                rr_weight               priorities # 按优先级轮询</span><br><span class="line">                no_path_retry           5 # 重试时间5s</span><br><span class="line">        &#125;</span><br><span class="line">        multipath &#123;</span><br><span class="line">                wwid                    1DEC_____321816758474</span><br><span class="line">                alias                   red</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart multipathd</span><br><span class="line">systemctl restart iscsi</span><br><span class="line"></span><br><span class="line">multipath -ll</span><br><span class="line">cqm (36001405ac25fe1abdfd4eecb1d0624b2) dm-2 LIO-ORG ,block</span><br><span class="line">size=1023M features=&#x27;1 queue_if_no_path&#x27; hwhandler=&#x27;0&#x27; wp=rw</span><br><span class="line">`-+- policy=&#x27;round-robin 0&#x27; prio=1 status=active</span><br><span class="line">  |- 5:0:0:0 sdb 8:16 active ready running</span><br><span class="line">  `- 6:0:0:0 sdc 8:32 active ready running</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>挂载</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/test</span><br><span class="line">mount /dev/mapper/cqm1 /root/test</span><br></pre></td></tr></table></figure>

<h3 id="7-2-测试"><a href="#7-2-测试" class="headerlink" title="7.2 测试"></a>7.2 测试</h3><p>将一块网卡断掉，看是否还能使用iSCSI设备</p>
<ol>
<li>断开网卡ens33</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifdown ens33</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E5%85%AD.png" alt="iSCSI六"></p>
<ol start="2">
<li>依旧可以在iSCSI设备上写入数据</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%B8%83.png" alt="iSCSI七"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:01:00.205Z" title="2/18/2024, 7:01:00 PM">2024-02-18</time></span><span class="level-item">28 minutes read (About 4127 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/redis/">Redis</a></p><div class="content"><h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>REmote DIctionary Server（Redis）是一个由 Salvatore Sanfilippo 写的 key-value 存储系统，是跨平台的非关系型数据库。</p>
<p><img src="/2024/02/18/redis/redis_logo.jpeg" alt="redis_logo"></p>
<p>Redis 就是一款 NoSQL，而 NoSQL 就是指非关系型数据库，主要分为四种：</p>
<ol>
<li>键值型：Redis</li>
<li>文档型：ElasticSearch、Mongdb</li>
<li>面向列：Hbase</li>
<li>图形化：Neo4j</li>
</ol>
<h2 id="二、Redis基础"><a href="#二、Redis基础" class="headerlink" title="二、Redis基础"></a>二、Redis基础</h2><h3 id="2-1-Redis安装"><a href="#2-1-Redis安装" class="headerlink" title="2.1 Redis安装"></a>2.1 Redis安装</h3><ol>
<li>通过 docker-compose 安装 redis</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入容器内部测试 redis</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接redis</span></span><br><span class="line">redis-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span>新建键值对</span></span><br><span class="line">set key value</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get获取键值</span></span><br><span class="line">get key</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Redis常用命令"><a href="#2-2-Redis常用命令" class="headerlink" title="2.2 Redis常用命令"></a>2.2 Redis常用命令</h3><p>redis 的数据存储结构有以下几种：</p>
<ul>
<li>key-string（字符串）：一个 key 对应一个值</li>
<li>key-hash（哈希）：一个 key 对应一个 map</li>
<li>key-list（列表）：一个 key 对应一个列表</li>
<li>key-set（集合）：一个 key 对应一个集合</li>
<li>key-zset（有序集合）：一个 key 对应一个有序的集合</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%80.png" alt="redis一"></p>
<h4 id="2-2-1-string常用命令"><a href="#2-2-1-string常用命令" class="headerlink" title="2.2.1 string常用命令"></a>2.2.1 string常用命令</h4><ol>
<li>设置值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set key value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>取值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>批量操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mset key1 value1 key2 value2 ...</span><br><span class="line">mget key1 key2 ... </span><br></pre></td></tr></table></figure>

<ol start="4">
<li>自增</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incr key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>自减</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decr key</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>自增自减指定数量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">incrby key number</span><br><span class="line">decrby key number</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>设置值的同时指定生存时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key seconds value</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>设置值，如果当前 key 不存在如同 set，如果存在则说明都不做</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key value</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>在 key 对应的 value 后追加内容</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key value</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>查看 value 字符串长度</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-hash常用命令"><a href="#2-2-2-hash常用命令" class="headerlink" title="2.2.2 hash常用命令"></a>2.2.2 hash常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hset key field value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hget key field</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>批量操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hmset key1 field1 value1 field2 value2 ...</span><br><span class="line">hmget key1 firle1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>指定自增</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hincrby key field number</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>设置值，如果当前 key 不存在如同 set，如果存在则说明都不做</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hsetnx key field value</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>检查 field 是否存在</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexists key field</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>删除某个 field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdel key field1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>获取当前 hash 结构中的全部 field 和 value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgetall key</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>获取当前 hash 结构中的全部 field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hkeys key</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>获取当前 hash 结构中的全部 value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hvals key</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>获取当前 hash 中 field 的数量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-list常用命令"><a href="#2-2-3-list常用命令" class="headerlink" title="2.2.3 list常用命令"></a>2.2.3 list常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从左侧插入数据</span></span><br><span class="line">lpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从右侧插入数据</span></span><br><span class="line">rpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果key不存在，什么都不做，如果key存在但不是list结构，也什么都不做</span></span><br><span class="line">lpushx key value1 value2 ...</span><br><span class="line">rpushx key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过索引位置添加value</span></span><br><span class="line">lset key index value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">左侧弹出数据并移除</span></span><br><span class="line">lpop key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">右侧弹出数据并移除</span></span><br><span class="line">rpop key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取一定范围的数据，start从0开始，stop为-1时为最后一个value，-2时为倒数第二个value</span></span><br><span class="line">lrange key start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据索引位置获取value</span></span><br><span class="line">lindex key index</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取整个list的长度</span></span><br><span class="line">llen key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除list中count个value的值，当count&gt;0，从左向右删除，但count&lt;0，从右向左删除，但count==0，全部删除</span></span><br><span class="line">lrem key count value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保留列表中指定范围内的数据，超出这个范围的都会被移除</span></span><br><span class="line">ltrim start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将list1中的最后一个数据弹出，插入到list2中的第一个位置</span></span><br><span class="line">rpoplpush key1 key2</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-set常用命令"><a href="#2-2-4-set常用命令" class="headerlink" title="2.2.4 set常用命令"></a>2.2.4 set常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">value不允许重复，且数据无序排列</span></span><br><span class="line">sadd key value1 value2 ...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取全部数据</span></span><br><span class="line">smembers key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">随机获取数据，并移除，可加弹出数量</span></span><br><span class="line">spop key number</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的交集</span></span><br><span class="line">sinter key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的并集</span></span><br><span class="line">sunion key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的差集</span></span><br><span class="line">sdiff key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前<span class="built_in">set</span>是否包含某个值</span></span><br><span class="line">sismember key value</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5-zset常用命令"><a href="#2-2-5-zset常用命令" class="headerlink" title="2.2.5 zset常用命令"></a>2.2.5 zset常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">score必须是数值，value不允许重复</span></span><br><span class="line">zadd key score1 value1 score2 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改score，如果value存在则增加分数，如果不存在则相当于zadd</span></span><br><span class="line">zincrby key number value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看指定value的分数</span></span><br><span class="line">zscore key value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取value数量</span></span><br><span class="line">zcard key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据score范围查询value数量</span></span><br><span class="line">zcount key min max</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据分数从小到大排序，获取指定范围内的数据，添加了withscores参数会返回value的具体score</span></span><br><span class="line">zrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从大到小</span></span><br><span class="line">zrevrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据分数的范围获取数据，如果不希望包括min和max的值可以用(min max)的方式，最大最小值用±inf表示</span></span><br><span class="line">zrangebyscore key min max withscores [limit,offset,count]</span><br><span class="line">zrevrangebyscore key max min withscores [limit,offset,count]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-6-key常用命令"><a href="#2-2-6-key常用命令" class="headerlink" title="2.2.6 key常用命令"></a>2.2.6 key常用命令</h4><ol>
<li>查看所有key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看某个key是否存在</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del key</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>设置key的生存时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位为s</span></span><br><span class="line">expire key seconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位为ms</span></span><br><span class="line">pexpire key milliseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定生存到某个时间点</span></span><br><span class="line">expireat key timestamp</span><br><span class="line">pexpireat key millseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看key的剩余生存时间，返回-2则key不存在，-1则没设置生存时间</span></span><br><span class="line">ttl key</span><br><span class="line">pttl key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除生存时间</span></span><br><span class="line">persist key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>选择操作的库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis默认有16个库</span></span><br><span class="line">select 0~15</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动key到另一个库中</span></span><br><span class="line">move key db</span><br></pre></td></tr></table></figure>

<h4 id="2-2-7-库的常用命令"><a href="#2-2-7-库的常用命令" class="headerlink" title="2.2.7 库的常用命令"></a>2.2.7 库的常用命令</h4><ol>
<li>清空当前所在数据库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdb</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>清空所有数据库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdball</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看当前库有多少key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbsize</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>查看最后一次操作的时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lastsave</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>实时监控redis接收到的命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monitor</span><br></pre></td></tr></table></figure>



<h2 id="三、Redis配置"><a href="#三、Redis配置" class="headerlink" title="三、Redis配置"></a>三、Redis配置</h2><h3 id="3-1-Redis的AUTH"><a href="#3-1-Redis的AUTH" class="headerlink" title="3.1 Redis的AUTH"></a>3.1 Redis的AUTH</h3><ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置 Redis 连接密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">requirepass toortoor</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入 Redis 之后都需要输入密码才可以创建 key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">auth toortoor</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Redis的事务"><a href="#3-2-Redis的事务" class="headerlink" title="3.2 Redis的事务"></a>3.2 Redis的事务</h3><p>Redis 事务可以一次执行多个命令， 并且带有以下三个重要的保证：</p>
<ul>
<li>批量操作在发送 EXEC 命令前被放入队列缓存</li>
<li>收到 EXEC 命令后进入事务执行，事务中任意命令执行失败，其余的命令依然被执行</li>
<li>在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中</li>
</ul>
<p>一个事务从开始到执行会经历以下几个阶段：</p>
<ul>
<li>开始事务：multi</li>
<li>命令入队：……</li>
<li>执行事务：exec</li>
<li>取消事务：discard</li>
<li>监听：在开启事务之前，先通过 watch 监听事务中要操作的 key，如果在事务过程中有其他的客户端修改了 key，那么事务将会被取消</li>
</ul>
<p>事务可以理解为一个打包的批量执行脚本，但批量指令并非原子化的操作，中间某条指令的失败不会导致前面已做指令的回滚，也不会造成后续的指令不做。</p>
<ol>
<li>监听</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch name age gander</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>开始事务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>命令入队</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line">set gander male</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>执行事务&#x2F;取消事务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec/discard</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Redis的持久化"><a href="#3-3-Redis的持久化" class="headerlink" title="3.3 Redis的持久化"></a>3.3 Redis的持久化</h3><h4 id="3-3-1-RDB持久化"><a href="#3-3-1-RDB持久化" class="headerlink" title="3.3.1 RDB持久化"></a>3.3.1 RDB持久化</h4><p>Redis 的配置文件位于 Redis 安装目录,	ROB 是默认的持久化机制。</p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="comment"># 加载redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis.conf</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">redis.conf</span></span><br><span class="line"><span class="comment"># 在900秒内有1一个 key 发生了变化，就执行 RDB 持久化</span></span><br><span class="line"><span class="string">save</span> <span class="number">900</span> <span class="number">1</span></span><br><span class="line"><span class="string">save</span> <span class="number">300</span> <span class="number">10</span></span><br><span class="line"><span class="string">save</span> <span class="number">60</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># 开启RDB持久化</span></span><br><span class="line"><span class="string">rdbchecksum</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># RDB持久化名称</span></span><br><span class="line"><span class="string">dbfilename</span> <span class="string">dump.rdb</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试持久化</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭redis并保存</span></span><br><span class="line">shutdown save</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>可以看到 data 目录下多了个 rdb 文件，即使 redis 容器重启也不会造成 key 的丢失</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%8C.png" alt="redis二"></p>
<h4 id="3-3-2-AOF持久化"><a href="#3-3-2-AOF持久化" class="headerlink" title="3.3.2 AOF持久化"></a>3.3.2 AOF持久化</h4><p>AOF 比起 RDB 有更高的数据安全性，如果同时开启了 AOF 和 RDB，那么前者比后者的优先级更高，且如果先开启了 RDB 在开启 AOF，那么 RDB 中的内容会被 AOF 的内容覆盖。</p>
<ol>
<li>redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启AOF持久化</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF文件名</span></span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF持久化执行策略</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">always:每次执行写操作都调用fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">everysec:最多每秒调用一次fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no:根据环境的不同在不确定的时间调用fsync</span></span><br><span class="line">appendfsync always|everysec|no</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>重启 docker-compose 测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set gander male</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不RDB持久化</span></span><br><span class="line">shutdown nosave</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到 data 目录下多了个 aof 文件，即 AOF 持久化生成的文件</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%B8%89.png" alt="redis三"></p>
<h3 id="3-4-Redis主从架构"><a href="#3-4-Redis主从架构" class="headerlink" title="3.4 Redis主从架构"></a>3.4 Redis主从架构</h3><p>Redis 的主从架构是指 Master 节点负责写操作，而其余的 Slave 节点负责读操作。</p>
<p><img src="/2024/02/18/redis/redis%E5%9B%9B.png" alt="redis四"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="comment"># 连接redis-master容器，并将该容器ip地址映射为master</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>从节点 redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slaveof &lt;主节点地址&gt; &lt;端口&gt;</span></span><br><span class="line">slaveof master 6379</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动后进入容器内部通过 <code>info</code> 可看到节点信息</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%94.png" alt="redis五"></p>
<h3 id="3-5-Redis哨兵模式"><a href="#3-5-Redis哨兵模式" class="headerlink" title="3.5 Redis哨兵模式"></a>3.5 Redis哨兵模式</h3><p>Redis 的主从架构有一个很明显的问题，就是当 Master 节点出现问题宕机后，那么 Redis 集群就没有可以进行写操作的 Redis 了，而哨兵就可以解决该问题。</p>
<p>在每个节点中都会有个哨兵与 Redis 进行连接，且哨兵与哨兵之间也会进行连接，如果 Master 节点出现故障宕机了，那么哨兵们就会选出一个 Slave 来作为新的 Master 来提供写的操作。</p>
<p><img src="/2024/02/18/redis/redis%E5%85%AD.png" alt="redis六"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel1.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel2.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel3.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Master 节点 sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以守护进程的方式运行redis</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定Master节点，sentinel monitor &lt;名称&gt; &lt;ip&gt; &lt;端口&gt; &lt;Slave个数&gt;</span></span><br><span class="line">sentinel monitor master localhost 6379 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定哨兵每隔多久检测一次redis主从架构</span></span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Slave 节点 sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">sentinel monitor master master 6379 2</span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>进入容器启动哨兵，当 Master 节点出现问题后，就会在两个 Slave 中选出一个作为新的 Master，而旧的 Master 启动后就会变为新的 Slave</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel /data/sentinel.conf</span><br></pre></td></tr></table></figure>

<h3 id="3-6-Redis集群"><a href="#3-6-Redis集群" class="headerlink" title="3.6 Redis集群"></a>3.6 Redis集群</h3><p>Redis 集群在保证主从和哨兵的基本功能之外，还能提高 Redis 存储数据的能力，主要的特点如下</p>
<ul>
<li>Redis 集群是无中心的</li>
<li>Redis 集群有ping-pang的机制</li>
<li>投票机制，集群节点的数量必须是 2n+1</li>
<li>分配了 16484 个 hash 槽，在存储数据时，会对 key 进行 crc16 的算法，并对 16384 进行取余，通过结果分配到对应的节点上，每个节点都有自己维护的 hash 槽</li>
<li>每个主节点都要跟一个从节点，但这里的从节点只管备份，不管查询</li>
<li>集群中半数的节点宕机后，那么集群就瘫痪</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%83.png" alt="redis七"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17001</span><span class="string">:17001</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17002</span><span class="string">:17002</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis3:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17003</span><span class="string">:17003</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis4:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis4</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7004</span><span class="string">:7004</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17004</span><span class="string">:17004</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis4.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis5:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis5</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7005</span><span class="string">:7005</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17005</span><span class="string">:17005</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis5.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis6:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7006</span><span class="string">:7006</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17006</span><span class="string">:17006</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis6.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis{1..6}.conf，x 为 {1..6}</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定redis端口</span></span><br><span class="line"><span class="string">port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line"><span class="string">cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># 集群信息文件</span></span><br><span class="line"><span class="string">cluster-config-file</span> <span class="string">nodes-700x.conf</span></span><br><span class="line"><span class="comment"># 集群对外ip</span></span><br><span class="line"><span class="string">cluster-announce-ip</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.135</span></span><br><span class="line"><span class="comment"># 集群对外端口</span></span><br><span class="line"><span class="string">cluster-announce-port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># 集群总线端口</span></span><br><span class="line"><span class="string">cluster-announce-bus-port</span> <span class="string">1700x</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入任意 reids 容器创建集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--cluster-replicas:每个主节点分配的从节点个数</span></span><br><span class="line">redis-cli --cluster create 192.168.88.135:7001 192.168.88.135:7002 192.168.88.135:7003 192.168.88.135:7004 192.168.88.135:7005 192.168.88.135:7006 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>由于每个主节点都被分配了不同的 hash 槽，所以要在容器内任意切换不同的 redis 节点需要加参数 <code>-c</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.88.135 -p 7001 -c</span><br></pre></td></tr></table></figure>



<h2 id="四、Redis常见问题"><a href="#四、Redis常见问题" class="headerlink" title="四、Redis常见问题"></a>四、Redis常见问题</h2><h3 id="4-1-Redis的删除策略"><a href="#4-1-Redis的删除策略" class="headerlink" title="4.1 Redis的删除策略"></a>4.1 Redis的删除策略</h3><p>当 key 的生存时间到了，Redis 并不会立即删除该 key，而是遵守以下删除策略来进行删除</p>
<ul>
<li>定期删除：Redis 每隔一段时间就回去查看设置了生存时间的 key，默认是 100ms 查看 3 个 key</li>
<li>惰性删除：当用户去查询已经超过了生存时间的 key，Redis 会先查看该 key 是否已经超过了生存时间，如果超过，那么 Redis 会将该 key 删除并给用户返回一个空值</li>
</ul>
<h3 id="4-2-Redis的淘汰机制"><a href="#4-2-Redis的淘汰机制" class="headerlink" title="4.2 Redis的淘汰机制"></a>4.2 Redis的淘汰机制</h3><p>当 Redis 内存满的时候添加了一个新的数据，那么就会执行 Redis 的淘汰机制，通过 <code>maxmemory-policy</code> 来设置，参数如下</p>
<ol>
<li><p>volatile-lru：当内存不足时，会删除一个设置了生存时间且最近最少使用的 key</p>
</li>
<li><p>allkeys-lru：当内存不足时，会删除一个设置了最近最少使用的 key</p>
</li>
<li><p>volatile-lfu：当内存不足时，会删除一个设置了生存时间且最近使用频率最低的 key</p>
</li>
<li><p>allkeys-lfu：当内存不足时，会删除一个设置了最近使用频率最低的 key</p>
</li>
<li><p>volatile-random：当内存不足时，会随机删除一个设置了生存时间的 key</p>
</li>
<li><p>allkeys-random：当内存不足时，会随机删除一个 key</p>
</li>
<li><p>volatile-ttl：当内存不足时，会删除一个生存时间最少的 key</p>
</li>
<li><p>noeviction：内存不足时，直接报错</p>
</li>
</ol>
<h3 id="4-3-缓存问题"><a href="#4-3-缓存问题" class="headerlink" title="4.3 缓存问题"></a>4.3 缓存问题</h3><p><strong>缓存穿透</strong></p>
<p>当客户查询的数据 Redis 中没有，数据库中也没有，且请求量特别大时，就会导致数据库的压力过大，解决方法如下</p>
<ul>
<li>根据 id 查询时，如果 id 是自增的，那么可以将最大的 id 放到 Reids 中，当查询数据时直接对比 id 即可</li>
<li>如果 id 不是 int 型，那么可以将全部的 id 放入 set 中，用户查询之前可以先到 set 查看是否有该 id</li>
<li>获取用户的 ip 地址，对该地址进行访问限制</li>
</ul>
<p><strong>缓存击穿</strong></p>
<p>当用户查询的是热点数据时，那么并发量肯定是很高的，当 Redis 中的热点数据过期了，那么数据库的压力就会很大，甚至宕机，解决方法如下</p>
<ul>
<li>在访问热点数据时，缓存中没有的时候，可以添加一把锁，让几个请求去访问数据库，避免数据库宕机</li>
<li>把热点数据的生存时间去掉</li>
</ul>
<p><strong>缓存雪崩</strong></p>
<p>当大量缓存同时到期时，导致请求都去到了数据库，也很容易导致数据库宕机，解决方法如下</p>
<ul>
<li>对缓存中的数据设置一个随机的生存时间，避免同时过期</li>
</ul>
<p><strong>缓存倾斜</strong></p>
<p>如果将热点数据放在集群中的某一 Redis 节点上时，那么大量的数据都会去到该 Redis 节点，导致节点宕机，解决方法如下</p>
<ul>
<li>主从架构，准备大量的从节点</li>
<li>在 Tomcat 中做 JVM 缓存，在查询 Redis 前先查询 JVM 缓存</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:58.270Z" title="2/18/2024, 7:02:58 PM">2024-02-18</time></span><span class="level-item">18 minutes read (About 2754 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/zookeeper/">Zookeeper</a></p><div class="content"><p><img src="/2024/02/18/zookeeper/logo.jpg" alt="logo"></p>
<p>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务，是 Hadoop 和 Hbase 的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。</p>
<h2 id="一、Zookeeper基础"><a href="#一、Zookeeper基础" class="headerlink" title="一、Zookeeper基础"></a>一、Zookeeper基础</h2><h3 id="1-1-使用场景"><a href="#1-1-使用场景" class="headerlink" title="1.1 使用场景"></a>1.1 使用场景</h3><ul>
<li>分布式协调组件：通过 watch 机制可以协调好节点之间的数据一致性</li>
<li>分布式锁：通过分布式锁可以做到强一致性</li>
<li>无状态化实现</li>
<li>负载均衡</li>
<li>数据发布&#x2F;订阅</li>
<li>命名服务</li>
</ul>
<h3 id="1-2-部署"><a href="#1-2-部署" class="headerlink" title="1.2 部署"></a>1.2 部署</h3><p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>zoo.cfg</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/datalog</span><br><span class="line"><span class="comment"># 基本时间配置（毫秒）</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># 初始化连接到leader的最大时长，单位为倍数，即初始化时间为tickTime * initLimit</span></span><br><span class="line">initLimit=5</span><br><span class="line"><span class="comment"># follower与leader数据同步的最大时长</span></span><br><span class="line">syncLimit=2</span><br><span class="line"><span class="comment"># 保存数据的快照数量</span></span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line"><span class="comment"># 自动触发清除任务时间间隔，以小时为单位，默认为0，表不清除</span></span><br><span class="line">autopurge.purgeInterval=0</span><br><span class="line"><span class="comment"># 客户端与zk的最大并发连接数</span></span><br><span class="line">maxClientCnxns=60</span><br><span class="line"><span class="comment"># 开启standaloneEnabled模式，即独立部署</span></span><br><span class="line">standaloneEnabled=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启adminServer</span></span><br><span class="line">admin.enableServer=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 2181是为客户端提供的端口</span></span><br><span class="line">server.1=zk01:2888:3888;2181</span><br></pre></td></tr></table></figure>

<h3 id="1-3-基本命令"><a href="#1-3-基本命令" class="headerlink" title="1.3 基本命令"></a>1.3 基本命令</h3><ol>
<li>启动|关闭|查看状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start|stop|status</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 zk</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看内部数据结构</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls [path]</span><br></pre></td></tr></table></figure>



<h2 id="二、内部数据结构"><a href="#二、内部数据结构" class="headerlink" title="二、内部数据结构"></a>二、内部数据结构</h2><h3 id="2-1-是如何存储数据的"><a href="#2-1-是如何存储数据的" class="headerlink" title="2.1 是如何存储数据的"></a>2.1 是如何存储数据的</h3><p>Zookeeper 中的数据是保存在节点上的，即 znode，多个 znode 就构成一个树的结构。</p>
<p><img src="/2024/02/18/zookeeper/zk%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png" alt="zk数据存储结构"></p>
<p>如图，a 和 b 就是 Zookeeper 的 znode，创建 znode 方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create /[znode_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建节点并创建一个数据</span></span><br><span class="line">create /[znode_name] [data_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取数据</span></span><br><span class="line">get [znode_name]</span><br></pre></td></tr></table></figure>

<h3 id="2-2-znode结构"><a href="#2-2-znode结构" class="headerlink" title="2.2 znode结构"></a>2.2 znode结构</h3><p>Zookeeper 中的 zonode，包含以下几个部分：</p>
<ul>
<li>data：保存数据</li>
<li>acl：权限<ul>
<li>c：创建权限</li>
<li>w：写权限</li>
<li>r：读权限</li>
<li>d：删除权限</li>
<li>a：admin 管理者权限</li>
</ul>
</li>
<li>stat：描述当前 znode 的元数据</li>
<li>child：当前节点的子节点</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看znode详细信息</span></span><br><span class="line">get -s /[znode_name]</span><br><span class="line">cZxid:创建节点的事务ID</span><br><span class="line">ctime:创建节点时间</span><br><span class="line">mZxid:修改节点的事务ID</span><br><span class="line">mtime:修改节点时间</span><br><span class="line">pZxid:添加和删除子节点的事务ID</span><br><span class="line">cversion:当前节点的子节点版本号，初始值为-1，每对该节点的子节点进行操作，这个cversion都会自动增加</span><br><span class="line">dataVersion:数据版本初识版本为0，每对该节点的数据进行操作，这个dataVersion都会自动增加</span><br><span class="line">aclVersion:权限版本</span><br><span class="line">ephemeralOwne:如果当前节点是临时节点，该值是当前节点的session id，如果不是临时节点则为0</span><br><span class="line">dataLength:数据长度</span><br><span class="line">numChildren:该节点的子节点个数</span><br></pre></td></tr></table></figure>

<h3 id="2-3-znode类型"><a href="#2-3-znode类型" class="headerlink" title="2.3 znode类型"></a>2.3 znode类型</h3><ul>
<li>持久节点：在会话结束后仍会存在</li>
<li>持久序号节点：根据先后顺序，会在结点之后带上一个数值，适用于分布式锁的场景（单调递增）</li>
<li>临时节点：会话结束后会自动删除，适用于注册与服务发现的场景</li>
<li>临时序号节点：跟持久序号节点相同，适用于分布式锁的场景</li>
<li>容器节点：当容器节点中没有任何子节点时，该容器节点会被定期删除（60s）</li>
<li>TTL 节点：可以指定节点的到期时间</li>
</ul>
<p><strong>持久序号节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>临时节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>临时序号节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>容器节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -c /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>TTL 节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过系统配置开启</span></span><br><span class="line">zookeeper.extendedTypesEnabled=true</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/zookeeper/%E6%8C%81%E4%B9%85%E4%B8%8E%E4%B8%B4%E6%97%B6%E8%8A%82%E7%82%B9.png" alt="持久与临时节点"></p>
<p><strong>持久节点</strong></p>
<p>持久节点在创建后服务端会发送一个 <code>session id</code>，并一直保留着。</p>
<p><strong>临时节点</strong></p>
<p>临时节点在创建时后服务器也会发送一个 <code>session id</code>，在会话持续的过程中客户端会不断向服务端续约 <code>session id</code> 的时间，当客户端没有继续续约，而服务端内部的计时器到期时，就会将该 <code>session id</code> 所对应的 znode 全部删除。</p>
<h3 id="2-4-持久化机制"><a href="#2-4-持久化机制" class="headerlink" title="2.4 持久化机制"></a>2.4 持久化机制</h3><p>Zookeeper 的数据是运行在内存中的，所以提供了两种持久化机制：</p>
<ul>
<li>事务日志：Zookeeper 将执行过的命令以日志的形式存储在 dataLogDir &#x2F; dataDir 中，类似于 redis 的 AOF</li>
<li>数据快照：在一定时间间隔内做一次数据快照，存储在快照文件中（snapshot），类似于 redis 的RDB</li>
</ul>
<p>Zookeeper 通过这两种持久化机制，在恢复数据时先将快照文件中的数据恢复到内存中，再用日志文件中的数据做增量恢复，可以实现高效的持久化。</p>
<h2 id="三、zkCli的使用"><a href="#三、zkCli的使用" class="headerlink" title="三、zkCli的使用"></a>三、zkCli的使用</h2><ol>
<li>递归查询</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -R /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>删除节点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deleteall /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>乐观锁删除</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete -v [version] /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>给当前会话注册用户，并创建节点赋予该用户权限</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addauth digest [user]:[password]</span><br><span class="line">create /[znode_name] auth:[user]:[password]:[privileges]</span><br></pre></td></tr></table></figure>



<h2 id="四、分布式锁"><a href="#四、分布式锁" class="headerlink" title="四、分布式锁"></a>四、分布式锁</h2><p>在分布式的环境下，如果在一个节点去上了个锁，当请求被负载均衡分配到了其它节点，那么锁就无法形成互斥，所以节点之间使用 Zookeeper，做一个协调中心，将锁上传到 Zookeeper，其它节点要用到就去 Zookeeper 拿这个锁，这就是分布式锁。</p>
<p>Zookeeper 锁的分类：</p>
<ul>
<li>读锁：大家都可以读，前提是之前没有写锁。（读锁比喻成约会，大家都有机会和女神约会，约会前提是女神没结婚）</li>
<li>写锁：只有写锁才能写，前提是不能有任何锁。（写锁比喻成结婚，结婚后只有老公能和女神约会，结婚前提是女神和其他人的关系断干净了）</li>
</ul>
<h3 id="4-1-上读锁"><a href="#4-1-上读锁" class="headerlink" title="4.1 上读锁"></a>4.1 上读锁</h3><ul>
<li>创建一个临时序号节点，节点数据是 read，表示为读锁</li>
<li>获取当前 Zookeeper 中序号比自己小的所有节点</li>
<li>判断最小节点是否为读锁：<ul>
<li>如果是读锁：则上锁失败，因为如果最小节点是读锁，那么后面就不可能有写锁，接着为最小节点设置监听，Zookeeper 的 watch 机制会在最小节点发生变化时通知当前节点，再进行后面的步骤，被称为阻塞等待</li>
<li>如果不是读锁：则上锁成功</li>
</ul>
</li>
</ul>
<h3 id="4-2-上写锁"><a href="#4-2-上写锁" class="headerlink" title="4.2 上写锁"></a>4.2 上写锁</h3><ul>
<li>创建一个临时序号节点，节点数据是 write，表示为写锁</li>
<li>获取 Zookeeper 中的所有节点</li>
<li>判断自己是否为最小节点：<ul>
<li>如果是：上锁成功</li>
<li>如果不是：说明前面还有锁，所以上锁失败，接着监听最小节点，如果最小节点发生变化，则重新进行第二步</li>
</ul>
</li>
</ul>
<p><strong>羊群效应</strong></p>
<p>假设有一百个请求都是要去写锁，那么就会有一百个请求去监听最小节点，那么 Zookeeper 的压力就会非常大，解决方法是将这一百个请求按请求顺序排列，后一个请求去监听前一个请求即可，实现链式监听。</p>
<h3 id="4-3-watch机制"><a href="#4-3-watch机制" class="headerlink" title="4.3 watch机制"></a>4.3 watch机制</h3><p>Zookeeper 的 watch 可以看作是一个触发器，当监控的 znode 发生改变，就会触发 znode 上注册的对应事件，请求 watch 的客户端就会接收到异步通知。</p>
<p><strong>zkCli.sh 中使用 watch</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一次性监听，监听节点内容</span></span><br><span class="line">get -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听目录，但所监听节点下创建和删除子节点不会触发监听</span></span><br><span class="line">ls -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">与上面相对，都会触发监听</span></span><br><span class="line">ls -R -w /test</span><br></pre></td></tr></table></figure>



<h2 id="五、集群部署"><a href="#五、集群部署" class="headerlink" title="五、集群部署"></a>五、集群部署</h2><p>Zookeeper 的集群角色有三个：</p>
<ul>
<li>Leader：处理集群所有事务的请求，集群只有一个 Leader</li>
<li>Follower：只处理读请求，参与 Leader 选举</li>
<li>Observer：只处理读请求，提升集群的性能，但不能参与 Leader 选举</li>
</ul>
<p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zk01:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="comment"># 2888:用于集群内zk之间的通信</span></span><br><span class="line">      <span class="comment"># 3888:用于选举投票</span></span><br><span class="line">      <span class="comment"># 2181:客户端使用</span></span><br><span class="line">      <span class="comment"># 要创建observer则在2181端口后加:observer</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">zk02:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2182</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">zk03:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2183</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>通过命令查看节点角色</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh status</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure>

<p><strong>连接集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh -server zk01:2181,zk02:2181,zk03:2181</span><br></pre></td></tr></table></figure>

<h3 id="5-1-ZAB协议"><a href="#5-1-ZAB协议" class="headerlink" title="5.1 ZAB协议"></a>5.1 ZAB协议</h3><p>ZAB（Zookeeper Atomic Broadcast）即 Zookeeper 原子广播协议，通过这个协议解决了集群数据一致性和崩溃恢复的问题。</p>
<p><strong>ZAB 协议中节点的四种状态</strong></p>
<ul>
<li>Looking：选举状态</li>
<li>Following</li>
<li>Leading</li>
<li>Observing</li>
</ul>
<p><strong>初始化集群时 leader 的选举</strong></p>
<ul>
<li>当集群中两台节点启动时，就会开始 leader 的选举，选票的格式为 <code>(myid,zXid)</code></li>
<li>第一轮投票时，每个节点会生成自己的选票，即自己的 <code>(myid,zXid)</code>，然后将选票给到对方，这时候每个节点就会有两张选票，即自己的和对方节点的</li>
<li>接着就会比较两张选票的 <code>zXid</code>，如果都相同就对比 <code>myid</code>，将大的一票投到投票箱中</li>
<li>第二轮投票时，每个节点会将上一轮投出去的选票给到其它节点，然后再对比 <code>(myid,zXid)</code>，将大的一票投出去，就能够选出 leader</li>
<li>后来新启动的节点会发现已经有 leader了，就不用做选举的过程了</li>
<li>可以看出初始化集群时，leader 的选举主要看 <code>myid</code></li>
</ul>
<p><strong>崩溃恢复时的 leader 选举</strong></p>
<p>在 leader 确定了之后，leader 会周期性地向 follower 发送心跳包，当 follower 没有收到 leader 发送过来的心跳包，就会进入选举过程，这时候集群不能对外提供服务。</p>
<ul>
<li>当 leader 挂了之后，follower 的状态会变成 looking</li>
<li>接着就进行选举投票，过程和初始化集群时一样</li>
</ul>
<h3 id="5-2-主从同步原理"><a href="#5-2-主从同步原理" class="headerlink" title="5.2 主从同步原理"></a>5.2 主从同步原理</h3><p><img src="/2024/02/18/zookeeper/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86.png" alt="主从同步原理"></p>
<h3 id="5-3-NIO和BIO"><a href="#5-3-NIO和BIO" class="headerlink" title="5.3 NIO和BIO"></a>5.3 NIO和BIO</h3><p><strong>NIO</strong></p>
<p>用于被客户端连接的 2181 端口，使用的就是 NIO 的连接模式；客户端开启 watch 时，使用的也是 NIO。</p>
<p><strong>BIO</strong></p>
<p>集群在进行选举时，多个节点之间的通信端口，使用的是 BIO 的连接模式。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:24.353Z" title="2/18/2024, 7:02:24 PM">2024-02-18</time></span><span class="level-item">an hour read (About 10192 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/web/">Web</a></p><div class="content"><h2 id="一、Apache"><a href="#一、Apache" class="headerlink" title="一、Apache"></a>一、Apache</h2><h3 id="1-1-Apache介绍"><a href="#1-1-Apache介绍" class="headerlink" title="1.1 Apache介绍"></a>1.1 Apache介绍</h3><p>Apache HTTP Server（简称Apache）是Apache软件基金会的一个开放源码的网页服务器，是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。它快速、可靠并且可通过简单的API扩充，将Perl&#x2F;Python等解释器编译到服务器中。</p>
<p>Apache HTTP服务器是一个模块化的服务器，源于NCSAhttpd服务器，经过多次修改，成为世界使用排名第一的Web服务器软件。</p>
<p>Apache官方文档：<a target="_blank" rel="noopener" href="http://httpd.apache.org/docs/">http://httpd.apache.org/docs/</a></p>
<h3 id="1-2-通过脚本源码安装Apache"><a href="#1-2-通过脚本源码安装Apache" class="headerlink" title="1.2 通过脚本源码安装Apache"></a>1.2 通过脚本源码安装Apache</h3><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -r www</span><br><span class="line">vim apache-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apr_version=1.7.0</span><br><span class="line">apr_iconv_version=1.2.2</span><br><span class="line">apr_util_version=1.6.1</span><br><span class="line">apache_version=2.4.46</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否为root用户</span></span><br><span class="line">   if [ $USER != &#x27;root&#x27; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否安装了wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装依赖</span></span><br><span class="line">   if [ ! `yum -y install zlib-devel pcre-devel libxml2 expat-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/apr/apr-$&#123;apr_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-$&#123;apr_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-$&#123;apr_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-$&#123;apr_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-$&#123;apr_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-$&#123;apr_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr</span></span><br><span class="line">   echo &quot;apr configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">	   echo -e &quot;\e[1;32m apr installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">	   echo -e &quot;\e[1;31m apr installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr-iconv</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-iconv-$&#123;apr_iconv_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-iconv-$&#123;apr_iconv_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-iconv-$&#123;apr_iconv_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr-iconv</span></span><br><span class="line">   echo &quot;apr-iconv configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-iconv --with-apr=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then </span><br><span class="line">       echo &quot;apr-iconv make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-iconv installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-iconv installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-iconv configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr-util</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-util-$&#123;apr_util_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-util-$&#123;apr_util_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-util-$&#123;apr_util_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-util-$&#123;apr_util_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-util-$&#123;apr_util_version&#125;</span><br><span class="line">       fi  </span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-util-$&#123;apr_util_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr-util</span></span><br><span class="line">   echo &quot;apr-util configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr-util make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-util installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-util installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-util configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载安装Apache</span></span><br><span class="line">function apache_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载Apache</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/httpd/httpd-$&#123;apache_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf httpd-$&#123;apache_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d httpd-$&#123;apache_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd httpd-$&#123;apache_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装Apache</span></span><br><span class="line">   echo &quot;Apache configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apache --enable-mpms-shared=all --with-mpm=event --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-so --enable-remoteip --enable-proxy --enable-proxy-fcgi --enable-proxy-uwsgi --enable-deflate=shared --enable-expires=shared --enable-rewrite=shared --enable-cache --enable-file-cache --enable-mem-cache --enable-disk-cache --enable-static-support --enable-static-ab --disable-userdir --enable-nonportable-atomics --disable-ipv6 --with-sendfile &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;Apache make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m Apache installed sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m Apache installed failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m Apache configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">apache_install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写启动脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apache_doc=/usr/local/apache/bin</span><br><span class="line">apache_pid=/usr/local/apache/logs/httpd.pid</span><br><span class="line"></span><br><span class="line">function apache_start()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $apache_num -eq 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall httpd</span><br><span class="line">   fi</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl</span><br><span class="line">   echo -e &quot;start Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_stop()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       killall httpd</span><br><span class="line">       echo -e &quot;stop Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_restart()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl restart</span><br><span class="line">   echo -e &quot;restart Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_status()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_reload()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       cd /usr/local/apache/bin;./apachectl graceful</span><br><span class="line">       echo -e &quot;reload Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        apache_start</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        apache_stop</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">restart)</span><br><span class="line">        apache_restart</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">status)</span><br><span class="line">        apache_status</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">reload)</span><br><span class="line">        apache_reload</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="1-3-多处理模块MPM"><a href="#1-3-多处理模块MPM" class="headerlink" title="1.3 多处理模块MPM"></a>1.3 多处理模块MPM</h3><p>Apache HTTP 服务器被设计为一个功能强大，并且灵活的 web 服务器， 可以在很多平台与环境中工作。不同平台和不同的环境往往需要不同 的特性，或可能以不同的方式实现相同的特性最有效率。Apache 通过模块化的设计来适应各种环境。这种设计允许网站管理员通过在 编译时或运行时，选择哪些模块将会加载在服务器中，来选择服务器特性。</p>
<p>实际上就是用来<strong>接受请求</strong>和<strong>处理请求</strong>的。</p>
<p>Apache的三种工作方式：</p>
<ol>
<li>Prefork MPM：使用多个进程，每个进程只有一个线程，每个进程再某个确定的时间只能维持一个连接，有点是稳定，缺点是内存消耗过高。</li>
</ol>
<p>![Prefork MPM](Prefork MPM.png)</p>
<ol>
<li>Worker MPM：使用多个进程，每个进程有多个线程，每个线程在某个确定的时间只能维持一个连接，内存占用比较小，是个大并发、高流量的场景，缺点是一个线程崩溃，整个进程就会连同其任何线程一起挂掉。</li>
</ol>
<p>![Worker MPM](Worker MPM.png)</p>
<ol start="3">
<li>Event MPM：使用多进程多线程+epoll的模式。</li>
</ol>
<p>![Event MPM](Event MPM.png)</p>
<h3 id="1-4-虚拟主机"><a href="#1-4-虚拟主机" class="headerlink" title="1.4 虚拟主机"></a>1.4 虚拟主机</h3><p>默认情况下，一个web服务器只能发布一个默认网站，也就是只能发布一个web站点，对于大网站来说还好，但对于访问量较少的小网站那就显得有点浪费了。</p>
<p>而虚拟主机就可以实现在一个web服务器上发布多个站点，分为基于IP地址、域名和端口三种。</p>
<p>Apache的虚拟主机和默认网站不能够同时存在，如果设置了虚拟主机那么默认网站也就失效了，需要在用虚拟主机发布默认站点才可解决。</p>
<p>基于IP：基于IP的虚拟主机需要耗费大量的IP地址，只适合IP地址充足的环境。</p>
<p>基于端口：需要耗费较多的端口，适合私网环境。</p>
<p>基于域名：需要耗费较多的域名，适合公网环境。</p>
<h4 id="1-4-1-基于IP的虚拟主机"><a href="#1-4-1-基于IP的虚拟主机" class="headerlink" title="1.4.1 基于IP的虚拟主机"></a>1.4.1 基于IP的虚拟主机</h4><ol>
<li>在主配文件中调用虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Virtual hosts</span></span><br><span class="line">Include conf/extra/httpd-vhosts.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个逻辑网卡，重启即失效</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost 49.232.160.75:80&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">管理员邮箱</span></span><br><span class="line">    # ServerAdmin webmaster@dummy-host.example.com</span><br><span class="line">    # web目录</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    # 域名</span><br><span class="line">    # ServerName dummy-host.example.com</span><br><span class="line">    # 给域名起别名，起到重定向作用</span><br><span class="line">    # ServerAlias www.dummy-host.example.com</span><br><span class="line">    # 错误日子</span><br><span class="line">    # ErrorLog &quot;logs/dummy-host.example.com-error_log&quot;</span><br><span class="line">    # 访问日志</span><br><span class="line">    # CustomLog &quot;logs/dummy-host.example.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.88.100:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建站点目录和文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/apache/htdocs/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/apache/htdocs/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/apache/htdocs/web2/index.html</span><br><span class="line">./apache start</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8EIP%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于IP虚拟主机测试"></p>
<h4 id="1-4-2-基于端口的虚拟主机"><a href="#1-4-2-基于端口的虚拟主机" class="headerlink" title="1.4.2 基于端口的虚拟主机"></a>1.4.2 基于端口的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">Listen 81</span><br><span class="line">&lt;VirtualHost *:81&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E7%AB%AF%E5%8F%A3%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于端口虚拟主机测试"></p>
<h4 id="1-4-3-基于域名的虚拟主机"><a href="#1-4-3-基于域名的虚拟主机" class="headerlink" title="1.4.3 基于域名的虚拟主机"></a>1.4.3 基于域名的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    ServerName www.cqm1.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">    ServerName www.cqm2.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于域名虚拟主机测试"></p>
<h3 id="1-5-LAMP"><a href="#1-5-LAMP" class="headerlink" title="1.5 LAMP"></a>1.5 LAMP</h3><p>LAMP：Linux + Apache + Mysql + PHP</p>
<p>作用就是构建一个PHP业务环境，用来发布PHP网站。</p>
<h4 id="1-5-1-Mysql通过脚本源码安装"><a href="#1-5-1-Mysql通过脚本源码安装" class="headerlink" title="1.5.1 Mysql通过脚本源码安装"></a>1.5.1 Mysql通过脚本源码安装</h4><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mysql_version=5.7.35</span><br><span class="line">install_dir=/opt</span><br><span class="line">data_dir=/data</span><br><span class="line">wget_url=&quot;https://mirrors.tuna.tsinghua.edu.cn/mysql/downloads/MySQL-5.7/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz&quot;</span><br><span class="line"></span><br><span class="line">function loginfo()&#123;</span><br><span class="line">    if [[ $? -eq 0 ]];then</span><br><span class="line">        echo -e &quot;\033[32m[INFO][$(date +&quot;%F %T&quot;)] $1 succeed! \033[0m&quot;</span><br><span class="line">    else</span><br><span class="line">        echo -e &quot;\033[31m[ERROR][$(date +&quot;%F %T&quot;)] $1 failed! \033[0m&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mysql_install()&#123;</span><br><span class="line">    echo -e &quot;\033[32mBegin install mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    </span><br><span class="line">    # 安装依赖</span><br><span class="line">    sudo yum -y install libaio &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;libaio install&quot;</span><br><span class="line"></span><br><span class="line">    # 下载mysql</span><br><span class="line">    echo -e &quot;\033[32mBegin download mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    curl -O $wget_url &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    mv ./mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz $install_dir</span><br><span class="line">    loginfo &quot;mysql software download&quot;</span><br><span class="line"></span><br><span class="line">    # 解压缩mysql</span><br><span class="line">    sudo tar -xf $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz -C $install_dir</span><br><span class="line">    loginfo &quot;mysql software decompression&quot;</span><br><span class="line"></span><br><span class="line">    # 创建配置文件目录和数据目录</span><br><span class="line">    if [[ -d $install_dir/mysql ]];then</span><br><span class="line">        rm -rf $install_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo ln -s $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64 $install_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql config dir soft link&quot;</span><br><span class="line">    if [[ -d $data_dir/mysql ]];then</span><br><span class="line">        rm -rf $data_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo mkdir -p $data_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql data dir&quot;</span><br><span class="line"></span><br><span class="line">    # 修改启动脚本</span><br><span class="line">    sudo sed -i &quot;46s#basedir=#basedir=$&#123;install_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo sed -i &quot;47s#datadir=#datadir=$&#123;data_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo cp $&#123;install_dir&#125;/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">    sudo chmod 755 /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # 创建用户组及用户</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/group</span><br><span class="line">    then</span><br><span class="line">        sudo groupadd mysql</span><br><span class="line">        loginfo &quot;create user mysql&quot;</span><br><span class="line">    fi</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/passwd</span><br><span class="line">    then</span><br><span class="line">        sudo useradd -r -g mysql -s /bin/false mysql</span><br><span class="line">        loginfo &quot;create group mysql&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 授权</span><br><span class="line">    sudo chown -R mysql:mysql $install_dir/mysql</span><br><span class="line">    sudo chown -R mysql:mysql $data_dir/mysql</span><br><span class="line"></span><br><span class="line">    # 为二进制文件创建软连接</span><br><span class="line">    if [ ! -f /usr/bin/mysql ]</span><br><span class="line">    then</span><br><span class="line">        sudo ln -s /opt/mysql/bin/mysql /usr/bin/</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 创建配置文件</span><br><span class="line">    if [ -f /etc/my.cnf ]</span><br><span class="line">    then</span><br><span class="line">        sudo rm -f /etc/my.cnf</span><br><span class="line">    fi</span><br><span class="line">    sudo bash -c &quot;cat &gt;&gt; /etc/my.cnf&quot; &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">datadir                             = /data/mysql</span><br><span class="line">basedir                             = /opt/mysql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">tmpdir                              = /data/mysql/tmp_mysql</span></span><br><span class="line">port                                = 3306</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">pid-file                            = /data/mysql/mysql.pid</span><br><span class="line">max_connections                     = 8000</span><br><span class="line">max_connect_errors                  = 100000</span><br><span class="line">max_user_connections                = 3000</span><br><span class="line">check_proxy_users                   = on</span><br><span class="line">mysql_native_password_proxy_users   = on</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">symbolic-links                      = FALSE</span><br><span class="line">group_concat_max_len                = 4294967295</span><br><span class="line">max_join_size                       = 18446744073709551615</span><br><span class="line">max_execution_time                  = 20000</span><br><span class="line">lock_wait_timeout                   = 60</span><br><span class="line">autocommit                          = 1</span><br><span class="line">lower_case_table_names              = 1</span><br><span class="line">thread_cache_size                   = 64</span><br><span class="line">disabled_storage_engines            = &quot;MyISAM,FEDERATED&quot;</span><br><span class="line">character_set_server                = utf8mb4</span><br><span class="line">character-set-client-handshake      = FALSE</span><br><span class="line">collation_server                    = utf8mb4_general_ci</span><br><span class="line">init_connect                        = &#x27;SET NAMES utf8mb4&#x27;</span><br><span class="line">transaction-isolation               = &quot;READ-COMMITTED&quot;</span><br><span class="line">skip_name_resolve                   = ON</span><br><span class="line">explicit_defaults_for_timestamp     = ON</span><br><span class="line">log_timestamps                      = SYSTEM</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">event_scheduler                     = OFF</span><br><span class="line">query_cache_type                    = OFF</span><br><span class="line">query_cache_size                    = 0</span><br><span class="line">sql_mode                            = NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO</span><br><span class="line">log_error                           = /data/mysql/mysql.err</span><br><span class="line">slow_query_log                      = ON</span><br><span class="line">slow_query_log_file                 = /data/mysql/slow.log</span><br><span class="line">long_query_time                     = 1</span><br><span class="line">general_log                         = OFF</span><br><span class="line">general_log_file                    = /data/mysql/general.log</span><br><span class="line">expire_logs_days                    = 99</span><br><span class="line">log-bin                             = /data/mysql/mysql-bin</span><br><span class="line">log-bin-index                       = /data/mysql/mysql-bin.index</span><br><span class="line">max_binlog_size                     = 500M</span><br><span class="line">binlog_format                       = mixed</span><br><span class="line">binlog_rows_query_log_events        = ON</span><br><span class="line">binlog_cache_size                   = 128k</span><br><span class="line">binlog_stmt_cache_size              = 128k</span><br><span class="line">log-bin-trust-function-creators     = 1</span><br><span class="line">max_binlog_cache_size               = 2G</span><br><span class="line">max_binlog_stmt_cache_size          = 2G</span><br><span class="line">relay_log                           = /data/mysql/relay</span><br><span class="line">relay_log_index                     = /data/mysql/relay.index</span><br><span class="line">max_relay_log_size                  = 500M</span><br><span class="line">relay_log_purge                     = ON</span><br><span class="line">relay_log_recovery                  = ON</span><br><span class="line">server_id                           = 1</span><br><span class="line">read_buffer_size                    = 1M</span><br><span class="line">read_rnd_buffer_size                = 2M</span><br><span class="line">sort_buffer_size                    = 64M</span><br><span class="line">join_buffer_size                    = 64M</span><br><span class="line">tmp_table_size                      = 64M</span><br><span class="line">max_allowed_packet                  = 128M</span><br><span class="line">max_heap_table_size                 = 64M</span><br><span class="line">connect_timeout                     = 43200</span><br><span class="line">wait_timeout                        = 43200</span><br><span class="line">back_log                            = 512</span><br><span class="line">interactive_timeout                 = 300</span><br><span class="line">net_read_timeout                    = 30</span><br><span class="line">net_write_timeout                   = 30</span><br><span class="line">skip_external_locking               = ON</span><br><span class="line">key_buffer_size                     = 16M</span><br><span class="line">bulk_insert_buffer_size             = 16M</span><br><span class="line">concurrent_insert                   = ALWAYS</span><br><span class="line">open_files_limit                    = 65000</span><br><span class="line">table_open_cache                    = 16000</span><br><span class="line">table_definition_cache              = 16000</span><br><span class="line">default_storage_engine              = InnoDB</span><br><span class="line">default_tmp_storage_engine          = InnoDB</span><br><span class="line">internal_tmp_disk_storage_engine    = InnoDB</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[ndatad default]</span><br><span class="line">TransactionDeadLockDetectionTimeOut = 20000</span><br><span class="line">EOF</span><br><span class="line">    sudo chown -R mysql:mysql /etc/my.cnf</span><br><span class="line">    loginfo &quot;configure my.cnf&quot;</span><br><span class="line"></span><br><span class="line">    # 创建SSL证书</span><br><span class="line">    # sudo mkdir -p $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line">    # sudo $&#123;install_dir&#125;/mysql/bin/mysql_ssl_rsa_setup -d $&#123;install_dir&#125;/mysql/ca-pem/ --uid=mysql</span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line"></span><br><span class="line">    # sudo bash -c &quot;cat &gt;&gt; $&#123;data_dir&#125;/mysql/init_file.sql&quot; &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_safe_updates=0;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_select_limit=50000;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">EOF</span></span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;data_dir&#125;/mysql/init_file.sql</span><br><span class="line">    # sudo chown -R mysql:mysql /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # 初始化</span><br><span class="line">    $&#123;install_dir&#125;/mysql/bin/mysqld --initialize --user=mysql --basedir=$&#123;DEPLOY_PATH&#125;/mysql --datadir=/data/mysql </span><br><span class="line">    loginfo &quot;initialize mysql&quot;</span><br><span class="line"></span><br><span class="line">    # 客户端环境变量</span><br><span class="line">    echo &quot;export PATH=\$PATH:$&#123;install_dir&#125;/mysql/bin&quot; | sudo tee /etc/profile.d/mysql.sh</span><br><span class="line">    source /etc/profile.d/mysql.sh</span><br><span class="line">    loginfo &quot;configure envirement&quot;</span><br><span class="line"></span><br><span class="line">    # 获取初始密码</span><br><span class="line">    mysql_init_passwd=$(grep &#x27;A temporary password is generated&#x27; $&#123;data_dir&#125;/mysql/mysql.err | awk &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    # 启动服务</span><br><span class="line">    chkconfig --add mysqld</span><br><span class="line">    sudo systemctl start mysqld</span><br><span class="line">    loginfo &quot;start mysqld&quot;</span><br><span class="line"></span><br><span class="line">    # 修改密码</span><br><span class="line">    mysql --connect-expired-password -uroot -p$&#123;mysql_init_passwd&#125; -e &#x27;alter user user() identified by &quot;toortoor&quot;;&#x27; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;edit mysql root password&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_install</span><br></pre></td></tr></table></figure>

<h4 id="1-5-2-PHP通过脚本源码安装"><a href="#1-5-2-PHP通过脚本源码安装" class="headerlink" title="1.5.2 PHP通过脚本源码安装"></a>1.5.2 PHP通过脚本源码安装</h4><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cmake_version=3.22.0</span><br><span class="line">libzip_version=1.8.0</span><br><span class="line">php_version=7.4.16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否为root用户</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否安装了wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装依赖包</span></span><br><span class="line">   if [ ! `yum -y install gcc-c++ libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel gd net-snmp-* sqlite-devel oniguruma-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载最新版cmake</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://github.com/Kitware/CMake/releases/download/v$&#123;cmake_version&#125;/cmake-$&#123;cmake_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">      tar -xf cmake-$&#123;cmake_version&#125;.tar.gz</span><br><span class="line">      if [ ! -d cmake-$&#123;cmake_version&#125; ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;31m error:no found cmake-$&#123;cmake_version&#125;  \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      else</span><br><span class="line">         cd cmake-$&#123;cmake_version&#125;</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:Failed to download cmake-$&#123;cmake_version&#125; \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装cmake</span></span><br><span class="line">   echo &quot;cmake configure...&quot;</span><br><span class="line">   ./configure &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">      echo &quot;cmake make &amp;&amp; make install...&quot;</span><br><span class="line">      make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">      if [ `echo $?` -eq 0 ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;32m cmake installed sucessfully \e[0m&quot;</span><br><span class="line">      else</span><br><span class="line">         echo -e &quot;\e[1;31m cmake installed failed \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:cmake configure failed \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载libzip1.1以上版本</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget --no-check-certificate https://libzip.org/download/libzip-$&#123;libzip_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar libzip...&quot;</span><br><span class="line">       tar -xf libzip-$&#123;libzip_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d libzip-$&#123;libzip_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found libzip-$&#123;libzip_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd libzip-$&#123;libzip_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download libzip-$&#123;libzip_version&#125;.tar.gz \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装libzip</span></span><br><span class="line">   mkdir build;cd build</span><br><span class="line">   echo &quot;cmake libzip...&quot;</span><br><span class="line">   cmake .. &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install libzip...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m libzip install sucessfully \e[0m&quot;</span><br><span class="line">           echo -e &#x27;/usr/local/lib64\n/usr/local/lib\n/usr/lib\n/usr/lib64&#x27;&gt;&gt; /etc/ld.so.conf</span><br><span class="line">           ldconfig -v &amp;&gt; /dev/null</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:libzip install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:lipzip cmake failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载php</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.php.net/distributions/php-$&#123;php_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar php...&quot;</span><br><span class="line">       tar -xf php-$&#123;php_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d php-$&#123;php_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found php-$&#123;php_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd php-$&#123;php_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download php-$&#123;php_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装php</span></span><br><span class="line">   echo &quot;configure php...&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">要php以apache模块运行需加上--with-apxs2=/usr/localapache/bin/apxs参数</span></span><br><span class="line">   ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-mysqli=mysqlnd --enable-pdo --with-pdo-mysql=mysqlnd --with-iconv-dir=/usr/local/ --enable-fpm --with-fpm-user=www --with-fpm-group=www --with-pcre-regex --with-zlib --with-bz2 --enable-calendar --disable-phar --with-curl --enable-dba --with-libxml-dir --enable-ftp --with-gd --with-jpeg-dir --with-png-dir --with-zlib-dir --with-freetype-dir --enable-gd-jis-conv --with-mhash --enable-mbstring --enable-opcache=yes --enable-pcntl --enable-xml --disable-rpath --enable-shmop --enable-sockets --enable-zip --enable-bcmath --with-snmp --disable-ipv6 --with-gettext --disable-rpath --disable-debug --enable-embedded-mysqli --with-mysql-sock=/var/lib/mysql/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install php...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m php install sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m php install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m configure php failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_set()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -f /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service ]</span><br><span class="line">    then</span><br><span class="line">        echo -e &quot;\e[1;31m No found php-fpm.service \e[0m&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    else</span><br><span class="line">        cp /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service /etc/systemd/system</span><br><span class="line">        if [ `echo $?` -ne 0 ]</span><br><span class="line">        then</span><br><span class="line">            echo -e &quot;\e[1;31m Copy php-fpm.service failed \e[0m&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        else</span><br><span class="line">            sed -i &#x27;/PrivateTmp=true/a\ProtectSystem=false&#x27; /etc/systemd/system/php-fpm.service</span><br><span class="line">            systemctl daemon-reload</span><br><span class="line">            echo -e &quot;\e[1;32m php set sucessfully \e[0m&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">pre</span><br><span class="line">php_install</span><br><span class="line">php_set</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置PHP</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/php/etc</span><br><span class="line">cp php-fpm.conf.default php-fpm.conf</span><br><span class="line">cp php-fpm.d/www.conf.default php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.conf</span><br><span class="line">[global]</span><br><span class="line">pid = run/php-fpm.pid</span><br><span class="line">error_log = log/php-fpm.log</span><br><span class="line">daemonize = yes</span><br><span class="line">include=/usr/local/php/etc/php-fpm.d/*.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.d/www.conf</span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line">listen.mode = 0660</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 5</span><br><span class="line">pm.start_servers = 2</span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line">pm.max_spare_servers = 3</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm</span><br></pre></td></tr></table></figure>

<h4 id="1-5-3-PHP作为Apache模块运行"><a href="#1-5-3-PHP作为Apache模块运行" class="headerlink" title="1.5.3 PHP作为Apache模块运行"></a>1.5.3 PHP作为Apache模块运行</h4><ol>
<li>在apache主配置文件中调用子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/php.con</span><br><span class="line">LoadModule php7_module modules/libphp7.so</span><br><span class="line">AddType application/x-httpd-php .php</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置虚拟主机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>写web目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;this is cqm web&#x27; &gt; /usr/local/apache/htdocs/web/index.html</span><br><span class="line">vim /usr/local/apache/htdocs/web/phpinfo.php</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/php%E4%BB%A5%E6%A8%A1%E5%9D%97%E8%BF%90%E8%A1%8C.png" alt="php以模块运行"></p>
<h4 id="1-5-4-PHP作为独立服务运行"><a href="#1-5-4-PHP作为独立服务运行" class="headerlink" title="1.5.4 PHP作为独立服务运行"></a>1.5.4 PHP作为独立服务运行</h4><p>PHP作为独立服务运行有两种模式：</p>
<ul>
<li>TCP socket模式</li>
<li>UNIX socket模式</li>
</ul>
<p><strong>TCP socket模式</strong></p>
<ol>
<li>修改<a target="_blank" rel="noopener" href="http://www.conf文件/">www.conf文件</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = 127.0.0.1:9000</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web&quot;&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">	AllowOverride None</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">	DirectoryIndex index.php index.html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">	SetHandler &quot;proxy:fcgi://127.0.0.1:9000&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在apache主配文件添加关联</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php-fpm.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置子配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/php-fpm.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">载入需要的模块</span></span><br><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</span><br></pre></td></tr></table></figure>

<p><strong>UNIX socket模式</strong></p>
<ol>
<li>修改<a target="_blank" rel="noopener" href="http://www.conf文件/">www.conf文件</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = /usr/local/php/etc/php-fpm.socket</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置虚拟主机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">        SetHandler &quot;proxy:unix:/usr/local/php/etc/php-fpm.socket|fcgi://localhost/&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-6-Apache常用模块"><a href="#1-6-Apache常用模块" class="headerlink" title="1.6 Apache常用模块"></a>1.6 Apache常用模块</h3><h4 id="1-6-1-长连接"><a href="#1-6-1-长连接" class="headerlink" title="1.6.1 长连接"></a>1.6.1 长连接</h4><p>HTTP采用TCP进行传输，是面向连接的协议，每完成一次请求就要经历以下过程：</p>
<ul>
<li>三次握手</li>
<li>发起请求</li>
<li>响应请求</li>
<li>四次挥手</li>
</ul>
<p>那么N个请求就要建立N次连接，如果希望用户能够更快的拿到数据，服务器的压力降到最低，那么靠长连接就可以解决。</p>
<p>长连接实际上就是优化了TCP连接。</p>
<p>Apache默认开启了长连接，持续时间为5秒，在httpd-default.conf中可以定义。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-default.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启长连接</span></span><br><span class="line">KeepAlive On</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">限制每个连接允许的请求数</span></span><br><span class="line">MaxKeepAliveRequests 500</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">长连接时间</span></span><br><span class="line">KeepAliveTimeout 5</span><br></pre></td></tr></table></figure>

<h4 id="1-6-2-静态缓存"><a href="#1-6-2-静态缓存" class="headerlink" title="1.6.2 静态缓存"></a>1.6.2 静态缓存</h4><p>用户每次访问网站都会将页面中的所有元素都请求一遍，全部下载后通过浏览器渲染，展示到浏览器中。但是，网站中的某些元素我们一般都是固定不变的，比如logo、框架文件等。用户每次访问都需要加载这些元素。这样做好处是保证了数据的新鲜，可是这些数据不是常变化的，很久才变化一次。每次都请求、下载浪费了用户时间和公司带宽。</p>
<p>所以我们通过静态缓存的方式，将这些不常变化的数据缓存到用户本地磁盘，用户以后再访问这些请求，直接从本地磁盘打开加载，这样的好处是加载速度快，且节约公司带宽及成本。</p>
<ol>
<li>在apache主配文件中加载缓存模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule expires_module modules/mod_expires.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle expires_module&gt;</span><br><span class="line">    #开启缓存</span><br><span class="line">    ExpiresActive on</span><br><span class="line">    #针对不同类型元素设置缓存时间</span><br><span class="line">    ExpiresByType image/gif  &quot;access plus 1 days&quot;</span><br><span class="line">    ExpiresByType image/jpeg &quot;access plus 24 hours&quot;</span><br><span class="line">    ExpiresByType image/png &quot;access plus 24 hours&quot;</span><br><span class="line">    #now 相当于 access</span><br><span class="line">    ExpiresByType text/css &quot;now plus 2 hour&quot;</span><br><span class="line">    ExpiresByType application/x-javascript &quot;now plus 2 hours&quot;</span><br><span class="line">    ExpiresByType application/x-shockwave-flash &quot;now plus 2 hours”</span><br><span class="line">    #其他数据不缓存</span><br><span class="line">    ExpiresDefault &quot;now plus 0 min&quot;</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-3-数据压缩"><a href="#1-6-3-数据压缩" class="headerlink" title="1.6.3 数据压缩"></a>1.6.3 数据压缩</h4><p>数据从服务器传输到客户端，需要传输时间，文件越大传输时间就越长，为了减少传输时间，我们一般把数据压缩后在传给客户端。</p>
<p>apache支持两种模式的压缩：</p>
<ul>
<li>default</li>
<li>gzip</li>
</ul>
<p>两者的区别：</p>
<ul>
<li>mod_deflate 压缩速度快。</li>
<li>mod_gzip 的压缩比略高。</li>
<li>一般情况下，mod_gzip 会比 mod_deflate 多出 4%~6％ 的压缩量。</li>
<li>mod_gzip 对服务器CPU的占用要高一些，所以 mod_deflate 是专门为确保服务器的性能而使用的一个压缩模块，只需较少的资源来进行压缩。</li>
</ul>
<ol>
<li>在apache主配文件中加载压缩模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule deflate_module modules/mod_deflate.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle deflate_module&gt;</span><br><span class="line">    #压缩等级1-9，数字越大压缩能力越好，相应地也越耗CPU性能</span><br><span class="line">    DeflateCompressionLevel 4</span><br><span class="line">    #压缩类型，html、xml、php、css、js</span><br><span class="line">	AddOutputFilterByType DEFLATE text/html text/plain text/xml application/x-javascript application/x-httpd-php</span><br><span class="line">	AddOutputFilter DEFLATE js css</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">浏览器匹配为IE1-6的不压缩</span></span><br><span class="line">	BrowserMatch \bMSIE\s[1-6] dont-vary</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">设置不压缩的文件</span></span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:pdf|doc)$ no-gzip dont-vary</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-4-限速"><a href="#1-6-4-限速" class="headerlink" title="1.6.4 限速"></a>1.6.4 限速</h4><p>网站除了能共享页面给用户外，还能作为下载服务器存在。但是作为下载服务器时，我们应该考虑服务器的带宽和IO的性能，防止部分邪恶分子会通过大量下载的方式来攻击你的带宽和服务器IO性能。</p>
<p>问题：</p>
<ul>
<li>假如你的服务器被邪恶分子通过下载的方式把带宽占满了，那么你或其他用户在访问的时候就会造成访问慢或者根本无法访问。</li>
<li>假如你的服务器被邪恶分子通过下载的方式把服务器IO占满了，那么你的服务器将会无法处理用户请求或宕机。</li>
</ul>
<p>以上问题可以通过限速来解决，apache自带了基于宽带限速的模块：</p>
<ul>
<li>ratelimit_module：只能对连接下载速度做限制，且是单线程的下载，迅雷等下载工具使用的是多线程下载。</li>
<li>mod_limitipconn：限制每 IP 的连接数，需要额外安装该模块。</li>
</ul>
<p><strong>ratelimit_module模块</strong></p>
<ol>
<li>在apache主配文件中加载压缩模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule ratelimit_module modules/mod_ratelimit.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Location相对路径：/usr/local/apache/htdocs/...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Directory绝对路径：...</span></span><br><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限速100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<p><strong>mod_limitipconn模块</strong></p>
<ol>
<li>下载安装模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://dominia.org/djao/limit/mod_limitipconn-0.24.tar.bz2</span><br><span class="line">tar -xf mod_limitipconn-0.24.tar.bz2</span><br><span class="line">cd mod_limitipconn-0.24</span><br><span class="line">vim Makefile</span><br><span class="line">    apxs = &quot;/usr/local/apache/bin/apxs&quot;</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在apache主配文件启用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule limitipconn_module modules/mod_limitipconn.so</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限速100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限制线程数</span></span><br><span class="line">	MaxConnPerIP 3</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">对index.html文件不作限制</span></span><br><span class="line">	NoIPLimit index.html</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-5-访问控制"><a href="#1-6-5-访问控制" class="headerlink" title="1.6.5 访问控制"></a>1.6.5 访问控制</h4><p>在生产环境中，网站分为公站和私站，公站允许所有人访问，但私站就只允许内部人员访问，Require就可以实现访问控制的功能。</p>
<p>容器：</p>
<ul>
<li>RequireAny：一个符合即可通过</li>
<li>RequireAll：所有符合才可通过</li>
<li>Requirenone：所有都不符合才可通过</li>
</ul>
<p><strong>普通的访问控制</strong></p>
<ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line">	AllowOverride None</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">拒绝所有人访问</span></span><br><span class="line">	Require all denied</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">允许该地址段的用户访问</span></span><br><span class="line">	Require ip 192.168.88</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">允许该主机访问</span></span><br><span class="line">	Require host www.cqm.com</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p><strong>用户登录验证访问控制</strong></p>
<ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义提示信息，用户访问时提示信息会出现在认证的对话框中</span></span><br><span class="line">	AuthName &quot;Private&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义认证类型，在HTTP1.0中，只有一种认证类型：basic。在HTTP1.1中有几种认证类型，如：MD5</span></span><br><span class="line">	AuthType Basic</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义包含用户名和密码的文本文件，每行一对</span></span><br><span class="line">	AuthUserFile &quot;/usr/local/apache/user.dbm&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">配合容器使用，只有条件全部符合才能通过</span></span><br><span class="line">	&lt;RequireAll&gt;</span><br><span class="line">		Require not ip 192.168.88</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　require user user1 user2 (只有用户user1和user2可以访问)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　requires <span class="built_in">groups</span> group1 (只有group1中的成员可以访问)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　require valid-user (在AuthUserFile指定的文件中的所有用户都可以访问)</span></span><br><span class="line">		Require valid-user</span><br><span class="line">	&lt;/RequireAll&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成用户文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成cqm用户</span></span><br><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/apache/user.dbm cqm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="1-6-6-URL重写"><a href="#1-6-6-URL重写" class="headerlink" title="1.6.6 URL重写"></a>1.6.6 URL重写</h4><p>Apache通过mod_rewrite模块可以实现URL重写的功能，URL重写其实就是改写用户浏览器中的URL地址。</p>
<ol>
<li>在主配文件开启模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    # 开启URL重写功能</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    # 重写规则，跳转到百度</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://www.baidu.com&quot; [NC,L]</span><br><span class="line">    # 匹配条件，根据请求头进行匹配</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;chrome&quot; [NC,OR]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;curl&quot;</span><br><span class="line">    # 重写规则，和匹配到的条件配合使用，请求头匹配到chrome或curl则返回403状态码</span><br><span class="line">    RewriteRule &quot;^/$&quot; - [F]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">RewreteRule [flag] 部分标记规则</span><br><span class="line">R:强制外部重定向</span><br><span class="line">F:禁用URL，返回403HTTP状态码</span><br><span class="line">G:强制URL为GONE，返回410HTTP状态码</span><br><span class="line">P:强制使用代理转发</span><br><span class="line">L:表明当前规则是最后一条规则，停止分析以后规则的重写</span><br><span class="line">N:重新从第一条规则开始运行重写过程</span><br><span class="line">C:与下一条规则关联</span><br><span class="line">NS:只用于不是内部子请求</span><br><span class="line">NC:不区分大小写</span><br></pre></td></tr></table></figure>

<p><strong>通过URL重写实现分流功能</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(chrome|curl)&quot; [NC,OR]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://pc.cqm.com&quot; [NC]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(iPhone|Blackberry|Android|ipad)&quot; [NC]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://phone.cqm.com&quot; [NC]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-7-压力测试"><a href="#1-6-7-压力测试" class="headerlink" title="1.6.7 压力测试"></a>1.6.7 压力测试</h4><p>Apache压力测试使用ab命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ab</span><br><span class="line">-A:指定连接服务器的基本的认证凭据</span><br><span class="line">-c:指定一次向服务器发出请求数</span><br><span class="line">-C:添加cookie</span><br><span class="line">-g:将测试结果输出为“gnuolot”文件</span><br><span class="line">-h:显示帮助信息</span><br><span class="line">-H:为请求追加一个额外的头</span><br><span class="line">-i:使用“head”请求方式</span><br><span class="line">-k:激活HTTP中的“keepAlive”特性</span><br><span class="line">-n:指定测试会话使用的请求数</span><br><span class="line">-p:指定包含数据的文件</span><br><span class="line">-q:不显示进度百分比</span><br><span class="line">-T:使用POST数据时，设置内容类型头</span><br><span class="line">-v:设置详细模式等级</span><br><span class="line">-w:以HTML表格方式打印结果</span><br><span class="line">-x:以表格方式输出时，设置表格的属性</span><br><span class="line">-X:使用指定的代理服务器发送请求</span><br><span class="line">-y:以表格方式输出时，设置表格属性</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/ab -n 10000 -c 200 http:...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">并发数</span></span><br><span class="line">per second...</span><br></pre></td></tr></table></figure>



<h2 id="二、Nginx"><a href="#二、Nginx" class="headerlink" title="二、Nginx"></a>二、Nginx</h2><h3 id="2-1-Nginx介绍"><a href="#2-1-Nginx介绍" class="headerlink" title="2.1 Nginx介绍"></a>2.1 Nginx介绍</h3><p>Nginx是一款是由俄罗斯的程序设计师Igor Sysoev所开发高性能的 Web和 反向代理服务器，也是一个 IMAP&#x2F;POP3&#x2F;SMTP 代理服务器。和apache一样，都是web服务器软件，因为其性能优异，所以被广大运维喜欢。又因为nginx是一个轻量级的web服务器，相比apache来说资源消耗更低。</p>
<p>Nginx中文文档：<a target="_blank" rel="noopener" href="https://www.nginx.cn/doc/index.html">https://www.nginx.cn/doc/index.html</a></p>
<h3 id="2-2-通过脚本源码安装Nginx"><a href="#2-2-通过脚本源码安装Nginx" class="headerlink" title="2.2 通过脚本源码安装Nginx"></a>2.2 通过脚本源码安装Nginx</h3><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">nginx_version=1.21.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检测</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检测是否为root</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检测wget是否安装</span></span><br><span class="line">   if [ ! -e /usr/bin/wget ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found command /usr/bin/wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">安装依赖</span></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">0:stdin标准输入   1:stdout标准输出   2:stderr错误输出</span></span><br><span class="line">   if [ ! `yum -y install gcc-* pcre-devel zlib-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载源码包</span></span><br><span class="line">   cd /usr/local/</span><br><span class="line">   if [ ! `wget http://nginx.org/download/nginx-$&#123;nginx_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf nginx-$&#123;nginx_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d nginx-$&#123;nginx_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found nginx-$&#123;nginx_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:wget file nginx-$&#123;nginx_version&#125;.tar.gz failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">function install_nginx()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/nginx-$&#123;nginx_version&#125;</span><br><span class="line">   echo &quot;nginx configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/nginx &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;nginx make...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m nginx install success \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:nginx install fail \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:nginx configure fail \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">install_nginx</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写启动脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Source <span class="keyword">function</span> libiary</span></span><br><span class="line">if [ -f /etc/init.d/functions ]</span><br><span class="line">then</span><br><span class="line">    . /etc/init.d/functions</span><br><span class="line">else</span><br><span class="line">    echo &quot;Not found file /etc/init.d/functions&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">nginxd=/usr/local/nginx/sbin/nginx</span><br><span class="line">nginx_pid=/usr/local/nginx/logs/nginx.pid</span><br><span class="line"></span><br><span class="line">function nginx_start()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -eq 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">nginxd</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_stop()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -gt 1 ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_status()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_restart()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_stop</span><br><span class="line">   nginx_start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_reload()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       $nginxd -s reload</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        nginx_start</span><br><span class="line">        echo -e &quot;nginx start [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        nginx_stop</span><br><span class="line">        echo -e &quot;nginx stop [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line">        nginx_status</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        nginx_restart</span><br><span class="line">        echo -e &quot;nginx restart [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">reload)</span><br><span class="line">        nginx_reload</span><br><span class="line">        echo -e &quot;nginx reload [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Nginx的Server块"><a href="#2-3-Nginx的Server块" class="headerlink" title="2.3 Nginx的Server块"></a>2.3 Nginx的Server块</h3><p>当Nginx配置文件只有一个Server块时，那么该Server块就被Nginx认为是默认网站，所有发给Nginx的请求都会传给该Server块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">监听80端口</span></span><br><span class="line">        listen       80;</span><br><span class="line">        # 域名</span><br><span class="line">        server_name  localhost;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">字符集</span></span><br><span class="line">        charset koi8-r;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">访问日志路径</span></span><br><span class="line">        access_log  logs/host.access.log  main;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">web根路径</span></span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">/代表相对路劲，这里代表/usr/local/nginx</span></span><br><span class="line">        location / &#123;</span><br><span class="line">        	# 根目录路径，这里代表/usr/local/nginx/html</span><br><span class="line">            root   html;</span><br><span class="line">            # 索引页</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">404状态码</span></span><br><span class="line">        error_page  404              /404.html;</span><br><span class="line">        location = /404.html&#123;</span><br><span class="line">        	root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        # 50x状态码</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Nginx的访问控制"><a href="#2-4-Nginx的访问控制" class="headerlink" title="2.4 Nginx的访问控制"></a>2.4 Nginx的访问控制</h3><ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    # 允许192.168.88.0/24的用户访问</span><br><span class="line">    allow 192.168.88.0/24;</span><br><span class="line">    # 拒绝所有</span><br><span class="line">    deny all;</span><br><span class="line">    # 基于客户端IP做过滤，符合条件的允许访问，不符合的返回404</span><br><span class="line">    # 这里为不是192.168.88的就返回404</span><br><span class="line">    if ( $remote_addr !~ &quot;192.168.88&quot; )&#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-Nginx的用户验证"><a href="#2-5-Nginx的用户验证" class="headerlink" title="2.5 Nginx的用户验证"></a>2.5 Nginx的用户验证</h3><ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	root   html;</span><br><span class="line">	index  index.html index.htm;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">欢迎词</span></span><br><span class="line">	auth_basic &quot;welcome to cqm&#x27;s web&quot;;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">存放用户文件</span></span><br><span class="line">	auth_basic_user_file /usr/local/nginx/htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成用户文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/nginx/htpasswd cqm</span><br></pre></td></tr></table></figure>

<h3 id="2-6-Nginx参数"><a href="#2-6-Nginx参数" class="headerlink" title="2.6 Nginx参数"></a>2.6 Nginx参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx中的log_format可以用来自定义日志格式</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">log_format变量：</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_addr:记录访问网站的客户端地址</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_user:远程客户端用户名</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">time_local:记录访问时间与时区</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request:用户的http请求起始行信息</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">status:http状态码，记录请求返回的状态码，例如：200、301、404等</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">body_bytes_sent:服务器发送给客户端的响应body字节数</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_referer:记录此次请求是从哪个连接访问过来的，可以根据该参数进行防盗链设置。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_user_agent:记录客户端访问信息，例如：浏览器、手机客户端等</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_x_forwarded_for:当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置</span></span><br></pre></td></tr></table></figure>

<h3 id="2-7-Nginx防盗链"><a href="#2-7-Nginx防盗链" class="headerlink" title="2.7 Nginx防盗链"></a>2.7 Nginx防盗链</h3><p>盗链用大白话讲就是抓取别人网站的资源，加以利用，以至于被抓取资源的网站消耗了带宽，而收益的是抓取资源的人。</p>
<p>而反盗链就可以防止别人抓取自身网站的资源。</p>
<ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    # 除了www.cqm.com之外，都返回403</span><br><span class="line">    valid_referers none blocked www.cqm.com;</span><br><span class="line">    if ($invalid_referer)&#123;</span><br><span class="line">       return 403;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-8-Nginx虚拟主机"><a href="#2-8-Nginx虚拟主机" class="headerlink" title="2.8 Nginx虚拟主机"></a>2.8 Nginx虚拟主机</h3><p>Nginx的虚拟主机是通过server块来实现的。</p>
<h4 id="2-8-1-基于IP的虚拟主机"><a href="#2-8-1-基于IP的虚拟主机" class="headerlink" title="2.8.1 基于IP的虚拟主机"></a>2.8.1 基于IP的虚拟主机</h4><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">include /usr/local/nginx/conf/conf.d/nginx_vhosts.conf;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.100;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.101;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>其它配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个逻辑网卡，重启即失效</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">mkdir /usr/local/nginx/html/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/nginx/html/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/nginx/html/web2/index.html</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.88.100/</span><br><span class="line">this is web1</span><br><span class="line">curl http://192.168.88.101/</span><br><span class="line">this is web2</span><br></pre></td></tr></table></figure>

<h4 id="2-8-2-基于端口的虚拟主机"><a href="#2-8-2-基于端口的虚拟主机" class="headerlink" title="2.8.2 基于端口的虚拟主机"></a>2.8.2 基于端口的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-8-3-基于域名的虚拟主机"><a href="#2-8-3-基于域名的虚拟主机" class="headerlink" title="2.8.3 基于域名的虚拟主机"></a>2.8.3 基于域名的虚拟主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm1.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm2.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-9-Nginx反向代理"><a href="#2-9-Nginx反向代理" class="headerlink" title="2.9 Nginx反向代理"></a>2.9 Nginx反向代理</h3><p>代理最常见的使用方式就是翻墙，能够实现让国内的用户访问国外的网站。</p>
<p>原理：</p>
<ul>
<li>用户讲请求发给代理服务器</li>
<li>代理服务器代替用户去获取数据</li>
<li>代理服务器将数据发送给用户</li>
</ul>
<p><strong>正常没有代理的上网</strong></p>
<p><img src="/2024/02/18/web/%E6%AD%A3%E5%B8%B8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="正常上网流程"></p>
<p><strong>使用代理服务器的上网</strong></p>
<p>&#x3D;<img src="/2024/02/18/web/%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="使用代理服务器上网流程"></p>
<p>代理服务器又分为两种：正向代理、反向代理</p>
<p>正向代理：代理用户向服务器获取资源</p>
<p>反向代理：代理服务器去管理网络资源，用户有请求找反向代理就可以了</p>
<ol>
<li>编写反向代理服务器主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">location / &#123;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    # 访问代理服务器就会跳转到http://192.168.88.100</span><br><span class="line">    proxy_pass http://192.168.88.100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>反向代理其它配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">client_max_body_size 10m; #允许客户端请求的最大单文件字节数</span><br><span class="line"></span><br><span class="line">client_body_buffer_size 128k; #缓冲区代理缓冲用户端请求的最大字节数，</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 90; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line"></span><br><span class="line">proxy_send_timeout 90; #后端服务器数据回传时间(代理发送超时)</span><br><span class="line"></span><br><span class="line">proxy_read_timeout 90; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line"></span><br><span class="line">proxy_buffer_size 4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line"></span><br><span class="line">proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line"></span><br><span class="line">proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line"></span><br><span class="line">proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br></pre></td></tr></table></figure>

<h3 id="2-10-Nginx下载限速"><a href="#2-10-Nginx下载限速" class="headerlink" title="2.10 Nginx下载限速"></a>2.10 Nginx下载限速</h3><p>限速方法主要分为：</p>
<ul>
<li>下载速度限制</li>
<li>单位时间内请求数限制</li>
<li>基于客户端的并发数限制</li>
</ul>
<p>Nginx官方提供的限制IP连接和并发的模块有两个：</p>
<p>limit_req_zone：用来限制单位时间内的请求数，即速率限制，采用的漏桶算法</p>
<p>limit_req_conn：来限制同一时间连接数，即并发限制</p>
<p><strong>单位时间内请求数限制</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在http快下调用模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:基于ip地址做限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:创建缓存域和缓存大小</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rate:设置访问频数</span></span><br><span class="line">limit_req_zone $binary_remote_addr zone=cqm:10m rate=1r/s;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server块</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">调用模块</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">当请求数超过5次时，就拒绝访问，并返回503状态码</span></span><br><span class="line">	limit_req zone=cqm burst=5 nodelay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>限制并发连接数</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在http快下调用模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:基于ip地址做限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:创建缓存域和缓存大小</span></span><br><span class="line">limit_req_conn $binary_remote_addr zone=cqm:10m;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server块</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">限制同一时间内下载数为1个</span></span><br><span class="line">	limit_conn cqm 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>限制下载速度</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">限制下载速度为1k</span></span><br><span class="line">	limit_rate 1k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-11-Nginx的URL重写"><a href="#2-11-Nginx的URL重写" class="headerlink" title="2.11 Nginx的URL重写"></a>2.11 Nginx的URL重写</h3><p>rewrite的主要功能是实现URL地址的重定向。Nginx的rewrite功能需要PCRE软件的支持，即通过perl兼容正则表达式语句进行规则匹配的。默认参数编译nginx就会支持rewrite的模块，但是也必须要PCRE的支持。</p>
<p>URL模板语块：</p>
<ul>
<li>set：设置变量</li>
<li>if：判断</li>
<li>return：返回值或URL</li>
<li>break：终止</li>
<li>rewrite：重定向URL</li>
</ul>
<p><strong>例一：根据不同域名跳转到主域名的不同目录下</strong></p>
<ol>
<li>创建测试目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/nginx/html/&#123;cn,jp,us&#125;</span><br><span class="line">echo &#x27;this is China&#x27; &gt; /usr/local/nginx/html/cn/index.html</span><br><span class="line">echo &#x27;this is Japan&#x27; &gt; /usr/local/nginx/html/jp/index.html</span><br><span class="line">echo &#x27;this is America&#x27; &gt; /usr/local/nginx/html/us/index.html</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改hosts文件，以便解析</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.88.100 www.cqm.com</span><br><span class="line">192.168.88.100 www.cqm.com.cn</span><br><span class="line">192.168.88.100 www.cqm.com.jp</span><br><span class="line">192.168.88.100 www.cqm.com.us</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /usr/local/nginx/conf/conf.d/rewrite.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改重定向文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置重定向server</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com.cn www.cqm.com.jp www.cqm.com.us;</span><br><span class="line">    location / &#123;</span><br><span class="line">        # 模糊匹配到cn的话，就跳转到http://www.cqm.com/cn下</span><br><span class="line">        if ($http_host ~ (cn)$)&#123;</span><br><span class="line">            set $nation cn;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (jp)$)&#123;</span><br><span class="line">            set $nation jp;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (us)$)&#123;</span><br><span class="line">            set $nation us;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://www.cqm.com.cn</span><br><span class="line">this is China</span><br><span class="line">curl -L http://www.cqm.com.jp</span><br><span class="line">this is Japan</span><br><span class="line">curl -L http://www.cqm.com.us</span><br><span class="line">this is America</span><br><span class="line">-L:自动获取重定向</span><br></pre></td></tr></table></figure>

<p><strong>例二：retuen以及break的简单实用</strong></p>
<ol>
<li>修改重定向文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">        # 模糊匹配 ~</span><br><span class="line">        # 精确匹配 =</span><br><span class="line">        # 不匹配 !~</span><br><span class="line">        # 如果匹配请求头不是chrome的话，就返回403</span><br><span class="line">        if ($http_user_agent !~ &#x27;chrome&#x27;)&#123;</span><br><span class="line">            return 403;</span><br><span class="line">            # break放在return上面的话就不会执行return操作</span><br><span class="line">            # break;</span><br><span class="line">            # return http://www.baidu.com;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>flag</strong></p>
<p>flag是放在rewrite重定向的URL后边的，格式为：rewrite URL flag</p>
<p>flag的选项有：</p>
<ol>
<li>last：本条规则匹配完成后继续执行到最后。</li>
<li>break：本条规则匹配完成即终止。</li>
<li>redirect：返回302临时重定向。</li>
<li>permanent：返回301永久重定向。</li>
</ol>
<p>redirect和permanent的区别：设置permanent的话，新网址就会完全继承旧网址，旧网址的排名等完全清零，如果不是暂时迁移的情况下都建议使用permanent；设置redirect的话，新网址对旧网址没有影响，且新网址也不会有排名。</p>
<h3 id="2-12-Nginx优化"><a href="#2-12-Nginx优化" class="headerlink" title="2.12 Nginx优化"></a>2.12 Nginx优化</h3><h4 id="2-12-1-大并发"><a href="#2-12-1-大并发" class="headerlink" title="2.12.1 大并发"></a>2.12.1 大并发</h4><p>Nginx的工作模式：主进程 + 工作进程</p>
<p>假如Nginx服务器有4个CPU</p>
<ol>
<li>设置主配文件来实现高并发</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">worker_processes  4;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定运行的核的编号，采用掩码的方式设置编号</span></span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br><span class="line">events &#123;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">单个工作进程维护的请求队列长度，根据实际情况调整</span></span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-2-长连接"><a href="#2-12-2-长连接" class="headerlink" title="2.12.2 长连接"></a>2.12.2 长连接</h4><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">keepalive_timeout用来设置长连接，0代表关闭</span></span><br><span class="line">keepalive_timeout  0;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置长连接时间100s</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_timeout  100;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置每秒可以接受的请求数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_requests 8192;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-12-3-压缩"><a href="#2-12-3-压缩" class="headerlink" title="2.12.3 压缩"></a>2.12.3 压缩</h4><p>Nginx是采用gzip进行压缩。</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启缓存</span></span><br><span class="line">gzip on;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginx做为反向代理的时候启用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">off:关闭所有的代理结果数据压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">expired:如果header中包含”Expires”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-cache:如果header中包含”Cache-Control:no-cache”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-store:如果header中包含”Cache-Control:no-store”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">private:如果header中包含”Cache-Control:private”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_last_modified:启用压缩，如果header中包含”Last_Modified”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_etag:启用压缩，如果header中包含“ETag”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">auth:启用压缩，如果header中包含“Authorization”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">any:无条件压缩所有结果数据</span></span><br><span class="line">gzip_proxied any;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span><br><span class="line">gzip_min_length 1k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置压缩所需要的缓冲区大小</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">32 4K表示按照内存页（one memory page）大小以4K为单位（即一个系统中内存页为4K），申请32倍的内存空间</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建议此项不设置，使用默认值</span></span><br><span class="line">gzip_buffers 32 4k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置gzip压缩级别，级别越底压缩速度越快文件压缩比越小，反之速度越慢文件压缩比越大</span></span><br><span class="line">gzip_comp_level 1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于识别http协议的版本，早期的浏览器不支持gzip压缩，用户会看到乱码，所以为了支持前期版本加了此选项。默认在http/1.0的协议下不开启gzip压缩</span></span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置需要压缩的MIME类型,如果不在设置类型范围内的请求不进行压缩</span></span><br><span class="line">gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-4-静态缓存"><a href="#2-12-4-静态缓存" class="headerlink" title="2.12.4 静态缓存"></a>2.12.4 静态缓存</h4><p>将部分数据缓存在用户本地磁盘，用户加载时，如果本地和服务器的数据一致，则从本地加载。提升用户访问速度，提升体验度。节省公司带宽成本。</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模糊匹配以png或gif结尾的文件</span></span><br><span class="line">location ~*  \.(png|gif)$ &#123;</span><br><span class="line">    # 缓存时间为1小时</span><br><span class="line">    expires 1h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="三、Tomcat"><a href="#三、Tomcat" class="headerlink" title="三、Tomcat"></a>三、Tomcat</h2><h3 id="3-1-Tomcat介绍"><a href="#3-1-Tomcat介绍" class="headerlink" title="3.1 Tomcat介绍"></a>3.1 Tomcat介绍</h3><p>Tomcat 服务器是一个免费的开放源代码的 Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试 JSP 程序的首选。</p>
<p>实际上 Tomcat 是 Apache 服务器的扩展，但运行时它是独立运行的，所以当你运行 tomcat 时，它实际上作为一个与 Apache 独立的进程单独运行的。</p>
<p>Tomcat 官方文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/">https://tomcat.apache.org/</a></p>
<h3 id="3-2-Tomcat安装"><a href="#3-2-Tomcat安装" class="headerlink" title="3.2 Tomcat安装"></a>3.2 Tomcat安装</h3><ol>
<li>安装jdk和tomcat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk*</span><br><span class="line">wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.43/bin/apache-tomcat-9.0.43.tar.gz</span><br><span class="line">tar -xf apache-tomcat-9.0.43.tar.gz</span><br><span class="line">mkdir /root/tomcat</span><br><span class="line">mv apache-tomcat-9.0.43.tar.gz/* /root/tomcat</span><br><span class="line">./root/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>

</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/5/">Previous</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/page/7/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/5/">5</a></li><li><a class="pagination-link is-current" href="/page/6/">6</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/NUX_Octodex.gif" alt="Warner"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">29</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">20</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqmmm/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-31T09:18:10.000Z">2024-03-31</time></p><p class="title"><a href="/2024/03/31/calico%E7%9A%84%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F/">calico的三种模式</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-31T09:04:31.000Z">2024-03-31</time></p><p class="title"><a href="/2024/03/31/%E5%85%AB%E8%82%A1%E6%96%87%E9%9A%8F%E8%AE%B0%E5%BD%95/">八股文随记录</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-31T07:44:02.000Z">2024-03-31</time></p><p class="title"><a href="/2024/03/31/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1ipv4-forward%E8%A2%AB%E4%BF%AE%E6%94%B9%E5%AF%BC%E8%87%B4%E7%9A%84%E7%94%9F%E4%BA%A7%E4%BA%8B%E6%95%85/">记录一次ipv4_forward被修改导致的生产事故</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-30T15:59:11.000Z">2024-03-30</time></p><p class="title"><a href="/2024/03/30/K8s%E7%BB%99%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%AE%BE%E7%BD%AE%E4%B8%93%E4%BA%AB%E8%8A%82%E7%82%B9/">K8s给命名空间设置专享节点</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-30T13:23:16.000Z">2024-03-30</time></p><p class="title"><a href="/2024/03/30/CoreDNS%E5%92%8CNodeLocalDNS%E7%9A%84%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/">CoreDNS和NodeLocalDNS的域名解析</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/calico/"><span class="tag">calico</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/container/"><span class="tag">container</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/containerd/"><span class="tag">containerd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/etcd/"><span class="tag">etcd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">首页</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2024 Warner</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>