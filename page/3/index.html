<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Warner&#039;s Wiki"><meta property="og:url" content="https://cqmmm.github.io/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cqmmm.github.io/img/og_image.png"><meta property="article:author" content="Warner"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cqmmm.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqmmm.github.io"},"headline":"Warner's Wiki","image":["https://cqmmm.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Warner"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://cqmmm.github.io/logo.jpg"}},"description":""}</script><link rel="icon" href="/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T10:59:10.989Z" title="2/18/2024, 6:59:10 PM">2024-02-18</time></span><span class="level-item">3 hours read (About 31093 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/kubernetes/">Kubernetes</a></p><div class="content"><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><h3 id="1-1-k8s概述"><a href="#1-1-k8s概述" class="headerlink" title="1.1 k8s概述"></a>1.1 k8s概述</h3><p>Kubernetes 是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。 Kubernetes 拥有一个庞大且快速增长的生态系统。Kubernetes 的服务、支持和工具广泛可用。</p>
<p><img src="/2024/02/18/kubernetes/k8s%E5%9B%BE%E6%A0%87.jpg" alt="k8s图标"></p>
<p>容器是打包和运行应用程序的好方式。在生产环境中，你需要管理运行应用程序的容器，并确保不会停机。 例如，如果一个容器发生故障，则需要启动另一个容器。如果系统处理此行为，会不会更容易？</p>
<p>这就是 Kubernetes 来解决这些问题的方法！ Kubernetes 为你提供了一个可弹性运行分布式系统的框架。 Kubernetes 会满足你的扩展要求、故障转移、部署模式等。 例如，Kubernetes 可以轻松管理系统的 Canary 部署。</p>
<p>Kubernetes 简称 k8s，主要功能有：</p>
<ul>
<li>服务发现和负载均衡</li>
<li>存储编排</li>
<li>自动部署和回滚</li>
<li>自动完成装箱计算</li>
<li>自我修复</li>
<li>密钥与配置管理</li>
</ul>
<h3 id="1-2-k8s组件"><a href="#1-2-k8s组件" class="headerlink" title="1.2 k8s组件"></a>1.2 k8s组件</h3><p>一个 Kubernetes 集群由一组被称作节点的机器组成。这些节点上运行 Kubernetes 所管理的容器化应用。集群具有至少一个工作节点。</p>
<p>工作节点托管作为应用负载的组件的 Pod 。控制平面管理集群中的工作节点和 Pod 。 为集群提供故障转移和高可用性，这些控制平面一般跨多主机运行，集群跨多个节点运行。</p>
<p><img src="/2024/02/18/kubernetes/k8s%E6%9E%B6%E6%9E%84.svg" alt="k8s架构"></p>
<h4 id="1-2-1-控制平面组件"><a href="#1-2-1-控制平面组件" class="headerlink" title="1.2.1 控制平面组件"></a>1.2.1 控制平面组件</h4><p><strong>kube-apiserver：</strong></p>
<p>API 服务器是 Kubernetes 控制面的组件，该组件公开了 Kubernetes API。API 服务器是 Kubernetes 控制面的前端。</p>
<p><strong>etcd：</strong></p>
<p>etcd 是兼具一致性和高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库。</p>
<p><strong>kube-scheduler：</strong></p>
<p>控制平面组件，负责监视新创建的、未指定运行节点（node）的 Pods，选择节点让 Pod 在上面运行。</p>
<p>调度决策考虑的因素包括单个 Pod 和 Pod 集合的资源需求、硬件&#x2F;软件&#x2F;策略约束、亲和性和反亲和性规范、数据位置、工作负载间的干扰和最后时限。</p>
<p><strong>kube-controller-manager：</strong></p>
<p>在主节点上运行控制器的组件。</p>
<p>控制器包括：</p>
<ul>
<li>节点控制器（Node Controller）: 负责在节点出现故障时进行通知和响应</li>
<li>任务控制器（Job controller）: 监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成</li>
<li>端点控制器（Endpoints Controller）: 填充端点(Endpoints)对象(即加入 Service 与 Pod)</li>
<li>服务帐户和令牌控制器（Service Account &amp; Token Controllers）: 为新的命名空间创建默认帐户和 API 访问令牌</li>
</ul>
<p><strong>cloud-controller-manager：</strong></p>
<p>云控制器管理器是指嵌入特定云的控制逻辑的控制平面组件。云控制器管理器允许您链接聚合到云提供商的应用编程接口中，并分离出相互作用的组件与您的集群交互的组件。</p>
<p>下面的控制器都包含对云平台驱动的依赖：</p>
<ul>
<li>节点控制器（Node Controller）: 用于在节点终止响应后检查云提供商以确定节点是否已被删除</li>
<li>路由控制器（Route Controller）: 用于在底层云基础架构中设置路由</li>
<li>服务控制器（Service Controller）: 用于创建、更新和删除云提供商负载均衡器</li>
</ul>
<h4 id="1-2-2-Node组件"><a href="#1-2-2-Node组件" class="headerlink" title="1.2.2 Node组件"></a>1.2.2 Node组件</h4><p>节点组件在每个节点上运行，维护运行的 Pod 并提供 Kubernetes 运行环境。</p>
<p><strong>kubelet：</strong></p>
<p>一个在集群中每个节点（node）上运行的代理。它保证容器（containers）都运行在 Pod 中。</p>
<p>kubelet 接收一组通过各类机制提供给它的 PodSpecs，确保这些 PodSpecs 中描述的容器处于运行状态且健康。 kubelet 不会管理不是由 Kubernetes 创建的容器。</p>
<p><strong>容器运行时（Container Runtime）：</strong></p>
<p>容器运行环境是负责运行容器的软件，例如 Docker 。</p>
<h4 id="1-2-3-插件（Addons）"><a href="#1-2-3-插件（Addons）" class="headerlink" title="1.2.3 插件（Addons）"></a>1.2.3 插件（Addons）</h4><p>插件使用 Kubernetes 资源（DaemonSet、Deployment等）实现集群功能。 因为这些插件提供集群级别的功能，插件中命名空间域的资源属于 <code>kube-system</code> 命名空间。</p>
<p><strong>DNS：</strong></p>
<p>尽管其他插件都并非严格意义上的必需组件，但几乎所有 Kubernetes 集群都应该 有集群 DNS， 因为很多示例都需要 DNS 服务。</p>
<p><strong>Web 界面（仪表盘）：</strong></p>
<p>Dashboard 是Kubernetes 集群的通用的、基于 Web 的用户界面。 它使用户可以管理集群中运行的应用程序以及集群本身并进行故障排除。</p>
<p><strong>容器资源监控：</strong></p>
<p>容器资源监控将关于容器的一些常见的时间序列度量值保存到一个集中的数据库中，并提供用于浏览这些数据的界面。</p>
<p><strong>集群层面日志：</strong></p>
<p>集群层面日志机制负责将容器的日志数据 保存到一个集中的日志存储中，该存储能够提供搜索和浏览接口。</p>
<h3 id="1-3-Pod"><a href="#1-3-Pod" class="headerlink" title="1.3 Pod"></a>1.3 Pod</h3><h4 id="1-3-1-Pod概念"><a href="#1-3-1-Pod概念" class="headerlink" title="1.3.1 Pod概念"></a>1.3.1 Pod概念</h4><p>Pod 是 k8s 中的最小单元，一个 Pod 包含一个或多个容器，一个 Pod 不会跨越多个节点（Node）。</p>
<p>而每个 Pod 里都会有一个根容器 pause，Pod 中的其他容器都共享 pause 根容器的网络栈和volume挂载卷，因此容器之间的通信和数据交换会更为高效。</p>
<h4 id="1-3-2-RC、RS、Deployment"><a href="#1-3-2-RC、RS、Deployment" class="headerlink" title="1.3.2 RC、RS、Deployment"></a>1.3.2 RC、RS、Deployment</h4><p>k8s 管理 Pod 主要用到以下三个组件：</p>
<ul>
<li>Replication Controller（RC）：用来确保容器应用的副本数始终保持在用户定义的副本数，如果有容器异常退出，会自动创建新的 Pod 来代替，如果有异常多出的容器也会自动回收。</li>
<li>ReplicaSet（RS）：相比 RC 多了支持 selector，推荐使用 RS。</li>
<li>Deployment：用来管理 RS。</li>
</ul>
<p>来看看 Deployment 和 RS 是如何实现更新的：</p>
<ol>
<li>Deployment 创建新的 RS</li>
</ol>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%B8%80.png" alt="RS和Deployment实现更新一"></p>
<ol start="2">
<li>RS1删除一个容器，接着 RS2 新建一个新版本的 Pod</li>
</ol>
<p>	</p>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%BA%8C.png" alt="RS和Deployment实现更新二"></p>
<ol start="3">
<li>全部更新完之后，RS1 并不会删除，而是保留着处于停用状态，如果新版本出了问题需要回滚，就可以反过来操作实现回滚</li>
</ol>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%B8%89.png" alt="RS和Deployment实现更新三"></p>
<h4 id="1-3-3-Horizontal-Pod-Autoscaler"><a href="#1-3-3-Horizontal-Pod-Autoscaler" class="headerlink" title="1.3.3 Horizontal Pod Autoscaler"></a>1.3.3 Horizontal Pod Autoscaler</h4><p>Horizontal Pod Autoscaler（HPA）在k8s集群中用于 Pod 水平自动弹性伸缩，它是基于 CPU 和内存利用率对 Deployment 和 RS 中的 Pod 数量进行自动扩缩容（除了 CPU 和内存利用率之外，也可以基于其他应程序提供的度量指标 custom metrics 进行自动扩缩容）。</p>
<p>假如 HPA 检测到当前 Deployment 和 RS 所管理的 Pod 的 CPU 或内存使用率超过了设定之后，就会创建新的 Pod 来实现降压，新建 Pod 的数量限制由 Max 和 Min 设定。</p>
<p><img src="/2024/02/18/kubernetes/HPA.png" alt="HPA"></p>
<h4 id="1-3-4-StatefulSet"><a href="#1-3-4-StatefulSet" class="headerlink" title="1.3.4 StatefulSet"></a>1.3.4 StatefulSet</h4><p>RS 和 Deployment 都是面向无状态的服务，它们所管理的 Pod 的 IP、名字，启停顺序等都是随机的，而 StatefulSet 是有状态的集合，管理所有有状态的服务，比如 MySQL、MongoDB 集群等。</p>
<p>StatefulSet 的特点有：</p>
<p>Pod 的一致性：包含次序（启停顺序，例如 mysql -&gt; php-fpm -&gt; nginx 的启动顺序）、网络一致性（与 Pod 相关，与被调度的 Node 节点无关）。</p>
<p>稳定的存储：即 Pod 重新调度之后还是访问到相同的持久化数据，基于 PVC（PV 是集群中由管理员提供或使用存储类动态提供的一块存储。它是集群中的资源，就像节点是集群资源一样。而 PVC 是用户对存储的请求。它类似于 Pod，Pod 消耗 Node 资源，而 PVC 消耗 PV 资源。） 来实现。</p>
<p>稳定的次序：对于N个副本的 StatefulSet，每个 Pod 都在 [0，N) 的范围内分配一个数字序号，且是唯一的。</p>
<p>稳定的网络：Pod 的 hostname 模式为：( StatefulSet 名称 ) - ( 序号 )。</p>
<h4 id="1-3-5-DaemonSet"><a href="#1-3-5-DaemonSet" class="headerlink" title="1.3.5 DaemonSet"></a>1.3.5 DaemonSet</h4><p>DaemonSet 确保全部或者一部分 Node 上运行一个 Pod 的副本，当有 Node 加入集群时，也会为他们新增一个 Pod，当这些 Node 退出集群时，这些 Pod 也会被回收。</p>
<p>DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行 glusterd、ceph等。</li>
<li>运行日志收集daemon，例如fluentd、logstash等。</li>
<li>运行监控daemon，例如 Prometheus 的 Node exporter、zabbix等。</li>
</ul>
<h4 id="1-3-6-Job和Cron-Job"><a href="#1-3-6-Job和Cron-Job" class="headerlink" title="1.3.6 Job和Cron Job"></a>1.3.6 Job和Cron Job</h4><p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束。</p>
<p>这里可能有人会想，那在 linux 上直接执行脚本不就行了吗？其实这就会有个问题，如果脚本执行失败那么久退出且不会再执行了，需要执行就必须手动，但 Job 设置的任务只有在正常执行结束后才会结束，否则一直执行到成功为止。Job 也可以设置成功的次数要达到几次才允许退出。</p>
<p>Cron Job 是基于时间管理控制 Job，即在给定的时间只运行一次、周期性的在指定时间运行。</p>
<h4 id="1-3-7-Service"><a href="#1-3-7-Service" class="headerlink" title="1.3.7 Service"></a>1.3.7 Service</h4><p>Pod 的生命是有限的，如果 Pod 重启 IP 也可能会发生变化。如果我们将 Pod 的 IP 写死，Pod 如果挂了或重启，其它的服务也会不可用。我们可以把我们的服务（各种 Pod）注册到服务发现中心去，让服务发现中心去动态更新其它服务的配置就可以了，k8s 就给我们提供了这么一个服务，即 Service。</p>
<p>我们这样就可以不用去管后端的 Pod 如何变化，只需要指定 Service 的地址就可以了，因为我们在中间添加了一层服务发现的中间件，Pod 销毁或者重启后，把这个 Pod 的地址注册到这个服务发现中心去。</p>
<p><img src="/2024/02/18/kubernetes/service.png" alt="service"></p>
<h3 id="1-4-k8s的网络通讯方式"><a href="#1-4-k8s的网络通讯方式" class="headerlink" title="1.4 k8s的网络通讯方式"></a>1.4 k8s的网络通讯方式</h3><p>k8s 的网络模型假定了所有的 Pod 都在一个可以直接连通的扁平化网络空间中，在这 GCE（Google Compute Engine）里面是现成的网络模型。</p>
<p>Flannel 是 CoreOS 团队针对 Kubernetes 设计一个网络规划服务，简单来说，它的功能是让集群中的不同节点主机创建 Docker 容器都具有全集群唯一的虚拟 IP 地址。而且它还能在这些 IP 地址之间建立一个覆盖网络（Overlay Network），通过覆盖网络将数据包原封不动的传递到目标容器内。</p>
<p>通过一个架构图来看看不同情况下的通讯是怎么样的：</p>
<p><img src="/2024/02/18/kubernetes/%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="网络通讯方式架构图"></p>
<p>通讯情况主要分为以下几种：</p>
<ol>
<li>同一 Pod 不同容器之间的通信：采用 pause 网络栈。</li>
<li>同一 Node 不同 Pod 之间的通信：通过 docker0 网桥进行通信。</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E5%90%8C%E4%B8%80Node%E5%86%85%E4%B8%8D%E5%90%8CPod%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E8%AE%AF.png" alt="同一Node内不同Pod之间的通讯"></p>
<ol>
<li>不同 Node 的 Pod 之间的通信：不同 Node 的 Pod 之间的通信是 k8s 网络通信的难点，是通过 Flannel 网络通讯方式来实现的，通讯的过程分为以下几个步骤：<ul>
<li>数据包从 Node1 的 Pod 到达 docker0 网桥</li>
<li>Flanneld 会开启一个 Flannel0 的网桥，用来抓取到达 docker0 的数据，可以理解为一个钩子函数</li>
<li>Flanneld 会有很多路由表信息，是存储在 etcd 中由 Flanneld 自动获取的，通过路由表知道了转发信息后就通过物理网卡进行转发</li>
<li>发送到目标主机的物理网卡后，就会再通过 Flanneld -&gt; Flannel0网桥 -&gt; docker0网桥，最终到达目的 Pod</li>
</ul>
</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E4%B8%8D%E5%90%8CNode%E7%9A%84Pod%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1.png" alt="不同Node的Pod之间的通信"></p>
<ol>
<li>Pod 与 service 之间的通信：采用各节点的 iptables 规则来实现。</li>
<li>Pod 到外网：通过 Flanneld 到达物理网卡，经过路由选择后，iptables 执行 Masquerade，把Pod 的虚拟 IP 改为 物理网卡的 IP，在向外网服务器发出请求。</li>
<li>外网到 Pod：通过 service 进行访问，一般使用 NodePort。</li>
</ol>
<h2 id="二、k8s部署"><a href="#二、k8s部署" class="headerlink" title="二、k8s部署"></a>二、k8s部署</h2><p>本次 k8s 部署为以下环境</p>
<p><img src="/2024/02/18/kubernetes/k8s%E9%83%A8%E7%BD%B2%E6%9D%A1%E4%BB%B6.png" alt="k8s部署条件"></p>
<h3 id="2-1-基本环境配置（所有节点）"><a href="#2-1-基本环境配置（所有节点）" class="headerlink" title="2.1 基本环境配置（所有节点）"></a>2.1 基本环境配置（所有节点）</h3><ol>
<li>在各主机设置主机名以及host文件解析</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master01</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br><span class="line">hostnamectl set-hostname k8s-node02</span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.88.10 k8s-master01</span><br><span class="line">192.168.88.20 k8s-node01</span><br><span class="line">192.168.88.21 k8s-node02</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装依赖</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install conntrack ntpdate ntp ipvsadm ipset jp iptables curl stsstat libseccomp wget vim net-tools git</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>设置防火墙为iptables并设置空规则</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line">yum -y install iptables-services</span><br><span class="line">systemctl start iptables</span><br><span class="line">systemctl enable iptables</span><br><span class="line">iptables -F &amp;&amp; service iptables save</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>关闭虚拟内存和selinux</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sed -i &#x27;/ swap / s/^\(.*\)$/#/g&#x27; /etc/fstab</span><br><span class="line">setenforce 0 &amp;&amp; sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调整内核参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ipv6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0 # 禁用swap，只有系统OOM时才允许使用</span><br><span class="line">vm.overcommit_memory=1 # 不检查物理内存是否够用</span><br><span class="line">vm.panic_on_oom=0 # 开启OOM</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line">cp kubernetes.conf /etc/sysctl.d/kubernetes.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>调整系统时区</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设为中国/上海</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将当前UTC时间写入硬件时钟</span></span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启依赖于时间的服务</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>关闭不需要的服务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭邮件服务</span></span><br><span class="line">systemctl stop postfix &amp;&amp; systemctl disable postfix</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>设置rsyslog和systemd journald</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">持久化保存日志目录</span></span><br><span class="line">mkdir /var/log/journal</span><br><span class="line">mkdir /etc/systemd/journald.conf.d</span><br><span class="line">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF</span><br><span class="line">[Journal]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">持久化保存到磁盘</span></span><br><span class="line">Storage=persistent</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">压缩历史日志</span></span><br><span class="line">Compress=yes</span><br><span class="line"> </span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最大占用空间 10G</span></span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">单日志文件最大 200M</span></span><br><span class="line">SystemMaxFileSize=200M</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">日志保存时间 2 周</span></span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不将日志转发到 syslog</span></span><br><span class="line">ForwardToSyslog=no</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>升级内核</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入公钥</span></span><br><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装elrepo源</span></span><br><span class="line">yum -y install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">升级内核</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机从新内核启动</span></span><br><span class="line">grub2-set-default &quot;CentOS Linux (5.4.116-1.e17.elrepo.x86_64) 7 (Core)&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看内核启动项</span></span><br><span class="line">grub2-editenv list</span><br></pre></td></tr></table></figure>

<h3 id="2-2-kubeadm部署（所有节点）"><a href="#2-2-kubeadm部署（所有节点）" class="headerlink" title="2.2 kubeadm部署（所有节点）"></a>2.2 kubeadm部署（所有节点）</h3><ol>
<li>kube-proxy开启ipvs前置条件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">vim /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack&quot;</span><br><span class="line"></span><br><span class="line">for kernel_module in $&#123;ipvs_modules&#125;;</span><br><span class="line">do</span><br><span class="line">    /sbin/modinfo -F filename $&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe $&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装docker</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum -y install yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce docker-ce-cli</span><br><span class="line"></span><br><span class="line">mkdir /etc/docker</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">        &quot;registry-mirrors&quot;: [&quot;http://f1361db2.m.daocloud.io&quot;],</span><br><span class="line">        &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">        &quot;log-driver&quot;:&quot;json-file&quot;,</span><br><span class="line">        &quot;log-opts&quot;:&#123;</span><br><span class="line">                &quot;max-size&quot;:&quot;100m&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker</span><br></pre></td></tr></table></figure>

<h3 id="2-3-安装kubeadm（所有节点）"><a href="#2-3-安装kubeadm（所有节点）" class="headerlink" title="2.3 安装kubeadm（所有节点）"></a>2.3 安装kubeadm（所有节点）</h3><ol>
<li>安装 kubeadm kubectl kubelet</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum -y install kubeadm kubectl kubelet</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>通过kubeadm查看目前各镜像版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.21.0</span><br><span class="line">k8s.gcr.io/pause:3.4.1</span><br><span class="line">k8s.gcr.io/etcd:3.4.13-0</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.0</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写脚本，通过阿里镜像安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim k8s_images.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">apiserver_var=v1.21.0</span><br><span class="line">controller_manager_var=v1.21.0</span><br><span class="line">scheduler_var=v1.21.0</span><br><span class="line">proxy_var=v1.21.0</span><br><span class="line">pause_var=3.4.1</span><br><span class="line">etcd_var=3.4.13-0</span><br><span class="line">coredns_var=v1.8.0</span><br><span class="line">image_aliyun=(kube-apiserver:$apiserver_var kube-controller-manager:$controller_manager_var kube-scheduler:$scheduler_var kube-proxy:$proxy_var pause:$pause_var etcd:$etcd_var coredns/coredns:$coredns_var)</span><br><span class="line"></span><br><span class="line">for image in $&#123;image_aliyun[@]&#125;</span><br><span class="line">do</span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$image</span><br><span class="line">    docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/$image k8s.gcr.io/$&#123;image&#125;</span><br><span class="line">    docker rmi  registry.cn-hangzhou.aliyuncs.com/google_containers/$image</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">./k8s_images.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">问题</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于杭州阿里源里目前没有coredns:v1.8.0版本，所以在北京阿里源下载</span></span><br><span class="line">docker pull registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0</span><br><span class="line">docker tag  registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0 k8s.gcr.io/coredns/coredns:v1.8.0</span><br><span class="line">docker rmi  registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0</span><br></pre></td></tr></table></figure>

<h3 id="2-4-初始化Master节点"><a href="#2-4-初始化Master节点" class="headerlink" title="2.4 初始化Master节点"></a>2.4 初始化Master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults &gt; kubeadm.config.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">kubeadm.config.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="comment"># 改成master节点IP地址</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.10</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.21</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="comment"># 添加这一段</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">kubeproxy:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">ipvs</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm.config.yml --upload-certs | tee kubeadm-init.log</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化后操作</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<h3 id="2-5-部署网络"><a href="#2-5-部署网络" class="headerlink" title="2.5 部署网络"></a>2.5 部署网络</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p k8s/plugin/flannel &amp;&amp; cd k8s/plugin/flannel</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl create -f kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>kube-flannel.yml文件内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp.flannel.unprivileged</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">seccomp.security.alpha.kubernetes.io/allowedProfileNames:</span> <span class="string">docker/default</span></span><br><span class="line">    <span class="attr">seccomp.security.alpha.kubernetes.io/defaultProfileName:</span> <span class="string">docker/default</span></span><br><span class="line">    <span class="attr">apparmor.security.beta.kubernetes.io/allowedProfileNames:</span> <span class="string">runtime/default</span></span><br><span class="line">    <span class="attr">apparmor.security.beta.kubernetes.io/defaultProfileName:</span> <span class="string">runtime/default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configMap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secret</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">emptyDir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hostPath</span></span><br><span class="line">  <span class="attr">allowedHostPaths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/etc/cni/net.d&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/etc/kube-flannel&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/run/flannel&quot;</span></span><br><span class="line">  <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Users and groups</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="comment"># Privilege Escalation</span></span><br><span class="line">  <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">defaultAllowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Capabilities</span></span><br><span class="line">  <span class="attr">allowedCapabilities:</span> [<span class="string">&#x27;NET_ADMIN&#x27;</span>, <span class="string">&#x27;NET_RAW&#x27;</span>]</span><br><span class="line">  <span class="attr">defaultAddCapabilities:</span> []</span><br><span class="line">  <span class="attr">requiredDropCapabilities:</span> []</span><br><span class="line">  <span class="comment"># Host namespaces</span></span><br><span class="line">  <span class="attr">hostPID:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostIPC:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostPorts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">min:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">max:</span> <span class="number">65535</span></span><br><span class="line">  <span class="comment"># SELinux</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="comment"># SELinux is unused in CaaSP</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">&#x27;RunAsAny&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;extensions&#x27;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&#x27;podsecuritypolicies&#x27;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&#x27;use&#x27;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&#x27;psp.flannel.unprivileged&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/os</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.14.0-rc1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.14.0-rc1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/flannel</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br></pre></td></tr></table></figure>

<p>部署完后可以看到 flannel 网卡</p>
<p><img src="/2024/02/18/kubernetes/flannel%E7%BD%91%E5%8D%A1.png" alt="flannel网卡"></p>
<p>通过命令查看各模块运行情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/k8s%E5%90%84%E6%A8%A1%E5%9D%97%E8%BF%90%E8%A1%8C%E6%83%85%E5%86%B5.png" alt="k8s各模块运行情况"></p>
<h3 id="2-6-添加Node节点"><a href="#2-6-添加Node节点" class="headerlink" title="2.6 添加Node节点"></a>2.6 添加Node节点</h3><ol>
<li>查看kubeadm-init.log</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">kubeadm join 192.168.88.10:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:37c9645a7a2ee75301f132537240157ecd4f464494022cc442f77489c1978989</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在node主机上执行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.88.10:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:37c9645a7a2ee75301f132537240157ecd4f464494022cc442f77489c1978989</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在master主机查看是否加入成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">...</span><br><span class="line">kubectl get pod -n kube-system -o wide</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h2 id="三、k8s资源清单"><a href="#三、k8s资源清单" class="headerlink" title="三、k8s资源清单"></a>三、k8s资源清单</h2><p>在 k8s 中，一般使用 yaml 格式的文件来创建符合我们预期期望的 pod，这样的 yaml 文件我们一般称为资源清单。</p>
<h3 id="3-1-资源类型"><a href="#3-1-资源类型" class="headerlink" title="3.1 资源类型"></a>3.1 资源类型</h3><p><strong>名称空间级别</strong></p>
<p>工作负载型资源：Pod、RS、Deployment、StatefulSet、DaemonSet、Job、CronJob</p>
<p>服务发现及负载均衡型资源：Service</p>
<p>配置与存储型资源：Volume、CSI</p>
<p>特殊类型的存储卷：ConfigMap(当配置中心来使用的资源类型)、Secret(保存敏感数据)、DownwarAPI(把外部环境中的信息输出给容器)</p>
<p>集群级资源：Namespace、Node、Role、ClusterRole、RoleBinding、ClusterRoleBinding</p>
<p>元数据型资源：HPA、PodTemplate、LimitRange</p>
<h3 id="3-2-常用字段"><a href="#3-2-常用字段" class="headerlink" title="3.2 常用字段"></a>3.2 常用字段</h3><p><strong>必要属性</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>apiVersion</td>
<td>String</td>
<td>K8S API 的版本，目前基本是v1，可以用 kubectl api-versions 命令查询</td>
</tr>
<tr>
<td>kind</td>
<td>String</td>
<td>这里指的是 yaml 文件定义的资源类型和角色，比如: Pod</td>
</tr>
<tr>
<td>metadata</td>
<td>Object</td>
<td>元数据对象，固定值写 metadata</td>
</tr>
<tr>
<td>metadata.name</td>
<td>String</td>
<td>元数据对象的名字，这里由我们编写，比如命名Pod的名字</td>
</tr>
<tr>
<td>metadata.namespace</td>
<td>String</td>
<td>元数据对象的命名空间，由我们自身定义</td>
</tr>
<tr>
<td>spec</td>
<td>Object</td>
<td>详细定义对象，固定值写Spec</td>
</tr>
<tr>
<td>spec.containers[]</td>
<td>list</td>
<td>这里是Spec对象的容器列表定义，是个列表</td>
</tr>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>这里定义容器的名字</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>这里定义要用到的镜像名称</td>
</tr>
</tbody></table>
<p><strong>spec 主要对象</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>定义容器的名字</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>定义要用到的镜像的名称</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>String</td>
<td>定义镜像拉取策略，有 Always，Never，IfNotPresent 三个值课选 （1）Always：意思是每次尝试重新拉取镜像 （2）Never：表示仅使用本地镜像 （3）IfNotPresent：如果本地有镜像就是用本地镜像，没有就拉取在线镜像。上面三个值都没设置的话，默认是 Always</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>指定容器启动命令，因为是数组可以指定多个，不指定则使用镜像打包时使用的启动命令</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>指定容器启动命令参数，因为是数组可以指定多个</td>
</tr>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>指定容器的工作目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>指定容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>指定可以被容器挂载的容器卷的路径</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].readOnly</td>
<td>String</td>
<td>设置存储卷路径的读写模式，true 或者 false，默认为读写模式</td>
</tr>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>指定容器需要用到的端口列表</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>指定端口名称</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>指定容器需要监听的端口号</td>
</tr>
<tr>
<td>spec.containers[].ports.hostPort</td>
<td>String</td>
<td>指定容器所在主机需要监听的端口号，默认跟上面 containerPort 相同，注意设置了 hostPort 同一台主机无法启动该容器的相同副本（因为主机的端口号不能相同，这样会冲突）</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>指定端口协议，支持TCP和UDP，默认值为TCP</td>
</tr>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>指定容器运行千需设置的环境变量列表</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>指定环境变量名称</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>指定环境变量值</td>
</tr>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>指定设置容器运行时资源的运行上限</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>指定CPU的限制，单位为 core 数，将用于 docker run –cpu-shares 参数</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>指定 MEM 内存的限制，单位为 MIB，GIB</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>指定容器启动和调度室的限制设置</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPU请求，单位为 core 数，容器启动时初始化可用数量</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>内存请求，单位为 MIB，GIB 容器启动的初始化可用数量</td>
</tr>
</tbody></table>
<p><strong>额外的参数项</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>定义Pod重启策略，可以选择值为 Always、OnFailure、Never，默认值为 Always。1. Always：Pod一旦终止运行，则无论容器是如何终止的，kubelet 服务都将重启它。2. OnFailure：只有 Pod 以非零退出码终止时，kubelet 才会重启该容器。如果容器正常结束（退出码为0），则 kubelet 将不会重启它。3. Never：Pod 终止后，kubelet 将退出码报告给 Master，不会重启该 Pod。</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>定义 Node 的 Label 过滤标签，以 key:value 格式指定</td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>Object</td>
<td>定义pull 镜像是使用 secret 名称，以 name:secretkey 格式指定</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>定义是否使用主机网络模式，默认值为 false。设置 true 表示使用宿主机网络，不使用 docker 网桥，同时设置了 true 将无法在同一台宿主机上启动第二个副本。</td>
</tr>
</tbody></table>
<p><strong>辅助命令</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看资源对象用法</span></span><br><span class="line">kubectl explain &lt;资源对象&gt; </span><br></pre></td></tr></table></figure>

<p>例子：</p>
<ol>
<li>创建 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx.yaml</span></span><br><span class="line"><span class="comment"># 此处只有必要字段</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否生成pod</span></span><br><span class="line">kubectl get pod</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pod详细信息</span></span><br><span class="line">kubectl describe pod nginx-pod</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试能否访问</span></span><br><span class="line">curl 10.244.1.2 # 此处为flannel分配的地址</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="3-3-容器生命周期"><a href="#3-3-容器生命周期" class="headerlink" title="3.3 容器生命周期"></a>3.3 容器生命周期</h3><p>每一个 Pod 被成功创立之前，都会进行初始化，会运行零个或若干个 init 容器，init 容器运行完就释放，接着才会运行 main 主容器，当然在 init 容器运行之前会先运行 pause 容器，以保证存储和网络的可用。</p>
<p>init 容器与普通的容器非常相似，除了以下两点：</p>
<ul>
<li>init 容器总是运行到完成。</li>
<li>每个 init 容器都要在下一个容器启动之前完成。</li>
</ul>
<p>如果 Pod 的 Init 容器失败，kubelet 会不断地重启该 Init 容器直到该容器成功为止。 然而，如果 Pod 对应的 <code>restartPolicy</code> 值为 “Never”，Kubernetes 不会重新启动 Pod。</p>
<p>如果为一个 Pod 指定了多个 Init 容器，这些容器会按顺序逐个运行。 每个 Init 容器必须运行成功，下一个才能够运行。当所有的 Init 容器运行完成时， Kubernetes 才会为 Pod 初始化应用容器并像平常一样运行。</p>
<p><strong>init 容器的使用</strong></p>
<p>因为 Init 容器具有与应用容器分离的单独镜像，其启动相关代码具有如下优势：</p>
<ul>
<li>Init 容器可以包含一些安装过程中应用容器中不存在的实用工具或个性化代码。 例如，没有必要仅为了在安装过程中使用类似 <code>sed</code>、<code>awk</code>、<code>python</code> 或 <code>dig</code> 这样的工具而去 <code>FROM</code> 一个镜像来生成一个新的镜像。</li>
<li>Init 容器可以安全地运行这些工具，避免这些工具导致应用镜像的安全性降低。</li>
<li>应用镜像的创建者和部署者可以各自独立工作，而没有必要联合构建一个单独的应用镜像。</li>
<li>Init 容器能以不同于 Pod 内应用容器的文件系统视图运行。因此，Init 容器可以访问应用容器不能访问的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">Secret</a> 的权限。</li>
<li>由于 Init 容器必须在应用容器启动之前运行完成，因此 Init 容器提供了一种机制来阻塞或延迟应用容器的启动，直到满足了一组先决条件。 一旦前置条件满足，Pod 内的所有的应用容器会并行启动。</li>
</ul>
<p><strong>init 容器使用例子</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">busybox.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="comment"># 定义了一个 Pod 叫 busybox-pod，busybox 封装了 linux 的大量命令</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line"><span class="comment"># 定义该 Pod 下的资源，也就是容器</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义了一个 busybox 容器</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo The busybox app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">  <span class="comment"># 定义 init 容器，init 容器全部执行完前不会执行 busybox 容器</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="comment"># 第一个 init 容器，如果检查 service 中没有注册 myservice，则休眠2秒继续执行，直到成功</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done&#x27;</span>]</span><br><span class="line">    <span class="comment"># 第一个 init 容器运行完就运行该 init 容器，检查 service 中有没有注册 mydb</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mydb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until nslookup mydb; do echo waiting for mydb; sleep 2; done&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f busybox.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到一直处于 <code>Init:0/2</code> 状态，因为第一个 init 容器一直没完成</li>
</ol>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="init容器测试一"></p>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="init容器测试二"></p>
<ol start="4">
<li>编写 yaml 文件添加 service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9377</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f service.yaml</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>可以看到两个 init 容器都执行完，main 主容器也就运行了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="init容器测试三"></p>
<h3 id="3-4-探针"><a href="#3-4-探针" class="headerlink" title="3.4 探针"></a>3.4 探针</h3><p>探针（probe）是由 kubelet 对容器执行的定期诊断。 要执行诊断，kubelet 调用由容器实现的 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#handler-v1-core">Handler</a> （处理程序）。有三种类型的处理程序：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#execaction-v1-core">ExecAction</a>： 在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#tcpsocketaction-v1-core">TCPSocketAction</a>： 对容器的 IP 地址上的指定端口执行 TCP 检查。如果端口打开，则诊断被认为是成功的。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#httpgetaction-v1-core">HTTPGetAction</a>： 对容器的 IP 地址上指定端口和路径执行 HTTP Get 请求。如果响应的状态码大于等于 200 且小于 400，则诊断被认为是成功的。</li>
</ul>
<p>每次探测都将获得以下三种结果之一：</p>
<ul>
<li><code>Success</code>（成功）：容器通过了诊断。</li>
<li><code>Failure</code>（失败）：容器未通过诊断。</li>
<li><code>Unknown</code>（未知）：诊断失败，因此不会采取任何行动。</li>
</ul>
<p>探针可以分为以下三种：</p>
<ul>
<li><code>livenessProbe</code>：指示容器是否正在运行。如果存活态探测失败，则 kubelet 会杀死容器， 并且容器将根据其<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">重启策略</a>决定未来。如果容器不提供存活探针， 则默认状态为 <code>Success</code>。</li>
<li><code>readinessProbe</code>：指示容器是否准备好为请求提供服务。如果就绪态探测失败， 端点控制器将从与 Pod 匹配的所有服务的端点列表中删除该 Pod 的 IP 地址。 初始延迟之前的就绪态的状态值默认为 <code>Failure</code>。 如果容器不提供就绪态探针，则默认状态为 <code>Success</code>。</li>
<li><code>startupProbe</code>: 指示容器中的应用是否已经启动。如果提供了启动探针，则所有其他探针都会被禁用，直到此探针成功为止。如果启动探测失败，<code>kubelet</code> 将杀死容器，而容器依其<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">重启策略</a>进行重启。 如果容器没有提供启动探测，则默认状态为 <code>Success</code>。</li>
</ul>
<h4 id="3-4-1-readinessProbe就绪检测"><a href="#3-4-1-readinessProbe就绪检测" class="headerlink" title="3.4.1 readinessProbe就绪检测"></a>3.4.1 readinessProbe就绪检测</h4><ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">readinessProbe.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readiness-httpget-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="comment"># 调用readinessProbe探针</span></span><br><span class="line">      <span class="attr">readinessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="comment"># 检查80端口</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="comment"># 检查该目录下的网页</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/test.html</span></span><br><span class="line">        <span class="comment"># 容器启动1秒后才进行检测</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># 每3秒检测一次</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f readinessProbe.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到虽然 Pod 运行了，但 ready 状态是不对的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/readinessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="readinessProbe探针测试一"></p>
<ol start="4">
<li>进入容器创建文件，问题即可解决</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it readiness-httpget-pod -- /bin/sh</span><br><span class="line">echo &#x27;this is test&#x27; &gt; /usr/share/nginx/html/test.html</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-livenessProbe存活检测"><a href="#3-4-2-livenessProbe存活检测" class="headerlink" title="3.4.2 livenessProbe存活检测"></a>3.4.2 livenessProbe存活检测</h4><p><strong>livenessProbe-exec</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_exec.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-exec-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;touch /tmp/test; sleep 60; rm -rf /tmp/test; sleep 3600&#x27;</span>]</span><br><span class="line">    <span class="comment"># 查看本地是否有镜像，有则使用，没有则下载</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;-e&#x27;</span>,<span class="string">&#x27;/tmp/test&#x27;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到当 test 文件给删除的时候，Pod 就会重启，重启后又会有 test 文件，一直循环下去</li>
</ol>
<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="livenessProbe探针测试一"></p>
<p><strong>livenessProbe-httpget</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_httpget.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-httpget-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># Pod生成1秒之后会每3秒检测一次是否存在index.html文件，如果超过10秒没有则重启Pod</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line">        <span class="comment"># 允许超时时间</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建容器，可以看到是在正常运行的</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe_httpget.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="livenessProbe探针测试三"></p>
<ol start="3">
<li>删除 index.html 文件，可以看到会执行重启</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it liveness-httpget-pod -- /bin/sh</span><br><span class="line">rm -rf /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E5%9B%9B.png" alt="livenessProbe探针测试四"></p>
<p><strong>livenessProbe-tcp</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_tcp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-tcp-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-tcp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod，会发现一直处于重启状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe_tcp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%BA%94.png" alt="livenessProbe探针测试五"></p>
<h4 id="3-4-3-Start-和-Stop"><a href="#3-4-3-Start-和-Stop" class="headerlink" title="3.4.3 Start 和 Stop"></a>3.4.3 Start 和 Stop</h4><p>Start 和 Stop 是指 Pod 在生成后执行和结束前执行的命令</p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">start_stop.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">start-stop-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start-stop-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo this is postStart test &gt; /usr/share/message&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo this is preStop test &gt; /usr/share/message&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod，进入 Pod 可以看到 Start 执行的命令，由于 Pod 停止后就没有了，所以看不到 Stop 执行的命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it start-stop-pod -- /bin/sh</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/start_stop%E6%B5%8B%E8%AF%95.png" alt="start_stop测试"></p>
<h2 id="四、k8s控制器"><a href="#四、k8s控制器" class="headerlink" title="四、k8s控制器"></a>四、k8s控制器</h2><h3 id="4-1-什么是控制器"><a href="#4-1-什么是控制器" class="headerlink" title="4.1 什么是控制器"></a>4.1 什么是控制器</h3><p>k8s 中内置了很多 controller，用来控制 Pod 的具体状态和行为。</p>
<p>控制器的类型有：</p>
<ul>
<li>ReplicationController（已弃用） 和 ReplicaSet</li>
<li>Deployment</li>
<li>DaemonSet</li>
<li>StateFulSet</li>
<li>Job 和 CronJob</li>
<li>Horizontal Pod Autoscaling</li>
</ul>
<h3 id="4-2-RS-与-Deployment"><a href="#4-2-RS-与-Deployment" class="headerlink" title="4.2 RS 与 Deployment"></a>4.2 RS 与 Deployment</h3><p>k8s 管理 Pod 主要用到以下三个组件：</p>
<ul>
<li>Replication Controller（RC）：用来确保容器应用的副本数始终保持在用户定义的副本数，如果有容器异常退出，会自动创建新的 Pod 来代替，如果有异常多出的容器也会自动回收。</li>
<li>ReplicaSet（RS）：相比 RC 多了支持 selector，推荐使用 RS。</li>
<li>Deployment：用来管理 RS。</li>
</ul>
<p><strong>RS 单独使用</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">rs_test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># RS名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rs-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 设置副本数</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 设置标签</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">rs-test</span></span><br><span class="line">  <span class="comment"># 设置模板，会根据此模板生成Pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># 与上边RS设置的标签相对应，说明根据该模板创建的Pod都由标签相对RS管理</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">rs-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rs-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 RS，可以看到会根据 <code>replicas</code>设置的数量创建 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f rs_test.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RS%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="RS测试一"></p>
<ol start="3">
<li>删除这些 Pod，RS 也会按照副本数重新建立新的 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod --all</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RS%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="RS测试二"></p>
<p><strong>RS 与 Deployment</strong></p>
<p><img src="/2024/02/18/kubernetes/Deployment%E5%92%8CRS.png" alt="Deployment和RS"></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="comment"># Deployment详细信息</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 副本数</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 选择标签</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 标签匹配，与Deployment对应</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="comment"># Pod模板</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># 定义标签</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-deployment-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment.yaml --record</span><br><span class="line">record:记录命令，方便每次 reversion 的变化</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到会生成对应的 RS 和 Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/deployment%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="deployment测试一"></p>
<ol start="4">
<li>扩容</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas 5</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>更新镜像</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment/nginx-deployment nginx-deployment-container=daocloud.io/library/nginx:1.19.1</span><br></pre></td></tr></table></figure>

<p>可以看到会创建一个新的 RS，以实现灰度更新</p>
<p><img src="/2024/02/18/kubernetes/deployment%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="deployment测试二"></p>
<ol start="6">
<li>回滚</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>查看回滚状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>查看历史版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout history deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>回到历史指定版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=1</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>暂停更新</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout pause deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<h3 id="4-3-DaemonSet"><a href="#4-3-DaemonSet" class="headerlink" title="4.3 DaemonSet"></a>4.3 DaemonSet</h3><p>DaemonSet 确保全部或者一部分 Node 上运行一个 Pod 的副本，当有 Node 加入集群时，也会为他们新增一个 Pod，当这些 Node 退出集群时，这些 Pod 也会被回收。</p>
<p>DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行 glusterd、ceph等。</li>
<li>运行日志收集daemon，例如fluentd、logstash等。</li>
<li>运行监控daemon，例如 Prometheus 的 Node exporter、zabbix等。</li>
</ul>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">daemonset_test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># DaemonSet名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">daemonset-test</span></span><br><span class="line">  <span class="comment"># 设置标签</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">daemonset-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 该标签要与上边标签一致</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">daemonset-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">daemonset-nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">daemonset-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 DaemonSet</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f daemonset_test.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/daemonset%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="daemonset测试一"></p>
<ol start="3">
<li>删除一个 Pod 之后 DaemonSet 为保证每个节点都至少有一个副本，就会重新创建新的 Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/daemonset%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="daemonset测试二"></p>
<h3 id="4-4-Job-和-CronJob"><a href="#4-4-Job-和-CronJob" class="headerlink" title="4.4 Job 和 CronJob"></a>4.4 Job 和 CronJob</h3><h4 id="4-4-1-Job"><a href="#4-4-1-Job" class="headerlink" title="4.4.1 Job"></a>4.4.1 Job</h4><p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束。</p>
<p><strong>Job spec</strong></p>
<ul>
<li><p><code>spec.template</code>格式同 Pod 相同</p>
</li>
<li><p><code>RestartPolicy</code>仅支持<code>Never</code>和<code>OnFailure</code></p>
</li>
<li><p>单个 Pod 时，默认 Pod 成功运行后 Job 即结束</p>
</li>
<li><p><code>spec.completions</code>标志 Job 结束时需要成功运行的 Pod 个数，默认为1</p>
</li>
<li><p><code>spec.parallelism</code>标志并行运行的 Pod 个数，默认为1</p>
</li>
<li><p><code>spec.activeDeadlineSeconds</code>标志失败 Pod 的重试最大时间，超过该时间就不会再重试</p>
</li>
</ul>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">job.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">job-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="comment"># 通过perl语言进行圆周率计算，计算小数点后2000位</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;perl&#x27;</span>,<span class="string">&#x27;-Mbignum=bpi&#x27;</span>,<span class="string">&#x27;-wle&#x27;</span>,<span class="string">&#x27;print bpi(2000)&#x27;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Job，可以看到开始是 Running，接着就是 Completed，代表 Job 已经完成</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f job.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/job%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="job测试一"></p>
<ol start="3">
<li>查看日志可以看到计算好的圆周率</li>
</ol>
<p><img src="/2024/02/18/kubernetes/job%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="job测试二"></p>
<h4 id="4-4-2-CronJob"><a href="#4-4-2-CronJob" class="headerlink" title="4.4.2 CronJob"></a>4.4.2 CronJob</h4><p>Cron Job 是基于时间管理控制 Job，即在给定的时间只运行一次、周期性的在指定时间运行。</p>
<p><strong>CronJob spec</strong></p>
<ul>
<li>所有 CronJob 的 <code>schedule:</code> 时间都是基于 kube-controller-manager 的时区。</li>
<li><code>.spec.schedule</code> 是 <code>.spec</code> 需要的域。它使用了 Cron 格式串，例如 <code>0 * * * *</code> or <code>@hourly</code> ，做为它的任务被创建和执行的调度时间。</li>
<li><code>.spec.jobTemplate</code>是任务的模版，是必须项。</li>
<li><code>.spec.startingDeadlineSeconds</code> 域是可选项。它表示任务如果由于某种原因错过了调度时间，开始该任务的截止时间的秒数。过了截止时间，CronJob 就不会开始任务。 不满足这种最后期限的任务会被统计为失败任务。如果该域没有声明，那任务就没有最后期限。</li>
<li><code>.spec.suspend</code>域也是可选的。如果设置为 <code>true</code> ，后续发生的执行都会挂起。 这个设置对已经开始的执行不起作用。默认是关闭的。</li>
<li><code>.spec.successfulJobsHistoryLimit</code> 和 <code>.spec.failedJobsHistoryLimit</code>是可选的。 这两个字段指定应保留多少已完成和失败的任务。 默认设置为3和1。限制设置为0代表相应类型的任务完成后不会保留。</li>
</ul>
<p><strong>并发性规则</strong></p>
<p><code>.spec.concurrencyPolicy</code>声明了 CronJob 创建的任务执行时发生重叠如何处理。 spec 仅能声明下列规则中的一种：</p>
<ul>
<li><code>Allow</code> (默认)：CronJob 允许并发任务执行。</li>
<li><code>Forbid</code>： CronJob 不允许并发任务执行；如果新任务的执行时间到了而老任务没有执行完，CronJob 会忽略新任务的执行。</li>
<li><code>Replace</code>：如果新任务的执行时间到了而老任务没有执行完，CronJob 会用新任务替换当前正在运行的任务。</li>
</ul>
<p>并发性规则仅适用于相同 CronJob 创建的任务。如果有多个 CronJob，它们相应的任务总是允许并发执行的。</p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">crontjob.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cronjob</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># CronJob必要字段，格式为分时日月周</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="comment"># job模板</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">crontab-pod</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">&#x27;Welcome My K8s&#x27;</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 CronJob，可以看到每分钟都会创建一个 Job 和 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cronjob.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/cronjob%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="cronjob测试一"></p>
<p><img src="/2024/02/18/kubernetes/cronjob%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="cronjob测试二"></p>
<h2 id="五、Service"><a href="#五、Service" class="headerlink" title="五、Service"></a>五、Service</h2><h3 id="5-1-什么是Service"><a href="#5-1-什么是Service" class="headerlink" title="5.1 什么是Service"></a>5.1 什么是Service</h3><p><img src="/2024/02/18/kubernetes/Service%E4%B8%80.png" alt="Service一"></p>
<p>到这里我们都知道，Deployment 会根据 <code>replicas</code>保证 Pod 的数量，当上图的其中一个 php-fpm Pod 出现问题时，就会新建一个来代替。但这时候会会出现一个问题，新的 Pod 的地址与旧的很可能不一样，那 nginx 也无法连接到新的 Pod，除非修改 nginx 的配置，这样的 k8s 集群效率是非常低的。</p>
<p>Service 就能解决该问题，在 nginx 和 php-fpm 中间添加一个 Service，由该 Service 来管理各 php-fpm Pod 的信息，每个 Pod 会设置一个标签，只要与 SVC 中设置的标签相匹配，就可以进行管理，其它 Pod（例如下图的 nginx）想要访问该 SVC 管理的 Pod，只要通过 SVC 的地址就可以访问到。</p>
<p>Service 定义了这样一种抽象：逻辑上的一组 Pod，一种可以访问它们的策略 —— 通常称为微服务。</p>
<p><img src="/2024/02/18/kubernetes/Service%E4%BA%8C.png" alt="Service二"></p>
<h3 id="5-2-Service发布服务（服务类型"><a href="#5-2-Service发布服务（服务类型" class="headerlink" title="5.2 Service发布服务（服务类型)"></a>5.2 Service发布服务（服务类型)</h3><p>对一些应用的某些部分（如前端），可能希望将其暴露给 Kubernetes 集群外部 的 IP 地址。</p>
<p>Kubernetes <code>ServiceTypes</code> 允许指定你所需要的 Service 类型，默认是 <code>ClusterIP</code>。</p>
<p><code>Type</code> 的取值以及行为如下：</p>
<ul>
<li><code>ClusterIP</code>：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是默认的 <code>ServiceType</code>。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#nodeport"><code>NodePort</code></a>：通过每个节点上的 IP 和静态端口（<code>NodePort</code>）暴露服务。 <code>NodePort</code> 服务会路由到自动创建的 <code>ClusterIP</code> 服务。 通过请求 <code>&lt;节点 IP&gt;:&lt;节点端口&gt;</code>，你可以从集群的外部访问一个 <code>NodePort</code> 服务。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer"><code>LoadBalancer</code></a>：使用云提供商的负载均衡器向外部暴露服务。 外部负载均衡器可以将流量路由到自动创建的 <code>NodePort</code> 服务和 <code>ClusterIP</code> 服务上。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#externalname"><code>ExternalName</code></a>：通过返回 <code>CNAME</code> 和对应值，可以将服务映射到 <code>externalName</code> 字段的内容（例如，<code>foo.bar.example.com</code>）。 无需创建任何类型代理。</li>
</ul>
<p><strong>ClusterIP</strong></p>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E7%B1%BB%E5%9E%8B.png" alt="ClusterIP类型"></p>
<p><strong>NodePort</strong></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E7%B1%BB%E5%9E%8B.png" alt="NodePort类型"></p>
<p><strong>LoadBalancer</strong></p>
<p><img src="/2024/02/18/kubernetes/LoadBalancer%E7%B1%BB%E5%9E%8B.png" alt="LoadBalancer类型"></p>
<p><strong>ExternalName</strong></p>
<p><img src="/2024/02/18/kubernetes/ExternalName%E7%B1%BB%E5%9E%8B.png" alt="ExternalName类型"></p>
<h3 id="5-3-虚拟-IP-和-Service-代理"><a href="#5-3-虚拟-IP-和-Service-代理" class="headerlink" title="5.3 虚拟 IP 和 Service 代理"></a>5.3 虚拟 IP 和 Service 代理</h3><p>在 Kubernetes 集群中，每个 Node 运行一个 <code>kube-proxy</code> 进程。 <code>kube-proxy</code> 负责为 Service 实现了一种 VIP（虚拟 IP）的形式，而不是 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#externalname"><code>ExternalName</code></a> 的形式。</p>
<p><strong>代理模式分类：</strong></p>
<p><strong>userspace 代理模式</strong></p>
<p>在该模式下，所有操作都要通过 kube-proxy 进行一个代理的操作，kube-proxy 的压力相对会较大。</p>
<p><img src="/2024/02/18/kubernetes/userspace%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="userspace代理模式"></p>
<p><strong>iptables 代理模式</strong></p>
<p>在该模式下，所有的访问都通过 iptables 来处理，kube-proxy 的压力就会减小很多。</p>
<p><img src="/2024/02/18/kubernetes/iptables%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="iptables代理模式"></p>
<p><strong>IPVS 代理模式</strong></p>
<p>在该模式下，iptables 换成了 IPVS，通过内核模块来实现负载均衡。</p>
<p>在 <code>ipvs</code> 模式下，kube-proxy 监视 Kubernetes 服务和端点，调用 <code>netlink</code> 接口相应地创建 IPVS 规则， 并定期将 IPVS 规则与 Kubernetes 服务和端点同步。 该控制循环可确保 IPVS 状态与所需状态匹配。访问服务时，IPVS 将流量定向到后端Pod之一。</p>
<p>IPVS代理模式基于类似于 iptables 模式的 netfilter 挂钩函数， 但是使用哈希表作为基础数据结构，并且在内核空间中工作。 这意味着，与 iptables 模式下的 kube-proxy 相比，IPVS 模式下的 kube-proxy 重定向通信的延迟要短，并且在同步代理规则时具有更好的性能。 与其他代理模式相比，IPVS 模式还支持更高的网络流量吞吐量。</p>
<p>IPVS 提供了更多选项来平衡后端 Pod 的流量。 这些是：</p>
<ul>
<li><code>rr</code>：轮替（Round-Robin）</li>
<li><code>lc</code>：最少链接（Least Connection），即打开链接数量最少者优先</li>
<li><code>dh</code>：目标地址哈希（Destination Hashing）</li>
<li><code>sh</code>：源地址哈希（Source Hashing）</li>
<li><code>sed</code>：最短预期延迟（Shortest Expected Delay）</li>
<li><code>nq</code>：从不排队（Never Queue）</li>
</ul>
<p>注意：当 kube-proxy 以 IPVS 代理模式启动时，它将验证 IPVS 内核模块是否可用。 如果未检测到 IPVS 内核模块，则 kube-proxy 将退回到以 iptables 代理模式运行。</p>
<p><img src="/2024/02/18/kubernetes/IPVS%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="IPVS代理模式"></p>
<h3 id="5-4-ClusterIP"><a href="#5-4-ClusterIP" class="headerlink" title="5.4 ClusterIP"></a>5.4 ClusterIP</h3><p>ClusterIP 主要在每个 Node 节点使用 iptables &#x2F; IPVS，将发向 ClusterIP 对应端口的数据，转发到 kube-proxy 中，kube-proxy 内部可以实现负载均衡，并可以查询到该 Service 下对应 Pod 的地址和端口，进而把数据转发给对应的 Pod 的地址和端口。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建 Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_svc_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 创建两个标签</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="comment"># 释放的端口</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 Service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">clusterip_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-clusterip-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># 用来匹配Pod中的标签，全部匹配才会管理该Pod</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到 Deployment 和 SVC 都已经创建成功，且直接访问 SVC 的 ClusterIP 地址就可以访问到 Pod 了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="ClusterIP测试一"></p>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="ClusterIP测试二"></p>
<ol start="4">
<li>测试负载均衡，在各容器内部创建一个 html 页面</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-deployment-*** -- /bin/bash</span><br><span class="line">echo &#x27;this is node01-pod01&#x27; &gt; /usr/share/nginx/html/pod.html</span><br><span class="line">echo &#x27;this is node02-pod01&#x27; &gt; /usr/share/nginx/html/pod.html</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>可以看到是实现了负载均衡的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="ClusterIP测试三"></p>
<h3 id="5-5-无头服务（Headless-Services）"><a href="#5-5-无头服务（Headless-Services）" class="headerlink" title="5.5 无头服务（Headless Services）"></a>5.5 无头服务（Headless Services）</h3><p>有时不需要或不想要负载均衡，以及单独的 Service IP。 遇到这种情况，可以通过指定 Cluster IP（<code>spec.clusterIP</code>）的值为 <code>&quot;None&quot;</code> 来创建 <code>Headless</code> Service。</p>
<p>可以使用无头 Service 与其他服务发现机制进行接口，而不必与 Kubernetes 的实现捆绑在一起。</p>
<p>对这无头 Service 并不会分配 Cluster IP，kube-proxy 不会处理它们， 而且平台也不会为它们进行负载均衡和路由。 DNS 如何实现自动配置，依赖于 Service 是否定义了选择算符。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建 Headless Service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">headless_service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">headless-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>可以看到是没有分配 VIP 的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="无头服务测试一"></p>
<ol start="3">
<li>安装 bind-utils 工具来测试无头服务的作用，可以看到即使没有了 VIP，但依旧可以通过域名来访问到不同的 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">k8s内部使用dns访问格式：SVC名称.命名空间.svc.集群域(默认集群域为cluster.local)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dig命令可以用来获取域名的详细信息</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.244.0.37是其中一个coredns的地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-t A:显示A记录，A记录是将域名指向一个IPv4地址，即一个域名解析到一个IP地址</span></span><br><span class="line">dig -t A headless-service.default.svc.cluster.local @10.244.0.37</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="无头服务测试二"></p>
<h3 id="5-6-NodePort"><a href="#5-6-NodePort" class="headerlink" title="5.6 NodePort"></a>5.6 NodePort</h3><p>NodePort 的原理在于在 Node 上开放了一个端口，将该端口的流量导入到 kube-proxy 中，然后再由 kube-proxy 传送给不同的 Pod。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建 Service，这里的标签仍与上面 ClusterIP 中的 Deployment 创建的 Pod 相匹配</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nodeport_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-nodeport-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>可以看到会暴露一个端口，外部通过这个端口就可以访问到内部的 Pod，且是每一个 Node 都开启了这个端口，所以也可以实现负载均衡</li>
</ol>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="NodePort测试一"></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="NodePort测试一"></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="NodePort测试三"></p>
<ol start="3">
<li>在 iptables &#x2F; IPVS 规则中可以看到开启该端口的规则</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -nvl | grep 31419</span><br><span class="line">ipvsadm -Ln | grep 31419</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E5%9B%9B.png" alt="NodePort测试四"></p>
<h3 id="5-7-LoadBalancer"><a href="#5-7-LoadBalancer" class="headerlink" title="5.7 LoadBalancer"></a>5.7 LoadBalancer</h3><p>LoadBalancer 就是在 NodePort 的基础上，通过 LAAS 来实现负载均衡，用户指要访问 LAAS即可，LAAS 会将请求通过调度转发给不同的 Node。</p>
<h3 id="5-8-ExternalName"><a href="#5-8-ExternalName" class="headerlink" title="5.8 ExternalName"></a>5.8 ExternalName</h3><p>ExternalName 通过返回 CNAME 和它的值，将服务映射到 ExternalName 字段的内容，ExternalName 没有 selector，也没有端口的设置，对于运行在集群之外的服务，ExternalName 是通过该外部服务的别名来提供服务的。</p>
<p>当这个 Service 创建成功时，就会有 <code>externalname-service.default.svc.cluster.local</code> 的 fqdn 被创建，如果有用户访问到这个 fqdn，就会被改写成 <code>my.database.example.com</code>，这就是 DNS 内部的一个 CNAME 记录，也就是别名记录。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建测试用的 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">curl-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">curl-pod-container</span></span><br><span class="line">    <span class="comment"># curl镜像包含测试网络和DNS的工具</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/appropriate/curl</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;curl test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 ExternalName</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">externalname-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">externalname</span></span><br><span class="line">  <span class="comment"># 引入百度的网址</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">www.baidu.com</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入 Pod 内部测试可以看到，通过 nslookup 可以解析到百度的地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nolookup SVC名称.命名空间.svc.集群域</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/externalname%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="externalname测试一"></p>
<h3 id="5-9-ingress"><a href="#5-9-ingress" class="headerlink" title="5.9 ingress"></a>5.9 ingress</h3><h4 id="5-9-1-什么是ingress"><a href="#5-9-1-什么是ingress" class="headerlink" title="5.9.1 什么是ingress"></a>5.9.1 什么是ingress</h4><p>ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。</p>
<p>ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p>
<p>ingress 由两部分构成：</p>
<ul>
<li>ingress controller：将新加入的 ingress 转化成 Nginx 的配置文件并使之生效。</li>
<li>ingress 服务：将 Nginx 的配置抽象成一个 ingress 对象，每添加一个新的服务只需写一个新的 ingress 的 yaml 文件即可。</li>
</ul>
<p>ingress controller 主要有两种，<code>nginx-ingress</code>和<code>traefik-ingress</code>，这里主要讲<code>nginx-ingress</code>。</p>
<p>ingress 官方网址：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/nginx-ingress">https://kubernetes.github.io/nginx-ingress</a></p>
<p>ingress GitHub 网址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/nginx-ingress">https://github.com/kubernetes/nginx-ingress</a></p>
<p><strong>nginx-ingress功能</strong></p>
<p><code>nginx-ingress</code>主要负责向外暴露服务，同时提供负载均衡的功能。</p>
<p>Nginx 对后端运行的服务（Service1、Service2）提供反向代理，在配置文件中配置了域名与后端服务 Endpoints 的对应关系。客户端通过使用 DNS 服务或者直接配置本地的 hosts 文件，将域名都映射到 Nginx 代理服务器。当客户端访问 service1.com 时，浏览器会把包含域名的请求发送给 Nginx 服务器，Nginx 服务器根据传来的域名，选择对应的 Service，这里就是选择 Service1 后端服务，然后根据一定的负载均衡策略，选择 Service1 中的某个容器接收来自客户端的请求并作出响应。过程很简单，Nginx 在整个过程中仿佛是一台根据域名进行请求转发的“路由器”。</p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%80.png" alt="nginx-ingress一"></p>
<p><strong>nginx-ingress工作过程</strong></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%BA%8C.png" alt="nginx-ingress二"></p>
<p><code>nginx-ingress</code>模块在运行时主要分为三个主体：</p>
<ul>
<li>Store：Store 会与 APIServer 以协程的 Pod 方式进行一个监听状态，发生新的事件会写入循环队列里。</li>
<li>NginxController：NginxController 会监听循环队列里的事件，发生一个循环就会更新一个事件，并写入 SyncQueue 里。</li>
<li>SyncQueue：SyncQueue 协程会定期拉取需要执行的任务（如果有必要的则直接从 Store 拉取过来进行修改），接着判断是否需要 reload nginx，最后会以 nginx 模块运行。</li>
</ul>
<h4 id="5-9-2-ingress规则"><a href="#5-9-2-ingress规则" class="headerlink" title="5.9.2 ingress规则"></a>5.9.2 ingress规则</h4><p>每个 HTTP 规则都包含以下信息：</p>
<ul>
<li>可选的 <code>host</code>。在此示例中，未指定 <code>host</code>，因此该规则适用于通过指定 IP 地址的所有入站 HTTP 通信。 如果提供了 <code>host</code>（例如 <a target="_blank" rel="noopener" href="http://www.cqm.com),则/">www.cqm.com），则</a> <code>rules</code> 适用于该 <code>host</code>。</li>
<li>路径列表 paths（例如，<code>/testpath</code>）,每个路径都有一个由 <code>serviceName</code> 和 <code>servicePort</code> 定义的关联后端。 在负载均衡器将流量定向到引用的服务之前，主机和路径都必须匹配传入请求的内容。</li>
<li><code>backend</code>（后端）是 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">Service 文档</a> 中所述的服务和端口名称的组合。 与规则的 <code>host</code> 和 <code>path</code> 匹配的对 Ingress 的 HTTP（和 HTTPS ）请求将发送到列出的 <code>backend</code>。</li>
</ul>
<p><strong>路径类型</strong></p>
<p>Ingress 中的每个路径都需要有对应的路径类型（Path Type）。未明确设置 <code>pathType</code> 的路径无法通过合法性检查。当前支持的路径类型有三种：</p>
<ul>
<li><code>ImplementationSpecific</code>：对于这种路径类型，匹配方法取决于 IngressClass。 具体实现可以将其作为单独的 <code>pathType</code> 处理或者与 <code>Prefix</code> 或 <code>Exact</code> 类型作相同处理。</li>
<li><code>Exact</code>：精确匹配 URL 路径，且区分大小写。</li>
<li><code>Prefix</code>：基于以 <code>/</code> 分隔的 URL 路径前缀匹配。匹配区分大小写，并且对路径中的元素逐个完成。 路径元素指的是由 <code>/</code> 分隔符分隔的路径中的标签列表。 如果每个 <em>p</em> 都是请求路径 <em>p</em> 的元素前缀，则请求与路径 <em>p</em> 匹配。</li>
</ul>
<h4 id="5-9-3-部署nginx-ingress"><a href="#5-9-3-部署nginx-ingress" class="headerlink" title="5.9.3 部署nginx-ingress"></a>5.9.3 部署nginx-ingress</h4><ol>
<li>通过 Bare-metal（NodePort） 方式部署，先下载 yaml 文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">地址一</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.46.0/deploy/static/provider/baremetal/deploy.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">地址二</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/baremetal/deploy.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于镜像地址也在国外，所以通过国内镜像源拉取</span></span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/nginx-ingress-controller:v0.46.0</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/nginx-ingress-controller:v0.46.0 k8s.gcr.io/ingress-nginx/controller:v0.46.0</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取镜像地址，下载好需要的镜像，并导入镜像到其它 node 上</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%89.png" alt="nginx-ingress三"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%9B%9B.png" alt="nginx-ingress四"></p>
<ol start="3">
<li>通过 deploy.yaml 文件生成 svc</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deploy.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%BA%94.png" alt="nginx-ingress五"></p>
<h4 id="5-9-4-ingress-HTTP代理访问"><a href="#5-9-4-ingress-HTTP代理访问" class="headerlink" title="5.9.4 ingress HTTP代理访问"></a>5.9.4 ingress HTTP代理访问</h4><p> <img src="/2024/02/18/kubernetes/nginx-ingress%E5%85%AD.png" alt="nginx-ingress六"></p>
<p><code>ingress-nginx</code>会根据配置好的 yaml 文件，自动配置 nginx.conf 和虚拟主机文件。</p>
<ol>
<li>创建 deployment1、deployment2、service1、service2</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx2</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 nginx-ingress1、nginx-ingress2</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># 设置虚拟主机，通过该域名访问</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm1.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="comment"># 路径列表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="comment"># 路径类型</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="comment"># 后端</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="comment"># 指定连接哪个SVC</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm2.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment_svc1.yaml</span><br><span class="line">kubectl create -f nginx_deployment_svc2.yaml</span><br><span class="line">kubectl create -f nginx_ingress.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>给每个 Pod 写入信息，方便查看负载均衡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-deployment-... -- /bin/bash</span><br><span class="line">echo &#x27;this is nginx-pod-1&#x27; &gt; /usr/share/nginx/html/pod.html</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>查看 ingress-nginx 所创建的 svc 暴露的端口，以及 service1、service2、nginx-ingress1、nginx-ingress2</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl get ingress</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%83.png" alt="nginx-ingress七"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%85%AB.png" alt="nginx-ingress八"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B9%9D.png" alt="nginx-ingress九"></p>
<ol start="6">
<li>在 &#x2F;etc&#x2F;hosts 文件下写入域名与 IP 绑定，访问测试，可以看到实现了负载均衡</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81.png" alt="nginx-ingress十"></p>
<ol start="7">
<li>可以进入 ingress 控制器内部查看 nginx 配置，可以看到自动添加的代理配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it -n ingress-nginx ingress-nginx-controller-... -- /bin/bash</span><br><span class="line">cat nginx.conf</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%80.png" alt="nginx-ingress十一"></p>
<h4 id="5-9-5-ingress-HTTPS代理访问"><a href="#5-9-5-ingress-HTTPS代理访问" class="headerlink" title="5.9.5 ingress HTTPS代理访问"></a>5.9.5 ingress HTTPS代理访问</h4><p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%BA%8C.png" alt="nginx-ingress十二"></p>
<ol>
<li>创建私钥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=nginxsvc/O=nginxsvc&quot;</span><br><span class="line">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 deployment3、service3、nginx-ingress3</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc3.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx3</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">www.cqm3.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm3.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service3</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment_svc3.yaml nginx_ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%89.png" alt="nginx-ingress十三"></p>
<ol start="5">
<li>在每个 Pod 写入 pod.html，便于查看负载均衡效果，并测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it ingress-nginx-... -- /bin/bash</span><br><span class="line">echo &#x27;this is node01-pod&#x27; &gt; /usr/share/nginx/html/pod.html</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%9B%9B.png" alt="nginx-ingress十四"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%BA%94.png" alt="nginx-ingress十五"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%85%AD.png" alt="nginx-ingress十六"></p>
<h4 id="5-9-5-Nginx进行基础认证（BasicAuth）"><a href="#5-9-5-Nginx进行基础认证（BasicAuth）" class="headerlink" title="5.9.5 Nginx进行基础认证（BasicAuth）"></a>5.9.5 Nginx进行基础认证（BasicAuth）</h4><ol>
<li>通过 Apache 创建用户认证文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">htpasswd -c auth cqm</span><br><span class="line">kubectl create secret generic basic-auth --from-file=auth</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 ingress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-auth</span></span><br><span class="line">  <span class="comment"># 添加基础认证字段</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required - cqm&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.cqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="comment"># 这里使用HTTP代理实验的service1</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建 ingress 后测试</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%83.png" alt="nginx-ingress十七"></p>
<h4 id="5-9-6-Nginx重写"><a href="#5-9-6-Nginx重写" class="headerlink" title="5.9.6  Nginx重写"></a>5.9.6  Nginx重写</h4><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;rewrite-target</td>
<td>必须重定向流量的目标 URI</td>
<td>string</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-redirect</td>
<td>指示位置部分是否仅可访问 SSL（当 Ingress 包含证书时默认为 True）</td>
<td>bool</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;force-ssl-redirect</td>
<td>即使 Ingress 未启用 TLS，也强制重定向到 HTTPS</td>
<td>bool</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;app-root</td>
<td>定义控制器必须重定向的应用程序根，如果它在“&#x2F;”上下文中</td>
<td>string</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;use-regex</td>
<td>指示 Ingress 上定义的路径是否使用正则表达式</td>
<td>bool</td>
</tr>
</tbody></table>
<ol>
<li>先准备好转发后的 deployment、ingress等，这里用上边的 ingress1，用户访问 <a target="_blank" rel="noopener" href="http://www.rewritecqm.com/">www.rewritecqm.com</a> 时就跳转到 <a target="_blank" rel="noopener" href="http://www.cqm1.com/">www.cqm1.com</a></li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%85%AB.png" alt="nginx-ingress十八"></p>
<ol start="2">
<li>编写重写 ingress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">rewrite_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rewrite-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 访问 www.rewritecqm.com:30779 将跳转到 http://www.cqm1.com:30779/pod.html</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">http://www.cqm1.com:30779/pod.html</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.rewritecqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B9%9D.png" alt="nginx-ingress十九"></p>
<h2 id="六、k8s存储"><a href="#六、k8s存储" class="headerlink" title="六、k8s存储"></a>六、k8s存储</h2><h3 id="6-1-配置存储卷"><a href="#6-1-配置存储卷" class="headerlink" title="6.1 配置存储卷"></a>6.1 配置存储卷</h3><p>配置存储卷并不是用来进行容器间相互交互或 Pod 间数据共享的，而是用于向各个 Pod 注入配置信息的，主要分为以下三种：</p>
<p>ConfigMap：可传递普通信息</p>
<p>Secret：可传递密码等敏感的配置信息</p>
<p>DownwardAPI：可传递 Pod 和容器自身的运行信息</p>
<h4 id="6-1-1-ConfigMap"><a href="#6-1-1-ConfigMap" class="headerlink" title="6.1.1 ConfigMap"></a>6.1.1 ConfigMap</h4><p>许多应用程序都会从配置文件、命令行参数或环境变量中读取配置信息。</p>
<p>ConfigMap API 给我们提供了向容器内部注入信息的机制，ConfigMap 可以被用来保存单个属性，也可以用来保存整个配置文件或者 JSON 二进制对象。</p>
<p>ConfigMap 的创建方式有三种，分别为基于目录、文件和字面值来创建。</p>
<p><strong>基于目录创建 ConfigMap</strong></p>
<ol>
<li>创建指定目录，下载官方测试文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/k8s/plugin/configmap/dir || cd /root/k8s/plugin/configmap/dir</span><br><span class="line">wget https://kubernetes.io/examples/configmap/game.properties</span><br><span class="line">wget https://kubernetes.io/examples/configmap/ui.properties</span><br><span class="line">kubectl create configmap configmap1 --from-file=./</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe cm configmap1</span><br><span class="line">kubectl get cm configmap1 -o yaml</span><br></pre></td></tr></table></figure>

<p><strong>基于文件创建 ConfigMap</strong></p>
<ol>
<li>通过 game.properties 和 ui.properties 创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap configmap2 --from-file=game.properties --from-file=ui.properties</span><br></pre></td></tr></table></figure>

<p><strong>基于字面值创建 ConfigMap</strong></p>
<ol>
<li>通过<code>--from-literal=键名=键值</code>来创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap configmap3 --from-literal=special.how=very</span><br></pre></td></tr></table></figure>

<h5 id="6-1-1-1-Pod中使用ConfigMap"><a href="#6-1-1-1-Pod中使用ConfigMap" class="headerlink" title="6.1.1.1 Pod中使用ConfigMap"></a>6.1.1.1 Pod中使用ConfigMap</h5><p><strong>使用 ConfigMap 代替环境变量</strong></p>
<ol>
<li>创建两个 ConfigMap</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">special_cm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">special.how:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">special.type:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">env_cm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将这两个 ConfigMap 注入到 Pod中</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod1-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span>]</span><br><span class="line">      <span class="comment"># env:取某个 ConfigMap 中的某个键值</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_HOW_KEY</span></span><br><span class="line">          <span class="comment"># 定义环境变量</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="comment"># 表示从 ConfigMap 中引用</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="comment"># 要引用的 ConfigMap 名称</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="comment"># 引用 ConfigMap 中的哪个键值对</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">      <span class="comment"># envFrom:取某个 ConfigMap 的所有键值</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>生成 Pod 后查看日志，可以看到注入成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs pod1</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%B8%80.png" alt="ConfigMap一"></p>
<p><strong>使用 ConfigMap 设置命令行参数</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod2-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo $(SPECIAL_HOW_KEY) $(SPECIAL_TYPE_KEY)&quot;</span>]</span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_HOW_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p><strong>将 ConfigMap 数据添加到一个卷中</strong></p>
<ol>
<li>创建 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod3.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod3-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 1200&quot;</span> ]</span><br><span class="line">      <span class="comment"># 挂载config-volume，挂载在/etc/config目录下</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="comment"># 创建一个卷，将special-cm内容写入config-volume卷</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 Pod，在挂载目录下查看是否写入到 config 文件里</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%BA%8C.png" alt="ConfigMap二"></p>
<h5 id="6-1-1-2-ConfigMap热更新"><a href="#6-1-1-2-ConfigMap热更新" class="headerlink" title="6.1.1.2 ConfigMap热更新"></a>6.1.1.2 ConfigMap热更新</h5><p>本例子通过 ConfigMap 来实现热更新，可以实现热更新 nginx.conf，但需进入容器内部重载配置文件，所以通过热更新一个 html 来展示效果。</p>
<ol>
<li>编写 yaml 文件，并创建</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">hotupdate.yaml</span></span><br><span class="line"><span class="comment"># ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-hotupdate-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">test.html:</span> <span class="string">&#x27;this is the fist test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># 挂载下边创建的volume</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-html-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="comment"># 创建一个volume，通过ConfigMap方式挂载，使用上面创建的nginx-hotupdate-cm</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-html-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-hotupdate-cm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hotupdate.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试是否能够访问到</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%B8%89.png" alt="ConfigMap三"></p>
<ol start="3">
<li>修改 ConfigMap，并再次访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm nginx-hotupdate-cm</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/ConfigMap%E5%9B%9B.png" alt="ConfigMap四"></p>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%BA%94.png" alt="ConfigMap五"></p>
<h4 id="6-1-2-Secret"><a href="#6-1-2-Secret" class="headerlink" title="6.1.2 Secret"></a>6.1.2 Secret</h4><p><code>Secret</code> 对象类型用来保存敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 将这些信息放在 <code>secret</code> 中比放在 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 的定义或者 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-image">容器镜像</a> 中来说更加安全和灵活。</p>
<p><strong>Secret 的类型</strong></p>
<table>
<thead>
<tr>
<th>内置类型</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td><code>Opaque</code></td>
<td>用户定义的任意数据</td>
</tr>
<tr>
<td><code>kubernetes.io/service-account-token</code></td>
<td>服务账号令牌</td>
</tr>
<tr>
<td><code>kubernetes.io/dockercfg</code></td>
<td><code>~/.dockercfg</code> 文件的序列化形式</td>
</tr>
<tr>
<td><code>kubernetes.io/dockerconfigjson</code></td>
<td><code>~/.docker/config.json</code> 文件的序列化形式</td>
</tr>
<tr>
<td><code>kubernetes.io/basic-auth</code></td>
<td>用于基本身份认证的凭据</td>
</tr>
<tr>
<td><code>kubernetes.io/ssh-auth</code></td>
<td>用于 SSH 身份认证的凭据</td>
</tr>
<tr>
<td><code>kubernetes.io/tls</code></td>
<td>用于 TLS 客户端或者服务器端的数据</td>
</tr>
<tr>
<td><code>bootstrap.kubernetes.io/token</code></td>
<td>启动引导令牌数据</td>
</tr>
</tbody></table>
<h5 id="6-1-2-1-Opaque"><a href="#6-1-2-1-Opaque" class="headerlink" title="6.1.2.1 Opaque"></a>6.1.2.1 Opaque</h5><p>Opaque 使用base64编码存储信息，可以通过 <code>base64 --decode</code> 解码获得原始数据，因此安全性弱。</p>
<p>使用示例</p>
<ol>
<li>生成 base64 编码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;admin&#x27; | base64</span><br><span class="line">YWRtaW4K</span><br><span class="line">echo &#x27;12345&#x27; | base64</span><br><span class="line">MTIzNDUK</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4K</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIzNDUK</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f opaque.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>挂载到 volume 中使用，查看测试可以看到挂载后的信息被解码了</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque-pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opaque-pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opaque-pod1-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="comment"># 挂载下边创建的volume-opaque</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-opaque</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/secrets</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># 创建一个secret类型的volume，引用上边创建好的secret-opaque</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-opaque</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">secret-opaque</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%B8%80.png" alt="secret一"></p>
<ol start="4">
<li>导入到环境变量中并测试</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque-pod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opaque-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">opaque-pod2</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opaque-pod2-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># 将secret导入环境变量中</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># 命名变量</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER</span></span><br><span class="line">          <span class="comment"># 引用secret-opaque中的username的键值</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PASSWORD</span></span><br><span class="line">          <span class="comment"># 引用secret-opaque中的password的键值</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%BA%8C.png" alt="secret二"></p>
<h5 id="6-1-2-2-ImagePullSecret"><a href="#6-1-2-2-ImagePullSecret" class="headerlink" title="6.1.2.2 ImagePullSecret"></a>6.1.2.2 ImagePullSecret</h5><p>可以使用下面两种 <code>type</code> 值之一来创建 Secret，用以存放访问 Docker 仓库来下载镜像的凭据。</p>
<ul>
<li><code>kubernetes.io/dockercfg</code></li>
<li><code>kubernetes.io/dockerconfigjson</code></li>
</ul>
<p><code>kubernetes.io/dockerconfigjson</code> 创建 Secret 示例</p>
<ol>
<li>创建 Secret</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry cqmregistry --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%B8%89.png" alt="secret三"></p>
<ol start="2">
<li>在 Pod 中运用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">  <span class="comment"># 调用创建好的Secret</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cqmregistry</span></span><br></pre></td></tr></table></figure>

<h5 id="6-1-2-3-Downward-API"><a href="#6-1-2-3-Downward-API" class="headerlink" title="6.1.2.3 Downward API"></a>6.1.2.3 Downward API</h5><p>有时候 Pod 需要获取自身的信息，这时候 Downward API 就派上用场了。</p>
<p>Downward API 是通过 fieldRef 参数获取信息的。</p>
<p><strong>示例一</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod1-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;EnvPodName:$&#123;EnvPodName&#125; EnvNodeName:$&#123;EnvNodeName&#125;&quot;, sleep 3600&#x27;</span> ]</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EnvPodName</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EnvNodeName</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br></pre></td></tr></table></figure>

<p><strong>示例二</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod2-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;EnvPodName:$&#123;EnvPodName&#125; EnvNodeName:$&#123;EnvNodeName&#125;&quot;, sleep 3600&#x27;</span> ]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">downwardAPI:</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;PodName&#x27;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;NodeName&#x27;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-本地存储卷"><a href="#6-2-本地存储卷" class="headerlink" title="6.2 本地存储卷"></a>6.2 本地存储卷</h3><p>Container 中的文件在磁盘上是临时存放的，这给 Container 中运行的较重要的应用程序带来一些问题。问题之一是当容器崩溃时文件丢失。kubelet 会重新启动容器， 但容器会以干净的状态重启。 第二个问题会在同一 <code>Pod</code> 中运行多个容器并共享文件时出现。 Kubernetes <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">Volume</a> 这一抽象概念能够解决这两个问题。</p>
<p>Kubernetes 支持很多类型的卷。 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 可以同时使用任意数目的卷类型。 临时卷类型的生命周期与 Pod 相同，但持久卷可以比 Pod 的存活期长。 当 Pod 不再存在时，Kubernetes 也会销毁临时卷；不过 Kubernetes 不会销毁持久卷。对于给定 Pod 中任何类型的卷，在容器重启期间数据都不会丢失。</p>
<p><img src="/2024/02/18/kubernetes/volume%E4%B8%80.png" alt="volume一"></p>
<p>卷的类型分为很多种，可通过官方文档查看：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">https://kubernetes.io/zh/docs/concepts/storage/volumes/</a></p>
<h4 id="6-2-1-emptyDir"><a href="#6-2-1-emptyDir" class="headerlink" title="6.2.1 emptyDir"></a>6.2.1 emptyDir</h4><p>当 Pod 分派到某个 Node 上时，<code>emptyDir</code> 卷会被创建，并且在 Pod 在该节点上运行期间，卷一直存在。 就像其名称表示的那样，卷最初是空的。 尽管 Pod 中的容器挂载 <code>emptyDir</code> 卷的路径可能相同也可能不同，这些容器都可以读写 <code>emptyDir</code> 卷中相同的文件。 当 Pod 因为某些原因被从节点上删除时，<code>emptyDir</code> 卷中的数据也会被永久删除。</p>
<p>需要注意的是，容器崩溃并不会导致 Pod 被从节点上移除，因此容器崩溃期间 <code>emptyDir</code> 卷中的数据是安全的。</p>
<p><code>emptyDir</code> 的一些用途：</p>
<ul>
<li>缓存空间，例如基于磁盘的归并排序。</li>
<li>为耗时较长的计算任务提供检查点，以便任务能方便地从崩溃前状态恢复执行。</li>
<li>在 Web 服务器容器服务数据时，保存内容管理器容器获取的文件。</li>
</ul>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">emptydir-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-container1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/empty1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-container2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 6000&#x27;</span>]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/empty2</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 Pod 中的不同容器查看是否共享同一个 volume，</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E4%BA%8C.png" alt="volume二"></p>
<p><img src="/2024/02/18/kubernetes/volume%E4%B8%89.png" alt="volume三"></p>
<h4 id="6-2-2-hostPath"><a href="#6-2-2-hostPath" class="headerlink" title="6.2.2 hostPath"></a>6.2.2 hostPath</h4><p><code>hostPath</code> 卷能将主机节点文件系统上的文件或目录挂载到你的 Pod 中，类似 docker 中的 volume 挂载。</p>
<p><code>hostPath</code> 的一些用法有：</p>
<ul>
<li>运行一个需要访问 Docker 内部机制的容器；可使用 <code>hostPath</code> 挂载 <code>/var/lib/docker</code> 路径。</li>
<li>在容器中运行 cAdvisor（容器监控工具） 时，以 <code>hostPath</code> 方式挂载 <code>/sys</code>。</li>
<li>允许 Pod 指定给定的 <code>hostPath</code> 在运行 Pod 之前是否应该存在，是否应该创建以及应该以什么方式存在。</li>
</ul>
<p>除了必需的 <code>path</code> 属性之外，用户可以选择性地为 <code>hostPath</code> 卷指定 <code>type</code>。</p>
<p>支持的 <code>type</code> 值如下：</p>
<table>
<thead>
<tr>
<th align="left">取值</th>
<th align="left">行为</th>
</tr>
</thead>
<tbody><tr>
<td align="left"></td>
<td align="left">空字符串（默认）用于向后兼容，这意味着在安装 hostPath 卷之前不会执行任何检查。</td>
</tr>
<tr>
<td align="left"><code>DirectoryOrCreate</code></td>
<td align="left">如果在给定路径上什么都不存在，那么将根据需要创建空目录，权限设置为 0755，具有与 kubelet 相同的组和属主信息。</td>
</tr>
<tr>
<td align="left"><code>Directory</code></td>
<td align="left">在给定路径上必须存在的目录。</td>
</tr>
<tr>
<td align="left"><code>FileOrCreate</code></td>
<td align="left">如果在给定路径上什么都不存在，那么将在那里根据需要创建空文件，权限设置为 0644，具有与 kubelet 相同的组和所有权。</td>
</tr>
<tr>
<td align="left"><code>File</code></td>
<td align="left">在给定路径上必须存在的文件。</td>
</tr>
<tr>
<td align="left"><code>Socket</code></td>
<td align="left">在给定路径上必须存在的 UNIX 套接字。</td>
</tr>
<tr>
<td align="left"><code>CharDevice</code></td>
<td align="left">在给定路径上必须存在的字符设备。</td>
</tr>
<tr>
<td align="left"><code>BlockDevice</code></td>
<td align="left">在给定路径上必须存在的块设备。</td>
</tr>
</tbody></table>
<p>注意：具有相同配置（例如基于同一 PodTemplate 创建）的多个 Pod 会由于节点上文件的不同而在不同节点上有不同的行为，即假如同一个 template 创建出来的 Pod 分配在了不同的 Node 上时，会因为节点的不同而产生不同的行为。</p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hostpath-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># 宿主机被挂载目录</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># 如果没有/data目录则会被创建</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看是否挂载成功</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%9B%9B.png" alt="volume四"></p>
<p>需要注意的是，在<code>FileOrCreate</code>下，如果被挂载的目录不存在，那么不会自动创建该目录， 为了确保这种模式能够工作，可以尝试把文件和它对应的目录分开挂载。</p>
<p><strong>hostPath FileOrCreate 配置示例</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath-fileorcreate-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-fileorcreate-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mydir</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test/test.txt</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myfile</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydir</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># 如果宿主机没有/data目录则会自动创建</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfile</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/test.txt</span></span><br><span class="line">      <span class="comment"># 因为上面已经确保会有/data目录，所以该文件的挂载不受影响</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-持久存储卷"><a href="#6-3-持久存储卷" class="headerlink" title="6.3 持久存储卷"></a>6.3 持久存储卷</h3><h4 id="6-3-1-PV和PVC"><a href="#6-3-1-PV和PVC" class="headerlink" title="6.3.1 PV和PVC"></a>6.3.1 PV和PVC</h4><p>PV 和 PVC 是 k8s 提供的两个 api 资源。</p>
<p><strong>PV</strong></p>
<p>持久卷（PersistentVolume，PV）是集群中的一块存储，可以由管理员事先供应，或者使用<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">存储类</a>来动态供应，PV 是集群资源，和普通的 Volume 一样，也是使用卷插件来实现的，只是它们拥有独立于任何使用 PV 的 Pod 的生命周期。</p>
<p><img src="/2024/02/18/kubernetes/volume%E4%BA%94.png" alt="volume五"></p>
<p><strong>PVC</strong></p>
<p>持久卷申领（PersistentVolumeClaim，PVC）表达的是用户对存储的请求。概念上与 Pod 类似。Pod 会耗用 Node 资源，而 PVC 申领会耗用 PV 资源。Pod 可以请求特定数量的资源（CPU 和内存），同样 PVC 申领也可以请求特定的大小和访问模式。</p>
<p><img src="/2024/02/18/kubernetes/volume%E5%85%AD.png" alt="volume六"></p>
<p><strong>PV 的供应方式有两种：</strong></p>
<p><strong>静态供应</strong></p>
<p>集群管理员创建若干 PV 卷。这些卷对象带有真实存储的细节信息，并且对集群用户可用（可见）。PV 卷对象存在于 Kubernetes API 中，可供用户消费（使用）。</p>
<p><strong>动态供应</strong></p>
<p>如果管理员所创建的所有静态 PV 卷都无法与用户的 PersistentVolumeClaim 匹配， 集群可以尝试为该 PVC 申领动态供应一个存储卷。 这一供应操作是基于 StorageClass 来实现的：PVC 申领必须请求某个 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">存储类</a>，同时集群管理员必须 已经创建并配置了该类，这样动态供应卷的动作才会发生。 如果 PVC 申领指定存储类为 <code>&quot;&quot;</code>，则相当于为自身禁止使用动态供应的卷。</p>
<p>为了基于存储类完成动态的存储供应，集群管理员需要在 API 服务器上启用 <code>DefaultStorageClass</code> <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#defaultstorageclass">准入控制器</a>。 举例而言，可以通过保证 <code>DefaultStorageClass</code> 出现在 API 服务器组件的 <code>--enable-admission-plugins</code> 标志值中实现这点；该标志的值可以是逗号 分隔的有序列表。关于 API 服务器标志的更多信息，可以参考 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver</a> 文档。</p>
<p><strong>绑定</strong></p>
<p>通俗理解就是一旦 PV 与 PVC 进行了绑定，那么该 PV 就无法与其它 PVC 进行绑定了。</p>
<p><strong>保护</strong></p>
<p>当一个 PV 与 PVC 绑定之后，假设 Pod 被删除，那么该 PV 与 PVC 依旧会是一个绑定的关系。</p>
<p><strong>持久卷的类型</strong></p>
<p>PV 持久卷是用插件的形式来实现的。Kubernetes 目前支持以下插件：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#awselasticblockstore"><code>awsElasticBlockStore</code></a> - AWS 弹性块存储（EBS）</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#azuredisk"><code>azureDisk</code></a> - Azure Disk</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#azurefile"><code>azureFile</code></a> - Azure File</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#cephfs"><code>cephfs</code></a> - CephFS volume</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#csi"><code>csi</code></a> - 容器存储接口 (CSI)</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#fc"><code>fc</code></a> - Fibre Channel (FC) 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#flexVolume"><code>flexVolume</code></a> - FlexVolume</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#flocker"><code>flocker</code></a> - Flocker 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#gcepersistentdisk"><code>gcePersistentDisk</code></a> - GCE 持久化盘</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#glusterfs"><code>glusterfs</code></a> - Glusterfs 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath"><code>hostPath</code></a> - HostPath 卷 （仅供单节点测试使用；不适用于多节点集群； 请尝试使用 <code>local</code> 卷作为替代）</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#iscsi"><code>iscsi</code></a> - iSCSI (SCSI over IP) 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local"><code>local</code></a> - 节点上挂载的本地存储设备</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#nfs"><code>nfs</code></a> - 网络文件系统 (NFS) 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#portworxvolume"><code>portworxVolume</code></a> - Portworx 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#quobyte"><code>quobyte</code></a> - Quobyte 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#rbd"><code>rbd</code></a> - Rados 块设备 (RBD) 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#storageos"><code>storageos</code></a> - StorageOS 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#vspherevolume"><code>vsphereVolume</code></a> - vSphere VMDK 卷</li>
</ul>
<p><strong>访问模式</strong></p>
<p>PV 卷可以用资源提供者所支持的任何方式挂载到宿主系统上。 如下表所示，提供者（驱动）的能力不同，每个 PV 卷的访问模式都会设置为 对应卷所支持的模式值。 例如，NFS 可以支持多个读写客户，但是某个特定的 NFS PV 卷可能在服务器 上以只读的方式导出。每个 PV 卷都会获得自身的访问模式集合，描述的是 特定 PV 卷的能力。</p>
<p>访问模式有：</p>
<ul>
<li>ReadWriteOnce：卷可以被一个节点以读写方式挂载；</li>
<li>ReadOnlyMany：卷可以被多个节点以只读方式挂载；</li>
<li>ReadWriteMany：卷可以被多个节点以读写方式挂载。</li>
</ul>
<p>对于不同类型的存储卷访问模式也有不同，如下表</p>
<table>
<thead>
<tr>
<th align="left">卷插件</th>
<th align="center">ReadWriteOnce</th>
<th align="center">ReadOnlyMany</th>
<th align="center">ReadWriteMany</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AWSElasticBlockStore</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">AzureFile</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">AzureDisk</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">CephFS</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Cinder</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">CSI</td>
<td align="center">取决于驱动</td>
<td align="center">取决于驱动</td>
<td align="center">取决于驱动</td>
</tr>
<tr>
<td align="left">FC</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">FlexVolume</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">取决于驱动</td>
</tr>
<tr>
<td align="left">Flocker</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">GCEPersistentDisk</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">Glusterfs</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">HostPath</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">iSCSI</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">Quobyte</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">NFS</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">RBD</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">VsphereVolume</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">- (Pod 运行于同一节点上时可行)</td>
</tr>
<tr>
<td align="left">PortworxVolume</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">ScaleIO</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">StorageOS</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<p><strong>类</strong></p>
<p>每个 PV 可以属于某个类（Class），通过将其 <code>storageClassName</code> 属性设置为某个 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">StorageClass</a> 的名称来指定。 特定类的 PV 卷只能绑定到请求该类存储卷的 PVC 申领。 未设置 <code>storageClassName</code> 的 PV 卷没有类设定，只能绑定到那些没有指定特定存储类的 PVC 申领。</p>
<p><strong>回收策略</strong></p>
<p>目前的回收策略有：</p>
<ul>
<li>Retain（保留） – 手动回收</li>
<li>Recycle（回收）– 基本擦除 (<code>rm -rf /thevolume/*</code>)</li>
<li>Delete（删除）– 诸如 AWS EBS、GCE PD、Azure Disk 或 OpenStack Cinder 卷这类关联存储资产也被删除</li>
</ul>
<p>目前，仅 NFS 和 HostPath 支持回收（Recycle）。 AWS EBS、GCE PD、Azure Disk 和 Cinder 卷都支持删除（Delete）。</p>
<p><strong>阶段（状态）</strong></p>
<p>每个卷会处于以下阶段（Phase）之一：</p>
<ul>
<li>Available（可用）– 卷是一个空闲资源，尚未绑定到任何申领；</li>
<li>Bound（已绑定）– 该卷已经绑定到某申领；</li>
<li>Released（已释放）– 所绑定的申领已被删除，但是资源尚未被集群回收；</li>
<li>Failed（失败）– 卷的自动回收操作失败。</li>
</ul>
<p><strong>示例一</strong></p>
<p>这个实例是先后创建 PV、PVC、Deployment</p>
<ol>
<li>创建 PV</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 PVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建 Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-deployment-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-deployment-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">test-pvc</span></span><br></pre></td></tr></table></figure>

<p><strong>示例二</strong></p>
<p>这个实例会由 StatefulSet 自动创建 PVC</p>
<p><img src="/2024/02/18/kubernetes/%E6%8C%81%E4%B9%85%E5%AD%98%E5%82%A8%E5%8D%B7%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="持久存储卷示例图"></p>
<ol>
<li>部署 NFS 服务器，并在每个节点安装<code>nfs-utils</code></li>
<li>部署 PV，这里创建了四个 PV</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># PV容量大小</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="comment"># 服务模式为RWO，卷可以被一个节点以读写方式挂载</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="comment"># 回收策略为Retain，即手动回收</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="comment"># 类为nfs</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="comment"># 制定nfs服务器地址和被挂载目录</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadOnlyMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">slow-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/slow</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/volume%E4%B8%83.png" alt="volume七"></p>
<ol start="2">
<li>创建无头 SVC、StatefulSet</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-svc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># 不分配ip地址，为StatefulSet使用</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="comment"># 匹配标签</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 匹配标签</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nfs-pv-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-pv-pod</span></span><br><span class="line">      <span class="comment"># pod标签</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pv-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># 挂载持久卷</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pv-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="comment"># PVC模板</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-pv-volume</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 匹配规则</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&#x27;ReadWriteOnce&#x27;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>先后创建后查看 Pod 创建情况，可以看到只创建了一个 Pod，因为现有的 PV 只有一个符合匹配条件，而 StatefulSet 是前一个 Pod 创建成功才会创建下一个，因为第二个 Pod 创建不成功，所以第三个 Pod 不会被创建</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%85%AB.png" alt="volume八"></p>
<ol start="4">
<li>进入容器内部可以看到挂载成功，去到 NFS 服务器的<code>/nfs1</code>目录下创建<code>test.html</code>文件测试成功</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E4%B9%9D.png" alt="volume九"></p>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81.png" alt="volume十"></p>
<ol start="5">
<li>删除创建失败的 Pod 以及对应的 PVC，创建新的两个 PV，以满足 StatefulSet 的挂载要求，剩下的 Pod 就会逐一创建成功</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%80.png" alt="volume十一"></p>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%BA%8C.png" alt="volume十二"></p>
<ol start="6">
<li>删除上面测试的 Pod，StatefulSet 会重新创建一个 Pod，且数据不会丢失</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%89.png" alt="volume十三"></p>
<p>这里会有个问题，如果删除了 StatefulSet，那么对应的 Pod 也会被删除，可是已经绑定的 PV 并不会删除，这里就需要手动回收了。</p>
<p><strong>手动回收</strong></p>
<ul>
<li><p>删除 StatefulSet</p>
</li>
<li><p>删除 PVC</p>
</li>
<li><p>修改 PV</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit pv pv名称</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除ClaimRef的信息</span></span><br><span class="line">ClainRef:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="6-3-2-StorageClass"><a href="#6-3-2-StorageClass" class="headerlink" title="6.3.2 StorageClass"></a>6.3.2 StorageClass</h4><p>以上的方法都是静态创建的 PV，会出现 PVC 找不到条件符合的 PV 进行绑定。</p>
<p>而 StorageClass 的作用是根据 PVC 的需求动态创建 PV。</p>
<p><strong>示例一</strong></p>
<p><img src="/2024/02/18/kubernetes/NFS%E5%AD%98%E5%82%A8%E5%88%86%E9%85%8D%E5%99%A8%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="NFS存储分配器示例图"></p>
<ol>
<li>k8s 在 1.20 版本开始就禁用了 selfLink，所以需在配置文件添加以下内容</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E5%9B%9B.png" alt="volume十四"></p>
<ol start="2">
<li>StorageClass 是通过存储分配器来动态创建 PV 的，但 k8s 内部的存储分配器不支持 NFS，所以首先要安装 NFS 存储分配器</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="comment"># 设置升级策略为删除再创建(默认为滚动更新)</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nfs-provision</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="comment"># nfs存储分配器名称</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">nfs-client</span></span><br><span class="line">            <span class="comment"># nfs服务器地址</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">            <span class="comment"># nfs共享目录</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>给 NFS 存储分配器授权</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner_rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建 StorageClass</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_storageclass.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># storageclass名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storageclass</span></span><br><span class="line"><span class="comment"># nfs存储分配器名称</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">nfs-client</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># 表示pvc删除时，所绑定的pv不会被保留，true相反</span></span><br><span class="line">  <span class="attr">archieveOnDelete:</span> <span class="string">&#x27;false&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>创建 PVC，可以看到 NFS 存储分配器已经自动创建了 PV 与之绑定</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_storageclass_pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="comment"># storageclass名称</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs-client&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%BA%94.png" alt="volume十五"></p>
<ol start="6">
<li>创建一个 Deployment 测试是否能用这个 PVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-provisioner-deployment-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/test</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nfs-storageclass-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>在 NFS 服务器的共享目录下创建一个 test.html</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E5%85%AD.png" alt="volume十六"></p>
<ol start="8">
<li>访问 Deployment 创建出来的 Pod，可以看到是可以访问的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%83.png" alt="volume十七"></p>
<h3 id="6-4-StatefulSet"><a href="#6-4-StatefulSet" class="headerlink" title="6.4 StatefulSet"></a>6.4 StatefulSet</h3><p>StatefulSet 是一种提供排序和唯一性保证的特殊 Pod 控制器，当有部署顺序、持久数据或固定网络等相关的特殊需求时，可以用 StatefulSet 控制器来进行控制。</p>
<p>StatefulSet 提供有状态服务，主要功能如下：</p>
<ol>
<li>实现稳定的持久化存储：通过 PVC 来实现，Pod 之间不能共用一个存储卷，每个 Pod 都要有一个自己专用的存储卷。</li>
<li>实现稳定的网络标识：Pod 重新调度后其 PodName 和 HostName 不变，通过无头 SVC 来实现。</li>
<li>实现有序部署、有序伸缩：Pod 是有顺序的，只有前一个 Pod 创建成功才会创建下一个，直到最后。</li>
<li>实现有序收缩、有序删除：从最后一个开始，依次删除到第一个。</li>
<li>无头 SVC ：为 Pod 生成可以解析的 DNS 记录。</li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%B8%80.png" alt="statefulset一"></p>
<p><strong>示例一</strong></p>
<ol>
<li>创建无头 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">statefulset_nginx_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-nginx-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 StatefulSet</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">statefulset_nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 匹配无头SVC</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">statefulset-nginx-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">statefulset-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># PVC模板</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">statefulset-nginx-pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&#x27;ReadWriteOnce&#x27;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs-storageclass&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">50Mi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到 Pod 是有序创建的，且每个 Pod 都是单独使用一个 PVC 和 PV，删除 StatefulSet 也可以看到 Pod 是有序删除的，且删除后 PVC 与 PV 依旧存在，重新生成 StatefulSet 可以继续使用这些 PVC 和 PV</li>
</ol>
<p><strong>有序创建</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%BA%8C.png" alt="statefulset二"></p>
<p><strong>PVC 与 PV</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%B8%89.png" alt="statefulset三"></p>
<p><strong>有序删除</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E5%9B%9B.png" alt="statefulset四"></p>
<ol start="4">
<li>创建一个 Pod 用来测试无头 SVC 提供的 DNS 服务</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;this is test&quot;; sleep 36000&#x27;</span> ]</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>进入 Pod 后可以通过<code>nslookup</code>测试，形式为<code>&#123;ServiceName&#125;.&#123;NameSpace&#125;.svc.&#123;ClusterDomain&#125;</code></li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%BA%94.png" alt="statefulset五"></p>
<ol start="6">
<li>通过域名也可以访问各个 Pod，形式为<code>&#123;PodName&#125;&#123;ServiceName&#125;.&#123;NameSpace&#125;.svc.&#123;ClusterDomain&#125;</code></li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E5%85%AD.png" alt="statefulset六"></p>
<h2 id="七、k8s调度器"><a href="#七、k8s调度器" class="headerlink" title="七、k8s调度器"></a>七、k8s调度器</h2><p>scheduler 是 k8s 集群的调度器，对每一个新创建的 Pod 或者是未被调度的 Pod，scheduler 会选择一个最优的 Node 去运行这个 Pod。然而，Pod 内的每一个容器对资源都有不同的需求，而且 Pod 本身也有不同的资源需求。因此，Pod 在被调度到 Node 上之前， 根据这些特定的资源调度需求，需要对集群中的 Node 进行一次过滤。</p>
<p>在做调度决定时需要考虑的因素包括：单独和整体的资源请求、硬件&#x2F;软件&#x2F;策略限制、 亲和以及反亲和要求、数据局域性、负载间的干扰等等。</p>
<p><strong>调度流程：</strong></p>
<ul>
<li>过滤：调度器会将所有满足 Pod 调度需求的 Node 选出来。</li>
<li>打分：调度器会为 Pod 从所有可调度节点中选取一个最合适的 Node。</li>
</ul>
<h3 id="7-1-亲和性与反亲和性"><a href="#7-1-亲和性与反亲和性" class="headerlink" title="7.1 亲和性与反亲和性"></a>7.1 亲和性与反亲和性</h3><h4 id="7-1-1-Node亲和性"><a href="#7-1-1-Node亲和性" class="headerlink" title="7.1.1 Node亲和性"></a>7.1.1 Node亲和性</h4><p>节点亲和性是通过<code>pod.spec.nodeAffinity</code>来实现的，包括以下两种：</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策略</li>
</ul>
<p><strong>requiredDuringSchedulingIgnoredDuringExecution硬策略</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-required-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-required-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># 亲和性设置</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="comment"># 节点亲和性设置</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="comment"># 硬策略</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="comment"># 节点选择器</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="comment"># 匹配表达式</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="comment"># 制定key，即以这个key的键值为匹配条件</span></span><br><span class="line">          <span class="comment"># 通过kubectl get node --show-labels可以获得更多标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="comment"># In:label的值在某个列表中</span></span><br><span class="line">            <span class="comment"># NotIn:label的值不在某个列表中</span></span><br><span class="line">            <span class="comment"># Gt:label的值大于某个值</span></span><br><span class="line">            <span class="comment"># Lt:label的值小于某个值</span></span><br><span class="line">            <span class="comment"># Exists:某个label存在</span></span><br><span class="line">            <span class="comment"># DoesNotExist:某个label不存在</span></span><br><span class="line">            <span class="comment"># 这里设置的意思是，根据kubernetes.io/hostname的键值，永远不分配到键值为k8s-node01的节点上</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node01</span></span><br></pre></td></tr></table></figure>

<p>创建后可以看到 Pod 不会被创建在 k8s-node01 节点上<img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%80.png" alt="Node亲和性一"></p>
<p><strong>preferredDuringSchedulingIgnoredDuringExecution软策略</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-preferred-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-preferred-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="comment"># 软策略</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="comment"># 权重，范围为1-100</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># 偏向于</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="comment"># 匹配表达式</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node03</span></span><br></pre></td></tr></table></figure>

<p>可以看到虽然要求部署到 k8s-node03 节点上，但由于本环境没有该节点，所以就被分配到其它的节点了</p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BA%8C.png" alt="Node亲和性二"></p>
<p><strong>软硬合体版</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-preandreq-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-preandreq-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">cpu</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">4core</span>] &#125;</span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">disktype</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">ssd</span>] &#125;</span><br></pre></td></tr></table></figure>

<p>软策略和硬策略一起使用就会先满足硬策略再分析软策略，可以看到现有的节点没有可以满足以上条件的，所以 Pod 一直处于 Pending 状态</p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%89.png" alt="Node亲和性三"></p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E5%9B%9B.png" alt="Node亲和性四"></p>
<h4 id="7-1-2-Pod亲和性"><a href="#7-1-2-Pod亲和性" class="headerlink" title="7.1.2 Pod亲和性"></a>7.1.2 Pod亲和性</h4><p>有时候需要将某些 Pod 与正在运行的已具有某些特质的 Pod 调度到一起，因此就需要 Pod 亲和性调度方式。</p>
<p>Pod 亲和性是通过<code>spec.affinity.podAffinity/podAntiAffinity</code>来实现的，前者为<strong>亲和性</strong>，后者为<strong>反亲和性</strong>，包括以下两种：</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策略</li>
</ul>
<p><strong>requiredDuringSchedulingIgnoredDuringExecution硬策略</strong></p>
<ol>
<li>首先创建一个标签为<code>app:nginx</code>的 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod-container-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建硬策略亲和性 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-required</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-required-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># 亲和性设置</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="comment"># Pod亲和性设置</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="comment"># 硬策略</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="comment"># 列出规则</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="comment"># 甄选app这个标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="comment"># In:label的值在某个列表中</span></span><br><span class="line">            <span class="comment"># NotIn:label的值不在某个列表中</span></span><br><span class="line">            <span class="comment"># Exists:某个label存在</span></span><br><span class="line">            <span class="comment"># DoesNotExist:某个label不存在</span></span><br><span class="line">            <span class="comment"># 表示硬性匹配标签为app=nginx的这个Pod</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="comment"># 键值</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="comment"># 分配到与这个Pod所属的节点kubernetes.io/hostname值相同的节点上，可以理解为分配到同一节点上，但可能有多个</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>可以看到会分配在同一节点上</p>
<p><img src="/2024/02/18/kubernetes/Pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%80.png" alt="Pod亲和性一"></p>
<ol start="3">
<li>删除该 Pod，将<code>podAffinity</code>改为<code>podAntiAffinity</code>，将不会分配到一起</li>
</ol>
<p><img src="/2024/02/18/kubernetes/Pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BA%8C.png" alt="Pod亲和性二"></p>
<h3 id="7-2-污点和容忍度"><a href="#7-2-污点和容忍度" class="headerlink" title="7.2 污点和容忍度"></a>7.2 污点和容忍度</h3><p>污点（taint）表示一个节点上存在不良状况，污点会影响 Pod 的调度，其定义方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node &#123;节点名称&#125; &#123;污点名称&#125;=&#123;污点值&#125;:&#123;污点的影响&#125;</span><br></pre></td></tr></table></figure>

<p>污点的影响有三种：</p>
<ul>
<li>NoExecute：不将 Pod 调度到具备该污点的节点上，如果 Pod 已经在该节点运行，则会被驱逐。</li>
<li>NoSchedule：不将 Pod 调度到具备该污点的节点上，如果 Pod 已经在该节点运行，不会被驱逐。</li>
<li>PreferNoSchedule：不推荐将 Pod 调度到具备该污点的节点上。</li>
</ul>
<p><strong>添加污点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E4%B8%80.png" alt="污点和容忍一"></p>
<p><strong>删除污点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute-</span><br></pre></td></tr></table></figure>

<p><strong>示例一</strong></p>
<ol>
<li>给 k8s-node01 打上污点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">toleration-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">toleration-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># 添加节点亲和性硬策略，让该Pod调度到k8s-node01上</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node01</span></span><br><span class="line">  <span class="comment"># 容忍设置</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="comment"># 容忍污点</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;cpu&quot;</span></span><br><span class="line">    <span class="comment"># Equal:指等于该值</span></span><br><span class="line">    <span class="comment"># Exist:指有该key就可，值无所谓</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="comment"># 污点影响</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">    <span class="comment"># 容忍时间，超过该事件就会被驱除，只有污点影响设置为NoExecute才可用</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">36</span></span><br></pre></td></tr></table></figure>

<p>可以看到该 Pod 依旧可以调度到 k8s-node01 节点上，但超过 3600 秒后就被驱除了</p>
<p><img src="/2024/02/18/kubernetes/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E4%BA%8C.png" alt="污点和容忍二"></p>
<p>容忍度设置一般用于 DaemonSet 控制器，因为 DaemonSet 控制器下的应用一般是为节点本身提供服务的。</p>
<h3 id="7-3-优先级和抢占式调度"><a href="#7-3-优先级和抢占式调度" class="headerlink" title="7.3 优先级和抢占式调度"></a>7.3 优先级和抢占式调度</h3><p>当集群的资源（CPU、内存、磁盘等）不足时，新 Pod 的创建会一直处于 Pending 的状态，默认情况下，除了系统外的 Pod，其它 Pod 的优先级都是相同的，如果调高了 Pod 的优先级，那么节点就会将低优先级的 Pod 驱逐，腾出空间给优先级高的 Pod，这就被称为<strong>抢占式调度</strong>。</p>
<p><strong>示例一</strong></p>
<ol>
<li>要调整优先级，需要先创建 PriorityClass</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-priorityclass</span></span><br><span class="line"><span class="comment"># 优先级设置</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000000</span></span><br><span class="line"><span class="comment"># 是否在全局下使用，只可设置一个</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 描述</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;this priorityclass is test&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在 Pod 中调用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">priorityclass-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">priorityclass-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">priorityClassName:</span> <span class="string">test-priorityclass</span></span><br></pre></td></tr></table></figure>

<h3 id="7-4-为Pod设置计算资源"><a href="#7-4-为Pod设置计算资源" class="headerlink" title="7.4 为Pod设置计算资源"></a>7.4 为Pod设置计算资源</h3><p>容器运行时会提供一些机制来限制容器可以使用的计算资源（CPU、内存和磁盘等），Pod 模板中也提供了这个功能，主要如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算资源设置</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="comment"># 资源限制设置，超过设置的值容器会被停止</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="comment"># cpu限制</span></span><br><span class="line">    <span class="attr">cpu:</span></span><br><span class="line">    <span class="comment"># 内存限制</span></span><br><span class="line">    <span class="attr">memory:</span></span><br><span class="line">  <span class="comment"># 资源请求设置，至少需要多少资源容器才会被运行</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="comment"># cpu请求</span></span><br><span class="line">    <span class="attr">cpu:</span></span><br><span class="line">    <span class="comment"># 内存请求</span></span><br><span class="line">    <span class="attr">memory:</span></span><br></pre></td></tr></table></figure>

<p><strong>示例一</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resources-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">resources-container</span></span><br><span class="line">    <span class="comment"># 压测工具</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">vish/stress</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="comment"># 进行压测，阈值为150Mi,每一秒增加5Mi压力</span></span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;-mem-total&#x27;</span>,<span class="string">&#x27;150Mi&#x27;</span>,<span class="string">&#x27;-mem-alloc-size&#x27;</span>,<span class="string">&#x27;5Mi&#x27;</span>,<span class="string">&#x27;-mem-alloc-sleep&#x27;</span>,<span class="string">&#x27;1s&#x27;</span> ]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&#x27;100Mi&#x27;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&#x27;200m&#x27;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&#x27;50Mi&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以看到 Pod 最初可以运行，但20秒后就不行了</p>
<p><img src="/2024/02/18/kubernetes/%E4%B8%BAPod%E8%AE%BE%E7%BD%AE%E8%AE%A1%E7%AE%97%E8%B5%84%E6%BA%90%E4%B8%80.png" alt="为Pod设置计算资源一"></p>
<h3 id="7-5-命名空间管理"><a href="#7-5-命名空间管理" class="headerlink" title="7.5 命名空间管理"></a>7.5 命名空间管理</h3><p>命名空间的主要作用是对 k8s 集群的资源进行划分，这种划分是一种逻辑划分，用于实现多租户的资源隔离。</p>
<p><strong>命名空间的创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace 命名空间名称</span><br></pre></td></tr></table></figure>

<p><strong>命名空间的资源配额</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span></span><br><span class="line">  <span class="attr">namespace:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="comment"># 计算资源配额</span></span><br><span class="line">    <span class="attr">limits.cpu:</span></span><br><span class="line">    <span class="attr">limits.memory:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span></span><br><span class="line">    <span class="attr">requests.memory:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 存储资源配额</span></span><br><span class="line">    <span class="comment"># 在所有PVC中，存储资源的需求不能超过该值</span></span><br><span class="line">    <span class="attr">requests.storage:</span></span><br><span class="line">    <span class="comment"># 允许存在的PVC数量</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span></span><br><span class="line">    <span class="comment"># 允许与&#123;storage-class-name&#125;相关的PVC总量</span></span><br><span class="line">    &#123;<span class="string">storage-class-name</span>&#125;<span class="string">.storageclass.storage.k8s.io/requests.storage:</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment"># 对象数量配额</span></span><br><span class="line">    <span class="comment"># 允许存在ConfigMap数量</span></span><br><span class="line">    <span class="attr">configmaps:</span></span><br><span class="line">    <span class="comment"># 允许存在的非终止状态的Pod数量</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">    <span class="comment"># 允许存在的RC数量</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span></span><br><span class="line">    <span class="comment"># 允许存在的资源配额数量</span></span><br><span class="line">    <span class="attr">resourcequotas:</span></span><br><span class="line">    <span class="comment"># 允许存在的SVC数量</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">    <span class="comment"># 允许存在的LoadBalancer类型的SVC数量</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span></span><br><span class="line">    <span class="comment"># 允许存在的NodePort类型的SVC数量</span></span><br><span class="line">    <span class="attr">services.nodeports:</span></span><br><span class="line">    <span class="comment"># 允许存在的Secret数量</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br></pre></td></tr></table></figure>

<h4 id="7-5-1-命名空间的资源配额"><a href="#7-5-1-命名空间的资源配额" class="headerlink" title="7.5.1 命名空间的资源配额"></a>7.5.1 命名空间的资源配额</h4><p><strong>示例一</strong></p>
<ol>
<li>先创建一个命名空间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace test-ns</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建资源配额</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-rq</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&#x27;4&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建一个 Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-ns-depolyment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-ns-depolyment-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>配额限制的 Pod 数量是2，但 Deployment 设置的副本数是3，可以看到是创建不了第三个 Pod 的</p>
<p><img src="/2024/02/18/kubernetes/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E4%B8%80.png" alt="命名空间资源配额一"></p>
<h4 id="7-5-2-命名空间单个资源的资源配额"><a href="#7-5-2-命名空间单个资源的资源配额" class="headerlink" title="7.5.2 命名空间单个资源的资源配额"></a>7.5.2 命名空间单个资源的资源配额</h4><p>通过设置资源配额，可以限定一个命名空间下使用的资源总量，但这只是总量限制，对于单个资源没有限制，有时候一个 Pod 就可能用完整个命名空间所指定的资源，为了避免，可以通过<code>LimitRange</code>来对单个资源进行限定。</p>
<p><strong>设置容器的限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-container</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;200m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;300Mi&#x27;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;150Mi&#x27;</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;180m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;250Mi&#x27;</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;110m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;160Mi&#x27;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E4%BA%8C.png" alt="命名空间资源配额二"></p>
<p>当 LimitRange 创建成功后，创建该命名空间下的 Pod 时，各个容器的<code>resource.limits</code>和<code>resource.requests</code>必须满足 Max 和 Min 之间的范围。</p>
<p>而<code>default</code>和<code>defaultRequest</code>是指，当创建 Pod 时没用设置限额，则根据此属性来设置限额。</p>
<p><strong>设置 Pod 的限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;600Mi&#x27;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;500m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;300Mi&#x27;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<p>当 LimitRange 创建成功后，创建该命名空间下的 Pod 时，各个 Pod 的<code>resource.limits</code>和<code>resource.requests</code>必须满足 Max 和 Min 之间的范围。</p>
<p><strong>设置 PVC 的限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">200Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PersistentVolumeClaim</span></span><br></pre></td></tr></table></figure>

<p><strong>设置 Pod 或容器的比例限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-ratio</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">maxLimitRequestRatio:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<p>设置比例限额可以限制 Pod 或容器设置的请求资源和上限资源的比值，在该示例中，Pod 所有容器的<code>resources.limits.memory</code>的总和要 &#x3D; Pod 所有容器的<code>resources.requests.memory</code>的总和的两倍，<strong>即上限必须是需求的两倍</strong>，Pod 才能够创建成功。</p>
<h3 id="7-6-标签、选择器、注解"><a href="#7-6-标签、选择器、注解" class="headerlink" title="7.6 标签、选择器、注解"></a>7.6 标签、选择器、注解</h3><h4 id="7-6-1-标签"><a href="#7-6-1-标签" class="headerlink" title="7.6.1 标签"></a>7.6.1 标签</h4><p>k8s 的标签（label）是一种语义化标记标签，可以附加到 k8s 对象上，对它们进行标记和划分。</p>
<p>标签的形式是键值对，每个资源对象都可以拥有多个标签，但每个键都只能有一个值。</p>
<p>对于标签的设置，是通过<code>metadata</code>属性中实现的，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">key1:</span> <span class="string">value1</span></span><br><span class="line">    <span class="attr">key2:</span> <span class="string">value2</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>而对于已有的资源，可以通过以下命令添加或删除标签</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label 资源类型 资源名称 标签名=标签值</span><br><span class="line">kubectl label 资源类型 资源名称 标签名=标签值-</span><br></pre></td></tr></table></figure>

<h4 id="7-6-2-选择器"><a href="#7-6-2-选择器" class="headerlink" title="7.6.2 选择器"></a>7.6.2 选择器</h4><p>通过标签选择器（selector）就可以快速查找到指定标签的资源。</p>
<p>通过<code>-l</code>查找方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l 标签名=/!=标签值</span><br></pre></td></tr></table></figure>

<p>通过<code>in</code> <code>notin</code>查找</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l &#x27;标签名1 in/notin (标签值1,标签值2)&#x27;</span><br></pre></td></tr></table></figure>

<p>每种基于控制器的对象也可以使用标签来选择需要操作的 Pod，如 Job、Deployment、DaemonSet 等都可以在<code>spec</code>中指定选择器，以查找到符合条件的 Pod，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">stable</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">env</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">dev</span>] &#125;</span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">track</span>, <span class="attr">operator:</span> <span class="string">Exists</span> &#125;</span><br></pre></td></tr></table></figure>

<p>在创建 SVC 时，都需要制定标签选择器来确定需要控制的资源，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">stable</span></span><br></pre></td></tr></table></figure>

<p>在创建 PVC 时，除了用类匹配之外，也可以用标签来匹配适合的 PV，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">pvnumber:</span> <span class="string">pv01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">pvnumber:</span> <span class="string">pv01</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="7-6-3-注解"><a href="#7-6-3-注解" class="headerlink" title="7.6.3 注解"></a>7.6.3 注解</h4><p>注解（annotation）也是一种类似标签的机制，但只是给资源添加更多信息的方式，类似注释。</p>
<p>设置注解，是通过<code>metadata</code>来实现的，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line">  <span class="attr">annotation:</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">&#x27;cqm&#x27;</span></span><br><span class="line">    <span class="attr">phone:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">&#x27;123456@789.com&#x27;</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>



<h2 id="八、API-Server"><a href="#八、API-Server" class="headerlink" title="八、API Server"></a>八、API Server</h2><p>API Server 是集群内布各个组件通信的中介，也是外部控制的入口，k8s 的安全机制基本都是围绕着保护 API Server 来设计的，通过<strong>认证、鉴权、准入控制</strong>三步来保证 API Server 的安全。</p>
<p>我们在使用 k8s 时，都是通过<code>kubectl</code>工具来访问 API Server 的，<code>kubectl</code>把命令转换为对 API Server 的 REST API 调用。</p>
<p><img src="/2024/02/18/kubernetes/apiserver%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B.svg" alt="apiserver访问流程"></p>
<h3 id="8-1-身份认证"><a href="#8-1-身份认证" class="headerlink" title="8.1 身份认证"></a>8.1 身份认证</h3><p>身份认证主要用于确定用户能不能访问，是访问 API Server 的第一个关卡。</p>
<p>通过命令可以看到认证情况，可以看到是通过 6443 端口进行访问的。</p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%80.png" alt="身份认证一"></p>
<p>要访问 API Server，首先就要进行身份认证，k8s 的身份认证分为以下两类：</p>
<ul>
<li>常规用户认证：主要提供于普通用户或独立于 k8s 之外的其他外部应用使用，以便能从外部访问 API Server。</li>
<li>ServiceAccount 认证：主要提供于内部的 Pod 使用。</li>
</ul>
<h4 id="8-1-1-常规用户认证"><a href="#8-1-1-常规用户认证" class="headerlink" title="8.1.1 常规用户认证"></a>8.1.1 常规用户认证</h4><p>常规用户认证主要有三种方式：</p>
<ul>
<li><p>HTTPS 证书认证：基于 CA 证书签名的数字证书认证。</p>
</li>
<li><p>HTTP 令牌认证：通过令牌来识别用户。</p>
</li>
<li><p>HTTP Base 认证：通过用户名和密码认证。</p>
</li>
</ul>
<ol>
<li>令牌认证是最实用也最普及的方式，首先生成一个随机令牌</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>接着给 k8s 创建令牌认证文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/pki/token_auth_file</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式为:令牌1,用户1,用户ID</span></span><br><span class="line">ec0f09bf9a3c40f9db1cc0f8e6664c12,cqm,1</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>认证文件创建好后，在 API Server 启动文件中进行引用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line"><span class="comment"># 在spec中添加</span></span><br><span class="line"><span class="string">--token-auth-file=/etc/kubernetes/pki/token_auth_file</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>接着就可以用认证好的用户访问 API Server 来获取 Pod 的信息了</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer ec0f09bf9a3c40f9db1cc0f8e6664c12&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%BA%8C.png" alt="身份认证二"></p>
<p>但可以看到还是失败，因为还没有进行授权，后边将进行授权。</p>
<h4 id="8-1-2-ServiceAccount认证"><a href="#8-1-2-ServiceAccount认证" class="headerlink" title="8.1.2 ServiceAccount认证"></a>8.1.2 ServiceAccount认证</h4><p>ServiceAccount 认证主要提供于集群内布的 Pod 中的进程使用，常规用户认证是不限制命名空间的，但 ServiceAccount 认证的局限于它所在的命名空间中。</p>
<p><strong>默认 ServiceAccount</strong></p>
<p>每个命名空间都有个默认的 ServiceAccount，如果创建 Pod 时没用指定，那么就会使用默认的 ServiceAccount。</p>
<ol>
<li>通过命令可以看到默认的 ServiceAccount</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%89.png" alt="身份认证三"></p>
<ol start="2">
<li>创建一个 Pod 进行测试</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sa-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sa-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;this is sa test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看 Pod 的详细信息，可以看到被挂载了一个 Secret 类型的卷，实际上这里面就存放了 ServiceAccount 的认证信息</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%9B%9B.png" alt="身份认证四"></p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%BA%94.png" alt="身份认证五"></p>
<p>进入容器内部，通过以上地址映射令牌在进行访问 API Server，可以看到由于未授权依旧不行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorizat</span><br><span class="line">ion:Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%85%AD.png" alt="身份认证六"></p>
<p><strong>自定义 ServiceAccount</strong></p>
<p>如果某些 Pod 需要访问 API Server，通常会让它引用自定义 ServiceAccount，并为其授权。</p>
<ol>
<li>首先创建一个自定义 ServiceAccount</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建好后可以查看详细信息，包含了证书和令牌等</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%83.png" alt="身份认证七"></p>
<ol start="3">
<li>创建 Pod 引用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-sa-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-sa-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;this is sa test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>就可以看到 Pod 中已经引用了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%85%AB.png" alt="身份认证八"></p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B9%9D.png" alt="身份认证九"></p>
<h3 id="8-2-RBAC授权"><a href="#8-2-RBAC授权" class="headerlink" title="8.2 RBAC授权"></a>8.2 RBAC授权</h3><p>k8s 中有基于属性的访问控制（ABAC），基于角色的访问控制（RBAC），基于 HTTP 回调机制的访问控制（Webhook）、Node 认证等授权模式，但1.6版本开始就默认启用 RBAC 模式。</p>
<p>RBAC 授权主要分为两步：</p>
<ul>
<li>角色定义：指定角色名称，定义允许访问哪些资源以及允许的访问方式。</li>
<li>角色绑定：将角色与用户（常规用户或 ServiceAccount）进行绑定。</li>
</ul>
<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E5%8E%9F%E7%90%86.png" alt="RBAC授权原理"></p>
<p>而角色定义和角色绑定又分为两种：</p>
<ul>
<li>只有单一指定命名空间访问权限的角色：角色定义关键字为 Role，角色绑定关键字为 RoleBinding。</li>
<li>拥有集群级别（不限命名空间）访问权限的角色：角色定义为 ClusterRole，角色绑定关键字为 ClusterRoleBinding。</li>
</ul>
<h4 id="8-2-1-普通角色的定义与绑定"><a href="#8-2-1-普通角色的定义与绑定" class="headerlink" title="8.2.1 普通角色的定义与绑定"></a>8.2.1 普通角色的定义与绑定</h4><p><strong>普通角色定义</strong></p>
<ol>
<li>创建一个普通角色</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 角色名</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># 角色规则定义</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># 表示可以对哪些API组的资源进行操作，这里为空即不限制</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="comment"># 可以访问的资源列表，这里为Pod</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="comment"># 可以进行的访问方式</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>访问方式可以通过开启<code>kubectl</code>反向代理查看，其中的<code>verb</code>就是可以访问的方式</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --port:8080</span><br><span class="line">curl http://localhost:8080/&#123;APIVersion&#125;</span><br></pre></td></tr></table></figure>

<p><strong>普通角色绑定</strong></p>
<p>定义角色后就可以进行绑定角色，绑定可以针对常规用户认证，也可以这对 ServiceAccount 认证。</p>
<ol>
<li>创建角色绑定</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># 将角色绑定给那些认证主体，它是一个数组，将常规用户认证cqm和ServiceAccount认证my-serviceaccount加入到rabc-role角色中</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="comment"># 常规用户认证绑定</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># ServiceAccount认证绑定</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 要绑定的角色</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="comment"># 普通角色</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E4%B8%80.png" alt="RBAC授权一"></p>
<ol start="2">
<li>尝试用之前创建的常规用户认证和 ServiceAccount 认证来访问 API Server，可以发现就可以访问了</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer ec0f09bf9a3c40f9db1cc0f8e6664c12&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer $(cat /var/run/secrets/kubern</span><br><span class="line">etes.io/serviceaccount/token)&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E4%BA%8C.png" alt="RBAC授权二"></p>
<h4 id="8-2-2-集群角色的定义与绑定"><a href="#8-2-2-集群角色的定义与绑定" class="headerlink" title="8.2.2 集群角色的定义与绑定"></a>8.2.2 集群角色的定义与绑定</h4><p>集群角色与普通角色的区别如下：</p>
<ul>
<li>使用的关键字不同：普通角色使用 Role，绑定使用 RoleBinding，集群角色使用 ClusterRole，绑定使用 ClusterRoleBinding。</li>
<li>集群角色不属于任何命名空间，模板也不需要指定命名空间，普通角色要求指定命名空间，如果没指定九默认 default。</li>
<li>集群角色可以访问所有命名空间下的资源，也可以访问不在命名空间下的资源。</li>
</ul>
<p>集群角色创建和绑定如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群角色定义</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 集群角色名</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrole</span></span><br><span class="line"><span class="comment"># 规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 集群角色绑定</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrolebinding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># 由于my-serviceaccount是某个命名空间下的，所以要指定命名空间</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">clusterrole</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>这样一来用户（cqm，my-serviceaccount）都可以访问全局的资源，当然 ClusterRole 也可以和 RoleBinding 绑定在一起，因为 ClusterRole 是不限命名空间的，如果既想给某个认证主体绑定 ClusterRole，又想限制它能访问的命名空间，就可以通过与 RoleBinding 绑定来实现，本例中是指<code>rbac-clusterrole</code>的角色在绑定<code>rbac-rolebinding</code>后，可以访问在<code>default</code>命名空间下的任何资源，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrole</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-创建一个用户只能管理指定的命名空间"><a href="#8-3-创建一个用户只能管理指定的命名空间" class="headerlink" title="8.3 创建一个用户只能管理指定的命名空间"></a>8.3 创建一个用户只能管理指定的命名空间</h3><p>在实际的生产环境中，Master 的管理者可能有很多个，但不可能给人人都赋予 root 的权限，那么就可以创建新用户给其管理指定命名空间的权限。</p>
<ol>
<li>创建新用户，这时候该用户是使用不了 k8s 的</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd cqm</span><br><span class="line">passwd cqm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E7%BB%99%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%9F%90%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%80.png" alt="给用户管理某个命名空间一"></p>
<ol start="2">
<li>创建证书请求</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim cqm-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cqm&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ShenZhen&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ShenZhen&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k8s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>下载证书生成工具</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssl_1.6.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssljson_1.6.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssl-certinfo_1.6.0_linux_amd64</span><br><span class="line">mv cfssl_1.6.0_linux_amd64 cfssl</span><br><span class="line">mv cfssl-certinfo_1.6.0_linux_amd64 cfssl-certinfo</span><br><span class="line">mv cfssljson_1.6.0_linux_amd64 cfssljson</span><br><span class="line">chmod a+x cfssl*</span><br><span class="line">mv cfssl* /usr/local/bin</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>生成证书</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/pki</span><br><span class="line">cfssl gencert -ca=ca.crt -ca-key=ca.key -profile=kubernetes ~/cqm-csr.json | cfssljson -bare cqm</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>设置集群参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export KUBE_APISERVER=&quot;192.168.88.10:6443&quot;</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>设置客户端认证参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials cqm \</span><br><span class="line">--client-certificate=/etc/kubernetes/pki/cqm.pem  \</span><br><span class="line">--client-key=/etc/kubernetes/pki/cqm-key.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>设置上下文参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=cqm \</span><br><span class="line">--namespace=dev \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>进行 RoleBinding，这里的意思是指将常规用户 cqm 与 ClusterRole 的 admin 角色进行绑定，且指定 dev 的命名空间给 cqm，最终效果是 cqm 只能够访问和管理 dev 命名空间下的所有资源</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E7%BB%99%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%9F%90%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%BA%8C.png" alt="给用户管理某个命名空间二"></p>
<ol start="9">
<li>设置默认上下文</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/cqm/.kube</span><br><span class="line">cp cqm.kubeconfig /home/cqm/.kube/config</span><br><span class="line">chown cqm:cqm /home/cqm/.kube/config</span><br><span class="line">su cqm</span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=/home/cqm/.kube/config</span><br></pre></td></tr></table></figure>



<h2 id="九、k8s扩展"><a href="#九、k8s扩展" class="headerlink" title="九、k8s扩展"></a>九、k8s扩展</h2><h3 id="9-1-可视化管理——Kubernetes-Dashboard"><a href="#9-1-可视化管理——Kubernetes-Dashboard" class="headerlink" title="9.1 可视化管理——Kubernetes Dashboard"></a>9.1 可视化管理——Kubernetes Dashboard</h3><p>Kubernetes Dashboard 可以实现 k8s 的可视化管理，可以实现对 Pod、控制器、Service 等资源的创建和维护，并对它们进行持续监控。</p>
<h4 id="9-1-1-安装Kubernetes-Dashboard"><a href="#9-1-1-安装Kubernetes-Dashboard" class="headerlink" title="9.1.1 安装Kubernetes Dashboard"></a>9.1.1 安装Kubernetes Dashboard</h4><ol>
<li>下载</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>模板文件如下，将拉取镜像的地址改为国内地址，同时修改 SVC 模式为 NodePort，这样在集群之外也可以访问 Dashboard</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-csrf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">csrf:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-key-holder</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-settings</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="string">&quot;kubernetes-dashboard-certs&quot;</span>, <span class="string">&quot;kubernetes-dashboard-csrf&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-settings&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services/proxy&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;http:heapster:&quot;</span>, <span class="string">&quot;https:heapster:&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>, <span class="string">&quot;http:dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;metrics.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registery.cn-hangzhou.aliyuncs.com/google_containers/dashboard:v2.3.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--namespace=kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">seccomp.security.alpha.kubernetes.io/pod:</span> <span class="string">&#x27;runtime/default&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registery.cn-hangzhou.aliyuncs.com/google_containers/metrics-scraper:v1.0.6</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f Kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建完之后可以查看对应的 SVC，就可以通过浏览器访问了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%B8%80.png" alt="dashboard一"></p>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%BA%8C.png" alt="dashboard二"></p>
<ol start="5">
<li>RBAC 授权</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建ServiceAccount认证</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># 创建ClusterRoleBinding将dashboard-admin与集群角色cluster-admin进行绑定</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboardadmin-rbac</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>获取令牌并填入</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe secret dashboard-admin -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/dashboard%E4%B8%89.png" alt="dashboard三"></p>
<h4 id="9-1-2-Kubernetes-Dashboard使用"><a href="#9-1-2-Kubernetes-Dashboard使用" class="headerlink" title="9.1.2 Kubernetes Dashboard使用"></a>9.1.2 Kubernetes Dashboard使用</h4><ol>
<li>创建一个简单的 Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E5%9B%9B.png" alt="dashboard四"></p>
<ol start="2">
<li>查看 Pod 状态</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%BA%94.png" alt="dashboard五"></p>
<h3 id="9-2-资源监控——Prometheus和Grafana"><a href="#9-2-资源监控——Prometheus和Grafana" class="headerlink" title="9.2 资源监控——Prometheus和Grafana"></a>9.2 资源监控——Prometheus和Grafana</h3><h4 id="9-2-1-安装Prometheus"><a href="#9-2-1-安装Prometheus" class="headerlink" title="9.2.1 安装Prometheus"></a>9.2.1 安装Prometheus</h4><ol>
<li>进行 RBAC 授权</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.rbac.yml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 ConfigMap</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.configmap.yml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.deployment.yml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.service.yml</span><br></pre></td></tr></table></figure>

<h4 id="9-2-2-安装Grafana"><a href="#9-2-2-安装Grafana" class="headerlink" title="9.2.2 安装Grafana"></a>9.2.2 安装Grafana</h4><ol>
<li>配置 Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/grafana.deployment.yml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/grafana.service.yml</span><br></pre></td></tr></table></figure>

<h4 id="9-2-3-Prometheus和Grafana的使用"><a href="#9-2-3-Prometheus和Grafana的使用" class="headerlink" title="9.2.3 Prometheus和Grafana的使用"></a>9.2.3 Prometheus和Grafana的使用</h4><ol>
<li>添加数据源</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%B8%80.png" alt="监控一"></p>
<ol start="2">
<li>使用模板，这里使用代号为 315 的 k8s 监控模板</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%BA%8C.png" alt="监控二"></p>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%B8%89.png" alt="监控三"></p>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E5%9B%9B.png" alt="监控四"></p>
<ol start="3">
<li>效果</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%BA%94.png" alt="监控五"></p>
<h3 id="9-3-日志管理——ElasticSearch、Fluentd、Kibana"><a href="#9-3-日志管理——ElasticSearch、Fluentd、Kibana" class="headerlink" title="9.3 日志管理——ElasticSearch、Fluentd、Kibana"></a>9.3 日志管理——ElasticSearch、Fluentd、Kibana</h3><p>k8s 推荐采用 ElasticSearch、Fluentd、Kibana（简称EFK）三者组合的方式，对集群的日志进行手机和查询，关系如下：</p>
<ul>
<li>ElasticSearch 是一种搜索引擎，用于存储日志并进行查询。</li>
<li>Fluentd 用于将日志消息从 k8s 发送到 ElasticSearch。</li>
<li>Kibana 是一种图形界面，用于查询 ElasticSearch 中的日志。</li>
</ul>
<p><img src="/2024/02/18/kubernetes/%E6%97%A5%E5%BF%97%E6%9E%B6%E6%9E%84.png" alt="日志架构"></p>
<p>EFK 之间的交互如下：</p>
<ul>
<li>容器运行时会将日志输出到控制台，并以 ”-json.log“ 结尾将日志文件存放到 <code>/var/lib/docker/containers</code> 目录中，而 <code>/var/log</code> 是 linux 系统的日志。</li>
<li>在各个 Node 上运行的 Fluentd 将是收集这些日志，并发送给 ElasticSearch。</li>
<li>Kibana 是直接与用户交互的界面，可以查询 ElasticSearch 中的日志。</li>
</ul>
<h4 id="9-3-1-安装EFK"><a href="#9-3-1-安装EFK" class="headerlink" title="9.3.1 安装EFK"></a>9.3.1 安装EFK</h4><ol>
<li>配置命名空间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/create-logging-namespace.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 Fluentd 的 ConfigMap</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/fluentd-es-configmap.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装 Fluentd</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/fluentd-es-ds.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装 ElasticSearch</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/es-statefulset.yaml</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>配置 ElasticSearch 的 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/es-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>安装 Kibana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/kibana-deployment.yaml</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>配置 Kibana 的 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl applt -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/kibana-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>获取 Kibana 访问地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info | grep Kibana</span><br></pre></td></tr></table></figure>



<h2 id="十、项目部署"><a href="#十、项目部署" class="headerlink" title="十、项目部署"></a>十、项目部署</h2><h3 id="10-1-无状态项目部署"><a href="#10-1-无状态项目部署" class="headerlink" title="10.1 无状态项目部署"></a>10.1 无状态项目部署</h3><p>Guestbook 是一个无状态的多层 Web 应用程序，是一个简单的留言板程序，包含一下三个部分，并拥有读写分离机制：</p>
<ol>
<li>前端应用：Guestbook 留言板应用，将部署多个实例供用户访问。</li>
<li>后端存储（写）：Redis 主应用，用于写入留言信息，只部署一个案例。</li>
<li>后端存储（读）：Redis 从属应用，用域读取留言信息，将部署多个案例。</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" alt="无状态服务架构"></p>
<ol>
<li>部署 Redis 主实例</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-master-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-master-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>部署 Redis 主实例 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>部署 Redis 从属实例</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-slave-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-slave-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-slave-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>部署 Redis 从属实例 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-slave-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>部署 Guestbook</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">guestbook-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">guestbook-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">guestbook-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubeguide/guestbook-php-frontend</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>部署 Guestbook 的 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">guestbook-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30222</span></span><br></pre></td></tr></table></figure>

<h3 id="10-2-有状态项目部署"><a href="#10-2-有状态项目部署" class="headerlink" title="10.2 有状态项目部署"></a>10.2 有状态项目部署</h3><p>WordPress 是使用 PHP 开发的开源个人博客平台，是一套非常完善的内容管理系统，支持非常丰富的插件和模板，主要包含以下两个部分：</p>
<ul>
<li>前端应用：WordPress。</li>
<li>后端应用：MySQL 数据库，使用 PVC 来存储博客的数据。</li>
</ul>
<p><img src="/2024/02/18/kubernetes/%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" alt="有状态服务架构"></p>
<ol>
<li>首先生成一个数据库密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &#x27;toortoor&#x27; | base64</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建一个 Secret 存放密码</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Qpaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mysql_password:</span> <span class="string">dG9vcnRvb3I=</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>部署 nfs-client，实现自动分配 PV 给 PVC，步骤参照 6.3.2</li>
<li>部署 MySQL</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storageclass</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/mysql:5.7</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_password</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-datadir</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>部署 WordPress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30111</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-pvc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storageclass</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">wordpress-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/daocloud/dao-wordpress:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="comment"># 这里用到了MySQL的变量参数</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># Mysql的SVC名称</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">mysql-service</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_password</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/www/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-datadir</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">wordpress-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>部署 Ingress，通过 <code>www.cqm.com:30111</code> 就能访问 WordPress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/var/www/html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">wordpress-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">30111</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E4%B8%80.png" alt="有状态服务一"></p>
<h3 id="10-3-使用Helm部署项目"><a href="#10-3-使用Helm部署项目" class="headerlink" title="10.3 使用Helm部署项目"></a>10.3 使用Helm部署项目</h3><p>Helm 是 k8s 的一个子项目，是一种 k8s 包管理平台，它能够定义、部署、升级非常复杂的 k8s 应用集合，并进行版本管理。</p>
<p><img src="/2024/02/18/kubernetes/Helm%E6%9E%B6%E6%9E%84.png" alt="Helm架构"></p>
<ul>
<li>Helm 客户端：是一种远程命令客户端工具，主要用于 Chart 文件的创建、打包和发布部署，以及和 Chart 仓库的管理。Helm 发出的请求，根据 Chart 结构生成发布对象，并将 Chart 解析成各个 k8s 资源的实际部署文件，供 k8s 创建相应资源，同时还提供发布对象的更新、回滚、统一删除等功能。</li>
<li>Chart：是应用程序的部署定义，包含各种 yaml 文件，可以采用 TAR 格式打包。</li>
<li>Chart 仓库：Helm 中存放了各种应用程序的 Chart 包以供用户下载，Helm 可以同时管理多个 Chart 仓库，默认情况下管理一个本地仓库和一个远程仓库。</li>
<li>发布对象：在 k8s 集群中部署的 Chart 称为发布对象，Chart 和发布对象的关系类似于镜像和容器，前者是部署的定义，后者是实际部署好的应用程序。</li>
</ul>
<h4 id="10-3-1-Helm安装"><a href="#10-3-1-Helm安装" class="headerlink" title="10.3.1 Helm安装"></a>10.3.1 Helm安装</h4><ol>
<li>安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.6.2-linux-amd64.tar.gz</span><br><span class="line">tar -xf helm-v3.6.2-linux-amd64.tar.gz</span><br><span class="line">cp linux-amd64/helm /usr/local/bin/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置环境变量 KUBECONFIG 来指定存有 ApiServre 的地址与 token 的配置文件地址，默认为~&#x2F;.kube&#x2F;config</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/root/.kube/config</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 Helm 仓库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">helm repo add incubator https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/</span><br></pre></td></tr></table></figure>

<h4 id="10-3-2-Helm-Chart的基本操作"><a href="#10-3-2-Helm-Chart的基本操作" class="headerlink" title="10.3.2 Helm Chart的基本操作"></a>10.3.2 Helm Chart的基本操作</h4><p><strong>Chart 的创建</strong></p>
<ol>
<li>创建 Chart</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create chart名称</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行后会在当前目录下创建一个文件，可用 tree 命令查看该目录结构</li>
</ol>
<p><img src="/2024/02/18/kubernetes/Helm%E4%B8%80.png" alt="Helm一"></p>
<ul>
<li>chars：存放该 Chart 以来的所有子 Chart 的目录，这些子 Chart 也拥有这 4 个部分，如果有子 Chart ，则需要在父 Chart 创建一个 <code>requirements.yaml</code> 文件，在文件中记录这些子 Chart。</li>
<li>Chart.yaml：记录该 Chart 的相关信息，并定义在文件中的 <code>.Chart</code> 开头的属性值。</li>
<li>template：存放了 k8s 部署文件的 Helm 模板，其中扩展了 Go Template 语法。</li>
<li>values.yaml：定义在文件中的 <code>.Values</code> 开头的属性值。</li>
<li>_helpers.tpl：它是一个i模板助手文件，用于定义通用信息，然后在其他地方使用。</li>
<li>NOTES.txt：会在 Chart 部署命令后，代入具体的参数值，产生说明信息。</li>
<li>test-connection.yaml：用于定义部署完成后需要执行的测试内容，以便测试是否部署成功。</li>
</ul>
<p><strong>Chart 的验证</strong></p>
<ol>
<li>在发布 Chart 之前，可以通过命令检查 Chart 文件是否有误，如下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm lint chart目录/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>同时也可以用命令将各项值组合为 k8s 的 yaml 文件，查看是否为预期内容，比如下图就是其中 Deployment 的内容</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install --dry-run --debug 发布名称 -name chart目录名称</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/Helm%E4%BA%8C.png" alt="Helm二"></p>
<p><strong>Chart 的发布</strong></p>
<ol>
<li>Chart 的发布命令如下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install 发布版本名称 chart文件目录</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看目前发布的版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm list</span><br></pre></td></tr></table></figure>

<p><strong>将 Chart 打包到仓库中</strong></p>
<ol>
<li>查看仓库命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看仓库中的包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm search repo/hub</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以在后面加上应用名，如</span></span><br><span class="line">helm search repo/hub nginx</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>首先打包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm package chart目录</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装 Push 插件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm plugin install https://github.com/chartmuseum/helm-push.git</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>上传</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm push tar包名 仓库</span><br></pre></td></tr></table></figure>

<p><strong>发布版本的更新、回滚和删除</strong></p>
<ol>
<li>更新</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade 发布版本名称 chart目录或tar flags</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看历史版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm history 发布版本名称</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>回滚</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm rollback 发布版本名称 版本号</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>删除</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete 发布版本名称</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:14:58.446Z" title="2/18/2024, 5:14:58 PM">2024-02-18</time></span><span class="level-item">6 minutes read (About 850 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/nexus/">Nexus</a></p><div class="content"><p>Nexus 是一个用于专门搭建 Maven 仓库的软件，除了作为 Maven 仓库，它还能够作为 Docker 镜像仓库、Yum 仓库等等。</p>
<h2 id="Nexus-部署"><a href="#Nexus-部署" class="headerlink" title="Nexus 部署"></a>Nexus 部署</h2><p><strong>deploy.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-mount-hack</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;-c&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;chown -R 200:200 /nexus-data&#x27;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nexus-data</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">sonatype/nexus3:3.37.3</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INSTALL4J_ADD_VM_PARAMS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;-Xms2703m -Xmx2703m -XX:MaxDirectMemorySize=2703m -Djava.util.prefs.userRoot=$&#123;NEXUS_DATA&#125;/javaprefs&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2048Mi</span>      </span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2048Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nexus-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">        <span class="comment"># 自行修改挂载类型，不修改则需创建对应PV和PVC👇</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nexus-data</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br></pre></td></tr></table></figure>

<p>部署后，在容器内部获取 admin 密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $(cat /nexus-data/admin.password)</span><br></pre></td></tr></table></figure>

<h2 id="默认仓库说明"><a href="#默认仓库说明" class="headerlink" title="默认仓库说明"></a>默认仓库说明</h2><ul>
<li>maven-central：中央仓库，默认从 <code>https://repo1.maven.org/maven2/</code> 拉取 jar 包</li>
<li>maven-releases：私库发行 jar，建议将设置改为 <code>Allow redeploy</code></li>
<li>maven-snapshots：私库快照 jar，即库中的 jar 均为调试版本</li>
<li>maven-public：仓库分组，把上面三个仓库组合在一起对外提供服务，在本地 maven 的 settings.xml 文件或项目的 pom.xml 文件设置为该仓库地址，即可调用</li>
</ul>
<h2 id="仓库类型说明"><a href="#仓库类型说明" class="headerlink" title="仓库类型说明"></a>仓库类型说明</h2><ul>
<li>group：仓库组，起到了聚合的作用，在该组中的仓库都可以通过该组的 URL 进行访问</li>
<li>hosted：私有仓库，顾名思义，用来存储自己的 jar 包</li>
<li>snapshot：快照仓库</li>
<li>release：本地项目的正式版本仓库</li>
<li>proxy：代理，Nexus 的 maven-central 就是这种类型，代理地址为 <code>https://repo1.maven.org/maven2/</code> ，默认会去该地址下拉取 jar 包</li>
<li>central：中央仓库</li>
</ul>
<h2 id="新增代理仓库"><a href="#新增代理仓库" class="headerlink" title="新增代理仓库"></a>新增代理仓库</h2><p>创建仓库选择 <code>maven2(proxy)</code> 类型</p>
<p><img src="/2024/02/18/nexus/%E6%96%B0%E5%A2%9E%E4%BB%A3%E7%90%86%E4%BB%93%E5%BA%93.png" alt="新增代理仓库"></p>
<p>添加到 <code>maven-public</code></p>
<p><img src="/2024/02/18/nexus/%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%BB%84.png" alt="添加到组"></p>
<h2 id="Maven-配置使用私服"><a href="#Maven-配置使用私服" class="headerlink" title="Maven 配置使用私服"></a>Maven 配置使用私服</h2><p>要在本地 Maven 在私服拉取 jar 的方式有两种：</p>
<ul>
<li>settings.xml：全局配置模式</li>
<li>pom.xml：项目独享模式</li>
</ul>
<p>如果两种方式都配置了，那么以 pom.xml 文件配置为准。</p>
<p>当我们通过 Maven 使用 Nexus 的 <code>maven-public</code> 的时候，会按照以下方式顺序访问：</p>
<ol>
<li><p>本地仓库</p>
</li>
<li><p>私服 maven-releases</p>
</li>
<li><p>私服 maven-snapshots</p>
</li>
<li><p>远程阿里 maven 仓库</p>
</li>
<li><p>远程中央仓库</p>
</li>
</ol>
<h3 id="通过-settings-xml-文件配置"><a href="#通过-settings-xml-文件配置" class="headerlink" title="通过 settings.xml 文件配置"></a>通过 settings.xml 文件配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- servers块中添加用户认证信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">password</span>&gt;</span>changeme<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mirrors块中添加maven-public信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 唯一标识符 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line">   <span class="comment">&lt;!-- 名称 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>cqm maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- maven-public地址 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.159.11:35826/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- *指的是访问任何仓库都使用我们的私服，可设置为central等等 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以设置为阿里的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="通过-pom-xml-文件配置"><a href="#通过-pom-xml-文件配置" class="headerlink" title="通过 pom.xml 文件配置"></a>通过 pom.xml 文件配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>mnexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>cqm nexus<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.159.11:35826/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同样也可以设置为阿里的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>fail<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用-Maven-批量向-Nexus-上传"><a href="#使用-Maven-批量向-Nexus-上传" class="headerlink" title="使用 Maven 批量向 Nexus 上传"></a>使用 Maven 批量向 Nexus 上传</h2><p>首先需要将 <code>.m2/repository</code> 下的相应 jar 包和 pom 文件 cp 出来，再进行 deploy。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-DrepositoryId 参数调用了 settings.xml 中 servers 块的账号密码进行认证</span></span><br><span class="line">find . -name &quot;*.jar&quot; | awk &#x27;&#123; gsub(&quot;\.jar$&quot;,&quot;&quot;,$0); print &quot;mvn deploy:deploy-file -Dfile=&quot;$0&quot;.jar -DpomFile=&quot;$0&quot;.pom -Dpackaging=jar -DrepositoryId=nexus -Durl=\&quot;http://nexus-path\&quot;&quot;&#125;&#x27;	</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:05:34.526Z" title="2/18/2024, 7:05:34 PM">2024-02-18</time></span><span class="level-item">31 minutes read (About 4642 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/prometheus/">Prometheus</a></p><div class="content"><p><img src="/2024/02/18/prometheus/prometheus_logo.jpg" alt="prometheus_logo"></p>
<p>Prometheus是一个开源的<strong>云原生</strong>监控系统和时间序列数据库。</p>
<h2 id="一、Prometheus概述"><a href="#一、Prometheus概述" class="headerlink" title="一、Prometheus概述"></a>一、Prometheus概述</h2><p>Prometheus 作为新一代的云原生监控系统，目前已经有超过 650+位贡献者参与到 Prometheus 的研发工作上，并且超过 120+项的第三方集成。</p>
<h3 id="1-1-Prometheus的优点"><a href="#1-1-Prometheus的优点" class="headerlink" title="1.1 Prometheus的优点"></a>1.1 Prometheus的优点</h3><ol>
<li><strong>提供多维度数据模型和灵活的查询方式</strong>，通过将监控指标关联多个 tag，来将监控数据进行任意维度的组合，并且提供简单的 PromQL 查询方式，还提供 HTTP 查询接口，可以很方便地结合 Grafana 等 GUI 组件展示数据。</li>
<li>在不依赖外部存储的情况下，<strong>支持服务器节点的本地存储</strong>，通过 Prometheus 自带的时序数据库，可以完成每秒千万级的数据存储；不仅如此，在保存大量历史数据的场景中，Prometheus 可以对接第三方时序数据库和 OpenTSDB 等。</li>
<li><strong>定义了开放指标数据标准</strong>，以基于 HTTP 的 Pull 方式采集时序数据，只有实现了 Prometheus 监控数据才可以被 Prometheus 采集、汇总、并支持 Push 方式向中间网关推送时序列数据，能更加灵活地应对多种监控场景。</li>
<li><strong>支持通过静态文件配置和动态发现机制发现监控对象，自动完成数据采集</strong>。</li>
<li>Prometheus 目前已经支持 Kubernetes、etcd、Consul 等多种服务发现机制。<strong>易于维护</strong>，可以通过二进制文件直接启动，并且提供了容器化部署镜像。</li>
<li><strong>支持数据的分区采样和联邦部署，支持大规模集群监控。</strong></li>
</ol>
<h3 id="1-2-Prometheus基本组件"><a href="#1-2-Prometheus基本组件" class="headerlink" title="1.2 Prometheus基本组件"></a>1.2 Prometheus基本组件</h3><ol>
<li>Prometheus Server：是 Prometheus 组件中的核心部分，负责实现对监控数据的获取，存储以及查询。收集到的数据统称为<strong>metrics</strong>。</li>
<li>Push Gateway：当网络需求无法直接满足时，就可以利用 Push Gateway 来进行中转。可以通过 Push Gateway 将内部网络的监控数据主动 <strong>Push</strong> 到 Gateway 当中。而 Prometheus Server 则可以采用同样 <strong>Pull</strong> 的方式从 Push Gateway 中获取到监控数据。</li>
<li>Exporter：主要用来采集数据，并通过 HTTP 服务的形式暴露给 Prometheus Server，Prometheus Server 通过访问该 Exporter 提供的接口，即可获取到需要采集的监控数据。</li>
<li>Alert manager：管理告警，主要是负责实现报警功能。现在grafana也能实现报警功能，所以也慢慢被取代。</li>
</ol>
<p><img src="/2024/02/18/prometheus/Prometheus%E6%9E%B6%E6%9E%84.png" alt="Prometheus架构"></p>
<h3 id="1-3-Prometheus数据类型"><a href="#1-3-Prometheus数据类型" class="headerlink" title="1.3 Prometheus数据类型"></a>1.3 Prometheus数据类型</h3><ol>
<li>Counter（计数器类型）：Counter类型的指标的工作方式和计数器一样，只增不减（除非系统发生了重置）。</li>
<li>Gauge（仪表盘类型）：Gauge是可增可减的指标类，可以用于反应当前应用的状态。</li>
<li>Histogram（直方图类型）：主要用于表示一段时间范围内对数据进行采样（通常是请求持续时间或响应大小），并能够对其指定区间以及总数进行统计，通常它采集的数据展示为直方图。</li>
<li>Summary（摘要类型）：主要用于表示一段时间内数据采样结果（通常是请求持续时间或响应大小）。</li>
</ol>
<h2 id="二、Prometheus安装"><a href="#二、Prometheus安装" class="headerlink" title="二、Prometheus安装"></a>二、Prometheus安装</h2><h3 id="2-1-Prometheus-server安装"><a href="#2-1-Prometheus-server安装" class="headerlink" title="2.1 Prometheus server安装"></a>2.1 Prometheus server安装</h3><ol>
<li>Prometheus安装较为简单，下载解压即可</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.26.0-rc.0/prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.26.0-rc.0.linux-amd64 prometheus</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>prometheus.yml配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> <span class="comment"># 设置抓取间隔，默认为1分钟</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># 估算规则的默认周期，每15秒计算一次规则，默认1分钟</span></span><br><span class="line">  <span class="comment"># scrape_timeout # 默认抓取超时，默认为10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报警配置</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则文件列表，使用&#x27;evaluation_interval&#x27; 参数去抓取</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置列表</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># 任务名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="comment"># 要被监控的客户端</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建Prometheus的用户及数据存储目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd prometheus</span><br><span class="line">useradd -g prometheus -s /sbin/nologin prometheus</span><br><span class="line">mkdir /root/prometheus/data</span><br><span class="line">chown -R prometheus:prometheus /root/prometheus</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Prometheus的启动很简单，只需要直接启动解压目录的二进制文件Prometheus即可，但是为了更加方便对Prometheus进行管理，这里编写脚本或者使用screen工具来进行启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /root/prometheus/start.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">prometheus_dir=/root/prometheus</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;prometheus_dir&#125;/prometheus --config.file=<span class="variable">$&#123;prometheus_dir&#125;</span>/prometheus.yml --storage.tsdb.path=<span class="variable">$&#123;prometheus_dir&#125;</span>/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--config.file:指定配置文件路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.path:指定tsdb路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.retention.time:指定数据存储时间</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--web.enable-lifecycle:类似nginx的reload功能</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.no-lockfile:如果用k8s的deployment管理需加此项</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动Prometheus后访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">nohup</span>英文全称no hang up（不挂起），用于在系统后台不挂断地运行命令，退出终端不会影响程序的运行。</span></span><br><span class="line">nohup sh start.sh 2&gt;&amp;1 &gt; prometheus.log</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/Prometheus%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="Prometheus安装一"></p>
<ol start="6">
<li>用screen工具进行启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入后台</span></span><br><span class="line">screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行脚本</span></span><br><span class="line">/root/prometheus/prometheus --config.file=/root/prometheus/prometheus.yml --storage.tsdb.path=/root/prometheus/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入CTRL + A + D撤回前台</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看后台运行的脚本</span></span><br><span class="line">screen -ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回后台</span></span><br><span class="line">screen -r 后台id</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除后台</span></span><br><span class="line">screen -S 后台id -X quit</span><br></pre></td></tr></table></figure>

<h3 id="2-2-node-exporter安装"><a href="#2-2-node-exporter安装" class="headerlink" title="2.2 node exporter安装"></a>2.2 node exporter安装</h3><p>在Prometheus架构中，exporter是负责收集数据并将信息汇报给Prometheus Server的组件。官方提供了node_exporter内置了对主机系统的基础监控。</p>
<ol>
<li>下载node exporter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">tar -xf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">mv node_exporter-1.1.2.linux-amd64.tar.gz node_exporter</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在prometheus.yml中添加被监控主机</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>,<span class="string">&#x27;localhost:9100&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>后台启动exporter和重启prometheus</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过curl命令获取收集到的数据key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9100/metrics</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>用其中的一个key在Prometheus测试是否被监控</li>
</ol>
<p><img src="/2024/02/18/prometheus/node_exporter%E6%B5%8B%E8%AF%95.png" alt="node_exporter测试"></p>
<h2 id="三、Prometheus命令行的使用"><a href="#三、Prometheus命令行的使用" class="headerlink" title="三、Prometheus命令行的使用"></a>三、Prometheus命令行的使用</h2><h3 id="3-1-计算cpu使用率"><a href="#3-1-计算cpu使用率" class="headerlink" title="3.1 计算cpu使用率"></a>3.1 计算cpu使用率</h3><p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png" alt="计算cpu使用率一"></p>
<p>通过上图可以知道，linux的cpu使用是分为很多种状态的，例如用户态user，空闲态idle。</p>
<p>要计算cpu的使用率有两种粗略的公式：</p>
<ol>
<li>除去idle状态的所有cpu状态时间之和 &#x2F; cpu时间总和</li>
<li>100% - （idle状态 &#x2F; cpu时间总和）</li>
</ol>
<p>但这两种方式都存在两个问题：</p>
<ol>
<li>如何计算某一时间段的cpu使用率？例如精确到每一分钟。</li>
<li>实际工作中cpu大多数都是多核的，node exporter截取到的数据精确到了每个核，如何监控所有核加起来的数据？</li>
</ol>
<p>Prometheus提供了许多的函数，其中 increase 和 sum 就很好的解决了以上两个问题。</p>
<ol>
<li>提取cpu的key，即node_cpu_seconds_total</li>
<li>把idle空闲时间和总时间过滤出来，在Prometheus中使用{}进行过滤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用increase函数取一分钟内的增量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用sum函数将每个核的数整合起来</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m]))</span><br></pre></td></tr></table></figure>

<p>到这里又出现一个问题，sum函数会将所有数据整合起来，不光将一台机器的所有cpu加到一起，也将所有机器的cpu都加到了一起，最终显示的是集群cpu的总平均值，by(instance)可以解决这个问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)</span><br></pre></td></tr></table></figure>

<p>这样就得到了空闲时cpu的数据了，用上边第一个公式即可得到单台主机cpu在一分钟内的使用率。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png" alt="计算cpu使用率二"></p>
<h3 id="3-2-计算内存使用率"><a href="#3-2-计算内存使用率" class="headerlink" title="3.2 计算内存使用率"></a>3.2 计算内存使用率</h3><p>内存使用率公式为 &#x3D; (available &#x2F; total) * 100</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87.png" alt="计算内存使用率"></p>
<h3 id="3-3-rate函数"><a href="#3-3-rate函数" class="headerlink" title="3.3 rate函数"></a>3.3 rate函数</h3><p>rate函数是专门搭配counter类型数据使用的函数，功能是按照设置的一个时间段，取counter在这个时间段中平均每秒的增量。</p>
<p>举个栗子，假设我们要取ens33这个网卡在一分钟内字节的接受数量，假如一分钟内接收到的是1000bytes，那么平均每秒接收到就是1000bytes &#x2F; 1m * 60s ≈ 16bytes&#x2F;s。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_network_receive_bytes_total&#123;device=&#x27;ens33&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<p>如果是五分钟的话即为5000bytes &#x2F; 5m * 60s ≈ 16bytes&#x2F;s，结果是一样的，但曲线图就不一样了，上图为一分钟，下图为五分钟，因为五分钟的密度要更底，所以可以看到五分钟的曲线图更加平缓。</p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%B8%80.png" alt="rate函数一"></p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%BA%8C.png" alt="rate函数二"></p>
<p>rate和increase的概念有些类似，但rate取的是一段时间增量的平均每秒数量，increase取的是一段时间增量的总量，即：</p>
<ul>
<li>rate(1m)：总量 &#x2F; 60s</li>
<li>increase(1m)：总量</li>
</ul>
<h3 id="3-4-sum函数"><a href="#3-4-sum函数" class="headerlink" title="3.4 sum函数"></a>3.4 sum函数</h3><p>sum函数就是将收到的数据全部进行整合。</p>
<p>假如一个集群里有20台服务器，分别为5台web服务器，10台db服务器，还有5台其他服务的服务器，这时候sum就可以分为三条曲线来代表不同功能服务器的总和数据。</p>
<h3 id="3-5-topk函数"><a href="#3-5-topk函数" class="headerlink" title="3.5 topk函数"></a>3.5 topk函数</h3><p>topk函数的作用就是取前几位的最高值。</p>
<p><img src="/2024/02/18/prometheus/topk%E5%87%BD%E6%95%B0%E4%B8%80.png" alt="topk函数一"></p>
<h3 id="3-6-count函数"><a href="#3-6-count函数" class="headerlink" title="3.6 count函数"></a>3.6 count函数</h3><p>count函数的作用是把符合条件的数值进行整合。</p>
<p>假如我们要查看集群中cpu使用率超过80%的主机数量的话</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count((1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100 &gt; 80)</span><br></pre></td></tr></table></figure>



<h2 id="四、Push-gateway"><a href="#四、Push-gateway" class="headerlink" title="四、Push gateway"></a>四、Push gateway</h2><p>Push gateway实际上就是一种被动推送数据的方式，与exporter主动获取不同。</p>
<h3 id="4-1-Push-gateway安装"><a href="#4-1-Push-gateway安装" class="headerlink" title="4.1 Push gateway安装"></a>4.1 Push gateway安装</h3><ol>
<li>下载安装Push gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/pushgateway/releases/download/v1.4.0/pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">mv pushgateway-1.4.0.linux-amd64 pushgateway</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>后台运行Push gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/pushgateway/pushgateway</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在prometheus.yml中加上</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;pushgateway&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&#x27;localhost:9091&#x27;]</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E6%B7%BB%E5%8A%A0pushgateway.png" alt="添加pushgateway"></p>
<h3 id="4-2-自定义编写脚本"><a href="#4-2-自定义编写脚本" class="headerlink" title="4.2 自定义编写脚本"></a>4.2 自定义编写脚本</h3><p>由于Push gateway自己本身是没有任何抓取数据的功能的，所以用户需要自行编写脚本来抓取数据。</p>
<p>举个例子：编写脚本抓取 TCP waiting_connection 的数量</p>
<ol>
<li>编写自定义脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取监控主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果主机名为localhost，则退出</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;不能监控主机名为localhost的主机&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取TCP CONNECTED数量</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">抓取TCP CONNECTED数量，定义为一个新key</span></span><br><span class="line">lable_tcp_connected=&quot;count_netstat_connected_connections&quot;</span><br><span class="line">count_netstat_connected_connections=`netstat -an | grep &#x27;CONNECTED&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_connected $count_netstat_connected_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该脚本是通过post的方式将key推送给pushgateway</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://localhost:9091 即推送给哪台pushgateway主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">job/pushgateway 即推送给prometheus.yml中定义的job为pushgateway的主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">instance/<span class="variable">$instance_name</span> 推送后显示的主机名</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>因为脚本都是运行一次后就结束了，可以配合crontab反复运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每分钟执行一次脚本</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每10s执行一次脚本</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC.png" alt="自定义编写脚本"></p>
<h3 id="4-3-编写抓取ping丢包和延迟时间数据"><a href="#4-3-编写抓取ping丢包和延迟时间数据" class="headerlink" title="4.3 编写抓取ping丢包和延迟时间数据"></a>4.3 编写抓取ping丢包和延迟时间数据</h3><p>在node_exporter_shell.sh中加入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取ping某网站丢包率和延迟时间</span></span><br><span class="line"></span><br><span class="line">site_address=&quot;www.baidu.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取丢包率和延迟时间，定义为两个新key</span></span><br><span class="line">lable_ping_packet_loss=&quot;ping_packet_loss&quot;</span><br><span class="line">ping_packet_loss_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $6&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串截取，%?为去除最后一个字符</span></span><br><span class="line">ping_packet_loss=`echo $&#123;ping_packet_loss_test%?&#125;`</span><br><span class="line"></span><br><span class="line">lable_ping_time=&quot;ping_time&quot;</span><br><span class="line">ping_time_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $10&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串截取，%??为去除最后两个字符</span></span><br><span class="line">ping_time=`echo $&#123;ping_time_test%??&#125;`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至push_ping_timegateway</span></span><br><span class="line">echo &quot;$lable_ping_packet_loss $ping_packet_loss&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"></span><br><span class="line">echo &quot;$lable_ping_time $ping_time&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>



<h2 id="五、Grafana的使用"><a href="#五、Grafana的使用" class="headerlink" title="五、Grafana的使用"></a>五、Grafana的使用</h2><p>Grafana是一款用Go语言开发的开源数据可视化工具，可以做数据监控和数据统计，带有告警功能。</p>
<h3 id="5-1-Grafana安装"><a href="#5-1-Grafana安装" class="headerlink" title="5.1 Grafana安装"></a>5.1 Grafana安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">yum -y install grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl enable grafana-server</span><br></pre></td></tr></table></figure>

<h3 id="5-2-设置数据源"><a href="#5-2-设置数据源" class="headerlink" title="5.2 设置数据源"></a>5.2 设置数据源</h3><ol>
<li>Grafana -&gt; Configuration -&gt; Date Sources -&gt; Prometheus</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="Grafana安装一"></p>
<ol start="2">
<li>New dashboard</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%BA%8C.png" alt="Grafana安装二"></p>
<ol start="3">
<li>添加一个监控和CPU内存使用率的仪表盘</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%89.png" alt="Grafana安装三"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E5%9B%9B.png" alt="Grafana安装四"></p>
<h3 id="5-3-json备份和还原"><a href="#5-3-json备份和还原" class="headerlink" title="5.3 json备份和还原"></a>5.3 json备份和还原</h3><ol>
<li>备份：dashboard -&gt; Settings -&gt; JSON Model，将里面内容保存为json文件</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E5%A4%87%E4%BB%BD.png" alt="JSON备份"></p>
<ol start="2">
<li>恢复：Create -&gt; import</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E8%BF%98%E5%8E%9F.png" alt="JSON还原"></p>
<h3 id="5-4-Grafana实现报警功能"><a href="#5-4-Grafana实现报警功能" class="headerlink" title="5.4 Grafana实现报警功能"></a>5.4 Grafana实现报警功能</h3><ol>
<li>配置Grafana文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖和图形显示插件</span></span><br><span class="line">yum -y install libatk-bridge* libXss* libgtk*</span><br><span class="line">grafana-cli plugins install grafana-image-renderer</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置</span></span><br><span class="line">vim /etc/grafana/grafana.ini</span><br><span class="line">enabled = true</span><br><span class="line">host = smtp.163.com:25</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送报警邮件的邮箱</span></span><br><span class="line">user = chenqiming13@163.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">授权码</span></span><br><span class="line">password = QXQALYMTRYRWIOOS</span><br><span class="line">skip_verify = true</span><br><span class="line">from_address = chenqiming13@163.com</span><br><span class="line">from_name = Grafana</span><br><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建报警规则</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%80.png" alt="Grafana实现报警功能一"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%8C.png" alt="Grafana实现报警功能二"></p>
<ol start="3">
<li>针对具体监控项，设置发送邮件阈值等，这里设置为发现超过阈值起5分钟后触发报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%89.png" alt="Grafana实现报警功能三"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%9B%9B.png" alt="Grafana实现报警功能四"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%94.png" alt="Grafana实现报警功能五"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%85%AD.png" alt="Grafana实现报警功能六"></p>
<p>![Grafana实现报警功能七](Grafana实现报警功能七.png</p>
<h2 id="六、Prometheus-Grafana实际案例"><a href="#六、Prometheus-Grafana实际案例" class="headerlink" title="六、Prometheus + Grafana实际案例"></a>六、Prometheus + Grafana实际案例</h2><h3 id="6-1-predict-linear函数实现硬盘监控"><a href="#6-1-predict-linear函数实现硬盘监控" class="headerlink" title="6.1 predict_linear函数实现硬盘监控"></a>6.1 predict_linear函数实现硬盘监控</h3><p>硬盘使用率公式为：（（总容量 - 剩余容量）&#x2F;  总容量）* 100，在Prometheus中表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes) * 100</span><br></pre></td></tr></table></figure>

<p>通过df -m可以看出计算出来的值是正确的</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png" alt="计算硬盘使用率一"></p>
<p>Prometheus提供了一个predict_linear函数可以预计多长时间磁盘爆满，例如当前这1个小时的磁盘可用率急剧下降，这种情况可能导致磁盘很快被写满，这时可以使用该函数，用当前1小时的数据去预测未来几个小时的状态，实现提前报警。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该式子表示用当前1小时的值来预测未来4小时后如果根目录下容量小于0则触发报警</span></span><br><span class="line">predict_linear(node_filesystem_free_bytes &#123;mountpoint =&quot;/&quot;&#125;[1h], 4*3600) &lt; 0</span><br></pre></td></tr></table></figure>

<p>在Grafana添加监控硬盘使用率和预测硬盘使用率的仪表盘</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png" alt="计算硬盘使用率二"></p>
<h3 id="6-2-监控硬盘IO"><a href="#6-2-监控硬盘IO" class="headerlink" title="6.2 监控硬盘IO"></a>6.2 监控硬盘IO</h3><p>公式为：（读取时间 &#x2F; 写入时间）&#x2F; 1024 &#x2F; 1024，用rate函数取一分钟内读和写的字节增长率来计算，用Prometheus表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((rate(node_disk_read_bytes_total[1m]) + rate(node_disk_written_bytes_total[1m])) / 1024 / 1024) &gt; 0</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7IO%E7%8A%B6%E6%80%81.png" alt="监控IO状态"></p>
<h3 id="6-3-监控TCP-WAIT状态的数量"><a href="#6-3-监控TCP-WAIT状态的数量" class="headerlink" title="6.3 监控TCP_WAIT状态的数量"></a>6.3 监控TCP_WAIT状态的数量</h3><p>在被监控主机上编写监控脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取监控主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果主机名为localhost，则退出</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;不能监控主机名为localhost的主机&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取TCP WAIT数量</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">抓取TCP WAIT数量，定义为一个新key</span></span><br><span class="line">lable_tcp_wait=&quot;count_netstat_wait_connections&quot;</span><br><span class="line">count_netstat_wait_connections=`netstat -an | grep &#x27;WAIT&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_wait $count_netstat_wait_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-监控文件描述符使用率"><a href="#6-4-监控文件描述符使用率" class="headerlink" title="6.4 监控文件描述符使用率"></a>6.4 监控文件描述符使用率</h3><p>在linux中，每当进程打开一个文件时，系统就会为其分配一个唯一的整型文件描述符，用来标识这个文件，每个进程默认打开的文件描述符有三个，分别为标准输入、标准输出、标准错误，即stdin、stout、steer，用文件描述符来表示为0、1、2。</p>
<p>用命令可以查看目前系统的最大文件描述符限制，一般默认设置是1024。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n</span><br></pre></td></tr></table></figure>

<p>文件描述符使用率公式为：（已分配的文件描述符数量 &#x2F; 最大文件描述符数量）* 100，在Prometheus中则表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_filefd_allocated / node_filefd_maximum) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%BD%BF%E7%94%A8%E7%8E%87.png" alt="监控文件描述符使用率"></p>
<h3 id="6-5-网络延迟和丢包率监控"><a href="#6-5-网络延迟和丢包率监控" class="headerlink" title="6.5 网络延迟和丢包率监控"></a>6.5 网络延迟和丢包率监控</h3><p>前面我们采用的都是简单的ping + ip地址来进行测试，实际上这样测试发出去的icmp数据包是非常小的，只适合用来测试网络是否连通，因此用以下命令来进行优化：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ping -q ip地址 -s 500 -W 1000 -c 100</span><br><span class="line">-q:不显示指令执行过程，开头和结尾的相关信息除外。</span><br><span class="line">-s:设置数据包的大小。</span><br><span class="line">-W:在等待 timeout 秒后开始执行。</span><br><span class="line">-c:设置完成要求回应的次数。</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E5%92%8C%E4%B8%A2%E5%8C%85%E7%8E%87%E7%9B%91%E6%8E%A7.png" alt="网络延迟和丢包率监控"></p>
<h3 id="6-6-使用Pageduty实现报警"><a href="#6-6-使用Pageduty实现报警" class="headerlink" title="6.6 使用Pageduty实现报警"></a>6.6 使用Pageduty实现报警</h3><p>Pagerduty是一套付费监控报警系统，经常作为SRE&#x2F;运维人员的监控报警工具，可以和市面上常见的监控工具直接整合。</p>
<ol>
<li>创建新service</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%80.png" alt="pateduty实现报警一"><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%8C.png" alt="pateduty实现报警二"></p>
<ol start="2">
<li>在Grafana新建报警渠道，并在仪表盘中设置为Pageduty报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%89.png" alt="pateduty实现报警三"></p>
<ol start="3">
<li>设置报警信息</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%9B%9B.png" alt="pateduty实现报警四"></p>
<ol start="4">
<li>查看是否收到报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%94.png" alt="pateduty实现报警五"></p>
<ol start="5">
<li>当问题解决可以点击已解决</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%85%AD.png" alt="pateduty实现报警六"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T08:31:44.427Z" title="2/18/2024, 4:31:44 PM">2024-02-18</time></span><span class="level-item">2 hours read (About 13895 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/">linux基础网络服务</a></p><div class="content"><h2 id="一、DHCP服务"><a href="#一、DHCP服务" class="headerlink" title="一、DHCP服务"></a>一、DHCP服务</h2><h3 id="1-1-DHCP服务介绍"><a href="#1-1-DHCP服务介绍" class="headerlink" title="1.1 DHCP服务介绍"></a>1.1 DHCP服务介绍</h3><p>DHCP服务即动态主机配置协议，被运用在局域网中，主要的作用是分配IP地址。</p>
<p>DHCP服务采用的是UDP协议，发送采用UDP67端口，接受则采用UDP68端口。</p>
<h3 id="1-2-DHCP服务部署"><a href="#1-2-DHCP服务部署" class="headerlink" title="1.2 DHCP服务部署"></a>1.2 DHCP服务部署</h3><ol>
<li>安装DHCP</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install dhcp</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>DHCP配置文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/doc/dhcp*/dhcpd.conf.example /etc/dhcp/dhcpd.conf</span><br><span class="line">cat /etc/dhcp/dhcpd.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DHCP服务配置文件分为全局配置和作用域配置，很好区分：subnet的就是作用域 不在subnet里面的就是全局设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dhcpd.conf</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Sample configuration file for ISC dhcpd</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DNS全局选项，指定DNS服务器的地址，可以是IP，也可以是域名。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option definitions common to all supported networks...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DNS的域名</span></span><br><span class="line">option domain-name &quot;example.org&quot;;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">具体的DNS服务器</span></span><br><span class="line">option domain-name-servers ns1.example.org, ns2.example.org;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">租约设置，默认租约为600s</span></span><br><span class="line">default-lease-time 600;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">租约设置，最大租约为7200s，当客户端未请求明确的租约时间。</span></span><br><span class="line">max-lease-time 7200;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">动态DNS更新方式(none:不支持；interim:互动更新模式；ad-hoc:特殊更新模式)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Use this to enble / <span class="built_in">disable</span> dynamic dns updates globally.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ddns-update-style none;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果该DHCP服务器是本地官方DHCP就将此选项打开，避免其他DHCP服务器的干扰。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当一个客户端试图获得一个不是该DHCP服务器分配的IP信息，DHCP将发送一个拒绝消息，而不会等待请求超时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当请求被拒绝，客户端会重新向当前DHCP发送IP请求获得新地址。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保证IP是自己发出去的</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If this DHCP server is the official DHCP server for the local</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network, the authoritative directive should be uncommented.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启此项表权威DHCP</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">authoritative;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Use this to send dhcp <span class="built_in">log</span> messages to a different <span class="built_in">log</span> file (you also</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">have to hack syslog.conf to complete the redirection).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志级别</span></span><br><span class="line">log-facility local7;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">No service will be given on this subnet, but declaring it helps the</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DHCP server to understand the network topology.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">作用域相关设置指令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">subnet 定义一个作用域</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">netmask 定义作用域的掩码</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">range 允许发放的IP范围</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option routers 指定网关地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option domain-name-servers 指定DNS服务器地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option broadcast-address 广播地址</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例:定义一个作用域 网段为10.152.187.0 掩码为255.255.255.0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此作用域不提供任何服务</span></span><br><span class="line">subnet 10.152.187.0 netmask 255.255.255.0 &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a very basic subnet declaration.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例:定义一个基本的作用域</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网段10.254.239.0 掩码255.255.255.224</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分发范围10.254.239.10-20</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网关为rtr-239-0-1.example.org, rtr-239-0-2.example.org</span></span><br><span class="line">subnet 10.254.239.0 netmask 255.255.255.224 &#123;</span><br><span class="line">  range 10.254.239.10 10.254.239.20;</span><br><span class="line">  option routers rtr-239-0-1.example.org, rtr-239-0-2.example.org;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This declaration allows BOOTP clients to get dynamic addresses,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">which</span> we don<span class="string">&#x27;t really recommend.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:允许采用bootp协议的客户端动态获得地址</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">bootp DHCP的前身</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">BOOTP用于无盘工作站的局域网中，可以让无盘工作站从一个中心服务器上获得IP地址。通过BOOTP协议可以为局域网中的无盘工作站分配动态IP地址，</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">这样就不需要管理员去为每个用户去设置静态IP地址。</span></span></span><br><span class="line">subnet 10.254.239.32 netmask 255.255.255.224 &#123;</span><br><span class="line">  range dynamic-bootp 10.254.239.40 10.254.239.60;</span><br><span class="line">  option broadcast-address 10.254.239.31;</span><br><span class="line">  option routers rtr-239-32-1.example.org;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:一个简单的作用域案例</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">A slightly different configuration for an internal subnet.</span></span></span><br><span class="line">subnet 10.5.5.0 netmask 255.255.255.224 &#123;</span><br><span class="line">  range 10.5.5.26 10.5.5.30;</span><br><span class="line">  option domain-name-servers ns1.internal.example.org;</span><br><span class="line">  option domain-name &quot;internal.example.org&quot;;</span><br><span class="line">  option routers 10.5.5.1;</span><br><span class="line">  option broadcast-address 10.5.5.31;</span><br><span class="line">  default-lease-time 600;</span><br><span class="line">  max-lease-time 7200;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Hosts which require special configuration options can be listed in</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">host statements.   If no address is specified, the address will be</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">allocated dynamically (if possible), but the host-specific information</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">will still come from the host declaration.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># 保留地址:可以将指定的IP分发给指定的机器，根据网卡的MAC地址来做触发</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">host: 启用保留。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">hardware:指定客户端的mac地址</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">filename:指定文件名</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">server-name:指定下一跳服务器地址</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">fixed-address: 指定保留IP地址</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:这个案例中分发给客户端的不是IP地址信息，而是告诉客户端去找toccata.fugue.com服务器，并且下载vmunix.passacaglia文件</span></span></span><br><span class="line">host passacaglia &#123;</span><br><span class="line">  hardware ethernet 0:0:c0:5d:bd:95;</span><br><span class="line">  filename &quot;vmunix.passacaglia&quot;;</span><br><span class="line">  server-name &quot;toccata.fugue.com&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Fixed IP addresses can also be specified for hosts.   These addresses</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">should not also be listed as being available for dynamic assignment.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Hosts for which fixed IP addresses have been specified can boot using</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">BOOTP or DHCP.   Hosts for which no fixed address is specified can only</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">be booted with DHCP, unless there is an address range on the subnet</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">to which a BOOTP client is connected which has the dynamic-bootp flag</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">set.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:保留地址，将指定IP(fantasia.fugue.com对应的IP)分给指定客户端网卡(MAC:08:00:07:26:c0:a5)</span></span></span><br><span class="line">host fantasia &#123;</span><br><span class="line">  hardware ethernet 08:00:07:26:c0:a5;</span><br><span class="line">  fixed-address fantasia.fugue.com;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">超级作用域</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">超级作用域是DHCP服务中的一种管理功能，使用超级作用域，可以将多个作用域组合为单个管理实体。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">You can declare a class of clients and then do address allocation</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">based on that.   The example below shows a case where all clients</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">in a certain class get addresses on the 10.17.224/24 subnet, and all</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">other clients get addresses on the 10.0.29/24 subnet.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">在局域网中，可以配置策略根据各个机器的具体信息分配IP地址和其他的网络参数，客户机的具体信息：客户机能够给dhcp服务提供的信息由两个，</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">第一个就是网卡的dhcp-client-identifier（mac地址），</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">第二个就是设备的vendor-class-identifier。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">管理员可以根据这两个信息给不同的机器分组。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">案例:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">按client某种类型分组DHCP,而不是按物理接口网段</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">例子: SUNW 分配地址段10.17.224.0/24</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">     非SUNW的主机,分配地址段10.0.29.0/24</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义一个dhcp类:foo</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">request广播中vendor-class-identifier字段对应的值前四个字节如果是&quot;SUNW&quot;,则视合法客户端.</span></span></span><br><span class="line">class &quot;foo&quot; &#123;</span><br><span class="line">  match if substring (option vendor-class-identifier, 0, 4) = &quot;SUNW&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义一个超级作用域: 224-29</span></span></span><br><span class="line">shared-network 224-29 &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义第一个作用域</span></span></span><br><span class="line">  subnet 10.17.224.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    option routers rtr-224.example.org;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">定义第二个作用域</span></span></span><br><span class="line">  subnet 10.0.29.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    option routers rtr-29.example.org;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">关连池,如果客户端匹配foo类，将获得该池地址</span></span></span><br><span class="line">  pool &#123;</span><br><span class="line">    allow members of &quot;foo&quot;;</span><br><span class="line">    range 10.17.224.10 10.17.224.250;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">关连池,如果客户端配置foo类，则拒绝获得该段地址</span></span></span><br><span class="line">  pool &#123;</span><br><span class="line">    deny members of &quot;foo&quot;;</span><br><span class="line">    range 10.0.29.10 10.0.29.230;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置作用域"><a href="#1-3-配置作用域" class="headerlink" title="1.3 配置作用域"></a>1.3 配置作用域</h3><ol>
<li>配置作用域</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">subnet 192.168.88.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    range 192.168.88.150 192.168.88.160; # 发放地址范围</span><br><span class="line">    option routers 192.168.88.0; # 网关</span><br><span class="line">    option broadcast-address 192.168.88.255; # 广播地址</span><br><span class="line">    option domain-name-servers 8.8.8.8, 114.114.114.114; # 设置DNS</span><br><span class="line">    default-lease-time 7200; # 默认租约2小时</span><br><span class="line">    max-lease-time 10800; # 最大租约3小时</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将另一台主机网卡设置为DHCP模式</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%B8%80.png" alt="DHCP一"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启网络服务</span></span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>用dhclient命令进行测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">释放IP</span></span><br><span class="line">dhclient -r ens33</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取IP</span></span><br><span class="line">dhclient -d ens33</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%BA%8C.png" alt="DHCP二"></p>
<ol start="4">
<li>查看是否获取了150-160网段内的地址</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%B8%89.png" alt="DHCP三"></p>
<h3 id="1-4-保留地址"><a href="#1-4-保留地址" class="headerlink" title="1.4 保留地址"></a>1.4 保留地址</h3><p>当租约到期的时候，client端只能乖乖交出IP地址，下一次获取就未必是同样的地址了，但公司中往往有些机器要用固定的地址，例如打印机、文件服务器等等，所以在DHCP中可以设置保留地址为其使用。</p>
<p>DHCP是根据主机网卡的MAC地址来做匹配，将保留的IP地址分给相应的主机网卡MAC地址。</p>
<ol>
<li>获取网卡MAC地址</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E5%9B%9B.png" alt="DHCP四"></p>
<ol start="2">
<li>添加保留地址配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dhcp/dhcpd.conf</span><br><span class="line">host fantasia &#123;</span><br><span class="line">    hardware ethernet 00:0c:29:6c:6f:0d;</span><br><span class="line">    fixed-address 192.168.88.155;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看是否获取相应地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dhclient -r ens37</span><br><span class="line">dhclient -d ens37</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/DHCP%E4%BA%94.png" alt="DHCP五"></p>
<h3 id="1-5-超级作用域"><a href="#1-5-超级作用域" class="headerlink" title="1.5 超级作用域"></a>1.5 超级作用域</h3><p>超级作用域简单来说就是将两个或两个以上的不同网段的作用域合成一个作用域。</p>
<ol>
<li>添加超级作用域</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加作用域之前DHCP必须拥有两个网段的网卡</span></span><br><span class="line">shared-network supernet &#123;</span><br><span class="line"></span><br><span class="line">   subnet 192.168.88.0 netmask 255.255.255.0 &#123;</span><br><span class="line">       range 192.168.88.150 192.168.88.160;</span><br><span class="line">       option routers 192.168.88.2;</span><br><span class="line">       option broadcast-address 192.168.88.255;</span><br><span class="line">       option domain-name-servers 8.8.8.8, 114.114.114.114;</span><br><span class="line">       default-lease-time 7200;</span><br><span class="line">       max-lease-time 10800;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   subnet 192.168.99.0 netmask 255.255.255.0 &#123;</span><br><span class="line">       range 192.168.99.150 192.168.99.160;</span><br><span class="line">       option routers 192.168.99.0;</span><br><span class="line">       option broadcast-address 192.168.99.255;</span><br><span class="line">       option domain-name-servers 8.8.8.8, 114.114.114.114;</span><br><span class="line">       default-lease-time 7200;</span><br><span class="line">       max-lease-time 10800;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="二、DNS服务"><a href="#二、DNS服务" class="headerlink" title="二、DNS服务"></a>二、DNS服务</h2><h3 id="2-1-DNS服务介绍"><a href="#2-1-DNS服务介绍" class="headerlink" title="2.1 DNS服务介绍"></a>2.1 DNS服务介绍</h3><p>DNS即域名系统，在互联网中为域名和IP地址进行相互映射的一个分布式数据库。</p>
<p>DNS采用UDP协议，使用UDP53端口进行传输。</p>
<p>DNS记录类型：</p>
<ul>
<li>A：ipv4 记录，将域名映射到 ipv4 地址</li>
<li>AAAA：ipv6 记录，将域名映射到 ipv6 地址</li>
<li>CNAME：别名记录，将域名映射到另一个域名</li>
<li>MX：电邮交互记录，将域名映射到邮件服务器地址</li>
<li>TXT：文本记录，是任意可读的文本 DNS 记录</li>
<li>SRV：服务器资源记录，用来标识某个服务器使用了某个服务，创建于微软系统的目录管理</li>
<li>NS：名称服务器记录，支持将子域名委托给其他 DNS 服务商解析</li>
<li>CAA：CAA 资源记录，可以限定域名颁发证书和 CA 之间的关系</li>
</ul>
<h3 id="2-2-DNS服务部署"><a href="#2-2-DNS服务部署" class="headerlink" title="2.2 DNS服务部署"></a>2.2 DNS服务部署</h3><ol>
<li>安装DNS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bind-chroot是<span class="built_in">bind</span>的一个功能,使<span class="built_in">bind</span>可以在一个<span class="built_in">chroot</span>的模式下运行.也就是说,<span class="built_in">bind</span>运行时的/(根)目录,并不是系统真正的/(根)目录,只是系统中的一个子目录而已.这样做的目的是为了提高安全性.因为在<span class="built_in">chroot</span>的模式下,<span class="built_in">bind</span>可以访问的范围仅限于这个子目录的范围里,无法进一步提升,进入到系统的其他目录中。<span class="built_in">bind</span>的默认启动方式就是<span class="built_in">chroot</span>方式。</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将配置文件和区域数据库文件拷贝到chroot目录下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp -p /etc/named.conf /var/named/chroot/etc/</span><br><span class="line">cp -pr /var/named/name* /var/named/chroot/var/named/</span><br><span class="line">chown -R named:named /var/named/chroot/*</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置文件 /var/named/chroot/etc/named.conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">区域数据库文件 /var/named/chroot/var/named/</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> Sample named.conf BIND DNS server &#x27;named&#x27; configuration file</span><br><span class="line"> for the Red Hat BIND distribution.</span><br><span class="line"> See the BIND Administrator&#x27;s Reference Manual (ARM) for details about the</span><br><span class="line"> configuration located in /usr/share/doc/bind-&#123;version&#125;/Bv9ARM.html</span><br><span class="line">*/</span><br><span class="line">options</span><br><span class="line">&#123;</span><br><span class="line">    // Put files that named is allowed to write in the data/ directory:</span><br><span class="line">        #指定区域数据库文件的路径目录</span><br><span class="line">    directory         &quot;/var/named&quot;;        // &quot;Working&quot; directory</span><br><span class="line">    #CACHE文件路径,指定服务器在收到rndc dump命令时，转储数据到文件的路径。默认named_dump.db</span><br><span class="line">    dump-file         &quot;data/cache_dump.db&quot;;</span><br><span class="line">    #静态文件路径,指定服务器在收到rndc stats命令时，追加统计数据的文件路径。默认named.stats</span><br><span class="line">        statistics-file     &quot;data/named_stats.txt&quot;;</span><br><span class="line">    #内存静态文件路径,服务器在退出时，将内存统计写到文件的路径。默认named.memstats</span><br><span class="line">        memstatistics-file     &quot;data/named_mem_stats.txt&quot;;</span><br><span class="line">    # 指定服务器在通过rndc recursing命令指定转储当前递归请求到的文件路径。默认named.recursing</span><br><span class="line">    recursing-file        &quot;data/named.recursing&quot;;</span><br><span class="line">    #在收到rndc secroots指令后，服务器转储安全根的目的文件的路径名。默认named.secroots</span><br><span class="line">    secroots-file        &quot;data/named.secroots&quot;;</span><br><span class="line">    /*</span><br><span class="line">      Specify listenning interfaces. You can use list of addresses (&#x27;;&#x27; is</span><br><span class="line">      delimiter) or keywords &quot;any&quot;/&quot;none&quot;</span><br><span class="line">    */</span><br><span class="line">    #IPV4监听端口为53,允许任何人连接</span><br><span class="line">    //listen-on port 53    &#123; any; &#125;;</span><br><span class="line">    #IPv4监听端口为53，只允许本机连接</span><br><span class="line">    listen-on port 53    &#123; 127.0.0.1; &#125;;</span><br><span class="line">    #IPV6监听端口为53,允许任何人连接</span><br><span class="line">    //listen-on-v6 port 53    &#123; any; &#125;;</span><br><span class="line">    #IPv6监听端口为53，只允许本机连接</span><br><span class="line">    listen-on-v6 port 53    &#123; ::1; &#125;;</span><br><span class="line">    /*</span><br><span class="line">      访问控制</span><br><span class="line">      Access restrictions</span><br><span class="line">          两个重要选项</span><br><span class="line">      There are two important options:</span><br><span class="line">        allow-query &#123; argument; &#125;;</span><br><span class="line">          - allow queries for authoritative data</span><br><span class="line">        允许查询来自权威数据</span><br><span class="line">        allow-query-cache &#123; argument; &#125;;</span><br><span class="line">          - allow queries for non-authoritative data (mostly cached data)</span><br><span class="line">        允许查询来自非权威数据</span><br><span class="line">      You can use address, network address or keywords &quot;any&quot;/&quot;localhost&quot;/&quot;none&quot; as argument</span><br><span class="line">      大括号中可以使用IP地址、网段、或者关键字 any任何人   localhost本机  none任何人不允许</span><br><span class="line">      Examples:</span><br><span class="line">        allow-query &#123; localhost; 10.0.0.1; 192.168.1.0/8; &#125;;</span><br><span class="line">        allow-query-cache &#123; ::1; fe80::5c63:a8ff:fe2f:4526; 10.0.0.1; &#125;;</span><br><span class="line">    */</span><br><span class="line">    #指定允许哪些主机可以进行普通的DNS查询,可以是关键字:any/localhost/none,也可以是IPV4,IPV6地址</span><br><span class="line">    allow-query        &#123; localhost; &#125;;</span><br><span class="line">    #指定允许哪些主机可以对缓存的访问</span><br><span class="line">    allow-query-cache    &#123; localhost; &#125;;</span><br><span class="line">    /* Enable/disable recursion - recursion yes/no;</span><br><span class="line">        递归查询开关</span><br><span class="line">     - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.</span><br><span class="line">    假如你建立的是一个权威DNS你不需要开启递归</span><br><span class="line">     - If you are building a RECURSIVE (caching) DNS server, you need to enable </span><br><span class="line">       recursion. </span><br><span class="line">    假如你建立的是一个递归DNS,你需要开启递归服务</span><br><span class="line">     - If your recursive DNS server has a public IP address, you MUST enable access </span><br><span class="line">    如果你的递归DNS是具有公网IP，你必须要设置访问控制来限制对合法用户的查询.</span><br><span class="line">       control to limit queries to your legitimate users. Failing to do so will</span><br><span class="line">       cause your server to become part of large scale DNS amplification </span><br><span class="line">    否者你的DNS会被大规模的攻击</span><br><span class="line">       attacks. Implementing BCP38 within your network would greatly</span><br><span class="line">    在您的网络中实现BCP38将非常重要减少此类攻击面</span><br><span class="line">       reduce such attack surface </span><br><span class="line">     */</span><br><span class="line">    #开启递归</span><br><span class="line">    recursion yes;</span><br><span class="line">    #Domain Name System Security Extensions (DNS安全扩展）</span><br><span class="line">    /* DNSSEC related options. See information about keys (&quot;Trusted keys&quot;, bellow) */</span><br><span class="line">    /* Enable serving of DNSSEC related data - enable on both authoritative</span><br><span class="line">        and recursive servers DNSSEC aware servers */</span><br><span class="line">    #开启DNSSEC在权威或者递归服务器之间信任服务</span><br><span class="line">    dnssec-enable yes;</span><br><span class="line">    /* Enable DNSSEC validation on recursive servers */</span><br><span class="line">    #开启DNSSEC验证在递归服务器</span><br><span class="line">    dnssec-validation yes;</span><br><span class="line">    /* In RHEL-7 we use /run/named instead of default /var/run/named</span><br><span class="line">       so we have to configure paths properly. */</span><br><span class="line">    #PID文件路径</span><br><span class="line">    pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">    #session-keyfile文件路径</span><br><span class="line">    session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">    #指定目录，其中保存着跟踪被管理DNSSEC密钥文件。默认为工作目录。</span><br><span class="line">    managed-keys-directory &quot;/var/named/dynamic&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">logging </span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启DNS日志记录</span></span><br><span class="line">/*      If you want to enable debugging, eg. using the &#x27;rndc trace&#x27; command,</span><br><span class="line"> *      named will try to write the &#x27;named.run&#x27; file in the $directory (/var/named).</span><br><span class="line"> *      By default, SELinux policy does not allow named to modify the /var/named directory,</span><br><span class="line"> *      so put the default debug log file in data/ :</span><br><span class="line"> */</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file &quot;data/named.run&quot;;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">/*</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#日志分为两种 告警和访问</span></span></span><br><span class="line">logging &#123;</span><br><span class="line">  channel warning &#123;</span><br><span class="line">    file &quot;data/dns_warning&quot; versions 10 size 10m;</span><br><span class="line">    severity warning;</span><br><span class="line">    print-category yes;</span><br><span class="line">    print-severity yes;</span><br><span class="line">    print-time yes;</span><br><span class="line">  &#125;;</span><br><span class="line">  channel general_dns &#123;</span><br><span class="line">    file &quot;data/dns_log&quot; versions 10 size 100m;</span><br><span class="line">    severity info;</span><br><span class="line">    print-category yes;</span><br><span class="line">    print-severity yes;</span><br><span class="line">    print-time yes;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">默认日志 warning</span></span><br><span class="line"> category default &#123;</span><br><span class="line">    warning;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">访问日志级别 general_dns info</span></span><br><span class="line">  category queries &#123;</span><br><span class="line">    general_dns;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">*/</span><br><span class="line">&#125;;</span><br><span class="line">/*</span><br><span class="line">通过Views指令配置智能查询DNS</span><br><span class="line"> Views let a name server answer a DNS query differently depending on who is asking.</span><br><span class="line"> By default, if named.conf contains no &quot;view&quot; clauses, all zones are in the </span><br><span class="line"> &quot;default&quot; view, which matches all clients.</span><br><span class="line"> Views are processed sequentially. The first match is used so the last view should</span><br><span class="line"> match &quot;any&quot; - it&#x27;s fallback and the most restricted view.</span><br><span class="line"> If named.conf contains any &quot;view&quot; clause, then all zones MUST be in a view.</span><br><span class="line">*/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置一个明称为localhost_resolver的智能访问视图</span></span><br><span class="line">view &quot;localhost_resolver&quot;</span><br><span class="line">&#123;</span><br><span class="line">/* This view sets up named to be a localhost resolver ( caching only nameserver ).</span><br><span class="line"> * If all you want is a caching-only nameserver, then you need only define this view:</span><br><span class="line"> */</span><br><span class="line">    #允许使用该视图解析的客户端   localhost本机   any 任何机器  或者网段</span><br><span class="line">    match-clients         &#123; localhost; &#125;;</span><br><span class="line">    #允许递归</span><br><span class="line">    recursion yes;</span><br><span class="line">    # all views must contain the root hints zone:</span><br><span class="line">    #根域</span><br><span class="line">    zone &quot;.&quot; IN &#123;</span><br><span class="line">        #域类型为hint,还有master slave forward等类型</span><br><span class="line">            type hint;</span><br><span class="line">        #区域数据库文件路径</span><br><span class="line">            file &quot;/var/named/named.ca&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">        /* these are zones that contain definitions for all the localhost</span><br><span class="line">         * names and addresses, as recommended in RFC1912 - these names should</span><br><span class="line">     * not leak to the other nameservers:</span><br><span class="line">     */</span><br><span class="line">    #包含子配置文件</span><br><span class="line">    include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义视图internal</span></span><br><span class="line">view &quot;internal&quot;</span><br><span class="line">&#123;</span><br><span class="line">/* This view will contain zones you want to serve only to &quot;internal&quot; clients</span><br><span class="line">   that connect via your directly attached LAN interfaces - &quot;localnets&quot; .</span><br><span class="line"> */</span><br><span class="line">    match-clients        &#123; localnets; &#125;;</span><br><span class="line">    recursion yes;</span><br><span class="line">    zone &quot;.&quot; IN &#123;</span><br><span class="line">            type hint;</span><br><span class="line">            file &quot;/var/named/named.ca&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">        /* these are zones that contain definitions for all the localhost</span><br><span class="line">         * names and addresses, as recommended in RFC1912 - these names should</span><br><span class="line">     * not leak to the other nameservers:</span><br><span class="line">     */</span><br><span class="line">    include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">    // These are your &quot;authoritative&quot; internal zones, and would probably</span><br><span class="line">    // also be included in the &quot;localhost_resolver&quot; view above :</span><br><span class="line">    /*</span><br><span class="line">      NOTE for dynamic DNS zones and secondary zones:</span><br><span class="line">      DO NOT USE SAME FILES IN MULTIPLE VIEWS!</span><br><span class="line">      If you are using views and DDNS/secondary zones it is strongly</span><br><span class="line">      recommended to read FAQ on ISC site (www.isc.org), section</span><br><span class="line">      &quot;Configuration and Setup Questions&quot;, questions</span><br><span class="line">      &quot;How do I share a dynamic zone between multIPle views?&quot; and</span><br><span class="line">      &quot;How can I make a server a slave for both an internal and an external</span><br><span class="line">       view at the same time?&quot;</span><br><span class="line">    */</span><br><span class="line">    zone &quot;my.internal.zone&quot; &#123; </span><br><span class="line">        type master;</span><br><span class="line">        file &quot;my.internal.zone.db&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    zone &quot;my.slave.internal.zone&quot; &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file &quot;slaves/my.slave.internal.zone.db&quot;;</span><br><span class="line">        masters &#123; /* put master nameserver IPs here */ 127.0.0.1; &#125; ;</span><br><span class="line">        // put slave zones in the slaves/ directory so named can update them</span><br><span class="line">    &#125;;    </span><br><span class="line">    zone &quot;my.ddns.internal.zone&quot; &#123;</span><br><span class="line">        type master;</span><br><span class="line">        allow-update &#123; key ddns_key; &#125;;</span><br><span class="line">        file &quot;dynamic/my.ddns.internal.zone.db&quot;;</span><br><span class="line">        // put dynamically updateable zones in the slaves/ directory so named can update them</span><br><span class="line">    &#125;;            </span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置DDNS_key</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主从复制加密使用</span></span><br><span class="line">key ddns_key</span><br><span class="line">&#123;</span><br><span class="line">    #加密方式 hmac-md5</span><br><span class="line">    algorithm hmac-md5;</span><br><span class="line">    secret &quot;use /usr/sbin/dnssec-keygen to generate TSIG keys&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;external&quot;</span><br><span class="line">&#123;</span><br><span class="line">/* This view will contain zones you want to serve only to &quot;external&quot; clients</span><br><span class="line"> * that have addresses that are not match any above view:</span><br><span class="line"> */</span><br><span class="line">    match-clients        &#123; any; &#125;;</span><br><span class="line">    zone &quot;.&quot; IN &#123;</span><br><span class="line">            type hint;</span><br><span class="line">            file &quot;/var/named/named.ca&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    recursion no;</span><br><span class="line">    // you&#x27;d probably want to deny recursion to external clients, so you don&#x27;t</span><br><span class="line">        // end up providing free DNS service to all takers</span><br><span class="line">    // These are your &quot;authoritative&quot; external zones, and would probably</span><br><span class="line">        // contain entries for just your web and mail servers:</span><br><span class="line">    zone &quot;my.external.zone&quot; &#123; </span><br><span class="line">        type master;</span><br><span class="line">        file &quot;my.external.zone.db&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">/* Trusted keys</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义信任的dnssec密钥。</span></span><br><span class="line">  This statement contains DNSSEC keys. If you want DNSSEC aware resolver you</span><br><span class="line">  have to configure at least one trusted key.</span><br><span class="line">  Note that no key written below is valid. Especially root key because root zone</span><br><span class="line">  is not signed yet.</span><br><span class="line">*/</span><br><span class="line">/*</span><br><span class="line">trusted-keys &#123;</span><br><span class="line">// Root Key</span><br><span class="line">&quot;.&quot; 257 3 3 &quot;BNY4wrWM1nCfJ+CXd0rVXyYmobt7sEEfK3clRbGaTwSJxrGkxJWoZu6I7PzJu/</span><br><span class="line">             E9gx4UC1zGAHlXKdE4zYIPRhaBKnvcC2U9mZhkdUpd1Vso/HAdjNe8LmMlnzY3</span><br><span class="line">             zy2Xy4klWOADTPzSv9eamj8V18PHGjBLaVtYvk/ln5ZApjYghf+6fElrmLkdaz</span><br><span class="line">             MQ2OCnACR817DF4BBa7UR/beDHyp5iWTXWSi6XmoJLbG9Scqc7l70KDqlvXR3M</span><br><span class="line">             /lUUVRbkeg1IPJSidmK3ZyCllh4XSKbje/45SKucHgnwU5jefMtq66gKodQj+M</span><br><span class="line">             iA21AfUVe7u99WzTLzY3qlxDhxYQQ20FQ97S+LKUTpQcq27R7AT3/V5hRQxScI</span><br><span class="line">             Nqwcz4jYqZD2fQdgxbcDTClU0CRBdiieyLMNzXG3&quot;;</span><br><span class="line">// Key for forward zone</span><br><span class="line">example.com. 257 3 5 &quot;AwEAAaxPMcR2x0HbQV4WeZB6oEDX+r0QM65KbhTjrW1ZaARmPhEZZe</span><br><span class="line">                      3Y9ifgEuq7vZ/zGZUdEGNWy+JZzus0lUptwgjGwhUS1558Hb4JKUbb</span><br><span class="line">                      OTcM8pwXlj0EiX3oDFVmjHO444gLkBO UKUf/mC7HvfwYH/Be22GnC</span><br><span class="line">                      lrinKJp1Og4ywzO9WglMk7jbfW33gUKvirTHr25GL7STQUzBb5Usxt</span><br><span class="line">                      8lgnyTUHs1t3JwCY5hKZ6CqFxmAVZP20igTixin/1LcrgX/KMEGd/b</span><br><span class="line">                      iuvF4qJCyduieHukuY3H4XMAcR+xia2 nIUPvm/oyWR8BW/hWdzOvn</span><br><span class="line">                      SCThlHf3xiYleDbt/o1OTQ09A0=&quot;;</span><br><span class="line">// Key for reverse zone.</span><br><span class="line">2.0.192.IN-ADDRPA.NET. 257 3 5 &quot;AQOnS4xn/IgOUpBPJ3bogzwcxOdNax071L18QqZnQQQA</span><br><span class="line">                                VVr+iLhGTnNGp3HoWQLUIzKrJVZ3zggy3WwNT6kZo6c0</span><br><span class="line">                                tszYqbtvchmgQC8CzKojM/W16i6MG/ea fGU3siaOdS0</span><br><span class="line">                                yOI6BgPsw+YZdzlYMaIJGf4M4dyoKIhzdZyQ2bYQrjyQ</span><br><span class="line">                                4LB0lC7aOnsMyYKHHYeRv PxjIQXmdqgOJGq+vsevG06</span><br><span class="line">                                zW+1xgYJh9rCIfnm1GX/KMgxLPG2vXTD/RnLX+D3T3UL</span><br><span class="line">                                7HJYHJhAZD5L59VvjSPsZJHeDCUyWYrvPZesZDIRvhDD</span><br><span class="line">                                52SKvbheeTJUm6EhkzytNN2SN96QRk8j/iI8ib&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vim /var/named/chroot/etc/named.conf</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 192.168.88.132; &#125;;</span><br><span class="line">        #listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        recursing-file  &quot;/var/named/data/named.recursing&quot;;</span><br><span class="line">        secroots-file   &quot;/var/named/data/named.secroots&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line"></span><br><span class="line">        recursion yes;</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">        pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">        session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">        type hint;</span><br><span class="line">        file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br><span class="line"></span><br><span class="line">systemctl start named-chroot</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>区域数据库文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正向解析 named.localhost</span></span><br><span class="line">;缓存时间</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">;@表示相应的域名</span><br><span class="line">@    IN SOA        @ rname.invalid. (</span><br><span class="line">;解析的域名   类型 授权域    授权域名服务器   管理员邮箱</span><br><span class="line">                    0    ; serial  序列号,每次更新该文件系列号都应该变大</span><br><span class="line">                    1D    ; refresh 刷新时间,即规定从域名服务器多长时间查询一个主服务器，以保证从服务器的数据是最新的</span><br><span class="line">                    1H    ; retry   重试时间,即当从服务试图在主服务器上查询更时，而连接失败了，则这个值规定了从服务多长时间后再试 </span><br><span class="line">                    1W    ; expire  过期时间,从服务器在向主服务更新失败后多长时间后清除对应的记录</span><br><span class="line">                    3H )    ; minimum 这个数据用来规定缓冲服务器不能与主服务联系上后多长时间清除相应的记录</span><br><span class="line">    NS   @</span><br><span class="line">    ;NS 名称服务器，表示这个主机为域名服务器</span><br><span class="line">    A    127.0.0.1</span><br><span class="line">;主机头  A记录   IP</span><br><span class="line">    AAAA    ::1</span><br><span class="line">;   AAAA 解析为IPV6地址</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">反向解析 named.loopback</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">@    IN SOA    @ rname.invalid. (</span><br><span class="line">                    0    ; serial</span><br><span class="line">                    1D    ; refresh</span><br><span class="line">                    1H    ; retry</span><br><span class="line">                    1W    ; expire</span><br><span class="line">                    3H )    ; minimum</span><br><span class="line">    NS    @</span><br><span class="line">    PTR    localhost</span><br><span class="line">;IP 反向指针     域名</span><br><span class="line">;PTR 反向指针 反解</span><br></pre></td></tr></table></figure>

<h3 id="2-3-正向解析"><a href="#2-3-正向解析" class="headerlink" title="2.3 正向解析"></a>2.3 正向解析</h3><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">	type master;</span><br><span class="line">	file &quot;cqm.com.zone&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cp /var/named/chroot/var/named/named.localhost /var/named/chroot/var/named/cqm.com.zone</span><br><span class="line">chgrp named cqm.com.zone</span><br><span class="line">vim /var/named/chroot/var/named/cqm.com.zone</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.    IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A:IPv4解析为域名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PTR:域名解析为IP</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MX</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CNAME:设置别名</span></span><br><span class="line">		NS      dns.cqm.com.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析dns为192.168.88.132</span></span><br><span class="line">dns		A		192.168.88.132</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析www为192.168.88.132</span></span><br><span class="line">www     A       192.168.88.132</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用news访问也解析为www</span></span><br><span class="line">news    CNAME   www</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检测文件是否有误</span></span><br><span class="line">named-checkzone cqm.com cqm.com.zone</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在客户端上配置DNS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/resolve.conf</span><br><span class="line">nameserver 192.168.88.132</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过host命令进行测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind-utils</span><br><span class="line">host www.cqm.com</span><br><span class="line">www.cqm.com has address 192.168.88.132</span><br><span class="line"></span><br><span class="line">host news.cqm.com</span><br><span class="line">news.cqm.com is an alias for www.cqm.com.</span><br><span class="line">www.cqm.com has address 192.168.88.132</span><br></pre></td></tr></table></figure>

<h3 id="2-4-反向解析"><a href="#2-4-反向解析" class="headerlink" title="2.4 反向解析"></a>2.4 反向解析</h3><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;88.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">	type master;</span><br><span class="line">	file &quot;192.168.88.arpa&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cp /var/named/chroot/var/named/named.loopback /var/named/chroot/var/named/192.168.88.arpa</span><br><span class="line">vim /var/named/chroot/var/named/192.168.88.arpa</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">88.168.192.in-addr.arpa.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">132     PTR     www.cqm.com.</span><br><span class="line"></span><br><span class="line">named-checkzone 88.168.192.in-addr.arpa 192.168.88.arpa</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host 192.168.88.132</span><br><span class="line">132.88.168.192.in-addr.arpa domain name pointer www.cqm.com.</span><br></pre></td></tr></table></figure>

<h3 id="2-5-主从同步"><a href="#2-5-主从同步" class="headerlink" title="2.5 主从同步"></a>2.5 主从同步</h3><p>即配置两台DNS服务器，由于上边我们以及配置过主DNS了，接下来再配置一台辅DNS服务器即可。</p>
<p>主DNS服务器IP：192.168.88.132</p>
<p>辅DNS服务器IP：192.168.88.135</p>
<ol>
<li>安装DNS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置主配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">scp root@192.168.88.132:/var/named/chroot/etc/named.conf /var/named/chroot/etc/named.conf</span><br><span class="line">chgrp named /var/named/chroot/etc/named.conf</span><br><span class="line">vim /var/named/chroot/etc/named.conf</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 192.168.88.135; &#125;;</span><br><span class="line">        #listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        recursing-file  &quot;/var/named/data/named.recursing&quot;;</span><br><span class="line">        secroots-file   &quot;/var/named/data/named.secroots&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line">        # 从主DNS服务器拷过来的数据不进行加密</span><br><span class="line">        masterfile-format text;</span><br><span class="line"></span><br><span class="line">        recursion yes;</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">        pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">        session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">        type hint;</span><br><span class="line">        file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file &quot;cqm.com.zone&quot;;</span><br><span class="line">        masters &#123; 192.168.88.132; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;88.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file &quot;192.168.88.arpa&quot;;</span><br><span class="line">        masters &#123; 192.168.88.132; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置和主DNS服务器相同的区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim cqm.com.zone</span><br><span class="line">...</span><br><span class="line">vim 192.168.88.arpa</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>将DNS服务器设为自己后进行测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/reslove.comf</span><br><span class="line">nameserver 192.168.88.135</span><br><span class="line">host www.cqm.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="2-6-智能解析"><a href="#2-6-智能解析" class="headerlink" title="2.6 智能解析"></a>2.6 智能解析</h3><p>在DNS中植入全世界的IP库以及IP对应的地域，当用户发来请求时，会根据用户属于哪个地区来找那个地区的区域数据库文件来进行解析，从而使得不同地域的用户解析不同。</p>
<p>例子：</p>
<p>部署一台智能解析DNS服务器，对cqm.com进行解析</p>
<p>深圳用户解析为1.1.1.1</p>
<p>广州用户解析为2.2.2.2</p>
<p>佛山用户解析为3.3.3.3</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 192.168.88.132; &#125;;</span><br><span class="line">        #listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        recursing-file  &quot;/var/named/data/named.recursing&quot;;</span><br><span class="line">        secroots-file   &quot;/var/named/data/named.secroots&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line"></span><br><span class="line">        recursion yes;</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">        pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">        session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl sz &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">假设该网段是深圳的IP地址段</span></span><br><span class="line">        192.168.77.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl gz &#123;</span><br><span class="line">        192.168.88.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl fs &#123;</span><br><span class="line">        192.168.99.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view shenzhen &#123;</span><br><span class="line">match-clients &#123; sz; &#125;;</span><br><span class="line">        zone &quot;.&quot; IN &#123;</span><br><span class="line">                type hint;</span><br><span class="line">                file &quot;named.ca&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file &quot;cqm.com.zone.SZ&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view guangzhou &#123;</span><br><span class="line">match-clients &#123; gz; &#125;;</span><br><span class="line">        zone &quot;.&quot; IN &#123;</span><br><span class="line">                type hint;</span><br><span class="line">                file &quot;named.ca&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file &quot;cqm.com.zone.GZ&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view foshan &#123;</span><br><span class="line">match-clients &#123; fs; &#125;;</span><br><span class="line">        zone &quot;.&quot; IN &#123;</span><br><span class="line">                type hint;</span><br><span class="line">                file &quot;named.ca&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        zone &quot;cqm.com&quot; IN &#123;</span><br><span class="line">                type master;</span><br><span class="line">                file &quot;cqm.com.zone.FS&quot;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加区域数据库文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cp cqm.com.zone cqm.com.zone.SZ</span><br><span class="line">cp cqm.com.zone cqm.com.zone.GZ</span><br><span class="line">cp cqm.com.zone cqm.com.zone.FS</span><br><span class="line">chgrp named cqm.com.zone.*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">深圳</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">dns     A       192.168.88.132</span><br><span class="line">www     A       1.1.1.1</span><br><span class="line">news    CNAME   www</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">广州</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">dns     A       192.168.88.132</span><br><span class="line">www     A       2.2.2.2</span><br><span class="line">news    CNAME   www</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">佛山</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">TTL 1D</span></span><br><span class="line">cqm.com.        IN SOA  dns.cqm.com. rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      dns.cqm.com.</span><br><span class="line">dns     A       192.168.88.132</span><br><span class="line">www     A       3.3.3.3</span><br><span class="line">news    CNAME   www</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试主机的地址段为192.168.88.0/24网段的，所以属于广州区域，即匹配解析到2.2.2.2</span></span><br><span class="line">host www.cqm.com</span><br><span class="line">www.cqm.com has address 2.2.2.2</span><br></pre></td></tr></table></figure>



<h2 id="三、FTP文件传输服务"><a href="#三、FTP文件传输服务" class="headerlink" title="三、FTP文件传输服务"></a>三、FTP文件传输服务</h2><h3 id="3-1-FTP服务介绍"><a href="#3-1-FTP服务介绍" class="headerlink" title="3.1 FTP服务介绍"></a>3.1 FTP服务介绍</h3><p>FTP即文件传输协议，是TCP&#x2F;IP协议组的协议之一。</p>
<p>FTP默认采用TCP20和21端口，20用于传输数据，21用于控制传输信息。</p>
<p>FTP分别有主动传输方式和被动传输方式两种，当FTP为主动传输方式时运用20和21端口，而当FTP为被动传输方式时则会随即打开一个大于1024的端口来进行数据的传输。</p>
<h3 id="3-2-FTP服务部署"><a href="#3-2-FTP服务部署" class="headerlink" title="3.2 FTP服务部署"></a>3.2 FTP服务部署</h3><ol>
<li>安装vsftpd</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vsftpd</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>主配文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example config file /etc/vsftpd/vsftpd.conf</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The default compiled in settings are fairly paranoid. This sample file</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">loosens things up a bit, to make the ftp daemon more usable.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Please see vsftpd.conf.5 <span class="keyword">for</span> all compiled <span class="keyword">in</span> defaults.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># READ THIS: This example file is NOT an exhaustive list of vsftpd options.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Please <span class="built_in">read</span> the vsftpd.conf.5 manual page to get a full idea of vsftpd<span class="string">&#x27;s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">capabilities.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">#匿名用户访问,YES是允许，NO是拒绝</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Allow anonymous FTP? (Beware - allowed by default if you comment this out).</span></span></span><br><span class="line">anonymous_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># Uncomment this to allow local users to log in.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">本地用户登录,YES是允许，NO是拒绝.默认访问的是本地用户家目录，如果你开启了selinux</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">请设置开启布尔值ftp_home_dir为ON</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">When SELinux is enforcing check for SE bool ftp_home_dir</span></span></span><br><span class="line">local_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">#允许本地用户上传</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Uncomment this to enable any form of FTP write command.</span></span></span><br><span class="line">write_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># Default umask for local users is 077. You may wish to change this to 022,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">上传的权限是022，使用的是umask权限。对应的目录是755，文件是644</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">if your users expect that (022 is used by most other ftpd&#x27;</span>s)</span></span><br><span class="line">local_umask=022</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Uncomment this to allow the anonymous FTP user to upload files. This only</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">has an effect <span class="keyword">if</span> the above global write <span class="built_in">enable</span> is activated. Also, you will</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">obviously need to create a directory writable by the FTP user.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">When SELinux is enforcing check <span class="keyword">for</span> SE bool allow_ftpd_anon_write, allow_ftpd_full_access</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启匿名用户上传功能，默认是拒绝的</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">anon_upload_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Uncomment this if you want the anonymous FTP user to be able to create</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">new directories.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启匿名用户创建文件或文件夹权限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">anon_mkdir_write_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Activate directory messages - messages given to remote users when they</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">go into a certain directory.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启目录欢迎消息，一般对命令行登陆有效</span></span><br><span class="line">dirmessage_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Activate logging of uploads/downloads.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启上传和下载日志记录功能</span></span><br><span class="line">xferlog_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#使用标准模式</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Make sure PORT transfer connections originate from port 20 (ftp-data).</span></span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you want, you can arrange for uploaded anonymous files to be owned by</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a different user. Note! Using <span class="string">&quot;root&quot;</span> <span class="keyword">for</span> uploaded files is not</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">recommended!</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">声明匿名用户上传文件的所有者</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许更改匿名用户上传文件的所有者</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">chown_uploads=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有者为whoever</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">chown_username=whoever</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may override where the log file goes if you like. The default is shown</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">below.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志文件路径</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">xferlog_file=/var/log/xferlog</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you want, you can have your log file in standard ftpd xferlog format.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that the default <span class="built_in">log</span> file location is /var/log/xferlog <span class="keyword">in</span> this <span class="keyword">case</span>.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志文件采用标准格斯</span></span><br><span class="line">xferlog_std_format=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may change the default value for timing out an idle session.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会话超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">idle_session_timeout=600</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may change the default value for timing out a data connection.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据传输超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">data_connection_timeout=120</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># It is recommended that you define on your system a unique user which the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ftp server can use as a totally isolated and unprivileged user.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">FTP子进程管理用户</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nopriv_user=ftpsecure</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Enable this and the server will recognise asynchronous ABOR requests. Not</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">recommended <span class="keyword">for</span> security (the code is non-trivial). Not enabling it,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">however, may confuse older FTP clients.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否允许客户端发起“async ABOR”请求，该操作是不安全的默认禁止。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">async_abor_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># By default the server will pretend to allow ASCII mode but in fact ignore</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the request. Turn on the below options to have the server actually <span class="keyword">do</span> ASCII</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mangling on files when <span class="keyword">in</span> ASCII mode. The vsftpd.conf(5) man page explains</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the behaviour when these options are disabled.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Beware that on some FTP servers, ASCII support allows a denial of service</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">attack (DoS) via the <span class="built_in">command</span> <span class="string">&quot;SIZE /big/file&quot;</span> <span class="keyword">in</span> ASCII mode. vsftpd</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">predicted this attack and has always been safe, reporting the size of the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">raw file.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ASCII mangling is a horrible feature of the protocol.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该选项用于指定是否允许上传时以ASCII模式传输数据</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ascii_upload_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该选项用于指定是否允许下载时以ASCII模式传输数据</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ascii_download_enable=YES</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may fully customise the login banner string:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">FTP文本界面登陆欢迎词</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ftpd_banner=Welcome to blah FTP service.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may specify a file of disallowed anonymous e-mail addresses. Apparently</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">useful <span class="keyword">for</span> combatting certain DoS attacks.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否开启拒绝的Email功能</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">deny_email_enable=YES</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(default follows)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定保存被拒接的Email地址的文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">banned_email_file=/etc/vsftpd/banned_emails</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You may specify an explicit list of local users to chroot() to their home</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">directory. If chroot_local_user is YES, <span class="keyword">then</span> this list becomes a list of</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">users</span> to NOT <span class="built_in">chroot</span>().</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(Warning! <span class="built_in">chroot</span><span class="string">&#x27;ing can be very dangerous. If using chroot, make sure that</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">the user does not have write access to the top level directory within the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">chroot)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启对本地用户chroot的限制，YES为默认所有用户都不能切出家目录，NO代表默认用户都可以切出家目录</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">设置方法类似于：YES拒绝所有允许个别；NO允许所有拒绝个别</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">chroot_local_user=YES</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">开启特例列表</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">chroot_list_enable=YES</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">(default follows)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">如果chroot_local_user的值是YES则该文件中的用户是可以切出家目录，如果是NO，该文件中的用户则不能切出家目录</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">一行一个用户。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">chroot_list_file=/etc/vsftpd/chroot_list</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># You may activate the &quot;-R&quot; option to the builtin ls. This is disabled by</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">default to avoid remote users being able to cause excessive I/O on large</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">sites. However, some broken FTP clients such as &quot;ncftp&quot; and &quot;mirror&quot; assume</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">the presence of the &quot;-R&quot; option, so there is a strong case for enabling it.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启ls 递归查询功能 ls -R</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">ls_recurse_enable=YES</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># When &quot;listen&quot; directive is enabled, vsftpd runs in standalone mode and</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">listens on IPv4 sockets. This directive cannot be used in conjunction</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">with the listen_ipv6 directive.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启ftp独立模式在IPV4</span></span></span><br><span class="line">listen=NO</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># This directive enables listening on IPv6 sockets. By default, listening</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">on the IPv6 &quot;any&quot; address (::) will accept connections from both IPv6</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">and IPv4 clients. It is not necessary to listen on *both* IPv4 and IPv6</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">sockets. If you want that (perhaps because you want to listen on specific</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">addresses) then you must run two copies of vsftpd with two configuration</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">files.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Make sure, that one of the listen options is commented !!</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">是否开启ftp独立模式在ipv6</span></span></span><br><span class="line">listen_ipv6=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">启用pam模块验证</span></span></span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">是否开启userlist功能.</span></span></span><br><span class="line">定义对列表中的用户做定义</span><br><span class="line">userlist_deny=NO</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">NO拒绝所有人访问，对应列表中的用户可以访问，YES允许所有人访问，列表中的用户无法访问。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">只有userlist_file=/etc/vsftpd/user_list定义的用户才可以访问或拒绝访问</span></span></span><br><span class="line">userlist_enable=YES</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">是否开启tcp_wrappers管理，TCP_Wrappers是一个工作在第四层（传输层）的的安全工具，</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">对有状态连接的特定服务进行安全检测并实现访问控制</span></span></span><br><span class="line">tcp_wrappers=YES</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>匿名用户和本地用户</p>
<ul>
<li><p>需要注意的是，匿名用户访问的是&#x2F;var&#x2F;ftp，而本地用户访问的话是家目录。</p>
</li>
<li><p>关于权限，在主配文件中设置的权限是反码，文件实际权限 &#x3D; 666 - 反码。</p>
</li>
<li><p>假如主配文件中设置为022，那么文件实际权限 &#x3D; 666 - 022 &#x3D; 644，文件夹实际权限 &#x3D; 777 - 022 &#x3D; 755。</p>
</li>
<li><p>在linux端访问FTP服务器时，无论FTP服务器是否开启了匿名用户访问，客户访问时都要输入用户名和密码，匿名用户用户名ftp，密码随意，但是需要为带有@的email地址。</p>
</li>
</ul>
</li>
<li><p>开启chroot</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否开启对本地用户<span class="built_in">chroot</span>的限制，YES为默认所有用户都不能切出家目录，NO代表默认用户都可以切出家目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置方法类似于：YES拒绝所有允许个别；NO允许所有拒绝个别</span></span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">特例列表</span></span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果用户家目录有写权限的话，则该用户登陆不上</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果想在有写权限的家目录登录的话，需在配置文件加上</span></span><br><span class="line">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure>

<h3 id="3-3-FTP命令"><a href="#3-3-FTP命令" class="headerlink" title="3.3 FTP命令"></a>3.3 FTP命令</h3><p>登录到FTP服务器后，基本命令如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">help # 打印命令菜单</span><br><span class="line">!+linux命令 # 执行linux命令</span><br><span class="line">lcd 目录路径 # 切换linux当前路径</span><br><span class="line">put mput # 上传 批量上传</span><br><span class="line">get mget # 下载 批量下载</span><br><span class="line">ls dir # 列出目录内容</span><br><span class="line">mkdir cd delete rmdir # 创建目录 进入目录 删除文件 删除目录</span><br><span class="line">pwd # 现实FTP当前路径</span><br><span class="line">open close bye # 开启/关闭/退出FTP</span><br></pre></td></tr></table></figure>

<h3 id="3-4-虚拟用户"><a href="#3-4-虚拟用户" class="headerlink" title="3.4 虚拟用户"></a>3.4 虚拟用户</h3><p>由于FTP是采用本地用户来进行登录的，所以会将本地用户暴露在互联网中，如果没有相关安全设置，就会造成FTP不安全。</p>
<p>因此FTP可以设置虚拟用户来解决该问题。</p>
<p>在主配文件中开启虚拟用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">guest_enable=YES</span><br><span class="line">guest_username=cqm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">虚拟用户不用本地用户的权限</span></span><br><span class="line">virtual_use_local_privs=NO</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用户文件存放地址</span></span><br><span class="line">user_config_dir=/etc/vsftpd/vconf.d</span><br></pre></td></tr></table></figure>

<h3 id="3-5-基于虚拟用户配置的安全FTP"><a href="#3-5-基于虚拟用户配置的安全FTP" class="headerlink" title="3.5 基于虚拟用户配置的安全FTP"></a>3.5 基于虚拟用户配置的安全FTP</h3><p>案例要求：</p>
<ul>
<li>公司公共文件可以通过匿名下载</li>
<li>公式A部门、B部门、C部门分别由自己的文件夹，并相互隔离</li>
<li>部门之间只有主管拥有上传权限，部门员工只有下载权限</li>
<li>禁止用户查看家目录以外的数据</li>
<li>确保FTP账号安全</li>
</ul>
<ol>
<li>创建虚拟用户映射本地账号</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -d /var/tmp/vuser_ftp cqm</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建目录，所有操作都只能在此目录进行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod 500 /var/tmp/vuser_ftp</span><br><span class="line">mkdir /var/tmp/vuser_ftp/&#123;A,B,C&#125;</span><br><span class="line">chmod 700 /var/tmp/vuser_ftp/*</span><br><span class="line">chown -R cqm:cqm /var/tmp/vuser_ftp</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建虚拟用户账号密码文件，并生成db文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vuser</span><br><span class="line">A_01</span><br><span class="line">123</span><br><span class="line">B_01</span><br><span class="line">123</span><br><span class="line">C_01</span><br><span class="line">123</span><br><span class="line">A_02</span><br><span class="line">123</span><br><span class="line">B_02</span><br><span class="line">123</span><br><span class="line">C_02</span><br><span class="line">123</span><br><span class="line">db_load -T -t hash -f /etc/vsftpd/vuser /etc/vsftpd/vuser.db</span><br><span class="line">chmod 600 /etc/vsftpd/vuser.db</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>设置虚拟用户pam认证</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pam.d/vsftpd</span><br><span class="line">auth       sufficient   /lib64/security/pam_userdb.so db=/etc/vsftpd/vuser</span><br><span class="line">account    sufficient   /lib64/security/pam_userdb.so db=/etc/vsftpd/vuser</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>要求不能切出家目录，所以要设置chroot_list</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/chroot_list</span><br><span class="line">A_01</span><br><span class="line">B_01</span><br><span class="line">C_01</span><br><span class="line">A_02</span><br><span class="line">B_02</span><br><span class="line">C_02</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>创建子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/vsftpd/vconf.d</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A主管文件</span></span><br><span class="line">vim /etc/vsftpd/vconf.d/A_01</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定家目录</span></span><br><span class="line">local_root=/var/tmp/vuser_ftp/A</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定权限</span></span><br><span class="line">anon_umask=077</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载权限</span></span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传权限</span></span><br><span class="line">anon_upload_enable=YES</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建目录权限</span></span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除和重命名目录权限</span></span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A员工文件</span></span><br><span class="line">vim /etc/vsftpd/vconf.d/A_02</span><br><span class="line">local_root=/var/tmp/vuser_ftp/A</span><br><span class="line">anon_world_readable_only=NO</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>配置主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">anonymous_enable=YES</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line">listen=YES</span><br><span class="line">listen_ipv6=NO</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=cqm</span><br><span class="line">virtual_use_local_privs=NO</span><br><span class="line">user_config_dir=/etc/vsftpd/vconf.d</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>测试主管用户和员工用户的权限</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ftp 192.168.88.132</span><br><span class="line">A_01</span><br><span class="line">123</span><br><span class="line">230 Login successful</span><br></pre></td></tr></table></figure>



<h2 id="四、Samba服务"><a href="#四、Samba服务" class="headerlink" title="四、Samba服务"></a>四、Samba服务</h2><h3 id="4-1-Samba服务介绍"><a href="#4-1-Samba服务介绍" class="headerlink" title="4.1 Samba服务介绍"></a>4.1 Samba服务介绍</h3><p>Samba是可以实现不同计算机系统之间文件共享的服务，即是在Linux和UNIX系统上实现SMB协议的一个免费软件。</p>
<p>SMB（Server Messages Block，信息服务块）是一种在局域网上共享文件和打印机的一种通信协议，它为局域网内的不同计算机之间提供文件及打印机等资源的共享服务。</p>
<p>Samba采用到的端口有：</p>
<ul>
<li>UDP 137：NetBIOS 名字服务</li>
<li>UDP 138：NetBIOS 数据报服务</li>
<li>UDP 139：SMB</li>
<li>TCP 389：用于 LDAP (Active Directory Mode)</li>
<li>TCP 445：NetBIOS服务在windos 2000及以后版本使用此端口, (Common Internet File System，CIFS，它是SMB协议扩展到Internet后，实现Internet文件共享)</li>
<li>TCP 901：用于 SWAT，用于网页管理Samba</li>
</ul>
<h3 id="4-2-Samba服务部署"><a href="#4-2-Samba服务部署" class="headerlink" title="4.2 Samba服务部署"></a>4.2 Samba服务部署</h3><ol>
<li>安装samba</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install samba samba-client</span><br><span class="line">systemctl start smb nmb</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>主配文件详解</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/samba/smb.conf.example</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is the main Samba configuration file. For detailed information about the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">options listed here, refer to the smb.conf(5) manual page. Samba has a huge</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">number of configurable options, most of <span class="built_in">which</span> are not shown <span class="keyword">in</span> this example.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The Samba Wiki contains a lot of step-by-step guides installing, configuring,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and using Samba:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://wiki.samba.org/index.php/User_Documentation</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># In this file, lines starting with a semicolon (;) or a hash (#) are</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">comments and are ignored. This file uses hashes to denote commentary and</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">semicolons <span class="keyword">for</span> parts of the file you may wish to configure.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># <span class="doctag">NOTE:</span> Run the &quot;testparm&quot; command after modifying this file to check for basic</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">syntax errors.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#---------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#SAMBA selinux相关设置，如果你开启了selinux，请注意下面的说明</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Security-Enhanced Linux (SELinux) Notes:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Turn the samba_domain_controller Boolean on to allow a Samba PDC to use the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">useradd and groupadd family of binaries. Run the following <span class="built_in">command</span> as the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">root user to turn this Boolean on:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你在域环境中使用samba那么请设置下面的bool值</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_domain_controller on</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Turn the samba_enable_home_dirs Boolean on if you want to share home</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">directories via Samba. Run the following <span class="built_in">command</span> as the root user to turn this</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Boolean on:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 假如希望通过samba共享用户家目录请设置下面的bool值</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_enable_home_dirs on</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you create a new directory, such as a new top-level directory, label it</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">with samba_share_t so that SELinux allows Samba to <span class="built_in">read</span> and write to it. Do</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">not label system directories, such as /etc/ and /home/, with samba_share_t, as</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">such directories should already have an SELinux label.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#加入你想将目录通过samba共享，请确认其目录标签为sambe_share_t</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run the <span class="string">&quot;ls -ldZ /path/to/directory&quot;</span> <span class="built_in">command</span> to view the current SELinux</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">label <span class="keyword">for</span> a given directory.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Set SELinux labels only on files and directories you have created. Use the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chcon</span> <span class="built_in">command</span> to temporarily change a label:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">标签设置方法</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">chcon</span> -t samba_share_t /path/to/directory</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Changes made via chcon are lost when the file system is relabeled or commands</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">such as restorecon are run.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Use the samba_export_all_ro or samba_export_all_rw Boolean to share system</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">directories. To share such directories and only allow read-only permissions:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对共享目录的权限的bool设置，只读或读写</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_export_all_ro on</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">To share such directories and allow <span class="built_in">read</span> and write permissions:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setsebool -P samba_export_all_rw on</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># To run scripts (preexec/root prexec/print command/...), copy them to the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/var/lib/samba/scripts/ directory so that SELinux will allow smbd to run them.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that <span class="keyword">if</span> you move the scripts to /var/lib/samba/scripts/, they retain</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">their existing SELinux labels, <span class="built_in">which</span> may be labels that SELinux does not allow</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">smbd to run. Copying the scripts will result <span class="keyword">in</span> the correct SELinux labels.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Run the <span class="string">&quot;restorecon -R -v /var/lib/samba/scripts&quot;</span> <span class="built_in">command</span> as the root user to</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apply the correct SELinux labels to these files.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#--------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#======================= Global Settings =====================================</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">全局设置，对整个服务都生效</span></span><br><span class="line">[global]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">网络设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Network-Related Options -------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># workgroup = the Windows NT domain name or workgroup name, for example, MYGROUP.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># server string = the equivalent of the Windows NT Description field.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># netbios name = used to specify a server name that is not tied to the hostname,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">               maximum is 15 characters.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># interfaces = used to configure Samba to listen on multiple network interfaces.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If you have multiple interfaces, you can use the <span class="string">&quot;interfaces =&quot;</span> option to</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">configure <span class="built_in">which</span> of those interfaces Samba listens on. Never omit the localhost</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">interface (lo).</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># hosts allow = the hosts allowed to connect. This option can also be used on a</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">per-share basis.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># hosts deny = the hosts not allowed to connect. This option can also be used on</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a per-share basis.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#定义计算机的工作组,如果希望和windows共享，可以设置为workgroup，这样就可以在windows的网上邻居中找到linux计算机</span></span></span><br><span class="line">    workgroup = MYGROUP</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对samba服务器的描述信息</span></span><br><span class="line">    server string = Samba Server Version %v</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置netbios计算机名称</span></span><br><span class="line">;    netbios name = MYSERVER</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">samba使用本机的那块网卡</span></span><br><span class="line">;    interfaces = lo eth0 192.168.12.2/24 192.168.13.2/24</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">允许那个网段访问samba服务器共享</span></span><br><span class="line">;    hosts allow = 127. 192.168.12. 192.168.13.</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#日志选项</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------- Logging Options -----------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># log file = specify where log files are written to and how they are split.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># max log size = specify the maximum size log files are allowed to reach. Log</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">files are rotated when they reach the size specified with <span class="string">&quot;max log size&quot;</span>.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">    <span class="comment">#samba日志文件路径</span></span></span><br><span class="line">    # log files split per-machine:</span><br><span class="line">    log file = /var/log/samba/log.%m</span><br><span class="line">    #日志文件大小，0为不限制，注意不建议这样设置</span><br><span class="line">    # maximum size of 50KB per log file, then rotate:</span><br><span class="line">    max log size = 50</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">独立服务选项</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Standalone Server Options ------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># security = the mode Samba runs in. This can be set to user, share</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(deprecated), or server (deprecated).</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># passdb backend = the backend used to store user information in. New</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installations should use either tdbsam or ldapsam. No additional configuration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">is required <span class="keyword">for</span> tdbsam. The <span class="string">&quot;smbpasswd&quot;</span> utility is available <span class="keyword">for</span> backwards</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">compatibility.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#samba安全级别</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">share:  不需要账号密码，公开共享</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">user:   需要提供sam账号密码才能访问共享，私密共享</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">server：依靠其他Windows NT/2000或Samba Server来验证用户的账号和密码,是一种代理验证。此种安全模式下,系统管理员可以把所有的Windows用户和口令集中到一个NT系统上,&gt;使用Windows NT进行Samba认证, 远程服务器可以自动认证全部用户和口令,如果认证失败,Samba将使用用户级安全模式作为替代的方式。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">domain：域安全级别,使用主域控制器(PDC)来完成认证。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#一般情况下我们使用share和user的比较多，除非公司有完整的域环境</span></span></span><br><span class="line">    security = user</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该方式则是使用一个数据库文件来建立用户数据库。数据库文件叫passdb.tdb，默认在/etc/samba目录下。passdb.tdb 用户数据库可以使用smbpasswd –a来建立Samba用户，不过要建立的Samba用户必须先是系统用户。我们也可以使用pdbedit命令来建立Samba账户并由其pdbedit管理。</span></span><br><span class="line">    passdb backend = tdbsam</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">域成员选项</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Domain Members Options ------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># security = must be set to domain or ads.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># passdb backend = the backend used to store user information in. New</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installations should use either tdbsam or ldapsam. No additional configuration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">is required <span class="keyword">for</span> tdbsam. The <span class="string">&quot;smbpasswd&quot;</span> utility is available <span class="keyword">for</span> backwards</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">compatibility.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># realm = only use the realm option when the &quot;security = ads&quot; option is set.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The realm option specifies the Active Directory realm the host is a part of.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># password server = only use this option when the &quot;security = server&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option is <span class="built_in">set</span>, or <span class="keyword">if</span> you cannot use DNS to locate a Domain Controller. The</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">argument list can include My_PDC_Name, [My_BDC_Name], and [My_Next_BDC_Name]:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># password server = My_PDC_Name [My_BDC_Name] [My_Next_BDC_Name]</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Use &quot;password server = *&quot; to automatically locate Domain Controllers.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置域共享</span></span><br><span class="line">;    security = domain</span><br><span class="line">;    passdb backend = tdbsam</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义域名称</span></span><br><span class="line">;    realm = MY_REALM</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">域验证服务器</span></span><br><span class="line">;    password server = </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">域控选项</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">----------------------- Domain Controller Options ------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># security = must be set to user for domain controllers.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># passdb backend = the backend used to store user information in. New</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installations should use either tdbsam or ldapsam. No additional configuration</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">is required <span class="keyword">for</span> tdbsam. The <span class="string">&quot;smbpasswd&quot;</span> utility is available <span class="keyword">for</span> backwards</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">compatibility.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># domain master = specifies Samba to be the Domain Master Browser, allowing</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Samba to collate browse lists between subnets. Do not use the <span class="string">&quot;domain master&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option <span class="keyword">if</span> you already have a Windows NT domain controller performing this task.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># domain logons = allows Samba to provide a network logon service for Windows</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">workstations.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># logon script = specifies a script to run at login time on the client. These</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scripts must be provided <span class="keyword">in</span> a share named NETLOGON.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># logon path = specifies (with a UNC path) where user profiles are stored.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line">;    security = user</span><br><span class="line">;    passdb backend = tdbsam</span><br><span class="line">;    domain master = yes</span><br><span class="line">;    domain logons = yes</span><br><span class="line">    # the following login script name is determined by the machine name</span><br><span class="line">    # (%m):</span><br><span class="line">;    logon script = %m.bat</span><br><span class="line">    # the following login script name is determined by the UNIX user used:</span><br><span class="line">;    logon script = %u.bat</span><br><span class="line">;    logon path = \\%L\Profiles\%u</span><br><span class="line">    # use an empty path to disable profile support:</span><br><span class="line">;    logon path =</span><br><span class="line">    # various scripts can be used on a domain controller or a stand-alone</span><br><span class="line">    # machine to add or delete corresponding UNIX accounts:</span><br><span class="line">;    add user script = /usr/sbin/useradd &quot;%u&quot; -n -g users</span><br><span class="line">;    add group script = /usr/sbin/groupadd &quot;%g&quot;</span><br><span class="line">;    add machine script = /usr/sbin/useradd -n -c &quot;Workstation (%u)&quot; -M -d /nohome -s /bin/false &quot;%u&quot;</span><br><span class="line">;    delete user script = /usr/sbin/userdel &quot;%u&quot;</span><br><span class="line">;    delete user from group script = /usr/sbin/userdel &quot;%u&quot; &quot;%g&quot;</span><br><span class="line">;    delete group script = /usr/sbin/groupdel &quot;%g&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这些设置选项主要用于SMB网络中进行浏览时，设置samba服务器的行为。缺省情况不让 samba服务器参加broswser的推举过程，为了使得samba服务器能成为browser，就需要设定<span class="built_in">local</span> master =<span class="built_in">yes</span>。然后samba服务就可以根据os level设置的权重进行推举，缺省的os level为0，这个权重不会赢得推举。但可以取消注释，将os level设置为33，这将在与所有Windows计算机（包括Windows NT）的推举竞赛中获得胜利，因为NT server的权重为32。设置比33更高的权重，只是在不同的samba 服务器之间进行选择时才有意义。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># preferred master  可以设置自己优先成为浏览服务器候选人</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ----------------------- Browser Control Options ----------------------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># local master = when set to no, Samba does not become the master browser on</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">your network. When <span class="built_in">set</span> to <span class="built_in">yes</span>, normal election rules apply.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># os level = determines the precedence the server has in master browser</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">elections. The default value should be reasonable.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># preferred master = when set to yes, Samba forces a local browser election at</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">start up (and gives itself a slightly higher chance of winning the election).</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">;    <span class="built_in">local</span> master = no</span></span><br><span class="line">;    os level = 33</span><br><span class="line">;    preferred master = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">wins服务，如果网络中配置了wins服务器可以在此设置wins相关项</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">----------------------------- Name Resolution -------------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This section details the support for the Windows Internet Name Service (WINS).</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Note: Samba can be either a WINS server or a WINS client, but not both.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># wins support = when set to yes, the NMBD component of Samba enables its WINS</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># wins server = tells the NMBD component of Samba to be a WINS client.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># wins proxy = when set to yes, Samba answers name resolution queries on behalf</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">of a non WINS capable client. For this to work, there must be at least one</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WINS server on the network. The default is no.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># dns proxy = when set to yes, Samba attempts to resolve NetBIOS names via DNS</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nslookups.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置nmb进程支持wins服务</span></span><br><span class="line">;    wins support = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置wins服务器ip</span></span><br><span class="line">;    wins server = w.x.y.z</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置wins代理IP</span></span><br><span class="line">;    wins proxy = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置Samba服务器是否在无法联系WINS服务器时通过DNS去解析主机的NetBIOS名</span></span><br><span class="line">;    dns proxy = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该部分包括Samba服务器打印机相关设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------- Printing Options -----------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The options in this section allow you to configure a non-default printing</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">system.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># load printers = when set you yes, the list of printers is automatically</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">loaded, rather than setting them up individually.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cups options = allows you to pass options to the CUPS library. Setting this</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option to raw, <span class="keyword">for</span> example, allows you to use drivers on your Windows clients.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># printcap name = used to specify an alternative printcap file.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#是否启用共享打印机</span></span></span><br><span class="line">    load printers = yes</span><br><span class="line">    cups options = raw</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打印机配置文件</span></span><br><span class="line">;    printcap name = /etc/printcap</span><br><span class="line">    # obtain a list of printers automatically on UNIX System V systems:</span><br><span class="line">;    printcap name = lpstat</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打印机的系统类型,现在支持的打印系统有：bsd, sysv, plp, lprng, aix, hpux, qnx,cups</span></span><br><span class="line">;    printing = cups</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该部分包括Samba服务器如何保留从Windows客户端复制或移动到Samba服务器共享目录文件的Windows文件属性的相关配置.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------- File System Options ---------------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The options in this section can be un-commented if the file system supports</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">extended attributes, and those attributes are enabled (usually via the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;user_xattr&quot;</span> mount option). These options allow the administrator to specify</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">that DOS attributes are stored <span class="keyword">in</span> extended attributes and also make sure that</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Samba does not change the permission bits.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Note: These options can be used on a per-share basis. Setting them globally</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(<span class="keyword">in</span> the [global] section) makes them the default <span class="keyword">for</span> all shares.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的存档属性。默认no。</span></span><br><span class="line">;    map archive = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的隐藏属性。默认no。</span></span><br><span class="line">;    map hidden = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的只读属性。默认为no。</span></span><br><span class="line">;    map read only = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的系统文件属性。默认为no。</span></span><br><span class="line">;    map system = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当Windows客户端将文件复制或移动到Samba服务器共享目录时，是否保留文件在Windows中的相关属性（只读、系统、隐藏、存档属性）。默认为<span class="built_in">yes</span>。</span></span><br><span class="line">;    store dos attributes = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">共享设置</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">============================ Share Definitions ==============================</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用户家目录共享</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">共享名称</span></span><br><span class="line">[homes]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">描述</span></span><br><span class="line">    comment = Home Directories</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否支持浏览</span></span><br><span class="line">    browseable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否允许写入</span></span><br><span class="line">    writable = yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">允许访问该共享资源的smb用户，@组</span></span><br><span class="line">;    valid users = %S</span><br><span class="line">;    valid users = MYDOMAIN\%S</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打印机共享</span></span><br><span class="line">[printers]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">描述</span></span><br><span class="line">    comment = All Printers</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">路径</span></span><br><span class="line">    path = /var/spool/samba</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否可浏览，no类似隐藏共享</span></span><br><span class="line">    browseable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否支持guest访问，和public指令类似</span>    </span><br><span class="line">    guest ok = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否可写</span></span><br><span class="line">    writable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">是否允许打印</span></span><br><span class="line">    printable = yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Un-comment the following and create the netlogon directory <span class="keyword">for</span> Domain Logons:</span></span><br><span class="line">;    [netlogon]</span><br><span class="line">;    comment = Network Logon Service</span><br><span class="line">;    path = /var/lib/samba/netlogon</span><br><span class="line">;    guest ok = yes</span><br><span class="line">;    writable = no</span><br><span class="line">;    share modes = no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Un-comment the following to provide a specific roaming profile share.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The default is to use the user<span class="string">&#x27;s home directory:</span></span></span><br><span class="line">;    [Profiles]</span><br><span class="line">;    path = /var/lib/samba/profiles</span><br><span class="line">;    browseable = no</span><br><span class="line">;    guest ok = yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">A publicly accessible directory that is read only, except for users in the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;staff&quot; group (which have write permissions):</span></span></span><br><span class="line">;    [public]</span><br><span class="line">;    comment = Public Stuff</span><br><span class="line">;    path = /home/samba</span><br><span class="line">;    public = yes</span><br><span class="line">;    writable = no</span><br><span class="line">;    printable = no</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">定义允许哪些smb用户写入</span></span></span><br><span class="line">;    write list = +staff</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Samba共享"><a href="#4-3-Samba共享" class="headerlink" title="4.3 Samba共享"></a>4.3 Samba共享</h3><p>案例：在Windows上访问Samba服务器，共享目录为&#x2F;common，指定用cqm1、cqm2用户才能访问，且只有cqm2有写权限。</p>
<ol>
<li>创建Samba用户</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">smbpasswd用户命令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-a 添加用户 smbpasswd -a cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-x 删除用户 smbpasswd -x cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-d 禁用帐号 smbpasswd -d cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-e 取消禁用 smbpasswd -e cqm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-n 清除密码 smbpasswd -a cqm</span></span><br><span class="line">useradd -s /sbin/nologin cqm1</span><br><span class="line">useradd -s /sbin/nologin cqm2</span><br><span class="line">smbpasswd -a cqm1</span><br><span class="line">smbpasswd -a cqm2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建共享目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /common</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置757是为了让cqm2有写权限</span></span><br><span class="line">chmod 757 /common</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">		workgroup = WORKGROUP</span><br><span class="line">		...</span><br><span class="line">[common]</span><br><span class="line">        comment = samba share directory</span><br><span class="line">        path = /common</span><br><span class="line">        browseable = YES</span><br><span class="line">        hosts allow = 10.0.0.0/8,192.168.88.0/24</span><br><span class="line">        valid users = cqm1,cqm2</span><br><span class="line">        writable = No</span><br><span class="line">        write list = cqm2</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在Windows中输入 \\192.168.88.132 访问</li>
</ol>
<p>首先是cqm1用户</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E4%B8%80.png" alt="Samba一"></p>
<p>可以看到cqm1用户没有写入权限</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E4%BA%8C.png" alt="Samba二"></p>
<p>cqm2用户</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E4%B8%89.png" alt="Samba三"></p>
<p>可以看到cqm2用户有创建文件夹的权限</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Samba%E5%9B%9B.png" alt="Samba四"></p>
<h3 id="4-4-Linux挂载"><a href="#4-4-Linux挂载" class="headerlink" title="4.4 Linux挂载"></a>4.4 Linux挂载</h3><ol>
<li>在客户端上安装samba-client</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install samba-client</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>通过smbclient命令访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //192.168.88.132/common -U cqm2%toortoor</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过mount命令挂载</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /common</span><br><span class="line">mount -o username=cqm2,password=toortoor -t cifs //192.168.88.132/common /common</span><br><span class="line">mount</span><br><span class="line">//192.168.88.132/common on /common type cifs (rw,relatime,vers=default,cache=strict,username=cqm2,domain=LOCALHOST,uid=0,noforceuid,gid=0,noforcegid,addr=192.168.88.132,file_mode=0755,dir_mode=0755,soft,nounix,serverino,mapposix,rsize=1048576,wsize=1048576,echo_interval=60,actimeo=1)</span><br></pre></td></tr></table></figure>



<h2 id="五、NFS文件服务"><a href="#五、NFS文件服务" class="headerlink" title="五、NFS文件服务"></a>五、NFS文件服务</h2><h3 id="5-1-NFS服务介绍"><a href="#5-1-NFS服务介绍" class="headerlink" title="5.1 NFS服务介绍"></a>5.1 NFS服务介绍</h3><p>NFS即网络文件系统，它允许网络中的计算机之间通过TCP&#x2F;IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。</p>
<p>NFS应用场景：</p>
<ul>
<li>共享存储服务器：图片服务器、视频服务器</li>
<li>家目录漫游：域用户家目录服务器</li>
<li>文件服务器：文件存储服务器</li>
</ul>
<h3 id="5-2-NFS实现共享"><a href="#5-2-NFS实现共享" class="headerlink" title="5.2 NFS实现共享"></a>5.2 NFS实现共享</h3><ol>
<li>安装NFS</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nfs-utils</span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl start nfs</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>&#x2F;etc&#x2F;exports共享文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享格式</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享目录绝对路径 IP地址或网段地址(权限1,权限2)</span></span><br><span class="line">/test 192.168.88.132(rw,sync)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">权限说明</span></span><br><span class="line">ro                      只读访问  </span><br><span class="line">rw                      读写访问  </span><br><span class="line">sync                    所有数据在请求时写入共享  </span><br><span class="line">async                   NFS在写入数据前可以相应请求  </span><br><span class="line">secure                  NFS通过1024以下的安全TCP/IP端口发送  </span><br><span class="line">insecure                NFS通过1024以上的端口发送  </span><br><span class="line">wdelay                  如果多个用户要写入NFS目录，则归组写入（默认）  </span><br><span class="line">no_wdelay               如果多个用户要写入NFS目录，则立即写入，当使用async时，无需此设置。  </span><br><span class="line">hide                    在NFS共享目录中不共享其子目录  </span><br><span class="line">no_hide                 共享NFS目录的子目录  </span><br><span class="line">subtree_check           如果共享/usr/bin之类的子目录时，强制NFS检查父目录的权限（默认）  </span><br><span class="line">no_subtree_check        和上面相对，不检查父目录权限  </span><br><span class="line">all_squash              共享文件的UID和GID映射匿名用户anonymous，适合公用目录。  </span><br><span class="line">no_all_squash           保留共享文件的UID和GID（默认）  </span><br><span class="line">root_squash             root用户的所有请求映射成如anonymous用户一样的权限（默认）  </span><br><span class="line">no_root_squash          root用户具有根目录的完全管理访问权限  </span><br><span class="line">anonuid=xxx          	指定NFS服务器/etc/passwd文件中匿名用户的UID  </span><br><span class="line">anongid=xxx          	指定NFS服务器/etc/passwd文件中匿名用户的GID</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>exportfs共享管理命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exportfs命令：</span><br><span class="line">-a     打开或取消所有目录共享。</span><br><span class="line">-o     options,... 指定一列共享选项，与 exports(5) 中讲到的类似。</span><br><span class="line">-i     忽略 /etc/exports 文件，从而只使用默认的和命令行指定的选项。</span><br><span class="line">-r     重新共享所有目录。它使/var/lib/nfs/xtab和/etc/exports同步。它将/etc/exports中已删除的条目从 /var/lib/nfs/xtab中删除，将内核共享表中任何不再有效的条目移除。</span><br><span class="line">-u     取消一个或多个目录的共享。</span><br><span class="line">-f     在“新”模式下，刷新内核共享表之外的任何东西。</span><br><span class="line">       任何活动的客户程序将在它们的下次请求中得到mountd 添加的新的共享条目。</span><br><span class="line">-v     输出详细信息。当共享或者取消共享时，显示在做什么。</span><br><span class="line">       显示当前共享列表的时候，同时显示共享的选项。</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>设置共享</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建被共享目录</span></span><br><span class="line">mkdir /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置exports</span></span><br><span class="line">vim /etc/exports</span><br><span class="line">/test 192.168.88.0/24(rw,sync)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享</span></span><br><span class="line">exportfs -r</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否共享</span></span><br><span class="line">exportfs -v</span><br><span class="line">showmount -e 192.168.88.132</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>客户端挂载</li>
</ol>
<p>客户端挂载是使用nfsnobody用户进行的，如果是root创建的共享目录，且客户端挂载后要进行读写的话，得给目录757的权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs 192.168.88.132:/test /test</span><br></pre></td></tr></table></figure>



<h2 id="六、iSCSI服务"><a href="#六、iSCSI服务" class="headerlink" title="六、iSCSI服务"></a>六、iSCSI服务</h2><h3 id="6-1-iSCSI介绍"><a href="#6-1-iSCSI介绍" class="headerlink" title="6.1 iSCSI介绍"></a>6.1 iSCSI介绍</h3><p>iSCSI即网络小型计算机系统接口，又被称为IPSAN。实际就是通过网络来共享设备。</p>
<p>数据存储技术：</p>
<ul>
<li>DSA（Direct Attached Storage 直接附加存储）：IDE SATA SAS SCSI（本地磁盘）</li>
<li>NSA（Network Attached Storage 网络附加存储）：Samba NFS（共享文件夹）</li>
<li>SAN（Storage Attached Network 网络附加存储）：iSCSI（共享设备）</li>
</ul>
<h3 id="6-2-iSCSI服务部署"><a href="#6-2-iSCSI服务部署" class="headerlink" title="6.2 iSCSI服务部署"></a>6.2 iSCSI服务部署</h3><ol>
<li>准备好要被挂载的磁盘，这里共享sdb1</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%B8%80.png" alt="iSCSI一"></p>
<ol start="2">
<li>安装iSCSI</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install targetcli</span><br><span class="line">sysetmctl start target</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过targetcli命令添加设备共享</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入命令行</span></span><br><span class="line">targetcli</span><br><span class="line">ls</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">backstores 代表后端存储,iscsi通过使用文件、逻辑卷或任何类型的磁盘作为底层存储来仿真呈现为目标的scsi设备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">block      后端存储是个块设备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">fileio     后端存储是一个文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pscsi      物理scsi设备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ramdisk    后端存储是内存上的空间，在内存上创建一个指定大小的ramdisk设备可以通过<span class="built_in">help</span>命令来打印可用命令</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将要共享的设备添加到backstores存储库中</span></span><br><span class="line">cd backstores/</span><br><span class="line">block/ creat block /dev/sdb1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置IQN标识</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式：iqn.年-月.二级域名倒写:共享名</span></span><br><span class="line">cd ..</span><br><span class="line">iscsi/ create iqn.2021-04.com.cqm:storage</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置TPG组中对应的三个问题 谁 从哪里 访问什么设备</span></span><br><span class="line">cd iscsi/iqn.2021-04.com.cqm:storage/tpg1/</span><br><span class="line">acls/ create iqn.2021-04.com.cqm:client</span><br><span class="line">luns/ create /backstores/block/block</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<h3 id="6-3-iSCSI客户端挂载"><a href="#6-3-iSCSI客户端挂载" class="headerlink" title="6.3 iSCSI客户端挂载"></a>6.3 iSCSI客户端挂载</h3><ol>
<li>安装iSCSI客户端</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install iscsi-initiator-utils</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置客户端名称</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/iscsi/initiatorname.iscsi</span><br><span class="line">InitiatorName=iqn.2021-04.com.cqm:client</span><br><span class="line">systemctl start iscsi</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>发现共享设备</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm --mode discoverydb --type sendtargets --portal 192.168.88.132:3260 --discover</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>连接远程设备</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.88.132:3260 --login</span><br><span class="line">lsblk</span><br><span class="line">...</span><br><span class="line">sdb</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>分区格式化</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/sdb</span><br><span class="line">...</span><br><span class="line">mkfs.ext4 /dev/sdb1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>挂载共享磁盘</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/sdb1</span><br><span class="line">vim /etc/fstab</span><br><span class="line">/dev/sdb1 /root/sdb1                            ext4    _netdev        0 0</span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure>

<h3 id="6-4-iSCSI取消挂载"><a href="#6-4-iSCSI取消挂载" class="headerlink" title="6.4 iSCSI取消挂载"></a>6.4 iSCSI取消挂载</h3><ol>
<li>客户端</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.88.132:3260 --logout</span><br><span class="line">rm -rf /var/lib/iscsi/nodes/iqn.2021-04.com.cqm\:storage/</span><br><span class="line">rm -rf /var/lib/iscsi/send_targets/192.168.88.132,3260/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>服务端</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">倒着删</span></span><br><span class="line">targetcli</span><br><span class="line">iscsi/iqn.2021-04.com.cqm:storage/tpg1/portals/ delete 0.0.0.0 3260</span><br><span class="line">iscsi/iqn.2021-04.com.cqm:storage/tpg1/luns/ delete lun=0</span><br><span class="line">iscsi/iqn.2021-04.com.cqm:storage/tpg1/acls/ delete iqn.2021-04.com.cqm:client</span><br><span class="line">iscsi/ delete iqn.2021-04.com.cqm:storage</span><br><span class="line">backstores/block/ delete block</span><br></pre></td></tr></table></figure>



<h2 id="七、IPSAN多链路部署"><a href="#七、IPSAN多链路部署" class="headerlink" title="七、IPSAN多链路部署"></a>七、IPSAN多链路部署</h2><p>在上边的环境中的共享设备是通过单链路共享的，如果这条链路出现了故障，那么就会出现连接不上共享设备的问题，所以在生产环境中都会配置多链路进行部署。</p>
<p>iSCSI服务端和客户端分别拥有两张不同网段的网卡，就可以配置多链路部署。</p>
<h3 id="7-1-部署多链路"><a href="#7-1-部署多链路" class="headerlink" title="7.1 部署多链路"></a>7.1 部署多链路</h3><ol>
<li>在服务端上设置共享设备，并用两个IP进行共享</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%BA%94.png" alt="iSCSI五"></p>
<ol start="2">
<li>在客户端发现共享设备</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/iscsi/initiatorname.iscsi</span><br><span class="line">InitiatorName=iqn.2021-04.com.cqm:client</span><br><span class="line"></span><br><span class="line">systemctl start iscsi</span><br><span class="line"></span><br><span class="line">iscsiadm --mode discoverydb --type sendtargets --portal 192.168.88.132:3260 --discover 192.168.88.132:3260,1 iqn.2021-04.com.cqm:storage 192.168.99.130:3260,1 iqn.2021-04.com.cqm:storage</span><br><span class="line"></span><br><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.88.132:3260 --login</span><br><span class="line">iscsiadm --mode node --targetname iqn.2021-04.com.cqm:storage --portal 192.168.99.130:3260 --login</span><br></pre></td></tr></table></figure>

<p>这时候通过lsblk命令可以看到多了两块设备，但其实是同一个设备不同名</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%B8%89.png" alt="iSCSI三"></p>
<ol start="3">
<li>安装多路径软件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install device-mapper-multipath</span><br><span class="line">cp /usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf /etc/</span><br><span class="line">systemctl start multipathd</span><br></pre></td></tr></table></figure>

<p>再用lsblk命令查看可发现</p>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E5%9B%9B.png" alt="iSCSI四"></p>
<ol start="4">
<li>配置多路径运行模式</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">multipath -ll</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wwid:36001405ac25fe1abdfd4eecb1d0624b2</span></span><br><span class="line">mpatha (36001405ac25fe1abdfd4eecb1d0624b2) dm-2 LIO-ORG ,block</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">vim /etc/multipath.conf</span><br><span class="line">multipaths &#123;</span><br><span class="line">        multipath &#123;</span><br><span class="line">                wwid                    36001405ac25fe1abdfd4eecb1d0624b2 # wwid</span><br><span class="line">                alias                   cqm # 起名</span><br><span class="line">                path_grouping_policy    multibus # 多路径组策略</span><br><span class="line">                path_selector           &quot;round-robin 0&quot; # 负载均衡模式</span><br><span class="line">                failback                manual</span><br><span class="line">                rr_weight               priorities # 按优先级轮询</span><br><span class="line">                no_path_retry           5 # 重试时间5s</span><br><span class="line">        &#125;</span><br><span class="line">        multipath &#123;</span><br><span class="line">                wwid                    1DEC_____321816758474</span><br><span class="line">                alias                   red</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart multipathd</span><br><span class="line">systemctl restart iscsi</span><br><span class="line"></span><br><span class="line">multipath -ll</span><br><span class="line">cqm (36001405ac25fe1abdfd4eecb1d0624b2) dm-2 LIO-ORG ,block</span><br><span class="line">size=1023M features=&#x27;1 queue_if_no_path&#x27; hwhandler=&#x27;0&#x27; wp=rw</span><br><span class="line">`-+- policy=&#x27;round-robin 0&#x27; prio=1 status=active</span><br><span class="line">  |- 5:0:0:0 sdb 8:16 active ready running</span><br><span class="line">  `- 6:0:0:0 sdc 8:32 active ready running</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>挂载</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/test</span><br><span class="line">mount /dev/mapper/cqm1 /root/test</span><br></pre></td></tr></table></figure>

<h3 id="7-2-测试"><a href="#7-2-测试" class="headerlink" title="7.2 测试"></a>7.2 测试</h3><p>将一块网卡断掉，看是否还能使用iSCSI设备</p>
<ol>
<li>断开网卡ens33</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifdown ens33</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E5%85%AD.png" alt="iSCSI六"></p>
<ol start="2">
<li>依旧可以在iSCSI设备上写入数据</li>
</ol>
<p><img src="/2024/02/18/linux%E5%9F%BA%E7%A1%80%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/iSCSI%E4%B8%83.png" alt="iSCSI七"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:58.270Z" title="2/18/2024, 7:02:58 PM">2024-02-18</time></span><span class="level-item">18 minutes read (About 2754 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/zookeeper/">Zookeeper</a></p><div class="content"><p><img src="/2024/02/18/zookeeper/logo.jpg" alt="logo"></p>
<p>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务，是 Hadoop 和 Hbase 的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。</p>
<h2 id="一、Zookeeper基础"><a href="#一、Zookeeper基础" class="headerlink" title="一、Zookeeper基础"></a>一、Zookeeper基础</h2><h3 id="1-1-使用场景"><a href="#1-1-使用场景" class="headerlink" title="1.1 使用场景"></a>1.1 使用场景</h3><ul>
<li>分布式协调组件：通过 watch 机制可以协调好节点之间的数据一致性</li>
<li>分布式锁：通过分布式锁可以做到强一致性</li>
<li>无状态化实现</li>
<li>负载均衡</li>
<li>数据发布&#x2F;订阅</li>
<li>命名服务</li>
</ul>
<h3 id="1-2-部署"><a href="#1-2-部署" class="headerlink" title="1.2 部署"></a>1.2 部署</h3><p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>zoo.cfg</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/datalog</span><br><span class="line"><span class="comment"># 基本时间配置（毫秒）</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># 初始化连接到leader的最大时长，单位为倍数，即初始化时间为tickTime * initLimit</span></span><br><span class="line">initLimit=5</span><br><span class="line"><span class="comment"># follower与leader数据同步的最大时长</span></span><br><span class="line">syncLimit=2</span><br><span class="line"><span class="comment"># 保存数据的快照数量</span></span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line"><span class="comment"># 自动触发清除任务时间间隔，以小时为单位，默认为0，表不清除</span></span><br><span class="line">autopurge.purgeInterval=0</span><br><span class="line"><span class="comment"># 客户端与zk的最大并发连接数</span></span><br><span class="line">maxClientCnxns=60</span><br><span class="line"><span class="comment"># 开启standaloneEnabled模式，即独立部署</span></span><br><span class="line">standaloneEnabled=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启adminServer</span></span><br><span class="line">admin.enableServer=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 2181是为客户端提供的端口</span></span><br><span class="line">server.1=zk01:2888:3888;2181</span><br></pre></td></tr></table></figure>

<h3 id="1-3-基本命令"><a href="#1-3-基本命令" class="headerlink" title="1.3 基本命令"></a>1.3 基本命令</h3><ol>
<li>启动|关闭|查看状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start|stop|status</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 zk</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看内部数据结构</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls [path]</span><br></pre></td></tr></table></figure>



<h2 id="二、内部数据结构"><a href="#二、内部数据结构" class="headerlink" title="二、内部数据结构"></a>二、内部数据结构</h2><h3 id="2-1-是如何存储数据的"><a href="#2-1-是如何存储数据的" class="headerlink" title="2.1 是如何存储数据的"></a>2.1 是如何存储数据的</h3><p>Zookeeper 中的数据是保存在节点上的，即 znode，多个 znode 就构成一个树的结构。</p>
<p><img src="/2024/02/18/zookeeper/zk%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png" alt="zk数据存储结构"></p>
<p>如图，a 和 b 就是 Zookeeper 的 znode，创建 znode 方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create /[znode_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建节点并创建一个数据</span></span><br><span class="line">create /[znode_name] [data_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取数据</span></span><br><span class="line">get [znode_name]</span><br></pre></td></tr></table></figure>

<h3 id="2-2-znode结构"><a href="#2-2-znode结构" class="headerlink" title="2.2 znode结构"></a>2.2 znode结构</h3><p>Zookeeper 中的 zonode，包含以下几个部分：</p>
<ul>
<li>data：保存数据</li>
<li>acl：权限<ul>
<li>c：创建权限</li>
<li>w：写权限</li>
<li>r：读权限</li>
<li>d：删除权限</li>
<li>a：admin 管理者权限</li>
</ul>
</li>
<li>stat：描述当前 znode 的元数据</li>
<li>child：当前节点的子节点</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看znode详细信息</span></span><br><span class="line">get -s /[znode_name]</span><br><span class="line">cZxid:创建节点的事务ID</span><br><span class="line">ctime:创建节点时间</span><br><span class="line">mZxid:修改节点的事务ID</span><br><span class="line">mtime:修改节点时间</span><br><span class="line">pZxid:添加和删除子节点的事务ID</span><br><span class="line">cversion:当前节点的子节点版本号，初始值为-1，每对该节点的子节点进行操作，这个cversion都会自动增加</span><br><span class="line">dataVersion:数据版本初识版本为0，每对该节点的数据进行操作，这个dataVersion都会自动增加</span><br><span class="line">aclVersion:权限版本</span><br><span class="line">ephemeralOwne:如果当前节点是临时节点，该值是当前节点的session id，如果不是临时节点则为0</span><br><span class="line">dataLength:数据长度</span><br><span class="line">numChildren:该节点的子节点个数</span><br></pre></td></tr></table></figure>

<h3 id="2-3-znode类型"><a href="#2-3-znode类型" class="headerlink" title="2.3 znode类型"></a>2.3 znode类型</h3><ul>
<li>持久节点：在会话结束后仍会存在</li>
<li>持久序号节点：根据先后顺序，会在结点之后带上一个数值，适用于分布式锁的场景（单调递增）</li>
<li>临时节点：会话结束后会自动删除，适用于注册与服务发现的场景</li>
<li>临时序号节点：跟持久序号节点相同，适用于分布式锁的场景</li>
<li>容器节点：当容器节点中没有任何子节点时，该容器节点会被定期删除（60s）</li>
<li>TTL 节点：可以指定节点的到期时间</li>
</ul>
<p><strong>持久序号节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>临时节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>临时序号节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>容器节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -c /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>TTL 节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过系统配置开启</span></span><br><span class="line">zookeeper.extendedTypesEnabled=true</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/zookeeper/%E6%8C%81%E4%B9%85%E4%B8%8E%E4%B8%B4%E6%97%B6%E8%8A%82%E7%82%B9.png" alt="持久与临时节点"></p>
<p><strong>持久节点</strong></p>
<p>持久节点在创建后服务端会发送一个 <code>session id</code>，并一直保留着。</p>
<p><strong>临时节点</strong></p>
<p>临时节点在创建时后服务器也会发送一个 <code>session id</code>，在会话持续的过程中客户端会不断向服务端续约 <code>session id</code> 的时间，当客户端没有继续续约，而服务端内部的计时器到期时，就会将该 <code>session id</code> 所对应的 znode 全部删除。</p>
<h3 id="2-4-持久化机制"><a href="#2-4-持久化机制" class="headerlink" title="2.4 持久化机制"></a>2.4 持久化机制</h3><p>Zookeeper 的数据是运行在内存中的，所以提供了两种持久化机制：</p>
<ul>
<li>事务日志：Zookeeper 将执行过的命令以日志的形式存储在 dataLogDir &#x2F; dataDir 中，类似于 redis 的 AOF</li>
<li>数据快照：在一定时间间隔内做一次数据快照，存储在快照文件中（snapshot），类似于 redis 的RDB</li>
</ul>
<p>Zookeeper 通过这两种持久化机制，在恢复数据时先将快照文件中的数据恢复到内存中，再用日志文件中的数据做增量恢复，可以实现高效的持久化。</p>
<h2 id="三、zkCli的使用"><a href="#三、zkCli的使用" class="headerlink" title="三、zkCli的使用"></a>三、zkCli的使用</h2><ol>
<li>递归查询</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -R /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>删除节点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deleteall /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>乐观锁删除</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete -v [version] /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>给当前会话注册用户，并创建节点赋予该用户权限</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addauth digest [user]:[password]</span><br><span class="line">create /[znode_name] auth:[user]:[password]:[privileges]</span><br></pre></td></tr></table></figure>



<h2 id="四、分布式锁"><a href="#四、分布式锁" class="headerlink" title="四、分布式锁"></a>四、分布式锁</h2><p>在分布式的环境下，如果在一个节点去上了个锁，当请求被负载均衡分配到了其它节点，那么锁就无法形成互斥，所以节点之间使用 Zookeeper，做一个协调中心，将锁上传到 Zookeeper，其它节点要用到就去 Zookeeper 拿这个锁，这就是分布式锁。</p>
<p>Zookeeper 锁的分类：</p>
<ul>
<li>读锁：大家都可以读，前提是之前没有写锁。（读锁比喻成约会，大家都有机会和女神约会，约会前提是女神没结婚）</li>
<li>写锁：只有写锁才能写，前提是不能有任何锁。（写锁比喻成结婚，结婚后只有老公能和女神约会，结婚前提是女神和其他人的关系断干净了）</li>
</ul>
<h3 id="4-1-上读锁"><a href="#4-1-上读锁" class="headerlink" title="4.1 上读锁"></a>4.1 上读锁</h3><ul>
<li>创建一个临时序号节点，节点数据是 read，表示为读锁</li>
<li>获取当前 Zookeeper 中序号比自己小的所有节点</li>
<li>判断最小节点是否为读锁：<ul>
<li>如果是读锁：则上锁失败，因为如果最小节点是读锁，那么后面就不可能有写锁，接着为最小节点设置监听，Zookeeper 的 watch 机制会在最小节点发生变化时通知当前节点，再进行后面的步骤，被称为阻塞等待</li>
<li>如果不是读锁：则上锁成功</li>
</ul>
</li>
</ul>
<h3 id="4-2-上写锁"><a href="#4-2-上写锁" class="headerlink" title="4.2 上写锁"></a>4.2 上写锁</h3><ul>
<li>创建一个临时序号节点，节点数据是 write，表示为写锁</li>
<li>获取 Zookeeper 中的所有节点</li>
<li>判断自己是否为最小节点：<ul>
<li>如果是：上锁成功</li>
<li>如果不是：说明前面还有锁，所以上锁失败，接着监听最小节点，如果最小节点发生变化，则重新进行第二步</li>
</ul>
</li>
</ul>
<p><strong>羊群效应</strong></p>
<p>假设有一百个请求都是要去写锁，那么就会有一百个请求去监听最小节点，那么 Zookeeper 的压力就会非常大，解决方法是将这一百个请求按请求顺序排列，后一个请求去监听前一个请求即可，实现链式监听。</p>
<h3 id="4-3-watch机制"><a href="#4-3-watch机制" class="headerlink" title="4.3 watch机制"></a>4.3 watch机制</h3><p>Zookeeper 的 watch 可以看作是一个触发器，当监控的 znode 发生改变，就会触发 znode 上注册的对应事件，请求 watch 的客户端就会接收到异步通知。</p>
<p><strong>zkCli.sh 中使用 watch</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一次性监听，监听节点内容</span></span><br><span class="line">get -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听目录，但所监听节点下创建和删除子节点不会触发监听</span></span><br><span class="line">ls -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">与上面相对，都会触发监听</span></span><br><span class="line">ls -R -w /test</span><br></pre></td></tr></table></figure>



<h2 id="五、集群部署"><a href="#五、集群部署" class="headerlink" title="五、集群部署"></a>五、集群部署</h2><p>Zookeeper 的集群角色有三个：</p>
<ul>
<li>Leader：处理集群所有事务的请求，集群只有一个 Leader</li>
<li>Follower：只处理读请求，参与 Leader 选举</li>
<li>Observer：只处理读请求，提升集群的性能，但不能参与 Leader 选举</li>
</ul>
<p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zk01:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="comment"># 2888:用于集群内zk之间的通信</span></span><br><span class="line">      <span class="comment"># 3888:用于选举投票</span></span><br><span class="line">      <span class="comment"># 2181:客户端使用</span></span><br><span class="line">      <span class="comment"># 要创建observer则在2181端口后加:observer</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">zk02:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2182</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">zk03:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2183</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>通过命令查看节点角色</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh status</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure>

<p><strong>连接集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh -server zk01:2181,zk02:2181,zk03:2181</span><br></pre></td></tr></table></figure>

<h3 id="5-1-ZAB协议"><a href="#5-1-ZAB协议" class="headerlink" title="5.1 ZAB协议"></a>5.1 ZAB协议</h3><p>ZAB（Zookeeper Atomic Broadcast）即 Zookeeper 原子广播协议，通过这个协议解决了集群数据一致性和崩溃恢复的问题。</p>
<p><strong>ZAB 协议中节点的四种状态</strong></p>
<ul>
<li>Looking：选举状态</li>
<li>Following</li>
<li>Leading</li>
<li>Observing</li>
</ul>
<p><strong>初始化集群时 leader 的选举</strong></p>
<ul>
<li>当集群中两台节点启动时，就会开始 leader 的选举，选票的格式为 <code>(myid,zXid)</code></li>
<li>第一轮投票时，每个节点会生成自己的选票，即自己的 <code>(myid,zXid)</code>，然后将选票给到对方，这时候每个节点就会有两张选票，即自己的和对方节点的</li>
<li>接着就会比较两张选票的 <code>zXid</code>，如果都相同就对比 <code>myid</code>，将大的一票投到投票箱中</li>
<li>第二轮投票时，每个节点会将上一轮投出去的选票给到其它节点，然后再对比 <code>(myid,zXid)</code>，将大的一票投出去，就能够选出 leader</li>
<li>后来新启动的节点会发现已经有 leader了，就不用做选举的过程了</li>
<li>可以看出初始化集群时，leader 的选举主要看 <code>myid</code></li>
</ul>
<p><strong>崩溃恢复时的 leader 选举</strong></p>
<p>在 leader 确定了之后，leader 会周期性地向 follower 发送心跳包，当 follower 没有收到 leader 发送过来的心跳包，就会进入选举过程，这时候集群不能对外提供服务。</p>
<ul>
<li>当 leader 挂了之后，follower 的状态会变成 looking</li>
<li>接着就进行选举投票，过程和初始化集群时一样</li>
</ul>
<h3 id="5-2-主从同步原理"><a href="#5-2-主从同步原理" class="headerlink" title="5.2 主从同步原理"></a>5.2 主从同步原理</h3><p><img src="/2024/02/18/zookeeper/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86.png" alt="主从同步原理"></p>
<h3 id="5-3-NIO和BIO"><a href="#5-3-NIO和BIO" class="headerlink" title="5.3 NIO和BIO"></a>5.3 NIO和BIO</h3><p><strong>NIO</strong></p>
<p>用于被客户端连接的 2181 端口，使用的就是 NIO 的连接模式；客户端开启 watch 时，使用的也是 NIO。</p>
<p><strong>BIO</strong></p>
<p>集群在进行选举时，多个节点之间的通信端口，使用的是 BIO 的连接模式。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/2/">Previous</a></div><div class="pagination-next"><a href="/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link is-current" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/NUX_Octodex.gif" alt="Warner"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">16</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqmmm/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-11T09:15:48.000Z">2024-03-11</time></p><p class="title"><a href="/2024/03/11/Pod%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%9E%E7%94%9F%E7%9A%84/">Pod是怎么诞生的</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-29T05:08:36.000Z">2024-02-29</time></p><p class="title"><a href="/2024/02/29/%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85containerd%E5%92%8Cnerdctl/">快速安装containerd和nerdctl</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T09:39:48.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/%E9%A6%96%E9%A1%B5/">首页</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/ansible/">Ansible</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/cisco/">Cisco</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/containerd/"><span class="tag">containerd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">首页</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2024 Warner</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>