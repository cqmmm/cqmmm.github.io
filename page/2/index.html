<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Warner&#039;s Wiki"><meta property="og:url" content="https://cqmmm.github.io/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cqmmm.github.io/img/og_image.png"><meta property="article:author" content="Warner"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cqmmm.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqmmm.github.io"},"headline":"Warner's Wiki","image":["https://cqmmm.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Warner"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://cqmmm.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:14:58.446Z" title="2/18/2024, 5:14:58 PM">2024-02-18</time></span><span class="level-item">6 minutes read (About 850 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/nexus/">Nexus</a></p><div class="content"><p>Nexus æ˜¯ä¸€ä¸ªç”¨äºä¸“é—¨æ­å»º Maven ä»“åº“çš„è½¯ä»¶ï¼Œé™¤äº†ä½œä¸º Maven ä»“åº“ï¼Œå®ƒè¿˜èƒ½å¤Ÿä½œä¸º Docker é•œåƒä»“åº“ã€Yum ä»“åº“ç­‰ç­‰ã€‚</p>
<h2 id="Nexus-éƒ¨ç½²"><a href="#Nexus-éƒ¨ç½²" class="headerlink" title="Nexus éƒ¨ç½²"></a>Nexus éƒ¨ç½²</h2><p><strong>deploy.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-mount-hack</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;-c&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;chown -R 200:200 /nexus-data&#x27;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nexus-data</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">sonatype/nexus3:3.37.3</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INSTALL4J_ADD_VM_PARAMS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;-Xms2703m -Xmx2703m -XX:MaxDirectMemorySize=2703m -Djava.util.prefs.userRoot=$&#123;NEXUS_DATA&#125;/javaprefs&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2048Mi</span>      </span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2048Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nexus-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">        <span class="comment"># è‡ªè¡Œä¿®æ”¹æŒ‚è½½ç±»å‹ï¼Œä¸ä¿®æ”¹åˆ™éœ€åˆ›å»ºå¯¹åº”PVå’ŒPVCğŸ‘‡</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nexus-data</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br></pre></td></tr></table></figure>

<p>éƒ¨ç½²åï¼Œåœ¨å®¹å™¨å†…éƒ¨è·å– admin å¯†ç </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $(cat /nexus-data/admin.password)</span><br></pre></td></tr></table></figure>

<h2 id="é»˜è®¤ä»“åº“è¯´æ˜"><a href="#é»˜è®¤ä»“åº“è¯´æ˜" class="headerlink" title="é»˜è®¤ä»“åº“è¯´æ˜"></a>é»˜è®¤ä»“åº“è¯´æ˜</h2><ul>
<li>maven-centralï¼šä¸­å¤®ä»“åº“ï¼Œé»˜è®¤ä» <code>https://repo1.maven.org/maven2/</code> æ‹‰å– jar åŒ…</li>
<li>maven-releasesï¼šç§åº“å‘è¡Œ jarï¼Œå»ºè®®å°†è®¾ç½®æ”¹ä¸º <code>Allow redeploy</code></li>
<li>maven-snapshotsï¼šç§åº“å¿«ç…§ jarï¼Œå³åº“ä¸­çš„ jar å‡ä¸ºè°ƒè¯•ç‰ˆæœ¬</li>
<li>maven-publicï¼šä»“åº“åˆ†ç»„ï¼ŒæŠŠä¸Šé¢ä¸‰ä¸ªä»“åº“ç»„åˆåœ¨ä¸€èµ·å¯¹å¤–æä¾›æœåŠ¡ï¼Œåœ¨æœ¬åœ° maven çš„ settings.xml æ–‡ä»¶æˆ–é¡¹ç›®çš„ pom.xml æ–‡ä»¶è®¾ç½®ä¸ºè¯¥ä»“åº“åœ°å€ï¼Œå³å¯è°ƒç”¨</li>
</ul>
<h2 id="ä»“åº“ç±»å‹è¯´æ˜"><a href="#ä»“åº“ç±»å‹è¯´æ˜" class="headerlink" title="ä»“åº“ç±»å‹è¯´æ˜"></a>ä»“åº“ç±»å‹è¯´æ˜</h2><ul>
<li>groupï¼šä»“åº“ç»„ï¼Œèµ·åˆ°äº†èšåˆçš„ä½œç”¨ï¼Œåœ¨è¯¥ç»„ä¸­çš„ä»“åº“éƒ½å¯ä»¥é€šè¿‡è¯¥ç»„çš„ URL è¿›è¡Œè®¿é—®</li>
<li>hostedï¼šç§æœ‰ä»“åº“ï¼Œé¡¾åæ€ä¹‰ï¼Œç”¨æ¥å­˜å‚¨è‡ªå·±çš„ jar åŒ…</li>
<li>snapshotï¼šå¿«ç…§ä»“åº“</li>
<li>releaseï¼šæœ¬åœ°é¡¹ç›®çš„æ­£å¼ç‰ˆæœ¬ä»“åº“</li>
<li>proxyï¼šä»£ç†ï¼ŒNexus çš„ maven-central å°±æ˜¯è¿™ç§ç±»å‹ï¼Œä»£ç†åœ°å€ä¸º <code>https://repo1.maven.org/maven2/</code> ï¼Œé»˜è®¤ä¼šå»è¯¥åœ°å€ä¸‹æ‹‰å– jar åŒ…</li>
<li>centralï¼šä¸­å¤®ä»“åº“</li>
</ul>
<h2 id="æ–°å¢ä»£ç†ä»“åº“"><a href="#æ–°å¢ä»£ç†ä»“åº“" class="headerlink" title="æ–°å¢ä»£ç†ä»“åº“"></a>æ–°å¢ä»£ç†ä»“åº“</h2><p>åˆ›å»ºä»“åº“é€‰æ‹© <code>maven2(proxy)</code> ç±»å‹</p>
<p><img src="/2024/02/18/nexus/%E6%96%B0%E5%A2%9E%E4%BB%A3%E7%90%86%E4%BB%93%E5%BA%93.png" alt="æ–°å¢ä»£ç†ä»“åº“"></p>
<p>æ·»åŠ åˆ° <code>maven-public</code></p>
<p><img src="/2024/02/18/nexus/%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%BB%84.png" alt="æ·»åŠ åˆ°ç»„"></p>
<h2 id="Maven-é…ç½®ä½¿ç”¨ç§æœ"><a href="#Maven-é…ç½®ä½¿ç”¨ç§æœ" class="headerlink" title="Maven é…ç½®ä½¿ç”¨ç§æœ"></a>Maven é…ç½®ä½¿ç”¨ç§æœ</h2><p>è¦åœ¨æœ¬åœ° Maven åœ¨ç§æœæ‹‰å– jar çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>settings.xmlï¼šå…¨å±€é…ç½®æ¨¡å¼</li>
<li>pom.xmlï¼šé¡¹ç›®ç‹¬äº«æ¨¡å¼</li>
</ul>
<p>å¦‚æœä¸¤ç§æ–¹å¼éƒ½é…ç½®äº†ï¼Œé‚£ä¹ˆä»¥ pom.xml æ–‡ä»¶é…ç½®ä¸ºå‡†ã€‚</p>
<p>å½“æˆ‘ä»¬é€šè¿‡ Maven ä½¿ç”¨ Nexus çš„ <code>maven-public</code> çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§ä»¥ä¸‹æ–¹å¼é¡ºåºè®¿é—®ï¼š</p>
<ol>
<li><p>æœ¬åœ°ä»“åº“</p>
</li>
<li><p>ç§æœ maven-releases</p>
</li>
<li><p>ç§æœ maven-snapshots</p>
</li>
<li><p>è¿œç¨‹é˜¿é‡Œ maven ä»“åº“</p>
</li>
<li><p>è¿œç¨‹ä¸­å¤®ä»“åº“</p>
</li>
</ol>
<h3 id="é€šè¿‡-settings-xml-æ–‡ä»¶é…ç½®"><a href="#é€šè¿‡-settings-xml-æ–‡ä»¶é…ç½®" class="headerlink" title="é€šè¿‡ settings.xml æ–‡ä»¶é…ç½®"></a>é€šè¿‡ settings.xml æ–‡ä»¶é…ç½®</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- serverså—ä¸­æ·»åŠ ç”¨æˆ·è®¤è¯ä¿¡æ¯ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">password</span>&gt;</span>changeme<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mirrorså—ä¸­æ·»åŠ maven-publicä¿¡æ¯ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- å”¯ä¸€æ ‡è¯†ç¬¦ --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line">   <span class="comment">&lt;!-- åç§° --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>cqm maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- maven-publicåœ°å€ --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.159.11:35826/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- *æŒ‡çš„æ˜¯è®¿é—®ä»»ä½•ä»“åº“éƒ½ä½¿ç”¨æˆ‘ä»¬çš„ç§æœï¼Œå¯è®¾ç½®ä¸ºcentralç­‰ç­‰ --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºé˜¿é‡Œçš„</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡-pom-xml-æ–‡ä»¶é…ç½®"><a href="#é€šè¿‡-pom-xml-æ–‡ä»¶é…ç½®" class="headerlink" title="é€šè¿‡ pom.xml æ–‡ä»¶é…ç½®"></a>é€šè¿‡ pom.xml æ–‡ä»¶é…ç½®</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>mnexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>cqm nexus<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.159.11:35826/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åŒæ ·ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºé˜¿é‡Œçš„</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>fail<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨-Maven-æ‰¹é‡å‘-Nexus-ä¸Šä¼ "><a href="#ä½¿ç”¨-Maven-æ‰¹é‡å‘-Nexus-ä¸Šä¼ " class="headerlink" title="ä½¿ç”¨ Maven æ‰¹é‡å‘ Nexus ä¸Šä¼ "></a>ä½¿ç”¨ Maven æ‰¹é‡å‘ Nexus ä¸Šä¼ </h2><p>é¦–å…ˆéœ€è¦å°† <code>.m2/repository</code> ä¸‹çš„ç›¸åº” jar åŒ…å’Œ pom æ–‡ä»¶ cp å‡ºæ¥ï¼Œå†è¿›è¡Œ deployã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-DrepositoryId å‚æ•°è°ƒç”¨äº† settings.xml ä¸­ servers å—çš„è´¦å·å¯†ç è¿›è¡Œè®¤è¯</span></span><br><span class="line">find . -name &quot;*.jar&quot; | awk &#x27;&#123; gsub(&quot;\.jar$&quot;,&quot;&quot;,$0); print &quot;mvn deploy:deploy-file -Dfile=&quot;$0&quot;.jar -DpomFile=&quot;$0&quot;.pom -Dpackaging=jar -DrepositoryId=nexus -Durl=\&quot;http://nexus-path\&quot;&quot;&#125;&#x27;	</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:58.270Z" title="2/18/2024, 7:02:58 PM">2024-02-18</time></span><span class="level-item">18 minutes read (About 2754 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/zookeeper/">Zookeeper</a></p><div class="content"><p><img src="/2024/02/18/zookeeper/logo.jpg" alt="logo"></p>
<p>ZooKeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå¼€æ”¾æºç çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡ï¼Œæ˜¯ Hadoop å’Œ Hbase çš„é‡è¦ç»„ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›ä¸€è‡´æ€§æœåŠ¡çš„è½¯ä»¶ï¼Œæä¾›çš„åŠŸèƒ½åŒ…æ‹¬ï¼šé…ç½®ç»´æŠ¤ã€åŸŸåæœåŠ¡ã€åˆ†å¸ƒå¼åŒæ­¥ã€ç»„æœåŠ¡ç­‰ã€‚</p>
<h2 id="ä¸€ã€ZookeeperåŸºç¡€"><a href="#ä¸€ã€ZookeeperåŸºç¡€" class="headerlink" title="ä¸€ã€ZookeeperåŸºç¡€"></a>ä¸€ã€ZookeeperåŸºç¡€</h2><h3 id="1-1-ä½¿ç”¨åœºæ™¯"><a href="#1-1-ä½¿ç”¨åœºæ™¯" class="headerlink" title="1.1 ä½¿ç”¨åœºæ™¯"></a>1.1 ä½¿ç”¨åœºæ™¯</h3><ul>
<li>åˆ†å¸ƒå¼åè°ƒç»„ä»¶ï¼šé€šè¿‡ watch æœºåˆ¶å¯ä»¥åè°ƒå¥½èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§</li>
<li>åˆ†å¸ƒå¼é”ï¼šé€šè¿‡åˆ†å¸ƒå¼é”å¯ä»¥åšåˆ°å¼ºä¸€è‡´æ€§</li>
<li>æ— çŠ¶æ€åŒ–å®ç°</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…</li>
<li>å‘½åæœåŠ¡</li>
</ul>
<h3 id="1-2-éƒ¨ç½²"><a href="#1-2-éƒ¨ç½²" class="headerlink" title="1.2 éƒ¨ç½²"></a>1.2 éƒ¨ç½²</h3><p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>zoo.cfg</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/datalog</span><br><span class="line"><span class="comment"># åŸºæœ¬æ—¶é—´é…ç½®ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># åˆå§‹åŒ–è¿æ¥åˆ°leaderçš„æœ€å¤§æ—¶é•¿ï¼Œå•ä½ä¸ºå€æ•°ï¼Œå³åˆå§‹åŒ–æ—¶é—´ä¸ºtickTime * initLimit</span></span><br><span class="line">initLimit=5</span><br><span class="line"><span class="comment"># followerä¸leaderæ•°æ®åŒæ­¥çš„æœ€å¤§æ—¶é•¿</span></span><br><span class="line">syncLimit=2</span><br><span class="line"><span class="comment"># ä¿å­˜æ•°æ®çš„å¿«ç…§æ•°é‡</span></span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line"><span class="comment"># è‡ªåŠ¨è§¦å‘æ¸…é™¤ä»»åŠ¡æ—¶é—´é—´éš”ï¼Œä»¥å°æ—¶ä¸ºå•ä½ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ä¸æ¸…é™¤</span></span><br><span class="line">autopurge.purgeInterval=0</span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯ä¸zkçš„æœ€å¤§å¹¶å‘è¿æ¥æ•°</span></span><br><span class="line">maxClientCnxns=60</span><br><span class="line"><span class="comment"># å¼€å¯standaloneEnabledæ¨¡å¼ï¼Œå³ç‹¬ç«‹éƒ¨ç½²</span></span><br><span class="line">standaloneEnabled=<span class="literal">true</span></span><br><span class="line"><span class="comment"># å¼€å¯adminServer</span></span><br><span class="line">admin.enableServer=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 2181æ˜¯ä¸ºå®¢æˆ·ç«¯æä¾›çš„ç«¯å£</span></span><br><span class="line">server.1=zk01:2888:3888;2181</span><br></pre></td></tr></table></figure>

<h3 id="1-3-åŸºæœ¬å‘½ä»¤"><a href="#1-3-åŸºæœ¬å‘½ä»¤" class="headerlink" title="1.3 åŸºæœ¬å‘½ä»¤"></a>1.3 åŸºæœ¬å‘½ä»¤</h3><ol>
<li>å¯åŠ¨|å…³é—­|æŸ¥çœ‹çŠ¶æ€</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start|stop|status</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è¿›å…¥ zk</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æŸ¥çœ‹å†…éƒ¨æ•°æ®ç»“æ„</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls [path]</span><br></pre></td></tr></table></figure>



<h2 id="äºŒã€å†…éƒ¨æ•°æ®ç»“æ„"><a href="#äºŒã€å†…éƒ¨æ•°æ®ç»“æ„" class="headerlink" title="äºŒã€å†…éƒ¨æ•°æ®ç»“æ„"></a>äºŒã€å†…éƒ¨æ•°æ®ç»“æ„</h2><h3 id="2-1-æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„"><a href="#2-1-æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„" class="headerlink" title="2.1 æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„"></a>2.1 æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„</h3><p>Zookeeper ä¸­çš„æ•°æ®æ˜¯ä¿å­˜åœ¨èŠ‚ç‚¹ä¸Šçš„ï¼Œå³ znodeï¼Œå¤šä¸ª znode å°±æ„æˆä¸€ä¸ªæ ‘çš„ç»“æ„ã€‚</p>
<p><img src="/2024/02/18/zookeeper/zk%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png" alt="zkæ•°æ®å­˜å‚¨ç»“æ„"></p>
<p>å¦‚å›¾ï¼Œa å’Œ b å°±æ˜¯ Zookeeper çš„ znodeï¼Œåˆ›å»º znode æ–¹å¼å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create /[znode_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºèŠ‚ç‚¹å¹¶åˆ›å»ºä¸€ä¸ªæ•°æ®</span></span><br><span class="line">create /[znode_name] [data_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–æ•°æ®</span></span><br><span class="line">get [znode_name]</span><br></pre></td></tr></table></figure>

<h3 id="2-2-znodeç»“æ„"><a href="#2-2-znodeç»“æ„" class="headerlink" title="2.2 znodeç»“æ„"></a>2.2 znodeç»“æ„</h3><p>Zookeeper ä¸­çš„ zonodeï¼ŒåŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>dataï¼šä¿å­˜æ•°æ®</li>
<li>aclï¼šæƒé™<ul>
<li>cï¼šåˆ›å»ºæƒé™</li>
<li>wï¼šå†™æƒé™</li>
<li>rï¼šè¯»æƒé™</li>
<li>dï¼šåˆ é™¤æƒé™</li>
<li>aï¼šadmin ç®¡ç†è€…æƒé™</li>
</ul>
</li>
<li>statï¼šæè¿°å½“å‰ znode çš„å…ƒæ•°æ®</li>
<li>childï¼šå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹znodeè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">get -s /[znode_name]</span><br><span class="line">cZxid:åˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡ID</span><br><span class="line">ctime:åˆ›å»ºèŠ‚ç‚¹æ—¶é—´</span><br><span class="line">mZxid:ä¿®æ”¹èŠ‚ç‚¹çš„äº‹åŠ¡ID</span><br><span class="line">mtime:ä¿®æ”¹èŠ‚ç‚¹æ—¶é—´</span><br><span class="line">pZxid:æ·»åŠ å’Œåˆ é™¤å­èŠ‚ç‚¹çš„äº‹åŠ¡ID</span><br><span class="line">cversion:å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ç‰ˆæœ¬å·ï¼Œåˆå§‹å€¼ä¸º-1ï¼Œæ¯å¯¹è¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œè¿™ä¸ªcversionéƒ½ä¼šè‡ªåŠ¨å¢åŠ </span><br><span class="line">dataVersion:æ•°æ®ç‰ˆæœ¬åˆè¯†ç‰ˆæœ¬ä¸º0ï¼Œæ¯å¯¹è¯¥èŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿™ä¸ªdataVersionéƒ½ä¼šè‡ªåŠ¨å¢åŠ </span><br><span class="line">aclVersion:æƒé™ç‰ˆæœ¬</span><br><span class="line">ephemeralOwne:å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¯¥å€¼æ˜¯å½“å‰èŠ‚ç‚¹çš„session idï¼Œå¦‚æœä¸æ˜¯ä¸´æ—¶èŠ‚ç‚¹åˆ™ä¸º0</span><br><span class="line">dataLength:æ•°æ®é•¿åº¦</span><br><span class="line">numChildren:è¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°</span><br></pre></td></tr></table></figure>

<h3 id="2-3-znodeç±»å‹"><a href="#2-3-znodeç±»å‹" class="headerlink" title="2.3 znodeç±»å‹"></a>2.3 znodeç±»å‹</h3><ul>
<li>æŒä¹…èŠ‚ç‚¹ï¼šåœ¨ä¼šè¯ç»“æŸåä»ä¼šå­˜åœ¨</li>
<li>æŒä¹…åºå·èŠ‚ç‚¹ï¼šæ ¹æ®å…ˆåé¡ºåºï¼Œä¼šåœ¨ç»“ç‚¹ä¹‹åå¸¦ä¸Šä¸€ä¸ªæ•°å€¼ï¼Œé€‚ç”¨äºåˆ†å¸ƒå¼é”çš„åœºæ™¯ï¼ˆå•è°ƒé€’å¢ï¼‰</li>
<li>ä¸´æ—¶èŠ‚ç‚¹ï¼šä¼šè¯ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤ï¼Œé€‚ç”¨äºæ³¨å†Œä¸æœåŠ¡å‘ç°çš„åœºæ™¯</li>
<li>ä¸´æ—¶åºå·èŠ‚ç‚¹ï¼šè·ŸæŒä¹…åºå·èŠ‚ç‚¹ç›¸åŒï¼Œé€‚ç”¨äºåˆ†å¸ƒå¼é”çš„åœºæ™¯</li>
<li>å®¹å™¨èŠ‚ç‚¹ï¼šå½“å®¹å™¨èŠ‚ç‚¹ä¸­æ²¡æœ‰ä»»ä½•å­èŠ‚ç‚¹æ—¶ï¼Œè¯¥å®¹å™¨èŠ‚ç‚¹ä¼šè¢«å®šæœŸåˆ é™¤ï¼ˆ60sï¼‰</li>
<li>TTL èŠ‚ç‚¹ï¼šå¯ä»¥æŒ‡å®šèŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´</li>
</ul>
<p><strong>æŒä¹…åºå·èŠ‚ç‚¹åˆ›å»º</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>ä¸´æ—¶èŠ‚ç‚¹åˆ›å»º</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>ä¸´æ—¶åºå·èŠ‚ç‚¹åˆ›å»º</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>å®¹å™¨èŠ‚ç‚¹åˆ›å»º</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -c /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>TTL èŠ‚ç‚¹åˆ›å»º</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€šè¿‡ç³»ç»Ÿé…ç½®å¼€å¯</span></span><br><span class="line">zookeeper.extendedTypesEnabled=true</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/zookeeper/%E6%8C%81%E4%B9%85%E4%B8%8E%E4%B8%B4%E6%97%B6%E8%8A%82%E7%82%B9.png" alt="æŒä¹…ä¸ä¸´æ—¶èŠ‚ç‚¹"></p>
<p><strong>æŒä¹…èŠ‚ç‚¹</strong></p>
<p>æŒä¹…èŠ‚ç‚¹åœ¨åˆ›å»ºåæœåŠ¡ç«¯ä¼šå‘é€ä¸€ä¸ª <code>session id</code>ï¼Œå¹¶ä¸€ç›´ä¿ç•™ç€ã€‚</p>
<p><strong>ä¸´æ—¶èŠ‚ç‚¹</strong></p>
<p>ä¸´æ—¶èŠ‚ç‚¹åœ¨åˆ›å»ºæ—¶åæœåŠ¡å™¨ä¹Ÿä¼šå‘é€ä¸€ä¸ª <code>session id</code>ï¼Œåœ¨ä¼šè¯æŒç»­çš„è¿‡ç¨‹ä¸­å®¢æˆ·ç«¯ä¼šä¸æ–­å‘æœåŠ¡ç«¯ç»­çº¦ <code>session id</code> çš„æ—¶é—´ï¼Œå½“å®¢æˆ·ç«¯æ²¡æœ‰ç»§ç»­ç»­çº¦ï¼Œè€ŒæœåŠ¡ç«¯å†…éƒ¨çš„è®¡æ—¶å™¨åˆ°æœŸæ—¶ï¼Œå°±ä¼šå°†è¯¥ <code>session id</code> æ‰€å¯¹åº”çš„ znode å…¨éƒ¨åˆ é™¤ã€‚</p>
<h3 id="2-4-æŒä¹…åŒ–æœºåˆ¶"><a href="#2-4-æŒä¹…åŒ–æœºåˆ¶" class="headerlink" title="2.4 æŒä¹…åŒ–æœºåˆ¶"></a>2.4 æŒä¹…åŒ–æœºåˆ¶</h3><p>Zookeeper çš„æ•°æ®æ˜¯è¿è¡Œåœ¨å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥æä¾›äº†ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼š</p>
<ul>
<li>äº‹åŠ¡æ—¥å¿—ï¼šZookeeper å°†æ‰§è¡Œè¿‡çš„å‘½ä»¤ä»¥æ—¥å¿—çš„å½¢å¼å­˜å‚¨åœ¨ dataLogDir &#x2F; dataDir ä¸­ï¼Œç±»ä¼¼äº redis çš„ AOF</li>
<li>æ•°æ®å¿«ç…§ï¼šåœ¨ä¸€å®šæ—¶é—´é—´éš”å†…åšä¸€æ¬¡æ•°æ®å¿«ç…§ï¼Œå­˜å‚¨åœ¨å¿«ç…§æ–‡ä»¶ä¸­ï¼ˆsnapshotï¼‰ï¼Œç±»ä¼¼äº redis çš„RDB</li>
</ul>
<p>Zookeeper é€šè¿‡è¿™ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼Œåœ¨æ¢å¤æ•°æ®æ—¶å…ˆå°†å¿«ç…§æ–‡ä»¶ä¸­çš„æ•°æ®æ¢å¤åˆ°å†…å­˜ä¸­ï¼Œå†ç”¨æ—¥å¿—æ–‡ä»¶ä¸­çš„æ•°æ®åšå¢é‡æ¢å¤ï¼Œå¯ä»¥å®ç°é«˜æ•ˆçš„æŒä¹…åŒ–ã€‚</p>
<h2 id="ä¸‰ã€zkCliçš„ä½¿ç”¨"><a href="#ä¸‰ã€zkCliçš„ä½¿ç”¨" class="headerlink" title="ä¸‰ã€zkCliçš„ä½¿ç”¨"></a>ä¸‰ã€zkCliçš„ä½¿ç”¨</h2><ol>
<li>é€’å½’æŸ¥è¯¢</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -R /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ é™¤èŠ‚ç‚¹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deleteall /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ä¹è§‚é”åˆ é™¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete -v [version] /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç»™å½“å‰ä¼šè¯æ³¨å†Œç”¨æˆ·ï¼Œå¹¶åˆ›å»ºèŠ‚ç‚¹èµ‹äºˆè¯¥ç”¨æˆ·æƒé™</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addauth digest [user]:[password]</span><br><span class="line">create /[znode_name] auth:[user]:[password]:[privileges]</span><br></pre></td></tr></table></figure>



<h2 id="å››ã€åˆ†å¸ƒå¼é”"><a href="#å››ã€åˆ†å¸ƒå¼é”" class="headerlink" title="å››ã€åˆ†å¸ƒå¼é”"></a>å››ã€åˆ†å¸ƒå¼é”</h2><p>åœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸‹ï¼Œå¦‚æœåœ¨ä¸€ä¸ªèŠ‚ç‚¹å»ä¸Šäº†ä¸ªé”ï¼Œå½“è¯·æ±‚è¢«è´Ÿè½½å‡è¡¡åˆ†é…åˆ°äº†å…¶å®ƒèŠ‚ç‚¹ï¼Œé‚£ä¹ˆé”å°±æ— æ³•å½¢æˆäº’æ–¥ï¼Œæ‰€ä»¥èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨ Zookeeperï¼Œåšä¸€ä¸ªåè°ƒä¸­å¿ƒï¼Œå°†é”ä¸Šä¼ åˆ° Zookeeperï¼Œå…¶å®ƒèŠ‚ç‚¹è¦ç”¨åˆ°å°±å» Zookeeper æ‹¿è¿™ä¸ªé”ï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”ã€‚</p>
<p>Zookeeper é”çš„åˆ†ç±»ï¼š</p>
<ul>
<li>è¯»é”ï¼šå¤§å®¶éƒ½å¯ä»¥è¯»ï¼Œå‰ææ˜¯ä¹‹å‰æ²¡æœ‰å†™é”ã€‚ï¼ˆè¯»é”æ¯”å–»æˆçº¦ä¼šï¼Œå¤§å®¶éƒ½æœ‰æœºä¼šå’Œå¥³ç¥çº¦ä¼šï¼Œçº¦ä¼šå‰ææ˜¯å¥³ç¥æ²¡ç»“å©šï¼‰</li>
<li>å†™é”ï¼šåªæœ‰å†™é”æ‰èƒ½å†™ï¼Œå‰ææ˜¯ä¸èƒ½æœ‰ä»»ä½•é”ã€‚ï¼ˆå†™é”æ¯”å–»æˆç»“å©šï¼Œç»“å©šååªæœ‰è€å…¬èƒ½å’Œå¥³ç¥çº¦ä¼šï¼Œç»“å©šå‰ææ˜¯å¥³ç¥å’Œå…¶ä»–äººçš„å…³ç³»æ–­å¹²å‡€äº†ï¼‰</li>
</ul>
<h3 id="4-1-ä¸Šè¯»é”"><a href="#4-1-ä¸Šè¯»é”" class="headerlink" title="4.1 ä¸Šè¯»é”"></a>4.1 ä¸Šè¯»é”</h3><ul>
<li>åˆ›å»ºä¸€ä¸ªä¸´æ—¶åºå·èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹æ•°æ®æ˜¯ readï¼Œè¡¨ç¤ºä¸ºè¯»é”</li>
<li>è·å–å½“å‰ Zookeeper ä¸­åºå·æ¯”è‡ªå·±å°çš„æ‰€æœ‰èŠ‚ç‚¹</li>
<li>åˆ¤æ–­æœ€å°èŠ‚ç‚¹æ˜¯å¦ä¸ºè¯»é”ï¼š<ul>
<li>å¦‚æœæ˜¯è¯»é”ï¼šåˆ™ä¸Šé”å¤±è´¥ï¼Œå› ä¸ºå¦‚æœæœ€å°èŠ‚ç‚¹æ˜¯è¯»é”ï¼Œé‚£ä¹ˆåé¢å°±ä¸å¯èƒ½æœ‰å†™é”ï¼Œæ¥ç€ä¸ºæœ€å°èŠ‚ç‚¹è®¾ç½®ç›‘å¬ï¼ŒZookeeper çš„ watch æœºåˆ¶ä¼šåœ¨æœ€å°èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥å½“å‰èŠ‚ç‚¹ï¼Œå†è¿›è¡Œåé¢çš„æ­¥éª¤ï¼Œè¢«ç§°ä¸ºé˜»å¡ç­‰å¾…</li>
<li>å¦‚æœä¸æ˜¯è¯»é”ï¼šåˆ™ä¸Šé”æˆåŠŸ</li>
</ul>
</li>
</ul>
<h3 id="4-2-ä¸Šå†™é”"><a href="#4-2-ä¸Šå†™é”" class="headerlink" title="4.2 ä¸Šå†™é”"></a>4.2 ä¸Šå†™é”</h3><ul>
<li>åˆ›å»ºä¸€ä¸ªä¸´æ—¶åºå·èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹æ•°æ®æ˜¯ writeï¼Œè¡¨ç¤ºä¸ºå†™é”</li>
<li>è·å– Zookeeper ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹</li>
<li>åˆ¤æ–­è‡ªå·±æ˜¯å¦ä¸ºæœ€å°èŠ‚ç‚¹ï¼š<ul>
<li>å¦‚æœæ˜¯ï¼šä¸Šé”æˆåŠŸ</li>
<li>å¦‚æœä¸æ˜¯ï¼šè¯´æ˜å‰é¢è¿˜æœ‰é”ï¼Œæ‰€ä»¥ä¸Šé”å¤±è´¥ï¼Œæ¥ç€ç›‘å¬æœ€å°èŠ‚ç‚¹ï¼Œå¦‚æœæœ€å°èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼Œåˆ™é‡æ–°è¿›è¡Œç¬¬äºŒæ­¥</li>
</ul>
</li>
</ul>
<p><strong>ç¾Šç¾¤æ•ˆåº”</strong></p>
<p>å‡è®¾æœ‰ä¸€ç™¾ä¸ªè¯·æ±‚éƒ½æ˜¯è¦å»å†™é”ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ä¸€ç™¾ä¸ªè¯·æ±‚å»ç›‘å¬æœ€å°èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ Zookeeper çš„å‹åŠ›å°±ä¼šéå¸¸å¤§ï¼Œè§£å†³æ–¹æ³•æ˜¯å°†è¿™ä¸€ç™¾ä¸ªè¯·æ±‚æŒ‰è¯·æ±‚é¡ºåºæ’åˆ—ï¼Œåä¸€ä¸ªè¯·æ±‚å»ç›‘å¬å‰ä¸€ä¸ªè¯·æ±‚å³å¯ï¼Œå®ç°é“¾å¼ç›‘å¬ã€‚</p>
<h3 id="4-3-watchæœºåˆ¶"><a href="#4-3-watchæœºåˆ¶" class="headerlink" title="4.3 watchæœºåˆ¶"></a>4.3 watchæœºåˆ¶</h3><p>Zookeeper çš„ watch å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè§¦å‘å™¨ï¼Œå½“ç›‘æ§çš„ znode å‘ç”Ÿæ”¹å˜ï¼Œå°±ä¼šè§¦å‘ znode ä¸Šæ³¨å†Œçš„å¯¹åº”äº‹ä»¶ï¼Œè¯·æ±‚ watch çš„å®¢æˆ·ç«¯å°±ä¼šæ¥æ”¶åˆ°å¼‚æ­¥é€šçŸ¥ã€‚</p>
<p><strong>zkCli.sh ä¸­ä½¿ç”¨ watch</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸€æ¬¡æ€§ç›‘å¬ï¼Œç›‘å¬èŠ‚ç‚¹å†…å®¹</span></span><br><span class="line">get -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç›‘å¬ç›®å½•ï¼Œä½†æ‰€ç›‘å¬èŠ‚ç‚¹ä¸‹åˆ›å»ºå’Œåˆ é™¤å­èŠ‚ç‚¹ä¸ä¼šè§¦å‘ç›‘å¬</span></span><br><span class="line">ls -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸ä¸Šé¢ç›¸å¯¹ï¼Œéƒ½ä¼šè§¦å‘ç›‘å¬</span></span><br><span class="line">ls -R -w /test</span><br></pre></td></tr></table></figure>



<h2 id="äº”ã€é›†ç¾¤éƒ¨ç½²"><a href="#äº”ã€é›†ç¾¤éƒ¨ç½²" class="headerlink" title="äº”ã€é›†ç¾¤éƒ¨ç½²"></a>äº”ã€é›†ç¾¤éƒ¨ç½²</h2><p>Zookeeper çš„é›†ç¾¤è§’è‰²æœ‰ä¸‰ä¸ªï¼š</p>
<ul>
<li>Leaderï¼šå¤„ç†é›†ç¾¤æ‰€æœ‰äº‹åŠ¡çš„è¯·æ±‚ï¼Œé›†ç¾¤åªæœ‰ä¸€ä¸ª Leader</li>
<li>Followerï¼šåªå¤„ç†è¯»è¯·æ±‚ï¼Œå‚ä¸ Leader é€‰ä¸¾</li>
<li>Observerï¼šåªå¤„ç†è¯»è¯·æ±‚ï¼Œæå‡é›†ç¾¤çš„æ€§èƒ½ï¼Œä½†ä¸èƒ½å‚ä¸ Leader é€‰ä¸¾</li>
</ul>
<p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zk01:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="comment"># 2888:ç”¨äºé›†ç¾¤å†…zkä¹‹é—´çš„é€šä¿¡</span></span><br><span class="line">      <span class="comment"># 3888:ç”¨äºé€‰ä¸¾æŠ•ç¥¨</span></span><br><span class="line">      <span class="comment"># 2181:å®¢æˆ·ç«¯ä½¿ç”¨</span></span><br><span class="line">      <span class="comment"># è¦åˆ›å»ºobserveråˆ™åœ¨2181ç«¯å£ååŠ :observer</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">zk02:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2182</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">zk03:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2183</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡å‘½ä»¤æŸ¥çœ‹èŠ‚ç‚¹è§’è‰²</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh status</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure>

<p><strong>è¿æ¥é›†ç¾¤</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh -server zk01:2181,zk02:2181,zk03:2181</span><br></pre></td></tr></table></figure>

<h3 id="5-1-ZABåè®®"><a href="#5-1-ZABåè®®" class="headerlink" title="5.1 ZABåè®®"></a>5.1 ZABåè®®</h3><p>ZABï¼ˆZookeeper Atomic Broadcastï¼‰å³ Zookeeper åŸå­å¹¿æ’­åè®®ï¼Œé€šè¿‡è¿™ä¸ªåè®®è§£å†³äº†é›†ç¾¤æ•°æ®ä¸€è‡´æ€§å’Œå´©æºƒæ¢å¤çš„é—®é¢˜ã€‚</p>
<p><strong>ZAB åè®®ä¸­èŠ‚ç‚¹çš„å››ç§çŠ¶æ€</strong></p>
<ul>
<li>Lookingï¼šé€‰ä¸¾çŠ¶æ€</li>
<li>Following</li>
<li>Leading</li>
<li>Observing</li>
</ul>
<p><strong>åˆå§‹åŒ–é›†ç¾¤æ—¶ leader çš„é€‰ä¸¾</strong></p>
<ul>
<li>å½“é›†ç¾¤ä¸­ä¸¤å°èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œå°±ä¼šå¼€å§‹ leader çš„é€‰ä¸¾ï¼Œé€‰ç¥¨çš„æ ¼å¼ä¸º <code>(myid,zXid)</code></li>
<li>ç¬¬ä¸€è½®æŠ•ç¥¨æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šç”Ÿæˆè‡ªå·±çš„é€‰ç¥¨ï¼Œå³è‡ªå·±çš„ <code>(myid,zXid)</code>ï¼Œç„¶åå°†é€‰ç¥¨ç»™åˆ°å¯¹æ–¹ï¼Œè¿™æ—¶å€™æ¯ä¸ªèŠ‚ç‚¹å°±ä¼šæœ‰ä¸¤å¼ é€‰ç¥¨ï¼Œå³è‡ªå·±çš„å’Œå¯¹æ–¹èŠ‚ç‚¹çš„</li>
<li>æ¥ç€å°±ä¼šæ¯”è¾ƒä¸¤å¼ é€‰ç¥¨çš„ <code>zXid</code>ï¼Œå¦‚æœéƒ½ç›¸åŒå°±å¯¹æ¯” <code>myid</code>ï¼Œå°†å¤§çš„ä¸€ç¥¨æŠ•åˆ°æŠ•ç¥¨ç®±ä¸­</li>
<li>ç¬¬äºŒè½®æŠ•ç¥¨æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šå°†ä¸Šä¸€è½®æŠ•å‡ºå»çš„é€‰ç¥¨ç»™åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œç„¶åå†å¯¹æ¯” <code>(myid,zXid)</code>ï¼Œå°†å¤§çš„ä¸€ç¥¨æŠ•å‡ºå»ï¼Œå°±èƒ½å¤Ÿé€‰å‡º leader</li>
<li>åæ¥æ–°å¯åŠ¨çš„èŠ‚ç‚¹ä¼šå‘ç°å·²ç»æœ‰ leaderäº†ï¼Œå°±ä¸ç”¨åšé€‰ä¸¾çš„è¿‡ç¨‹äº†</li>
<li>å¯ä»¥çœ‹å‡ºåˆå§‹åŒ–é›†ç¾¤æ—¶ï¼Œleader çš„é€‰ä¸¾ä¸»è¦çœ‹ <code>myid</code></li>
</ul>
<p><strong>å´©æºƒæ¢å¤æ—¶çš„ leader é€‰ä¸¾</strong></p>
<p>åœ¨ leader ç¡®å®šäº†ä¹‹åï¼Œleader ä¼šå‘¨æœŸæ€§åœ°å‘ follower å‘é€å¿ƒè·³åŒ…ï¼Œå½“ follower æ²¡æœ‰æ”¶åˆ° leader å‘é€è¿‡æ¥çš„å¿ƒè·³åŒ…ï¼Œå°±ä¼šè¿›å…¥é€‰ä¸¾è¿‡ç¨‹ï¼Œè¿™æ—¶å€™é›†ç¾¤ä¸èƒ½å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<ul>
<li>å½“ leader æŒ‚äº†ä¹‹åï¼Œfollower çš„çŠ¶æ€ä¼šå˜æˆ looking</li>
<li>æ¥ç€å°±è¿›è¡Œé€‰ä¸¾æŠ•ç¥¨ï¼Œè¿‡ç¨‹å’Œåˆå§‹åŒ–é›†ç¾¤æ—¶ä¸€æ ·</li>
</ul>
<h3 id="5-2-ä¸»ä»åŒæ­¥åŸç†"><a href="#5-2-ä¸»ä»åŒæ­¥åŸç†" class="headerlink" title="5.2 ä¸»ä»åŒæ­¥åŸç†"></a>5.2 ä¸»ä»åŒæ­¥åŸç†</h3><p><img src="/2024/02/18/zookeeper/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86.png" alt="ä¸»ä»åŒæ­¥åŸç†"></p>
<h3 id="5-3-NIOå’ŒBIO"><a href="#5-3-NIOå’ŒBIO" class="headerlink" title="5.3 NIOå’ŒBIO"></a>5.3 NIOå’ŒBIO</h3><p><strong>NIO</strong></p>
<p>ç”¨äºè¢«å®¢æˆ·ç«¯è¿æ¥çš„ 2181 ç«¯å£ï¼Œä½¿ç”¨çš„å°±æ˜¯ NIO çš„è¿æ¥æ¨¡å¼ï¼›å®¢æˆ·ç«¯å¼€å¯ watch æ—¶ï¼Œä½¿ç”¨çš„ä¹Ÿæ˜¯ NIOã€‚</p>
<p><strong>BIO</strong></p>
<p>é›†ç¾¤åœ¨è¿›è¡Œé€‰ä¸¾æ—¶ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ç«¯å£ï¼Œä½¿ç”¨çš„æ˜¯ BIO çš„è¿æ¥æ¨¡å¼ã€‚</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:24.353Z" title="2/18/2024, 7:02:24 PM">2024-02-18</time></span><span class="level-item">an hour read (About 10192 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/web/">Web</a></p><div class="content"><h2 id="ä¸€ã€Apache"><a href="#ä¸€ã€Apache" class="headerlink" title="ä¸€ã€Apache"></a>ä¸€ã€Apache</h2><h3 id="1-1-Apacheä»‹ç»"><a href="#1-1-Apacheä»‹ç»" class="headerlink" title="1.1 Apacheä»‹ç»"></a>1.1 Apacheä»‹ç»</h3><p>Apache HTTP Serverï¼ˆç®€ç§°Apacheï¼‰æ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€ä¸ªå¼€æ”¾æºç çš„ç½‘é¡µæœåŠ¡å™¨ï¼Œæ˜¯ä¸–ç•Œä½¿ç”¨æ’åç¬¬ä¸€çš„WebæœåŠ¡å™¨è½¯ä»¶ã€‚å®ƒå¯ä»¥è¿è¡Œåœ¨å‡ ä¹æ‰€æœ‰å¹¿æ³›ä½¿ç”¨çš„è®¡ç®—æœºå¹³å°ä¸Šï¼Œç”±äºå…¶è·¨å¹³å°å’Œå®‰å…¨æ€§è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæ˜¯æœ€æµè¡Œçš„WebæœåŠ¡å™¨ç«¯è½¯ä»¶ä¹‹ä¸€ã€‚å®ƒå¿«é€Ÿã€å¯é å¹¶ä¸”å¯é€šè¿‡ç®€å•çš„APIæ‰©å……ï¼Œå°†Perl&#x2F;Pythonç­‰è§£é‡Šå™¨ç¼–è¯‘åˆ°æœåŠ¡å™¨ä¸­ã€‚</p>
<p>Apache HTTPæœåŠ¡å™¨æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–çš„æœåŠ¡å™¨ï¼ŒæºäºNCSAhttpdæœåŠ¡å™¨ï¼Œç»è¿‡å¤šæ¬¡ä¿®æ”¹ï¼Œæˆä¸ºä¸–ç•Œä½¿ç”¨æ’åç¬¬ä¸€çš„WebæœåŠ¡å™¨è½¯ä»¶ã€‚</p>
<p>Apacheå®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="http://httpd.apache.org/docs/">http://httpd.apache.org/docs/</a></p>
<h3 id="1-2-é€šè¿‡è„šæœ¬æºç å®‰è£…Apache"><a href="#1-2-é€šè¿‡è„šæœ¬æºç å®‰è£…Apache" class="headerlink" title="1.2 é€šè¿‡è„šæœ¬æºç å®‰è£…Apache"></a>1.2 é€šè¿‡è„šæœ¬æºç å®‰è£…Apache</h3><ol>
<li>ç¼–å†™å®‰è£…è„šæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -r www</span><br><span class="line">vim apache-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apr_version=1.7.0</span><br><span class="line">apr_iconv_version=1.2.2</span><br><span class="line">apr_util_version=1.6.1</span><br><span class="line">apache_version=2.4.46</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ£€æŸ¥</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·</span></span><br><span class="line">   if [ $USER != &#x27;root&#x27; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">æ£€æŸ¥æ˜¯å¦å®‰è£…äº†wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å®‰è£…å‰å‡†å¤‡</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…ä¾èµ–</span></span><br><span class="line">   if [ ! `yum -y install zlib-devel pcre-devel libxml2 expat-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½apr</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/apr/apr-$&#123;apr_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-$&#123;apr_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-$&#123;apr_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-$&#123;apr_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-$&#123;apr_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-$&#123;apr_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…apr</span></span><br><span class="line">   echo &quot;apr configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">	   echo -e &quot;\e[1;32m apr installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">	   echo -e &quot;\e[1;31m apr installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½apr-iconv</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-iconv-$&#123;apr_iconv_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-iconv-$&#123;apr_iconv_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-iconv-$&#123;apr_iconv_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…apr-iconv</span></span><br><span class="line">   echo &quot;apr-iconv configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-iconv --with-apr=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then </span><br><span class="line">       echo &quot;apr-iconv make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-iconv installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-iconv installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-iconv configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½apr-util</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-util-$&#123;apr_util_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-util-$&#123;apr_util_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-util-$&#123;apr_util_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-util-$&#123;apr_util_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-util-$&#123;apr_util_version&#125;</span><br><span class="line">       fi  </span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-util-$&#123;apr_util_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…apr-util</span></span><br><span class="line">   echo &quot;apr-util configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr-util make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-util installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-util installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-util configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¸‹è½½å®‰è£…Apache</span></span><br><span class="line">function apache_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½Apache</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/httpd/httpd-$&#123;apache_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf httpd-$&#123;apache_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d httpd-$&#123;apache_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd httpd-$&#123;apache_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…Apache</span></span><br><span class="line">   echo &quot;Apache configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apache --enable-mpms-shared=all --with-mpm=event --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-so --enable-remoteip --enable-proxy --enable-proxy-fcgi --enable-proxy-uwsgi --enable-deflate=shared --enable-expires=shared --enable-rewrite=shared --enable-cache --enable-file-cache --enable-mem-cache --enable-disk-cache --enable-static-support --enable-static-ab --disable-userdir --enable-nonportable-atomics --disable-ipv6 --with-sendfile &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;Apache make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m Apache installed sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m Apache installed failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m Apache configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">apache_install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™å¯åŠ¨è„šæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apache_doc=/usr/local/apache/bin</span><br><span class="line">apache_pid=/usr/local/apache/logs/httpd.pid</span><br><span class="line"></span><br><span class="line">function apache_start()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $apache_num -eq 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall httpd</span><br><span class="line">   fi</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl</span><br><span class="line">   echo -e &quot;start Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_stop()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       killall httpd</span><br><span class="line">       echo -e &quot;stop Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_restart()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl restart</span><br><span class="line">   echo -e &quot;restart Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_status()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_reload()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       cd /usr/local/apache/bin;./apachectl graceful</span><br><span class="line">       echo -e &quot;reload Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        apache_start</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        apache_stop</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">restart)</span><br><span class="line">        apache_restart</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">status)</span><br><span class="line">        apache_status</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">reload)</span><br><span class="line">        apache_reload</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="1-3-å¤šå¤„ç†æ¨¡å—MPM"><a href="#1-3-å¤šå¤„ç†æ¨¡å—MPM" class="headerlink" title="1.3 å¤šå¤„ç†æ¨¡å—MPM"></a>1.3 å¤šå¤„ç†æ¨¡å—MPM</h3><p>Apache HTTP æœåŠ¡å™¨è¢«è®¾è®¡ä¸ºä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ï¼Œå¹¶ä¸”çµæ´»çš„ web æœåŠ¡å™¨ï¼Œ å¯ä»¥åœ¨å¾ˆå¤šå¹³å°ä¸ç¯å¢ƒä¸­å·¥ä½œã€‚ä¸åŒå¹³å°å’Œä¸åŒçš„ç¯å¢ƒå¾€å¾€éœ€è¦ä¸åŒ çš„ç‰¹æ€§ï¼Œæˆ–å¯èƒ½ä»¥ä¸åŒçš„æ–¹å¼å®ç°ç›¸åŒçš„ç‰¹æ€§æœ€æœ‰æ•ˆç‡ã€‚Apache é€šè¿‡æ¨¡å—åŒ–çš„è®¾è®¡æ¥é€‚åº”å„ç§ç¯å¢ƒã€‚è¿™ç§è®¾è®¡å…è®¸ç½‘ç«™ç®¡ç†å‘˜é€šè¿‡åœ¨ ç¼–è¯‘æ—¶æˆ–è¿è¡Œæ—¶ï¼Œé€‰æ‹©å“ªäº›æ¨¡å—å°†ä¼šåŠ è½½åœ¨æœåŠ¡å™¨ä¸­ï¼Œæ¥é€‰æ‹©æœåŠ¡å™¨ç‰¹æ€§ã€‚</p>
<p>å®é™…ä¸Šå°±æ˜¯ç”¨æ¥<strong>æ¥å—è¯·æ±‚</strong>å’Œ<strong>å¤„ç†è¯·æ±‚</strong>çš„ã€‚</p>
<p>Apacheçš„ä¸‰ç§å·¥ä½œæ–¹å¼ï¼š</p>
<ol>
<li>Prefork MPMï¼šä½¿ç”¨å¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹å†æŸä¸ªç¡®å®šçš„æ—¶é—´åªèƒ½ç»´æŒä¸€ä¸ªè¿æ¥ï¼Œæœ‰ç‚¹æ˜¯ç¨³å®šï¼Œç¼ºç‚¹æ˜¯å†…å­˜æ¶ˆè€—è¿‡é«˜ã€‚</li>
</ol>
<p>![Prefork MPM](Prefork MPM.png)</p>
<ol>
<li>Worker MPMï¼šä½¿ç”¨å¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨æŸä¸ªç¡®å®šçš„æ—¶é—´åªèƒ½ç»´æŒä¸€ä¸ªè¿æ¥ï¼Œå†…å­˜å ç”¨æ¯”è¾ƒå°ï¼Œæ˜¯ä¸ªå¤§å¹¶å‘ã€é«˜æµé‡çš„åœºæ™¯ï¼Œç¼ºç‚¹æ˜¯ä¸€ä¸ªçº¿ç¨‹å´©æºƒï¼Œæ•´ä¸ªè¿›ç¨‹å°±ä¼šè¿åŒå…¶ä»»ä½•çº¿ç¨‹ä¸€èµ·æŒ‚æ‰ã€‚</li>
</ol>
<p>![Worker MPM](Worker MPM.png)</p>
<ol start="3">
<li>Event MPMï¼šä½¿ç”¨å¤šè¿›ç¨‹å¤šçº¿ç¨‹+epollçš„æ¨¡å¼ã€‚</li>
</ol>
<p>![Event MPM](Event MPM.png)</p>
<h3 id="1-4-è™šæ‹Ÿä¸»æœº"><a href="#1-4-è™šæ‹Ÿä¸»æœº" class="headerlink" title="1.4 è™šæ‹Ÿä¸»æœº"></a>1.4 è™šæ‹Ÿä¸»æœº</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªwebæœåŠ¡å™¨åªèƒ½å‘å¸ƒä¸€ä¸ªé»˜è®¤ç½‘ç«™ï¼Œä¹Ÿå°±æ˜¯åªèƒ½å‘å¸ƒä¸€ä¸ªwebç«™ç‚¹ï¼Œå¯¹äºå¤§ç½‘ç«™æ¥è¯´è¿˜å¥½ï¼Œä½†å¯¹äºè®¿é—®é‡è¾ƒå°‘çš„å°ç½‘ç«™é‚£å°±æ˜¾å¾—æœ‰ç‚¹æµªè´¹äº†ã€‚</p>
<p>è€Œè™šæ‹Ÿä¸»æœºå°±å¯ä»¥å®ç°åœ¨ä¸€ä¸ªwebæœåŠ¡å™¨ä¸Šå‘å¸ƒå¤šä¸ªç«™ç‚¹ï¼Œåˆ†ä¸ºåŸºäºIPåœ°å€ã€åŸŸåå’Œç«¯å£ä¸‰ç§ã€‚</p>
<p>Apacheçš„è™šæ‹Ÿä¸»æœºå’Œé»˜è®¤ç½‘ç«™ä¸èƒ½å¤ŸåŒæ—¶å­˜åœ¨ï¼Œå¦‚æœè®¾ç½®äº†è™šæ‹Ÿä¸»æœºé‚£ä¹ˆé»˜è®¤ç½‘ç«™ä¹Ÿå°±å¤±æ•ˆäº†ï¼Œéœ€è¦åœ¨ç”¨è™šæ‹Ÿä¸»æœºå‘å¸ƒé»˜è®¤ç«™ç‚¹æ‰å¯è§£å†³ã€‚</p>
<p>åŸºäºIPï¼šåŸºäºIPçš„è™šæ‹Ÿä¸»æœºéœ€è¦è€—è´¹å¤§é‡çš„IPåœ°å€ï¼Œåªé€‚åˆIPåœ°å€å……è¶³çš„ç¯å¢ƒã€‚</p>
<p>åŸºäºç«¯å£ï¼šéœ€è¦è€—è´¹è¾ƒå¤šçš„ç«¯å£ï¼Œé€‚åˆç§ç½‘ç¯å¢ƒã€‚</p>
<p>åŸºäºåŸŸåï¼šéœ€è¦è€—è´¹è¾ƒå¤šçš„åŸŸåï¼Œé€‚åˆå…¬ç½‘ç¯å¢ƒã€‚</p>
<h4 id="1-4-1-åŸºäºIPçš„è™šæ‹Ÿä¸»æœº"><a href="#1-4-1-åŸºäºIPçš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="1.4.1 åŸºäºIPçš„è™šæ‹Ÿä¸»æœº"></a>1.4.1 åŸºäºIPçš„è™šæ‹Ÿä¸»æœº</h4><ol>
<li>åœ¨ä¸»é…æ–‡ä»¶ä¸­è°ƒç”¨è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Virtual hosts</span></span><br><span class="line">Include conf/extra/httpd-vhosts.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ ä¸€ä¸ªé€»è¾‘ç½‘å¡ï¼Œé‡å¯å³å¤±æ•ˆ</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost 49.232.160.75:80&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">ç®¡ç†å‘˜é‚®ç®±</span></span><br><span class="line">    # ServerAdmin webmaster@dummy-host.example.com</span><br><span class="line">    # webç›®å½•</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    # åŸŸå</span><br><span class="line">    # ServerName dummy-host.example.com</span><br><span class="line">    # ç»™åŸŸåèµ·åˆ«åï¼Œèµ·åˆ°é‡å®šå‘ä½œç”¨</span><br><span class="line">    # ServerAlias www.dummy-host.example.com</span><br><span class="line">    # é”™è¯¯æ—¥å­</span><br><span class="line">    # ErrorLog &quot;logs/dummy-host.example.com-error_log&quot;</span><br><span class="line">    # è®¿é—®æ—¥å¿—</span><br><span class="line">    # CustomLog &quot;logs/dummy-host.example.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.88.100:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ›å»ºç«™ç‚¹ç›®å½•å’Œæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/apache/htdocs/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/apache/htdocs/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/apache/htdocs/web2/index.html</span><br><span class="line">./apache start</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æµ‹è¯•</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8EIP%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="åŸºäºIPè™šæ‹Ÿä¸»æœºæµ‹è¯•"></p>
<h4 id="1-4-2-åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº"><a href="#1-4-2-åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="1.4.2 åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº"></a>1.4.2 åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº</h4><ol>
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">Listen 81</span><br><span class="line">&lt;VirtualHost *:81&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æµ‹è¯•</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E7%AB%AF%E5%8F%A3%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="åŸºäºç«¯å£è™šæ‹Ÿä¸»æœºæµ‹è¯•"></p>
<h4 id="1-4-3-åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº"><a href="#1-4-3-åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="1.4.3 åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº"></a>1.4.3 åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº</h4><ol>
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    ServerName www.cqm1.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">    ServerName www.cqm2.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æµ‹è¯•</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="åŸºäºåŸŸåè™šæ‹Ÿä¸»æœºæµ‹è¯•"></p>
<h3 id="1-5-LAMP"><a href="#1-5-LAMP" class="headerlink" title="1.5 LAMP"></a>1.5 LAMP</h3><p>LAMPï¼šLinux + Apache + Mysql + PHP</p>
<p>ä½œç”¨å°±æ˜¯æ„å»ºä¸€ä¸ªPHPä¸šåŠ¡ç¯å¢ƒï¼Œç”¨æ¥å‘å¸ƒPHPç½‘ç«™ã€‚</p>
<h4 id="1-5-1-Mysqlé€šè¿‡è„šæœ¬æºç å®‰è£…"><a href="#1-5-1-Mysqlé€šè¿‡è„šæœ¬æºç å®‰è£…" class="headerlink" title="1.5.1 Mysqlé€šè¿‡è„šæœ¬æºç å®‰è£…"></a>1.5.1 Mysqlé€šè¿‡è„šæœ¬æºç å®‰è£…</h4><ol>
<li>ç¼–å†™å®‰è£…è„šæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mysql_version=5.7.35</span><br><span class="line">install_dir=/opt</span><br><span class="line">data_dir=/data</span><br><span class="line">wget_url=&quot;https://mirrors.tuna.tsinghua.edu.cn/mysql/downloads/MySQL-5.7/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz&quot;</span><br><span class="line"></span><br><span class="line">function loginfo()&#123;</span><br><span class="line">    if [[ $? -eq 0 ]];then</span><br><span class="line">        echo -e &quot;\033[32m[INFO][$(date +&quot;%F %T&quot;)] $1 succeed! \033[0m&quot;</span><br><span class="line">    else</span><br><span class="line">        echo -e &quot;\033[31m[ERROR][$(date +&quot;%F %T&quot;)] $1 failed! \033[0m&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mysql_install()&#123;</span><br><span class="line">    echo -e &quot;\033[32mBegin install mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    </span><br><span class="line">    # å®‰è£…ä¾èµ–</span><br><span class="line">    sudo yum -y install libaio &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;libaio install&quot;</span><br><span class="line"></span><br><span class="line">    # ä¸‹è½½mysql</span><br><span class="line">    echo -e &quot;\033[32mBegin download mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    curl -O $wget_url &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    mv ./mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz $install_dir</span><br><span class="line">    loginfo &quot;mysql software download&quot;</span><br><span class="line"></span><br><span class="line">    # è§£å‹ç¼©mysql</span><br><span class="line">    sudo tar -xf $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz -C $install_dir</span><br><span class="line">    loginfo &quot;mysql software decompression&quot;</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•å’Œæ•°æ®ç›®å½•</span><br><span class="line">    if [[ -d $install_dir/mysql ]];then</span><br><span class="line">        rm -rf $install_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo ln -s $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64 $install_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql config dir soft link&quot;</span><br><span class="line">    if [[ -d $data_dir/mysql ]];then</span><br><span class="line">        rm -rf $data_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo mkdir -p $data_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql data dir&quot;</span><br><span class="line"></span><br><span class="line">    # ä¿®æ”¹å¯åŠ¨è„šæœ¬</span><br><span class="line">    sudo sed -i &quot;46s#basedir=#basedir=$&#123;install_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo sed -i &quot;47s#datadir=#datadir=$&#123;data_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo cp $&#123;install_dir&#125;/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">    sudo chmod 755 /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºç”¨æˆ·ç»„åŠç”¨æˆ·</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/group</span><br><span class="line">    then</span><br><span class="line">        sudo groupadd mysql</span><br><span class="line">        loginfo &quot;create user mysql&quot;</span><br><span class="line">    fi</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/passwd</span><br><span class="line">    then</span><br><span class="line">        sudo useradd -r -g mysql -s /bin/false mysql</span><br><span class="line">        loginfo &quot;create group mysql&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # æˆæƒ</span><br><span class="line">    sudo chown -R mysql:mysql $install_dir/mysql</span><br><span class="line">    sudo chown -R mysql:mysql $data_dir/mysql</span><br><span class="line"></span><br><span class="line">    # ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºè½¯è¿æ¥</span><br><span class="line">    if [ ! -f /usr/bin/mysql ]</span><br><span class="line">    then</span><br><span class="line">        sudo ln -s /opt/mysql/bin/mysql /usr/bin/</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºé…ç½®æ–‡ä»¶</span><br><span class="line">    if [ -f /etc/my.cnf ]</span><br><span class="line">    then</span><br><span class="line">        sudo rm -f /etc/my.cnf</span><br><span class="line">    fi</span><br><span class="line">    sudo bash -c &quot;cat &gt;&gt; /etc/my.cnf&quot; &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">datadir                             = /data/mysql</span><br><span class="line">basedir                             = /opt/mysql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">tmpdir                              = /data/mysql/tmp_mysql</span></span><br><span class="line">port                                = 3306</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">pid-file                            = /data/mysql/mysql.pid</span><br><span class="line">max_connections                     = 8000</span><br><span class="line">max_connect_errors                  = 100000</span><br><span class="line">max_user_connections                = 3000</span><br><span class="line">check_proxy_users                   = on</span><br><span class="line">mysql_native_password_proxy_users   = on</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">symbolic-links                      = FALSE</span><br><span class="line">group_concat_max_len                = 4294967295</span><br><span class="line">max_join_size                       = 18446744073709551615</span><br><span class="line">max_execution_time                  = 20000</span><br><span class="line">lock_wait_timeout                   = 60</span><br><span class="line">autocommit                          = 1</span><br><span class="line">lower_case_table_names              = 1</span><br><span class="line">thread_cache_size                   = 64</span><br><span class="line">disabled_storage_engines            = &quot;MyISAM,FEDERATED&quot;</span><br><span class="line">character_set_server                = utf8mb4</span><br><span class="line">character-set-client-handshake      = FALSE</span><br><span class="line">collation_server                    = utf8mb4_general_ci</span><br><span class="line">init_connect                        = &#x27;SET NAMES utf8mb4&#x27;</span><br><span class="line">transaction-isolation               = &quot;READ-COMMITTED&quot;</span><br><span class="line">skip_name_resolve                   = ON</span><br><span class="line">explicit_defaults_for_timestamp     = ON</span><br><span class="line">log_timestamps                      = SYSTEM</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">event_scheduler                     = OFF</span><br><span class="line">query_cache_type                    = OFF</span><br><span class="line">query_cache_size                    = 0</span><br><span class="line">sql_mode                            = NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO</span><br><span class="line">log_error                           = /data/mysql/mysql.err</span><br><span class="line">slow_query_log                      = ON</span><br><span class="line">slow_query_log_file                 = /data/mysql/slow.log</span><br><span class="line">long_query_time                     = 1</span><br><span class="line">general_log                         = OFF</span><br><span class="line">general_log_file                    = /data/mysql/general.log</span><br><span class="line">expire_logs_days                    = 99</span><br><span class="line">log-bin                             = /data/mysql/mysql-bin</span><br><span class="line">log-bin-index                       = /data/mysql/mysql-bin.index</span><br><span class="line">max_binlog_size                     = 500M</span><br><span class="line">binlog_format                       = mixed</span><br><span class="line">binlog_rows_query_log_events        = ON</span><br><span class="line">binlog_cache_size                   = 128k</span><br><span class="line">binlog_stmt_cache_size              = 128k</span><br><span class="line">log-bin-trust-function-creators     = 1</span><br><span class="line">max_binlog_cache_size               = 2G</span><br><span class="line">max_binlog_stmt_cache_size          = 2G</span><br><span class="line">relay_log                           = /data/mysql/relay</span><br><span class="line">relay_log_index                     = /data/mysql/relay.index</span><br><span class="line">max_relay_log_size                  = 500M</span><br><span class="line">relay_log_purge                     = ON</span><br><span class="line">relay_log_recovery                  = ON</span><br><span class="line">server_id                           = 1</span><br><span class="line">read_buffer_size                    = 1M</span><br><span class="line">read_rnd_buffer_size                = 2M</span><br><span class="line">sort_buffer_size                    = 64M</span><br><span class="line">join_buffer_size                    = 64M</span><br><span class="line">tmp_table_size                      = 64M</span><br><span class="line">max_allowed_packet                  = 128M</span><br><span class="line">max_heap_table_size                 = 64M</span><br><span class="line">connect_timeout                     = 43200</span><br><span class="line">wait_timeout                        = 43200</span><br><span class="line">back_log                            = 512</span><br><span class="line">interactive_timeout                 = 300</span><br><span class="line">net_read_timeout                    = 30</span><br><span class="line">net_write_timeout                   = 30</span><br><span class="line">skip_external_locking               = ON</span><br><span class="line">key_buffer_size                     = 16M</span><br><span class="line">bulk_insert_buffer_size             = 16M</span><br><span class="line">concurrent_insert                   = ALWAYS</span><br><span class="line">open_files_limit                    = 65000</span><br><span class="line">table_open_cache                    = 16000</span><br><span class="line">table_definition_cache              = 16000</span><br><span class="line">default_storage_engine              = InnoDB</span><br><span class="line">default_tmp_storage_engine          = InnoDB</span><br><span class="line">internal_tmp_disk_storage_engine    = InnoDB</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[ndatad default]</span><br><span class="line">TransactionDeadLockDetectionTimeOut = 20000</span><br><span class="line">EOF</span><br><span class="line">    sudo chown -R mysql:mysql /etc/my.cnf</span><br><span class="line">    loginfo &quot;configure my.cnf&quot;</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºSSLè¯ä¹¦</span><br><span class="line">    # sudo mkdir -p $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line">    # sudo $&#123;install_dir&#125;/mysql/bin/mysql_ssl_rsa_setup -d $&#123;install_dir&#125;/mysql/ca-pem/ --uid=mysql</span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line"></span><br><span class="line">    # sudo bash -c &quot;cat &gt;&gt; $&#123;data_dir&#125;/mysql/init_file.sql&quot; &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_safe_updates=0;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_select_limit=50000;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">EOF</span></span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;data_dir&#125;/mysql/init_file.sql</span><br><span class="line">    # sudo chown -R mysql:mysql /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # åˆå§‹åŒ–</span><br><span class="line">    $&#123;install_dir&#125;/mysql/bin/mysqld --initialize --user=mysql --basedir=$&#123;DEPLOY_PATH&#125;/mysql --datadir=/data/mysql </span><br><span class="line">    loginfo &quot;initialize mysql&quot;</span><br><span class="line"></span><br><span class="line">    # å®¢æˆ·ç«¯ç¯å¢ƒå˜é‡</span><br><span class="line">    echo &quot;export PATH=\$PATH:$&#123;install_dir&#125;/mysql/bin&quot; | sudo tee /etc/profile.d/mysql.sh</span><br><span class="line">    source /etc/profile.d/mysql.sh</span><br><span class="line">    loginfo &quot;configure envirement&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–åˆå§‹å¯†ç </span><br><span class="line">    mysql_init_passwd=$(grep &#x27;A temporary password is generated&#x27; $&#123;data_dir&#125;/mysql/mysql.err | awk &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    # å¯åŠ¨æœåŠ¡</span><br><span class="line">    chkconfig --add mysqld</span><br><span class="line">    sudo systemctl start mysqld</span><br><span class="line">    loginfo &quot;start mysqld&quot;</span><br><span class="line"></span><br><span class="line">    # ä¿®æ”¹å¯†ç </span><br><span class="line">    mysql --connect-expired-password -uroot -p$&#123;mysql_init_passwd&#125; -e &#x27;alter user user() identified by &quot;toortoor&quot;;&#x27; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;edit mysql root password&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_install</span><br></pre></td></tr></table></figure>

<h4 id="1-5-2-PHPé€šè¿‡è„šæœ¬æºç å®‰è£…"><a href="#1-5-2-PHPé€šè¿‡è„šæœ¬æºç å®‰è£…" class="headerlink" title="1.5.2 PHPé€šè¿‡è„šæœ¬æºç å®‰è£…"></a>1.5.2 PHPé€šè¿‡è„šæœ¬æºç å®‰è£…</h4><ol>
<li>ç¼–å†™å®‰è£…è„šæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cmake_version=3.22.0</span><br><span class="line">libzip_version=1.8.0</span><br><span class="line">php_version=7.4.16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ£€æŸ¥</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">æ£€æŸ¥æ˜¯å¦å®‰è£…äº†wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å®‰è£…å‰å‡†å¤‡</span></span><br><span class="line">function pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…ä¾èµ–åŒ…</span></span><br><span class="line">   if [ ! `yum -y install gcc-c++ libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel gd net-snmp-* sqlite-devel oniguruma-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½æœ€æ–°ç‰ˆcmake</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://github.com/Kitware/CMake/releases/download/v$&#123;cmake_version&#125;/cmake-$&#123;cmake_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">      tar -xf cmake-$&#123;cmake_version&#125;.tar.gz</span><br><span class="line">      if [ ! -d cmake-$&#123;cmake_version&#125; ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;31m error:no found cmake-$&#123;cmake_version&#125;  \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      else</span><br><span class="line">         cd cmake-$&#123;cmake_version&#125;</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:Failed to download cmake-$&#123;cmake_version&#125; \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…cmake</span></span><br><span class="line">   echo &quot;cmake configure...&quot;</span><br><span class="line">   ./configure &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">      echo &quot;cmake make &amp;&amp; make install...&quot;</span><br><span class="line">      make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">      if [ `echo $?` -eq 0 ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;32m cmake installed sucessfully \e[0m&quot;</span><br><span class="line">      else</span><br><span class="line">         echo -e &quot;\e[1;31m cmake installed failed \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:cmake configure failed \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½libzip1.1ä»¥ä¸Šç‰ˆæœ¬</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget --no-check-certificate https://libzip.org/download/libzip-$&#123;libzip_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar libzip...&quot;</span><br><span class="line">       tar -xf libzip-$&#123;libzip_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d libzip-$&#123;libzip_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found libzip-$&#123;libzip_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd libzip-$&#123;libzip_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download libzip-$&#123;libzip_version&#125;.tar.gz \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…libzip</span></span><br><span class="line">   mkdir build;cd build</span><br><span class="line">   echo &quot;cmake libzip...&quot;</span><br><span class="line">   cmake .. &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install libzip...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m libzip install sucessfully \e[0m&quot;</span><br><span class="line">           echo -e &#x27;/usr/local/lib64\n/usr/local/lib\n/usr/lib\n/usr/lib64&#x27;&gt;&gt; /etc/ld.so.conf</span><br><span class="line">           ldconfig -v &amp;&gt; /dev/null</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:libzip install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:lipzip cmake failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½php</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.php.net/distributions/php-$&#123;php_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar php...&quot;</span><br><span class="line">       tar -xf php-$&#123;php_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d php-$&#123;php_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found php-$&#123;php_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd php-$&#123;php_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download php-$&#123;php_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">å®‰è£…php</span></span><br><span class="line">   echo &quot;configure php...&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">è¦phpä»¥apacheæ¨¡å—è¿è¡Œéœ€åŠ ä¸Š--with-apxs2=/usr/localapache/bin/apxså‚æ•°</span></span><br><span class="line">   ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-mysqli=mysqlnd --enable-pdo --with-pdo-mysql=mysqlnd --with-iconv-dir=/usr/local/ --enable-fpm --with-fpm-user=www --with-fpm-group=www --with-pcre-regex --with-zlib --with-bz2 --enable-calendar --disable-phar --with-curl --enable-dba --with-libxml-dir --enable-ftp --with-gd --with-jpeg-dir --with-png-dir --with-zlib-dir --with-freetype-dir --enable-gd-jis-conv --with-mhash --enable-mbstring --enable-opcache=yes --enable-pcntl --enable-xml --disable-rpath --enable-shmop --enable-sockets --enable-zip --enable-bcmath --with-snmp --disable-ipv6 --with-gettext --disable-rpath --disable-debug --enable-embedded-mysqli --with-mysql-sock=/var/lib/mysql/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install php...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m php install sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m php install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m configure php failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_set()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -f /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service ]</span><br><span class="line">    then</span><br><span class="line">        echo -e &quot;\e[1;31m No found php-fpm.service \e[0m&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    else</span><br><span class="line">        cp /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service /etc/systemd/system</span><br><span class="line">        if [ `echo $?` -ne 0 ]</span><br><span class="line">        then</span><br><span class="line">            echo -e &quot;\e[1;31m Copy php-fpm.service failed \e[0m&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        else</span><br><span class="line">            sed -i &#x27;/PrivateTmp=true/a\ProtectSystem=false&#x27; /etc/systemd/system/php-fpm.service</span><br><span class="line">            systemctl daemon-reload</span><br><span class="line">            echo -e &quot;\e[1;32m php set sucessfully \e[0m&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">pre</span><br><span class="line">php_install</span><br><span class="line">php_set</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®PHP</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/php/etc</span><br><span class="line">cp php-fpm.conf.default php-fpm.conf</span><br><span class="line">cp php-fpm.d/www.conf.default php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.conf</span><br><span class="line">[global]</span><br><span class="line">pid = run/php-fpm.pid</span><br><span class="line">error_log = log/php-fpm.log</span><br><span class="line">daemonize = yes</span><br><span class="line">include=/usr/local/php/etc/php-fpm.d/*.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.d/www.conf</span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line">listen.mode = 0660</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 5</span><br><span class="line">pm.start_servers = 2</span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line">pm.max_spare_servers = 3</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯åŠ¨</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm</span><br></pre></td></tr></table></figure>

<h4 id="1-5-3-PHPä½œä¸ºApacheæ¨¡å—è¿è¡Œ"><a href="#1-5-3-PHPä½œä¸ºApacheæ¨¡å—è¿è¡Œ" class="headerlink" title="1.5.3 PHPä½œä¸ºApacheæ¨¡å—è¿è¡Œ"></a>1.5.3 PHPä½œä¸ºApacheæ¨¡å—è¿è¡Œ</h4><ol>
<li>åœ¨apacheä¸»é…ç½®æ–‡ä»¶ä¸­è°ƒç”¨å­é…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®å­é…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/php.con</span><br><span class="line">LoadModule php7_module modules/libphp7.so</span><br><span class="line">AddType application/x-httpd-php .php</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>é…ç½®è™šæ‹Ÿä¸»æœº</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å†™webç›®å½•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;this is cqm web&#x27; &gt; /usr/local/apache/htdocs/web/index.html</span><br><span class="line">vim /usr/local/apache/htdocs/web/phpinfo.php</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>æµ‹è¯•</li>
</ol>
<p><img src="/2024/02/18/web/php%E4%BB%A5%E6%A8%A1%E5%9D%97%E8%BF%90%E8%A1%8C.png" alt="phpä»¥æ¨¡å—è¿è¡Œ"></p>
<h4 id="1-5-4-PHPä½œä¸ºç‹¬ç«‹æœåŠ¡è¿è¡Œ"><a href="#1-5-4-PHPä½œä¸ºç‹¬ç«‹æœåŠ¡è¿è¡Œ" class="headerlink" title="1.5.4 PHPä½œä¸ºç‹¬ç«‹æœåŠ¡è¿è¡Œ"></a>1.5.4 PHPä½œä¸ºç‹¬ç«‹æœåŠ¡è¿è¡Œ</h4><p>PHPä½œä¸ºç‹¬ç«‹æœåŠ¡è¿è¡Œæœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>TCP socketæ¨¡å¼</li>
<li>UNIX socketæ¨¡å¼</li>
</ul>
<p><strong>TCP socketæ¨¡å¼</strong></p>
<ol>
<li>ä¿®æ”¹<a target="_blank" rel="noopener" href="http://www.confæ–‡ä»¶/">www.confæ–‡ä»¶</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = 127.0.0.1:9000</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web&quot;&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">	AllowOverride None</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">	DirectoryIndex index.php index.html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">	SetHandler &quot;proxy:fcgi://127.0.0.1:9000&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åœ¨apacheä¸»é…æ–‡ä»¶æ·»åŠ å…³è”</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php-fpm.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>é…ç½®å­é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/php-fpm.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è½½å…¥éœ€è¦çš„æ¨¡å—</span></span><br><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</span><br></pre></td></tr></table></figure>

<p><strong>UNIX socketæ¨¡å¼</strong></p>
<ol>
<li>ä¿®æ”¹<a target="_blank" rel="noopener" href="http://www.confæ–‡ä»¶/">www.confæ–‡ä»¶</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = /usr/local/php/etc/php-fpm.socket</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®è™šæ‹Ÿä¸»æœº</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">        SetHandler &quot;proxy:unix:/usr/local/php/etc/php-fpm.socket|fcgi://localhost/&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-6-Apacheå¸¸ç”¨æ¨¡å—"><a href="#1-6-Apacheå¸¸ç”¨æ¨¡å—" class="headerlink" title="1.6 Apacheå¸¸ç”¨æ¨¡å—"></a>1.6 Apacheå¸¸ç”¨æ¨¡å—</h3><h4 id="1-6-1-é•¿è¿æ¥"><a href="#1-6-1-é•¿è¿æ¥" class="headerlink" title="1.6.1 é•¿è¿æ¥"></a>1.6.1 é•¿è¿æ¥</h4><p>HTTPé‡‡ç”¨TCPè¿›è¡Œä¼ è¾“ï¼Œæ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œæ¯å®Œæˆä¸€æ¬¡è¯·æ±‚å°±è¦ç»å†ä»¥ä¸‹è¿‡ç¨‹ï¼š</p>
<ul>
<li>ä¸‰æ¬¡æ¡æ‰‹</li>
<li>å‘èµ·è¯·æ±‚</li>
<li>å“åº”è¯·æ±‚</li>
<li>å››æ¬¡æŒ¥æ‰‹</li>
</ul>
<p>é‚£ä¹ˆNä¸ªè¯·æ±‚å°±è¦å»ºç«‹Næ¬¡è¿æ¥ï¼Œå¦‚æœå¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿæ›´å¿«çš„æ‹¿åˆ°æ•°æ®ï¼ŒæœåŠ¡å™¨çš„å‹åŠ›é™åˆ°æœ€ä½ï¼Œé‚£ä¹ˆé é•¿è¿æ¥å°±å¯ä»¥è§£å†³ã€‚</p>
<p>é•¿è¿æ¥å®é™…ä¸Šå°±æ˜¯ä¼˜åŒ–äº†TCPè¿æ¥ã€‚</p>
<p>Apacheé»˜è®¤å¼€å¯äº†é•¿è¿æ¥ï¼ŒæŒç»­æ—¶é—´ä¸º5ç§’ï¼Œåœ¨httpd-default.confä¸­å¯ä»¥å®šä¹‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-default.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¼€å¯é•¿è¿æ¥</span></span><br><span class="line">KeepAlive On</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é™åˆ¶æ¯ä¸ªè¿æ¥å…è®¸çš„è¯·æ±‚æ•°</span></span><br><span class="line">MaxKeepAliveRequests 500</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é•¿è¿æ¥æ—¶é—´</span></span><br><span class="line">KeepAliveTimeout 5</span><br></pre></td></tr></table></figure>

<h4 id="1-6-2-é™æ€ç¼“å­˜"><a href="#1-6-2-é™æ€ç¼“å­˜" class="headerlink" title="1.6.2 é™æ€ç¼“å­˜"></a>1.6.2 é™æ€ç¼“å­˜</h4><p>ç”¨æˆ·æ¯æ¬¡è®¿é—®ç½‘ç«™éƒ½ä¼šå°†é¡µé¢ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½è¯·æ±‚ä¸€éï¼Œå…¨éƒ¨ä¸‹è½½åé€šè¿‡æµè§ˆå™¨æ¸²æŸ“ï¼Œå±•ç¤ºåˆ°æµè§ˆå™¨ä¸­ã€‚ä½†æ˜¯ï¼Œç½‘ç«™ä¸­çš„æŸäº›å…ƒç´ æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯å›ºå®šä¸å˜çš„ï¼Œæ¯”å¦‚logoã€æ¡†æ¶æ–‡ä»¶ç­‰ã€‚ç”¨æˆ·æ¯æ¬¡è®¿é—®éƒ½éœ€è¦åŠ è½½è¿™äº›å…ƒç´ ã€‚è¿™æ ·åšå¥½å¤„æ˜¯ä¿è¯äº†æ•°æ®çš„æ–°é²œï¼Œå¯æ˜¯è¿™äº›æ•°æ®ä¸æ˜¯å¸¸å˜åŒ–çš„ï¼Œå¾ˆä¹…æ‰å˜åŒ–ä¸€æ¬¡ã€‚æ¯æ¬¡éƒ½è¯·æ±‚ã€ä¸‹è½½æµªè´¹äº†ç”¨æˆ·æ—¶é—´å’Œå…¬å¸å¸¦å®½ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬é€šè¿‡é™æ€ç¼“å­˜çš„æ–¹å¼ï¼Œå°†è¿™äº›ä¸å¸¸å˜åŒ–çš„æ•°æ®ç¼“å­˜åˆ°ç”¨æˆ·æœ¬åœ°ç£ç›˜ï¼Œç”¨æˆ·ä»¥åå†è®¿é—®è¿™äº›è¯·æ±‚ï¼Œç›´æ¥ä»æœ¬åœ°ç£ç›˜æ‰“å¼€åŠ è½½ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åŠ è½½é€Ÿåº¦å¿«ï¼Œä¸”èŠ‚çº¦å…¬å¸å¸¦å®½åŠæˆæœ¬ã€‚</p>
<ol>
<li>åœ¨apacheä¸»é…æ–‡ä»¶ä¸­åŠ è½½ç¼“å­˜æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule expires_module modules/mod_expires.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶è°ƒç”¨æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle expires_module&gt;</span><br><span class="line">    #å¼€å¯ç¼“å­˜</span><br><span class="line">    ExpiresActive on</span><br><span class="line">    #é’ˆå¯¹ä¸åŒç±»å‹å…ƒç´ è®¾ç½®ç¼“å­˜æ—¶é—´</span><br><span class="line">    ExpiresByType image/gif  &quot;access plus 1 days&quot;</span><br><span class="line">    ExpiresByType image/jpeg &quot;access plus 24 hours&quot;</span><br><span class="line">    ExpiresByType image/png &quot;access plus 24 hours&quot;</span><br><span class="line">    #now ç›¸å½“äº access</span><br><span class="line">    ExpiresByType text/css &quot;now plus 2 hour&quot;</span><br><span class="line">    ExpiresByType application/x-javascript &quot;now plus 2 hours&quot;</span><br><span class="line">    ExpiresByType application/x-shockwave-flash &quot;now plus 2 hoursâ€</span><br><span class="line">    #å…¶ä»–æ•°æ®ä¸ç¼“å­˜</span><br><span class="line">    ExpiresDefault &quot;now plus 0 min&quot;</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-3-æ•°æ®å‹ç¼©"><a href="#1-6-3-æ•°æ®å‹ç¼©" class="headerlink" title="1.6.3 æ•°æ®å‹ç¼©"></a>1.6.3 æ•°æ®å‹ç¼©</h4><p>æ•°æ®ä»æœåŠ¡å™¨ä¼ è¾“åˆ°å®¢æˆ·ç«¯ï¼Œéœ€è¦ä¼ è¾“æ—¶é—´ï¼Œæ–‡ä»¶è¶Šå¤§ä¼ è¾“æ—¶é—´å°±è¶Šé•¿ï¼Œä¸ºäº†å‡å°‘ä¼ è¾“æ—¶é—´ï¼Œæˆ‘ä»¬ä¸€èˆ¬æŠŠæ•°æ®å‹ç¼©ååœ¨ä¼ ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>apacheæ”¯æŒä¸¤ç§æ¨¡å¼çš„å‹ç¼©ï¼š</p>
<ul>
<li>default</li>
<li>gzip</li>
</ul>
<p>ä¸¤è€…çš„åŒºåˆ«ï¼š</p>
<ul>
<li>mod_deflate å‹ç¼©é€Ÿåº¦å¿«ã€‚</li>
<li>mod_gzip çš„å‹ç¼©æ¯”ç•¥é«˜ã€‚</li>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œmod_gzip ä¼šæ¯” mod_deflate å¤šå‡º 4%~6ï¼… çš„å‹ç¼©é‡ã€‚</li>
<li>mod_gzip å¯¹æœåŠ¡å™¨CPUçš„å ç”¨è¦é«˜ä¸€äº›ï¼Œæ‰€ä»¥ mod_deflate æ˜¯ä¸“é—¨ä¸ºç¡®ä¿æœåŠ¡å™¨çš„æ€§èƒ½è€Œä½¿ç”¨çš„ä¸€ä¸ªå‹ç¼©æ¨¡å—ï¼Œåªéœ€è¾ƒå°‘çš„èµ„æºæ¥è¿›è¡Œå‹ç¼©ã€‚</li>
</ul>
<ol>
<li>åœ¨apacheä¸»é…æ–‡ä»¶ä¸­åŠ è½½å‹ç¼©æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule deflate_module modules/mod_deflate.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶è°ƒç”¨æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle deflate_module&gt;</span><br><span class="line">    #å‹ç¼©ç­‰çº§1-9ï¼Œæ•°å­—è¶Šå¤§å‹ç¼©èƒ½åŠ›è¶Šå¥½ï¼Œç›¸åº”åœ°ä¹Ÿè¶Šè€—CPUæ€§èƒ½</span><br><span class="line">    DeflateCompressionLevel 4</span><br><span class="line">    #å‹ç¼©ç±»å‹ï¼Œhtmlã€xmlã€phpã€cssã€js</span><br><span class="line">	AddOutputFilterByType DEFLATE text/html text/plain text/xml application/x-javascript application/x-httpd-php</span><br><span class="line">	AddOutputFilter DEFLATE js css</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">æµè§ˆå™¨åŒ¹é…ä¸ºIE1-6çš„ä¸å‹ç¼©</span></span><br><span class="line">	BrowserMatch \bMSIE\s[1-6] dont-vary</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">è®¾ç½®ä¸å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:pdf|doc)$ no-gzip dont-vary</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-4-é™é€Ÿ"><a href="#1-6-4-é™é€Ÿ" class="headerlink" title="1.6.4 é™é€Ÿ"></a>1.6.4 é™é€Ÿ</h4><p>ç½‘ç«™é™¤äº†èƒ½å…±äº«é¡µé¢ç»™ç”¨æˆ·å¤–ï¼Œè¿˜èƒ½ä½œä¸ºä¸‹è½½æœåŠ¡å™¨å­˜åœ¨ã€‚ä½†æ˜¯ä½œä¸ºä¸‹è½½æœåŠ¡å™¨æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥è€ƒè™‘æœåŠ¡å™¨çš„å¸¦å®½å’ŒIOçš„æ€§èƒ½ï¼Œé˜²æ­¢éƒ¨åˆ†é‚ªæ¶åˆ†å­ä¼šé€šè¿‡å¤§é‡ä¸‹è½½çš„æ–¹å¼æ¥æ”»å‡»ä½ çš„å¸¦å®½å’ŒæœåŠ¡å™¨IOæ€§èƒ½ã€‚</p>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>å‡å¦‚ä½ çš„æœåŠ¡å™¨è¢«é‚ªæ¶åˆ†å­é€šè¿‡ä¸‹è½½çš„æ–¹å¼æŠŠå¸¦å®½å æ»¡äº†ï¼Œé‚£ä¹ˆä½ æˆ–å…¶ä»–ç”¨æˆ·åœ¨è®¿é—®çš„æ—¶å€™å°±ä¼šé€ æˆè®¿é—®æ…¢æˆ–è€…æ ¹æœ¬æ— æ³•è®¿é—®ã€‚</li>
<li>å‡å¦‚ä½ çš„æœåŠ¡å™¨è¢«é‚ªæ¶åˆ†å­é€šè¿‡ä¸‹è½½çš„æ–¹å¼æŠŠæœåŠ¡å™¨IOå æ»¡äº†ï¼Œé‚£ä¹ˆä½ çš„æœåŠ¡å™¨å°†ä¼šæ— æ³•å¤„ç†ç”¨æˆ·è¯·æ±‚æˆ–å®•æœºã€‚</li>
</ul>
<p>ä»¥ä¸Šé—®é¢˜å¯ä»¥é€šè¿‡é™é€Ÿæ¥è§£å†³ï¼Œapacheè‡ªå¸¦äº†åŸºäºå®½å¸¦é™é€Ÿçš„æ¨¡å—ï¼š</p>
<ul>
<li>ratelimit_moduleï¼šåªèƒ½å¯¹è¿æ¥ä¸‹è½½é€Ÿåº¦åšé™åˆ¶ï¼Œä¸”æ˜¯å•çº¿ç¨‹çš„ä¸‹è½½ï¼Œè¿…é›·ç­‰ä¸‹è½½å·¥å…·ä½¿ç”¨çš„æ˜¯å¤šçº¿ç¨‹ä¸‹è½½ã€‚</li>
<li>mod_limitipconnï¼šé™åˆ¶æ¯ IP çš„è¿æ¥æ•°ï¼Œéœ€è¦é¢å¤–å®‰è£…è¯¥æ¨¡å—ã€‚</li>
</ul>
<p><strong>ratelimit_moduleæ¨¡å—</strong></p>
<ol>
<li>åœ¨apacheä¸»é…æ–‡ä»¶ä¸­åŠ è½½å‹ç¼©æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule ratelimit_module modules/mod_ratelimit.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶è°ƒç”¨æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Locationç›¸å¯¹è·¯å¾„ï¼š/usr/local/apache/htdocs/...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Directoryç»å¯¹è·¯å¾„ï¼š...</span></span><br><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">é™é€Ÿ100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<p><strong>mod_limitipconnæ¨¡å—</strong></p>
<ol>
<li>ä¸‹è½½å®‰è£…æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://dominia.org/djao/limit/mod_limitipconn-0.24.tar.bz2</span><br><span class="line">tar -xf mod_limitipconn-0.24.tar.bz2</span><br><span class="line">cd mod_limitipconn-0.24</span><br><span class="line">vim Makefile</span><br><span class="line">    apxs = &quot;/usr/local/apache/bin/apxs&quot;</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨apacheä¸»é…æ–‡ä»¶å¯ç”¨æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule limitipconn_module modules/mod_limitipconn.so</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶è°ƒç”¨æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">é™é€Ÿ100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">é™åˆ¶çº¿ç¨‹æ•°</span></span><br><span class="line">	MaxConnPerIP 3</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">å¯¹index.htmlæ–‡ä»¶ä¸ä½œé™åˆ¶</span></span><br><span class="line">	NoIPLimit index.html</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-5-è®¿é—®æ§åˆ¶"><a href="#1-6-5-è®¿é—®æ§åˆ¶" class="headerlink" title="1.6.5 è®¿é—®æ§åˆ¶"></a>1.6.5 è®¿é—®æ§åˆ¶</h4><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç½‘ç«™åˆ†ä¸ºå…¬ç«™å’Œç§ç«™ï¼Œå…¬ç«™å…è®¸æ‰€æœ‰äººè®¿é—®ï¼Œä½†ç§ç«™å°±åªå…è®¸å†…éƒ¨äººå‘˜è®¿é—®ï¼ŒRequireå°±å¯ä»¥å®ç°è®¿é—®æ§åˆ¶çš„åŠŸèƒ½ã€‚</p>
<p>å®¹å™¨ï¼š</p>
<ul>
<li>RequireAnyï¼šä¸€ä¸ªç¬¦åˆå³å¯é€šè¿‡</li>
<li>RequireAllï¼šæ‰€æœ‰ç¬¦åˆæ‰å¯é€šè¿‡</li>
<li>Requirenoneï¼šæ‰€æœ‰éƒ½ä¸ç¬¦åˆæ‰å¯é€šè¿‡</li>
</ul>
<p><strong>æ™®é€šçš„è®¿é—®æ§åˆ¶</strong></p>
<ol>
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line">	AllowOverride None</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">æ‹’ç»æ‰€æœ‰äººè®¿é—®</span></span><br><span class="line">	Require all denied</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å…è®¸è¯¥åœ°å€æ®µçš„ç”¨æˆ·è®¿é—®</span></span><br><span class="line">	Require ip 192.168.88</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å…è®¸è¯¥ä¸»æœºè®¿é—®</span></span><br><span class="line">	Require host www.cqm.com</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p><strong>ç”¨æˆ·ç™»å½•éªŒè¯è®¿é—®æ§åˆ¶</strong></p>
<ol>
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å®šä¹‰æç¤ºä¿¡æ¯ï¼Œç”¨æˆ·è®¿é—®æ—¶æç¤ºä¿¡æ¯ä¼šå‡ºç°åœ¨è®¤è¯çš„å¯¹è¯æ¡†ä¸­</span></span><br><span class="line">	AuthName &quot;Private&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å®šä¹‰è®¤è¯ç±»å‹ï¼Œåœ¨HTTP1.0ä¸­ï¼Œåªæœ‰ä¸€ç§è®¤è¯ç±»å‹ï¼šbasicã€‚åœ¨HTTP1.1ä¸­æœ‰å‡ ç§è®¤è¯ç±»å‹ï¼Œå¦‚ï¼šMD5</span></span><br><span class="line">	AuthType Basic</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å®šä¹‰åŒ…å«ç”¨æˆ·åå’Œå¯†ç çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œä¸€å¯¹</span></span><br><span class="line">	AuthUserFile &quot;/usr/local/apache/user.dbm&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">é…åˆå®¹å™¨ä½¿ç”¨ï¼Œåªæœ‰æ¡ä»¶å…¨éƒ¨ç¬¦åˆæ‰èƒ½é€šè¿‡</span></span><br><span class="line">	&lt;RequireAll&gt;</span><br><span class="line">		Require not ip 192.168.88</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">ã€€require user user1 user2 (åªæœ‰ç”¨æˆ·user1å’Œuser2å¯ä»¥è®¿é—®)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">ã€€requires <span class="built_in">groups</span> group1 (åªæœ‰group1ä¸­çš„æˆå‘˜å¯ä»¥è®¿é—®)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">ã€€require valid-user (åœ¨AuthUserFileæŒ‡å®šçš„æ–‡ä»¶ä¸­çš„æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®)</span></span><br><span class="line">		Require valid-user</span><br><span class="line">	&lt;/RequireAll&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆç”¨æˆ·æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆcqmç”¨æˆ·</span></span><br><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/apache/user.dbm cqm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="1-6-6-URLé‡å†™"><a href="#1-6-6-URLé‡å†™" class="headerlink" title="1.6.6 URLé‡å†™"></a>1.6.6 URLé‡å†™</h4><p>Apacheé€šè¿‡mod_rewriteæ¨¡å—å¯ä»¥å®ç°URLé‡å†™çš„åŠŸèƒ½ï¼ŒURLé‡å†™å…¶å®å°±æ˜¯æ”¹å†™ç”¨æˆ·æµè§ˆå™¨ä¸­çš„URLåœ°å€ã€‚</p>
<ol>
<li>åœ¨ä¸»é…æ–‡ä»¶å¼€å¯æ¨¡å—</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    # å¼€å¯URLé‡å†™åŠŸèƒ½</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    # é‡å†™è§„åˆ™ï¼Œè·³è½¬åˆ°ç™¾åº¦</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://www.baidu.com&quot; [NC,L]</span><br><span class="line">    # åŒ¹é…æ¡ä»¶ï¼Œæ ¹æ®è¯·æ±‚å¤´è¿›è¡ŒåŒ¹é…</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;chrome&quot; [NC,OR]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;curl&quot;</span><br><span class="line">    # é‡å†™è§„åˆ™ï¼Œå’ŒåŒ¹é…åˆ°çš„æ¡ä»¶é…åˆä½¿ç”¨ï¼Œè¯·æ±‚å¤´åŒ¹é…åˆ°chromeæˆ–curlåˆ™è¿”å›403çŠ¶æ€ç </span><br><span class="line">    RewriteRule &quot;^/$&quot; - [F]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">RewreteRule [flag] éƒ¨åˆ†æ ‡è®°è§„åˆ™</span><br><span class="line">R:å¼ºåˆ¶å¤–éƒ¨é‡å®šå‘</span><br><span class="line">F:ç¦ç”¨URLï¼Œè¿”å›403HTTPçŠ¶æ€ç </span><br><span class="line">G:å¼ºåˆ¶URLä¸ºGONEï¼Œè¿”å›410HTTPçŠ¶æ€ç </span><br><span class="line">P:å¼ºåˆ¶ä½¿ç”¨ä»£ç†è½¬å‘</span><br><span class="line">L:è¡¨æ˜å½“å‰è§„åˆ™æ˜¯æœ€åä¸€æ¡è§„åˆ™ï¼Œåœæ­¢åˆ†æä»¥åè§„åˆ™çš„é‡å†™</span><br><span class="line">N:é‡æ–°ä»ç¬¬ä¸€æ¡è§„åˆ™å¼€å§‹è¿è¡Œé‡å†™è¿‡ç¨‹</span><br><span class="line">C:ä¸ä¸‹ä¸€æ¡è§„åˆ™å…³è”</span><br><span class="line">NS:åªç”¨äºä¸æ˜¯å†…éƒ¨å­è¯·æ±‚</span><br><span class="line">NC:ä¸åŒºåˆ†å¤§å°å†™</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡URLé‡å†™å®ç°åˆ†æµåŠŸèƒ½</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(chrome|curl)&quot; [NC,OR]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://pc.cqm.com&quot; [NC]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(iPhone|Blackberry|Android|ipad)&quot; [NC]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://phone.cqm.com&quot; [NC]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-7-å‹åŠ›æµ‹è¯•"><a href="#1-6-7-å‹åŠ›æµ‹è¯•" class="headerlink" title="1.6.7 å‹åŠ›æµ‹è¯•"></a>1.6.7 å‹åŠ›æµ‹è¯•</h4><p>Apacheå‹åŠ›æµ‹è¯•ä½¿ç”¨abå‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ab</span><br><span class="line">-A:æŒ‡å®šè¿æ¥æœåŠ¡å™¨çš„åŸºæœ¬çš„è®¤è¯å‡­æ®</span><br><span class="line">-c:æŒ‡å®šä¸€æ¬¡å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚æ•°</span><br><span class="line">-C:æ·»åŠ cookie</span><br><span class="line">-g:å°†æµ‹è¯•ç»“æœè¾“å‡ºä¸ºâ€œgnuolotâ€æ–‡ä»¶</span><br><span class="line">-h:æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</span><br><span class="line">-H:ä¸ºè¯·æ±‚è¿½åŠ ä¸€ä¸ªé¢å¤–çš„å¤´</span><br><span class="line">-i:ä½¿ç”¨â€œheadâ€è¯·æ±‚æ–¹å¼</span><br><span class="line">-k:æ¿€æ´»HTTPä¸­çš„â€œkeepAliveâ€ç‰¹æ€§</span><br><span class="line">-n:æŒ‡å®šæµ‹è¯•ä¼šè¯ä½¿ç”¨çš„è¯·æ±‚æ•°</span><br><span class="line">-p:æŒ‡å®šåŒ…å«æ•°æ®çš„æ–‡ä»¶</span><br><span class="line">-q:ä¸æ˜¾ç¤ºè¿›åº¦ç™¾åˆ†æ¯”</span><br><span class="line">-T:ä½¿ç”¨POSTæ•°æ®æ—¶ï¼Œè®¾ç½®å†…å®¹ç±»å‹å¤´</span><br><span class="line">-v:è®¾ç½®è¯¦ç»†æ¨¡å¼ç­‰çº§</span><br><span class="line">-w:ä»¥HTMLè¡¨æ ¼æ–¹å¼æ‰“å°ç»“æœ</span><br><span class="line">-x:ä»¥è¡¨æ ¼æ–¹å¼è¾“å‡ºæ—¶ï¼Œè®¾ç½®è¡¨æ ¼çš„å±æ€§</span><br><span class="line">-X:ä½¿ç”¨æŒ‡å®šçš„ä»£ç†æœåŠ¡å™¨å‘é€è¯·æ±‚</span><br><span class="line">-y:ä»¥è¡¨æ ¼æ–¹å¼è¾“å‡ºæ—¶ï¼Œè®¾ç½®è¡¨æ ¼å±æ€§</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/ab -n 10000 -c 200 http:...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¹¶å‘æ•°</span></span><br><span class="line">per second...</span><br></pre></td></tr></table></figure>



<h2 id="äºŒã€Nginx"><a href="#äºŒã€Nginx" class="headerlink" title="äºŒã€Nginx"></a>äºŒã€Nginx</h2><h3 id="2-1-Nginxä»‹ç»"><a href="#2-1-Nginxä»‹ç»" class="headerlink" title="2.1 Nginxä»‹ç»"></a>2.1 Nginxä»‹ç»</h3><p>Nginxæ˜¯ä¸€æ¬¾æ˜¯ç”±ä¿„ç½—æ–¯çš„ç¨‹åºè®¾è®¡å¸ˆIgor Sysoevæ‰€å¼€å‘é«˜æ€§èƒ½çš„ Webå’Œ åå‘ä»£ç†æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª IMAP&#x2F;POP3&#x2F;SMTP ä»£ç†æœåŠ¡å™¨ã€‚å’Œapacheä¸€æ ·ï¼Œéƒ½æ˜¯webæœåŠ¡å™¨è½¯ä»¶ï¼Œå› ä¸ºå…¶æ€§èƒ½ä¼˜å¼‚ï¼Œæ‰€ä»¥è¢«å¹¿å¤§è¿ç»´å–œæ¬¢ã€‚åˆå› ä¸ºnginxæ˜¯ä¸€ä¸ªè½»é‡çº§çš„webæœåŠ¡å™¨ï¼Œç›¸æ¯”apacheæ¥è¯´èµ„æºæ¶ˆè€—æ›´ä½ã€‚</p>
<p>Nginxä¸­æ–‡æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://www.nginx.cn/doc/index.html">https://www.nginx.cn/doc/index.html</a></p>
<h3 id="2-2-é€šè¿‡è„šæœ¬æºç å®‰è£…Nginx"><a href="#2-2-é€šè¿‡è„šæœ¬æºç å®‰è£…Nginx" class="headerlink" title="2.2 é€šè¿‡è„šæœ¬æºç å®‰è£…Nginx"></a>2.2 é€šè¿‡è„šæœ¬æºç å®‰è£…Nginx</h3><ol>
<li>ç¼–å†™å®‰è£…è„šæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">nginx_version=1.21.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ£€æµ‹</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">æ£€æµ‹æ˜¯å¦ä¸ºroot</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">æ£€æµ‹wgetæ˜¯å¦å®‰è£…</span></span><br><span class="line">   if [ ! -e /usr/bin/wget ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found command /usr/bin/wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å®‰è£…å‰å‡†å¤‡</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">0:stdinæ ‡å‡†è¾“å…¥   1:stdoutæ ‡å‡†è¾“å‡º   2:stderré”™è¯¯è¾“å‡º</span></span><br><span class="line">   if [ ! `yum -y install gcc-* pcre-devel zlib-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">ä¸‹è½½æºç åŒ…</span></span><br><span class="line">   cd /usr/local/</span><br><span class="line">   if [ ! `wget http://nginx.org/download/nginx-$&#123;nginx_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf nginx-$&#123;nginx_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d nginx-$&#123;nginx_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found nginx-$&#123;nginx_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:wget file nginx-$&#123;nginx_version&#125;.tar.gz failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å®‰è£…</span></span><br><span class="line">function install_nginx()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/nginx-$&#123;nginx_version&#125;</span><br><span class="line">   echo &quot;nginx configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/nginx &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;nginx make...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m nginx install success \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:nginx install fail \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:nginx configure fail \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">install_nginx</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™å¯åŠ¨è„šæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Source <span class="keyword">function</span> libiary</span></span><br><span class="line">if [ -f /etc/init.d/functions ]</span><br><span class="line">then</span><br><span class="line">    . /etc/init.d/functions</span><br><span class="line">else</span><br><span class="line">    echo &quot;Not found file /etc/init.d/functions&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">nginxd=/usr/local/nginx/sbin/nginx</span><br><span class="line">nginx_pid=/usr/local/nginx/logs/nginx.pid</span><br><span class="line"></span><br><span class="line">function nginx_start()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -eq 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">nginxd</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_stop()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -gt 1 ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_status()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_restart()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_stop</span><br><span class="line">   nginx_start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_reload()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       $nginxd -s reload</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        nginx_start</span><br><span class="line">        echo -e &quot;nginx start [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        nginx_stop</span><br><span class="line">        echo -e &quot;nginx stop [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line">        nginx_status</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        nginx_restart</span><br><span class="line">        echo -e &quot;nginx restart [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">reload)</span><br><span class="line">        nginx_reload</span><br><span class="line">        echo -e &quot;nginx reload [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Nginxçš„Serverå—"><a href="#2-3-Nginxçš„Serverå—" class="headerlink" title="2.3 Nginxçš„Serverå—"></a>2.3 Nginxçš„Serverå—</h3><p>å½“Nginxé…ç½®æ–‡ä»¶åªæœ‰ä¸€ä¸ªServerå—æ—¶ï¼Œé‚£ä¹ˆè¯¥Serverå—å°±è¢«Nginxè®¤ä¸ºæ˜¯é»˜è®¤ç½‘ç«™ï¼Œæ‰€æœ‰å‘ç»™Nginxçš„è¯·æ±‚éƒ½ä¼šä¼ ç»™è¯¥Serverå—ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">ç›‘å¬80ç«¯å£</span></span><br><span class="line">        listen       80;</span><br><span class="line">        # åŸŸå</span><br><span class="line">        server_name  localhost;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">å­—ç¬¦é›†</span></span><br><span class="line">        charset koi8-r;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">è®¿é—®æ—¥å¿—è·¯å¾„</span></span><br><span class="line">        access_log  logs/host.access.log  main;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">webæ ¹è·¯å¾„</span></span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">/ä»£è¡¨ç›¸å¯¹è·¯åŠ²ï¼Œè¿™é‡Œä»£è¡¨/usr/local/nginx</span></span><br><span class="line">        location / &#123;</span><br><span class="line">        	# æ ¹ç›®å½•è·¯å¾„ï¼Œè¿™é‡Œä»£è¡¨/usr/local/nginx/html</span><br><span class="line">            root   html;</span><br><span class="line">            # ç´¢å¼•é¡µ</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">404çŠ¶æ€ç </span></span><br><span class="line">        error_page  404              /404.html;</span><br><span class="line">        location = /404.html&#123;</span><br><span class="line">        	root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        # 50xçŠ¶æ€ç </span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Nginxçš„è®¿é—®æ§åˆ¶"><a href="#2-4-Nginxçš„è®¿é—®æ§åˆ¶" class="headerlink" title="2.4 Nginxçš„è®¿é—®æ§åˆ¶"></a>2.4 Nginxçš„è®¿é—®æ§åˆ¶</h3><ol>
<li>ç¼–å†™ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    # å…è®¸192.168.88.0/24çš„ç”¨æˆ·è®¿é—®</span><br><span class="line">    allow 192.168.88.0/24;</span><br><span class="line">    # æ‹’ç»æ‰€æœ‰</span><br><span class="line">    deny all;</span><br><span class="line">    # åŸºäºå®¢æˆ·ç«¯IPåšè¿‡æ»¤ï¼Œç¬¦åˆæ¡ä»¶çš„å…è®¸è®¿é—®ï¼Œä¸ç¬¦åˆçš„è¿”å›404</span><br><span class="line">    # è¿™é‡Œä¸ºä¸æ˜¯192.168.88çš„å°±è¿”å›404</span><br><span class="line">    if ( $remote_addr !~ &quot;192.168.88&quot; )&#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-Nginxçš„ç”¨æˆ·éªŒè¯"><a href="#2-5-Nginxçš„ç”¨æˆ·éªŒè¯" class="headerlink" title="2.5 Nginxçš„ç”¨æˆ·éªŒè¯"></a>2.5 Nginxçš„ç”¨æˆ·éªŒè¯</h3><ol>
<li>ç¼–å†™ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	root   html;</span><br><span class="line">	index  index.html index.htm;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">æ¬¢è¿è¯</span></span><br><span class="line">	auth_basic &quot;welcome to cqm&#x27;s web&quot;;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å­˜æ”¾ç”¨æˆ·æ–‡ä»¶</span></span><br><span class="line">	auth_basic_user_file /usr/local/nginx/htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç”Ÿæˆç”¨æˆ·æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/nginx/htpasswd cqm</span><br></pre></td></tr></table></figure>

<h3 id="2-6-Nginxå‚æ•°"><a href="#2-6-Nginxå‚æ•°" class="headerlink" title="2.6 Nginxå‚æ•°"></a>2.6 Nginxå‚æ•°</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginxä¸­çš„log_formatå¯ä»¥ç”¨æ¥è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">log_formatå˜é‡ï¼š</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_addr:è®°å½•è®¿é—®ç½‘ç«™çš„å®¢æˆ·ç«¯åœ°å€</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_user:è¿œç¨‹å®¢æˆ·ç«¯ç”¨æˆ·å</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">time_local:è®°å½•è®¿é—®æ—¶é—´ä¸æ—¶åŒº</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request:ç”¨æˆ·çš„httpè¯·æ±‚èµ·å§‹è¡Œä¿¡æ¯</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">status:httpçŠ¶æ€ç ï¼Œè®°å½•è¯·æ±‚è¿”å›çš„çŠ¶æ€ç ï¼Œä¾‹å¦‚ï¼š200ã€301ã€404ç­‰</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">body_bytes_sent:æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯çš„å“åº”bodyå­—èŠ‚æ•°</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_referer:è®°å½•æ­¤æ¬¡è¯·æ±‚æ˜¯ä»å“ªä¸ªè¿æ¥è®¿é—®è¿‡æ¥çš„ï¼Œå¯ä»¥æ ¹æ®è¯¥å‚æ•°è¿›è¡Œé˜²ç›—é“¾è®¾ç½®ã€‚</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_user_agent:è®°å½•å®¢æˆ·ç«¯è®¿é—®ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šæµè§ˆå™¨ã€æ‰‹æœºå®¢æˆ·ç«¯ç­‰</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_x_forwarded_for:å½“å‰ç«¯æœ‰ä»£ç†æœåŠ¡å™¨æ—¶ï¼Œè®¾ç½®webèŠ‚ç‚¹è®°å½•å®¢æˆ·ç«¯åœ°å€çš„é…ç½®ï¼Œæ­¤å‚æ•°ç”Ÿæ•ˆçš„å‰ææ˜¯ä»£ç†æœåŠ¡å™¨ä¹Ÿè¦è¿›è¡Œç›¸å…³çš„x_forwarded_forè®¾ç½®</span></span><br></pre></td></tr></table></figure>

<h3 id="2-7-Nginxé˜²ç›—é“¾"><a href="#2-7-Nginxé˜²ç›—é“¾" class="headerlink" title="2.7 Nginxé˜²ç›—é“¾"></a>2.7 Nginxé˜²ç›—é“¾</h3><p>ç›—é“¾ç”¨å¤§ç™½è¯è®²å°±æ˜¯æŠ“å–åˆ«äººç½‘ç«™çš„èµ„æºï¼ŒåŠ ä»¥åˆ©ç”¨ï¼Œä»¥è‡³äºè¢«æŠ“å–èµ„æºçš„ç½‘ç«™æ¶ˆè€—äº†å¸¦å®½ï¼Œè€Œæ”¶ç›Šçš„æ˜¯æŠ“å–èµ„æºçš„äººã€‚</p>
<p>è€Œåç›—é“¾å°±å¯ä»¥é˜²æ­¢åˆ«äººæŠ“å–è‡ªèº«ç½‘ç«™çš„èµ„æºã€‚</p>
<ol>
<li>ç¼–å†™ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    # é™¤äº†www.cqm.comä¹‹å¤–ï¼Œéƒ½è¿”å›403</span><br><span class="line">    valid_referers none blocked www.cqm.com;</span><br><span class="line">    if ($invalid_referer)&#123;</span><br><span class="line">       return 403;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-8-Nginxè™šæ‹Ÿä¸»æœº"><a href="#2-8-Nginxè™šæ‹Ÿä¸»æœº" class="headerlink" title="2.8 Nginxè™šæ‹Ÿä¸»æœº"></a>2.8 Nginxè™šæ‹Ÿä¸»æœº</h3><p>Nginxçš„è™šæ‹Ÿä¸»æœºæ˜¯é€šè¿‡serverå—æ¥å®ç°çš„ã€‚</p>
<h4 id="2-8-1-åŸºäºIPçš„è™šæ‹Ÿä¸»æœº"><a href="#2-8-1-åŸºäºIPçš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="2.8.1 åŸºäºIPçš„è™šæ‹Ÿä¸»æœº"></a>2.8.1 åŸºäºIPçš„è™šæ‹Ÿä¸»æœº</h4><ol>
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">include /usr/local/nginx/conf/conf.d/nginx_vhosts.conf;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.100;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.101;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å…¶å®ƒé…ç½®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ ä¸€ä¸ªé€»è¾‘ç½‘å¡ï¼Œé‡å¯å³å¤±æ•ˆ</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">mkdir /usr/local/nginx/html/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/nginx/html/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/nginx/html/web2/index.html</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æµ‹è¯•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.88.100/</span><br><span class="line">this is web1</span><br><span class="line">curl http://192.168.88.101/</span><br><span class="line">this is web2</span><br></pre></td></tr></table></figure>

<h4 id="2-8-2-åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº"><a href="#2-8-2-åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="2.8.2 åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº"></a>2.8.2 åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº</h4><ol>
<li>ä¿®æ”¹è™šæ‹Ÿä¸»æœºæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-8-3-åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº"><a href="#2-8-3-åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="2.8.3 åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº"></a>2.8.3 åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm1.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm2.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-9-Nginxåå‘ä»£ç†"><a href="#2-9-Nginxåå‘ä»£ç†" class="headerlink" title="2.9 Nginxåå‘ä»£ç†"></a>2.9 Nginxåå‘ä»£ç†</h3><p>ä»£ç†æœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼å°±æ˜¯ç¿»å¢™ï¼Œèƒ½å¤Ÿå®ç°è®©å›½å†…çš„ç”¨æˆ·è®¿é—®å›½å¤–çš„ç½‘ç«™ã€‚</p>
<p>åŸç†ï¼š</p>
<ul>
<li>ç”¨æˆ·è®²è¯·æ±‚å‘ç»™ä»£ç†æœåŠ¡å™¨</li>
<li>ä»£ç†æœåŠ¡å™¨ä»£æ›¿ç”¨æˆ·å»è·å–æ•°æ®</li>
<li>ä»£ç†æœåŠ¡å™¨å°†æ•°æ®å‘é€ç»™ç”¨æˆ·</li>
</ul>
<p><strong>æ­£å¸¸æ²¡æœ‰ä»£ç†çš„ä¸Šç½‘</strong></p>
<p><img src="/2024/02/18/web/%E6%AD%A3%E5%B8%B8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="æ­£å¸¸ä¸Šç½‘æµç¨‹"></p>
<p><strong>ä½¿ç”¨ä»£ç†æœåŠ¡å™¨çš„ä¸Šç½‘</strong></p>
<p>&#x3D;<img src="/2024/02/18/web/%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ä¸Šç½‘æµç¨‹"></p>
<p>ä»£ç†æœåŠ¡å™¨åˆåˆ†ä¸ºä¸¤ç§ï¼šæ­£å‘ä»£ç†ã€åå‘ä»£ç†</p>
<p>æ­£å‘ä»£ç†ï¼šä»£ç†ç”¨æˆ·å‘æœåŠ¡å™¨è·å–èµ„æº</p>
<p>åå‘ä»£ç†ï¼šä»£ç†æœåŠ¡å™¨å»ç®¡ç†ç½‘ç»œèµ„æºï¼Œç”¨æˆ·æœ‰è¯·æ±‚æ‰¾åå‘ä»£ç†å°±å¯ä»¥äº†</p>
<ol>
<li>ç¼–å†™åå‘ä»£ç†æœåŠ¡å™¨ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">location / &#123;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    # è®¿é—®ä»£ç†æœåŠ¡å™¨å°±ä¼šè·³è½¬åˆ°http://192.168.88.100</span><br><span class="line">    proxy_pass http://192.168.88.100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åå‘ä»£ç†å…¶å®ƒé…ç½®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">client_max_body_size 10m; #å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span><br><span class="line"></span><br><span class="line">client_body_buffer_size 128k; #ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œ</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 90; #nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span><br><span class="line"></span><br><span class="line">proxy_send_timeout 90; #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)</span><br><span class="line"></span><br><span class="line">proxy_read_timeout 90; #è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span><br><span class="line"></span><br><span class="line">proxy_buffer_size 4k; #è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span><br><span class="line"></span><br><span class="line">proxy_buffers 4 32k; #proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®</span><br><span class="line"></span><br><span class="line">proxy_busy_buffers_size 64k; #é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span><br><span class="line"></span><br><span class="line">proxy_temp_file_write_size 64k; #è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ </span><br></pre></td></tr></table></figure>

<h3 id="2-10-Nginxä¸‹è½½é™é€Ÿ"><a href="#2-10-Nginxä¸‹è½½é™é€Ÿ" class="headerlink" title="2.10 Nginxä¸‹è½½é™é€Ÿ"></a>2.10 Nginxä¸‹è½½é™é€Ÿ</h3><p>é™é€Ÿæ–¹æ³•ä¸»è¦åˆ†ä¸ºï¼š</p>
<ul>
<li>ä¸‹è½½é€Ÿåº¦é™åˆ¶</li>
<li>å•ä½æ—¶é—´å†…è¯·æ±‚æ•°é™åˆ¶</li>
<li>åŸºäºå®¢æˆ·ç«¯çš„å¹¶å‘æ•°é™åˆ¶</li>
</ul>
<p>Nginxå®˜æ–¹æä¾›çš„é™åˆ¶IPè¿æ¥å’Œå¹¶å‘çš„æ¨¡å—æœ‰ä¸¤ä¸ªï¼š</p>
<p>limit_req_zoneï¼šç”¨æ¥é™åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°ï¼Œå³é€Ÿç‡é™åˆ¶ï¼Œé‡‡ç”¨çš„æ¼æ¡¶ç®—æ³•</p>
<p>limit_req_connï¼šæ¥é™åˆ¶åŒä¸€æ—¶é—´è¿æ¥æ•°ï¼Œå³å¹¶å‘é™åˆ¶</p>
<p><strong>å•ä½æ—¶é—´å†…è¯·æ±‚æ•°é™åˆ¶</strong></p>
<ol>
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨httpå¿«ä¸‹è°ƒç”¨æ¨¡å—</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:åŸºäºipåœ°å€åšé™åˆ¶</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:åˆ›å»ºç¼“å­˜åŸŸå’Œç¼“å­˜å¤§å°</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rate:è®¾ç½®è®¿é—®é¢‘æ•°</span></span><br><span class="line">limit_req_zone $binary_remote_addr zone=cqm:10m rate=1r/s;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">serverå—</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">è°ƒç”¨æ¨¡å—</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å½“è¯·æ±‚æ•°è¶…è¿‡5æ¬¡æ—¶ï¼Œå°±æ‹’ç»è®¿é—®ï¼Œå¹¶è¿”å›503çŠ¶æ€ç </span></span><br><span class="line">	limit_req zone=cqm burst=5 nodelay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é™åˆ¶å¹¶å‘è¿æ¥æ•°</strong></p>
<ol>
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨httpå¿«ä¸‹è°ƒç”¨æ¨¡å—</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:åŸºäºipåœ°å€åšé™åˆ¶</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:åˆ›å»ºç¼“å­˜åŸŸå’Œç¼“å­˜å¤§å°</span></span><br><span class="line">limit_req_conn $binary_remote_addr zone=cqm:10m;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">serverå—</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">é™åˆ¶åŒä¸€æ—¶é—´å†…ä¸‹è½½æ•°ä¸º1ä¸ª</span></span><br><span class="line">	limit_conn cqm 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é™åˆ¶ä¸‹è½½é€Ÿåº¦</strong></p>
<ol>
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">é™åˆ¶ä¸‹è½½é€Ÿåº¦ä¸º1k</span></span><br><span class="line">	limit_rate 1k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-11-Nginxçš„URLé‡å†™"><a href="#2-11-Nginxçš„URLé‡å†™" class="headerlink" title="2.11 Nginxçš„URLé‡å†™"></a>2.11 Nginxçš„URLé‡å†™</h3><p>rewriteçš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°URLåœ°å€çš„é‡å®šå‘ã€‚Nginxçš„rewriteåŠŸèƒ½éœ€è¦PCREè½¯ä»¶çš„æ”¯æŒï¼Œå³é€šè¿‡perlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼è¯­å¥è¿›è¡Œè§„åˆ™åŒ¹é…çš„ã€‚é»˜è®¤å‚æ•°ç¼–è¯‘nginxå°±ä¼šæ”¯æŒrewriteçš„æ¨¡å—ï¼Œä½†æ˜¯ä¹Ÿå¿…é¡»è¦PCREçš„æ”¯æŒã€‚</p>
<p>URLæ¨¡æ¿è¯­å—ï¼š</p>
<ul>
<li>setï¼šè®¾ç½®å˜é‡</li>
<li>ifï¼šåˆ¤æ–­</li>
<li>returnï¼šè¿”å›å€¼æˆ–URL</li>
<li>breakï¼šç»ˆæ­¢</li>
<li>rewriteï¼šé‡å®šå‘URL</li>
</ul>
<p><strong>ä¾‹ä¸€ï¼šæ ¹æ®ä¸åŒåŸŸåè·³è½¬åˆ°ä¸»åŸŸåçš„ä¸åŒç›®å½•ä¸‹</strong></p>
<ol>
<li>åˆ›å»ºæµ‹è¯•ç›®å½•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/nginx/html/&#123;cn,jp,us&#125;</span><br><span class="line">echo &#x27;this is China&#x27; &gt; /usr/local/nginx/html/cn/index.html</span><br><span class="line">echo &#x27;this is Japan&#x27; &gt; /usr/local/nginx/html/jp/index.html</span><br><span class="line">echo &#x27;this is America&#x27; &gt; /usr/local/nginx/html/us/index.html</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä¿®æ”¹hostsæ–‡ä»¶ï¼Œä»¥ä¾¿è§£æ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.88.100 www.cqm.com</span><br><span class="line">192.168.88.100 www.cqm.com.cn</span><br><span class="line">192.168.88.100 www.cqm.com.jp</span><br><span class="line">192.168.88.100 www.cqm.com.us</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /usr/local/nginx/conf/conf.d/rewrite.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ä¿®æ”¹é‡å®šå‘æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®é‡å®šå‘server</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com.cn www.cqm.com.jp www.cqm.com.us;</span><br><span class="line">    location / &#123;</span><br><span class="line">        # æ¨¡ç³ŠåŒ¹é…åˆ°cnçš„è¯ï¼Œå°±è·³è½¬åˆ°http://www.cqm.com/cnä¸‹</span><br><span class="line">        if ($http_host ~ (cn)$)&#123;</span><br><span class="line">            set $nation cn;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (jp)$)&#123;</span><br><span class="line">            set $nation jp;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (us)$)&#123;</span><br><span class="line">            set $nation us;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>æµ‹è¯•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://www.cqm.com.cn</span><br><span class="line">this is China</span><br><span class="line">curl -L http://www.cqm.com.jp</span><br><span class="line">this is Japan</span><br><span class="line">curl -L http://www.cqm.com.us</span><br><span class="line">this is America</span><br><span class="line">-L:è‡ªåŠ¨è·å–é‡å®šå‘</span><br></pre></td></tr></table></figure>

<p><strong>ä¾‹äºŒï¼šretuenä»¥åŠbreakçš„ç®€å•å®ç”¨</strong></p>
<ol>
<li>ä¿®æ”¹é‡å®šå‘æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">        # æ¨¡ç³ŠåŒ¹é… ~</span><br><span class="line">        # ç²¾ç¡®åŒ¹é… =</span><br><span class="line">        # ä¸åŒ¹é… !~</span><br><span class="line">        # å¦‚æœåŒ¹é…è¯·æ±‚å¤´ä¸æ˜¯chromeçš„è¯ï¼Œå°±è¿”å›403</span><br><span class="line">        if ($http_user_agent !~ &#x27;chrome&#x27;)&#123;</span><br><span class="line">            return 403;</span><br><span class="line">            # breakæ”¾åœ¨returnä¸Šé¢çš„è¯å°±ä¸ä¼šæ‰§è¡Œreturnæ“ä½œ</span><br><span class="line">            # break;</span><br><span class="line">            # return http://www.baidu.com;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>flag</strong></p>
<p>flagæ˜¯æ”¾åœ¨rewriteé‡å®šå‘çš„URLåè¾¹çš„ï¼Œæ ¼å¼ä¸ºï¼šrewrite URL flag</p>
<p>flagçš„é€‰é¡¹æœ‰ï¼š</p>
<ol>
<li>lastï¼šæœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆåç»§ç»­æ‰§è¡Œåˆ°æœ€åã€‚</li>
<li>breakï¼šæœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆå³ç»ˆæ­¢ã€‚</li>
<li>redirectï¼šè¿”å›302ä¸´æ—¶é‡å®šå‘ã€‚</li>
<li>permanentï¼šè¿”å›301æ°¸ä¹…é‡å®šå‘ã€‚</li>
</ol>
<p>redirectå’Œpermanentçš„åŒºåˆ«ï¼šè®¾ç½®permanentçš„è¯ï¼Œæ–°ç½‘å€å°±ä¼šå®Œå…¨ç»§æ‰¿æ—§ç½‘å€ï¼Œæ—§ç½‘å€çš„æ’åç­‰å®Œå…¨æ¸…é›¶ï¼Œå¦‚æœä¸æ˜¯æš‚æ—¶è¿ç§»çš„æƒ…å†µä¸‹éƒ½å»ºè®®ä½¿ç”¨permanentï¼›è®¾ç½®redirectçš„è¯ï¼Œæ–°ç½‘å€å¯¹æ—§ç½‘å€æ²¡æœ‰å½±å“ï¼Œä¸”æ–°ç½‘å€ä¹Ÿä¸ä¼šæœ‰æ’åã€‚</p>
<h3 id="2-12-Nginxä¼˜åŒ–"><a href="#2-12-Nginxä¼˜åŒ–" class="headerlink" title="2.12 Nginxä¼˜åŒ–"></a>2.12 Nginxä¼˜åŒ–</h3><h4 id="2-12-1-å¤§å¹¶å‘"><a href="#2-12-1-å¤§å¹¶å‘" class="headerlink" title="2.12.1 å¤§å¹¶å‘"></a>2.12.1 å¤§å¹¶å‘</h4><p>Nginxçš„å·¥ä½œæ¨¡å¼ï¼šä¸»è¿›ç¨‹ + å·¥ä½œè¿›ç¨‹</p>
<p>å‡å¦‚NginxæœåŠ¡å™¨æœ‰4ä¸ªCPU</p>
<ol>
<li>è®¾ç½®ä¸»é…æ–‡ä»¶æ¥å®ç°é«˜å¹¶å‘</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">worker_processes  4;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒ‡å®šè¿è¡Œçš„æ ¸çš„ç¼–å·ï¼Œé‡‡ç”¨æ©ç çš„æ–¹å¼è®¾ç½®ç¼–å·</span></span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br><span class="line">events &#123;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">å•ä¸ªå·¥ä½œè¿›ç¨‹ç»´æŠ¤çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´</span></span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-2-é•¿è¿æ¥"><a href="#2-12-2-é•¿è¿æ¥" class="headerlink" title="2.12.2 é•¿è¿æ¥"></a>2.12.2 é•¿è¿æ¥</h4><ol>
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">keepalive_timeoutç”¨æ¥è®¾ç½®é•¿è¿æ¥ï¼Œ0ä»£è¡¨å…³é—­</span></span><br><span class="line">keepalive_timeout  0;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®é•¿è¿æ¥æ—¶é—´100s</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_timeout  100;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®æ¯ç§’å¯ä»¥æ¥å—çš„è¯·æ±‚æ•°</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_requests 8192;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-12-3-å‹ç¼©"><a href="#2-12-3-å‹ç¼©" class="headerlink" title="2.12.3 å‹ç¼©"></a>2.12.3 å‹ç¼©</h4><p>Nginxæ˜¯é‡‡ç”¨gzipè¿›è¡Œå‹ç¼©ã€‚</p>
<ol>
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¼€å¯ç¼“å­˜</span></span><br><span class="line">gzip on;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginxåšä¸ºåå‘ä»£ç†çš„æ—¶å€™å¯ç”¨</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">off:å…³é—­æ‰€æœ‰çš„ä»£ç†ç»“æœæ•°æ®å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">expired:å¦‚æœheaderä¸­åŒ…å«â€Expiresâ€å¤´ä¿¡æ¯ï¼Œå¯ç”¨å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-cache:å¦‚æœheaderä¸­åŒ…å«â€Cache-Control:no-cacheâ€å¤´ä¿¡æ¯ï¼Œå¯ç”¨å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-store:å¦‚æœheaderä¸­åŒ…å«â€Cache-Control:no-storeâ€å¤´ä¿¡æ¯ï¼Œå¯ç”¨å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">private:å¦‚æœheaderä¸­åŒ…å«â€Cache-Control:privateâ€å¤´ä¿¡æ¯ï¼Œå¯ç”¨å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_last_modified:å¯ç”¨å‹ç¼©ï¼Œå¦‚æœheaderä¸­åŒ…å«â€Last_Modifiedâ€å¤´ä¿¡æ¯ï¼Œå¯ç”¨å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_etag:å¯ç”¨å‹ç¼©ï¼Œå¦‚æœheaderä¸­åŒ…å«â€œETagâ€å¤´ä¿¡æ¯ï¼Œå¯ç”¨å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">auth:å¯ç”¨å‹ç¼©ï¼Œå¦‚æœheaderä¸­åŒ…å«â€œAuthorizationâ€å¤´ä¿¡æ¯ï¼Œå¯ç”¨å‹ç¼©</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">any:æ— æ¡ä»¶å‹ç¼©æ‰€æœ‰ç»“æœæ•°æ®</span></span><br><span class="line">gzip_proxied any;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ç”¨gzipå‹ç¼©çš„æœ€å°æ–‡ä»¶ï¼Œå°äºè®¾ç½®å€¼çš„æ–‡ä»¶å°†ä¸ä¼šå‹ç¼©</span></span><br><span class="line">gzip_min_length 1k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®å‹ç¼©æ‰€éœ€è¦çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">32 4Kè¡¨ç¤ºæŒ‰ç…§å†…å­˜é¡µï¼ˆone memory pageï¼‰å¤§å°ä»¥4Kä¸ºå•ä½ï¼ˆå³ä¸€ä¸ªç³»ç»Ÿä¸­å†…å­˜é¡µä¸º4Kï¼‰ï¼Œç”³è¯·32å€çš„å†…å­˜ç©ºé—´</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å»ºè®®æ­¤é¡¹ä¸è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼</span></span><br><span class="line">gzip_buffers 32 4k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®gzipå‹ç¼©çº§åˆ«ï¼Œçº§åˆ«è¶Šåº•å‹ç¼©é€Ÿåº¦è¶Šå¿«æ–‡ä»¶å‹ç¼©æ¯”è¶Šå°ï¼Œåä¹‹é€Ÿåº¦è¶Šæ…¢æ–‡ä»¶å‹ç¼©æ¯”è¶Šå¤§</span></span><br><span class="line">gzip_comp_level 1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”¨äºè¯†åˆ«httpåè®®çš„ç‰ˆæœ¬ï¼Œæ—©æœŸçš„æµè§ˆå™¨ä¸æ”¯æŒgzipå‹ç¼©ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ä¹±ç ï¼Œæ‰€ä»¥ä¸ºäº†æ”¯æŒå‰æœŸç‰ˆæœ¬åŠ äº†æ­¤é€‰é¡¹ã€‚é»˜è®¤åœ¨http/1.0çš„åè®®ä¸‹ä¸å¼€å¯gzipå‹ç¼©</span></span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®éœ€è¦å‹ç¼©çš„MIMEç±»å‹,å¦‚æœä¸åœ¨è®¾ç½®ç±»å‹èŒƒå›´å†…çš„è¯·æ±‚ä¸è¿›è¡Œå‹ç¼©</span></span><br><span class="line">gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-4-é™æ€ç¼“å­˜"><a href="#2-12-4-é™æ€ç¼“å­˜" class="headerlink" title="2.12.4 é™æ€ç¼“å­˜"></a>2.12.4 é™æ€ç¼“å­˜</h4><p>å°†éƒ¨åˆ†æ•°æ®ç¼“å­˜åœ¨ç”¨æˆ·æœ¬åœ°ç£ç›˜ï¼Œç”¨æˆ·åŠ è½½æ—¶ï¼Œå¦‚æœæœ¬åœ°å’ŒæœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´ï¼Œåˆ™ä»æœ¬åœ°åŠ è½½ã€‚æå‡ç”¨æˆ·è®¿é—®é€Ÿåº¦ï¼Œæå‡ä½“éªŒåº¦ã€‚èŠ‚çœå…¬å¸å¸¦å®½æˆæœ¬ã€‚</p>
<ol>
<li>ä¿®æ”¹ä¸»é…æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¨¡ç³ŠåŒ¹é…ä»¥pngæˆ–gifç»“å°¾çš„æ–‡ä»¶</span></span><br><span class="line">location ~*  \.(png|gif)$ &#123;</span><br><span class="line">    # ç¼“å­˜æ—¶é—´ä¸º1å°æ—¶</span><br><span class="line">    expires 1h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ä¸‰ã€Tomcat"><a href="#ä¸‰ã€Tomcat" class="headerlink" title="ä¸‰ã€Tomcat"></a>ä¸‰ã€Tomcat</h2><h3 id="3-1-Tomcatä»‹ç»"><a href="#3-1-Tomcatä»‹ç»" class="headerlink" title="3.1 Tomcatä»‹ç»"></a>3.1 Tomcatä»‹ç»</h3><p>Tomcat æœåŠ¡å™¨æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æ”¾æºä»£ç çš„ Web åº”ç”¨æœåŠ¡å™¨ï¼Œå±äºè½»é‡çº§åº”ç”¨æœåŠ¡å™¨ï¼Œåœ¨ä¸­å°å‹ç³»ç»Ÿå’Œå¹¶å‘è®¿é—®ç”¨æˆ·ä¸æ˜¯å¾ˆå¤šçš„åœºåˆä¸‹è¢«æ™®éä½¿ç”¨ï¼Œæ˜¯å¼€å‘å’Œè°ƒè¯• JSP ç¨‹åºçš„é¦–é€‰ã€‚</p>
<p>å®é™…ä¸Š Tomcat æ˜¯ Apache æœåŠ¡å™¨çš„æ‰©å±•ï¼Œä½†è¿è¡Œæ—¶å®ƒæ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œæ‰€ä»¥å½“ä½ è¿è¡Œ tomcat æ—¶ï¼Œå®ƒå®é™…ä¸Šä½œä¸ºä¸€ä¸ªä¸ Apache ç‹¬ç«‹çš„è¿›ç¨‹å•ç‹¬è¿è¡Œçš„ã€‚</p>
<p>Tomcat å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://tomcat.apache.org/">https://tomcat.apache.org/</a></p>
<h3 id="3-2-Tomcatå®‰è£…"><a href="#3-2-Tomcatå®‰è£…" class="headerlink" title="3.2 Tomcatå®‰è£…"></a>3.2 Tomcatå®‰è£…</h3><ol>
<li>å®‰è£…jdkå’Œtomcat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk*</span><br><span class="line">wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.43/bin/apache-tomcat-9.0.43.tar.gz</span><br><span class="line">tar -xf apache-tomcat-9.0.43.tar.gz</span><br><span class="line">mkdir /root/tomcat</span><br><span class="line">mv apache-tomcat-9.0.43.tar.gz/* /root/tomcat</span><br><span class="line">./root/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:01:00.205Z" title="2/18/2024, 7:01:00 PM">2024-02-18</time></span><span class="level-item">28 minutes read (About 4127 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/redis/">Redis</a></p><div class="content"><h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><p>REmote DIctionary Serverï¼ˆRedisï¼‰æ˜¯ä¸€ä¸ªç”± Salvatore Sanfilippo å†™çš„ key-value å­˜å‚¨ç³»ç»Ÿï¼Œæ˜¯è·¨å¹³å°çš„éå…³ç³»å‹æ•°æ®åº“ã€‚</p>
<p><img src="/2024/02/18/redis/redis_logo.jpeg" alt="redis_logo"></p>
<p>Redis å°±æ˜¯ä¸€æ¬¾ NoSQLï¼Œè€Œ NoSQL å°±æ˜¯æŒ‡éå…³ç³»å‹æ•°æ®åº“ï¼Œä¸»è¦åˆ†ä¸ºå››ç§ï¼š</p>
<ol>
<li>é”®å€¼å‹ï¼šRedis</li>
<li>æ–‡æ¡£å‹ï¼šElasticSearchã€Mongdb</li>
<li>é¢å‘åˆ—ï¼šHbase</li>
<li>å›¾å½¢åŒ–ï¼šNeo4j</li>
</ol>
<h2 id="äºŒã€RedisåŸºç¡€"><a href="#äºŒã€RedisåŸºç¡€" class="headerlink" title="äºŒã€RedisåŸºç¡€"></a>äºŒã€RedisåŸºç¡€</h2><h3 id="2-1-Rediså®‰è£…"><a href="#2-1-Rediså®‰è£…" class="headerlink" title="2.1 Rediså®‰è£…"></a>2.1 Rediså®‰è£…</h3><ol>
<li>é€šè¿‡ docker-compose å®‰è£… redis</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è¿›å…¥å®¹å™¨å†…éƒ¨æµ‹è¯• redis</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿æ¥redis</span></span><br><span class="line">redis-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span>æ–°å»ºé”®å€¼å¯¹</span></span><br><span class="line">set key value</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">getè·å–é”®å€¼</span></span><br><span class="line">get key</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Rediså¸¸ç”¨å‘½ä»¤"><a href="#2-2-Rediså¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2 Rediså¸¸ç”¨å‘½ä»¤"></a>2.2 Rediså¸¸ç”¨å‘½ä»¤</h3><p>redis çš„æ•°æ®å­˜å‚¨ç»“æ„æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>key-stringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šä¸€ä¸ª key å¯¹åº”ä¸€ä¸ªå€¼</li>
<li>key-hashï¼ˆå“ˆå¸Œï¼‰ï¼šä¸€ä¸ª key å¯¹åº”ä¸€ä¸ª map</li>
<li>key-listï¼ˆåˆ—è¡¨ï¼‰ï¼šä¸€ä¸ª key å¯¹åº”ä¸€ä¸ªåˆ—è¡¨</li>
<li>key-setï¼ˆé›†åˆï¼‰ï¼šä¸€ä¸ª key å¯¹åº”ä¸€ä¸ªé›†åˆ</li>
<li>key-zsetï¼ˆæœ‰åºé›†åˆï¼‰ï¼šä¸€ä¸ª key å¯¹åº”ä¸€ä¸ªæœ‰åºçš„é›†åˆ</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%80.png" alt="redisä¸€"></p>
<h4 id="2-2-1-stringå¸¸ç”¨å‘½ä»¤"><a href="#2-2-1-stringå¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2.1 stringå¸¸ç”¨å‘½ä»¤"></a>2.2.1 stringå¸¸ç”¨å‘½ä»¤</h4><ol>
<li>è®¾ç½®å€¼</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set key value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å–å€¼</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æ‰¹é‡æ“ä½œ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mset key1 value1 key2 value2 ...</span><br><span class="line">mget key1 key2 ... </span><br></pre></td></tr></table></figure>

<ol start="4">
<li>è‡ªå¢</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incr key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>è‡ªå‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decr key</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>è‡ªå¢è‡ªå‡æŒ‡å®šæ•°é‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">incrby key number</span><br><span class="line">decrby key number</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>è®¾ç½®å€¼çš„åŒæ—¶æŒ‡å®šç”Ÿå­˜æ—¶é—´</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key seconds value</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>è®¾ç½®å€¼ï¼Œå¦‚æœå½“å‰ key ä¸å­˜åœ¨å¦‚åŒ setï¼Œå¦‚æœå­˜åœ¨åˆ™è¯´æ˜éƒ½ä¸åš</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key value</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>åœ¨ key å¯¹åº”çš„ value åè¿½åŠ å†…å®¹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key value</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>æŸ¥çœ‹ value å­—ç¬¦ä¸²é•¿åº¦</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-hashå¸¸ç”¨å‘½ä»¤"><a href="#2-2-2-hashå¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2.2 hashå¸¸ç”¨å‘½ä»¤"></a>2.2.2 hashå¸¸ç”¨å‘½ä»¤</h4><ol>
<li>å­˜å‚¨æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hset key field value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è·å–æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hget key field</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æ‰¹é‡æ“ä½œ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hmset key1 field1 value1 field2 value2 ...</span><br><span class="line">hmget key1 firle1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æŒ‡å®šè‡ªå¢</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hincrby key field number</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>è®¾ç½®å€¼ï¼Œå¦‚æœå½“å‰ key ä¸å­˜åœ¨å¦‚åŒ setï¼Œå¦‚æœå­˜åœ¨åˆ™è¯´æ˜éƒ½ä¸åš</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hsetnx key field value</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>æ£€æŸ¥ field æ˜¯å¦å­˜åœ¨</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexists key field</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>åˆ é™¤æŸä¸ª field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdel key field1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>è·å–å½“å‰ hash ç»“æ„ä¸­çš„å…¨éƒ¨ field å’Œ value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgetall key</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>è·å–å½“å‰ hash ç»“æ„ä¸­çš„å…¨éƒ¨ field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hkeys key</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>è·å–å½“å‰ hash ç»“æ„ä¸­çš„å…¨éƒ¨ value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hvals key</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>è·å–å½“å‰ hash ä¸­ field çš„æ•°é‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-listå¸¸ç”¨å‘½ä»¤"><a href="#2-2-3-listå¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2.3 listå¸¸ç”¨å‘½ä»¤"></a>2.2.3 listå¸¸ç”¨å‘½ä»¤</h4><ol>
<li>å­˜å‚¨æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»å·¦ä¾§æ’å…¥æ•°æ®</span></span><br><span class="line">lpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»å³ä¾§æ’å…¥æ•°æ®</span></span><br><span class="line">rpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœkeyä¸å­˜åœ¨ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œå¦‚æœkeyå­˜åœ¨ä½†ä¸æ˜¯listç»“æ„ï¼Œä¹Ÿä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">lpushx key value1 value2 ...</span><br><span class="line">rpushx key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€šè¿‡ç´¢å¼•ä½ç½®æ·»åŠ value</span></span><br><span class="line">lset key index value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è·å–æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å·¦ä¾§å¼¹å‡ºæ•°æ®å¹¶ç§»é™¤</span></span><br><span class="line">lpop key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å³ä¾§å¼¹å‡ºæ•°æ®å¹¶ç§»é™¤</span></span><br><span class="line">rpop key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–ä¸€å®šèŒƒå›´çš„æ•°æ®ï¼Œstartä»0å¼€å§‹ï¼Œstopä¸º-1æ—¶ä¸ºæœ€åä¸€ä¸ªvalueï¼Œ-2æ—¶ä¸ºå€’æ•°ç¬¬äºŒä¸ªvalue</span></span><br><span class="line">lrange key start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¹æ®ç´¢å¼•ä½ç½®è·å–value</span></span><br><span class="line">lindex key index</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–æ•´ä¸ªlistçš„é•¿åº¦</span></span><br><span class="line">llen key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ é™¤æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤listä¸­countä¸ªvalueçš„å€¼ï¼Œå½“count&gt;0ï¼Œä»å·¦å‘å³åˆ é™¤ï¼Œä½†count&lt;0ï¼Œä»å³å‘å·¦åˆ é™¤ï¼Œä½†count==0ï¼Œå…¨éƒ¨åˆ é™¤</span></span><br><span class="line">lrem key count value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿ç•™åˆ—è¡¨ä¸­æŒ‡å®šèŒƒå›´å†…çš„æ•°æ®ï¼Œè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„éƒ½ä¼šè¢«ç§»é™¤</span></span><br><span class="line">ltrim start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†list1ä¸­çš„æœ€åä¸€ä¸ªæ•°æ®å¼¹å‡ºï¼Œæ’å…¥åˆ°list2ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®</span></span><br><span class="line">rpoplpush key1 key2</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-setå¸¸ç”¨å‘½ä»¤"><a href="#2-2-4-setå¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2.4 setå¸¸ç”¨å‘½ä»¤"></a>2.2.4 setå¸¸ç”¨å‘½ä»¤</h4><ol>
<li>å­˜å‚¨æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">valueä¸å…è®¸é‡å¤ï¼Œä¸”æ•°æ®æ— åºæ’åˆ—</span></span><br><span class="line">sadd key value1 value2 ...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è·å–æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–å…¨éƒ¨æ•°æ®</span></span><br><span class="line">smembers key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éšæœºè·å–æ•°æ®ï¼Œå¹¶ç§»é™¤ï¼Œå¯åŠ å¼¹å‡ºæ•°é‡</span></span><br><span class="line">spop key number</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å–å¤šä¸ª<span class="built_in">set</span>çš„äº¤é›†</span></span><br><span class="line">sinter key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å–å¤šä¸ª<span class="built_in">set</span>çš„å¹¶é›†</span></span><br><span class="line">sunion key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å–å¤šä¸ª<span class="built_in">set</span>çš„å·®é›†</span></span><br><span class="line">sdiff key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹å½“å‰<span class="built_in">set</span>æ˜¯å¦åŒ…å«æŸä¸ªå€¼</span></span><br><span class="line">sismember key value</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ é™¤æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5-zsetå¸¸ç”¨å‘½ä»¤"><a href="#2-2-5-zsetå¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2.5 zsetå¸¸ç”¨å‘½ä»¤"></a>2.2.5 zsetå¸¸ç”¨å‘½ä»¤</h4><ol>
<li>å­˜å‚¨æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scoreå¿…é¡»æ˜¯æ•°å€¼ï¼Œvalueä¸å…è®¸é‡å¤</span></span><br><span class="line">zadd key score1 value1 score2 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹scoreï¼Œå¦‚æœvalueå­˜åœ¨åˆ™å¢åŠ åˆ†æ•°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›¸å½“äºzadd</span></span><br><span class="line">zincrby key number value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è·å–æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æŒ‡å®švalueçš„åˆ†æ•°</span></span><br><span class="line">zscore key value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–valueæ•°é‡</span></span><br><span class="line">zcard key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¹æ®scoreèŒƒå›´æŸ¥è¯¢valueæ•°é‡</span></span><br><span class="line">zcount key min max</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¹æ®åˆ†æ•°ä»å°åˆ°å¤§æ’åºï¼Œè·å–æŒ‡å®šèŒƒå›´å†…çš„æ•°æ®ï¼Œæ·»åŠ äº†withscoreså‚æ•°ä¼šè¿”å›valueçš„å…·ä½“score</span></span><br><span class="line">zrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»å¤§åˆ°å°</span></span><br><span class="line">zrevrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¹æ®åˆ†æ•°çš„èŒƒå›´è·å–æ•°æ®ï¼Œå¦‚æœä¸å¸Œæœ›åŒ…æ‹¬minå’Œmaxçš„å€¼å¯ä»¥ç”¨(min max)çš„æ–¹å¼ï¼Œæœ€å¤§æœ€å°å€¼ç”¨Â±infè¡¨ç¤º</span></span><br><span class="line">zrangebyscore key min max withscores [limit,offset,count]</span><br><span class="line">zrevrangebyscore key max min withscores [limit,offset,count]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ é™¤æ•°æ®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-6-keyå¸¸ç”¨å‘½ä»¤"><a href="#2-2-6-keyå¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2.6 keyå¸¸ç”¨å‘½ä»¤"></a>2.2.6 keyå¸¸ç”¨å‘½ä»¤</h4><ol>
<li>æŸ¥çœ‹æ‰€æœ‰key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æŸ¥çœ‹æŸä¸ªkeyæ˜¯å¦å­˜åœ¨</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ é™¤key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del key</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>è®¾ç½®keyçš„ç”Ÿå­˜æ—¶é—´</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å•ä½ä¸ºs</span></span><br><span class="line">expire key seconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å•ä½ä¸ºms</span></span><br><span class="line">pexpire key milliseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒ‡å®šç”Ÿå­˜åˆ°æŸä¸ªæ—¶é—´ç‚¹</span></span><br><span class="line">expireat key timestamp</span><br><span class="line">pexpireat key millseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹keyçš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ï¼Œè¿”å›-2åˆ™keyä¸å­˜åœ¨ï¼Œ-1åˆ™æ²¡è®¾ç½®ç”Ÿå­˜æ—¶é—´</span></span><br><span class="line">ttl key</span><br><span class="line">pttl key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç§»é™¤ç”Ÿå­˜æ—¶é—´</span></span><br><span class="line">persist key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>é€‰æ‹©æ“ä½œçš„åº“</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redisé»˜è®¤æœ‰16ä¸ªåº“</span></span><br><span class="line">select 0~15</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç§»åŠ¨keyåˆ°å¦ä¸€ä¸ªåº“ä¸­</span></span><br><span class="line">move key db</span><br></pre></td></tr></table></figure>

<h4 id="2-2-7-åº“çš„å¸¸ç”¨å‘½ä»¤"><a href="#2-2-7-åº“çš„å¸¸ç”¨å‘½ä»¤" class="headerlink" title="2.2.7 åº“çš„å¸¸ç”¨å‘½ä»¤"></a>2.2.7 åº“çš„å¸¸ç”¨å‘½ä»¤</h4><ol>
<li>æ¸…ç©ºå½“å‰æ‰€åœ¨æ•°æ®åº“</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdb</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdball</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æŸ¥çœ‹å½“å‰åº“æœ‰å¤šå°‘key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbsize</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æŸ¥çœ‹æœ€åä¸€æ¬¡æ“ä½œçš„æ—¶é—´</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lastsave</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>å®æ—¶ç›‘æ§redisæ¥æ”¶åˆ°çš„å‘½ä»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monitor</span><br></pre></td></tr></table></figure>



<h2 id="ä¸‰ã€Redisé…ç½®"><a href="#ä¸‰ã€Redisé…ç½®" class="headerlink" title="ä¸‰ã€Redisé…ç½®"></a>ä¸‰ã€Redisé…ç½®</h2><h3 id="3-1-Redisçš„AUTH"><a href="#3-1-Redisçš„AUTH" class="headerlink" title="3.1 Redisçš„AUTH"></a>3.1 Redisçš„AUTH</h3><ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è®¾ç½® Redis è¿æ¥å¯†ç </li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">requirepass toortoor</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>è¿›å…¥ Redis ä¹‹åéƒ½éœ€è¦è¾“å…¥å¯†ç æ‰å¯ä»¥åˆ›å»º key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">auth toortoor</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Redisçš„äº‹åŠ¡"><a href="#3-2-Redisçš„äº‹åŠ¡" class="headerlink" title="3.2 Redisçš„äº‹åŠ¡"></a>3.2 Redisçš„äº‹åŠ¡</h3><p>Redis äº‹åŠ¡å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œ å¹¶ä¸”å¸¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦çš„ä¿è¯ï¼š</p>
<ul>
<li>æ‰¹é‡æ“ä½œåœ¨å‘é€ EXEC å‘½ä»¤å‰è¢«æ”¾å…¥é˜Ÿåˆ—ç¼“å­˜</li>
<li>æ”¶åˆ° EXEC å‘½ä»¤åè¿›å…¥äº‹åŠ¡æ‰§è¡Œï¼Œäº‹åŠ¡ä¸­ä»»æ„å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä½™çš„å‘½ä»¤ä¾ç„¶è¢«æ‰§è¡Œ</li>
<li>åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ï¼Œå…¶ä»–å®¢æˆ·ç«¯æäº¤çš„å‘½ä»¤è¯·æ±‚ä¸ä¼šæ’å…¥åˆ°äº‹åŠ¡æ‰§è¡Œå‘½ä»¤åºåˆ—ä¸­</li>
</ul>
<p>ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹åˆ°æ‰§è¡Œä¼šç»å†ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>å¼€å§‹äº‹åŠ¡ï¼šmulti</li>
<li>å‘½ä»¤å…¥é˜Ÿï¼šâ€¦â€¦</li>
<li>æ‰§è¡Œäº‹åŠ¡ï¼šexec</li>
<li>å–æ¶ˆäº‹åŠ¡ï¼šdiscard</li>
<li>ç›‘å¬ï¼šåœ¨å¼€å¯äº‹åŠ¡ä¹‹å‰ï¼Œå…ˆé€šè¿‡ watch ç›‘å¬äº‹åŠ¡ä¸­è¦æ“ä½œçš„ keyï¼Œå¦‚æœåœ¨äº‹åŠ¡è¿‡ç¨‹ä¸­æœ‰å…¶ä»–çš„å®¢æˆ·ç«¯ä¿®æ”¹äº† keyï¼Œé‚£ä¹ˆäº‹åŠ¡å°†ä¼šè¢«å–æ¶ˆ</li>
</ul>
<p>äº‹åŠ¡å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ‰“åŒ…çš„æ‰¹é‡æ‰§è¡Œè„šæœ¬ï¼Œä½†æ‰¹é‡æŒ‡ä»¤å¹¶éåŸå­åŒ–çš„æ“ä½œï¼Œä¸­é—´æŸæ¡æŒ‡ä»¤çš„å¤±è´¥ä¸ä¼šå¯¼è‡´å‰é¢å·²åšæŒ‡ä»¤çš„å›æ»šï¼Œä¹Ÿä¸ä¼šé€ æˆåç»­çš„æŒ‡ä»¤ä¸åšã€‚</p>
<ol>
<li>ç›‘å¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch name age gander</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¼€å§‹äº‹åŠ¡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å‘½ä»¤å…¥é˜Ÿ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line">set gander male</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æ‰§è¡Œäº‹åŠ¡&#x2F;å–æ¶ˆäº‹åŠ¡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec/discard</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Redisçš„æŒä¹…åŒ–"><a href="#3-3-Redisçš„æŒä¹…åŒ–" class="headerlink" title="3.3 Redisçš„æŒä¹…åŒ–"></a>3.3 Redisçš„æŒä¹…åŒ–</h3><h4 id="3-3-1-RDBæŒä¹…åŒ–"><a href="#3-3-1-RDBæŒä¹…åŒ–" class="headerlink" title="3.3.1 RDBæŒä¹…åŒ–"></a>3.3.1 RDBæŒä¹…åŒ–</h4><p>Redis çš„é…ç½®æ–‡ä»¶ä½äº Redis å®‰è£…ç›®å½•,	ROB æ˜¯é»˜è®¤çš„æŒä¹…åŒ–æœºåˆ¶ã€‚</p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="comment"># åŠ è½½redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis.conf</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">redis.conf</span></span><br><span class="line"><span class="comment"># åœ¨900ç§’å†…æœ‰1ä¸€ä¸ª key å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±æ‰§è¡Œ RDB æŒä¹…åŒ–</span></span><br><span class="line"><span class="string">save</span> <span class="number">900</span> <span class="number">1</span></span><br><span class="line"><span class="string">save</span> <span class="number">300</span> <span class="number">10</span></span><br><span class="line"><span class="string">save</span> <span class="number">60</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># å¼€å¯RDBæŒä¹…åŒ–</span></span><br><span class="line"><span class="string">rdbchecksum</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># RDBæŒä¹…åŒ–åç§°</span></span><br><span class="line"><span class="string">dbfilename</span> <span class="string">dump.rdb</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æµ‹è¯•æŒä¹…åŒ–</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…³é—­rediså¹¶ä¿å­˜</span></span><br><span class="line">shutdown save</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å¯ä»¥çœ‹åˆ° data ç›®å½•ä¸‹å¤šäº†ä¸ª rdb æ–‡ä»¶ï¼Œå³ä½¿ redis å®¹å™¨é‡å¯ä¹Ÿä¸ä¼šé€ æˆ key çš„ä¸¢å¤±</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%8C.png" alt="redisäºŒ"></p>
<h4 id="3-3-2-AOFæŒä¹…åŒ–"><a href="#3-3-2-AOFæŒä¹…åŒ–" class="headerlink" title="3.3.2 AOFæŒä¹…åŒ–"></a>3.3.2 AOFæŒä¹…åŒ–</h4><p>AOF æ¯”èµ· RDB æœ‰æ›´é«˜çš„æ•°æ®å®‰å…¨æ€§ï¼Œå¦‚æœåŒæ—¶å¼€å¯äº† AOF å’Œ RDBï¼Œé‚£ä¹ˆå‰è€…æ¯”åè€…çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œä¸”å¦‚æœå…ˆå¼€å¯äº† RDB åœ¨å¼€å¯ AOFï¼Œé‚£ä¹ˆ RDB ä¸­çš„å†…å®¹ä¼šè¢« AOF çš„å†…å®¹è¦†ç›–ã€‚</p>
<ol>
<li>redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¼€å¯AOFæŒä¹…åŒ–</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOFæ–‡ä»¶å</span></span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOFæŒä¹…åŒ–æ‰§è¡Œç­–ç•¥</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">always:æ¯æ¬¡æ‰§è¡Œå†™æ“ä½œéƒ½è°ƒç”¨fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">everysec:æœ€å¤šæ¯ç§’è°ƒç”¨ä¸€æ¬¡fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no:æ ¹æ®ç¯å¢ƒçš„ä¸åŒåœ¨ä¸ç¡®å®šçš„æ—¶é—´è°ƒç”¨fsync</span></span><br><span class="line">appendfsync always|everysec|no</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é‡å¯ docker-compose æµ‹è¯•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set gander male</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸RDBæŒä¹…åŒ–</span></span><br><span class="line">shutdown nosave</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯ä»¥çœ‹åˆ° data ç›®å½•ä¸‹å¤šäº†ä¸ª aof æ–‡ä»¶ï¼Œå³ AOF æŒä¹…åŒ–ç”Ÿæˆçš„æ–‡ä»¶</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%B8%89.png" alt="redisä¸‰"></p>
<h3 id="3-4-Redisä¸»ä»æ¶æ„"><a href="#3-4-Redisä¸»ä»æ¶æ„" class="headerlink" title="3.4 Redisä¸»ä»æ¶æ„"></a>3.4 Redisä¸»ä»æ¶æ„</h3><p>Redis çš„ä¸»ä»æ¶æ„æ˜¯æŒ‡ Master èŠ‚ç‚¹è´Ÿè´£å†™æ“ä½œï¼Œè€Œå…¶ä½™çš„ Slave èŠ‚ç‚¹è´Ÿè´£è¯»æ“ä½œã€‚</p>
<p><img src="/2024/02/18/redis/redis%E5%9B%9B.png" alt="rediså››"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="comment"># è¿æ¥redis-masterå®¹å™¨ï¼Œå¹¶å°†è¯¥å®¹å™¨ipåœ°å€æ˜ å°„ä¸ºmaster</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ä»èŠ‚ç‚¹ redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slaveof &lt;ä¸»èŠ‚ç‚¹åœ°å€&gt; &lt;ç«¯å£&gt;</span></span><br><span class="line">slaveof master 6379</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¯åŠ¨åè¿›å…¥å®¹å™¨å†…éƒ¨é€šè¿‡ <code>info</code> å¯çœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%94.png" alt="redisäº”"></p>
<h3 id="3-5-Rediså“¨å…µæ¨¡å¼"><a href="#3-5-Rediså“¨å…µæ¨¡å¼" class="headerlink" title="3.5 Rediså“¨å…µæ¨¡å¼"></a>3.5 Rediså“¨å…µæ¨¡å¼</h3><p>Redis çš„ä¸»ä»æ¶æ„æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é—®é¢˜ï¼Œå°±æ˜¯å½“ Master èŠ‚ç‚¹å‡ºç°é—®é¢˜å®•æœºåï¼Œé‚£ä¹ˆ Redis é›†ç¾¤å°±æ²¡æœ‰å¯ä»¥è¿›è¡Œå†™æ“ä½œçš„ Redis äº†ï¼Œè€Œå“¨å…µå°±å¯ä»¥è§£å†³è¯¥é—®é¢˜ã€‚</p>
<p>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­éƒ½ä¼šæœ‰ä¸ªå“¨å…µä¸ Redis è¿›è¡Œè¿æ¥ï¼Œä¸”å“¨å…µä¸å“¨å…µä¹‹é—´ä¹Ÿä¼šè¿›è¡Œè¿æ¥ï¼Œå¦‚æœ Master èŠ‚ç‚¹å‡ºç°æ•…éšœå®•æœºäº†ï¼Œé‚£ä¹ˆå“¨å…µä»¬å°±ä¼šé€‰å‡ºä¸€ä¸ª Slave æ¥ä½œä¸ºæ–°çš„ Master æ¥æä¾›å†™çš„æ“ä½œã€‚</p>
<p><img src="/2024/02/18/redis/redis%E5%85%AD.png" alt="rediså…­"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel1.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel2.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel3.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Master èŠ‚ç‚¹ sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œredis</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒ‡å®šMasterèŠ‚ç‚¹ï¼Œsentinel monitor &lt;åç§°&gt; &lt;ip&gt; &lt;ç«¯å£&gt; &lt;Slaveä¸ªæ•°&gt;</span></span><br><span class="line">sentinel monitor master localhost 6379 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒ‡å®šå“¨å…µæ¯éš”å¤šä¹…æ£€æµ‹ä¸€æ¬¡redisä¸»ä»æ¶æ„</span></span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Slave èŠ‚ç‚¹ sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">sentinel monitor master master 6379 2</span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>è¿›å…¥å®¹å™¨å¯åŠ¨å“¨å…µï¼Œå½“ Master èŠ‚ç‚¹å‡ºç°é—®é¢˜åï¼Œå°±ä¼šåœ¨ä¸¤ä¸ª Slave ä¸­é€‰å‡ºä¸€ä¸ªä½œä¸ºæ–°çš„ Masterï¼Œè€Œæ—§çš„ Master å¯åŠ¨åå°±ä¼šå˜ä¸ºæ–°çš„ Slave</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel /data/sentinel.conf</span><br></pre></td></tr></table></figure>

<h3 id="3-6-Redisé›†ç¾¤"><a href="#3-6-Redisé›†ç¾¤" class="headerlink" title="3.6 Redisé›†ç¾¤"></a>3.6 Redisé›†ç¾¤</h3><p>Redis é›†ç¾¤åœ¨ä¿è¯ä¸»ä»å’Œå“¨å…µçš„åŸºæœ¬åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜èƒ½æé«˜ Redis å­˜å‚¨æ•°æ®çš„èƒ½åŠ›ï¼Œä¸»è¦çš„ç‰¹ç‚¹å¦‚ä¸‹</p>
<ul>
<li>Redis é›†ç¾¤æ˜¯æ— ä¸­å¿ƒçš„</li>
<li>Redis é›†ç¾¤æœ‰ping-pangçš„æœºåˆ¶</li>
<li>æŠ•ç¥¨æœºåˆ¶ï¼Œé›†ç¾¤èŠ‚ç‚¹çš„æ•°é‡å¿…é¡»æ˜¯ 2n+1</li>
<li>åˆ†é…äº† 16484 ä¸ª hash æ§½ï¼Œåœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œä¼šå¯¹ key è¿›è¡Œ crc16 çš„ç®—æ³•ï¼Œå¹¶å¯¹ 16384 è¿›è¡Œå–ä½™ï¼Œé€šè¿‡ç»“æœåˆ†é…åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±ç»´æŠ¤çš„ hash æ§½</li>
<li>æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½è¦è·Ÿä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œä½†è¿™é‡Œçš„ä»èŠ‚ç‚¹åªç®¡å¤‡ä»½ï¼Œä¸ç®¡æŸ¥è¯¢</li>
<li>é›†ç¾¤ä¸­åŠæ•°çš„èŠ‚ç‚¹å®•æœºåï¼Œé‚£ä¹ˆé›†ç¾¤å°±ç˜«ç—ª</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%83.png" alt="redisä¸ƒ"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17001</span><span class="string">:17001</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17002</span><span class="string">:17002</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis3:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17003</span><span class="string">:17003</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis4:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis4</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7004</span><span class="string">:7004</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17004</span><span class="string">:17004</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis4.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis5:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis5</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7005</span><span class="string">:7005</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17005</span><span class="string">:17005</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis5.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis6:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7006</span><span class="string">:7006</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17006</span><span class="string">:17006</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis6.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis{1..6}.confï¼Œx ä¸º {1..6}</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šredisç«¯å£</span></span><br><span class="line"><span class="string">port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># å¼€å¯é›†ç¾¤</span></span><br><span class="line"><span class="string">cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># é›†ç¾¤ä¿¡æ¯æ–‡ä»¶</span></span><br><span class="line"><span class="string">cluster-config-file</span> <span class="string">nodes-700x.conf</span></span><br><span class="line"><span class="comment"># é›†ç¾¤å¯¹å¤–ip</span></span><br><span class="line"><span class="string">cluster-announce-ip</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.135</span></span><br><span class="line"><span class="comment"># é›†ç¾¤å¯¹å¤–ç«¯å£</span></span><br><span class="line"><span class="string">cluster-announce-port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># é›†ç¾¤æ€»çº¿ç«¯å£</span></span><br><span class="line"><span class="string">cluster-announce-bus-port</span> <span class="string">1700x</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>è¿›å…¥ä»»æ„ reids å®¹å™¨åˆ›å»ºé›†ç¾¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--cluster-replicas:æ¯ä¸ªä¸»èŠ‚ç‚¹åˆ†é…çš„ä»èŠ‚ç‚¹ä¸ªæ•°</span></span><br><span class="line">redis-cli --cluster create 192.168.88.135:7001 192.168.88.135:7002 192.168.88.135:7003 192.168.88.135:7004 192.168.88.135:7005 192.168.88.135:7006 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç”±äºæ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½è¢«åˆ†é…äº†ä¸åŒçš„ hash æ§½ï¼Œæ‰€ä»¥è¦åœ¨å®¹å™¨å†…ä»»æ„åˆ‡æ¢ä¸åŒçš„ redis èŠ‚ç‚¹éœ€è¦åŠ å‚æ•° <code>-c</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.88.135 -p 7001 -c</span><br></pre></td></tr></table></figure>



<h2 id="å››ã€Rediså¸¸è§é—®é¢˜"><a href="#å››ã€Rediså¸¸è§é—®é¢˜" class="headerlink" title="å››ã€Rediså¸¸è§é—®é¢˜"></a>å››ã€Rediså¸¸è§é—®é¢˜</h2><h3 id="4-1-Redisçš„åˆ é™¤ç­–ç•¥"><a href="#4-1-Redisçš„åˆ é™¤ç­–ç•¥" class="headerlink" title="4.1 Redisçš„åˆ é™¤ç­–ç•¥"></a>4.1 Redisçš„åˆ é™¤ç­–ç•¥</h3><p>å½“ key çš„ç”Ÿå­˜æ—¶é—´åˆ°äº†ï¼ŒRedis å¹¶ä¸ä¼šç«‹å³åˆ é™¤è¯¥ keyï¼Œè€Œæ˜¯éµå®ˆä»¥ä¸‹åˆ é™¤ç­–ç•¥æ¥è¿›è¡Œåˆ é™¤</p>
<ul>
<li>å®šæœŸåˆ é™¤ï¼šRedis æ¯éš”ä¸€æ®µæ—¶é—´å°±å›å»æŸ¥çœ‹è®¾ç½®äº†ç”Ÿå­˜æ—¶é—´çš„ keyï¼Œé»˜è®¤æ˜¯ 100ms æŸ¥çœ‹ 3 ä¸ª key</li>
<li>æƒ°æ€§åˆ é™¤ï¼šå½“ç”¨æˆ·å»æŸ¥è¯¢å·²ç»è¶…è¿‡äº†ç”Ÿå­˜æ—¶é—´çš„ keyï¼ŒRedis ä¼šå…ˆæŸ¥çœ‹è¯¥ key æ˜¯å¦å·²ç»è¶…è¿‡äº†ç”Ÿå­˜æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ï¼Œé‚£ä¹ˆ Redis ä¼šå°†è¯¥ key åˆ é™¤å¹¶ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªç©ºå€¼</li>
</ul>
<h3 id="4-2-Redisçš„æ·˜æ±°æœºåˆ¶"><a href="#4-2-Redisçš„æ·˜æ±°æœºåˆ¶" class="headerlink" title="4.2 Redisçš„æ·˜æ±°æœºåˆ¶"></a>4.2 Redisçš„æ·˜æ±°æœºåˆ¶</h3><p>å½“ Redis å†…å­˜æ»¡çš„æ—¶å€™æ·»åŠ äº†ä¸€ä¸ªæ–°çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ Redis çš„æ·˜æ±°æœºåˆ¶ï¼Œé€šè¿‡ <code>maxmemory-policy</code> æ¥è®¾ç½®ï¼Œå‚æ•°å¦‚ä¸‹</p>
<ol>
<li><p>volatile-lruï¼šå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šåˆ é™¤ä¸€ä¸ªè®¾ç½®äº†ç”Ÿå­˜æ—¶é—´ä¸”æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ key</p>
</li>
<li><p>allkeys-lruï¼šå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šåˆ é™¤ä¸€ä¸ªè®¾ç½®äº†æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ key</p>
</li>
<li><p>volatile-lfuï¼šå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šåˆ é™¤ä¸€ä¸ªè®¾ç½®äº†ç”Ÿå­˜æ—¶é—´ä¸”æœ€è¿‘ä½¿ç”¨é¢‘ç‡æœ€ä½çš„ key</p>
</li>
<li><p>allkeys-lfuï¼šå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šåˆ é™¤ä¸€ä¸ªè®¾ç½®äº†æœ€è¿‘ä½¿ç”¨é¢‘ç‡æœ€ä½çš„ key</p>
</li>
<li><p>volatile-randomï¼šå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šéšæœºåˆ é™¤ä¸€ä¸ªè®¾ç½®äº†ç”Ÿå­˜æ—¶é—´çš„ key</p>
</li>
<li><p>allkeys-randomï¼šå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šéšæœºåˆ é™¤ä¸€ä¸ª key</p>
</li>
<li><p>volatile-ttlï¼šå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šåˆ é™¤ä¸€ä¸ªç”Ÿå­˜æ—¶é—´æœ€å°‘çš„ key</p>
</li>
<li><p>noevictionï¼šå†…å­˜ä¸è¶³æ—¶ï¼Œç›´æ¥æŠ¥é”™</p>
</li>
</ol>
<h3 id="4-3-ç¼“å­˜é—®é¢˜"><a href="#4-3-ç¼“å­˜é—®é¢˜" class="headerlink" title="4.3 ç¼“å­˜é—®é¢˜"></a>4.3 ç¼“å­˜é—®é¢˜</h3><p><strong>ç¼“å­˜ç©¿é€</strong></p>
<p>å½“å®¢æˆ·æŸ¥è¯¢çš„æ•°æ® Redis ä¸­æ²¡æœ‰ï¼Œæ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰ï¼Œä¸”è¯·æ±‚é‡ç‰¹åˆ«å¤§æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®åº“çš„å‹åŠ›è¿‡å¤§ï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹</p>
<ul>
<li>æ ¹æ® id æŸ¥è¯¢æ—¶ï¼Œå¦‚æœ id æ˜¯è‡ªå¢çš„ï¼Œé‚£ä¹ˆå¯ä»¥å°†æœ€å¤§çš„ id æ”¾åˆ° Reids ä¸­ï¼Œå½“æŸ¥è¯¢æ•°æ®æ—¶ç›´æ¥å¯¹æ¯” id å³å¯</li>
<li>å¦‚æœ id ä¸æ˜¯ int å‹ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¨éƒ¨çš„ id æ”¾å…¥ set ä¸­ï¼Œç”¨æˆ·æŸ¥è¯¢ä¹‹å‰å¯ä»¥å…ˆåˆ° set æŸ¥çœ‹æ˜¯å¦æœ‰è¯¥ id</li>
<li>è·å–ç”¨æˆ·çš„ ip åœ°å€ï¼Œå¯¹è¯¥åœ°å€è¿›è¡Œè®¿é—®é™åˆ¶</li>
</ul>
<p><strong>ç¼“å­˜å‡»ç©¿</strong></p>
<p>å½“ç”¨æˆ·æŸ¥è¯¢çš„æ˜¯çƒ­ç‚¹æ•°æ®æ—¶ï¼Œé‚£ä¹ˆå¹¶å‘é‡è‚¯å®šæ˜¯å¾ˆé«˜çš„ï¼Œå½“ Redis ä¸­çš„çƒ­ç‚¹æ•°æ®è¿‡æœŸäº†ï¼Œé‚£ä¹ˆæ•°æ®åº“çš„å‹åŠ›å°±ä¼šå¾ˆå¤§ï¼Œç”šè‡³å®•æœºï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹</p>
<ul>
<li>åœ¨è®¿é—®çƒ­ç‚¹æ•°æ®æ—¶ï¼Œç¼“å­˜ä¸­æ²¡æœ‰çš„æ—¶å€™ï¼Œå¯ä»¥æ·»åŠ ä¸€æŠŠé”ï¼Œè®©å‡ ä¸ªè¯·æ±‚å»è®¿é—®æ•°æ®åº“ï¼Œé¿å…æ•°æ®åº“å®•æœº</li>
<li>æŠŠçƒ­ç‚¹æ•°æ®çš„ç”Ÿå­˜æ—¶é—´å»æ‰</li>
</ul>
<p><strong>ç¼“å­˜é›ªå´©</strong></p>
<p>å½“å¤§é‡ç¼“å­˜åŒæ—¶åˆ°æœŸæ—¶ï¼Œå¯¼è‡´è¯·æ±‚éƒ½å»åˆ°äº†æ•°æ®åº“ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¯¼è‡´æ•°æ®åº“å®•æœºï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹</p>
<ul>
<li>å¯¹ç¼“å­˜ä¸­çš„æ•°æ®è®¾ç½®ä¸€ä¸ªéšæœºçš„ç”Ÿå­˜æ—¶é—´ï¼Œé¿å…åŒæ—¶è¿‡æœŸ</li>
</ul>
<p><strong>ç¼“å­˜å€¾æ–œ</strong></p>
<p>å¦‚æœå°†çƒ­ç‚¹æ•°æ®æ”¾åœ¨é›†ç¾¤ä¸­çš„æŸä¸€ Redis èŠ‚ç‚¹ä¸Šæ—¶ï¼Œé‚£ä¹ˆå¤§é‡çš„æ•°æ®éƒ½ä¼šå»åˆ°è¯¥ Redis èŠ‚ç‚¹ï¼Œå¯¼è‡´èŠ‚ç‚¹å®•æœºï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹</p>
<ul>
<li>ä¸»ä»æ¶æ„ï¼Œå‡†å¤‡å¤§é‡çš„ä»èŠ‚ç‚¹</li>
<li>åœ¨ Tomcat ä¸­åš JVM ç¼“å­˜ï¼Œåœ¨æŸ¥è¯¢ Redis å‰å…ˆæŸ¥è¯¢ JVM ç¼“å­˜</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:00:41.990Z" title="2/18/2024, 7:00:41 PM">2024-02-18</time></span><span class="level-item">31 minutes read (About 4642 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/prometheus/">Prometheus</a></p><div class="content"><p><img src="/prometheus_logo.png" alt="prometheus_logo"></p>
<p>Prometheusæ˜¯ä¸€ä¸ªå¼€æºçš„<strong>äº‘åŸç”Ÿ</strong>ç›‘æ§ç³»ç»Ÿå’Œæ—¶é—´åºåˆ—æ•°æ®åº“ã€‚</p>
<h2 id="ä¸€ã€Prometheusæ¦‚è¿°"><a href="#ä¸€ã€Prometheusæ¦‚è¿°" class="headerlink" title="ä¸€ã€Prometheusæ¦‚è¿°"></a>ä¸€ã€Prometheusæ¦‚è¿°</h2><p>Prometheus ä½œä¸ºæ–°ä¸€ä»£çš„äº‘åŸç”Ÿç›‘æ§ç³»ç»Ÿï¼Œç›®å‰å·²ç»æœ‰è¶…è¿‡ 650+ä½è´¡çŒ®è€…å‚ä¸åˆ° Prometheus çš„ç ”å‘å·¥ä½œä¸Šï¼Œå¹¶ä¸”è¶…è¿‡ 120+é¡¹çš„ç¬¬ä¸‰æ–¹é›†æˆã€‚</p>
<h3 id="1-1-Prometheusçš„ä¼˜ç‚¹"><a href="#1-1-Prometheusçš„ä¼˜ç‚¹" class="headerlink" title="1.1 Prometheusçš„ä¼˜ç‚¹"></a>1.1 Prometheusçš„ä¼˜ç‚¹</h3><ol>
<li><strong>æä¾›å¤šç»´åº¦æ•°æ®æ¨¡å‹å’Œçµæ´»çš„æŸ¥è¯¢æ–¹å¼</strong>ï¼Œé€šè¿‡å°†ç›‘æ§æŒ‡æ ‡å…³è”å¤šä¸ª tagï¼Œæ¥å°†ç›‘æ§æ•°æ®è¿›è¡Œä»»æ„ç»´åº¦çš„ç»„åˆï¼Œå¹¶ä¸”æä¾›ç®€å•çš„ PromQL æŸ¥è¯¢æ–¹å¼ï¼Œè¿˜æä¾› HTTP æŸ¥è¯¢æ¥å£ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç»“åˆ Grafana ç­‰ GUI ç»„ä»¶å±•ç¤ºæ•°æ®ã€‚</li>
<li>åœ¨ä¸ä¾èµ–å¤–éƒ¨å­˜å‚¨çš„æƒ…å†µä¸‹ï¼Œ<strong>æ”¯æŒæœåŠ¡å™¨èŠ‚ç‚¹çš„æœ¬åœ°å­˜å‚¨</strong>ï¼Œé€šè¿‡ Prometheus è‡ªå¸¦çš„æ—¶åºæ•°æ®åº“ï¼Œå¯ä»¥å®Œæˆæ¯ç§’åƒä¸‡çº§çš„æ•°æ®å­˜å‚¨ï¼›ä¸ä»…å¦‚æ­¤ï¼Œåœ¨ä¿å­˜å¤§é‡å†å²æ•°æ®çš„åœºæ™¯ä¸­ï¼ŒPrometheus å¯ä»¥å¯¹æ¥ç¬¬ä¸‰æ–¹æ—¶åºæ•°æ®åº“å’Œ OpenTSDB ç­‰ã€‚</li>
<li><strong>å®šä¹‰äº†å¼€æ”¾æŒ‡æ ‡æ•°æ®æ ‡å‡†</strong>ï¼Œä»¥åŸºäº HTTP çš„ Pull æ–¹å¼é‡‡é›†æ—¶åºæ•°æ®ï¼Œåªæœ‰å®ç°äº† Prometheus ç›‘æ§æ•°æ®æ‰å¯ä»¥è¢« Prometheus é‡‡é›†ã€æ±‡æ€»ã€å¹¶æ”¯æŒ Push æ–¹å¼å‘ä¸­é—´ç½‘å…³æ¨é€æ—¶åºåˆ—æ•°æ®ï¼Œèƒ½æ›´åŠ çµæ´»åœ°åº”å¯¹å¤šç§ç›‘æ§åœºæ™¯ã€‚</li>
<li><strong>æ”¯æŒé€šè¿‡é™æ€æ–‡ä»¶é…ç½®å’ŒåŠ¨æ€å‘ç°æœºåˆ¶å‘ç°ç›‘æ§å¯¹è±¡ï¼Œè‡ªåŠ¨å®Œæˆæ•°æ®é‡‡é›†</strong>ã€‚</li>
<li>Prometheus ç›®å‰å·²ç»æ”¯æŒ Kubernetesã€etcdã€Consul ç­‰å¤šç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚<strong>æ˜“äºç»´æŠ¤</strong>ï¼Œå¯ä»¥é€šè¿‡äºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥å¯åŠ¨ï¼Œå¹¶ä¸”æä¾›äº†å®¹å™¨åŒ–éƒ¨ç½²é•œåƒã€‚</li>
<li><strong>æ”¯æŒæ•°æ®çš„åˆ†åŒºé‡‡æ ·å’Œè”é‚¦éƒ¨ç½²ï¼Œæ”¯æŒå¤§è§„æ¨¡é›†ç¾¤ç›‘æ§ã€‚</strong></li>
</ol>
<h3 id="1-2-PrometheusåŸºæœ¬ç»„ä»¶"><a href="#1-2-PrometheusåŸºæœ¬ç»„ä»¶" class="headerlink" title="1.2 PrometheusåŸºæœ¬ç»„ä»¶"></a>1.2 PrometheusåŸºæœ¬ç»„ä»¶</h3><ol>
<li>Prometheus Serverï¼šæ˜¯ Prometheus ç»„ä»¶ä¸­çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œè´Ÿè´£å®ç°å¯¹ç›‘æ§æ•°æ®çš„è·å–ï¼Œå­˜å‚¨ä»¥åŠæŸ¥è¯¢ã€‚æ”¶é›†åˆ°çš„æ•°æ®ç»Ÿç§°ä¸º<strong>metrics</strong>ã€‚</li>
<li>Push Gatewayï¼šå½“ç½‘ç»œéœ€æ±‚æ— æ³•ç›´æ¥æ»¡è¶³æ—¶ï¼Œå°±å¯ä»¥åˆ©ç”¨ Push Gateway æ¥è¿›è¡Œä¸­è½¬ã€‚å¯ä»¥é€šè¿‡ Push Gateway å°†å†…éƒ¨ç½‘ç»œçš„ç›‘æ§æ•°æ®ä¸»åŠ¨ <strong>Push</strong> åˆ° Gateway å½“ä¸­ã€‚è€Œ Prometheus Server åˆ™å¯ä»¥é‡‡ç”¨åŒæ · <strong>Pull</strong> çš„æ–¹å¼ä» Push Gateway ä¸­è·å–åˆ°ç›‘æ§æ•°æ®ã€‚</li>
<li>Exporterï¼šä¸»è¦ç”¨æ¥é‡‡é›†æ•°æ®ï¼Œå¹¶é€šè¿‡ HTTP æœåŠ¡çš„å½¢å¼æš´éœ²ç»™ Prometheus Serverï¼ŒPrometheus Server é€šè¿‡è®¿é—®è¯¥ Exporter æä¾›çš„æ¥å£ï¼Œå³å¯è·å–åˆ°éœ€è¦é‡‡é›†çš„ç›‘æ§æ•°æ®ã€‚</li>
<li>Alert managerï¼šç®¡ç†å‘Šè­¦ï¼Œä¸»è¦æ˜¯è´Ÿè´£å®ç°æŠ¥è­¦åŠŸèƒ½ã€‚ç°åœ¨grafanaä¹Ÿèƒ½å®ç°æŠ¥è­¦åŠŸèƒ½ï¼Œæ‰€ä»¥ä¹Ÿæ…¢æ…¢è¢«å–ä»£ã€‚</li>
</ol>
<p><img src="/2024/02/18/prometheus/Prometheus%E6%9E%B6%E6%9E%84.png" alt="Prometheusæ¶æ„"></p>
<h3 id="1-3-Prometheusæ•°æ®ç±»å‹"><a href="#1-3-Prometheusæ•°æ®ç±»å‹" class="headerlink" title="1.3 Prometheusæ•°æ®ç±»å‹"></a>1.3 Prometheusæ•°æ®ç±»å‹</h3><ol>
<li>Counterï¼ˆè®¡æ•°å™¨ç±»å‹ï¼‰ï¼šCounterç±»å‹çš„æŒ‡æ ‡çš„å·¥ä½œæ–¹å¼å’Œè®¡æ•°å™¨ä¸€æ ·ï¼Œåªå¢ä¸å‡ï¼ˆé™¤éç³»ç»Ÿå‘ç”Ÿäº†é‡ç½®ï¼‰ã€‚</li>
<li>Gaugeï¼ˆä»ªè¡¨ç›˜ç±»å‹ï¼‰ï¼šGaugeæ˜¯å¯å¢å¯å‡çš„æŒ‡æ ‡ç±»ï¼Œå¯ä»¥ç”¨äºååº”å½“å‰åº”ç”¨çš„çŠ¶æ€ã€‚</li>
<li>Histogramï¼ˆç›´æ–¹å›¾ç±»å‹ï¼‰ï¼šä¸»è¦ç”¨äºè¡¨ç¤ºä¸€æ®µæ—¶é—´èŒƒå›´å†…å¯¹æ•°æ®è¿›è¡Œé‡‡æ ·ï¼ˆé€šå¸¸æ˜¯è¯·æ±‚æŒç»­æ—¶é—´æˆ–å“åº”å¤§å°ï¼‰ï¼Œå¹¶èƒ½å¤Ÿå¯¹å…¶æŒ‡å®šåŒºé—´ä»¥åŠæ€»æ•°è¿›è¡Œç»Ÿè®¡ï¼Œé€šå¸¸å®ƒé‡‡é›†çš„æ•°æ®å±•ç¤ºä¸ºç›´æ–¹å›¾ã€‚</li>
<li>Summaryï¼ˆæ‘˜è¦ç±»å‹ï¼‰ï¼šä¸»è¦ç”¨äºè¡¨ç¤ºä¸€æ®µæ—¶é—´å†…æ•°æ®é‡‡æ ·ç»“æœï¼ˆé€šå¸¸æ˜¯è¯·æ±‚æŒç»­æ—¶é—´æˆ–å“åº”å¤§å°ï¼‰ã€‚</li>
</ol>
<h2 id="äºŒã€Prometheuså®‰è£…"><a href="#äºŒã€Prometheuså®‰è£…" class="headerlink" title="äºŒã€Prometheuså®‰è£…"></a>äºŒã€Prometheuså®‰è£…</h2><h3 id="2-1-Prometheus-serverå®‰è£…"><a href="#2-1-Prometheus-serverå®‰è£…" class="headerlink" title="2.1 Prometheus serverå®‰è£…"></a>2.1 Prometheus serverå®‰è£…</h3><ol>
<li>Prometheuså®‰è£…è¾ƒä¸ºç®€å•ï¼Œä¸‹è½½è§£å‹å³å¯</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.26.0-rc.0/prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.26.0-rc.0.linux-amd64 prometheus</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>prometheus.ymlé…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¨å±€é…ç½®</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> <span class="comment"># è®¾ç½®æŠ“å–é—´éš”ï¼Œé»˜è®¤ä¸º1åˆ†é’Ÿ</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># ä¼°ç®—è§„åˆ™çš„é»˜è®¤å‘¨æœŸï¼Œæ¯15ç§’è®¡ç®—ä¸€æ¬¡è§„åˆ™ï¼Œé»˜è®¤1åˆ†é’Ÿ</span></span><br><span class="line">  <span class="comment"># scrape_timeout # é»˜è®¤æŠ“å–è¶…æ—¶ï¼Œé»˜è®¤ä¸º10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ¥è­¦é…ç½®</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§„åˆ™æ–‡ä»¶åˆ—è¡¨ï¼Œä½¿ç”¨&#x27;evaluation_interval&#x27; å‚æ•°å»æŠ“å–</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“å–é…ç½®åˆ—è¡¨</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># ä»»åŠ¡åç§°</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="comment"># è¦è¢«ç›‘æ§çš„å®¢æˆ·ç«¯</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åˆ›å»ºPrometheusçš„ç”¨æˆ·åŠæ•°æ®å­˜å‚¨ç›®å½•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd prometheus</span><br><span class="line">useradd -g prometheus -s /sbin/nologin prometheus</span><br><span class="line">mkdir /root/prometheus/data</span><br><span class="line">chown -R prometheus:prometheus /root/prometheus</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Prometheusçš„å¯åŠ¨å¾ˆç®€å•ï¼Œåªéœ€è¦ç›´æ¥å¯åŠ¨è§£å‹ç›®å½•çš„äºŒè¿›åˆ¶æ–‡ä»¶Prometheuså³å¯ï¼Œä½†æ˜¯ä¸ºäº†æ›´åŠ æ–¹ä¾¿å¯¹Prometheusè¿›è¡Œç®¡ç†ï¼Œè¿™é‡Œç¼–å†™è„šæœ¬æˆ–è€…ä½¿ç”¨screenå·¥å…·æ¥è¿›è¡Œå¯åŠ¨</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /root/prometheus/start.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">prometheus_dir=/root/prometheus</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;prometheus_dir&#125;/prometheus --config.file=<span class="variable">$&#123;prometheus_dir&#125;</span>/prometheus.yml --storage.tsdb.path=<span class="variable">$&#123;prometheus_dir&#125;</span>/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--config.file:æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.path:æŒ‡å®štsdbè·¯å¾„</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.retention.time:æŒ‡å®šæ•°æ®å­˜å‚¨æ—¶é—´</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--web.enable-lifecycle:ç±»ä¼¼nginxçš„reloadåŠŸèƒ½</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.no-lockfile:å¦‚æœç”¨k8sçš„deploymentç®¡ç†éœ€åŠ æ­¤é¡¹</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>å¯åŠ¨Prometheusåè®¿é—®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">nohup</span>è‹±æ–‡å…¨ç§°no hang upï¼ˆä¸æŒ‚èµ·ï¼‰ï¼Œç”¨äºåœ¨ç³»ç»Ÿåå°ä¸æŒ‚æ–­åœ°è¿è¡Œå‘½ä»¤ï¼Œé€€å‡ºç»ˆç«¯ä¸ä¼šå½±å“ç¨‹åºçš„è¿è¡Œã€‚</span></span><br><span class="line">nohup sh start.sh 2&gt;&amp;1 &gt; prometheus.log</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/Prometheus%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="Prometheuså®‰è£…ä¸€"></p>
<ol start="6">
<li>ç”¨screenå·¥å…·è¿›è¡Œå¯åŠ¨</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿›å…¥åå°</span></span><br><span class="line">screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿è¡Œè„šæœ¬</span></span><br><span class="line">/root/prometheus/prometheus --config.file=/root/prometheus/prometheus.yml --storage.tsdb.path=/root/prometheus/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å…¥CTRL + A + Dæ’¤å›å‰å°</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹åå°è¿è¡Œçš„è„šæœ¬</span></span><br><span class="line">screen -ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿”å›åå°</span></span><br><span class="line">screen -r åå°id</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤åå°</span></span><br><span class="line">screen -S åå°id -X quit</span><br></pre></td></tr></table></figure>

<h3 id="2-2-node-exporterå®‰è£…"><a href="#2-2-node-exporterå®‰è£…" class="headerlink" title="2.2 node exporterå®‰è£…"></a>2.2 node exporterå®‰è£…</h3><p>åœ¨Prometheusæ¶æ„ä¸­ï¼Œexporteræ˜¯è´Ÿè´£æ”¶é›†æ•°æ®å¹¶å°†ä¿¡æ¯æ±‡æŠ¥ç»™Prometheus Serverçš„ç»„ä»¶ã€‚å®˜æ–¹æä¾›äº†node_exporterå†…ç½®äº†å¯¹ä¸»æœºç³»ç»Ÿçš„åŸºç¡€ç›‘æ§ã€‚</p>
<ol>
<li>ä¸‹è½½node exporter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">tar -xf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">mv node_exporter-1.1.2.linux-amd64.tar.gz node_exporter</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨prometheus.ymlä¸­æ·»åŠ è¢«ç›‘æ§ä¸»æœº</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>,<span class="string">&#x27;localhost:9100&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åå°å¯åŠ¨exporterå’Œé‡å¯prometheus</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>é€šè¿‡curlå‘½ä»¤è·å–æ”¶é›†åˆ°çš„æ•°æ®key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9100/metrics</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>ç”¨å…¶ä¸­çš„ä¸€ä¸ªkeyåœ¨Prometheusæµ‹è¯•æ˜¯å¦è¢«ç›‘æ§</li>
</ol>
<p><img src="/2024/02/18/prometheus/node_exporter%E6%B5%8B%E8%AF%95.png" alt="node_exporteræµ‹è¯•"></p>
<h2 id="ä¸‰ã€Prometheuså‘½ä»¤è¡Œçš„ä½¿ç”¨"><a href="#ä¸‰ã€Prometheuså‘½ä»¤è¡Œçš„ä½¿ç”¨" class="headerlink" title="ä¸‰ã€Prometheuså‘½ä»¤è¡Œçš„ä½¿ç”¨"></a>ä¸‰ã€Prometheuså‘½ä»¤è¡Œçš„ä½¿ç”¨</h2><h3 id="3-1-è®¡ç®—cpuä½¿ç”¨ç‡"><a href="#3-1-è®¡ç®—cpuä½¿ç”¨ç‡" class="headerlink" title="3.1 è®¡ç®—cpuä½¿ç”¨ç‡"></a>3.1 è®¡ç®—cpuä½¿ç”¨ç‡</h3><p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png" alt="è®¡ç®—cpuä½¿ç”¨ç‡ä¸€"></p>
<p>é€šè¿‡ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼Œlinuxçš„cpuä½¿ç”¨æ˜¯åˆ†ä¸ºå¾ˆå¤šç§çŠ¶æ€çš„ï¼Œä¾‹å¦‚ç”¨æˆ·æ€userï¼Œç©ºé—²æ€idleã€‚</p>
<p>è¦è®¡ç®—cpuçš„ä½¿ç”¨ç‡æœ‰ä¸¤ç§ç²—ç•¥çš„å…¬å¼ï¼š</p>
<ol>
<li>é™¤å»idleçŠ¶æ€çš„æ‰€æœ‰cpuçŠ¶æ€æ—¶é—´ä¹‹å’Œ &#x2F; cpuæ—¶é—´æ€»å’Œ</li>
<li>100% - ï¼ˆidleçŠ¶æ€ &#x2F; cpuæ—¶é—´æ€»å’Œï¼‰</li>
</ol>
<p>ä½†è¿™ä¸¤ç§æ–¹å¼éƒ½å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å¦‚ä½•è®¡ç®—æŸä¸€æ—¶é—´æ®µçš„cpuä½¿ç”¨ç‡ï¼Ÿä¾‹å¦‚ç²¾ç¡®åˆ°æ¯ä¸€åˆ†é’Ÿã€‚</li>
<li>å®é™…å·¥ä½œä¸­cpuå¤§å¤šæ•°éƒ½æ˜¯å¤šæ ¸çš„ï¼Œnode exporteræˆªå–åˆ°çš„æ•°æ®ç²¾ç¡®åˆ°äº†æ¯ä¸ªæ ¸ï¼Œå¦‚ä½•ç›‘æ§æ‰€æœ‰æ ¸åŠ èµ·æ¥çš„æ•°æ®ï¼Ÿ</li>
</ol>
<p>Prometheusæä¾›äº†è®¸å¤šçš„å‡½æ•°ï¼Œå…¶ä¸­ increase å’Œ sum å°±å¾ˆå¥½çš„è§£å†³äº†ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li>æå–cpuçš„keyï¼Œå³node_cpu_seconds_total</li>
<li>æŠŠidleç©ºé—²æ—¶é—´å’Œæ€»æ—¶é—´è¿‡æ»¤å‡ºæ¥ï¼Œåœ¨Prometheusä¸­ä½¿ç”¨{}è¿›è¡Œè¿‡æ»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ä½¿ç”¨increaseå‡½æ•°å–ä¸€åˆ†é’Ÿå†…çš„å¢é‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ä½¿ç”¨sumå‡½æ•°å°†æ¯ä¸ªæ ¸çš„æ•°æ•´åˆèµ·æ¥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m]))</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œåˆå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œsumå‡½æ•°ä¼šå°†æ‰€æœ‰æ•°æ®æ•´åˆèµ·æ¥ï¼Œä¸å…‰å°†ä¸€å°æœºå™¨çš„æ‰€æœ‰cpuåŠ åˆ°ä¸€èµ·ï¼Œä¹Ÿå°†æ‰€æœ‰æœºå™¨çš„cpuéƒ½åŠ åˆ°äº†ä¸€èµ·ï¼Œæœ€ç»ˆæ˜¾ç¤ºçš„æ˜¯é›†ç¾¤cpuçš„æ€»å¹³å‡å€¼ï¼Œby(instance)å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±å¾—åˆ°äº†ç©ºé—²æ—¶cpuçš„æ•°æ®äº†ï¼Œç”¨ä¸Šè¾¹ç¬¬ä¸€ä¸ªå…¬å¼å³å¯å¾—åˆ°å•å°ä¸»æœºcpuåœ¨ä¸€åˆ†é’Ÿå†…çš„ä½¿ç”¨ç‡ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png" alt="è®¡ç®—cpuä½¿ç”¨ç‡äºŒ"></p>
<h3 id="3-2-è®¡ç®—å†…å­˜ä½¿ç”¨ç‡"><a href="#3-2-è®¡ç®—å†…å­˜ä½¿ç”¨ç‡" class="headerlink" title="3.2 è®¡ç®—å†…å­˜ä½¿ç”¨ç‡"></a>3.2 è®¡ç®—å†…å­˜ä½¿ç”¨ç‡</h3><p>å†…å­˜ä½¿ç”¨ç‡å…¬å¼ä¸º &#x3D; (available &#x2F; total) * 100</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87.png" alt="è®¡ç®—å†…å­˜ä½¿ç”¨ç‡"></p>
<h3 id="3-3-rateå‡½æ•°"><a href="#3-3-rateå‡½æ•°" class="headerlink" title="3.3 rateå‡½æ•°"></a>3.3 rateå‡½æ•°</h3><p>rateå‡½æ•°æ˜¯ä¸“é—¨æ­é…counterç±»å‹æ•°æ®ä½¿ç”¨çš„å‡½æ•°ï¼ŒåŠŸèƒ½æ˜¯æŒ‰ç…§è®¾ç½®çš„ä¸€ä¸ªæ—¶é—´æ®µï¼Œå–counteråœ¨è¿™ä¸ªæ—¶é—´æ®µä¸­å¹³å‡æ¯ç§’çš„å¢é‡ã€‚</p>
<p>ä¸¾ä¸ªæ —å­ï¼Œå‡è®¾æˆ‘ä»¬è¦å–ens33è¿™ä¸ªç½‘å¡åœ¨ä¸€åˆ†é’Ÿå†…å­—èŠ‚çš„æ¥å—æ•°é‡ï¼Œå‡å¦‚ä¸€åˆ†é’Ÿå†…æ¥æ”¶åˆ°çš„æ˜¯1000bytesï¼Œé‚£ä¹ˆå¹³å‡æ¯ç§’æ¥æ”¶åˆ°å°±æ˜¯1000bytes &#x2F; 1m * 60s â‰ˆ 16bytes&#x2F;sã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_network_receive_bytes_total&#123;device=&#x27;ens33&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯äº”åˆ†é’Ÿçš„è¯å³ä¸º5000bytes &#x2F; 5m * 60s â‰ˆ 16bytes&#x2F;sï¼Œç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ›²çº¿å›¾å°±ä¸ä¸€æ ·äº†ï¼Œä¸Šå›¾ä¸ºä¸€åˆ†é’Ÿï¼Œä¸‹å›¾ä¸ºäº”åˆ†é’Ÿï¼Œå› ä¸ºäº”åˆ†é’Ÿçš„å¯†åº¦è¦æ›´åº•ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°äº”åˆ†é’Ÿçš„æ›²çº¿å›¾æ›´åŠ å¹³ç¼“ã€‚</p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%B8%80.png" alt="rateå‡½æ•°ä¸€"></p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%BA%8C.png" alt="rateå‡½æ•°äºŒ"></p>
<p>rateå’Œincreaseçš„æ¦‚å¿µæœ‰äº›ç±»ä¼¼ï¼Œä½†rateå–çš„æ˜¯ä¸€æ®µæ—¶é—´å¢é‡çš„å¹³å‡æ¯ç§’æ•°é‡ï¼Œincreaseå–çš„æ˜¯ä¸€æ®µæ—¶é—´å¢é‡çš„æ€»é‡ï¼Œå³ï¼š</p>
<ul>
<li>rate(1m)ï¼šæ€»é‡ &#x2F; 60s</li>
<li>increase(1m)ï¼šæ€»é‡</li>
</ul>
<h3 id="3-4-sumå‡½æ•°"><a href="#3-4-sumå‡½æ•°" class="headerlink" title="3.4 sumå‡½æ•°"></a>3.4 sumå‡½æ•°</h3><p>sumå‡½æ•°å°±æ˜¯å°†æ”¶åˆ°çš„æ•°æ®å…¨éƒ¨è¿›è¡Œæ•´åˆã€‚</p>
<p>å‡å¦‚ä¸€ä¸ªé›†ç¾¤é‡Œæœ‰20å°æœåŠ¡å™¨ï¼Œåˆ†åˆ«ä¸º5å°webæœåŠ¡å™¨ï¼Œ10å°dbæœåŠ¡å™¨ï¼Œè¿˜æœ‰5å°å…¶ä»–æœåŠ¡çš„æœåŠ¡å™¨ï¼Œè¿™æ—¶å€™sumå°±å¯ä»¥åˆ†ä¸ºä¸‰æ¡æ›²çº¿æ¥ä»£è¡¨ä¸åŒåŠŸèƒ½æœåŠ¡å™¨çš„æ€»å’Œæ•°æ®ã€‚</p>
<h3 id="3-5-topkå‡½æ•°"><a href="#3-5-topkå‡½æ•°" class="headerlink" title="3.5 topkå‡½æ•°"></a>3.5 topkå‡½æ•°</h3><p>topkå‡½æ•°çš„ä½œç”¨å°±æ˜¯å–å‰å‡ ä½çš„æœ€é«˜å€¼ã€‚</p>
<p><img src="/2024/02/18/prometheus/topk%E5%87%BD%E6%95%B0%E4%B8%80.png" alt="topkå‡½æ•°ä¸€"></p>
<h3 id="3-6-countå‡½æ•°"><a href="#3-6-countå‡½æ•°" class="headerlink" title="3.6 countå‡½æ•°"></a>3.6 countå‡½æ•°</h3><p>countå‡½æ•°çš„ä½œç”¨æ˜¯æŠŠç¬¦åˆæ¡ä»¶çš„æ•°å€¼è¿›è¡Œæ•´åˆã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬è¦æŸ¥çœ‹é›†ç¾¤ä¸­cpuä½¿ç”¨ç‡è¶…è¿‡80%çš„ä¸»æœºæ•°é‡çš„è¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count((1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100 &gt; 80)</span><br></pre></td></tr></table></figure>



<h2 id="å››ã€Push-gateway"><a href="#å››ã€Push-gateway" class="headerlink" title="å››ã€Push gateway"></a>å››ã€Push gateway</h2><p>Push gatewayå®é™…ä¸Šå°±æ˜¯ä¸€ç§è¢«åŠ¨æ¨é€æ•°æ®çš„æ–¹å¼ï¼Œä¸exporterä¸»åŠ¨è·å–ä¸åŒã€‚</p>
<h3 id="4-1-Push-gatewayå®‰è£…"><a href="#4-1-Push-gatewayå®‰è£…" class="headerlink" title="4.1 Push gatewayå®‰è£…"></a>4.1 Push gatewayå®‰è£…</h3><ol>
<li>ä¸‹è½½å®‰è£…Push gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/pushgateway/releases/download/v1.4.0/pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">mv pushgateway-1.4.0.linux-amd64 pushgateway</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åå°è¿è¡ŒPush gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/pushgateway/pushgateway</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åœ¨prometheus.ymlä¸­åŠ ä¸Š</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;pushgateway&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&#x27;localhost:9091&#x27;]</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E6%B7%BB%E5%8A%A0pushgateway.png" alt="æ·»åŠ pushgateway"></p>
<h3 id="4-2-è‡ªå®šä¹‰ç¼–å†™è„šæœ¬"><a href="#4-2-è‡ªå®šä¹‰ç¼–å†™è„šæœ¬" class="headerlink" title="4.2 è‡ªå®šä¹‰ç¼–å†™è„šæœ¬"></a>4.2 è‡ªå®šä¹‰ç¼–å†™è„šæœ¬</h3><p>ç”±äºPush gatewayè‡ªå·±æœ¬èº«æ˜¯æ²¡æœ‰ä»»ä½•æŠ“å–æ•°æ®çš„åŠŸèƒ½çš„ï¼Œæ‰€ä»¥ç”¨æˆ·éœ€è¦è‡ªè¡Œç¼–å†™è„šæœ¬æ¥æŠ“å–æ•°æ®ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šç¼–å†™è„šæœ¬æŠ“å– TCP waiting_connection çš„æ•°é‡</p>
<ol>
<li>ç¼–å†™è‡ªå®šä¹‰è„šæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–ç›‘æ§ä¸»æœºå</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœä¸»æœºåä¸ºlocalhostï¼Œåˆ™é€€å‡º</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;ä¸èƒ½ç›‘æ§ä¸»æœºåä¸ºlocalhostçš„ä¸»æœº&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–TCP CONNECTEDæ•°é‡</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŠ“å–TCP CONNECTEDæ•°é‡ï¼Œå®šä¹‰ä¸ºä¸€ä¸ªæ–°key</span></span><br><span class="line">lable_tcp_connected=&quot;count_netstat_connected_connections&quot;</span><br><span class="line">count_netstat_connected_connections=`netstat -an | grep &#x27;CONNECTED&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šä¼ è‡³pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_connected $count_netstat_connected_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¯¥è„šæœ¬æ˜¯é€šè¿‡postçš„æ–¹å¼å°†keyæ¨é€ç»™pushgateway</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://localhost:9091 å³æ¨é€ç»™å“ªå°pushgatewayä¸»æœº</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">job/pushgateway å³æ¨é€ç»™prometheus.ymlä¸­å®šä¹‰çš„jobä¸ºpushgatewayçš„ä¸»æœº</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">instance/<span class="variable">$instance_name</span> æ¨é€åæ˜¾ç¤ºçš„ä¸»æœºå</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å› ä¸ºè„šæœ¬éƒ½æ˜¯è¿è¡Œä¸€æ¬¡åå°±ç»“æŸäº†ï¼Œå¯ä»¥é…åˆcrontabåå¤è¿è¡Œ</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡è„šæœ¬</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¯10sæ‰§è¡Œä¸€æ¬¡è„šæœ¬</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC.png" alt="è‡ªå®šä¹‰ç¼–å†™è„šæœ¬"></p>
<h3 id="4-3-ç¼–å†™æŠ“å–pingä¸¢åŒ…å’Œå»¶è¿Ÿæ—¶é—´æ•°æ®"><a href="#4-3-ç¼–å†™æŠ“å–pingä¸¢åŒ…å’Œå»¶è¿Ÿæ—¶é—´æ•°æ®" class="headerlink" title="4.3 ç¼–å†™æŠ“å–pingä¸¢åŒ…å’Œå»¶è¿Ÿæ—¶é—´æ•°æ®"></a>4.3 ç¼–å†™æŠ“å–pingä¸¢åŒ…å’Œå»¶è¿Ÿæ—¶é—´æ•°æ®</h3><p>åœ¨node_exporter_shell.shä¸­åŠ å…¥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–pingæŸç½‘ç«™ä¸¢åŒ…ç‡å’Œå»¶è¿Ÿæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">site_address=&quot;www.baidu.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–ä¸¢åŒ…ç‡å’Œå»¶è¿Ÿæ—¶é—´ï¼Œå®šä¹‰ä¸ºä¸¤ä¸ªæ–°key</span></span><br><span class="line">lable_ping_packet_loss=&quot;ping_packet_loss&quot;</span><br><span class="line">ping_packet_loss_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $6&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å­—ç¬¦ä¸²æˆªå–ï¼Œ%?ä¸ºå»é™¤æœ€åä¸€ä¸ªå­—ç¬¦</span></span><br><span class="line">ping_packet_loss=`echo $&#123;ping_packet_loss_test%?&#125;`</span><br><span class="line"></span><br><span class="line">lable_ping_time=&quot;ping_time&quot;</span><br><span class="line">ping_time_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $10&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å­—ç¬¦ä¸²æˆªå–ï¼Œ%??ä¸ºå»é™¤æœ€åä¸¤ä¸ªå­—ç¬¦</span></span><br><span class="line">ping_time=`echo $&#123;ping_time_test%??&#125;`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šä¼ è‡³push_ping_timegateway</span></span><br><span class="line">echo &quot;$lable_ping_packet_loss $ping_packet_loss&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"></span><br><span class="line">echo &quot;$lable_ping_time $ping_time&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>



<h2 id="äº”ã€Grafanaçš„ä½¿ç”¨"><a href="#äº”ã€Grafanaçš„ä½¿ç”¨" class="headerlink" title="äº”ã€Grafanaçš„ä½¿ç”¨"></a>äº”ã€Grafanaçš„ä½¿ç”¨</h2><p>Grafanaæ˜¯ä¸€æ¬¾ç”¨Goè¯­è¨€å¼€å‘çš„å¼€æºæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥åšæ•°æ®ç›‘æ§å’Œæ•°æ®ç»Ÿè®¡ï¼Œå¸¦æœ‰å‘Šè­¦åŠŸèƒ½ã€‚</p>
<h3 id="5-1-Grafanaå®‰è£…"><a href="#5-1-Grafanaå®‰è£…" class="headerlink" title="5.1 Grafanaå®‰è£…"></a>5.1 Grafanaå®‰è£…</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">yum -y install grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl enable grafana-server</span><br></pre></td></tr></table></figure>

<h3 id="5-2-è®¾ç½®æ•°æ®æº"><a href="#5-2-è®¾ç½®æ•°æ®æº" class="headerlink" title="5.2 è®¾ç½®æ•°æ®æº"></a>5.2 è®¾ç½®æ•°æ®æº</h3><ol>
<li>Grafana -&gt; Configuration -&gt; Date Sources -&gt; Prometheus</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="Grafanaå®‰è£…ä¸€"></p>
<ol start="2">
<li>New dashboard</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%BA%8C.png" alt="Grafanaå®‰è£…äºŒ"></p>
<ol start="3">
<li>æ·»åŠ ä¸€ä¸ªç›‘æ§å’ŒCPUå†…å­˜ä½¿ç”¨ç‡çš„ä»ªè¡¨ç›˜</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%89.png" alt="Grafanaå®‰è£…ä¸‰"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E5%9B%9B.png" alt="Grafanaå®‰è£…å››"></p>
<h3 id="5-3-jsonå¤‡ä»½å’Œè¿˜åŸ"><a href="#5-3-jsonå¤‡ä»½å’Œè¿˜åŸ" class="headerlink" title="5.3 jsonå¤‡ä»½å’Œè¿˜åŸ"></a>5.3 jsonå¤‡ä»½å’Œè¿˜åŸ</h3><ol>
<li>å¤‡ä»½ï¼šdashboard -&gt; Settings -&gt; JSON Modelï¼Œå°†é‡Œé¢å†…å®¹ä¿å­˜ä¸ºjsonæ–‡ä»¶</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E5%A4%87%E4%BB%BD.png" alt="JSONå¤‡ä»½"></p>
<ol start="2">
<li>æ¢å¤ï¼šCreate -&gt; import</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E8%BF%98%E5%8E%9F.png" alt="JSONè¿˜åŸ"></p>
<h3 id="5-4-Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½"><a href="#5-4-Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½" class="headerlink" title="5.4 Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½"></a>5.4 Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½</h3><ol>
<li>é…ç½®Grafanaæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…ä¾èµ–å’Œå›¾å½¢æ˜¾ç¤ºæ’ä»¶</span></span><br><span class="line">yum -y install libatk-bridge* libXss* libgtk*</span><br><span class="line">grafana-cli plugins install grafana-image-renderer</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹é…ç½®</span></span><br><span class="line">vim /etc/grafana/grafana.ini</span><br><span class="line">enabled = true</span><br><span class="line">host = smtp.163.com:25</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‘é€æŠ¥è­¦é‚®ä»¶çš„é‚®ç®±</span></span><br><span class="line">user = chenqiming13@163.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æˆæƒç </span></span><br><span class="line">password = QXQALYMTRYRWIOOS</span><br><span class="line">skip_verify = true</span><br><span class="line">from_address = chenqiming13@163.com</span><br><span class="line">from_name = Grafana</span><br><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºæŠ¥è­¦è§„åˆ™</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%80.png" alt="Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½ä¸€"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%8C.png" alt="Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½äºŒ"></p>
<ol start="3">
<li>é’ˆå¯¹å…·ä½“ç›‘æ§é¡¹ï¼Œè®¾ç½®å‘é€é‚®ä»¶é˜ˆå€¼ç­‰ï¼Œè¿™é‡Œè®¾ç½®ä¸ºå‘ç°è¶…è¿‡é˜ˆå€¼èµ·5åˆ†é’Ÿåè§¦å‘æŠ¥è­¦</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%89.png" alt="Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½ä¸‰"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%9B%9B.png" alt="Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½å››"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%94.png" alt="Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½äº”"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%85%AD.png" alt="Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½å…­"></p>
<p>![Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½ä¸ƒ](Grafanaå®ç°æŠ¥è­¦åŠŸèƒ½ä¸ƒ.png</p>
<h2 id="å…­ã€Prometheus-Grafanaå®é™…æ¡ˆä¾‹"><a href="#å…­ã€Prometheus-Grafanaå®é™…æ¡ˆä¾‹" class="headerlink" title="å…­ã€Prometheus + Grafanaå®é™…æ¡ˆä¾‹"></a>å…­ã€Prometheus + Grafanaå®é™…æ¡ˆä¾‹</h2><h3 id="6-1-predict-linearå‡½æ•°å®ç°ç¡¬ç›˜ç›‘æ§"><a href="#6-1-predict-linearå‡½æ•°å®ç°ç¡¬ç›˜ç›‘æ§" class="headerlink" title="6.1 predict_linearå‡½æ•°å®ç°ç¡¬ç›˜ç›‘æ§"></a>6.1 predict_linearå‡½æ•°å®ç°ç¡¬ç›˜ç›‘æ§</h3><p>ç¡¬ç›˜ä½¿ç”¨ç‡å…¬å¼ä¸ºï¼šï¼ˆï¼ˆæ€»å®¹é‡ - å‰©ä½™å®¹é‡ï¼‰&#x2F;  æ€»å®¹é‡ï¼‰* 100ï¼Œåœ¨Prometheusä¸­è¡¨ç¤ºä¸º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes) * 100</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡df -må¯ä»¥çœ‹å‡ºè®¡ç®—å‡ºæ¥çš„å€¼æ˜¯æ­£ç¡®çš„</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png" alt="è®¡ç®—ç¡¬ç›˜ä½¿ç”¨ç‡ä¸€"></p>
<p>Prometheusæä¾›äº†ä¸€ä¸ªpredict_linearå‡½æ•°å¯ä»¥é¢„è®¡å¤šé•¿æ—¶é—´ç£ç›˜çˆ†æ»¡ï¼Œä¾‹å¦‚å½“å‰è¿™1ä¸ªå°æ—¶çš„ç£ç›˜å¯ç”¨ç‡æ€¥å‰§ä¸‹é™ï¼Œè¿™ç§æƒ…å†µå¯èƒ½å¯¼è‡´ç£ç›˜å¾ˆå¿«è¢«å†™æ»¡ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°ï¼Œç”¨å½“å‰1å°æ—¶çš„æ•°æ®å»é¢„æµ‹æœªæ¥å‡ ä¸ªå°æ—¶çš„çŠ¶æ€ï¼Œå®ç°æå‰æŠ¥è­¦ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¯¥å¼å­è¡¨ç¤ºç”¨å½“å‰1å°æ—¶çš„å€¼æ¥é¢„æµ‹æœªæ¥4å°æ—¶åå¦‚æœæ ¹ç›®å½•ä¸‹å®¹é‡å°äº0åˆ™è§¦å‘æŠ¥è­¦</span></span><br><span class="line">predict_linear(node_filesystem_free_bytes &#123;mountpoint =&quot;/&quot;&#125;[1h], 4*3600) &lt; 0</span><br></pre></td></tr></table></figure>

<p>åœ¨Grafanaæ·»åŠ ç›‘æ§ç¡¬ç›˜ä½¿ç”¨ç‡å’Œé¢„æµ‹ç¡¬ç›˜ä½¿ç”¨ç‡çš„ä»ªè¡¨ç›˜</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png" alt="è®¡ç®—ç¡¬ç›˜ä½¿ç”¨ç‡äºŒ"></p>
<h3 id="6-2-ç›‘æ§ç¡¬ç›˜IO"><a href="#6-2-ç›‘æ§ç¡¬ç›˜IO" class="headerlink" title="6.2 ç›‘æ§ç¡¬ç›˜IO"></a>6.2 ç›‘æ§ç¡¬ç›˜IO</h3><p>å…¬å¼ä¸ºï¼šï¼ˆè¯»å–æ—¶é—´ &#x2F; å†™å…¥æ—¶é—´ï¼‰&#x2F; 1024 &#x2F; 1024ï¼Œç”¨rateå‡½æ•°å–ä¸€åˆ†é’Ÿå†…è¯»å’Œå†™çš„å­—èŠ‚å¢é•¿ç‡æ¥è®¡ç®—ï¼Œç”¨Prometheusè¡¨ç¤ºä¸º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((rate(node_disk_read_bytes_total[1m]) + rate(node_disk_written_bytes_total[1m])) / 1024 / 1024) &gt; 0</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7IO%E7%8A%B6%E6%80%81.png" alt="ç›‘æ§IOçŠ¶æ€"></p>
<h3 id="6-3-ç›‘æ§TCP-WAITçŠ¶æ€çš„æ•°é‡"><a href="#6-3-ç›‘æ§TCP-WAITçŠ¶æ€çš„æ•°é‡" class="headerlink" title="6.3 ç›‘æ§TCP_WAITçŠ¶æ€çš„æ•°é‡"></a>6.3 ç›‘æ§TCP_WAITçŠ¶æ€çš„æ•°é‡</h3><p>åœ¨è¢«ç›‘æ§ä¸»æœºä¸Šç¼–å†™ç›‘æ§è„šæœ¬</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–ç›‘æ§ä¸»æœºå</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœä¸»æœºåä¸ºlocalhostï¼Œåˆ™é€€å‡º</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;ä¸èƒ½ç›‘æ§ä¸»æœºåä¸ºlocalhostçš„ä¸»æœº&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–TCP WAITæ•°é‡</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŠ“å–TCP WAITæ•°é‡ï¼Œå®šä¹‰ä¸ºä¸€ä¸ªæ–°key</span></span><br><span class="line">lable_tcp_wait=&quot;count_netstat_wait_connections&quot;</span><br><span class="line">count_netstat_wait_connections=`netstat -an | grep &#x27;WAIT&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šä¼ è‡³pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_wait $count_netstat_wait_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-ç›‘æ§æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨ç‡"><a href="#6-4-ç›‘æ§æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨ç‡" class="headerlink" title="6.4 ç›‘æ§æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨ç‡"></a>6.4 ç›‘æ§æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨ç‡</h3><p>åœ¨linuxä¸­ï¼Œæ¯å½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ•´å‹æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨æ¥æ ‡è¯†è¿™ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªè¿›ç¨‹é»˜è®¤æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«ä¸ºæ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ï¼Œå³stdinã€stoutã€steerï¼Œç”¨æ–‡ä»¶æè¿°ç¬¦æ¥è¡¨ç¤ºä¸º0ã€1ã€2ã€‚</p>
<p>ç”¨å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç›®å‰ç³»ç»Ÿçš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼Œä¸€èˆ¬é»˜è®¤è®¾ç½®æ˜¯1024ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨ç‡å…¬å¼ä¸ºï¼šï¼ˆå·²åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ &#x2F; æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡ï¼‰* 100ï¼Œåœ¨Prometheusä¸­åˆ™è¡¨ç¤ºä¸º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_filefd_allocated / node_filefd_maximum) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%BD%BF%E7%94%A8%E7%8E%87.png" alt="ç›‘æ§æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨ç‡"></p>
<h3 id="6-5-ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡ç›‘æ§"><a href="#6-5-ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡ç›‘æ§" class="headerlink" title="6.5 ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡ç›‘æ§"></a>6.5 ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡ç›‘æ§</h3><p>å‰é¢æˆ‘ä»¬é‡‡ç”¨çš„éƒ½æ˜¯ç®€å•çš„ping + ipåœ°å€æ¥è¿›è¡Œæµ‹è¯•ï¼Œå®é™…ä¸Šè¿™æ ·æµ‹è¯•å‘å‡ºå»çš„icmpæ•°æ®åŒ…æ˜¯éå¸¸å°çš„ï¼Œåªé€‚åˆç”¨æ¥æµ‹è¯•ç½‘ç»œæ˜¯å¦è¿é€šï¼Œå› æ­¤ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¿›è¡Œä¼˜åŒ–ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ping -q ipåœ°å€ -s 500 -W 1000 -c 100</span><br><span class="line">-q:ä¸æ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ï¼Œå¼€å¤´å’Œç»“å°¾çš„ç›¸å…³ä¿¡æ¯é™¤å¤–ã€‚</span><br><span class="line">-s:è®¾ç½®æ•°æ®åŒ…çš„å¤§å°ã€‚</span><br><span class="line">-W:åœ¨ç­‰å¾… timeout ç§’åå¼€å§‹æ‰§è¡Œã€‚</span><br><span class="line">-c:è®¾ç½®å®Œæˆè¦æ±‚å›åº”çš„æ¬¡æ•°ã€‚</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E5%92%8C%E4%B8%A2%E5%8C%85%E7%8E%87%E7%9B%91%E6%8E%A7.png" alt="ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡ç›‘æ§"></p>
<h3 id="6-6-ä½¿ç”¨Pagedutyå®ç°æŠ¥è­¦"><a href="#6-6-ä½¿ç”¨Pagedutyå®ç°æŠ¥è­¦" class="headerlink" title="6.6 ä½¿ç”¨Pagedutyå®ç°æŠ¥è­¦"></a>6.6 ä½¿ç”¨Pagedutyå®ç°æŠ¥è­¦</h3><p>Pagerdutyæ˜¯ä¸€å¥—ä»˜è´¹ç›‘æ§æŠ¥è­¦ç³»ç»Ÿï¼Œç»å¸¸ä½œä¸ºSRE&#x2F;è¿ç»´äººå‘˜çš„ç›‘æ§æŠ¥è­¦å·¥å…·ï¼Œå¯ä»¥å’Œå¸‚é¢ä¸Šå¸¸è§çš„ç›‘æ§å·¥å…·ç›´æ¥æ•´åˆã€‚</p>
<ol>
<li>åˆ›å»ºæ–°service</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%80.png" alt="patedutyå®ç°æŠ¥è­¦ä¸€"><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%8C.png" alt="patedutyå®ç°æŠ¥è­¦äºŒ"></p>
<ol start="2">
<li>åœ¨Grafanaæ–°å»ºæŠ¥è­¦æ¸ é“ï¼Œå¹¶åœ¨ä»ªè¡¨ç›˜ä¸­è®¾ç½®ä¸ºPagedutyæŠ¥è­¦</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%89.png" alt="patedutyå®ç°æŠ¥è­¦ä¸‰"></p>
<ol start="3">
<li>è®¾ç½®æŠ¥è­¦ä¿¡æ¯</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%9B%9B.png" alt="patedutyå®ç°æŠ¥è­¦å››"></p>
<ol start="4">
<li>æŸ¥çœ‹æ˜¯å¦æ”¶åˆ°æŠ¥è­¦</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%94.png" alt="patedutyå®ç°æŠ¥è­¦äº”"></p>
<ol start="5">
<li>å½“é—®é¢˜è§£å†³å¯ä»¥ç‚¹å‡»å·²è§£å†³</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%85%AD.png" alt="patedutyå®ç°æŠ¥è­¦å…­"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:27:23.375Z" title="2/18/2024, 5:27:23 PM">2024-02-18</time></span><span class="level-item">40 minutes read (About 6006 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/ansible/">Ansible</a></p><div class="content"><h2 id="ä¸€ã€Ansibleç®€ä»‹"><a href="#ä¸€ã€Ansibleç®€ä»‹" class="headerlink" title="ä¸€ã€Ansibleç®€ä»‹"></a>ä¸€ã€Ansibleç®€ä»‹</h2><p>ansbileæ˜¯ä¸€ä¸ªITè‡ªåŠ¨åŒ–çš„é…ç½®ç®¡ç†å·¥å…·ï¼Œè‡ªåŠ¨åŒ–ä¸»è¦ä½“ç°åœ¨Ansibleé›†æˆäº†ä¸°å¯Œçš„æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªå‘½ä»¤å®Œæˆä¸€ç³»åˆ—çš„æ“ä½œï¼Œè¿›è€Œå‡å°‘è¿ç»´é‡å¤æ€§çš„å·¥ä½œå’Œç»´æŠ¤æˆæœ¬ï¼Œæé«˜å·¥ä½œæ•ˆç‡ã€‚</p>
<p><img src="/2024/02/18/ansible/ansible%E5%9B%BE%E6%A0%87.jpg" alt="ansibleå›¾æ ‡"></p>
<h3 id="1-1-ä¸ºä»€ä¹ˆéœ€è¦ansible"><a href="#1-1-ä¸ºä»€ä¹ˆéœ€è¦ansible" class="headerlink" title="1.1 ä¸ºä»€ä¹ˆéœ€è¦ansible"></a>1.1 ä¸ºä»€ä¹ˆéœ€è¦ansible</h3><p>æ€è€ƒï¼šå‡è®¾æˆ‘ä»¬è¦åœ¨10å°æœåŠ¡å™¨ä¸Šå®‰è£…å¹¶è¿è¡Œnginxï¼Œè¦å¦‚ä½•æ“ä½œï¼Ÿ</p>
<ol>
<li>sshè¿œç¨‹ç™»å½•åˆ°æœåŠ¡å™¨</li>
<li>æ‰§è¡Œyum -y install nginx</li>
<li>æ‰§è¡Œsystemctl start nginx</li>
<li>æ‰§è¡Œsystemctl enable nginx</li>
<li>é‡å¤åæ¬¡ã€‚ã€‚ã€‚</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ç®€å•çš„å·¥ä½œè¦åšåæ¬¡æ˜¯å¾ˆæµªè´¹æ—¶é—´çš„ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ansibleäº†ã€‚</p>
<h3 id="1-2-ansibleæœ‰å“ªäº›åŠŸèƒ½"><a href="#1-2-ansibleæœ‰å“ªäº›åŠŸèƒ½" class="headerlink" title="1.2 ansibleæœ‰å“ªäº›åŠŸèƒ½"></a>1.2 ansibleæœ‰å“ªäº›åŠŸèƒ½</h3><ol>
<li>æ‰¹é‡æ‰§è¡Œè¿œç¨‹å‘½ä»¤ï¼Œå¯ä»¥åŒæ—¶å¯¹Nå°ä¸»æœºæ‰§è¡Œå‘½ä»¤</li>
<li>æ‰¹é‡é…ç½®è½¯ä»¶æœåŠ¡ï¼Œå¯ä»¥ç”¨è‡ªåŠ¨åŒ–çš„æ–¹å¼é…ç½®å’Œç®¡ç†æœåŠ¡</li>
<li>å®ç°è½¯ä»¶å¼€å‘åŠŸèƒ½ï¼Œjumpserveråº•å±‚ä½¿ç”¨ansibleæ¥å®ç°è‡ªåŠ¨åŒ–ç®¡ç†</li>
<li>ç¼–æ’é«˜çº§çš„ITä»»åŠ¡ï¼Œplaybookæ˜¯ansbileçš„ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥ç”¨æ¥æç»˜ä¸€å¥—ITæ¶æ„</li>
</ol>
<p><img src="/2024/02/18/ansible/ansbile%E6%9E%B6%E6%9E%84.png" alt="ansbileæ¶æ„"></p>
<h2 id="äºŒã€Ansibleå®‰è£…"><a href="#äºŒã€Ansibleå®‰è£…" class="headerlink" title="äºŒã€Ansibleå®‰è£…"></a>äºŒã€Ansibleå®‰è£…</h2><h3 id="2-1-åœ¨æ§åˆ¶ç«¯ä¸Šå®‰è£…ansible"><a href="#2-1-åœ¨æ§åˆ¶ç«¯ä¸Šå®‰è£…ansible" class="headerlink" title="2.1 åœ¨æ§åˆ¶ç«¯ä¸Šå®‰è£…ansible"></a>2.1 åœ¨æ§åˆ¶ç«¯ä¸Šå®‰è£…ansible</h3><p>ç›´æ¥åˆ©ç”¨yumæºå®‰è£…å³å¯ï¼Œansibleé…ç½®æ–‡ä»¶ä¸€èˆ¬ä¸éœ€è¦åšå˜åŠ¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure>

<h3 id="2-2-ansibleé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§"><a href="#2-2-ansibleé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§" class="headerlink" title="2.2 ansibleé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§"></a>2.2 ansibleé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§</h3><ol>
<li>å¦‚æœå½“å‰ç›®å½•ä¸å­˜åœ¨ansible.cfgï¼Œä¼šé‡‡ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br><span class="line">...</span><br><span class="line">config file = /etc/ansible/ansible.cfg</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¦‚æœå½“å‰ç›®å½•å­˜åœ¨ansible.cfgï¼Œåˆ™ä¼šé‡‡ç”¨å½“å‰ç›®å½•çš„é…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br><span class="line">...</span><br><span class="line">config file = /root/project1/ansible.cfg</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="2-3-ansibleçš„Inventory"><a href="#2-3-ansibleçš„Inventory" class="headerlink" title="2.3 ansibleçš„Inventory"></a>2.3 ansibleçš„Inventory</h3><p>åˆ©ç”¨å¯†é’¥æ¥è¿æ¥è¢«æ§ç«¯</p>
<ol>
<li>åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»ºhostsæ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd project1</span><br><span class="line">vim hosts</span><br><span class="line">[cqm]</span><br><span class="line">192.168.88.133</span><br><span class="line">192.168.88.134</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºå¯†é’¥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ls /root/.ssh/</span><br><span class="line">authorized_keys id_rsa id_rsa.pub known_hosts</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å°†å…¬é’¥ä¼ é€è‡³è¢«æ§ç«¯ä¸»æœº</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.88.133</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.88.134</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æµ‹è¯•æ˜¯å¦ä¸éœ€è¦å¯†ç å°±å¯ä»¥è¿æ¥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.88.133</span><br><span class="line">ssh root@192.168.88.134</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€Ansibleçš„ad-hocå’Œå¸¸ç”¨æ¨¡å—"><a href="#ä¸‰ã€Ansibleçš„ad-hocå’Œå¸¸ç”¨æ¨¡å—" class="headerlink" title="ä¸‰ã€Ansibleçš„ad-hocå’Œå¸¸ç”¨æ¨¡å—"></a>ä¸‰ã€Ansibleçš„ad-hocå’Œå¸¸ç”¨æ¨¡å—</h2><h3 id="3-1-ansibleçš„ad-hoc"><a href="#3-1-ansibleçš„ad-hoc" class="headerlink" title="3.1 ansibleçš„ad-hoc"></a>3.1 ansibleçš„ad-hoc</h3><p><strong>ad-hocç®€è€Œè¨€ä¹‹å°±æ˜¯â€œä¸´æ—¶å‘½ä»¤â€ï¼Œæ‰§è¡Œå®Œå°±ç»“æŸï¼Œå¹¶ä¸ä¼šä¿å­˜</strong></p>
<p><strong>ä¸»è¦æ ¼å¼ä¸ºï¼šansible + -i + æŒ‡å®šä¸»æœºæ¸…å• + æŒ‡å®šä¸»æœºç»„åç§° + -m + æŒ‡å®šæ¨¡å— + -a + å…·ä½“å‘½ä»¤</strong></p>
<p>ä½¿ç”¨ad-hocåè¿”å›ç»“æœçš„é¢œè‰²ï¼š</p>
<ol>
<li>ç»¿è‰²ï¼šè¢«æ§ç«¯ä¸»æœºæ²¡æœ‰å‘ç”Ÿå˜åŒ–</li>
<li>é»„è‰²ï¼šè¢«æ§ç«¯ä¸»æœºå‘ç”Ÿäº†å˜åŒ–</li>
<li>çº¢è‰²ï¼šå‡ºç°æ•…éšœ</li>
</ol>
<h3 id="3-2-ansibleåŸºæœ¬å‘½ä»¤"><a href="#3-2-ansibleåŸºæœ¬å‘½ä»¤" class="headerlink" title="3.2 ansibleåŸºæœ¬å‘½ä»¤"></a>3.2 ansibleåŸºæœ¬å‘½ä»¤</h3><ol>
<li>ç›´æ¥æ‰§è¡Œå‘½ä»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts ä¸»æœºç»„å -m æ¨¡å— -a å‘½ä»¤</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ—å‡ºæŸä¸ªä¸»æœºç»„çš„ä¸»æœºæ¸…å•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts ä¸»æœºç»„å --list-hosts</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æŸ¥çœ‹æŸä¸ªæ¨¡å—ä½¿ç”¨æ•™ç¨‹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc æ¨¡å—åç§°</span><br><span class="line">/EX</span><br></pre></td></tr></table></figure>

<h3 id="3-2-shellå’Œcommandæ¨¡å—"><a href="#3-2-shellå’Œcommandæ¨¡å—" class="headerlink" title="3.2 shellå’Œcommandæ¨¡å—"></a>3.2 shellå’Œcommandæ¨¡å—</h3><p>shellå’Œcommandæœ¬è´¨ä¸Šéƒ½æ˜¯ç”¨æ¥æ‰§è¡Œlinuxçš„åŸºç¡€å‘½ä»¤ï¼Œå¦‚catã€lsç­‰ç­‰ï¼Œä½†commandä¸æ”¯æŒç”¨|è¿™ç§ç®¡é“ç¬¦å‘½ä»¤</p>
<p>ä¾‹å­ï¼ŒåŒæ ·çš„å‘½ä»¤åœ¨commandä¸Šä¼šæŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m shell -a &#x27;ps -ef | grep nginx&#x27;</span><br><span class="line">ansible -i hosts cqm -m command -a &#x27;ps -ef | grep nginx&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/ansible/shell%E5%92%8Ccommand.png" alt="shellå’Œcommand"></p>
<h3 id="3-3-yumæ¨¡å—"><a href="#3-3-yumæ¨¡å—" class="headerlink" title="3.3 yumæ¨¡å—"></a>3.3 yumæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m yum -a &#x27;name=httpd state=latest enablerepo=epel&#x27;</span><br><span class="line">name:æŒ‡å®šå®‰è£…è½¯ä»¶åç§°</span><br><span class="line">state:</span><br><span class="line">	1.latestä¸ºå®‰è£…æœ€æ–°ç‰ˆæœ¬</span><br><span class="line">	2.absentä¸ºå¸è½½</span><br><span class="line">	3.presentä¸ºå®‰è£…</span><br><span class="line">enablerepo:æŒ‡å®šåœ¨å“ªä¸ªyumæºä¸‹å®‰è£…</span><br></pre></td></tr></table></figure>

<h3 id="3-4-copyæ¨¡å—"><a href="#3-4-copyæ¨¡å—" class="headerlink" title="3.4 copyæ¨¡å—"></a>3.4 copyæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m copy -a &#x27;src=./httpd.conf dest=/etc/httpd/conf/httpd.conf owner=www group=www mode=0755&#x27;</span><br><span class="line">src:è¡¨ç¤ºè¦å¤åˆ¶çš„æ–‡ä»¶è·¯å¾„</span><br><span class="line">dest:è¦å¤åˆ¶åˆ°è¢«æ§ç«¯çš„å“ªä¸ªè·¯å¾„</span><br><span class="line">owner:å¤åˆ¶æ–‡ä»¶çš„å±ä¸»</span><br><span class="line">group:å¤åˆ¶æ–‡ä»¶çš„å±ç»„</span><br><span class="line">mode:æ–‡ä»¶çš„æƒé™ï¼Œ0755ä¸ºrwxr-xr-x(r:4,w:2,x:1)ï¼Œä¹Ÿå¯ä»¥å†™æˆ(u+rwx,g+x,o-rwx)çš„å½¢å¼</span><br><span class="line">backup:å¦‚æœè¢«æ§ç«¯æœ‰åŒåæ–‡ä»¶ï¼Œæ˜¯å¦ä¿ç•™</span><br></pre></td></tr></table></figure>

<h3 id="3-5-fileæ¨¡å—"><a href="#3-5-fileæ¨¡å—" class="headerlink" title="3.5 fileæ¨¡å—"></a>3.5 fileæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ›´æ”¹æ–‡ä»¶æƒé™</span></span><br><span class="line">ansible -i hosts cqm -m file -a &#x27;path=/etc/nginx/nginx.conf owner=www group=www mode=0644&#x27;</span><br><span class="line">path:ä»£è¡¨è¦æ”¹å˜æ–‡ä»¶çš„è·¯å¾„(è¢«æ§ç«¯)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ›å»ºç¬¦å·è¿æ¥(è½¯è¿æ¥)</span></span><br><span class="line">ansible -i hosts cqm -m file -a &#x27;src=/root/test1 dest=/root/test2 mode=0755 state=link&#x27;</span><br><span class="line">src:æºæ–‡ä»¶è·¯å¾„(è¢«æ§ç«¯)</span><br><span class="line">dest:è½¯è¿æ¥è·¯å¾„(è¢«æ§ç«¯)</span><br><span class="line">state:linkåˆ›å»ºè½¯è¿æ¥</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åˆ›å»ºæ–‡ä»¶å’Œæ–‡ä»¶å¤¹</span></span><br><span class="line">ansible -i hosts cqm -m file -a &#x27;path=/root/text state=touch/directory mode=0644 recurse=yes&#x27;</span><br><span class="line">path:è¦åˆ›å»ºåœ¨å“ª</span><br><span class="line">state:</span><br><span class="line">	1.touchè¡¨åˆ›å»ºæ–‡ä»¶</span><br><span class="line">	2.directoryè¡¨åˆ›å»ºæ–‡ä»¶å¤¹</span><br><span class="line">	3.absentè¡¨åˆ é™¤</span><br><span class="line">recurse: é€’å½’æˆæƒ</span><br></pre></td></tr></table></figure>

<h3 id="3-6-serviceæ¨¡å—"><a href="#3-6-serviceæ¨¡å—" class="headerlink" title="3.6 serviceæ¨¡å—"></a>3.6 serviceæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m service -a &#x27;name=httpd state=started enabled=yes&#x27;</span><br><span class="line">name:æœåŠ¡åç§°</span><br><span class="line">state:</span><br><span class="line">	1.startedå¯åŠ¨</span><br><span class="line">	2.stoppedå…³é—­</span><br><span class="line">	3.restartedé‡å¯</span><br><span class="line">	4.reloadedé‡è½½</span><br><span class="line">enabled:æ˜¯å¦å¼€æœºè‡ªå¯</span><br></pre></td></tr></table></figure>

<h3 id="3-7-groupæ¨¡å—"><a href="#3-7-groupæ¨¡å—" class="headerlink" title="3.7 groupæ¨¡å—"></a>3.7 groupæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m group -a &#x27;name=cqm state=present gid=1000 system=yes/no&#x27;</span><br><span class="line">name:åˆ›å»ºç»„åç§°</span><br><span class="line">state:</span><br><span class="line">	1.presentåˆ›å»ºç»„</span><br><span class="line">	2.absentåˆ é™¤ç»„</span><br><span class="line">gid:ç»„id</span><br><span class="line">system:æ˜¯å¦è®¾ç½®ä¸ºç³»ç»Ÿç»„</span><br></pre></td></tr></table></figure>

<h3 id="3-8-useræ¨¡å—"><a href="#3-8-useræ¨¡å—" class="headerlink" title="3.8 useræ¨¡å—"></a>3.8 useræ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m user -a &#x27;name=cqm uid=1000 group=cqm shell=/bin/bash state=present create_home=no&#x27;</span><br><span class="line">name:åˆ›å»ºç”¨æˆ·åç§°</span><br><span class="line">uid:ç”¨æˆ·id</span><br><span class="line">group:æ·»åŠ åˆ°å“ªä¸ªç»„</span><br><span class="line">shell:ä½¿ç”¨/bin/bashåˆ›å»ºç”¨æˆ·ï¼Œæˆ–/sbin/nologin</span><br><span class="line">state:</span><br><span class="line">	1.presentåˆ›å»ºç”¨æˆ·</span><br><span class="line">	2.absentåˆ é™¤ç”¨æˆ·</span><br><span class="line">create_home:æ˜¯å¦åˆ›å»ºå®¶ç›®å½•ï¼Œé»˜è®¤ä¸ºyes</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m user -a &#x27;name=cqm uid=1000 groups=cqm1,cqm2 append=yes state=present system:yes&#x27;</span><br><span class="line">groups:æ·»åŠ åˆ°å“ªäº›ç»„</span><br><span class="line">append:æ·»åŠ åˆ°å¤šä¸ªç»„æ—¶æ·»åŠ è¯¥é¡¹</span><br><span class="line">system:æ˜¯å¦è®¾ç½®ä¸ºç³»ç»Ÿç”¨æˆ·</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m user -a &#x27;name=cqm state=absent remove=yes&#x27;</span><br><span class="line">remove:æ˜¯å¦åˆ é™¤å®¶ç›®å½•</span><br></pre></td></tr></table></figure>

<h3 id="3-9-cronæ¨¡å—"><a href="#3-9-cronæ¨¡å—" class="headerlink" title="3.9 cronæ¨¡å—"></a>3.9 cronæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m cron -a &#x27;name=&quot;check dirs&quot; minute=0 hour=5,2 job=&quot;ls -al &gt; /dev/null&quot;&#x27;</span><br><span class="line">name:åˆ›å»ºå®šæ—¶ä»»åŠ¡åç§°</span><br><span class="line">minute:åˆ†é’Ÿ</span><br><span class="line">hour:å°æ—¶</span><br><span class="line">job:ä»»åŠ¡</span><br><span class="line">state:åˆ é™¤å®šæ—¶ä»»åŠ¡ç”¨absent</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åœ¨è¢«æ§ç«¯å¯æŸ¥çœ‹</span></span><br><span class="line">crontab -l</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Ansible: check <span class="built_in">dirs</span></span></span><br><span class="line">0 5,2 * * * ls -al &gt; /dev/null</span><br></pre></td></tr></table></figure>

<h3 id="3-10-mountæ¨¡å—"><a href="#3-10-mountæ¨¡å—" class="headerlink" title="3.10 mountæ¨¡å—"></a>3.10 mountæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m mount -a &#x27;path=/root/data src=/dev/sr0 fstype=iso9660 opts=&quot;ro&quot; state=present&#x27;</span><br><span class="line">path:æŒ‚è½½åˆ°å“ª</span><br><span class="line">src:è¢«æŒ‚è½½çš„ç›®å½•ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å½¢å¼</span><br><span class="line">	1.UUIDå½¢å¼:src=&quot;UUID=......&quot;</span><br><span class="line">	2.ipå½¢å¼:src=&quot;192.168.88.128:/data&quot;ï¼Œä¸€èˆ¬ç”¨äºæŒ‚è½½nfsæœåŠ¡å™¨çš„ç›®å½•</span><br><span class="line">fstype:æŒ‚è½½ç±»å‹</span><br><span class="line">	1.iso9660:æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªæ ‡å‡†CD-ROMæ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">	2.ext4:Linuxç³»ç»Ÿä¸‹çš„æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">	3.xfs:é«˜æ€§èƒ½çš„æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">	4.none</span><br><span class="line">state:æŒ‚è½½ç±»å‹</span><br><span class="line">	1.present:å¼€æœºæŒ‚è½½ï¼Œä»…å°†æŒ‚è½½é…ç½®å†™å…¥/etc/fstab</span><br><span class="line">	2.mounted:æŒ‚è½½è®¾å¤‡ï¼Œå¹¶å°†é…ç½®å†™å…¥/etc/fstab</span><br><span class="line">	3.unmounted:å¸è½½è®¾å¤‡ï¼Œä¸ä¼šæ¸…é™¤/etc/fstabå†™å…¥çš„é…ç½®</span><br><span class="line">	4.absent:å¸è½½è®¾å¤‡ï¼Œä¼šæ¸…ç†/etc/fstabå†™å…¥çš„é…ç½®</span><br><span class="line">opts:æƒé™ç­‰ï¼Œé»˜è®¤å¡«defaults</span><br><span class="line">/etc/fstab:ç£ç›˜è¢«æ‰‹åŠ¨æŒ‚è½½ä¹‹åéƒ½å¿…é¡»æŠŠæŒ‚è½½ä¿¡æ¯å†™å…¥/etc/fstabè¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå¦åˆ™ä¸‹æ¬¡å¼€æœºå¯åŠ¨æ—¶ä»ç„¶éœ€è¦é‡æ–°æŒ‚è½½ã€‚</span><br></pre></td></tr></table></figure>

<h3 id="3-11-firewalldæ¨¡å—"><a href="#3-11-firewalldæ¨¡å—" class="headerlink" title="3.11 firewalldæ¨¡å—"></a>3.11 firewalldæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m firewalld -a &#x27;service=https permanent=yes enable=yes immediate=yes state=enabled&#x27;</span><br><span class="line">service:æ”¾è¡ŒæœåŠ¡</span><br><span class="line">port:æ”¾è¡Œç«¯å£ï¼Œå¦‚80/tcp</span><br><span class="line">source:æ”¾è¡ŒæŒ‡å®šipåœ°å€èŒƒå›´ï¼Œå¦‚192.168.88.0/24</span><br><span class="line">state:è¡¨é˜²ç«å¢™ç­–ç•¥çŠ¶æ€</span><br><span class="line">	1.enabledç­–ç•¥ç”Ÿæ•ˆ</span><br><span class="line">	2.disabledç¦ç”¨ç­–ç•¥</span><br><span class="line">	3.presentæ·»åŠ ç­–ç•¥</span><br><span class="line">	4.absentåˆ é™¤ç­–ç•¥</span><br><span class="line">zone:æŒ‡å®šé˜²ç«å¢™ä¿¡ä»»çº§åˆ«</span><br><span class="line">	1.drop:ä¸¢å¼ƒæ‰€æœ‰è¿›å…¥çš„åŒ…ï¼Œè€Œä¸ç»™å‡ºä»»ä½•å“åº”</span><br><span class="line">	2.block:æ‹’ç»æ‰€æœ‰å¤–éƒ¨å‘èµ·çš„è¿æ¥ï¼Œå…è®¸å†…éƒ¨å‘èµ·çš„è¿æ¥</span><br><span class="line">	3.public:å…è®¸æŒ‡å®šçš„è¿›å…¥è¿æ¥</span><br><span class="line">	4.internal:èŒƒå›´é’ˆå¯¹æ‰€æœ‰äº’è”ç½‘ç”¨æˆ·</span><br><span class="line">permanent:yesä¸ºæ°¸ä¹…ç”Ÿæ•ˆ</span><br><span class="line">immediate:yesä¸ºç«‹å³ç”Ÿæ•ˆ</span><br></pre></td></tr></table></figure>

<h3 id="3-12-unarchiveæ¨¡å—"><a href="#3-12-unarchiveæ¨¡å—" class="headerlink" title="3.12 unarchiveæ¨¡å—"></a>3.12 unarchiveæ¨¡å—</h3><p>unarchiveæ¨¡å—èƒ½å¤Ÿå®ç°è§£å‹å†æ‹·è´çš„åŠŸèƒ½</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m unarchive -a &#x27;src=./apache.tar.gz dest=/etc/httpd mode=0755 owner=www group=www&#x27;</span><br><span class="line">src:å‹ç¼©æ–‡ä»¶è·¯å¾„</span><br><span class="line">dest:è§£å‹åˆ°å“ª</span><br><span class="line">remote_src:è®¾ç½®ä¸ºyesæ—¶è¡¨ç¤ºå‹ç¼©åŒ…å·²ç»åœ¨è¢«æ§ç«¯ä¸»æœºä¸Šï¼Œè€Œä¸æ˜¯ansibleæ§åˆ¶ç«¯æœ¬åœ°</span><br></pre></td></tr></table></figure>

<h3 id="3-13-get-urlæ¨¡å—"><a href="#3-13-get-urlæ¨¡å—" class="headerlink" title="3.13 get_urlæ¨¡å—"></a>3.13 get_urlæ¨¡å—</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">url:ä¸‹è½½é“¾æ¥</span><br><span class="line">dest:ä¿å­˜æ–‡ä»¶åœ°å€</span><br><span class="line">mode:è®¾ç½®æƒé™</span><br></pre></td></tr></table></figure>

<h3 id="3-14-templateæ¨¡å—"><a href="#3-14-templateæ¨¡å—" class="headerlink" title="3.14 templateæ¨¡å—"></a>3.14 templateæ¨¡å—</h3><p>templateä¸copyç”¨æ³•ç›¸åŒï¼Œä½†templateå¯ä»¥å®åˆ«å˜é‡ï¼Œè€Œcopyä¸è¡Œã€‚</p>
<h3 id="3-15-yum-repositoryæ¨¡å—"><a href="#3-15-yum-repositoryæ¨¡å—" class="headerlink" title="3.15 yum_repositoryæ¨¡å—"></a>3.15 yum_repositoryæ¨¡å—</h3><p>yum_repositoryå¯ä»¥ç”¨æ¥é…ç½®yumæº</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">  <span class="attr">yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/7/$basearch/</span></span><br><span class="line">    <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="string">name:ç›¸å½“äº.repoæ–‡ä»¶ä¸­æ‹¬å·çš„[ä»“åº“å]</span></span><br><span class="line"><span class="string">description:ç›¸å½“äº.repoæ–‡ä»¶ä¸­çš„name</span></span><br><span class="line"><span class="string">file:ç›¸å½“äº.repoæ–‡ä»¶çš„åç§°</span></span><br><span class="line"><span class="string">baseurl:ç›¸å½“äº.repoæ–‡ä»¶ä¸­baseurl</span></span><br><span class="line"><span class="string">gpgcheck:ç›¸å½“äº.repoæ–‡ä»¶ä¸­gpgcheck</span></span><br><span class="line"><span class="string">enabled:ç›¸å½“äº.repoæ–‡ä»¶ä¸­enabled</span></span><br></pre></td></tr></table></figure>

<h2 id="å››ã€Ansibleçš„Playbook"><a href="#å››ã€Ansibleçš„Playbook" class="headerlink" title="å››ã€Ansibleçš„Playbook"></a>å››ã€Ansibleçš„Playbook</h2><p>playbookæ˜¯ansibleçš„å¦ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œè¢«ç§°ä¸ºâ€œå‰§æœ¬â€ï¼Œä¸ad-hocä¸åŒçš„æ˜¯ï¼Œplaybookå¯ä»¥å®ç°æŒä¹…ä½¿ç”¨ã€‚</p>
<p>playbookæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªplayç»„æˆçš„åˆ—è¡¨ï¼Œplayçš„ä¸»è¦åŠŸèƒ½åœ¨äºå°†äº‹å…ˆå½’å¹¶ä¸ºä¸€ç»„çš„ä¸»æœºè£…æ‰®æˆäº‹å…ˆé€šè¿‡ansibleä¸­çš„taskå®šä¹‰å¥½çš„è§’è‰²ï¼Œä»æ ¹æœ¬ä¸Šæ¥è®²ï¼Œæ‰€è°“çš„taskæ— éå°±æ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmoduleï¼Œå°†å¤šä¸ªplayç»„ç»‡åœ¨ä¸€ä¸ªplaybookä¸­ï¼Œå³å¯å®ç°åŒæ—¶å®Œæˆå¤šé¡¹ä»»åŠ¡ã€‚</p>
<p><strong>playbookçš„æ ¸å¿ƒå…ƒç´ </strong></p>
<ol>
<li>hostsï¼šè¢«æ§ä¸»æœºæ¸…å•</li>
<li>tasksï¼šä»»åŠ¡é›†</li>
<li>varsï¼šå˜é‡</li>
<li>templatesï¼šæ¨¡æ¿</li>
<li>handlerså’Œnotifyï¼šè§¦å‘å™¨</li>
<li>tagsï¼šæ ‡ç­¾</li>
</ol>
<h3 id="4-1-åˆ©ç”¨playbookå®‰è£…apache"><a href="#4-1-åˆ©ç”¨playbookå®‰è£…apache" class="headerlink" title="4.1 åˆ©ç”¨playbookå®‰è£…apache"></a>4.1 åˆ©ç”¨playbookå®‰è£…apache</h3><p>playbooké‡‡ç”¨çš„æ˜¯ymlè¯­æ³•ï¼Œä¸¾ä¸ªæ —å­</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/project1</span><br><span class="line">vim httpd.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">#å®‰è£…apacheæœåŠ¡</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#åˆ›å»ºwwwç»„</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">www</span> <span class="string">Group</span></span><br><span class="line">      <span class="attr">group:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#åˆ›å»ºwwwç”¨æˆ·</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">www</span> <span class="string">User</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#ä¿®æ”¹apacheé…ç½®æ–‡ä»¶</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Httpd</span> <span class="string">Conf</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./httpd.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#å¯åŠ¨æœåŠ¡å¹¶è®¾ä¸ºå¼€æœºè‡ªå¯</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#æ”¾è¡Œç«¯å£</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Firewall</span></span><br><span class="line">      <span class="attr">firewalld:</span></span><br><span class="line">        <span class="attr">zone:</span> <span class="string">public</span></span><br><span class="line">        <span class="attr">ports:</span> <span class="number">8080</span><span class="string">/tcp</span></span><br><span class="line">        <span class="attr">permanent:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">enabled</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ£€æŸ¥è¯­æ³•</span></span><br><span class="line">ansible-playbook --syntax -i hosts httpd.yml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ‰§è¡Œplaybook</span></span><br><span class="line">ansible-playbook -i hosts httpd.yml</span><br></pre></td></tr></table></figure>

<h3 id="4-2-åˆ©ç”¨playbookéƒ¨ç½²nfs"><a href="#4-2-åˆ©ç”¨playbookéƒ¨ç½²nfs" class="headerlink" title="4.2 åˆ©ç”¨playbookéƒ¨ç½²nfs"></a>4.2 åˆ©ç”¨playbookéƒ¨ç½²nfs</h3><ol>
<li>å‡†å¤‡å¥½nfsé…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /root/project1</span><br><span class="line">cat exports</span><br><span class="line">/root/nfs_data 192.168.88.0/24(rw,no_root_squash)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™nfs.ymlæ–‡ä»¶</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nfsä¸»æœº</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.133</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/nfs_data</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0744</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">recurse:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">NFS</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./exports</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/exports</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Stop</span> <span class="string">Firewall</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">firewalld</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">stopped</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŒ‚è½½nfsç›®å½•çš„ä¸»æœº</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.134</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/nfs_data</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Mount</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">mount:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/nfs_data</span></span><br><span class="line">        <span class="attr">src:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.133</span><span class="string">:/root/nfs_data</span></span><br><span class="line">        <span class="attr">fstype:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">opts:</span> <span class="string">defaults</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">mounted</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æ‰§è¡Œplaybook</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts nfs.yml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/ansible/nfs%E6%8C%82%E8%BD%BD.png" alt="nfsæŒ‚è½½"></p>
<h2 id="äº”ã€Ansibleçš„å˜é‡"><a href="#äº”ã€Ansibleçš„å˜é‡" class="headerlink" title="äº”ã€Ansibleçš„å˜é‡"></a>äº”ã€Ansibleçš„å˜é‡</h2><h3 id="5-1-åœ¨playä¸­è®¾ç½®å˜é‡"><a href="#5-1-åœ¨playä¸­è®¾ç½®å˜é‡" class="headerlink" title="5.1 åœ¨playä¸­è®¾ç½®å˜é‡"></a>5.1 åœ¨playä¸­è®¾ç½®å˜é‡</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web_package:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ftp_package:</span> <span class="string">vsftpd</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> &#123;&#123; <span class="string">web_package</span> &#125;&#125; <span class="string">and</span> &#123;&#123; <span class="string">ftp_package</span> &#125;&#125; <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ftp_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-åœ¨vars-fileä¸­è®¾ç½®å˜é‡"><a href="#5-2-åœ¨vars-fileä¸­è®¾ç½®å˜é‡" class="headerlink" title="5.2 åœ¨vars_fileä¸­è®¾ç½®å˜é‡"></a>5.2 åœ¨vars_fileä¸­è®¾ç½®å˜é‡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat vars.yml</span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">vars_files:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">./vars.yml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> &#123;&#123; <span class="string">web_package</span> &#125;&#125; <span class="string">and</span> &#123;&#123; <span class="string">ftp_package</span> &#125;&#125; <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ftp_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-é€šè¿‡inventoryä¸»æœºæ¸…å•è®¾ç½®å˜é‡"><a href="#5-3-é€šè¿‡inventoryä¸»æœºæ¸…å•è®¾ç½®å˜é‡" class="headerlink" title="5.3 é€šè¿‡inventoryä¸»æœºæ¸…å•è®¾ç½®å˜é‡"></a>5.3 é€šè¿‡inventoryä¸»æœºæ¸…å•è®¾ç½®å˜é‡</h3><ol>
<li>åˆ›å»ºä¸¤ä¸ªå˜é‡ç›®å½•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir hosts_vars</span><br><span class="line">mkdir groups_vars</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨groups_varsç›®å½•ä¸­é’ˆå¯¹æŸä¸ªç»„åˆ›å»ºå˜é‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat group_vars/cqm</span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">groups_varsç›®å½•ä¸­ä¹Ÿå¯ä»¥æ–°å»ºallæ¥è®¾ç½®å˜é‡ï¼Œè¿™æ ·æ‰€æœ‰çš„ä¸»æœºç»„éƒ½å¯ä»¥è°ƒç”¨</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åœ¨hosts_varsç›®å½•ä¸­é’ˆå¯¹æŸä¸ªä¸»æœºåˆ›å»ºå˜é‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat hosts_vars/192.168.88.133</span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br></pre></td></tr></table></figure>

<h3 id="5-4-åœ¨æ‰§è¡Œplaybookæ—¶é€šè¿‡-e-å‚æ•°è®¾ç½®å˜é‡"><a href="#5-4-åœ¨æ‰§è¡Œplaybookæ—¶é€šè¿‡-e-å‚æ•°è®¾ç½®å˜é‡" class="headerlink" title="5.4 åœ¨æ‰§è¡Œplaybookæ—¶é€šè¿‡ -e å‚æ•°è®¾ç½®å˜é‡"></a>5.4 åœ¨æ‰§è¡Œplaybookæ—¶é€šè¿‡ -e å‚æ•°è®¾ç½®å˜é‡</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> &#123;&#123; <span class="string">web_package</span> &#125;&#125; <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts -e &#x27;web_package=httpd&#x27; test.yml</span><br></pre></td></tr></table></figure>

<h3 id="5-5-ansibleå˜é‡çš„ä¼˜å…ˆçº§"><a href="#5-5-ansibleå˜é‡çš„ä¼˜å…ˆçº§" class="headerlink" title="5.5 ansibleå˜é‡çš„ä¼˜å…ˆçº§"></a>5.5 ansibleå˜é‡çš„ä¼˜å…ˆçº§</h3><p>ä¼˜å…ˆçº§ç”±ä¸Šè‡³ä¸‹é€’å‡</p>
<ol>
<li>-eï¼ˆå¤–ç½®ä¼ å‚ï¼‰</li>
<li>vars_files</li>
<li>playä¸­çš„vars</li>
<li>hosts_vars</li>
<li>groups_varsä¸­çš„æŸä¸ªä¸»æœºç»„</li>
<li>groups_varsä¸­çš„all</li>
</ol>
<h3 id="5-6-registeræ³¨å†Œå˜é‡"><a href="#5-6-registeræ³¨å†Œå˜é‡" class="headerlink" title="5.6 registeræ³¨å†Œå˜é‡"></a>5.6 registeræ³¨å†Œå˜é‡</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Apache</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Apache</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Apache</span> <span class="string">Process</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">ps</span> <span class="string">-ef</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">httpd</span></span><br><span class="line">      <span class="comment">#å°†ç»“æœå‚¨å­˜åˆ°å˜é‡é‡Œ</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_apache</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#åˆ©ç”¨debugæ¨¡å—è°ƒç”¨</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Output</span> <span class="string">check_apache</span></span><br><span class="line">      <span class="attr">debug:</span> </span><br><span class="line">        <span class="comment">#è¾“å‡ºmsgä¸­çš„stdout_lines</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; check_apache.stdout_lines &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-7-factså˜é‡"><a href="#5-7-factså˜é‡" class="headerlink" title="5.7 factså˜é‡"></a>5.7 factså˜é‡</h3><p>factså˜é‡æ˜¯ansibleæ§åˆ¶ç«¯é‡‡é›†è¢«æ§ç«¯çš„å˜é‡ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨</p>
<p>ä¸ºäº†æ–¹ä¾¿å¯ä»¥å°†factså˜é‡å†™åˆ°æ–‡æœ¬é‡Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m setup &gt; fasts.txt</span><br></pre></td></tr></table></figure>

<h2 id="å…­ã€Ansibleè¯­å¥"><a href="#å…­ã€Ansibleè¯­å¥" class="headerlink" title="å…­ã€Ansibleè¯­å¥"></a>å…­ã€Ansibleè¯­å¥</h2><h3 id="6-1-æ¡ä»¶åˆ¤æ–­when"><a href="#6-1-æ¡ä»¶åˆ¤æ–­when" class="headerlink" title="6.1 æ¡ä»¶åˆ¤æ–­when"></a>6.1 æ¡ä»¶åˆ¤æ–­when</h3><p>centoså®‰è£…apacheæ˜¯httpdï¼Œè€Œubuntuå®‰è£…apacheåˆ™æ˜¯httpd2ï¼Œæ‰€ä»¥è¿™æ—¶å€™å°±éœ€è¦æ¡ä»¶åˆ¤æ–­äº†</p>
<p><strong>ä¾‹ä¸€ï¼šä¸åŒç³»ç»Ÿå®‰è£…apache</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="string">tasks</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Centos</span> <span class="string">Install</span> <span class="string">Apache</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span> <span class="string">)</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Utunbu</span> <span class="string">Install</span> <span class="string">Apache2</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd2</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;Utunbu&quot;</span> <span class="string">)</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¾‹äºŒï¼šç»™ä¸»æœºåå¸¦æœ‰webçš„ä¸»æœºé…ç½®yumæº</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Cqm</span> <span class="string">Yum</span> <span class="string">Repo</span></span><br><span class="line">      <span class="attr">yum_repository:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">cqm</span> <span class="string">yum</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">baseurl:</span> <span class="string">http://www.cqmmmmm.com</span></span><br><span class="line">        <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">ansible_fqdn</span> <span class="string">is</span> <span class="string">match</span> <span class="string">(&quot;web*&quot;)</span> <span class="string">)</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¾‹ä¸‰ï¼šåˆ¤æ–­nfsæœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œæ²¡æœ‰åˆ™å¯åŠ¨ï¼Œå¦åˆ™é‡å¯</strong></p>
<p>åˆ©ç”¨echo $ï¼Ÿçš„è¿”å›å€¼æ¥æŸ¥çœ‹æ˜¯å¦å¯åŠ¨</p>
<p><img src="/2024/02/18/ansible/when%E5%88%A4%E6%96%AD%E4%B8%80.png" alt="whenåˆ¤æ–­ä¸€"></p>
<p><img src="/2024/02/18/ansible/when%E5%88%A4%E6%96%AD%E4%BA%8C.png" alt="whenåˆ¤æ–­äºŒ"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">NFS</span> <span class="string">Service</span> <span class="string">Status</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">is-active</span> <span class="string">nfs</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_nfs</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">check_nfs.rc</span> <span class="string">==</span> <span class="number">0</span> <span class="string">)</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-å¾ªç¯è¯­å¥with-items"><a href="#6-2-å¾ªç¯è¯­å¥with-items" class="headerlink" title="6.2 å¾ªç¯è¯­å¥with_items"></a>6.2 å¾ªç¯è¯­å¥with_items</h3><p>with_itemså¯ä»¥å®ç°å¾ªç¯ï¼Œå¯ä»¥å‡å°‘playbookä¸­åŒæ ·æ¨¡å—çš„ä½¿ç”¨æ¬¡æ•°</p>
<p><strong>ä¾‹ä¸€ï¼šåˆ©ç”¨with_itemsé‡å¯nginxå’ŒphpæœåŠ¡</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¾‹äºŒï¼šåˆ©ç”¨å˜é‡å¾ªç¯å®‰è£…å¤šä¸ªæœåŠ¡</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">Mysql</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">pack</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">pack:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mysql-server</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¾‹ä¸‰ï¼šåˆ©ç”¨å¾ªç¯åˆ›å»ºå¤šä¸ªç”¨æˆ·</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Multiple</span> <span class="string">Users</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item.name</span> &#125;&#125;</span><br><span class="line">        <span class="attr">group:</span> &#123;&#123; <span class="string">item.group</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;aaa&#x27;</span>, <span class="attr">group:</span> <span class="string">&#x27;aaa&#x27;</span> &#125;</span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;bbb&#x27;</span>, <span class="attr">group:</span> <span class="string">&#x27;bbb&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-è§¦å‘å™¨handlers"><a href="#6-3-è§¦å‘å™¨handlers" class="headerlink" title="6.3 è§¦å‘å™¨handlers"></a>6.3 è§¦å‘å™¨handlers</h3><p>handlersæ˜¯ansibleçš„è§¦å‘å™¨ï¼Œé…åˆnotifyä½¿ç”¨ã€‚</p>
<p>handlersåªæœ‰åœ¨playbookæ‰§è¡Œåˆ°æœ€åæ‰ä¼šæ‰§è¡Œï¼Œç®€å•æ¥è¯´å¯ä»¥å°†handlersçœ‹ä½œä¸€ä¸ªç‰¹æ®Šçš„tasksï¼Œåªæœ‰åœ¨notifyæŒ‡å®šçš„æŸä¸ªæ¨¡å—è¿è¡Œäº†æ‰ä¼šè§¦å‘handlersä¸­çš„æ¨¡å—ã€‚</p>
<p><strong>ä¾‹ä¸€ï¼šä¿®æ”¹nginx.confçš„è¯å°±é‡å¯nginxæœåŠ¡</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-tagsæ ‡ç­¾"><a href="#6-4-tagsæ ‡ç­¾" class="headerlink" title="6.4 tagsæ ‡ç­¾"></a>6.4 tagsæ ‡ç­¾</h3><p>å¯¹tasksæŒ‡å®šæ ‡ç­¾ï¼Œå¯ä»¥åœ¨æ‰§è¡Œplaybookçš„æ—¶å€™æŒ‡å®šæ‰§è¡Œå“ªä¸ªtagsçš„ä»»åŠ¡ã€‚</p>
<p><strong>ä¾‹ä¸€ï¼šåˆ©ç”¨tagsæ¥æ‰§è¡Œå¼€å¯nginxå’ŒphpæœåŠ¡</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">php-fpm</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">start_services</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts cqm -t &#x27;start_services&#x27; test.yml</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦æŒ‡å®šä¸æ‰§è¡Œå“ªä¸ªæ ‡ç­¾çš„ä»»åŠ¡ï¼Œæ·»åŠ å‚æ•°â€“skip-tags</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts cqm --skip-tags &#x27;start_services&#x27; test.yml</span><br></pre></td></tr></table></figure>

<h3 id="6-5-åŒ…å«include"><a href="#6-5-åŒ…å«include" class="headerlink" title="6.5 åŒ…å«include"></a>6.5 åŒ…å«include</h3><p>å¦‚æœæ¯ä¸ªplaybookéƒ½ä¼šç”¨åˆ°é‡å¯æŸä¸ªæœåŠ¡çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆæ¯ä¸ªplaybookéƒ½è¦å†™ä¸€æ¬¡ï¼Œåˆ©ç”¨includeå°±åªç”¨å†™ä¸€æ¬¡ï¼Œè®©æ¯ä¸ªplaybookè°ƒç”¨å³å¯ã€‚</p>
<p><strong>ä¾‹ä¸€ï¼šå‡†å¤‡ä¸€ä¸ªé‡å¯nginxçš„ymlæ–‡ä»¶æ¥ç»™å„ä¸ªplaybookè°ƒç”¨</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx_restart.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">include:</span> <span class="string">./restart_nginx.yml</span></span><br></pre></td></tr></table></figure>

<h3 id="6-6-é”™è¯¯å¿½ç•¥ignore-errors"><a href="#6-6-é”™è¯¯å¿½ç•¥ignore-errors" class="headerlink" title="6.6 é”™è¯¯å¿½ç•¥ignore_errors"></a>6.6 é”™è¯¯å¿½ç•¥ignore_errors</h3><p>å°±æ˜¯å­—é¢æ„æ€- -ï¼Œå°½ç®¡æŸä¸ªä»»åŠ¡å‡ºé”™äº†ï¼Œä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»»åŠ¡ã€‚</p>
<p><strong>ä¾‹ä¸€ï¼šå¿½ç•¥æŸä¸ªä»»åŠ¡</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- hosts: cqm</span><br><span class="line">  tasks:</span><br><span class="line">    - name: ignore errors test</span><br><span class="line">      command: /bin/false</span><br><span class="line">      ignore_errors: yes</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="6-7-é”™è¯¯æ¨¡å—fail"><a href="#6-7-é”™è¯¯æ¨¡å—fail" class="headerlink" title="6.7 é”™è¯¯æ¨¡å—fail"></a>6.7 é”™è¯¯æ¨¡å—fail</h3><p>failæ¨¡å—æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥â€œæ‰§è¡Œå¤±è´¥â€çš„æ¨¡å—ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“åœ¨shellä¸­åªè¦æ·»åŠ exitå°±å¯ä»¥åœæ­¢æ‰§è¡Œï¼Œè€Œplaybookåªæœ‰åœ¨æŸä¸ªä»»åŠ¡å‡ºé”™äº†æ‰ä¼šåœæ­¢æ‰§è¡Œï¼Œè¿™æ—¶å€™å°±å¯ä»¥åˆ©ç”¨failæ¥åœæ­¢playbookçš„æ‰§è¡Œã€‚</p>
<p><strong>ä¾‹ä¸€ï¼šåˆ©ç”¨failæ¥å®ç°exitçš„åŠŸèƒ½</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug2</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#æ‰§è¡Œè¯¥æ¨¡å—ååé¢çš„debugéƒ½ä¼šæ‰§è¡Œ</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fail</span></span><br><span class="line">      <span class="attr">fail:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot; this is fail module test &quot;</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug3</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug4</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;4&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-8-é”™è¯¯æ”¹å˜failed-when"><a href="#6-8-é”™è¯¯æ”¹å˜failed-when" class="headerlink" title="6.8 é”™è¯¯æ”¹å˜failed_when"></a>6.8 é”™è¯¯æ”¹å˜failed_when</h3><p>failed_whençš„ä½œç”¨å°±æ˜¯å°†æ¡ä»¶æˆç«‹çš„ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸ºå¤±è´¥ã€‚</p>
<p><strong>ä¾‹ä¸€ï¼šåˆ¤æ–­æ˜¯å¦è¾“å‡ºäº†errorï¼Œæ˜¯åˆ™è®¾ç½®ä¸ºä»»åŠ¡å¤±è´¥</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;i am debug1&quot;</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#å› ä¸ºè¾“å‡ºé‡ŒåŒ…å«äº†errorï¼Œæ‰€ä»¥æ¡ä»¶æˆç«‹å°†è¯¥ä»»åŠ¡è®¾ç½®ä¸ºäº†failï¼Œplaybookä¸­æ­¢  </span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Output</span> <span class="string">Error</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#x27;this is error&#x27;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">output_error</span></span><br><span class="line">      <span class="attr">failed_when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">&#x27;error&#x27;</span> <span class="string">in</span> <span class="string">output_error.stdout</span> <span class="string">)</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug2</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;i am debug2&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-9-é”™è¯¯å¤„ç†changed-when"><a href="#6-9-é”™è¯¯å¤„ç†changed-when" class="headerlink" title="6.9 é”™è¯¯å¤„ç†changed_when"></a>6.9 é”™è¯¯å¤„ç†changed_when</h3><p>changed_whençš„ä½œç”¨å°±æ˜¯å°†æ¡ä»¶æˆç«‹çš„ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸ºchangedã€‚</p>
<p>æˆ‘ä»¬åœ¨è°ƒç”¨handlersçš„æ—¶å€™ï¼Œåªæœ‰ä»»åŠ¡çŠ¶æ€ä¸ºchangedæ‰ä¼šè°ƒç”¨ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨changed_whenæ”¹å˜ä»»åŠ¡çŠ¶æ€ä¸ºchangedï¼Œå°±å¯ä»¥å®ç°è°ƒç”¨handlersäº†ã€‚</p>
<p><strong>ä¾‹ä¸€ï¼šæ”¹å˜ä»»åŠ¡çŠ¶æ€ä¸ºchangedè€Œè°ƒç”¨è§¦å‘å™¨</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="comment">#å°½ç®¡æ–‡ä»¶æ²¡æœ‰æ”¹å˜ï¼Œä»»åŠ¡çŠ¶æ€ä¸ºokä¹Ÿä¼šè¢«æ”¹ä¸ºchangedè€Œè°ƒç”¨handlers</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<p>changed_whenä¹Ÿå¯ä»¥ä½¿ä»»åŠ¡æ°¸è¿œä¸ä¼šæ˜¯changedã€‚</p>
<p><strong>ä¾‹äºŒï¼šä½¿ä»»åŠ¡æ°¸è¿œä¸ºok</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="comment">#å°½ç®¡æ–‡ä»¶å‘ç”Ÿäº†æ”¹å˜ï¼Œä»»åŠ¡çŠ¶æ€ä¸ºchangedä¹Ÿä¼šè¢«æ”¹ä¸ºok,æ°¸è¿œä¸ä¼šè°ƒç”¨handlers</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">false</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¸ƒã€Ansibleçš„roles"><a href="#ä¸ƒã€Ansibleçš„roles" class="headerlink" title="ä¸ƒã€Ansibleçš„roles"></a>ä¸ƒã€Ansibleçš„roles</h2><p>roleså°±æ˜¯é€šè¿‡åˆ†åˆ«å°†å˜é‡ã€æ–‡ä»¶ã€ä»»åŠ¡ã€æ¨¡å—åŠå¤„ç†å™¨æ”¾ç½®äºå•ç‹¬çš„ç›®å½•ä¸­ã€å¹¶å¯ä»¥ä¾¿æ·åœ°includeå®ƒä»¬çš„ä¸€ç§æœºåˆ¶ã€‚</p>
<p>rolesçš„ç›®å½•ç»“æ„ï¼š</p>
<p><img src="/2024/02/18/ansible/role%E7%BB%93%E6%9E%84.png" alt="roleç»“æ„"></p>
<ol>
<li>filesï¼šå­˜æ”¾æ™®é€šæ–‡ä»¶ï¼Œæ¯”å¦‚copyè°ƒç”¨çš„æ–‡ä»¶</li>
<li>handlersï¼šè§¦å‘å™¨</li>
<li>metaï¼šä¾èµ–å…³ç³»</li>
<li>tasksï¼šä»»åŠ¡</li>
<li>templatesï¼šå­˜æ”¾å«æœ‰å˜é‡çš„æ–‡ä»¶</li>
<li>varsï¼šå˜é‡</li>
<li>åœ¨æ¯ä¸ªç›®å½•é‡Œçš„ymlæ–‡ä»¶éƒ½å¿…é¡»å‘½åä¸ºmain.yml</li>
</ol>
<p><strong>ä¸€é”®ç”Ÿæˆrolesç›®å½•</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-galaxy role init test</span><br></pre></td></tr></table></figure>

<h2 id="å…«ã€åˆ©ç”¨Ansibleæ­å»ºKodcloud"><a href="#å…«ã€åˆ©ç”¨Ansibleæ­å»ºKodcloud" class="headerlink" title="å…«ã€åˆ©ç”¨Ansibleæ­å»ºKodcloud"></a>å…«ã€åˆ©ç”¨Ansibleæ­å»ºKodcloud</h2><p><strong>é¡¹ç›®æ¶æ„å›¾</strong></p>
<p><img src="/2024/02/18/ansible/ansible%E9%83%A8%E7%BD%B2kod%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="ansibleéƒ¨ç½²kodæ¶æ„å›¾.png"></p>
<h3 id="8-1-å‡†å¤‡é¡¹ç›®ç¯å¢ƒ"><a href="#8-1-å‡†å¤‡é¡¹ç›®ç¯å¢ƒ" class="headerlink" title="8.1 å‡†å¤‡é¡¹ç›®ç¯å¢ƒ"></a>8.1 å‡†å¤‡é¡¹ç›®ç¯å¢ƒ</h3><ol>
<li>åŸºæœ¬é…ç½®</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/project/&#123;host_vars,group_vars&#125;</span><br><span class="line">cd /root/project</span><br><span class="line">cp /etc/ansible/ansible.cfg .</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®inventory</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim hosts</span><br><span class="line">[web]</span><br><span class="line">192.168.88.133</span><br><span class="line">[db]</span><br><span class="line">192.168.88.134</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>é…ç½®é€šç”¨å˜é‡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim group_vars/all</span><br><span class="line">nfs_server_ip: 192.168.88.134</span><br><span class="line">redis_server_ip: 192.168.88.134</span><br><span class="line">ip_address_range: 192.168.88.0/24</span><br><span class="line">web_user: www</span><br><span class="line">web_group: www</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>åˆ›å»ºå„ä¸ªroleæ–‡ä»¶ç›®å½•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#123;db_base,redis,mariadb,nfs_server,web_base,nginx,php,nfs_client,kodcloud&#125;/&#123;files,handlers,tasks,templates,vars&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-é…ç½®rolesæ–‡ä»¶"><a href="#8-2-é…ç½®rolesæ–‡ä»¶" class="headerlink" title="8.2 é…ç½®rolesæ–‡ä»¶"></a>8.2 é…ç½®rolesæ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kod.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">db_base</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">db_base</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">mariadb</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">mariadb</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nfs_server</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">nfs_server</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">web_base</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">web_base</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">php</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">php</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nfs_client</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">nfs_client</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">kodcloud</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">kodcloud</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-é…ç½®dbç«¯åŸºæœ¬ç¯å¢ƒ"><a href="#8-3-é…ç½®dbç«¯åŸºæœ¬ç¯å¢ƒ" class="headerlink" title="8.3 é…ç½®dbç«¯åŸºæœ¬ç¯å¢ƒ"></a>8.3 é…ç½®dbç«¯åŸºæœ¬ç¯å¢ƒ</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim db_base/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Stop</span> <span class="string">Firewall</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">firewalld</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">stopped</span></span><br></pre></td></tr></table></figure>

<h3 id="8-4-é…ç½®dbç«¯redisæœåŠ¡"><a href="#8-4-é…ç½®dbç«¯redisæœåŠ¡" class="headerlink" title="8.4 é…ç½®dbç«¯redisæœåŠ¡"></a>8.4 é…ç½®dbç«¯redisæœåŠ¡</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim redis/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">redis.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/redis.conf</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™templates</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim redis/temlpates/redis.conf.j2</span><br><span class="line">egrep -v &#x27;^#|^$&#x27; redis/templates/redis.conf.j2</span><br><span class="line">bind &#123;&#123; ansible_default_ipv4.address &#125;&#125;</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat redis/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h3 id="8-5-é…ç½®dbç«¯mariadbæœåŠ¡"><a href="#8-5-é…ç½®dbç«¯mariadbæœåŠ¡" class="headerlink" title="8.5 é…ç½®dbç«¯mariadbæœåŠ¡"></a>8.5 é…ç½®dbç«¯mariadbæœåŠ¡</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mariadb/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Mariadb</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb-server</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">MySQL-python</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Mariadb</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">my.cnf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Mariadb</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Mariadb</span> <span class="string">Root</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">mysql_user:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">toortoor</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">website</span> &#125;&#125; <span class="string">Databases</span></span><br><span class="line">  <span class="attr">mysql_db:</span></span><br><span class="line">    <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">login_password:</span> <span class="string">toortoor</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; website &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">collation:</span> <span class="string">utf8_bin</span></span><br><span class="line">    <span class="attr">encoding:</span> <span class="string">utf8</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">website</span> &#125;&#125; <span class="string">DB</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">mysql_user:</span></span><br><span class="line">    <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">login_password:</span> <span class="string">toortoor</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_db_user &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_db_pass &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&#x27;192.168.88.%&#x27;</span></span><br><span class="line">    <span class="attr">priv:</span> <span class="string">&#x27;*.*:ALL,GRANT&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™files</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mariadb/files/my.cnf.j2</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">mysqld</span>]</span><br><span class="line"><span class="string">datadir=/var/lib/mysql</span></span><br><span class="line"><span class="string">socket=/var/lib/mysql/mysql.sock</span></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line"><span class="string">symbolic-links=0</span></span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[<span class="string">mysqld_safe</span>]</span><br><span class="line"><span class="string">log-error=/var/log/mariadb/mariadb.log</span></span><br><span class="line"><span class="string">pid-file=/var/run/mariadb/mariadb.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="type">!includedir</span> <span class="string">/etc/my.cnf.d</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mariadb/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">website:</span> <span class="string">kodcloud</span></span><br><span class="line"><span class="attr">web_db_user:</span> <span class="string">kodcloud</span></span><br><span class="line"><span class="attr">web_db_pass:</span> <span class="string">toortoor</span></span><br></pre></td></tr></table></figure>

<h3 id="8-6-é…ç½®dbç«¯nfsæœåŠ¡"><a href="#8-6-é…ç½®dbç«¯nfsæœåŠ¡" class="headerlink" title="8.6 é…ç½®dbç«¯nfsæœåŠ¡"></a>8.6 é…ç½®dbç«¯nfsæœåŠ¡</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0757</span></span><br><span class="line">    <span class="attr">recurse:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">NFS</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">exports.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/exports</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restarted</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restarted</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nfs_share_directory:</span> <span class="string">/root/nfs_share</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç¼–å†™temlpates</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/templates/exports.j2</span><br><span class="line">&#123;&#123; nfs_share_directory &#125;&#125; &#123;&#123; ip_address_range &#125;&#125;(rw)</span><br></pre></td></tr></table></figure>

<h3 id="8-7-é…ç½®webç«¯åŸºæœ¬ç¯å¢ƒ"><a href="#8-7-é…ç½®webç«¯åŸºæœ¬ç¯å¢ƒ" class="headerlink" title="8.7 é…ç½®webç«¯åŸºæœ¬ç¯å¢ƒ"></a>8.7 é…ç½®webç«¯åŸºæœ¬ç¯å¢ƒ</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim web_base/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">web_group</span> &#125;&#125; <span class="string">Group</span></span><br><span class="line">  <span class="attr">group:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_group &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">web_user</span> &#125;&#125; <span class="string">User</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_user &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_group &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">create_home:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/sbin/nologin</span></span><br></pre></td></tr></table></figure>

<h3 id="8-8-é…ç½®webç«¯nginxæœåŠ¡"><a href="#8-8-é…ç½®webç«¯nginxæœåŠ¡" class="headerlink" title="8.8 é…ç½®webç«¯nginxæœåŠ¡"></a>8.8 é…ç½®webç«¯nginxæœåŠ¡</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Firewall</span></span><br><span class="line">  <span class="attr">firewalld:</span></span><br><span class="line">    <span class="attr">zone:</span> <span class="string">public</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span><span class="string">/tcp</span></span><br><span class="line">    <span class="attr">permanent:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">enabled</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">  <span class="attr">yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/7/$basearch/</span></span><br><span class="line">    <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item.src &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item.dest &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">src:</span> <span class="string">&#x27;nginx.conf.j2&#x27;</span>, <span class="attr">dest:</span> <span class="string">&#x27;/etc/nginx/nginx.conf&#x27;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">src:</span> <span class="string">&#x27;default.conf.j2&#x27;</span>, <span class="attr">dest:</span> <span class="string">&#x27;/etc/nginx/conf.d/default.conf&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Started</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™templates</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/templates/nginx.conf.j2</span><br><span class="line">user  &#123;&#123; web_user &#125;&#125;;</span><br><span class="line">worker_processes  &#123;&#123; ansible_processor_count * 1 &#125;&#125;;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  &#123;&#123; ansible_processor_count * 1024 &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/templates/default.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen       &#123;&#123; nginx_port &#125;&#125;;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           /usr/share/nginx/html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_pass   unix:/etc/nginx/php-fpm.sock;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">    # concurs with nginx&#x27;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç¼–å†™vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx_port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="8-9-é…ç½®webç«¯phpæœåŠ¡"><a href="#8-9-é…ç½®webç«¯phpæœåŠ¡" class="headerlink" title="8.9 é…ç½®webç«¯phpæœåŠ¡"></a>8.9 é…ç½®webç«¯phpæœåŠ¡</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim php/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">PHP</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http://rpms.remirepo.net/enterprise/remi-release-7.rpm</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; php &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-cli&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-common&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-devel&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-embedded&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-gd&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-mcrypt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-mbstring&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pdo&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-xml&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-mysqlnd&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-opcache&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pecl-memcached&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pecl-redis&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pecl-mongodb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">www.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_route &#125;&#125;</span>/php-fpm.d/www.conf&quot;</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim php/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™files</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim php/files/www.conf.j2</span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = /etc/nginx/php-fpm.sock</span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line">listen.mode = 0660</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç¼–å†™vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim php/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">php:</span> <span class="string">php74</span></span><br><span class="line"><span class="attr">php_version:</span> <span class="string">php74-php</span></span><br><span class="line"><span class="attr">php_route:</span> <span class="string">/etc/opt/remi/php74</span></span><br></pre></td></tr></table></figure>

<h3 id="8-10-é…ç½®webç«¯nfsæœåŠ¡"><a href="#8-10-é…ç½®webç«¯nfsæœåŠ¡" class="headerlink" title="8.10 é…ç½®webç«¯nfsæœåŠ¡"></a>8.10 é…ç½®webç«¯nfsæœåŠ¡</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_client/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Mount</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">mount:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; nfs_server_ip &#125;&#125;</span>:<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">opts:</span> <span class="string">defaults</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">mounted</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_client/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nfs_share_directory:</span> <span class="string">/root/nfs_share</span></span><br></pre></td></tr></table></figure>

<h3 id="8-11-é…ç½®webç«¯kodcloud"><a href="#8-11-é…ç½®webç«¯kodcloud" class="headerlink" title="8.11 é…ç½®webç«¯kodcloud"></a>8.11 é…ç½®webç«¯kodcloud</h3><ol>
<li>ç¼–å†™tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Kodcloud</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/usr/share/nginx/html/kodcloud</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0777</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Input</span> <span class="string">Kodcloud</span> <span class="string">File</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; kod_version &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/usr/share/nginx/html/kodcloud</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0777</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">Virtual</span> <span class="string">Host</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">kodcloud.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/conf.d/kodcloud.conf</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kod_version:</span> <span class="string">kodbox.1.15.zip</span></span><br><span class="line"><span class="attr">php_version:</span> <span class="string">php74-php</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ç¼–å†™files</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://static.kodcloud.com/update/download/kodbox.1.15.zip kodcloud/files/kodbox.1.15.zip</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/files/kodcloud.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html/kodcloud;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-12-æ‰§è¡Œplaybook"><a href="#8-12-æ‰§è¡Œplaybook" class="headerlink" title="8.12 æ‰§è¡Œplaybook"></a>8.12 æ‰§è¡Œplaybook</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts kod.yml</span><br></pre></td></tr></table></figure>

<h3 id="8-13-æµ‹è¯•"><a href="#8-13-æµ‹è¯•" class="headerlink" title="8.13 æµ‹è¯•"></a>8.13 æµ‹è¯•</h3><ol>
<li>ç™»å½•åˆ°webå®‰è£…kodcloud</li>
</ol>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="kodå®‰è£…ä¸€"></p>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%BA%8C.png" alt="kodå®‰è£…äºŒ"></p>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%B8%89.png" alt="kodå®‰è£…ä¸‰"></p>
<ol start="2">
<li>ç™»å½•kodcloud</li>
</ol>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E5%9B%9B.png" alt="kodå®‰è£…å››"></p>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%BA%94.png" alt="kodå®‰è£…äº”"></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">Previous</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/page/3/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Warner"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">16</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">15</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqmmm/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T09:39:48.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/%E9%A6%96%E9%A1%B5/">é¦–é¡µ</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/cka/">CKA</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/docker/">Docker</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/elk/">ELK</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/jenkins/">Jenkins</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">é¦–é¡µ</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2024 Warner</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Â© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>