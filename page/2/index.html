<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Warner&#039;s Wiki"><meta property="og:url" content="https://cqmmm.github.io/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cqmmm.github.io/img/og_image.png"><meta property="article:author" content="Warner"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cqmmm.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqmmm.github.io"},"headline":"Warner's Wiki","image":["https://cqmmm.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Warner"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://cqmmm.github.io/logo.jpg"}},"description":""}</script><link rel="icon" href="/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:31:05.679Z" title="2/18/2024, 5:31:05 PM">2024-02-18</time></span><span class="level-item">15 minutes read (About 2252 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/elk/">ELK</a></p><div class="content"><p><img src="/elastic-logo.png" alt="elastic-logo"></p>
<p>ELK 即 ElasticSearch + Logstash + Kibana，Elasticsearch 是一个搜索和分析引擎。Logstash 是服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到诸如 Elasticsearch 等“存储库”中。Kibana 则可以让用户在 Elasticsearch 中使用图形和图表对数据进行可视化。</p>
<p>ELK 目前官方已整合为 Elastic Stack。</p>
<h2 id="一、部署ELK"><a href="#一、部署ELK" class="headerlink" title="一、部署ELK"></a>一、部署ELK</h2><h3 id="1-1-Elasticsearch部署"><a href="#1-1-Elasticsearch部署" class="headerlink" title="1.1 Elasticsearch部署"></a>1.1 Elasticsearch部署</h3><ol>
<li>准备 java 环境</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install jaba-1.8.0-openjdk*</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建用户</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd elk</span><br><span class="line">useradd -g elk elk</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>下载 es 并授权</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.15.1-linux-x86_64.tar.gz</span><br><span class="line">tar -xf elasticsearch-7.15.1-linux-x86_64.tar.gz</span><br><span class="line">mv elasticsearch-7.15.1 es</span><br><span class="line">chown -R elk:elk ./es</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置 es</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim ./es/config/elasticsearch.yml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群名称</span></span><br><span class="line">cluster.name: elk</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">节点名称</span></span><br><span class="line">node.name: es</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据存储目录</span></span><br><span class="line">path.data: /home/elk/es/data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志存储目录</span></span><br><span class="line">path.logs: /home/elk/es/logs</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">节点IP</span></span><br><span class="line">network.host: 192.168.88.130</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群初始化master节点</span></span><br><span class="line">cluster.initial_master_nodes: [&quot;es&quot;]</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动 es，通过 9200 端口就可以验证是否启动成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su elk</span><br><span class="line">./es/bin/elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Kibana部署"><a href="#1-2-Kibana部署" class="headerlink" title="1.2 Kibana部署"></a>1.2 Kibana部署</h3><ol>
<li>下载 kibana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/kibana/kibana-7.15.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>解压授权</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xf kibana-7.15.1-linux-x86_64.tar.gz</span><br><span class="line">mv kibana-7.15.1 kibana</span><br><span class="line">chown -R elk:elk ./kibana</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 kibana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim ./kibana/config/kibana.yml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口</span></span><br><span class="line">server.port: 5601</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kibana的IP</span></span><br><span class="line">server.host: &quot;192.168.88.130&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">es的IP</span></span><br><span class="line">elasticsearch.hosts: [&quot;http://192.168.88.130:9200&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kibana索引</span></span><br><span class="line">kibana.index: &quot;.kibana&quot;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-Logstash部署"><a href="#1-3-Logstash部署" class="headerlink" title="1.3 Logstash部署"></a>1.3 Logstash部署</h3><p>logstash 是一个数据分析软件，主要目的是分析log日志。</p>
<p>首先将数据传给 logstash，它将数据进行过滤和格式化（转成 JSON 格式），然后传给 Elasticsearch 进行存储、建搜索的索引，kibana 提供前端的页面再进行搜索和图表可视化，它是调用 Elasticsearch 的接口返回的数据进行可视化。</p>
<p>它组要组成部分是数据输入，数据源过滤，数据输出三部分。</p>
<p><strong>数据输入input</strong></p>
<p>input 是指数据传输到 logstash 中，常见的配置如下：</p>
<ul>
<li>file：从文件系统中读取一个文件</li>
<li>syslog：监听 514 端口</li>
<li>redis：从 redis 服务器读取数据</li>
<li>lumberjack：使用 lumberjack 协议来接收数据，目前已经改为 logstash-forwarder</li>
</ul>
<p>input 配置一般为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从控制台中输入来源</span></span><br><span class="line">stdin &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从文件中输入来源</span></span><br><span class="line">file &#123;</span><br><span class="line">   path =&gt; &quot;E:/software/logstash-1.5.4/logstash-1.5.4/data/*&quot; #单一文件</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">监听文件的多个路径</span></span><br><span class="line">   path =&gt; [&quot;E:/software/logstash-1.5.4/logstash-1.5.4/data/*.log&quot;,&quot;F:/*.log&quot;]</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">排除不想监听的文件</span></span><br><span class="line">   exclude =&gt; &quot;1.log&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">添加自定义的字段</span></span><br><span class="line">   add_field =&gt; &#123;&quot;test&quot;=&gt;&quot;test&quot;&#125;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">增加标签</span></span><br><span class="line">   tags =&gt; &quot;tag1&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">设置新事件的标志</span></span><br><span class="line">   delimiter =&gt; &quot;\n&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">设置多长时间扫描目录，发现新文件</span></span><br><span class="line">   discover_interval =&gt; 15</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">设置多长时间检测文件是否修改</span></span><br><span class="line">   stat_interval =&gt; 1</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">监听文件的起始位置，默认是end</span></span><br><span class="line">   start_position =&gt; beginning</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">监听文件读取信息记录的位置</span></span><br><span class="line">   sincedb_path =&gt; &quot;E:/software/logstash-1.5.4/logstash-1.5.4/test.txt&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">设置多长时间会写入读取的位置信息</span></span><br><span class="line">   sincedb_write_interval =&gt; 15</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">系统日志方式</span></span><br><span class="line">syslog &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">定义类型</span></span><br><span class="line">  type =&gt; &quot;system-syslog&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">定义监听端口</span></span><br><span class="line">  port =&gt; 10514</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">filebeats方式</span></span><br><span class="line">beats &#123;</span><br><span class="line">  port =&gt; 5044</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>数据过滤filter</strong></p>
<p>fillter 在 logstash 中担任中间处理组件。</p>
<p>常见的 filter 如下：</p>
<ul>
<li>grok：解析无规则的文字并转化为有结构的格式。Grok 是目前最好的方式来将无结构的数据转换为有结构可查询的数据,有120多种匹配规则</li>
<li>mutate：允许改变输入的文档，可以从命名，删除，移动或者修改字段在处理事件的过程中</li>
<li>drop：丢弃一部分 events 不进行处理，例如：debug events</li>
<li>clone：拷贝 event，这个过程中也可以添加或移除字段</li>
<li>geoip：添加地理信息（为 kibana 图形化展示使用）</li>
</ul>
<p>filter 的配置一般为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">定义数据的格式</span></span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;DATA:timestamp&#125;\|%&#123;IP:serverIp&#125;\|%&#123;IP:clientIp&#125;\|%&#123;DATA:logSource&#125;\|%&#123;DATA:userId&#125;\|%&#123;DATA:reqUrl&#125;\|%&#123;DATA:reqUri&#125;\|%&#123;DATA:refer&#125;\|%&#123;DATA:device&#125;\|%&#123;DATA:textDuring&#125;\|%&#123;DATA:duringTime:int&#125;\|\|&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">定义时间戳的格式</span></span><br><span class="line">  date &#123;</span><br><span class="line">    match =&gt; [ &quot;timestamp&quot;, &quot;yyyy-MM-dd-HH:mm:ss&quot; ]</span><br><span class="line">    locale =&gt; &quot;cn&quot;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">定义客户端的IP是哪个字段（上面定义的数据格式）</span></span><br><span class="line">  geoip &#123;</span><br><span class="line">    source =&gt; &quot;clientIp&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>输出配置output</strong></p>
<p>output 是整个 logstash 的最终端。</p>
<p>常见的 output 如下：</p>
<ul>
<li><p>elasticsearch：高效的保存数据，并且能够方便和简单的进行查询</p>
</li>
<li><p>file：将 event 数据保存到文件中。</p>
</li>
<li><p>graphite：将 event 数据发送到图形化组件中（一个很流行的开源存储图形化展示的组件：<a target="_blank" rel="noopener" href="http://graphite.wikidot.com/%EF%BC%89">http://graphite.wikidot.com/）</a></p>
</li>
<li><p>statsd：statsd是一个统计服务，比如技术和时间统计，通过udp通讯，聚合一个或者多个后台服务</p>
</li>
</ul>
<p>output 的配置一般为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; &quot;127.0.0.1:9200&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-1-Logstash处理Nginx日志"><a href="#1-3-1-Logstash处理Nginx日志" class="headerlink" title="1.3.1 Logstash处理Nginx日志"></a>1.3.1 Logstash处理Nginx日志</h4><ol>
<li>下载 logstash</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-7.15.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>解压并授权</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xf logstash-7.15.1-linux-x86_64.tar.gz</span><br><span class="line">mv logstash-7.15.1 logstash</span><br><span class="line">chown -R elk:elk ./logstash</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 logstash</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim ./logstash/config/logstash.yml</span><br><span class="line">http.host: 192.168.88.130</span><br><span class="line">http.port: 9600-9700</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>这里以处理 nginx 日志文件为例，配置 nginx 日志格式</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在http块下添加</span></span><br><span class="line">log_format json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;remote_user&quot;:&quot;$remote_user&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;request&quot;:&quot;$request&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br><span class="line">                  &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class="line">                  &#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br><span class="line">                  &#x27;&quot;status&quot;:&quot;$status&quot;</span><br><span class="line">                 &#125;&#x27;;</span><br><span class="line">access_log  /var/log/nginx/access.log  json;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>添加处理配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim ./logstash/config/elk_nginx_log.conf</span><br><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">      path =&gt; &quot;/var/log/messages&quot;</span><br><span class="line">      type =&gt; &quot;system&quot;</span><br><span class="line">      start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    file &#123;</span><br><span class="line">      path =&gt; &quot;/var/log/nginx/access.log&quot;</span><br><span class="line">      type =&gt;&quot;nginx-log&quot;</span><br><span class="line">      start_position =&gt; &quot;beginning&quot;</span><br><span class="line">      sincedb_path =&gt; &quot;/dev/null&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;   </span><br><span class="line">    if [type] == &quot;system&quot;&#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">           hosts =&gt; [&quot;192.168.88.130:9200&quot;]</span><br><span class="line">           index =&gt; &quot;systemlog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if [type] == &quot;nginx-log&quot;&#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">           hosts =&gt; [&quot;192.168.88.130:9200&quot;]</span><br><span class="line">           index =&gt; &quot;nginx-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stdout &#123;</span><br><span class="line">		codec =&gt; rubydebug</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>测试文件是否可用</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -f ./config/elk_nginx_log.conf --config.test_and_exit</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>开启 logstash</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -f ./config/elk_nginx_log.conf</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>在 kibana 创建 index pattern</li>
</ol>
<p><img src="/2024/02/18/elk/nginx_log%E4%B8%80.png" alt="nginx_log一"></p>
<ol start="9">
<li>在 Discover 就可以看到处理好的数据</li>
</ol>
<p><img src="/2024/02/18/elk/nginx_log%E4%BA%8C.png" alt="nginx_log二"></p>
<h3 id="1-4-Filebeat部署"><a href="#1-4-Filebeat部署" class="headerlink" title="1.4 Filebeat部署"></a>1.4 Filebeat部署</h3><p>beat 是一个轻量级的日志采集器，早期的 ELK 架构都是由 logstash 去采集数据，这样对内存等资源的消耗会比较高，而 beat 用于采集日志的话，占用的资源几乎可以忽略不计。</p>
<p>beat 的种类有很多种，主要包括以下几种：</p>
<p><img src="/2024/02/18/elk/beat%E7%A7%8D%E7%B1%BB.png" alt="beat种类"></p>
<ul>
<li>Filebeat：日志文件（收集文件数据）</li>
<li>Metricbeat：指标（收集系统、进程和文件系统级别的CPU和内存使用情况等数据），支持 Apache、HAProxy、MongoDB、MySQL、Nginx、PostgreSQL、Redis、System、Zookeeper 等服务</li>
<li>Packetbeat：网络数据（收集网络流量数据），支持 ICMP (v4 and v6)、DNS、HTTP、AMQP 0.9.1、Cassandra、Mysql、PostgreSQL、Redis、Thrift-RPC、MongoDB、Memcache 等</li>
<li>Winlogbeat：windows 事件日志（收集Windows事件日志数据）</li>
<li>Audibeat：审计数据（收集审计日志）</li>
<li>Heartbeat：运行时间监控（收集系统运行时的数据），支持 ICMP (v4 and v6) 、TCP、HTTP 等协议</li>
<li>Functionbeat：收集、传送并监测来自您的云服务的相关数据</li>
<li>Journalbeat：读取journald日志</li>
</ul>
<h4 id="1-4-1-Filebeat"><a href="#1-4-1-Filebeat" class="headerlink" title="1.4.1 Filebeat"></a>1.4.1 Filebeat</h4><p>Filebeat 代替了 logstash 收集日志的工作，将收集好的日志直接发送给 logstash 进行过滤，在很大程度上减轻了服务器的压力，工作流程如下：</p>
<ul>
<li>Filebeat 会启动一个或多个实例去指定的日志目录查找数据（Input）</li>
<li>对于每个日志，Filebeat 都会启动一个 Harvester，每个 Harvester 都会将数据发送个 Spooler，再由 Spooler 发送给后端程序（Logstash、ES）</li>
</ul>
<p><img src="/2024/02/18/elk/filebeat%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="filebeat工作流程"></p>
<p><strong>Filebeat Nginx模块</strong></p>
<ol>
<li>下载 filebeat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.15.1-linux-x86_64.tar.gz</span><br><span class="line">tar -xf filebeat-7.15.1-linux-x86_64.tar.gz</span><br><span class="line">mv filebeat-7.15.1-linux-x86_64 filebeat</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看所有支持的模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat modules list</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动 nginx 模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat modules enable nginx</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改 logstash 规则文件并启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">vim ./logstash/config/conf.d/elk_filebeat_nginx_log.conf</span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; 5044</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line"></span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">           &quot;message&quot; =&gt; &quot;%&#123;IP:remote_addr&#125; (?:%&#123;DATA:remote_user&#125;|-) \[%&#123;HTTPDATE:timestamp&#125;\] %&#123;IPORHOST:http_host&#125; %&#123;DATA:request_method&#125; %&#123;DATA:request_uri&#125; %&#123;NUMBER:status&#125; (?:%&#123;NUMBER:body_bytes_sent&#125;|-) (?:%&#123;DATA:request_time&#125;|-) \&quot;(?:%&#123;DATA:http_referer&#125;|-)\&quot; \&quot;%&#123;DATA:http_user_agent&#125;\&quot; (?:%&#123;DATA:http_x_forwarded_for&#125;|-) \&quot;(?:%&#123;DATA:http_cookie&#125;|-)\&quot;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    geoip &#123;</span><br><span class="line">        source =&gt; &quot;remote_addr&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [ &quot;timestamp&quot;,&quot;dd/MMM/YYYY:HH:mm:ss Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    useragent &#123;</span><br><span class="line">        source=&gt;&quot;http_user_agent&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 由于host中包含name，而es会把host看作一个json对象，需要转变成字符，否则会导致logstash无法传输数据给es</span><br><span class="line">    mutate &#123;</span><br><span class="line">         rename =&gt; &#123; &quot;[host][name]&quot; =&gt; &quot;host&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">         hosts =&gt; [&quot;192.168.88.130:9200&quot;]</span><br><span class="line">         index =&gt; &quot;nginx-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    stdout &#123;</span><br><span class="line">		codec =&gt; rubydebug</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">./logstash/bin/logstash -f ./logstash/config/conf.d/elk_filebeat_nginx_log.conf</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>修改 nginx 模块文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim modules.d/nginx.yml</span><br><span class="line">- module: nginx</span><br><span class="line">  access:</span><br><span class="line">    enabled: true</span><br><span class="line">    var.paths: [&quot;/var/log/nginx/access.log*&quot;]</span><br><span class="line">  error:</span><br><span class="line">    enabled: true</span><br><span class="line">    var.paths: [&quot;/var/log/nginx/error.log*&quot;]</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>配置 filebeat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim ./filebeat/filebeat.yml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过nginx模块来实现，所以不开启</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: false</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/*.log</span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  path: /home/elk/filebeat/modules.d/*.yml</span><br><span class="line">  reload.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主要配置</span></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;192.168.88.130:5044&quot;]</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>启动 filebeat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su elk</span><br><span class="line">./filebeat setup</span><br><span class="line">./filebeat -e</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>在 logstash 或 kibana 中就可以看到新的数据</li>
</ol>
<p><img src="/2024/02/18/elk/filebeat%E6%B5%8B%E8%AF%95.png" alt="filebeat测试"></p>
<p><strong>Filebeat MySQL模块收集日志</strong></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T10:56:44.184Z" title="2/18/2024, 6:56:44 PM">2024-02-18</time></span><span class="level-item">35 minutes read (About 5302 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/kafka/">Kafka</a></p><div class="content"><h2 id="一、kafka架构"><a href="#一、kafka架构" class="headerlink" title="一、kafka架构"></a>一、kafka架构</h2><p>kafka 是一个分布式的基于<strong>发布和订阅模式</strong>的<strong>消息队列（message queue）</strong>，主要用于大数据实时处理领域。</p>
<p><img src="/2024/02/18/kafka/kafka%E5%9B%BE%E6%A0%87.jpeg" alt="kafka图标"></p>
<h3 id="1-1-消息队列"><a href="#1-1-消息队列" class="headerlink" title="1.1 消息队列"></a>1.1 消息队列</h3><p><strong>同步通信</strong></p>
<p><img src="/2024/02/18/kafka/%E5%90%8C%E6%AD%A5%E9%80%9A%E4%BF%A1.png" alt="同步通信"></p>
<p><strong>异步通信</strong></p>
<p><img src="/2024/02/18/kafka/%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1.png" alt="异步通信"></p>
<p>使用消息队列的好处如下：</p>
<ul>
<li>解耦：允许独立的扩展或修改两边的处理过程</li>
<li>可恢复性：系统的一部分组件失效时，不会影响到整个系统</li>
<li>缓冲：控制和优化数据经过系统的速度</li>
<li>灵活性和峰值处理能力：在特殊情况下，通信中的请求量会急剧增大（如双十一等活动），但这种情况并不常见，如果投入资源来待命是很浪费的，使用消息队列就可以顶住突发的访问压力，而保护集群不会因为请求量过多而崩溃</li>
<li>异步通信：有时候用户不想也不需要立即处理消息，这种时候就允许用户把消息放在队列中，等待处理</li>
</ul>
<p>消息队列分为<strong>点对点模式</strong>和<strong>发布&#x2F;订阅模式</strong></p>
<p><strong>点对点模式</strong></p>
<p>消息生产者生产消息发送到 queue 中，消费者再从 queue 拉取消息并消费，消息被消费之后就不再存在于 queue 中，queue 可以有多个消费者，但对于消息而言只能有一个消费者。</p>
<p><img src="/2024/02/18/kafka/%E7%82%B9%E5%AF%B9%E7%82%B9%E6%A8%A1%E5%BC%8F.png" alt="点对点模式"></p>
<p><strong>发布&#x2F;订阅模式</strong></p>
<p>消息生产者将消息发送到 topic 中，可以同时有多个消费者订阅该消息，发布到 topic 的消息可以被所有消费者订阅。</p>
<p><img src="/2024/02/18/kafka/%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F.png" alt="发布订阅模式"></p>
<h3 id="1-2-kafka基础架构"><a href="#1-2-kafka基础架构" class="headerlink" title="1.2 kafka基础架构"></a>1.2 kafka基础架构</h3><p>kafka 有四个核心的 API：</p>
<ul>
<li>The Producer API：允许一个应用程序发布一串流式的数据到一个或者多个 topic</li>
<li>The Consumer API：允许一个应用程序订阅一个或多个 topic ，并且对发布给他们的流式数据进行处理</li>
<li>The Streams API：允许一个应用程序作为一个流处理器，消费一个或者多个 topic 产生的输入流，然后生产一个输出流到一个或多个 topic 中去，在输入输出流中进行有效的转换</li>
<li>The Connector API：允许构建并运行可重用的生产者或者消费者，将 topics 连接到已存在的应用程序或者数据系统</li>
</ul>
<p><img src="/2024/02/18/kafka/kafka%E6%9E%B6%E6%9E%84.png" alt="kafka架构"></p>
<ul>
<li>producer：消息生产者</li>
<li>consumer：消息消费者</li>
<li>topic：数据主题，是数据订阅&#x2F;发布的地方，可以被多个消费者订阅</li>
<li>partition：分区，每个 topic 包含一个或多个分区，分区是一个有序的队列，分区中的消息都会被分配一个 offset，kafka 保证按每一个分区中的顺序将消息发送给消费者，但不保证按每一个 topic 中的顺序将消息发送给消费者；且 partition 是消费者和生产者操作的最小单元</li>
<li>offset（偏移量）：kafka 的存储文件都是按照 offset.kafka 来命名，方便查找数据</li>
<li>leader 副本：消息的订阅&#x2F;发布都由 leader 来完成</li>
<li>follower 副本：进行消息数据的备份，当 leader 挂了之后，就成为新的 leader 来代替旧的 leader</li>
<li>broker：一个 kafka 就是一个 broker，一个集群由多个 broker 组成</li>
<li>consumer group：消费者组，组中有多个消费者，组中的消费者都只能够接收一个分区的消息</li>
<li>zookeeper：保存 kafka 集群状态的信息，2.8.0版本开始支持 kraft 模式，可不依赖 zk 运行 kafka 集群</li>
<li>replicas：副本数</li>
</ul>
<h3 id="1-3-kafka-存储机制"><a href="#1-3-kafka-存储机制" class="headerlink" title="1.3 kafka 存储机制"></a>1.3 kafka 存储机制</h3><p>kafka 内部会自己创建一个 _consumer_offsets 并包含 50 个分区，这些主题用来保存消费者消费某个 topic 的偏移量。</p>
<p>每个 partitions 都被切割成相同大小的 segment，segment 由四个部分构成，具体如下：</p>
<p><img src="/2024/02/18/kafka/kafka%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6.png" alt="kafka存储机制"></p>
<ul>
<li>log：数据文件</li>
<li>index：索引文件，用来保存消息的索引，能够使查找数据更加高效</li>
<li>timeindex：具体时间日志</li>
<li>leader-epoch-checkpoint：保存了每一任  leader 开始写入消息时的 offset，会定时更新</li>
</ul>
<h3 id="1-4-生产者分区策略"><a href="#1-4-生产者分区策略" class="headerlink" title="1.4 生产者分区策略"></a>1.4 生产者分区策略</h3><p>kafka 允许为每条消息定义消息 key，可以根据 key 来为消息选择分区。</p>
<p>分区策略即决定生产者将消息发送到哪个分区的算法，主要有以下几种：</p>
<ul>
<li>轮询策略（没给定分区号和 key 值）：可以提供优秀的负载均衡能力，保证消息被平均的分配到各个分区上，但不能保证消息的有序性。</li>
<li>随即策略：瞎分，基本不用。</li>
<li>hash 策略（没给定分区号，但给了 key 值）：将 key 的 hash 值与 topic 的 partition 数进行取余得到<br>partition值</li>
<li>自定义分区</li>
</ul>
<h3 id="1-5-生产者ISR"><a href="#1-5-生产者ISR" class="headerlink" title="1.5 生产者ISR"></a>1.5 生产者ISR</h3><p>ISR 即同步副本，leader 维护了一个动态的 ISR，为 leader 保持同步的 follower 集合，当 ISR 中的 follower 完成数据的同步之后，leader 就会给 follower 发送 acks，如果 follower 长时间没有向 leader 同步数据，则该 follower 将被踢出 ISR。leader 发生故障之后就会在 ISR 中选取出新的 leader。</p>
<h3 id="1-6-生产者ACKS"><a href="#1-6-生产者ACKS" class="headerlink" title="1.6 生产者ACKS"></a>1.6 生产者ACKS</h3><p>kafka 发送确认参数 acks 的几种模式：</p>
<ul>
<li>acks &#x3D; 0：意味着生产者能够通过网络把消息发送出去，broker 接收到数据还没写入就发送，容易丢数据</li>
<li>acks &#x3D; 1：等待 leader 写入数据（不等待 follower 同步），就可以发送数据，可能会丢数据</li>
<li>acks &#x3D; all&#x2F;-1：等待 leader 和 follower（ISR 中的）写入数据，就可以发送数据，数据不容易丢，但效率底</li>
</ul>
<h3 id="1-7-kafka数据一致性原理"><a href="#1-7-kafka数据一致性原理" class="headerlink" title="1.7 kafka数据一致性原理"></a>1.7 kafka数据一致性原理</h3><ul>
<li>HW：所有副本中的最小 LEO</li>
<li>LEO：每个副本的最后一个（最大的） offset</li>
</ul>
<p>假设分区的副本为3，副本0为 leader，副本1、2为 follower，并且都在 ISR 列表中。虽然 leader 已经写入了 message3，但消费者只能读到 message1，因为所有的 ISR 都同步了 message1，只有在 HW 之上的消息才支持被消费，而 HW 取决于 LEO，原理类似于木桶原理。</p>
<p>这么做的原因是如果 leader 崩溃了，一个 follower 成为新的 leader 后，由于该新的 leader 没有做好数据的同步，如果允许消费者读取 HW 之下的数据的话，那么就会出现数据不一致的问题。</p>
<p><img src="/2024/02/18/kafka/kafka%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E5%8E%9F%E7%90%86.png" alt="kafka数据一致性原理"></p>
<h3 id="1-7-Exactly-once"><a href="#1-7-Exactly-once" class="headerlink" title="1.7 Exactly-once"></a>1.7 Exactly-once</h3><p>当生产者发送消息到 topic 时，很可能会出现宕机的情况，或者出现了网络故障，导致生产者消息发送失败，而生产者要如何处理这样的错误，就产生了如下几种不同的语义：</p>
<ul>
<li>At least once：至少一次，如果生产者收到了 broker 发送过来的 acks，且 acks 设置为了 all&#x2F;-1，这就代表消息已经被写入 topic 且同步好了。如果生产者在时间内没受到 acks 或收到的 acks 有误，那么就会重新发送消息。如果 broker 恰好在消息已经写入 topic 时，发送 acks 前出了故障，那么就会导致生产者发送同样的消息两次，消费者消费两次。</li>
<li>At more once：最多一次，如果生产者在接收 acks 超时或返回有问题的时候不重新发送消息，那么消息很可能没写入 topic 中，因此消费者也不会消费该条消息，不会出现数据重复的现象，但很容易缺数据。</li>
<li>Exactly once：精确一次，即使生产者重新发送消息，也只会被消费者消费一次，实际上就是在 kafka 集群中做一次去重的操作。kafka 集群会给生产者分配一个 PID，生产者每次发送消息到 broker 时都会附带 PID、分区以及序列号，broker 就会对数据做一个保存，如果生产者再发送同样消息，那么 broker 就会对数据进行去重，但如果生产者宕机重启了，就会被分配一个新的 PID，所以去重无法做到精准的数据写入。要开启 exactly-once，需要在 broker 中配置 <code>enable.idempotence = true</code> ，这时候 acks 默认被设置为 -1。</li>
</ul>
<h3 id="1-8-消费者分区分配策略"><a href="#1-8-消费者分区分配策略" class="headerlink" title="1.8 消费者分区分配策略"></a>1.8 消费者分区分配策略</h3><p>消费者是采用 pull 的方式在 kafka 集群中获取消息的。</p>
<p>push 模式很难适应消费速率不同的消费者，因为消息的发送速率是由 broker 决定的；而 pull 方式当 kafka 集群没有数据的时候，消费者可能会陷入循环之中，一直取到空数据。</p>
<p>一个消费者组里由多个消费者，一个 topic 里由多个分区，那么数据在消费的时候就会涉及到分配的问题，即确定那些分区由消费者组里的哪些消费者来消费。</p>
<p>kakfa 有三种分配策略，如下：</p>
<ul>
<li>RangeAssignor（默认）：RangeAssignor 是针对 topic 而言的，首先会对 topic 中的分区按照序号进行排列，并对消费者根据字典序排列，然后用分区个数除以消费者线程的总数来决定分区的分配，但如果除不尽，那么前面的消费者就会多分配一些分区。</li>
<li>RoundRobin：将消费组内所有消费者以及消费者所订阅的所有 topic 的 partition 按照字典序排序，然后通过轮询的方式逐个分配给组内的消费者。如果同时消费多个 topic，那么消费者会将这些 topic 视为一个。但如果同一个消费组内的消费者所订阅的信息是不相同的，那么在执行分区分配的时候就不是完全的轮询分配，有可能会导致分区分配的不均匀。</li>
<li>StickyAssignor：StickyAssignor 要实现的是分区的分配要尽可能的均匀，分配给消费者者的主题分区数最多相差一个，假设一个消费者组有三个消费者，都订阅了四个 topic，且每个 topic 中有二个分区，那么这时候分配的结果与 RoundRobin 会很相似，即消费者A三个分区、消费者B三个分区、消费者C两个分区，假设消费者C退出了消费者组，这时候 StickyAssignor 会保留之前消费者A和B分配到的分区，然后再将消费者C之前分配到的分区再分配给消费者A和B，即体现了粘性，不需要消费者将之前处理过的数据送到新的消费者再处理一次。</li>
</ul>
<h3 id="1-9-offset存储"><a href="#1-9-offset存储" class="headerlink" title="1.9 offset存储"></a>1.9 offset存储</h3><p>kafka 在0.9版本之前，offset 是存储在 zk 中，在之后的版本则是存储在 kafka 内置的一个 topic 中，即 <code>_consumer_offsets</code>，一个 offset 提交的信息包括以下：</p>
<table>
<thead>
<tr>
<th align="center">Fields</th>
<th align="center">Content</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Key</td>
<td align="center">Consumer Group、Topic、Partition</td>
</tr>
<tr>
<td align="center">Payload</td>
<td align="center">Offset、Metadata、Timestamp</td>
</tr>
</tbody></table>
<p>offset 的提交会根据消费者组的 key（GTP） 进行分区，对于一个给定的消费者，它所有的消息都会发送到唯一的 broker，这样消费者就不需要对多个 broker 拉取数据，但如果消费者组消费很多数量的分区，会对 broker 造成性能瓶颈。</p>
<h3 id="1-10-kafka写机制"><a href="#1-10-kafka写机制" class="headerlink" title="1.10 kafka写机制"></a>1.10 kafka写机制</h3><ul>
<li>顺序写入磁盘</li>
<li>零拷贝</li>
</ul>
<h3 id="1-11-kafka-controller"><a href="#1-11-kafka-controller" class="headerlink" title="1.11 kafka-controller"></a>1.11 kafka-controller</h3><p>kafka 集群中会有一个 broker 被选举为 controller，用来负责管理 broker 的上下线，所有 topic 的分区、副本分配和 leader 选举等。</p>
<h3 id="1-12-kafka事务"><a href="#1-12-kafka事务" class="headerlink" title="1.12 kafka事务"></a>1.12 kafka事务</h3><p>事务可以保证在 Exactly-Once 的基础上，生产和消费可以跨分区跨会话，即生产者在同一个事务内提交到多个分区的消息，要么同时提交成功，要么同时失败，这样就保证了生产者在运行时出现异常或宕机之后仍然成立。</p>
<p><strong>生产者事务</strong></p>
<p>为了实现跨分区跨会话的事务，需要引入全局唯一的 Transaction ID（由客户端给定），并将生产者的 PID 与之绑定，这样以来生产者即使宕机重启也可以与原来的 PID 进行绑定。</p>
<p>为了管理 Transaction ID，kafka 中引入了一个新的组件 Transaction Coordinator，生产者就是与 Transaction Coordinator 交互来获得  Transaction ID 对应的任务状态。Transaction Coordinator 还负责将事务写入 topic，这样即使服务重启，也可以得到恢复。</p>
<p><strong>消费者事务</strong></p>
<p>事务主要是为生产者作保证，无法保证消费者的精准消费，是因为消费者可以根据 offset 来访问消息。</p>
<h2 id="二、kafka基础"><a href="#二、kafka基础" class="headerlink" title="二、kafka基础"></a>二、kafka基础</h2><h3 id="2-1-kafka安装"><a href="#2-1-kafka安装" class="headerlink" title="2.1 kafka安装"></a>2.1 kafka安装</h3><p><strong>通过二进制包部署</strong></p>
<ol>
<li>下载 kafka</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.8.0/kafka_2.13-2.8.0.tgz</span><br><span class="line">tar -xf kafka_2.13-2.8.0.tgz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改 server.properties</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">broker的<span class="built_in">id</span>必须为唯一的整数，设置为-1时随机生成</span></span><br><span class="line">broker.id=-1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为实际zookeeper节点地址+2181端口</span></span><br><span class="line">zookeeper.connect=...</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>开启 zookeeper 和 kafka</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">daemon参数:不输出启动日志信息</span></span><br><span class="line">./bin/zookeeper-server-start.sh -daemon ../config/zookeeper.properties</span><br><span class="line">./bin/kafka-server-start.sh -daemon ./config/server.properties</span><br></pre></td></tr></table></figure>

<p><strong>通过 docker-compose 部署</strong></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/bitnami/zookeeper:3.7</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;12181:2181&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/zookeeper_data:/zookeeper_data&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALLOW_ANONYMOUS_LOGIN=yes</span></span><br><span class="line">  <span class="attr">kafka1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kafka1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/bitnami/kafka:2.8.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19092:9092&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/kafka1_data:/data&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALLOW_PLAINTEXT_LISTENER=yes</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line">  <span class="attr">kafka2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kafka2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/bitnami/kafka:2.8.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19093:9092&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/kafka2_data:/data&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALLOW_PLAINTEXT_LISTENER=yes</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line">  <span class="attr">kafka3:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kafka3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/bitnami/kafka:2.8.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19094:9092&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/kafka3_data:/data&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALLOW_PLAINTEXT_LISTENER=yes</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 zookeeper 内部查看 brokers 是否存在</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh</span><br><span class="line">ls /brokers/ids</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>kraft 模式部署</strong></p>
<ol>
<li>kraft&#x2F;server.properties</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据节点数改</span></span><br><span class="line">node.id=1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">控制节点</span></span><br><span class="line">controller.quorum.voters=1@master:9093,2@slave1:9093,3@slave2:9093</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成集群ID</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-storage.sh random-uuid</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>生成 <code>/tmp/kraft-combined-logs</code> 目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-storage.sh format -t &lt;uuid&gt; -c ./config/kraft/server.properties</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>各节点启动 kafka</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-server-start.sh -daemon ./config/kraft/server.properties</span><br></pre></td></tr></table></figure>

<p><strong>kraft 模式 docker-compose 部署</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">kafka1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kafka1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/bitnami/kafka:2.8.0</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          kafka-storage.sh format -t &lt;uuid&gt; -c /opt/bitnami/kafka/config/kraft/server.properties</span></span><br><span class="line"><span class="string">          kafka-server-start.sh /opt/bitnami/kafka/config/kraft/server.properties</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19092:9092&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./conf/kafka1:/opt/bitnami/kafka/config/kraft&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALLOW_PLAINTEXT_LISTENER=yes</span></span><br><span class="line">  <span class="attr">kafka2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kafka2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/bitnami/kafka:2.8.0</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          kafka-storage.sh format -t &lt;uuid&gt; -c /opt/bitnami/kafka/config/kraft/server.properties</span></span><br><span class="line"><span class="string">          kafka-server-start.sh /opt/bitnami/kafka/config/kraft/server.properties</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19093:9092&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./conf/kafka2:/opt/bitnami/kafka/config/kraft&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALLOW_PLAINTEXT_LISTENER=yes</span></span><br><span class="line">  <span class="attr">kafka3:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kafka3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/bitnami/kafka:2.8.0</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          kafka-storage.sh format -t &lt;uuid&gt; -c /opt/bitnami/kafka/config/kraft/server.properties</span></span><br><span class="line"><span class="string">          kafka-server-start.sh /opt/bitnami/kafka/config/kraft/server.properties</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19094:9092&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./conf/kafka3:/opt/bitnami/kafka/config/kraft&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALLOW_PLAINTEXT_LISTENER=yes</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-kafka基本使用"><a href="#2-2-kafka基本使用" class="headerlink" title="2.2 kafka基本使用"></a>2.2 kafka基本使用</h3><ol>
<li>列出某个 zookeeper 中的 topic</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --list --zookeeper zookeeper_ip:2181</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 topic</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--replication-factor:副本数，总副本数为(分区数 * 副本数参数)，下面的例子总副本数为4</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--partitions:分区数</span></span><br><span class="line">./kafka-topics.sh --create --zookeeper zookeeper_ip:2181 --replication-factor 2 --partitions 2 --topic test</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除 topic</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">delete.topic.enable为<span class="literal">true</span>时才会真正删除</span></span><br><span class="line">./kafka-topics.sh --delete --zookeeper zookeeper_ip:2181 --topic test</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>查看 topic</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --describe --zookeeper zookeeper_ip:2181 --topic test</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动 producer</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--broker-list:针对生产者使用，指定集群中的一个或者多个kafka服务器</span></span><br><span class="line">./kafka-console-producer.sh --broker-list kafka_id:9092 --topic test</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>启动 consumer</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--bootstrap-server:针对消费者使用，指定集群中的一个或者多个kafka服务器</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--from-beginning:查看所有消息数据</span></span><br><span class="line">./kafka-console-consumer.sh --bootstrap-server kafka_id:9092 --topic test --from-beginning</span><br></pre></td></tr></table></figure>

<h3 id="2-3-单播消息"><a href="#2-3-单播消息" class="headerlink" title="2.3 单播消息"></a>2.3 单播消息</h3><p>如果多个消费者在同一个消费者组，只有一个消费者可以收到同一个订阅的 topic 的消息。</p>
<p>如果 topic 进行了分区，那么一个 partition 只能被消费者组内的一个消费者消费，但消费者可以消费多个不同的 partition，而这些 partition 也可以被不同消费者组的消费者消费。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--consumer-property group.id:指定该消费者从属于哪个消费者组</span></span><br><span class="line">./kafka-console-consumer.sh --bootstrap-server kafka_id:9092 --consumer-property group.id=testgroup --topic test </span><br></pre></td></tr></table></figure>

<h3 id="2-4-多播消息"><a href="#2-4-多播消息" class="headerlink" title="2.4 多播消息"></a>2.4 多播消息</h3><p>如果多个不同消费者组中的消费者消费同一个订阅的 topic 的消息，那么这些消费者都可以消费同样的消息。</p>
<h3 id="2-5-查看消费者组信息"><a href="#2-5-查看消费者组信息" class="headerlink" title="2.5 查看消费者组信息"></a>2.5 查看消费者组信息</h3><ol>
<li>查看指定节点有哪些消费者组</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-consumer-groups.sh --bootstrap-server kafka_id:9092 --list</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看消费者组详细信息</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./kafka-consumer-groups.sh --bootstrap-server kafka_id:9092 --describe --group testgroup</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CURRENT-OFFSET:上次消费消息偏移量</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">LOG-END-OFFSET:当前topic最后消息偏移量</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">LAG:未消费信息的数量</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-kafka集群操作"><a href="#2-6-kafka集群操作" class="headerlink" title="2.6 kafka集群操作"></a>2.6 kafka集群操作</h3><ol>
<li>消息发送</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-producer.sh --broker-list kafka_01:9092 kafka_02:9092 kafka_03:9092 --topic test</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>消息消费</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server kafka_01:9092 kafka_02:9092 kafka_03:9092 --from-beginning --topic test</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>消费者组消费信息</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-consumer-groups.sh --bootstrap-server kafka_01:9092 kafka_02:9092 kafka_03:9092 --from-beginning --consumer-property group.id=testgroup --topic test</span><br></pre></td></tr></table></figure>



<h2 id="三、kafka优化"><a href="#三、kafka优化" class="headerlink" title="三、kafka优化"></a>三、kafka优化</h2><h3 id="3-1-如何防止消息丢失"><a href="#3-1-如何防止消息丢失" class="headerlink" title="3.1 如何防止消息丢失"></a>3.1 如何防止消息丢失</h3><ul>
<li>发送方：设置 ack 的值为 1 或 -1&#x2F;all</li>
<li>消费方：设置 offset 为手动提交</li>
</ul>
<h3 id="3-2-如何防止消息的重复消费"><a href="#3-2-如何防止消息的重复消费" class="headerlink" title="3.2 如何防止消息的重复消费"></a>3.2 如何防止消息的重复消费</h3><p>如果 broker 收到了消息并发送了 ack 给生产者，因为网络原因生产者在一定时间内没有收到 ack 就会进行消息的重新发送，这样 broker 就会有两条一样的消息，就可能会造成消费者重复消费。</p>
<p>在消费者端进行非幂等性（多次访问的结果是一样的）消费问题，就可以解决。</p>
<ul>
<li>方法一：在数据库中创建一个联合主键（id，uuid），这样只有联合主键匹配成功才能写入数据</li>
<li>方法二：使用分布式锁，例如 Redission.lock（uuid）</li>
</ul>
<h3 id="3-3-如何做到顺序消费"><a href="#3-3-如何做到顺序消费" class="headerlink" title="3.3 如何做到顺序消费"></a>3.3 如何做到顺序消费</h3><p>顺序消费的使用场景并不多，因为会牺牲较多的性能。</p>
<ul>
<li>发送方：ack 不能设置为 0（否则可能会丢失消息），关闭重试并使用同步发送（重试可能会导致消息重复，异步发送会导致消息发送顺序不一致），消息发送成功后才会发送下一条，以保证消息的顺序发送</li>
<li>消费方：消息都是发送到一个 partition 中，只能有一个消费者来消费该 partition 的消息</li>
</ul>
<h3 id="3-4-消息积压"><a href="#3-4-消息积压" class="headerlink" title="3.4 消息积压"></a>3.4 消息积压</h3><p>当消费者的消费速度远远跟不上生产者的消息生产速度，那么 kafka 中就会有大量的消息没有被消费，消费者寻址的性能也会越来越差，最后导致服务雪崩。</p>
<ul>
<li>方法一：使用多线程</li>
<li>方法二：创建多个消费者组和多个消费者，一起消费</li>
<li>方法三：创建一个消费者，该消费者新建一个 topic，并划分多个分区，多个分区再划分给多个消费者，这时候该消费者将消息拉取下来但不进行消费，而是放在新的 topic 上让多个消费者进行消费。</li>
</ul>
<h3 id="3-5-延时队列"><a href="#3-5-延时队列" class="headerlink" title="3.5 延时队列"></a>3.5 延时队列</h3><p>如果在订单创建成功后 30 分钟内没有付款，则自动取消订单，在这就可以通过延时队列来实现。</p>
<p>方法：</p>
<ul>
<li>kafka 创建相应 topic</li>
<li>消费者轮询消费该 topic 的消息</li>
<li>消费者判断该 topic 的创建时间与当前时间是否超过 30 分钟（前提是订单未支付）<ul>
<li>如果是：在数据库中修改订单状态为取消</li>
<li>如果不是：记录当前消息的 offset，并不再继续消费</li>
</ul>
</li>
</ul>
<h2 id="四、kafka-eagle监控平台"><a href="#四、kafka-eagle监控平台" class="headerlink" title="四、kafka-eagle监控平台"></a>四、kafka-eagle监控平台</h2><ol>
<li>下载 kafka-eagle</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://github.com/smartloli/kafka-eagle-bin/archive/v2.0.8.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改 system-config.properties</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zk地址</span></span><br><span class="line">efak.zk.cluster.alias=cluster1</span><br><span class="line">cluster1.zk.list=localhost:12181</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mysql地址</span></span><br><span class="line">efak.driver=com.mysql.cj.jdbc.Driver</span><br><span class="line">efak.url=jdbc:mysql://127.0.0.1:3306/ke?useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull</span><br><span class="line">efak.username=root</span><br><span class="line">efak.password=toortoor</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改环境变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.302.b08-0.el7_9.x86_64</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar.:$JAVA_HOME/lib/dt.jar.:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">export KE_HOME=/root/kafka/kafka-eagle/efak-web-2.0.8</span><br><span class="line">export PATH=$PATH:$KE_HOME/bin</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>访问</li>
</ol>
<p><img src="/2024/02/18/kafka/kafka-eagle.png" alt="kafka-eagle"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T10:56:08.018Z" title="2/18/2024, 6:56:08 PM">2024-02-18</time></span><span class="level-item">an hour read (About 7552 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/jenkins/">Jenkins</a></p><div class="content"><p><img src="/2024/02/18/jenkins/Jenkins%E5%9B%BE%E6%A0%87.png" alt="Jenkins图标"></p>
<p>Jenkins是一个开源的持续集成的服务器，Jenkins开源帮助我们自动构建各类项目。Jenkins强大的插件式，使得Jenkins可以集成很多软件，可能帮助我们持续集成我们的工程项目。</p>
<h2 id="一、什么是CI、CD"><a href="#一、什么是CI、CD" class="headerlink" title="一、什么是CI、CD"></a>一、什么是CI、CD</h2><p><img src="/2024/02/18/jenkins/devops.png" alt="devops"></p>
<p><strong>Devops</strong>也就是<strong>开发运维一体化</strong>，而随着Devops的兴起，出现了<strong>持续集成</strong>、<strong>持续交付</strong>以及<strong>持续部署</strong>的新方法，传统的软件开发和交付方法正在迅速变得过时。从历史上看，在敏捷时代，大多数公司会每月、每季度、每两年甚至每年发布部署或发布软件。然而，在DevOps时代，每周、每天、甚至每天多次。当SaaS正在占领世界时，我们可以轻松地动态更新应用程序，而无需强迫客户下载新组件。很多时候，他们甚至都不会意识到正在发生变化。开发团队通过软件交付流水线（Pipeline）实现自动化，以缩短交付周期，大多数团队都有自动化流程来检查代码并部署到新环境。</p>
<p><strong>持续集成</strong>的重点是将各个开发人员的工作集合到一个代码仓库中。通常，每天都要进行几次，主要目的是尽早发现集成错误，使团队更加紧密结合，更好地协作。</p>
<p><strong>持续交付</strong>的目的是最小化部署或释放过程中固有的摩擦。它的实现通常能够将构建部署的每个步骤自动化，以便任何时刻能够安全地完成代码发布（理想情况下）。</p>
<p><strong>持续部署</strong>是一种更高程度的自动化，无论何时对代码进行重大更改，都会自动进行构建&#x2F;部署。</p>
<p>而<strong>Jenkins</strong>就是来实现以上持续集成工作的服务器。</p>
<h2 id="二、持续集成环境搭建"><a href="#二、持续集成环境搭建" class="headerlink" title="二、持续集成环境搭建"></a>二、持续集成环境搭建</h2><p>Jenkins流程图：</p>
<p><img src="/2024/02/18/jenkins/Jenkins%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="Jenkins流程图"></p>
<h3 id="2-1-Gitlab代码托管服务器安装"><a href="#2-1-Gitlab代码托管服务器安装" class="headerlink" title="2.1 Gitlab代码托管服务器安装"></a>2.1 Gitlab代码托管服务器安装</h3><p><strong>Gitlab</strong> 是一个用于仓库管理系统的开源项目，使用Git作为代码管理工具，并在此基础上搭建起来的Web服务。</p>
<p><img src="/gitlab%E5%9B%BE%E6%A0%87.png" alt="gitlab图标"></p>
<ol>
<li>开启postfix服务（支持gitlab发信功能）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start postfix</span><br><span class="line">systemctl enable postfix</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置gitlab的yum源</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/gitlab-cd.repo</span><br><span class="line">[gitlab-ce]</span><br><span class="line">name=Gitlab CE Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装gitlab</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gitlab-ce</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改gitlab配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用户访问所使用的URL，域名或者IP地址</span></span><br><span class="line">external_url &#x27;http://192.168.88.133&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">时区</span></span><br><span class="line">gitlab_rails[&#x27;time_zone&#x27;] = &#x27;Asia/Shanghai&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启用SMTP邮箱功能</span></span><br><span class="line">gitlab_rails[&#x27;smtp_enable&#x27;] = &#x27;ture&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用SSH协议拉取代码所使用的连接端口</span></span><br><span class="line">gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = &#x27;22&#x27;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>刷新配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>启动服务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl restart</span><br><span class="line">gitlab-ctl status</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gitlab:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gitlab/gitlab-ce:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        external_url &#x27;http://192.168.88.30&#x27;</span></span><br><span class="line"><span class="string">        gitlab_rails[&#x27;time_zone&#x27;] = &#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"><span class="string">        gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = &#x27;22&#x27;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;23:22&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/root/cicd/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/root/cicd/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/root/cicd/gitlab/data:/var/opt/gitlab&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="8">
<li>进入容器查看默认用户名和修改密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rails console</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找root用户</span></span><br><span class="line">u=User.where(id:1).first</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改密码</span></span><br><span class="line">u.password=&#x27;toortoor&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确认修改密码</span></span><br><span class="line">u.password_confirmation=&#x27;toortoor&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保存修改</span></span><br><span class="line">u.save</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Gitlab创建组、用户、项目"><a href="#2-2-Gitlab创建组、用户、项目" class="headerlink" title="2.2 Gitlab创建组、用户、项目"></a>2.2 Gitlab创建组、用户、项目</h3><p>Gitlab创建组：</p>
<ol>
<li>添加组</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E7%BB%84%E4%B8%80.png" alt="gitlab创建组一"></p>
<ol start="2">
<li>设置组名和权限</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E7%BB%84%E4%BA%8C.png" alt="gitlab创建组二"></p>
<p>Gitlab创建用户：</p>
<ol>
<li>添加用户</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E4%B8%80.png" alt="gitlab创建用户一"></p>
<ol start="2">
<li>配置选项</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E4%BA%8C.png" alt="gitlab创建用户二"><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E4%B8%89.png" alt="gitlab创建用户三"></p>
<ol start="3">
<li>将用户添加到项目组</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%9B%9B.png" alt="gitlab创建用户四"></p>
<p>Gitlab创建项目：</p>
<ol>
<li>在指定组中添加项目</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E4%B8%80.png" alt="gitlab创建项目一"></p>
<ol start="2">
<li>设置项目名称</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlab%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E4%BA%8C.png" alt="gitlab创建项目二"></p>
<h3 id="2-5-项目上传到Gitlab"><a href="#2-5-项目上传到Gitlab" class="headerlink" title="2.5 项目上传到Gitlab"></a>2.5 项目上传到Gitlab</h3><ol>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%B8%80.png" alt="上传代码一"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%BA%8C.png" alt="上传代码二"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%B8%89.png" alt="上传代码三"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E5%9B%9B.png" alt="上传代码四"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%BA%94.png" alt="上传代码四"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E5%85%AD.png" alt="上传代码六"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%B8%83.png" alt="上传代码四"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E5%85%AB.png" alt="上传代码八"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%B9%9D.png" alt="上传代码九"></li>
<li><img src="/2024/02/18/jenkins/%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E5%8D%81.png" alt="上传代码十"></li>
</ol>
<h3 id="2-4-Jenkins安装"><a href="#2-4-Jenkins安装" class="headerlink" title="2.4 Jenkins安装"></a>2.4 Jenkins安装</h3><ol>
<li>安装JDK</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk*</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>放行端口</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=8888/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>添加Jenkins官方源并安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum -y install jenkins</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_USER=&quot;root&quot;</span><br><span class="line">JENKINS_PORT=&quot;8888&quot;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>查看初始密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /var/lib/jenkins/secrets/initialAdminPassword</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">jenkins:2.60.3</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8080:8080&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;50000:50000&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/root/cicd/jenkins/home:/var/jenkins_home&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-Jenkins中文插件安装"><a href="#2-5-Jenkins中文插件安装" class="headerlink" title="2.5 Jenkins中文插件安装"></a>2.5 Jenkins中文插件安装</h3><ol>
<li>由于Jenkins官方下载插件很慢，我们修改为国内Jenkins插件地址，jenkins -&gt; Manage jenkins -&gt; Manage Plugins</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E6%9B%B4%E6%8D%A2%E6%B8%85%E5%8D%8E%E6%8F%92%E4%BB%B6%E5%9C%B0%E5%9D%80.png" alt="更换清华插件地址"></p>
<ol>
<li>更换配置文件中的地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp /var/lib/jenkins/updates/default.json /var/lib/jenkins/updates/default.json.backup</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s/https:\/\/updates.jenkins.io\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#x27; /var/lib/jenkins/updates/default.json &amp;&amp; sed -i &#x27;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#x27; /var/lib/jenkins/updates/default.json</span><br><span class="line"></span><br><span class="line">systemctl restart jenkins</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装中文插件</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%87%E6%8F%92%E4%BB%B6.png" alt="安装中文插件"></p>
<h3 id="2-6-Jenkins用户权限管理"><a href="#2-6-Jenkins用户权限管理" class="headerlink" title="2.6 Jenkins用户权限管理"></a>2.6 Jenkins用户权限管理</h3><ol>
<li>由于Jenkins功能较为简介，都要靠安装插件来丰富体验，所以用户管理需要安装role-based插件</li>
</ol>
<p><img src="/2024/02/18/jenkins/role-based%E6%8F%92%E4%BB%B6%E4%B8%80.png" alt="role-based插件"></p>
<ol start="2">
<li>在Configure Global Security开启刚刚安装的插件</li>
</ol>
<p><img src="/2024/02/18/jenkins/role-based%E6%8F%92%E4%BB%B6%E4%BA%8C.png" alt="role-based插件二"></p>
<ol start="3">
<li>在Manage and Assign Roles中创建角色baserole并分配具体权限</li>
</ol>
<p><img src="/2024/02/18/jenkins/role-based%E6%8F%92%E4%BB%B6%E4%B8%89.png" alt="role-based插件三"></p>
<p><img src="/2024/02/18/jenkins/role-based%E6%8F%92%E4%BB%B6%E4%B8%89.png" alt="role-based插件三"></p>
<p><img src="/2024/02/18/jenkins/role-based%E6%8F%92%E4%BB%B6%E5%9B%9B.png" alt="role-based插件五"></p>
<ol start="4">
<li>用户没加入角色前是没有访问权限的，将用户加入到角色baserole即可，但只有部分权限</li>
</ol>
<p><img src="/2024/02/18/jenkins/role-based%E6%8F%92%E4%BB%B6%E4%BA%94.png" alt="role-based插件五"></p>
<p><img src="/2024/02/18/jenkins/role-based%E6%8F%92%E4%BB%B6%E5%85%AD.png" alt="role-based插件五"></p>
<h3 id="2-7-Jenkins安装凭证管理插件"><a href="#2-7-Jenkins安装凭证管理插件" class="headerlink" title="2.7 Jenkins安装凭证管理插件"></a>2.7 Jenkins安装凭证管理插件</h3><ol>
<li>安装Credential Binding插件，安装完就可以看到多了凭据的功能</li>
</ol>
<p><img src="/2024/02/18/jenkins/Credential-Binding%E6%8F%92%E4%BB%B6%E4%B8%80.png" alt="Credential-Binding插件一"></p>
<p><img src="/2024/02/18/jenkins/Credential-Binding%E6%8F%92%E4%BB%B6%E4%BA%8C.png" alt="Credential-Binding插件二"></p>
<h3 id="2-8-Jenkins普通用户密码认证"><a href="#2-8-Jenkins普通用户密码认证" class="headerlink" title="2.8 Jenkins普通用户密码认证"></a>2.8 Jenkins普通用户密码认证</h3><ol>
<li>为了Jenkins能够拉取gitlab的代码，需要安装git插件</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%89%E8%A3%85git%E6%8F%92%E4%BB%B6.png" alt="安装git插件"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install git</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建普通用户凭证，注意这里的用户是gitlab创建好的用户</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%88%9B%E5%BB%BA%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E5%87%AD%E8%AF%81.png" alt="创建普通用户凭证"></p>
<ol start="3">
<li>创建项目添加普通用户凭证</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E5%87%AD%E8%AF%81.png" alt="创建项目添加普通用户凭证"></p>
<ol start="4">
<li>build now构建</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E5%87%AD%E8%AF%81build%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE%E4%B8%80.png" alt="普通用户凭证build构建项目一"></p>
<ol>
<li>Jenkins主机上查看是否构建成功</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E5%87%AD%E8%AF%81build%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE%E4%BA%8C.png" alt="普通用户凭证build构建项目二"></p>
<h3 id="2-9-Jenkins使用ssh免密认证"><a href="#2-9-Jenkins使用ssh免密认证" class="headerlink" title="2.9 Jenkins使用ssh免密认证"></a>2.9 Jenkins使用ssh免密认证</h3><ol>
<li>在Jenkins主机上生产公钥私钥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在gitlab上添加公钥</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%9C%A8gitlab%E4%B8%8A%E6%B7%BB%E5%8A%A0%E5%85%AC%E9%92%A5.png" alt="在gitlab上添加公钥"></p>
<ol start="3">
<li>在Jenkins上添加ssh凭证</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%9C%A8Jenkins%E4%B8%8A%E6%B7%BB%E5%8A%A0ssh%E5%87%AD%E8%AF%81.png" alt="在Jenkins上添加ssh凭证"></p>
<ol start="4">
<li>创建项目添加ssh凭证</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0ssh%E5%87%AD%E8%AF%81.png" alt="创建项目添加ssh凭证"></p>
<ol start="5">
<li>build now构建项目后</li>
</ol>
<p><img src="/2024/02/18/jenkins/ssh%E5%87%AD%E8%AF%81build%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE.png" alt="ssh凭证build构建项目"></p>
<h3 id="2-10-Jenkins安装Maven"><a href="#2-10-Jenkins安装Maven" class="headerlink" title="2.10 Jenkins安装Maven"></a>2.10 Jenkins安装Maven</h3><ol>
<li>下载maven</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.bfsu.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span><br><span class="line">mkdir maven</span><br><span class="line">tar -xf apache-maven-3.6.3-bin.tar.gz</span><br><span class="line">cp apache-maven-3.6.3-bin.tar.gz/* maven/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置环境变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk</span><br><span class="line">export MAVEN_HOME=/root/maven</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin:/$MAVEN_HOME/bin</span><br><span class="line">source /etc/profile</span><br><span class="line">mvn -v</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>全局工具配置里新增jdk和maven</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E6%96%B0%E5%A2%9Ejdk.png" alt="新增jdk"></p>
<p><img src="/2024/02/18/jenkins/%E6%96%B0%E5%A2%9Emaven.png" alt="新增maven"></p>
<ol start="4">
<li>在系统配置里添加三个变量</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E6%96%B0%E5%A2%9E%E5%8F%98%E9%87%8F.png" alt="新增变量"></p>
<ol start="5">
<li>修改maven配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/repo</span><br><span class="line">vim /root/maven/conf/settings.xml</span><br><span class="line">&lt;localRepository&gt;/root/repo&lt;/localRepository&gt;</span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">  &lt;id&gt;aliyunmaven&lt;/id&gt;</span><br><span class="line">  &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">  &lt;name&gt;阿里云公共仓库&lt;/name&gt;</span><br><span class="line">  &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;</span><br><span class="line">&lt;/mirror&gt;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>测试maven构建项目</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E6%B5%8B%E8%AF%95maven%E4%B8%80.png" alt="测试maven一"></p>
<p><img src="/2024/02/18/jenkins/%E6%B5%8B%E8%AF%95maven%E4%BA%8C.png" alt="测试maven二"></p>
<h3 id="2-11-Tomcat安装和配置"><a href="#2-11-Tomcat安装和配置" class="headerlink" title="2.11 Tomcat安装和配置"></a>2.11 Tomcat安装和配置</h3><ol>
<li>安装jdk和tomcat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk*</span><br><span class="line">wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.43/bin/apache-tomcat-9.0.43.tar.gz</span><br><span class="line">tar -xf apache-tomcat-9.0.43.tar.gz</span><br><span class="line">mkdir /root/tomcat</span><br><span class="line">mv apache-tomcat-9.0.43.tar.gz/* /root/tomcat</span><br><span class="line">./root/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加tomcat管理用户</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /root/tomcat/conf/tomcat-users.xml</span><br><span class="line">  &lt;role rolename=&quot;tomcat&quot;/&gt;</span><br><span class="line">  &lt;role rolename=&quot;role1&quot;/&gt;</span><br><span class="line">  &lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">  &lt;role rolename=&quot;manager-script&quot;/&gt;</span><br><span class="line">  &lt;role rolename=&quot;admin-gui&quot;/&gt;</span><br><span class="line">  &lt;role rolename=&quot;admin-script&quot;/&gt;</span><br><span class="line">  &lt;role rolename=&quot;manager-status&quot;/&gt;</span><br><span class="line">  &lt;user username=&quot;tomcat&quot; password=&quot;toortoor&quot; roles=&quot;manager-gui,manager-script,tomcat,admin-gui,admin-script&quot;/&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /root/tomcat/webapps/manager/META-INF/context.xml</span><br><span class="line">&lt;!--</span><br><span class="line">  &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span><br><span class="line">         allow=&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot; /&gt;</span><br><span class="line"><span class="meta prompt_">--&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/jenkins/tomcat%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="tomcat安装一"></p>
<p><img src="/2024/02/18/jenkins/tomcat%E5%AE%89%E8%A3%85%E4%BA%8C.png" alt="tomcat安装二"></p>
<h2 id="三、Jenkins构建项目"><a href="#三、Jenkins构建项目" class="headerlink" title="三、Jenkins构建项目"></a>三、Jenkins构建项目</h2><p>Jenkins构建的项目类型主要为以下三种：</p>
<ol>
<li>自由风格软件项目（freestyle project）</li>
<li>Maven项目（maven project）</li>
<li>流水线项目（pipeline project）</li>
</ol>
<h3 id="3-1-自由风格软件项目构建"><a href="#3-1-自由风格软件项目构建" class="headerlink" title="3.1 自由风格软件项目构建"></a>3.1 自由风格软件项目构建</h3><ol>
<li><p>要将项目部署到tomcat服务器上，需要安装deploy to container插件</p>
</li>
<li><p>Jenkins -&gt; 新建items</p>
</li>
</ol>
<p><img src="/2024/02/18/jenkins/freestyle%E4%B8%80.png" alt="freestyle一"></p>
<ol start="3">
<li>使用ssh免密登录来拉取代码</li>
</ol>
<p><img src="/2024/02/18/jenkins/freestyle%E4%BA%8C.png" alt="freestyle二"></p>
<ol start="4">
<li>使用maven编译打包</li>
</ol>
<p><img src="/2024/02/18/jenkins/freestyle%E5%9B%9B.png" alt="freestyle四"></p>
<ol start="5">
<li>部署</li>
</ol>
<p><img src="/2024/02/18/jenkins/freestyle%E4%BA%94.png" alt="freestyle五"></p>
<ol start="6">
<li>再次构建后可以回到tomcat查看是否部署成功</li>
</ol>
<p><img src="/2024/02/18/jenkins/freestyle%E5%85%AD.png" alt="freestyle六"></p>
<h3 id="3-2-Maven项目构建"><a href="#3-2-Maven项目构建" class="headerlink" title="3.2 Maven项目构建"></a>3.2 Maven项目构建</h3><ol>
<li><p>安装Maven Integration插件</p>
</li>
<li><p>创建maven项目</p>
</li>
</ol>
<p><img src="/2024/02/18/jenkins/maven%E4%B8%80.png" alt="maven一"></p>
<ol start="3">
<li>构建设置，其余设置都相同</li>
</ol>
<p><img src="/2024/02/18/jenkins/maven%E4%BA%8C.png" alt="maven二"></p>
<ol start="4">
<li>构建后查看是否部署成功</li>
</ol>
<p><img src="/2024/02/18/jenkins/maven%E4%B8%89.png" alt="maven三"></p>
<h3 id="3-3-Pipeline-project简介"><a href="#3-3-Pipeline-project简介" class="headerlink" title="3.3 Pipeline project简介"></a>3.3 Pipeline project简介</h3><p>pipeline就是一套运行在Jenkins上的工作流框架，将独立运行的单个或多个节点的任务连接起来，实现复杂流程的编排和可视化的工作。</p>
<p>优点有：</p>
<ul>
<li>自动地为所有分支创建流水线构建过程并拉取请求。</li>
<li>在流水线上代码复查&#x2F;迭代 (以及剩余的源代码)。</li>
<li>对流水线进行审计跟踪。</li>
<li>该流水线的真正的源代码，可以被项目的多个成员查看和编辑。</li>
</ul>
<h3 id="3-4-Pipeline流水线项目构建"><a href="#3-4-Pipeline流水线项目构建" class="headerlink" title="3.4 Pipeline流水线项目构建"></a>3.4 Pipeline流水线项目构建</h3><ol>
<li>安装pipeline插件</li>
<li>新建流水线项目</li>
</ol>
<p><img src="/2024/02/18/jenkins/pipeline%E4%B8%80.png" alt="pipeline一"></p>
<p><strong>声明式流水线</strong></p>
<ol>
<li><p><img src="/2024/02/18/jenkins/pipeline%E4%BA%8C.png" alt="pipeline二"></p>
</li>
<li><p><img src="/2024/02/18/jenkins/pipeline%E4%B8%89.png" alt="pipeline三"></p>
</li>
<li><p><img src="/2024/02/18/jenkins/pipeline%E5%9B%9B.png" alt="pipeline四"></p>
</li>
<li><p><img src="/2024/02/18/jenkins/pipeline%E4%BA%94.png" alt="pipeline五"></p>
</li>
<li><p><img src="/2024/02/18/jenkins/pipeline%E5%85%AD.png" alt="pipeline六"></p>
</li>
<li><p><img src="/2024/02/18/jenkins/pipeline%E4%B8%83.png" alt="pipeline七"></p>
</li>
</ol>
<h3 id="3-5-Jenkinsfile脚本文件"><a href="#3-5-Jenkinsfile脚本文件" class="headerlink" title="3.5 Jenkinsfile脚本文件"></a>3.5 Jenkinsfile脚本文件</h3><p>pipeline脚本内容放在Jenkins服务器不好管理，所以就在项目添加一个Jenkinsfile文件并推送到gitlab上，实现直接拉取执行。</p>
<ol>
<li>在项目下添加一个Jenkinsfile，将pipeline内容复制进去并推送到gitlab上</li>
</ol>
<p><img src="/2024/02/18/jenkins/Jenkinsfile%E4%B8%80.png" alt="Jenkinsfile一"></p>
<ol start="2">
<li>在pipeline项目中修改为在gitlab拉取Jenkinsfile文件</li>
</ol>
<p><img src="/2024/02/18/jenkins/Jenkinsfile%E4%BA%8C.png" alt="Jenkinsfile二"></p>
<h2 id="四、Jenkins构建细节"><a href="#四、Jenkins构建细节" class="headerlink" title="四、Jenkins构建细节"></a>四、Jenkins构建细节</h2><h3 id="4-1-Jenkins常用的构建触发器"><a href="#4-1-Jenkins常用的构建触发器" class="headerlink" title="4.1 Jenkins常用的构建触发器"></a>4.1 Jenkins常用的构建触发器</h3><p>Jenkins内置4种构建触发器：</p>
<ul>
<li>触发远程构建</li>
<li>其它工程构建后触发</li>
<li>定时构建</li>
<li>轮询SCM</li>
</ul>
<h3 id="4-2-触发远程构建"><a href="#4-2-触发远程构建" class="headerlink" title="4.2 触发远程构建"></a>4.2 触发远程构建</h3><ol>
<li>在项目中设置触发器</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E8%A7%A6%E5%8F%91%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E4%B8%80.png" alt="触发远程构建一"></p>
<ol start="2">
<li>在浏览器输入JENKINS_URL<code>/job/pipeline-project/build?token=</code>TOKEN_NAME即可触发</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E8%A7%A6%E5%8F%91%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E4%BA%8C.png" alt="触发远程构建二"></p>
<h3 id="4-3-其它工程构建后触发"><a href="#4-3-其它工程构建后触发" class="headerlink" title="4.3 其它工程构建后触发"></a>4.3 其它工程构建后触发</h3><p>是指某一工程构建后才会触发构建，这里测试freestyle工程构建后触发pipeline构建</p>
<ol>
<li>在pipeline配置构建后触发</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E6%9E%84%E5%BB%BA%E5%90%8E%E8%A7%A6%E5%8F%91%E4%B8%80.png" alt="构建后触发一"></p>
<ol start="2">
<li>freestyle工程构建后就会触发pipeline构建</li>
</ol>
<h3 id="4-4-定时构建"><a href="#4-4-定时构建" class="headerlink" title="4.4 定时构建"></a>4.4 定时构建</h3><p>五个*分别代表分时日月周，H&#x2F;2则代表每分时日月周</p>
<p><img src="/2024/02/18/jenkins/%E5%AE%9A%E6%97%B6%E6%9E%84%E5%BB%BA%E4%B8%80.png" alt="定时构建一"></p>
<h3 id="4-5-轮询SCM"><a href="#4-5-轮询SCM" class="headerlink" title="4.5 轮询SCM"></a>4.5 轮询SCM</h3><p>和定时构建一样是设置时间来进行构建，不过轮询只有在代码仓库发生变化后才会触发，相当于定时检查</p>
<p>注意：轮询会定时扫描仓库的代码，增大系统的开销，不建议使用</p>
<p><img src="/2024/02/18/jenkins/%E8%BD%AE%E8%AF%A2SCM%E4%B8%80.png" alt="轮询SCM一"></p>
<h3 id="4-6-Gitlab-Hook自动触发构建"><a href="#4-6-Gitlab-Hook自动触发构建" class="headerlink" title="4.6 Gitlab Hook自动触发构建"></a>4.6 Gitlab Hook自动触发构建</h3><p>SCM轮询是Jenkins服务器主动检测gitlab中的代码有没有发生变化，而gitlab的webhook可以实现代码变更后向Jenkins服务器主动发送构建请求，实现自动构建。</p>
<ol>
<li>在Jenkins安装gitlab和gitlab hook插件</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlabhook%E4%B8%80.png" alt="gitlabhook一"></p>
<ol start="2">
<li>在gitlab配置中允许发出请求</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlabhook%E4%BA%8C.png" alt="gitlabhook二"></p>
<ol start="3">
<li>在项目中添加第一步中的地址</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlabhook%E4%B8%89.png" alt="gitlabhook三"></p>
<ol start="4">
<li>配置Jenkins允许接受gitlab发送过来的请求</li>
</ol>
<p><img src="/2024/02/18/jenkins/gitlabhook%E5%9B%9B.png" alt="gitlabhook四"></p>
<h3 id="4-7-Jenkins参数化构建"><a href="#4-7-Jenkins参数化构建" class="headerlink" title="4.7 Jenkins参数化构建"></a>4.7 Jenkins参数化构建</h3><p>前边实操演示的都是默认从master下拉取代码，如果要实现在其他分支拉取代码，就需要设置参数化构建。</p>
<ol>
<li>在Jenkins的项目中添加参数，这里选择字符串参数</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B8%80.png" alt="参数化构建一"></p>
<ol start="2">
<li>修改Jenkinsfile文件中拉取代码部分的master为变量，并推送到gitlab</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA%E4%BA%8C.png" alt="参数化构建二"></p>
<ol start="3">
<li>在项目中添加一个v1分支</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B8%89.png" alt="参数化构建三"></p>
<p><img src="/2024/02/18/jenkins/%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA%E5%9B%9B.png" alt="参数化构建四"></p>
<ol start="4">
<li>在Jenkins中拉取v1代码构建</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA%E4%BA%94.png" alt="参数化构建五"></p>
<p><img src="/2024/02/18/jenkins/%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA%E5%85%AD.png" alt="参数化构建六"></p>
<h3 id="4-8-配置邮件服务器发送构建结果"><a href="#4-8-配置邮件服务器发送构建结果" class="headerlink" title="4.8 配置邮件服务器发送构建结果"></a>4.8 配置邮件服务器发送构建结果</h3><ol>
<li><p>安装Email Extension插件</p>
</li>
<li><p>在Jenkins中配置</p>
</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%9C%E4%B8%80.png" alt="配置邮件服务器发送构建结果一"><img src="/2024/02/18/jenkins/%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%9C%E4%BA%8C.png" alt="配置邮件服务器发送构建结果二"></p>
<p><img src="/2024/02/18/jenkins/%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%9C%E4%B8%89.png" alt="配置邮件服务器发送构建结果三"></p>
<p><img src="/2024/02/18/jenkins/%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%9C%E5%9B%9B.png" alt="配置邮件服务器发送构建结果四"></p>
<ol start="3">
<li>在项目中创建一个email.html文件，添加以下内容并推送到gitlab中</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>$&#123;PROJECT_NAME&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">leftmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span> <span class="attr">topmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginheight</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">&quot;95%&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">style</span>=<span class="string">&quot;font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>(本邮件是程序自动下发的，请勿回复！)<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0000FF&quot;</span>&gt;</span>构建结果 - $&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">h2</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>构建信息<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目名称 ： $&#123;PROJECT_NAME&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建编号 ： 第$&#123;BUILD_NUMBER&#125;次构建<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>触发原因： $&#123;CAUSE&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建日志： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;console&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;console<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建  Url ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>工作目录 ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;ws&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;ws<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目  Url ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>Changes Since Last Successful Build:<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>历史变更记录 : <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;changes&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;changes<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span> $&#123;CHANGES_SINCE_LAST_SUCCESS,reverse=true, format=&quot;Changes for Build #%n:<span class="tag">&lt;<span class="name">br</span> /&gt;</span>%c<span class="tag">&lt;<span class="name">br</span> /&gt;</span>&quot;,showPaths=true,changesFormat=&quot;<span class="tag">&lt;<span class="name">pre</span>&gt;</span>[%a]<span class="tag">&lt;<span class="name">br</span> /&gt;</span>%m<span class="tag">&lt;/<span class="name">pre</span>&gt;</span>&quot;,pathFormat=&quot;    %p&quot;&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>构建情况总览:<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span>$&#123;TEST_COUNTS,var=&quot;fail&quot;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">cols</span>=<span class="string">&quot;80&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;30&quot;</span> <span class="attr">readonly</span>=<span class="string">&quot;readonly&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;font-family: Courier New&quot;</span>&gt;</span>$&#123;BUILD_LOG,maxLines=23&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在Jenkinsfile中添加发送email功能，post即指构建后操作</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">post &#123;</span><br><span class="line">	always &#123;</span><br><span class="line">		emailext(</span><br><span class="line">			subject: &#x27;构建通知：$&#123;PROJECT_NAME&#125; - Build # $&#123;BUILD_NUMBER&#125; - $&#123;BUILD_STATUS&#125;!&#x27;,</span><br><span class="line">			body: &#x27;$&#123;FILE,path=&quot;email.html&quot;&#125;&#x27;,</span><br><span class="line">			to: &#x27;chenqiming13@qq.com&#x27;</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>构建测试是否收到邮件</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%9C%E4%BA%94.png" alt="配置邮件服务器发送构建结果五"></p>
<h2 id="五、Jenkins-SonarQube代码审查"><a href="#五、Jenkins-SonarQube代码审查" class="headerlink" title="五、Jenkins+SonarQube代码审查"></a>五、Jenkins+SonarQube代码审查</h2><p><img src="/sonarqube%E5%9B%BE%E6%A0%87.png" alt="sonarqube图标"></p>
<p>sonarqube是一个用于管理代码质量的开放平台，可以快速定位代码中潜在的错误。</p>
<p>环境要求：</p>
<ol>
<li>JDK11</li>
<li>PostgreSQL</li>
</ol>
<h3 id="5-1-安装PostgreSQL"><a href="#5-1-安装PostgreSQL" class="headerlink" title="5.1 安装PostgreSQL"></a>5.1 安装PostgreSQL</h3><ol>
<li>新版本的sonarqube不再支持MySQL，所以在Jenkins服务器上安装PostgreSQL并创建一个sonar数据库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装postgresql</span></span><br><span class="line">yum -y install https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">yum -y install postgresql96-server postgresql96-contrib</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化postgresql</span></span><br><span class="line">postgresql-9.6-setup initdb</span><br><span class="line">systemctl enable postgresql-9.6.service</span><br><span class="line">systemctl start postgresql-9.6.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化之后会自动创建postgres用户，切换用户</span></span><br><span class="line">su - postgres</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">psql进入命令行模式配，\q退出</span></span><br><span class="line">psql</span><br><span class="line">alter user postgres with password &#x27;toortoor&#x27;;</span><br><span class="line">create database sonar;</span><br><span class="line">create user sonar;</span><br><span class="line">alter user sonar with password &#x27;toortoor&#x27;;</span><br><span class="line">alter role sonar createdb;</span><br><span class="line">alter role sonar superuser;</span><br><span class="line">alter role sonar createrole;</span><br><span class="line">alter database sonar owner to sonar;</span><br><span class="line">\q</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/jenkins/postgresql%E4%B8%80.png" alt="postgresql一"></p>
<ol start="2">
<li>开启远程访问和远程连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/pgsql/9.6/data/postgresql.conf</span><br><span class="line">listen_addresses = &#x27;*&#x27;</span><br><span class="line">vim /var/lib/pgsql/9.6/data/pg_hba.conf</span><br><span class="line">host    all             all             127.0.0.1/32            trust</span><br><span class="line">host    all             all             192.168.88.1/32         trust</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>重启服务</li>
</ol>
<h3 id="5-2-安装SonarQube"><a href="#5-2-安装SonarQube" class="headerlink" title="5.2 安装SonarQube"></a>5.2 安装SonarQube</h3><ol>
<li>安装sonarqube</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-8.7.1.42226.zip</span><br><span class="line">unzip sonarqube-8.7.1.42226.zip</span><br><span class="line">mv sonarqube-8.7.1.42226 sonarqube</span><br><span class="line">useradd sonar</span><br><span class="line">chown -R sonar:sonar sonarqube/*</span><br><span class="line">mv sonarqube /opt/sonarqube</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改sonar配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim sonarqube/conf/sonar.properties</span><br><span class="line">sonar.jdbc.username=sonar</span><br><span class="line">sonar.jdbc.password=toortoor</span><br><span class="line">sonar.jdbc.url=jdbc:postgresql://localhost/sonarqube?currentSchema=my_schema</span><br><span class="line">sonar.jdbc.url=jdbc:postgresql://localhost/sonar?currentSchema=public</span><br><span class="line">sonar.web.port=9000</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动sonarqube</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">只能用sonar用户启动</span></span><br><span class="line">su sonar</span><br><span class="line">./opt/sonarqube/bin/linux-x86-64/sonar.sh start</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>遇到的问题</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sonar用户线程数不够，*代表所有用户</span></span><br><span class="line">cat /etc/security/limits.conf</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft noproc 65535</span><br><span class="line">* hard noproc 65535</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>deploy.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sonarqube</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">sonarqube</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">sonarqube</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-sysctl</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sysctl&quot;</span>, <span class="string">&quot;-w&quot;</span>, <span class="string">&quot;vm.max_map_count=262144&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">sonarqube:lts-community</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9000</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># 此处用到了集群现有的pg</span></span><br><span class="line">        <span class="comment"># 数据库用户sonarqube</span></span><br><span class="line">        <span class="comment"># 数据库名sonarqube</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SONARQUBE_JDBC_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;sonarqube&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SONARQUBE_JDBC_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;dangerous&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SONARQUBE_JDBC_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;jdbc:postgresql://dcs-installer-gitlab-postgresql.dcs-system:5432/sonarqube&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sessions/new</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sessions/new</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2048Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sonarqube</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-Jenkins整合SonarQube"><a href="#5-3-Jenkins整合SonarQube" class="headerlink" title="5.3 Jenkins整合SonarQube"></a>5.3 Jenkins整合SonarQube</h3><p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E4%B8%80.png" alt="实现代码审查一"></p>
<ol>
<li>安装sonarqube scanner插件</li>
<li>在Jenkins安装sonarqube scanner</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E4%BA%8C.png" alt="实现代码审查二"></p>
<ol start="3">
<li>在sonarqube中生成密钥</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E4%B8%89.png" alt="实现代码审查二"></p>
<ol start="4">
<li>在系统配置中配置sonarqube server，利用刚刚生成的密钥</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E4%BA%94.png" alt="实现代码审查五"></p>
<p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E5%85%AD.png" alt="实现代码审查六"></p>
<h3 id="5-4-实现代码审查"><a href="#5-4-实现代码审查" class="headerlink" title="5.4 实现代码审查"></a>5.4 实现代码审查</h3><p><strong>非流水线项目添加代码审查</strong></p>
<ol>
<li>在项目中添加构建步骤</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E4%B8%83.png" alt="实现代码审查七"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Must be unique in a given SonarQube instance</span></span><br><span class="line"><span class="comment"># SonarQube创建项目时的key</span></span><br><span class="line"><span class="attr">sonar.projectKey</span>=<span class="string">freestyle_project</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#This is the name and version displayed in the SonarQube UI.</span></span><br><span class="line"><span class="comment"># 项目名称</span></span><br><span class="line"><span class="attr">sonar.projectName</span>=<span class="string">freestyle_project</span></span><br><span class="line"><span class="comment"># 项目版本</span></span><br><span class="line"><span class="attr">sonar.projectVersion</span>=<span class="string">1.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#Path is relative to the sonar-project.properties file.</span></span><br><span class="line"><span class="comment">#This property is optional if sonar.modules is set.</span></span><br><span class="line"><span class="attr">sonar.sources</span>=<span class="string">.</span></span><br><span class="line"><span class="comment"># 忽略扫描的目录</span></span><br><span class="line"><span class="attr">sonar.exclusions</span>=<span class="string">**/test/**,**/target/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sonar.java.source</span>=<span class="string">11</span></span><br><span class="line"><span class="attr">sonar.java.target</span>=<span class="string">11</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#Encoding of the source code.Default is default system encoding.</span></span><br><span class="line"><span class="attr">sonar.sourceEncoding</span>=<span class="string">UTF-8</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>构建项目</li>
<li>回到sonarqube就可以看到提交的代码审查了</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E5%85%AB.png" alt="实现代码审查八"></p>
<p><strong>流水线项目添加代码审查</strong></p>
<ol>
<li>在项目中创建sonar-project.properties</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Must be unique in a given SonarQube instance</span></span><br><span class="line"><span class="attr">sonar.projectKey</span>=<span class="string">pipeline_project</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#This is the name and version displayed in the SonarQube UI.</span></span><br><span class="line"><span class="attr">sonar.projectName</span>=<span class="string">pipeline_project</span></span><br><span class="line"><span class="attr">sonar.projectVersion</span>=<span class="string">1.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#Path is relative to the sonar-project.properties file.</span></span><br><span class="line"><span class="comment">#This property is optional if sonar.modules is set.</span></span><br><span class="line"><span class="attr">sonar.sources</span>=<span class="string">.</span></span><br><span class="line"><span class="attr">sonar.exclusions</span>=<span class="string">**/test/**,**/target/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sonar.java.source</span>=<span class="string">11</span></span><br><span class="line"><span class="attr">sonar.java.target</span>=<span class="string">11</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#Encoding of the source code.Default is default system encoding.</span></span><br><span class="line"><span class="attr">sonar.sourceEncoding</span>=<span class="string">UTF-8</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改Jenkinsfile文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stage(&#x27;code checking&#x27;)&#123;</span><br><span class="line">	steps &#123;</span><br><span class="line">		script &#123;</span><br><span class="line">			//引入scanner工具</span><br><span class="line">			scannerHome = tool &#x27;sonar-scanner&#x27;</span><br><span class="line">		&#125;</span><br><span class="line">		//引入sonarqube服务器环境</span><br><span class="line">		withSonarQubeEnv(&#x27;sonarqube&#x27;) &#123;</span><br><span class="line">			sh &quot;$&#123;scannerHome&#125;/bin/sonar-scanner&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将Jenkinsfile和sonar-project.properties推送到gitlab</li>
<li>构建项目后在sonarqube就可以看到代码审查了</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%E4%B9%9D.png" alt="实现代码审查九"></p>
<h2 id="六、Jenkins-Docker-SpringCloud微服务持续集成"><a href="#六、Jenkins-Docker-SpringCloud微服务持续集成" class="headerlink" title="六、Jenkins+Docker+SpringCloud微服务持续集成"></a>六、Jenkins+Docker+SpringCloud微服务持续集成</h2><p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" alt="微服务架构"></p>
<p>大致流程：</p>
<ol>
<li>开发人员push代码到gitlab。</li>
<li>Jenkins服务器进行编译打包并构建镜像推送到harbor镜像仓库（服务器的JAVA环境要与项目对应）。</li>
<li>Jenkins服务器触发远程命令使生产服务器（tomcat）从私有仓库拉取镜像。</li>
<li>生产服务器（tomcat）生成容器，项目上线。</li>
<li>用户访问。</li>
</ol>
<h3 id="6-1-Harbor部署"><a href="#6-1-Harbor部署" class="headerlink" title="6.1 Harbor部署"></a>6.1 Harbor部署</h3><ol>
<li>下载</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://github.com/goharbor/harbor/releases/download/v2.3.4/harbor-offline-installer-v2.3.4.tgz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改 harbor.yml</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cp harbor.yml.tmpl harbor.yml</span><br><span class="line">egrep -v &#x27;^#|^$|*#&#x27; harbor.yml</span><br><span class="line">hostname: 192.168.88.30</span><br><span class="line">http:</span><br><span class="line">  port: 81</span><br><span class="line">harbor_admin_password: toortoor</span><br><span class="line">database:</span><br><span class="line">  password: toortoor</span><br><span class="line">  max_idle_conns: 100</span><br><span class="line">  max_open_conns: 900</span><br><span class="line">data_volume: /root/cicd/harbor/data</span><br><span class="line">trivy:</span><br><span class="line">  ignore_unfixed: false</span><br><span class="line">  skip_update: false</span><br><span class="line">  insecure: false</span><br><span class="line">jobservice:</span><br><span class="line">  max_job_workers: 10</span><br><span class="line">notification:</span><br><span class="line">  webhook_job_max_retry: 10</span><br><span class="line">chart:</span><br><span class="line">  absolute_url: disabled</span><br><span class="line">log:</span><br><span class="line">  level: info</span><br><span class="line">  local:</span><br><span class="line">    rotate_count: 50</span><br><span class="line">    rotate_size: 200M</span><br><span class="line">    location: /root/cicd/harbor/var</span><br><span class="line">_version: 2.3.0</span><br><span class="line">proxy:</span><br><span class="line">  http_proxy:</span><br><span class="line">  https_proxy:</span><br><span class="line">  no_proxy:</span><br><span class="line">  components:</span><br><span class="line">    - core</span><br><span class="line">    - jobservice</span><br><span class="line">    - trivy</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>docker-compose.yaml 文件中指定 harbor 访问端口为 80，避免与 gitlab 冲突， 修改为 81</p>
</li>
<li><p>通过脚本部署</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./prepare</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>创建私有仓库</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E4%B8%80.png" alt="微服务CICD一"></p>
<ol start="6">
<li>修改 daemon.json，让 docker 信任此仓库</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://5v5rh037.mirror.aliyuncs.com&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;192.168.88.30:81&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>登录远程镜像仓库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u admin -p toortoor 192.168.88.30:81</span><br></pre></td></tr></table></figure>

<h3 id="6-2-提交代码到Gitlab"><a href="#6-2-提交代码到Gitlab" class="headerlink" title="6.2 提交代码到Gitlab"></a>6.2 提交代码到Gitlab</h3><p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E4%BA%8C.png" alt="微服务CICD二"></p>
<h3 id="6-3-Jenkins创建流水线工程"><a href="#6-3-Jenkins创建流水线工程" class="headerlink" title="6.3 Jenkins创建流水线工程"></a>6.3 Jenkins创建流水线工程</h3><ol>
<li>创建工程</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E4%B8%89.png" alt="微服务CICD三"></p>
<hr>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%9B%9B.png" alt="微服务CICD四"></p>
<hr>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E4%B8%83.png" alt="微服务CICD七"></p>
<ol start="2">
<li>在项目根目录下创建 Jenkinsfile，通过语法生成器进行编写</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E4%BA%94.png" alt="微服务CICD五"></p>
<ol start="3">
<li>Jenkinsfile 拉取代码部分</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%85%AD.png" alt="微服务CICD六"></p>
<ol start="4">
<li>在流水线工程中创建参数，如果有多个服务就可以根据参数选择进行构建</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E4%B8%80.png" alt="微服务CICD十一"></p>
<ol start="5">
<li>Jenkinsfile 添加编译打包微服务工程部分，以及通过 Dockerfile 构建镜像部分</li>
</ol>
<ul>
<li>在 pom.xml 中添加 Dockerfile 依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="name">JAR_NAME</span>&gt;</span>target/$&#123;project.build.finalname&#125;.jar<span class="tag">&lt;/<span class="name">JAR_NAME</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在项目根目录添加 Dockerfile</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11</span></span><br><span class="line"><span class="keyword">ARG</span> JAR_NAME</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/myapp</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./<span class="variable">$&#123;JAR_NAME&#125;</span> /usr/src/myapp/</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/usr/src/myapp/<span class="variable">$&#123;JAR_NAME&#125;</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Jenkinsfile 添加上传镜像至 Harbor 部分</li>
</ol>
<ul>
<li>在 Jenkins 中添加 Harbor 账户凭证，以便于上传代码，这里用到的是 Harbor 的用户名和密码</li>
</ul>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%85%AB.png" alt="微服务CICD八"></p>
<ul>
<li>保留好凭证ID</li>
</ul>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E4%B9%9D.png" alt="微服务CICD九"></p>
<ul>
<li>在语法生成器中生成新语法用于登录 Harbor 仓库</li>
</ul>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81.png" alt="微服务CICD十"></p>
<ol start="7">
<li>Jenkins 安装 Publish Over SSH 插件，能够对远程主机发送 shell 命令，安装完后先给远程主机发送公钥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id root@192.168.88.30</span><br></pre></td></tr></table></figure>

<ul>
<li>发送完后在系统配置进行配置</li>
</ul>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E4%BA%8C.png" alt="微服务CICD十二"></p>
<hr>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E4%B8%89.png" alt="微服务CICD十三"></p>
<ul>
<li>接着生成流水线语法，去远程执行脚本文件 <code>test.sh</code></li>
</ul>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E5%9B%9B.png" alt="微服务CICD十四"></p>
<p><strong>test.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">harbor_url=$1</span><br><span class="line">project_name=$2</span><br><span class="line">image_name=$3</span><br><span class="line">service_port=$4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除none容器</span></span><br><span class="line">echo &quot;docker rmi none...&quot;</span><br><span class="line">docker images | grep none | awk &#x27;&#123; print &quot;docker rmi &quot;$3 &#125;&#x27; | sh &amp;&gt;/dev/null</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查是否有已运行容器</span></span><br><span class="line">num=`docker ps | grep $project_name | wc -l`</span><br><span class="line">if [ $num -gt 0 ]</span><br><span class="line">then</span><br><span class="line">    docker stop $project_name &amp;&amp; docker rm $project_name &amp;&gt;/dev/null</span><br><span class="line">    if [ `echo $?` -eq 0 ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;docker stop $project_name &amp;&amp; docker rm $project_name [OK]&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;ERROR: docker stop $project_name &amp;&amp; docker rm $project_name&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查是否有重命名镜像</span></span><br><span class="line">temp=`docker images | grep $image_name | awk &#x27;&#123; print $1&quot;:&quot;$2 &#125;&#x27; | wc -l`</span><br><span class="line">if [ $temp -eq 1 ]</span><br><span class="line">then</span><br><span class="line">    docker rmi $image_name &amp;&gt;/dev/null</span><br><span class="line">    if [ `echo $?` -eq 0 ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;docker rmi $image_name [OK]&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;ERROR: docker rmi $image_name&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录镜像仓库</span></span><br><span class="line">echo &quot;docker login repository...&quot;</span><br><span class="line">docker login -u admin -p toortoor $harbor_url &amp;&gt;/dev/null</span><br><span class="line">if [ `echo $?` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ERROR: failed to login repository&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;docker login repository [OK]&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">echo &quot;docker pull image...&quot;</span><br><span class="line">docker pull $image_name &amp;&gt;/dev/null</span><br><span class="line">if [ `echo $?` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ERROR: failed to pull image&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;docker pull image [OK]&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行容器</span></span><br><span class="line">echo &quot;docker run container...&quot;</span><br><span class="line">docker run -d --name $project_name -p $service_port:8080 $image_name &amp;&gt;/dev/null</span><br><span class="line">if [ `echo $?` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ERROR: failed to run container&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;docker run container [OK]&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>最终的 Jenkinsfile</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// git凭证id</span></span><br><span class="line"><span class="keyword">def</span> git_auth = <span class="string">&quot;bad37d0d-7260-43a2-a350-9abf6e99753a&quot;</span></span><br><span class="line"><span class="comment">// git凭证url</span></span><br><span class="line"><span class="keyword">def</span> git_url = <span class="string">&quot;http://192.168.88.30/test_group/test_project.git&quot;</span></span><br><span class="line"><span class="comment">// Harbor地址</span></span><br><span class="line"><span class="keyword">def</span> harbor_url = <span class="string">&quot;192.168.88.30:81&quot;</span></span><br><span class="line"><span class="comment">// 镜像仓库名称</span></span><br><span class="line"><span class="keyword">def</span> harbor_repository = <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="comment">// Harbor用户凭证ID</span></span><br><span class="line"><span class="keyword">def</span> harbor_auth = <span class="string">&quot;c147d241-a254-48d6-be1c-0d5f0964ce9a&quot;</span></span><br><span class="line"><span class="comment">// 镜像版本号</span></span><br><span class="line"><span class="keyword">def</span> image_version = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="comment">// 拉取的微服务名称</span></span><br><span class="line"><span class="keyword">def</span> project_name = <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="comment">// 微服务所需端口号</span></span><br><span class="line"><span class="keyword">def</span> service_port = <span class="string">&quot;8081&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    <span class="comment">// 拉取代码</span></span><br><span class="line">    stage(<span class="string">&#x27;Pull Code&#x27;</span>) &#123;</span><br><span class="line">        git <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;git_auth&#125;&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;git_url&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编译，打包微服务工程，构建镜像</span></span><br><span class="line">    stage(<span class="string">&#x27;Mvn clean package and Docker build&#x27;</span>) &#123;</span><br><span class="line">        sh <span class="string">&quot;mvn clean package dockerfile:build&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传镜像至Harbor</span></span><br><span class="line">    stage(<span class="string">&#x27;Push image to Harbor&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 镜像命名，打标签</span></span><br><span class="line">        <span class="keyword">def</span> image_name = <span class="string">&quot;$&#123;project_name&#125;:$&#123;image_version&#125;&quot;</span></span><br><span class="line">        sh <span class="string">&quot;docker tag $&#123;project_name&#125;:latest $&#123;harbor_url&#125;/$&#123;harbor_repository&#125;/$&#123;image_name&#125; &amp;&amp; docker rmi $&#123;project_name&#125;:latest&quot;</span></span><br><span class="line">        <span class="comment">// 登录Harbor仓库</span></span><br><span class="line">        withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;harbor_auth&#125;&quot;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;harbor_password&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harbor_user&#x27;</span>)]) &#123;</span><br><span class="line">            sh <span class="string">&quot;docker login -u $&#123;harbor_user&#125; -p $&#123;harbor_password&#125; $&#123;harbor_url&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 镜像上传</span></span><br><span class="line">        sh <span class="string">&quot;docker push $&#123;harbor_url&#125;/$&#123;harbor_repository&#125;/$&#123;project_name&#125;:$&#123;image_version&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 远程连接服务器拉取镜像运行</span></span><br><span class="line">    stage(<span class="string">&#x27;Pull image and Running container&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取镜像命名</span></span><br><span class="line">        <span class="keyword">def</span> image_name = <span class="string">&quot;$&#123;project_name&#125;:$&#123;image_version&#125;&quot;</span></span><br><span class="line">        sshPublisher(<span class="attr">publishers:</span> [sshPublisherDesc(<span class="attr">configName:</span> <span class="string">&#x27;192.168.88.30&#x27;</span>, <span class="attr">transfers:</span> [sshTransfer(<span class="attr">cleanRemote:</span> <span class="literal">false</span>, <span class="attr">excludes:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">execCommand:</span> <span class="string">&#x27;./root/test.sh $harbor_url $project_name $harbor_url/$harbor_repository/image_name $service_port&#x27;</span>, <span class="attr">execTimeout:</span> <span class="number">120000</span>, <span class="attr">flatten:</span> <span class="literal">false</span>, <span class="attr">makeEmptyDirs:</span> <span class="literal">false</span>, <span class="attr">noDefaultExcludes:</span> <span class="literal">false</span>, <span class="attr">patternSeparator:</span> <span class="string">&#x27;[, ]+&#x27;</span>, <span class="attr">remoteDirectory:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">remoteDirectorySDF:</span> <span class="literal">false</span>, <span class="attr">removePrefix:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">sourceFiles:</span> <span class="string">&#x27;&#x27;</span>)], <span class="attr">usePromotionTimestamp:</span> <span class="literal">false</span>, <span class="attr">useWorkspaceInPromotion:</span> <span class="literal">false</span>, <span class="attr">verbose:</span> <span class="literal">false</span>)])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-微服务架构CICD优化"><a href="#6-4-微服务架构CICD优化" class="headerlink" title="6.4 微服务架构CICD优化"></a>6.4 微服务架构CICD优化</h3><p>从以上配置中可以看到，每次构建都只能选择一个服务，且部署的服务器也只有一台，是不符合生产环境的，主要需求有以下三个：</p>
<ul>
<li>多个微服务同时构建流水线工程</li>
<li>批量处理镜像</li>
<li>将微服务部署服务器集群</li>
</ul>
<ol>
<li>安装 Extended Choice Parameter 插件，实现多个微服务同时构建</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E4%BA%94.png" alt="微服务CICD十五"></p>
<ol start="2">
<li>在创建流水线时设置选项</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E5%85%AD.png" alt="微服务CICD十六"></p>
<hr>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E4%B8%83.png" alt="微服务CICD十七"></p>
<hr>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E5%85%AB.png" alt="微服务CICD十八"></p>
<ol start="3">
<li>将公钥下发，并在系统设置的 Publish over SSH 中添加多台主机</li>
<li>在流水线工程中添加多一个多选项配置，用于选择要部署的服务器</li>
</ol>
<p><img src="/2024/02/18/jenkins/%E5%BE%AE%E6%9C%8D%E5%8A%A1CICD%E5%8D%81%E4%B9%9D.png" alt="微服务CICD十九"></p>
<ol start="5">
<li>修改流水线语法</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// git凭证id</span></span><br><span class="line"><span class="keyword">def</span> git_auth = <span class="string">&quot;bad37d0d-7260-43a2-a350-9abf6e99753a&quot;</span></span><br><span class="line"><span class="comment">// git凭证url</span></span><br><span class="line"><span class="keyword">def</span> git_url = <span class="string">&quot;http://192.168.88.30/test_group/test_project.git&quot;</span></span><br><span class="line"><span class="comment">// Harbor地址</span></span><br><span class="line"><span class="keyword">def</span> harbor_url = <span class="string">&quot;192.168.88.30:81&quot;</span></span><br><span class="line"><span class="comment">// 镜像仓库名称</span></span><br><span class="line"><span class="keyword">def</span> harbor_repository = <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="comment">// Harbor用户凭证ID</span></span><br><span class="line"><span class="keyword">def</span> harbor_auth = <span class="string">&quot;c147d241-a254-48d6-be1c-0d5f0964ce9a&quot;</span></span><br><span class="line"><span class="comment">// 镜像版本号</span></span><br><span class="line"><span class="keyword">def</span> image_version = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    <span class="comment">// 获取服务名</span></span><br><span class="line">    <span class="keyword">def</span> selectedProjectNames = <span class="string">&quot;$&#123;project_name&#125;&quot;</span>.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">    <span class="comment">// 获取集群地址</span></span><br><span class="line">    <span class="keyword">def</span> selectedServices = <span class="string">&quot;$&#123;publish_server&#125;&quot;</span>.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拉取代码</span></span><br><span class="line">    stage(<span class="string">&#x27;Pull Code&#x27;</span>) &#123;</span><br><span class="line">        git <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;git_auth&#125;&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;git_url&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编译，打包微服务工程，构建镜像</span></span><br><span class="line">    stage(<span class="string">&#x27;Mvn clean package and Docker build&#x27;</span>) &#123;</span><br><span class="line">        sh <span class="string">&quot;mvn clean package dockerfile:build&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传镜像至Harbor</span></span><br><span class="line">    stage(<span class="string">&#x27;Push image to Harbor&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;selectedProjectNames.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 获取每个选项</span></span><br><span class="line">            <span class="keyword">def</span> project_info = selectedProjectNames[i]</span><br><span class="line">            <span class="comment">// 获取选项中的微服务名称</span></span><br><span class="line">            <span class="keyword">def</span> current_project_name = <span class="string">&quot;$&#123;project_info&#125;&quot;</span>.split(<span class="string">&quot;@&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">// 镜像命名，打标签</span></span><br><span class="line">            <span class="keyword">def</span> image_name = <span class="string">&quot;$&#123;current_project_name&#125;:$&#123;image_version&#125;&quot;</span></span><br><span class="line">            sh <span class="string">&quot;docker tag $&#123;current_project_name&#125;:latest $&#123;harbor_url&#125;/$&#123;harbor_repository&#125;/$&#123;image_name&#125; &amp;&amp; docker rmi $&#123;current_project_name&#125;:latest&quot;</span></span><br><span class="line">            <span class="comment">// 登录Harbor仓库</span></span><br><span class="line">            withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;harbor_auth&#125;&quot;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;harbor_password&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harbor_user&#x27;</span>)]) &#123;</span><br><span class="line">                sh <span class="string">&quot;docker login -u $&#123;harbor_user&#125; -p $&#123;harbor_password&#125; $&#123;harbor_url&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 镜像上传</span></span><br><span class="line">            sh <span class="string">&quot;docker push $&#123;harbor_url&#125;/$&#123;harbor_repository&#125;/$&#123;current_project_name&#125;:$&#123;image_version&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 远程连接服务器拉取镜像运行</span></span><br><span class="line">    stage(<span class="string">&#x27;Pull image and Running container&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;selectedProjectNames.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 获取每个选项</span></span><br><span class="line">            <span class="keyword">def</span> project_info = selectedProjectNames[i]</span><br><span class="line">            <span class="comment">// 获取选项中的微服务名称</span></span><br><span class="line">            <span class="keyword">def</span> current_project_name = <span class="string">&quot;$&#123;project_info&#125;&quot;</span>.split(<span class="string">&quot;@&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">// 获取选项中的微服务所需端口</span></span><br><span class="line">            <span class="keyword">def</span> current_project_port = <span class="string">&quot;$&#123;project_info&#125;&quot;</span>.split(<span class="string">&quot;@&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">            <span class="comment">// 需要拉取的镜像</span></span><br><span class="line">            <span class="keyword">def</span> image_name = <span class="string">&quot;$&#123;current_project_name&#125;:$&#123;image_version&#125;&quot;</span></span><br><span class="line">            <span class="comment">// 遍历所有服务器，分别部署</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;selectedServices.length; j++) &#123;</span><br><span class="line">                <span class="comment">// 获取当前服务器</span></span><br><span class="line">                <span class="keyword">def</span> current_server = selectedServices[j]</span><br><span class="line">                <span class="comment">// 加上参数配置，根据配置文件的不同选择不同的服务器部署</span></span><br><span class="line">                <span class="keyword">if</span>(current_server == <span class="string">&quot;192.168.88.31&quot;</span>) &#123;</span><br><span class="line">                    activeProfile = activeProfile+<span class="string">&quot;serviceName-server1&quot;</span></span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(current_server == <span class="string">&quot;192.168.88.32&quot;</span>) &#123;</span><br><span class="line">                    activeProfile = activeProfile+<span class="string">&quot;serviceName-server2&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 远程执行脚本</span></span><br><span class="line">                sshPublisher(<span class="attr">publishers:</span> [sshPublisherDesc(<span class="attr">configName:</span> <span class="string">&quot;$&#123;current_server&#125;&quot;</span>, <span class="attr">transfers:</span> [sshTransfer(<span class="attr">cleanRemote:</span> <span class="literal">false</span>, <span class="attr">excludes:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">execCommand:</span> <span class="string">&#x27;./root/test.sh $harbor_url $current_project_name $harbor_url/$harbor_repository/$image_name $current_project_port $activeProfile&#x27;</span>, <span class="attr">execTimeout:</span> <span class="number">120000</span>, <span class="attr">flatten:</span> <span class="literal">false</span>, <span class="attr">makeEmptyDirs:</span> <span class="literal">false</span>, <span class="attr">noDefaultExcludes:</span> <span class="literal">false</span>, <span class="attr">patternSeparator:</span> <span class="string">&#x27;[, ]+&#x27;</span>, <span class="attr">remoteDirectory:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">remoteDirectorySDF:</span> <span class="literal">false</span>, <span class="attr">removePrefix:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">sourceFiles:</span> <span class="string">&#x27;&#x27;</span>)], <span class="attr">usePromotionTimestamp:</span> <span class="literal">false</span>, <span class="attr">useWorkspaceInPromotion:</span> <span class="literal">false</span>, <span class="attr">verbose:</span> <span class="literal">false</span>)])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>修改 <code>test.sh</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">harbor_url=$1</span><br><span class="line">project_name=$2</span><br><span class="line">image_name=$3</span><br><span class="line">service_port=$4</span><br><span class="line">profile=$6</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除none容器</span></span><br><span class="line">echo &quot;docker rmi none...&quot;</span><br><span class="line">docker images | grep none | awk &#x27;&#123; print &quot;docker rmi &quot;$3 &#125;&#x27; | sh &amp;&gt;/dev/null</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查是否有已运行容器</span></span><br><span class="line">num=`docker ps | grep $project_name | wc -l`</span><br><span class="line">if [ $num -gt 0 ]</span><br><span class="line">then</span><br><span class="line">    docker stop $project_name &amp;&amp; docker rm $project_name &amp;&gt;/dev/null</span><br><span class="line">    if [ `echo $?` -eq 0 ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;docker stop $project_name &amp;&amp; docker rm $project_name [OK]&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;ERROR: docker stop $project_name &amp;&amp; docker rm $project_name&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查是否有重命名镜像</span></span><br><span class="line">temp=`docker images | grep $image_name | awk &#x27;&#123; print $1&quot;:&quot;$2 &#125;&#x27; | wc -l`</span><br><span class="line">if [ $temp -eq 1 ]</span><br><span class="line">then</span><br><span class="line">    docker rmi $image_name &amp;&gt;/dev/null</span><br><span class="line">    if [ `echo $?` -eq 0 ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;docker rmi $image_name [OK]&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;ERROR: docker rmi $image_name&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录镜像仓库</span></span><br><span class="line">echo &quot;docker login repository...&quot;</span><br><span class="line">docker login -u admin -p toortoor $harbor_url &amp;&gt;/dev/null</span><br><span class="line">if [ `echo $?` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ERROR: failed to login repository&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;docker login repository [OK]&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">echo &quot;docker pull image...&quot;</span><br><span class="line">docker pull $image_name &amp;&gt;/dev/null</span><br><span class="line">if [ `echo $?` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ERROR: failed to pull image&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;docker pull image [OK]&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行容器</span></span><br><span class="line">echo &quot;docker run container...&quot;</span><br><span class="line">docker run -d --name $project_name -p $service_port:8080 $image_name $profile &amp;&gt;/dev/null</span><br><span class="line">if [ `echo $?` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ERROR: failed to run container&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;docker run container [OK]&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<h2 id="七、基于K8S的CICD"><a href="#七、基于K8S的CICD" class="headerlink" title="七、基于K8S的CICD"></a>七、基于K8S的CICD</h2><p>基于 Kubernetes 平台来实现 CICD 功能。</p>
<p><img src="/DK8SCICD%E4%B8%80.png" alt="K8SCICD一"></p>
<h3 id="7-1-Jenkins对接K8S"><a href="#7-1-Jenkins对接K8S" class="headerlink" title="7.1 Jenkins对接K8S"></a>7.1 Jenkins对接K8S</h3><ul>
<li>首先通过 bitnami helm 部署 Jenkins（Master），需开放 jnlp 50000 端口</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加repo源</span></span><br><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载chart到本地</span></span><br><span class="line">helm pull bitnami/jenkins</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据需求修改values.yaml</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署</span></span><br><span class="line">helm install jenkins jeknins/</span><br></pre></td></tr></table></figure>

<p><img src="/DK8SCICD%E5%8D%81%E5%85%AD.png" alt="K8SCICD十六"></p>
<ul>
<li>RBAC 授权，SA 名为 jenkins，后续会用到</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nextcloud</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nextcloud</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/exec&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>, <span class="string">&quot;apps&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nextcloud</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">nextcloud</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取刚刚创建的 ca.crt 信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret jenkins-token-xxx -oyaml | awk &#x27;/ca.crt/&#123; print $2 &#125;&#x27; | base64 -d</span><br></pre></td></tr></table></figure>

<ul>
<li>在 Jenkins 创建凭据</li>
</ul>
<p><img src="/DK8SCICD%E4%BA%8C.png" alt="K8SCICD二"></p>
<ul>
<li>添加云，这里用到刚刚创建的凭据</li>
</ul>
<p><img src="/DK8SCICD%E4%B8%89.png" alt="K8SCICD三"></p>
<hr>
<p><img src="/DK8SCICD%E5%9B%9B.png" alt="K8SCICD四"></p>
<hr>
<p>设置 Pod Template，即 Jenkins Slave，将包含 jnlp 一个容器，来实现编译打包等功能。</p>
<p><img src="/DK8SCICD%E4%BA%94.png" alt="K8SCICD五"></p>
<hr>
<p><img src="/DK8SCICD%E5%85%AD.png" alt="K8SCICD六"></p>
<hr>
<p>这里需挂载宿主机的 docker.sock、docker 和 kubectl 的二进制文件。</p>
<p><img src="/DK8SCICD%E4%B8%83.png" alt="K8SCICD七"></p>
<hr>
<p>然后使用到刚刚创建的 SA。</p>
<p><img src="/DK8SCICD%E5%85%AB.png" alt="K8SCICD八"></p>
<hr>
<p>测试链接。</p>
<p><img src="/DK8SCICD%E4%B9%9D.png" alt="K8SCICD九"></p>
<h3 id="7-2-构建前准备"><a href="#7-2-构建前准备" class="headerlink" title="7.2 构建前准备"></a>7.2 构建前准备</h3><p>需要在项目的根目录下准备好 Dockerfile、Jenkinsfile、deploy.yaml。</p>
<ul>
<li>Jenkinsfile</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gitlab及harbur凭据认证等信息</span></span><br><span class="line"><span class="keyword">def</span> git_auth = <span class="string">&quot;764f29f3-8955-4551-a23a-659aa4c8deaa&quot;</span></span><br><span class="line"><span class="keyword">def</span> git_url = <span class="string">&quot;http://192.168.159.12:30098/root/nextcloud.git&quot;</span></span><br><span class="line"><span class="keyword">def</span> harbor_url = <span class="string">&quot;192.168.159.101&quot;</span></span><br><span class="line"><span class="keyword">def</span> harbor_repository = <span class="string">&quot;nextcloud&quot;</span></span><br><span class="line"><span class="keyword">def</span> harbor_auth = <span class="string">&quot;7ebc36f8-73a3-417f-864f-24856490b1a2&quot;</span></span><br><span class="line"><span class="keyword">def</span> project_name = <span class="string">&quot;nextcloud&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// jenkins-slave为pod template中的name</span></span><br><span class="line">node(<span class="string">&#x27;jenkins-slave&#x27;</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// jnlp为pod template中的容器名称</span></span><br><span class="line">    container(<span class="string">&#x27;jnlp&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pipeline步骤</span></span><br><span class="line">        stage(<span class="string">&#x27;Git Clone&#x27;</span>) &#123;</span><br><span class="line">            git <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;git_auth&#125;&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;git_url&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Docker Build&#x27;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;docker build -t $&#123;harbor_url&#125;/$&#123;harbor_repository&#125;/$&#123;project_name&#125;:$&#123;branch&#125;-$&#123;version&#125; .&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Docker Push&#x27;</span>) &#123;</span><br><span class="line">            withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;harbor_auth&#125;&quot;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;harbor_password&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harbor_user&#x27;</span>)]) &#123;</span><br><span class="line">            sh <span class="string">&quot;docker login -u $&#123;harbor_user&#125; -p $&#123;harbor_password&#125; $&#123;harbor_url&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            sh <span class="string">&quot;docker push $&#123;harbor_url&#125;/$&#123;harbor_repository&#125;/$&#123;project_name&#125;:$&#123;branch&#125;-$&#123;version&#125;&quot;</span></span><br><span class="line">            sh <span class="string">&quot;docker rmi $&#123;harbor_url&#125;/$&#123;harbor_repository&#125;/$&#123;project_name&#125;:$&#123;branch&#125;-$&#123;version&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">// 在deploy.yaml中将镜像tag设为了build-tag,方便通过sed修改</span></span><br><span class="line">        stage(<span class="string">&#x27;Sed YAML&#x27;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s#build-tag#$&#123;branch&#125;-$&#123;version&#125;#g&#x27; deploy.yaml&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Deploy to K8s&#x27;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;kubectl apply -f deploy.yaml&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-创建流水线项目"><a href="#7-3-创建流水线项目" class="headerlink" title="7.3 创建流水线项目"></a>7.3 创建流水线项目</h3><p>这里添加了两个字符参数，用于构建前选择分支和 tag 的标签定义。</p>
<p><img src="/DK8SCICD%E5%8D%81.png" alt="K8SCICD十"></p>
<hr>
<p><img src="/DK8SCICD%E5%8D%81%E4%B8%80.png" alt="K8SCICD十一"></p>
<hr>
<p>构建测试，会发现集群中创建了一个 jenkins-slave-xxx 的 pod，pod 中包含 jnlp 一个容器，通过观察日志可发现与 Jenkins Master 进行了连接。</p>
<p><img src="/DK8SCICD%E5%8D%81%E4%B8%89.png" alt="K8SCICD十三"></p>
<hr>
<p>Jenkins 中查看流水线进度。</p>
<p><img src="/DK8SCICD%E5%8D%81%E5%9B%9B.png" alt="K8SCICD十四"></p>
<hr>
<p>流水线结束后，通过 kubectl 可看到项目已部署，且使用的镜像是刚刚构建好的。</p>
<p><img src="/DK8SCICD%E5%8D%81%E4%BA%94.png" alt="K8SCICD十五"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T10:59:10.989Z" title="2/18/2024, 6:59:10 PM">2024-02-18</time></span><span class="level-item">3 hours read (About 31093 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/kubernetes/">Kubernetes</a></p><div class="content"><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><h3 id="1-1-k8s概述"><a href="#1-1-k8s概述" class="headerlink" title="1.1 k8s概述"></a>1.1 k8s概述</h3><p>Kubernetes 是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。 Kubernetes 拥有一个庞大且快速增长的生态系统。Kubernetes 的服务、支持和工具广泛可用。</p>
<p><img src="/2024/02/18/kubernetes/k8s%E5%9B%BE%E6%A0%87.jpg" alt="k8s图标"></p>
<p>容器是打包和运行应用程序的好方式。在生产环境中，你需要管理运行应用程序的容器，并确保不会停机。 例如，如果一个容器发生故障，则需要启动另一个容器。如果系统处理此行为，会不会更容易？</p>
<p>这就是 Kubernetes 来解决这些问题的方法！ Kubernetes 为你提供了一个可弹性运行分布式系统的框架。 Kubernetes 会满足你的扩展要求、故障转移、部署模式等。 例如，Kubernetes 可以轻松管理系统的 Canary 部署。</p>
<p>Kubernetes 简称 k8s，主要功能有：</p>
<ul>
<li>服务发现和负载均衡</li>
<li>存储编排</li>
<li>自动部署和回滚</li>
<li>自动完成装箱计算</li>
<li>自我修复</li>
<li>密钥与配置管理</li>
</ul>
<h3 id="1-2-k8s组件"><a href="#1-2-k8s组件" class="headerlink" title="1.2 k8s组件"></a>1.2 k8s组件</h3><p>一个 Kubernetes 集群由一组被称作节点的机器组成。这些节点上运行 Kubernetes 所管理的容器化应用。集群具有至少一个工作节点。</p>
<p>工作节点托管作为应用负载的组件的 Pod 。控制平面管理集群中的工作节点和 Pod 。 为集群提供故障转移和高可用性，这些控制平面一般跨多主机运行，集群跨多个节点运行。</p>
<p><img src="/2024/02/18/kubernetes/k8s%E6%9E%B6%E6%9E%84.svg" alt="k8s架构"></p>
<h4 id="1-2-1-控制平面组件"><a href="#1-2-1-控制平面组件" class="headerlink" title="1.2.1 控制平面组件"></a>1.2.1 控制平面组件</h4><p><strong>kube-apiserver：</strong></p>
<p>API 服务器是 Kubernetes 控制面的组件，该组件公开了 Kubernetes API。API 服务器是 Kubernetes 控制面的前端。</p>
<p><strong>etcd：</strong></p>
<p>etcd 是兼具一致性和高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库。</p>
<p><strong>kube-scheduler：</strong></p>
<p>控制平面组件，负责监视新创建的、未指定运行节点（node）的 Pods，选择节点让 Pod 在上面运行。</p>
<p>调度决策考虑的因素包括单个 Pod 和 Pod 集合的资源需求、硬件&#x2F;软件&#x2F;策略约束、亲和性和反亲和性规范、数据位置、工作负载间的干扰和最后时限。</p>
<p><strong>kube-controller-manager：</strong></p>
<p>在主节点上运行控制器的组件。</p>
<p>控制器包括：</p>
<ul>
<li>节点控制器（Node Controller）: 负责在节点出现故障时进行通知和响应</li>
<li>任务控制器（Job controller）: 监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成</li>
<li>端点控制器（Endpoints Controller）: 填充端点(Endpoints)对象(即加入 Service 与 Pod)</li>
<li>服务帐户和令牌控制器（Service Account &amp; Token Controllers）: 为新的命名空间创建默认帐户和 API 访问令牌</li>
</ul>
<p><strong>cloud-controller-manager：</strong></p>
<p>云控制器管理器是指嵌入特定云的控制逻辑的控制平面组件。云控制器管理器允许您链接聚合到云提供商的应用编程接口中，并分离出相互作用的组件与您的集群交互的组件。</p>
<p>下面的控制器都包含对云平台驱动的依赖：</p>
<ul>
<li>节点控制器（Node Controller）: 用于在节点终止响应后检查云提供商以确定节点是否已被删除</li>
<li>路由控制器（Route Controller）: 用于在底层云基础架构中设置路由</li>
<li>服务控制器（Service Controller）: 用于创建、更新和删除云提供商负载均衡器</li>
</ul>
<h4 id="1-2-2-Node组件"><a href="#1-2-2-Node组件" class="headerlink" title="1.2.2 Node组件"></a>1.2.2 Node组件</h4><p>节点组件在每个节点上运行，维护运行的 Pod 并提供 Kubernetes 运行环境。</p>
<p><strong>kubelet：</strong></p>
<p>一个在集群中每个节点（node）上运行的代理。它保证容器（containers）都运行在 Pod 中。</p>
<p>kubelet 接收一组通过各类机制提供给它的 PodSpecs，确保这些 PodSpecs 中描述的容器处于运行状态且健康。 kubelet 不会管理不是由 Kubernetes 创建的容器。</p>
<p><strong>容器运行时（Container Runtime）：</strong></p>
<p>容器运行环境是负责运行容器的软件，例如 Docker 。</p>
<h4 id="1-2-3-插件（Addons）"><a href="#1-2-3-插件（Addons）" class="headerlink" title="1.2.3 插件（Addons）"></a>1.2.3 插件（Addons）</h4><p>插件使用 Kubernetes 资源（DaemonSet、Deployment等）实现集群功能。 因为这些插件提供集群级别的功能，插件中命名空间域的资源属于 <code>kube-system</code> 命名空间。</p>
<p><strong>DNS：</strong></p>
<p>尽管其他插件都并非严格意义上的必需组件，但几乎所有 Kubernetes 集群都应该 有集群 DNS， 因为很多示例都需要 DNS 服务。</p>
<p><strong>Web 界面（仪表盘）：</strong></p>
<p>Dashboard 是Kubernetes 集群的通用的、基于 Web 的用户界面。 它使用户可以管理集群中运行的应用程序以及集群本身并进行故障排除。</p>
<p><strong>容器资源监控：</strong></p>
<p>容器资源监控将关于容器的一些常见的时间序列度量值保存到一个集中的数据库中，并提供用于浏览这些数据的界面。</p>
<p><strong>集群层面日志：</strong></p>
<p>集群层面日志机制负责将容器的日志数据 保存到一个集中的日志存储中，该存储能够提供搜索和浏览接口。</p>
<h3 id="1-3-Pod"><a href="#1-3-Pod" class="headerlink" title="1.3 Pod"></a>1.3 Pod</h3><h4 id="1-3-1-Pod概念"><a href="#1-3-1-Pod概念" class="headerlink" title="1.3.1 Pod概念"></a>1.3.1 Pod概念</h4><p>Pod 是 k8s 中的最小单元，一个 Pod 包含一个或多个容器，一个 Pod 不会跨越多个节点（Node）。</p>
<p>而每个 Pod 里都会有一个根容器 pause，Pod 中的其他容器都共享 pause 根容器的网络栈和volume挂载卷，因此容器之间的通信和数据交换会更为高效。</p>
<h4 id="1-3-2-RC、RS、Deployment"><a href="#1-3-2-RC、RS、Deployment" class="headerlink" title="1.3.2 RC、RS、Deployment"></a>1.3.2 RC、RS、Deployment</h4><p>k8s 管理 Pod 主要用到以下三个组件：</p>
<ul>
<li>Replication Controller（RC）：用来确保容器应用的副本数始终保持在用户定义的副本数，如果有容器异常退出，会自动创建新的 Pod 来代替，如果有异常多出的容器也会自动回收。</li>
<li>ReplicaSet（RS）：相比 RC 多了支持 selector，推荐使用 RS。</li>
<li>Deployment：用来管理 RS。</li>
</ul>
<p>来看看 Deployment 和 RS 是如何实现更新的：</p>
<ol>
<li>Deployment 创建新的 RS</li>
</ol>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%B8%80.png" alt="RS和Deployment实现更新一"></p>
<ol start="2">
<li>RS1删除一个容器，接着 RS2 新建一个新版本的 Pod</li>
</ol>
<p>	</p>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%BA%8C.png" alt="RS和Deployment实现更新二"></p>
<ol start="3">
<li>全部更新完之后，RS1 并不会删除，而是保留着处于停用状态，如果新版本出了问题需要回滚，就可以反过来操作实现回滚</li>
</ol>
<p><img src="/2024/02/18/kubernetes/RS%E5%92%8CDeployment%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E4%B8%89.png" alt="RS和Deployment实现更新三"></p>
<h4 id="1-3-3-Horizontal-Pod-Autoscaler"><a href="#1-3-3-Horizontal-Pod-Autoscaler" class="headerlink" title="1.3.3 Horizontal Pod Autoscaler"></a>1.3.3 Horizontal Pod Autoscaler</h4><p>Horizontal Pod Autoscaler（HPA）在k8s集群中用于 Pod 水平自动弹性伸缩，它是基于 CPU 和内存利用率对 Deployment 和 RS 中的 Pod 数量进行自动扩缩容（除了 CPU 和内存利用率之外，也可以基于其他应程序提供的度量指标 custom metrics 进行自动扩缩容）。</p>
<p>假如 HPA 检测到当前 Deployment 和 RS 所管理的 Pod 的 CPU 或内存使用率超过了设定之后，就会创建新的 Pod 来实现降压，新建 Pod 的数量限制由 Max 和 Min 设定。</p>
<p><img src="/2024/02/18/kubernetes/HPA.png" alt="HPA"></p>
<h4 id="1-3-4-StatefulSet"><a href="#1-3-4-StatefulSet" class="headerlink" title="1.3.4 StatefulSet"></a>1.3.4 StatefulSet</h4><p>RS 和 Deployment 都是面向无状态的服务，它们所管理的 Pod 的 IP、名字，启停顺序等都是随机的，而 StatefulSet 是有状态的集合，管理所有有状态的服务，比如 MySQL、MongoDB 集群等。</p>
<p>StatefulSet 的特点有：</p>
<p>Pod 的一致性：包含次序（启停顺序，例如 mysql -&gt; php-fpm -&gt; nginx 的启动顺序）、网络一致性（与 Pod 相关，与被调度的 Node 节点无关）。</p>
<p>稳定的存储：即 Pod 重新调度之后还是访问到相同的持久化数据，基于 PVC（PV 是集群中由管理员提供或使用存储类动态提供的一块存储。它是集群中的资源，就像节点是集群资源一样。而 PVC 是用户对存储的请求。它类似于 Pod，Pod 消耗 Node 资源，而 PVC 消耗 PV 资源。） 来实现。</p>
<p>稳定的次序：对于N个副本的 StatefulSet，每个 Pod 都在 [0，N) 的范围内分配一个数字序号，且是唯一的。</p>
<p>稳定的网络：Pod 的 hostname 模式为：( StatefulSet 名称 ) - ( 序号 )。</p>
<h4 id="1-3-5-DaemonSet"><a href="#1-3-5-DaemonSet" class="headerlink" title="1.3.5 DaemonSet"></a>1.3.5 DaemonSet</h4><p>DaemonSet 确保全部或者一部分 Node 上运行一个 Pod 的副本，当有 Node 加入集群时，也会为他们新增一个 Pod，当这些 Node 退出集群时，这些 Pod 也会被回收。</p>
<p>DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行 glusterd、ceph等。</li>
<li>运行日志收集daemon，例如fluentd、logstash等。</li>
<li>运行监控daemon，例如 Prometheus 的 Node exporter、zabbix等。</li>
</ul>
<h4 id="1-3-6-Job和Cron-Job"><a href="#1-3-6-Job和Cron-Job" class="headerlink" title="1.3.6 Job和Cron Job"></a>1.3.6 Job和Cron Job</h4><p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束。</p>
<p>这里可能有人会想，那在 linux 上直接执行脚本不就行了吗？其实这就会有个问题，如果脚本执行失败那么久退出且不会再执行了，需要执行就必须手动，但 Job 设置的任务只有在正常执行结束后才会结束，否则一直执行到成功为止。Job 也可以设置成功的次数要达到几次才允许退出。</p>
<p>Cron Job 是基于时间管理控制 Job，即在给定的时间只运行一次、周期性的在指定时间运行。</p>
<h4 id="1-3-7-Service"><a href="#1-3-7-Service" class="headerlink" title="1.3.7 Service"></a>1.3.7 Service</h4><p>Pod 的生命是有限的，如果 Pod 重启 IP 也可能会发生变化。如果我们将 Pod 的 IP 写死，Pod 如果挂了或重启，其它的服务也会不可用。我们可以把我们的服务（各种 Pod）注册到服务发现中心去，让服务发现中心去动态更新其它服务的配置就可以了，k8s 就给我们提供了这么一个服务，即 Service。</p>
<p>我们这样就可以不用去管后端的 Pod 如何变化，只需要指定 Service 的地址就可以了，因为我们在中间添加了一层服务发现的中间件，Pod 销毁或者重启后，把这个 Pod 的地址注册到这个服务发现中心去。</p>
<p><img src="/2024/02/18/kubernetes/service.png" alt="service"></p>
<h3 id="1-4-k8s的网络通讯方式"><a href="#1-4-k8s的网络通讯方式" class="headerlink" title="1.4 k8s的网络通讯方式"></a>1.4 k8s的网络通讯方式</h3><p>k8s 的网络模型假定了所有的 Pod 都在一个可以直接连通的扁平化网络空间中，在这 GCE（Google Compute Engine）里面是现成的网络模型。</p>
<p>Flannel 是 CoreOS 团队针对 Kubernetes 设计一个网络规划服务，简单来说，它的功能是让集群中的不同节点主机创建 Docker 容器都具有全集群唯一的虚拟 IP 地址。而且它还能在这些 IP 地址之间建立一个覆盖网络（Overlay Network），通过覆盖网络将数据包原封不动的传递到目标容器内。</p>
<p>通过一个架构图来看看不同情况下的通讯是怎么样的：</p>
<p><img src="/2024/02/18/kubernetes/%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="网络通讯方式架构图"></p>
<p>通讯情况主要分为以下几种：</p>
<ol>
<li>同一 Pod 不同容器之间的通信：采用 pause 网络栈。</li>
<li>同一 Node 不同 Pod 之间的通信：通过 docker0 网桥进行通信。</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E5%90%8C%E4%B8%80Node%E5%86%85%E4%B8%8D%E5%90%8CPod%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E8%AE%AF.png" alt="同一Node内不同Pod之间的通讯"></p>
<ol>
<li>不同 Node 的 Pod 之间的通信：不同 Node 的 Pod 之间的通信是 k8s 网络通信的难点，是通过 Flannel 网络通讯方式来实现的，通讯的过程分为以下几个步骤：<ul>
<li>数据包从 Node1 的 Pod 到达 docker0 网桥</li>
<li>Flanneld 会开启一个 Flannel0 的网桥，用来抓取到达 docker0 的数据，可以理解为一个钩子函数</li>
<li>Flanneld 会有很多路由表信息，是存储在 etcd 中由 Flanneld 自动获取的，通过路由表知道了转发信息后就通过物理网卡进行转发</li>
<li>发送到目标主机的物理网卡后，就会再通过 Flanneld -&gt; Flannel0网桥 -&gt; docker0网桥，最终到达目的 Pod</li>
</ul>
</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E4%B8%8D%E5%90%8CNode%E7%9A%84Pod%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1.png" alt="不同Node的Pod之间的通信"></p>
<ol>
<li>Pod 与 service 之间的通信：采用各节点的 iptables 规则来实现。</li>
<li>Pod 到外网：通过 Flanneld 到达物理网卡，经过路由选择后，iptables 执行 Masquerade，把Pod 的虚拟 IP 改为 物理网卡的 IP，在向外网服务器发出请求。</li>
<li>外网到 Pod：通过 service 进行访问，一般使用 NodePort。</li>
</ol>
<h2 id="二、k8s部署"><a href="#二、k8s部署" class="headerlink" title="二、k8s部署"></a>二、k8s部署</h2><p>本次 k8s 部署为以下环境</p>
<p><img src="/2024/02/18/kubernetes/k8s%E9%83%A8%E7%BD%B2%E6%9D%A1%E4%BB%B6.png" alt="k8s部署条件"></p>
<h3 id="2-1-基本环境配置（所有节点）"><a href="#2-1-基本环境配置（所有节点）" class="headerlink" title="2.1 基本环境配置（所有节点）"></a>2.1 基本环境配置（所有节点）</h3><ol>
<li>在各主机设置主机名以及host文件解析</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master01</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br><span class="line">hostnamectl set-hostname k8s-node02</span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.88.10 k8s-master01</span><br><span class="line">192.168.88.20 k8s-node01</span><br><span class="line">192.168.88.21 k8s-node02</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装依赖</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install conntrack ntpdate ntp ipvsadm ipset jp iptables curl stsstat libseccomp wget vim net-tools git</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>设置防火墙为iptables并设置空规则</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line">yum -y install iptables-services</span><br><span class="line">systemctl start iptables</span><br><span class="line">systemctl enable iptables</span><br><span class="line">iptables -F &amp;&amp; service iptables save</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>关闭虚拟内存和selinux</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sed -i &#x27;/ swap / s/^\(.*\)$/#/g&#x27; /etc/fstab</span><br><span class="line">setenforce 0 &amp;&amp; sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调整内核参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ipv6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0 # 禁用swap，只有系统OOM时才允许使用</span><br><span class="line">vm.overcommit_memory=1 # 不检查物理内存是否够用</span><br><span class="line">vm.panic_on_oom=0 # 开启OOM</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line">cp kubernetes.conf /etc/sysctl.d/kubernetes.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>调整系统时区</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设为中国/上海</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将当前UTC时间写入硬件时钟</span></span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启依赖于时间的服务</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>关闭不需要的服务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭邮件服务</span></span><br><span class="line">systemctl stop postfix &amp;&amp; systemctl disable postfix</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>设置rsyslog和systemd journald</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">持久化保存日志目录</span></span><br><span class="line">mkdir /var/log/journal</span><br><span class="line">mkdir /etc/systemd/journald.conf.d</span><br><span class="line">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF</span><br><span class="line">[Journal]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">持久化保存到磁盘</span></span><br><span class="line">Storage=persistent</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">压缩历史日志</span></span><br><span class="line">Compress=yes</span><br><span class="line"> </span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最大占用空间 10G</span></span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">单日志文件最大 200M</span></span><br><span class="line">SystemMaxFileSize=200M</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">日志保存时间 2 周</span></span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不将日志转发到 syslog</span></span><br><span class="line">ForwardToSyslog=no</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>升级内核</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入公钥</span></span><br><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装elrepo源</span></span><br><span class="line">yum -y install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">升级内核</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机从新内核启动</span></span><br><span class="line">grub2-set-default &quot;CentOS Linux (5.4.116-1.e17.elrepo.x86_64) 7 (Core)&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看内核启动项</span></span><br><span class="line">grub2-editenv list</span><br></pre></td></tr></table></figure>

<h3 id="2-2-kubeadm部署（所有节点）"><a href="#2-2-kubeadm部署（所有节点）" class="headerlink" title="2.2 kubeadm部署（所有节点）"></a>2.2 kubeadm部署（所有节点）</h3><ol>
<li>kube-proxy开启ipvs前置条件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">vim /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack&quot;</span><br><span class="line"></span><br><span class="line">for kernel_module in $&#123;ipvs_modules&#125;;</span><br><span class="line">do</span><br><span class="line">    /sbin/modinfo -F filename $&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe $&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装docker</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum -y install yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce docker-ce-cli</span><br><span class="line"></span><br><span class="line">mkdir /etc/docker</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">        &quot;registry-mirrors&quot;: [&quot;http://f1361db2.m.daocloud.io&quot;],</span><br><span class="line">        &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">        &quot;log-driver&quot;:&quot;json-file&quot;,</span><br><span class="line">        &quot;log-opts&quot;:&#123;</span><br><span class="line">                &quot;max-size&quot;:&quot;100m&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker</span><br></pre></td></tr></table></figure>

<h3 id="2-3-安装kubeadm（所有节点）"><a href="#2-3-安装kubeadm（所有节点）" class="headerlink" title="2.3 安装kubeadm（所有节点）"></a>2.3 安装kubeadm（所有节点）</h3><ol>
<li>安装 kubeadm kubectl kubelet</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum -y install kubeadm kubectl kubelet</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>通过kubeadm查看目前各镜像版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.21.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.21.0</span><br><span class="line">k8s.gcr.io/pause:3.4.1</span><br><span class="line">k8s.gcr.io/etcd:3.4.13-0</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.0</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写脚本，通过阿里镜像安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim k8s_images.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">apiserver_var=v1.21.0</span><br><span class="line">controller_manager_var=v1.21.0</span><br><span class="line">scheduler_var=v1.21.0</span><br><span class="line">proxy_var=v1.21.0</span><br><span class="line">pause_var=3.4.1</span><br><span class="line">etcd_var=3.4.13-0</span><br><span class="line">coredns_var=v1.8.0</span><br><span class="line">image_aliyun=(kube-apiserver:$apiserver_var kube-controller-manager:$controller_manager_var kube-scheduler:$scheduler_var kube-proxy:$proxy_var pause:$pause_var etcd:$etcd_var coredns/coredns:$coredns_var)</span><br><span class="line"></span><br><span class="line">for image in $&#123;image_aliyun[@]&#125;</span><br><span class="line">do</span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$image</span><br><span class="line">    docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/$image k8s.gcr.io/$&#123;image&#125;</span><br><span class="line">    docker rmi  registry.cn-hangzhou.aliyuncs.com/google_containers/$image</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">./k8s_images.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">问题</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于杭州阿里源里目前没有coredns:v1.8.0版本，所以在北京阿里源下载</span></span><br><span class="line">docker pull registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0</span><br><span class="line">docker tag  registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0 k8s.gcr.io/coredns/coredns:v1.8.0</span><br><span class="line">docker rmi  registry.cn-beijing.aliyuncs.com/dotbalo/coredns:1.8.0</span><br></pre></td></tr></table></figure>

<h3 id="2-4-初始化Master节点"><a href="#2-4-初始化Master节点" class="headerlink" title="2.4 初始化Master节点"></a>2.4 初始化Master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults &gt; kubeadm.config.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">kubeadm.config.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="comment"># 改成master节点IP地址</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.10</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.21</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="comment"># 添加这一段</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">kubeproxy:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">ipvs</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm.config.yml --upload-certs | tee kubeadm-init.log</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化后操作</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<h3 id="2-5-部署网络"><a href="#2-5-部署网络" class="headerlink" title="2.5 部署网络"></a>2.5 部署网络</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p k8s/plugin/flannel &amp;&amp; cd k8s/plugin/flannel</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl create -f kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>kube-flannel.yml文件内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psp.flannel.unprivileged</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">seccomp.security.alpha.kubernetes.io/allowedProfileNames:</span> <span class="string">docker/default</span></span><br><span class="line">    <span class="attr">seccomp.security.alpha.kubernetes.io/defaultProfileName:</span> <span class="string">docker/default</span></span><br><span class="line">    <span class="attr">apparmor.security.beta.kubernetes.io/allowedProfileNames:</span> <span class="string">runtime/default</span></span><br><span class="line">    <span class="attr">apparmor.security.beta.kubernetes.io/defaultProfileName:</span> <span class="string">runtime/default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configMap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secret</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">emptyDir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hostPath</span></span><br><span class="line">  <span class="attr">allowedHostPaths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/etc/cni/net.d&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/etc/kube-flannel&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pathPrefix:</span> <span class="string">&quot;/run/flannel&quot;</span></span><br><span class="line">  <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Users and groups</span></span><br><span class="line">  <span class="attr">runAsUser:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">supplementalGroups:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="attr">fsGroup:</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">  <span class="comment"># Privilege Escalation</span></span><br><span class="line">  <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">defaultAllowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Capabilities</span></span><br><span class="line">  <span class="attr">allowedCapabilities:</span> [<span class="string">&#x27;NET_ADMIN&#x27;</span>, <span class="string">&#x27;NET_RAW&#x27;</span>]</span><br><span class="line">  <span class="attr">defaultAddCapabilities:</span> []</span><br><span class="line">  <span class="attr">requiredDropCapabilities:</span> []</span><br><span class="line">  <span class="comment"># Host namespaces</span></span><br><span class="line">  <span class="attr">hostPID:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostIPC:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostPorts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">min:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">max:</span> <span class="number">65535</span></span><br><span class="line">  <span class="comment"># SELinux</span></span><br><span class="line">  <span class="attr">seLinux:</span></span><br><span class="line">    <span class="comment"># SELinux is unused in CaaSP</span></span><br><span class="line">    <span class="attr">rule:</span> <span class="string">&#x27;RunAsAny&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;extensions&#x27;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&#x27;podsecuritypolicies&#x27;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&#x27;use&#x27;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&#x27;psp.flannel.unprivileged&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/os</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.14.0-rc1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.14.0-rc1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/flannel</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br></pre></td></tr></table></figure>

<p>部署完后可以看到 flannel 网卡</p>
<p><img src="/2024/02/18/kubernetes/flannel%E7%BD%91%E5%8D%A1.png" alt="flannel网卡"></p>
<p>通过命令查看各模块运行情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/k8s%E5%90%84%E6%A8%A1%E5%9D%97%E8%BF%90%E8%A1%8C%E6%83%85%E5%86%B5.png" alt="k8s各模块运行情况"></p>
<h3 id="2-6-添加Node节点"><a href="#2-6-添加Node节点" class="headerlink" title="2.6 添加Node节点"></a>2.6 添加Node节点</h3><ol>
<li>查看kubeadm-init.log</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">kubeadm join 192.168.88.10:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:37c9645a7a2ee75301f132537240157ecd4f464494022cc442f77489c1978989</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在node主机上执行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.88.10:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:37c9645a7a2ee75301f132537240157ecd4f464494022cc442f77489c1978989</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在master主机查看是否加入成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">...</span><br><span class="line">kubectl get pod -n kube-system -o wide</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h2 id="三、k8s资源清单"><a href="#三、k8s资源清单" class="headerlink" title="三、k8s资源清单"></a>三、k8s资源清单</h2><p>在 k8s 中，一般使用 yaml 格式的文件来创建符合我们预期期望的 pod，这样的 yaml 文件我们一般称为资源清单。</p>
<h3 id="3-1-资源类型"><a href="#3-1-资源类型" class="headerlink" title="3.1 资源类型"></a>3.1 资源类型</h3><p><strong>名称空间级别</strong></p>
<p>工作负载型资源：Pod、RS、Deployment、StatefulSet、DaemonSet、Job、CronJob</p>
<p>服务发现及负载均衡型资源：Service</p>
<p>配置与存储型资源：Volume、CSI</p>
<p>特殊类型的存储卷：ConfigMap(当配置中心来使用的资源类型)、Secret(保存敏感数据)、DownwarAPI(把外部环境中的信息输出给容器)</p>
<p>集群级资源：Namespace、Node、Role、ClusterRole、RoleBinding、ClusterRoleBinding</p>
<p>元数据型资源：HPA、PodTemplate、LimitRange</p>
<h3 id="3-2-常用字段"><a href="#3-2-常用字段" class="headerlink" title="3.2 常用字段"></a>3.2 常用字段</h3><p><strong>必要属性</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>apiVersion</td>
<td>String</td>
<td>K8S API 的版本，目前基本是v1，可以用 kubectl api-versions 命令查询</td>
</tr>
<tr>
<td>kind</td>
<td>String</td>
<td>这里指的是 yaml 文件定义的资源类型和角色，比如: Pod</td>
</tr>
<tr>
<td>metadata</td>
<td>Object</td>
<td>元数据对象，固定值写 metadata</td>
</tr>
<tr>
<td>metadata.name</td>
<td>String</td>
<td>元数据对象的名字，这里由我们编写，比如命名Pod的名字</td>
</tr>
<tr>
<td>metadata.namespace</td>
<td>String</td>
<td>元数据对象的命名空间，由我们自身定义</td>
</tr>
<tr>
<td>spec</td>
<td>Object</td>
<td>详细定义对象，固定值写Spec</td>
</tr>
<tr>
<td>spec.containers[]</td>
<td>list</td>
<td>这里是Spec对象的容器列表定义，是个列表</td>
</tr>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>这里定义容器的名字</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>这里定义要用到的镜像名称</td>
</tr>
</tbody></table>
<p><strong>spec 主要对象</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>定义容器的名字</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>定义要用到的镜像的名称</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>String</td>
<td>定义镜像拉取策略，有 Always，Never，IfNotPresent 三个值课选 （1）Always：意思是每次尝试重新拉取镜像 （2）Never：表示仅使用本地镜像 （3）IfNotPresent：如果本地有镜像就是用本地镜像，没有就拉取在线镜像。上面三个值都没设置的话，默认是 Always</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>指定容器启动命令，因为是数组可以指定多个，不指定则使用镜像打包时使用的启动命令</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>指定容器启动命令参数，因为是数组可以指定多个</td>
</tr>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>指定容器的工作目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>指定容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>指定可以被容器挂载的容器卷的路径</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].readOnly</td>
<td>String</td>
<td>设置存储卷路径的读写模式，true 或者 false，默认为读写模式</td>
</tr>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>指定容器需要用到的端口列表</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>指定端口名称</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>指定容器需要监听的端口号</td>
</tr>
<tr>
<td>spec.containers[].ports.hostPort</td>
<td>String</td>
<td>指定容器所在主机需要监听的端口号，默认跟上面 containerPort 相同，注意设置了 hostPort 同一台主机无法启动该容器的相同副本（因为主机的端口号不能相同，这样会冲突）</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>指定端口协议，支持TCP和UDP，默认值为TCP</td>
</tr>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>指定容器运行千需设置的环境变量列表</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>指定环境变量名称</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>指定环境变量值</td>
</tr>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>指定设置容器运行时资源的运行上限</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>指定CPU的限制，单位为 core 数，将用于 docker run –cpu-shares 参数</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>指定 MEM 内存的限制，单位为 MIB，GIB</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>指定容器启动和调度室的限制设置</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPU请求，单位为 core 数，容器启动时初始化可用数量</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>内存请求，单位为 MIB，GIB 容器启动的初始化可用数量</td>
</tr>
</tbody></table>
<p><strong>额外的参数项</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>定义Pod重启策略，可以选择值为 Always、OnFailure、Never，默认值为 Always。1. Always：Pod一旦终止运行，则无论容器是如何终止的，kubelet 服务都将重启它。2. OnFailure：只有 Pod 以非零退出码终止时，kubelet 才会重启该容器。如果容器正常结束（退出码为0），则 kubelet 将不会重启它。3. Never：Pod 终止后，kubelet 将退出码报告给 Master，不会重启该 Pod。</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>定义 Node 的 Label 过滤标签，以 key:value 格式指定</td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>Object</td>
<td>定义pull 镜像是使用 secret 名称，以 name:secretkey 格式指定</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>定义是否使用主机网络模式，默认值为 false。设置 true 表示使用宿主机网络，不使用 docker 网桥，同时设置了 true 将无法在同一台宿主机上启动第二个副本。</td>
</tr>
</tbody></table>
<p><strong>辅助命令</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看资源对象用法</span></span><br><span class="line">kubectl explain &lt;资源对象&gt; </span><br></pre></td></tr></table></figure>

<p>例子：</p>
<ol>
<li>创建 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx.yaml</span></span><br><span class="line"><span class="comment"># 此处只有必要字段</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否生成pod</span></span><br><span class="line">kubectl get pod</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pod详细信息</span></span><br><span class="line">kubectl describe pod nginx-pod</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试能否访问</span></span><br><span class="line">curl 10.244.1.2 # 此处为flannel分配的地址</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="3-3-容器生命周期"><a href="#3-3-容器生命周期" class="headerlink" title="3.3 容器生命周期"></a>3.3 容器生命周期</h3><p>每一个 Pod 被成功创立之前，都会进行初始化，会运行零个或若干个 init 容器，init 容器运行完就释放，接着才会运行 main 主容器，当然在 init 容器运行之前会先运行 pause 容器，以保证存储和网络的可用。</p>
<p>init 容器与普通的容器非常相似，除了以下两点：</p>
<ul>
<li>init 容器总是运行到完成。</li>
<li>每个 init 容器都要在下一个容器启动之前完成。</li>
</ul>
<p>如果 Pod 的 Init 容器失败，kubelet 会不断地重启该 Init 容器直到该容器成功为止。 然而，如果 Pod 对应的 <code>restartPolicy</code> 值为 “Never”，Kubernetes 不会重新启动 Pod。</p>
<p>如果为一个 Pod 指定了多个 Init 容器，这些容器会按顺序逐个运行。 每个 Init 容器必须运行成功，下一个才能够运行。当所有的 Init 容器运行完成时， Kubernetes 才会为 Pod 初始化应用容器并像平常一样运行。</p>
<p><strong>init 容器的使用</strong></p>
<p>因为 Init 容器具有与应用容器分离的单独镜像，其启动相关代码具有如下优势：</p>
<ul>
<li>Init 容器可以包含一些安装过程中应用容器中不存在的实用工具或个性化代码。 例如，没有必要仅为了在安装过程中使用类似 <code>sed</code>、<code>awk</code>、<code>python</code> 或 <code>dig</code> 这样的工具而去 <code>FROM</code> 一个镜像来生成一个新的镜像。</li>
<li>Init 容器可以安全地运行这些工具，避免这些工具导致应用镜像的安全性降低。</li>
<li>应用镜像的创建者和部署者可以各自独立工作，而没有必要联合构建一个单独的应用镜像。</li>
<li>Init 容器能以不同于 Pod 内应用容器的文件系统视图运行。因此，Init 容器可以访问应用容器不能访问的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">Secret</a> 的权限。</li>
<li>由于 Init 容器必须在应用容器启动之前运行完成，因此 Init 容器提供了一种机制来阻塞或延迟应用容器的启动，直到满足了一组先决条件。 一旦前置条件满足，Pod 内的所有的应用容器会并行启动。</li>
</ul>
<p><strong>init 容器使用例子</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">busybox.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="comment"># 定义了一个 Pod 叫 busybox-pod，busybox 封装了 linux 的大量命令</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line"><span class="comment"># 定义该 Pod 下的资源，也就是容器</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义了一个 busybox 容器</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo The busybox app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">  <span class="comment"># 定义 init 容器，init 容器全部执行完前不会执行 busybox 容器</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">    <span class="comment"># 第一个 init 容器，如果检查 service 中没有注册 myservice，则休眠2秒继续执行，直到成功</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done&#x27;</span>]</span><br><span class="line">    <span class="comment"># 第一个 init 容器运行完就运行该 init 容器，检查 service 中有没有注册 mydb</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mydb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until nslookup mydb; do echo waiting for mydb; sleep 2; done&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f busybox.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到一直处于 <code>Init:0/2</code> 状态，因为第一个 init 容器一直没完成</li>
</ol>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="init容器测试一"></p>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="init容器测试二"></p>
<ol start="4">
<li>编写 yaml 文件添加 service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9377</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f service.yaml</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>可以看到两个 init 容器都执行完，main 主容器也就运行了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/init%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="init容器测试三"></p>
<h3 id="3-4-探针"><a href="#3-4-探针" class="headerlink" title="3.4 探针"></a>3.4 探针</h3><p>探针（probe）是由 kubelet 对容器执行的定期诊断。 要执行诊断，kubelet 调用由容器实现的 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#handler-v1-core">Handler</a> （处理程序）。有三种类型的处理程序：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#execaction-v1-core">ExecAction</a>： 在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#tcpsocketaction-v1-core">TCPSocketAction</a>： 对容器的 IP 地址上的指定端口执行 TCP 检查。如果端口打开，则诊断被认为是成功的。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#httpgetaction-v1-core">HTTPGetAction</a>： 对容器的 IP 地址上指定端口和路径执行 HTTP Get 请求。如果响应的状态码大于等于 200 且小于 400，则诊断被认为是成功的。</li>
</ul>
<p>每次探测都将获得以下三种结果之一：</p>
<ul>
<li><code>Success</code>（成功）：容器通过了诊断。</li>
<li><code>Failure</code>（失败）：容器未通过诊断。</li>
<li><code>Unknown</code>（未知）：诊断失败，因此不会采取任何行动。</li>
</ul>
<p>探针可以分为以下三种：</p>
<ul>
<li><code>livenessProbe</code>：指示容器是否正在运行。如果存活态探测失败，则 kubelet 会杀死容器， 并且容器将根据其<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">重启策略</a>决定未来。如果容器不提供存活探针， 则默认状态为 <code>Success</code>。</li>
<li><code>readinessProbe</code>：指示容器是否准备好为请求提供服务。如果就绪态探测失败， 端点控制器将从与 Pod 匹配的所有服务的端点列表中删除该 Pod 的 IP 地址。 初始延迟之前的就绪态的状态值默认为 <code>Failure</code>。 如果容器不提供就绪态探针，则默认状态为 <code>Success</code>。</li>
<li><code>startupProbe</code>: 指示容器中的应用是否已经启动。如果提供了启动探针，则所有其他探针都会被禁用，直到此探针成功为止。如果启动探测失败，<code>kubelet</code> 将杀死容器，而容器依其<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">重启策略</a>进行重启。 如果容器没有提供启动探测，则默认状态为 <code>Success</code>。</li>
</ul>
<h4 id="3-4-1-readinessProbe就绪检测"><a href="#3-4-1-readinessProbe就绪检测" class="headerlink" title="3.4.1 readinessProbe就绪检测"></a>3.4.1 readinessProbe就绪检测</h4><ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">readinessProbe.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readiness-httpget-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="comment"># 调用readinessProbe探针</span></span><br><span class="line">      <span class="attr">readinessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="comment"># 检查80端口</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="comment"># 检查该目录下的网页</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/test.html</span></span><br><span class="line">        <span class="comment"># 容器启动1秒后才进行检测</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># 每3秒检测一次</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f readinessProbe.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到虽然 Pod 运行了，但 ready 状态是不对的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/readinessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="readinessProbe探针测试一"></p>
<ol start="4">
<li>进入容器创建文件，问题即可解决</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it readiness-httpget-pod -- /bin/sh</span><br><span class="line">echo &#x27;this is test&#x27; &gt; /usr/share/nginx/html/test.html</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-livenessProbe存活检测"><a href="#3-4-2-livenessProbe存活检测" class="headerlink" title="3.4.2 livenessProbe存活检测"></a>3.4.2 livenessProbe存活检测</h4><p><strong>livenessProbe-exec</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_exec.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-exec-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;touch /tmp/test; sleep 60; rm -rf /tmp/test; sleep 3600&#x27;</span>]</span><br><span class="line">    <span class="comment"># 查看本地是否有镜像，有则使用，没有则下载</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;-e&#x27;</span>,<span class="string">&#x27;/tmp/test&#x27;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到当 test 文件给删除的时候，Pod 就会重启，重启后又会有 test 文件，一直循环下去</li>
</ol>
<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="livenessProbe探针测试一"></p>
<p><strong>livenessProbe-httpget</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_httpget.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-httpget-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># Pod生成1秒之后会每3秒检测一次是否存在index.html文件，如果超过10秒没有则重启Pod</span></span><br><span class="line">      <span class="attr">livenessProbe:</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line">        <span class="comment"># 允许超时时间</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建容器，可以看到是在正常运行的</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe_httpget.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="livenessProbe探针测试三"></p>
<ol start="3">
<li>删除 index.html 文件，可以看到会执行重启</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it liveness-httpget-pod -- /bin/sh</span><br><span class="line">rm -rf /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E5%9B%9B.png" alt="livenessProbe探针测试四"></p>
<p><strong>livenessProbe-tcp</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">livenessProbe_tcp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-tcp-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-tcp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod，会发现一直处于重启状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f livenessProbe_tcp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/livenessProbe%E6%8E%A2%E9%92%88%E6%B5%8B%E8%AF%95%E4%BA%94.png" alt="livenessProbe探针测试五"></p>
<h4 id="3-4-3-Start-和-Stop"><a href="#3-4-3-Start-和-Stop" class="headerlink" title="3.4.3 Start 和 Stop"></a>3.4.3 Start 和 Stop</h4><p>Start 和 Stop 是指 Pod 在生成后执行和结束前执行的命令</p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">start_stop.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">start-stop-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start-stop-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo this is postStart test &gt; /usr/share/message&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo this is preStop test &gt; /usr/share/message&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Pod，进入 Pod 可以看到 Start 执行的命令，由于 Pod 停止后就没有了，所以看不到 Stop 执行的命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it start-stop-pod -- /bin/sh</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/start_stop%E6%B5%8B%E8%AF%95.png" alt="start_stop测试"></p>
<h2 id="四、k8s控制器"><a href="#四、k8s控制器" class="headerlink" title="四、k8s控制器"></a>四、k8s控制器</h2><h3 id="4-1-什么是控制器"><a href="#4-1-什么是控制器" class="headerlink" title="4.1 什么是控制器"></a>4.1 什么是控制器</h3><p>k8s 中内置了很多 controller，用来控制 Pod 的具体状态和行为。</p>
<p>控制器的类型有：</p>
<ul>
<li>ReplicationController（已弃用） 和 ReplicaSet</li>
<li>Deployment</li>
<li>DaemonSet</li>
<li>StateFulSet</li>
<li>Job 和 CronJob</li>
<li>Horizontal Pod Autoscaling</li>
</ul>
<h3 id="4-2-RS-与-Deployment"><a href="#4-2-RS-与-Deployment" class="headerlink" title="4.2 RS 与 Deployment"></a>4.2 RS 与 Deployment</h3><p>k8s 管理 Pod 主要用到以下三个组件：</p>
<ul>
<li>Replication Controller（RC）：用来确保容器应用的副本数始终保持在用户定义的副本数，如果有容器异常退出，会自动创建新的 Pod 来代替，如果有异常多出的容器也会自动回收。</li>
<li>ReplicaSet（RS）：相比 RC 多了支持 selector，推荐使用 RS。</li>
<li>Deployment：用来管理 RS。</li>
</ul>
<p><strong>RS 单独使用</strong></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">rs_test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># RS名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rs-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 设置副本数</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 设置标签</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">rs-test</span></span><br><span class="line">  <span class="comment"># 设置模板，会根据此模板生成Pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># 与上边RS设置的标签相对应，说明根据该模板创建的Pod都由标签相对RS管理</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">rs-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rs-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 RS，可以看到会根据 <code>replicas</code>设置的数量创建 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f rs_test.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RS%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="RS测试一"></p>
<ol start="3">
<li>删除这些 Pod，RS 也会按照副本数重新建立新的 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod --all</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RS%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="RS测试二"></p>
<p><strong>RS 与 Deployment</strong></p>
<p><img src="/2024/02/18/kubernetes/Deployment%E5%92%8CRS.png" alt="Deployment和RS"></p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="comment"># Deployment详细信息</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 副本数</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 选择标签</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 标签匹配，与Deployment对应</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="comment"># Pod模板</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># 定义标签</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-deployment-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment.yaml --record</span><br><span class="line">record:记录命令，方便每次 reversion 的变化</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到会生成对应的 RS 和 Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/deployment%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="deployment测试一"></p>
<ol start="4">
<li>扩容</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas 5</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>更新镜像</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment/nginx-deployment nginx-deployment-container=daocloud.io/library/nginx:1.19.1</span><br></pre></td></tr></table></figure>

<p>可以看到会创建一个新的 RS，以实现灰度更新</p>
<p><img src="/2024/02/18/kubernetes/deployment%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="deployment测试二"></p>
<ol start="6">
<li>回滚</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>查看回滚状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>查看历史版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout history deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>回到历史指定版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=1</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>暂停更新</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout pause deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<h3 id="4-3-DaemonSet"><a href="#4-3-DaemonSet" class="headerlink" title="4.3 DaemonSet"></a>4.3 DaemonSet</h3><p>DaemonSet 确保全部或者一部分 Node 上运行一个 Pod 的副本，当有 Node 加入集群时，也会为他们新增一个 Pod，当这些 Node 退出集群时，这些 Pod 也会被回收。</p>
<p>DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行 glusterd、ceph等。</li>
<li>运行日志收集daemon，例如fluentd、logstash等。</li>
<li>运行监控daemon，例如 Prometheus 的 Node exporter、zabbix等。</li>
</ul>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">daemonset_test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># DaemonSet名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">daemonset-test</span></span><br><span class="line">  <span class="comment"># 设置标签</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">daemonset-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 该标签要与上边标签一致</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">daemonset-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">daemonset-nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">daemonset-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 DaemonSet</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f daemonset_test.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/daemonset%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="daemonset测试一"></p>
<ol start="3">
<li>删除一个 Pod 之后 DaemonSet 为保证每个节点都至少有一个副本，就会重新创建新的 Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/daemonset%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="daemonset测试二"></p>
<h3 id="4-4-Job-和-CronJob"><a href="#4-4-Job-和-CronJob" class="headerlink" title="4.4 Job 和 CronJob"></a>4.4 Job 和 CronJob</h3><h4 id="4-4-1-Job"><a href="#4-4-1-Job" class="headerlink" title="4.4.1 Job"></a>4.4.1 Job</h4><p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束。</p>
<p><strong>Job spec</strong></p>
<ul>
<li><p><code>spec.template</code>格式同 Pod 相同</p>
</li>
<li><p><code>RestartPolicy</code>仅支持<code>Never</code>和<code>OnFailure</code></p>
</li>
<li><p>单个 Pod 时，默认 Pod 成功运行后 Job 即结束</p>
</li>
<li><p><code>spec.completions</code>标志 Job 结束时需要成功运行的 Pod 个数，默认为1</p>
</li>
<li><p><code>spec.parallelism</code>标志并行运行的 Pod 个数，默认为1</p>
</li>
<li><p><code>spec.activeDeadlineSeconds</code>标志失败 Pod 的重试最大时间，超过该时间就不会再重试</p>
</li>
</ul>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">job.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">job-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="comment"># 通过perl语言进行圆周率计算，计算小数点后2000位</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;perl&#x27;</span>,<span class="string">&#x27;-Mbignum=bpi&#x27;</span>,<span class="string">&#x27;-wle&#x27;</span>,<span class="string">&#x27;print bpi(2000)&#x27;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 Job，可以看到开始是 Running，接着就是 Completed，代表 Job 已经完成</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f job.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/job%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="job测试一"></p>
<ol start="3">
<li>查看日志可以看到计算好的圆周率</li>
</ol>
<p><img src="/2024/02/18/kubernetes/job%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="job测试二"></p>
<h4 id="4-4-2-CronJob"><a href="#4-4-2-CronJob" class="headerlink" title="4.4.2 CronJob"></a>4.4.2 CronJob</h4><p>Cron Job 是基于时间管理控制 Job，即在给定的时间只运行一次、周期性的在指定时间运行。</p>
<p><strong>CronJob spec</strong></p>
<ul>
<li>所有 CronJob 的 <code>schedule:</code> 时间都是基于 kube-controller-manager 的时区。</li>
<li><code>.spec.schedule</code> 是 <code>.spec</code> 需要的域。它使用了 Cron 格式串，例如 <code>0 * * * *</code> or <code>@hourly</code> ，做为它的任务被创建和执行的调度时间。</li>
<li><code>.spec.jobTemplate</code>是任务的模版，是必须项。</li>
<li><code>.spec.startingDeadlineSeconds</code> 域是可选项。它表示任务如果由于某种原因错过了调度时间，开始该任务的截止时间的秒数。过了截止时间，CronJob 就不会开始任务。 不满足这种最后期限的任务会被统计为失败任务。如果该域没有声明，那任务就没有最后期限。</li>
<li><code>.spec.suspend</code>域也是可选的。如果设置为 <code>true</code> ，后续发生的执行都会挂起。 这个设置对已经开始的执行不起作用。默认是关闭的。</li>
<li><code>.spec.successfulJobsHistoryLimit</code> 和 <code>.spec.failedJobsHistoryLimit</code>是可选的。 这两个字段指定应保留多少已完成和失败的任务。 默认设置为3和1。限制设置为0代表相应类型的任务完成后不会保留。</li>
</ul>
<p><strong>并发性规则</strong></p>
<p><code>.spec.concurrencyPolicy</code>声明了 CronJob 创建的任务执行时发生重叠如何处理。 spec 仅能声明下列规则中的一种：</p>
<ul>
<li><code>Allow</code> (默认)：CronJob 允许并发任务执行。</li>
<li><code>Forbid</code>： CronJob 不允许并发任务执行；如果新任务的执行时间到了而老任务没有执行完，CronJob 会忽略新任务的执行。</li>
<li><code>Replace</code>：如果新任务的执行时间到了而老任务没有执行完，CronJob 会用新任务替换当前正在运行的任务。</li>
</ul>
<p>并发性规则仅适用于相同 CronJob 创建的任务。如果有多个 CronJob，它们相应的任务总是允许并发执行的。</p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">crontjob.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cronjob</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># CronJob必要字段，格式为分时日月周</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="comment"># job模板</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">crontab-pod</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">&#x27;Welcome My K8s&#x27;</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 CronJob，可以看到每分钟都会创建一个 Job 和 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cronjob.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/cronjob%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="cronjob测试一"></p>
<p><img src="/2024/02/18/kubernetes/cronjob%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="cronjob测试二"></p>
<h2 id="五、Service"><a href="#五、Service" class="headerlink" title="五、Service"></a>五、Service</h2><h3 id="5-1-什么是Service"><a href="#5-1-什么是Service" class="headerlink" title="5.1 什么是Service"></a>5.1 什么是Service</h3><p><img src="/2024/02/18/kubernetes/Service%E4%B8%80.png" alt="Service一"></p>
<p>到这里我们都知道，Deployment 会根据 <code>replicas</code>保证 Pod 的数量，当上图的其中一个 php-fpm Pod 出现问题时，就会新建一个来代替。但这时候会会出现一个问题，新的 Pod 的地址与旧的很可能不一样，那 nginx 也无法连接到新的 Pod，除非修改 nginx 的配置，这样的 k8s 集群效率是非常低的。</p>
<p>Service 就能解决该问题，在 nginx 和 php-fpm 中间添加一个 Service，由该 Service 来管理各 php-fpm Pod 的信息，每个 Pod 会设置一个标签，只要与 SVC 中设置的标签相匹配，就可以进行管理，其它 Pod（例如下图的 nginx）想要访问该 SVC 管理的 Pod，只要通过 SVC 的地址就可以访问到。</p>
<p>Service 定义了这样一种抽象：逻辑上的一组 Pod，一种可以访问它们的策略 —— 通常称为微服务。</p>
<p><img src="/2024/02/18/kubernetes/Service%E4%BA%8C.png" alt="Service二"></p>
<h3 id="5-2-Service发布服务（服务类型"><a href="#5-2-Service发布服务（服务类型" class="headerlink" title="5.2 Service发布服务（服务类型)"></a>5.2 Service发布服务（服务类型)</h3><p>对一些应用的某些部分（如前端），可能希望将其暴露给 Kubernetes 集群外部 的 IP 地址。</p>
<p>Kubernetes <code>ServiceTypes</code> 允许指定你所需要的 Service 类型，默认是 <code>ClusterIP</code>。</p>
<p><code>Type</code> 的取值以及行为如下：</p>
<ul>
<li><code>ClusterIP</code>：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是默认的 <code>ServiceType</code>。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#nodeport"><code>NodePort</code></a>：通过每个节点上的 IP 和静态端口（<code>NodePort</code>）暴露服务。 <code>NodePort</code> 服务会路由到自动创建的 <code>ClusterIP</code> 服务。 通过请求 <code>&lt;节点 IP&gt;:&lt;节点端口&gt;</code>，你可以从集群的外部访问一个 <code>NodePort</code> 服务。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer"><code>LoadBalancer</code></a>：使用云提供商的负载均衡器向外部暴露服务。 外部负载均衡器可以将流量路由到自动创建的 <code>NodePort</code> 服务和 <code>ClusterIP</code> 服务上。</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#externalname"><code>ExternalName</code></a>：通过返回 <code>CNAME</code> 和对应值，可以将服务映射到 <code>externalName</code> 字段的内容（例如，<code>foo.bar.example.com</code>）。 无需创建任何类型代理。</li>
</ul>
<p><strong>ClusterIP</strong></p>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E7%B1%BB%E5%9E%8B.png" alt="ClusterIP类型"></p>
<p><strong>NodePort</strong></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E7%B1%BB%E5%9E%8B.png" alt="NodePort类型"></p>
<p><strong>LoadBalancer</strong></p>
<p><img src="/2024/02/18/kubernetes/LoadBalancer%E7%B1%BB%E5%9E%8B.png" alt="LoadBalancer类型"></p>
<p><strong>ExternalName</strong></p>
<p><img src="/2024/02/18/kubernetes/ExternalName%E7%B1%BB%E5%9E%8B.png" alt="ExternalName类型"></p>
<h3 id="5-3-虚拟-IP-和-Service-代理"><a href="#5-3-虚拟-IP-和-Service-代理" class="headerlink" title="5.3 虚拟 IP 和 Service 代理"></a>5.3 虚拟 IP 和 Service 代理</h3><p>在 Kubernetes 集群中，每个 Node 运行一个 <code>kube-proxy</code> 进程。 <code>kube-proxy</code> 负责为 Service 实现了一种 VIP（虚拟 IP）的形式，而不是 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#externalname"><code>ExternalName</code></a> 的形式。</p>
<p><strong>代理模式分类：</strong></p>
<p><strong>userspace 代理模式</strong></p>
<p>在该模式下，所有操作都要通过 kube-proxy 进行一个代理的操作，kube-proxy 的压力相对会较大。</p>
<p><img src="/2024/02/18/kubernetes/userspace%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="userspace代理模式"></p>
<p><strong>iptables 代理模式</strong></p>
<p>在该模式下，所有的访问都通过 iptables 来处理，kube-proxy 的压力就会减小很多。</p>
<p><img src="/2024/02/18/kubernetes/iptables%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="iptables代理模式"></p>
<p><strong>IPVS 代理模式</strong></p>
<p>在该模式下，iptables 换成了 IPVS，通过内核模块来实现负载均衡。</p>
<p>在 <code>ipvs</code> 模式下，kube-proxy 监视 Kubernetes 服务和端点，调用 <code>netlink</code> 接口相应地创建 IPVS 规则， 并定期将 IPVS 规则与 Kubernetes 服务和端点同步。 该控制循环可确保 IPVS 状态与所需状态匹配。访问服务时，IPVS 将流量定向到后端Pod之一。</p>
<p>IPVS代理模式基于类似于 iptables 模式的 netfilter 挂钩函数， 但是使用哈希表作为基础数据结构，并且在内核空间中工作。 这意味着，与 iptables 模式下的 kube-proxy 相比，IPVS 模式下的 kube-proxy 重定向通信的延迟要短，并且在同步代理规则时具有更好的性能。 与其他代理模式相比，IPVS 模式还支持更高的网络流量吞吐量。</p>
<p>IPVS 提供了更多选项来平衡后端 Pod 的流量。 这些是：</p>
<ul>
<li><code>rr</code>：轮替（Round-Robin）</li>
<li><code>lc</code>：最少链接（Least Connection），即打开链接数量最少者优先</li>
<li><code>dh</code>：目标地址哈希（Destination Hashing）</li>
<li><code>sh</code>：源地址哈希（Source Hashing）</li>
<li><code>sed</code>：最短预期延迟（Shortest Expected Delay）</li>
<li><code>nq</code>：从不排队（Never Queue）</li>
</ul>
<p>注意：当 kube-proxy 以 IPVS 代理模式启动时，它将验证 IPVS 内核模块是否可用。 如果未检测到 IPVS 内核模块，则 kube-proxy 将退回到以 iptables 代理模式运行。</p>
<p><img src="/2024/02/18/kubernetes/IPVS%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.svg" alt="IPVS代理模式"></p>
<h3 id="5-4-ClusterIP"><a href="#5-4-ClusterIP" class="headerlink" title="5.4 ClusterIP"></a>5.4 ClusterIP</h3><p>ClusterIP 主要在每个 Node 节点使用 iptables &#x2F; IPVS，将发向 ClusterIP 对应端口的数据，转发到 kube-proxy 中，kube-proxy 内部可以实现负载均衡，并可以查询到该 Service 下对应 Pod 的地址和端口，进而把数据转发给对应的 Pod 的地址和端口。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建 Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_svc_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># 创建两个标签</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="comment"># 释放的端口</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 Service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">clusterip_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-clusterip-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># 用来匹配Pod中的标签，全部匹配才会管理该Pod</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到 Deployment 和 SVC 都已经创建成功，且直接访问 SVC 的 ClusterIP 地址就可以访问到 Pod 了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="ClusterIP测试一"></p>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="ClusterIP测试二"></p>
<ol start="4">
<li>测试负载均衡，在各容器内部创建一个 html 页面</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-deployment-*** -- /bin/bash</span><br><span class="line">echo &#x27;this is node01-pod01&#x27; &gt; /usr/share/nginx/html/pod.html</span><br><span class="line">echo &#x27;this is node02-pod01&#x27; &gt; /usr/share/nginx/html/pod.html</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>可以看到是实现了负载均衡的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ClusterIP%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="ClusterIP测试三"></p>
<h3 id="5-5-无头服务（Headless-Services）"><a href="#5-5-无头服务（Headless-Services）" class="headerlink" title="5.5 无头服务（Headless Services）"></a>5.5 无头服务（Headless Services）</h3><p>有时不需要或不想要负载均衡，以及单独的 Service IP。 遇到这种情况，可以通过指定 Cluster IP（<code>spec.clusterIP</code>）的值为 <code>&quot;None&quot;</code> 来创建 <code>Headless</code> Service。</p>
<p>可以使用无头 Service 与其他服务发现机制进行接口，而不必与 Kubernetes 的实现捆绑在一起。</p>
<p>对这无头 Service 并不会分配 Cluster IP，kube-proxy 不会处理它们， 而且平台也不会为它们进行负载均衡和路由。 DNS 如何实现自动配置，依赖于 Service 是否定义了选择算符。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建 Headless Service</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">headless_service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">headless-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>可以看到是没有分配 VIP 的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="无头服务测试一"></p>
<ol start="3">
<li>安装 bind-utils 工具来测试无头服务的作用，可以看到即使没有了 VIP，但依旧可以通过域名来访问到不同的 Pod</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">k8s内部使用dns访问格式：SVC名称.命名空间.svc.集群域(默认集群域为cluster.local)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dig命令可以用来获取域名的详细信息</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.244.0.37是其中一个coredns的地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-t A:显示A记录，A记录是将域名指向一个IPv4地址，即一个域名解析到一个IP地址</span></span><br><span class="line">dig -t A headless-service.default.svc.cluster.local @10.244.0.37</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="无头服务测试二"></p>
<h3 id="5-6-NodePort"><a href="#5-6-NodePort" class="headerlink" title="5.6 NodePort"></a>5.6 NodePort</h3><p>NodePort 的原理在于在 Node 上开放了一个端口，将该端口的流量导入到 kube-proxy 中，然后再由 kube-proxy 传送给不同的 Pod。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建 Service，这里的标签仍与上面 ClusterIP 中的 Deployment 创建的 Pod 相匹配</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nodeport_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-nodeport-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-port</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>可以看到会暴露一个端口，外部通过这个端口就可以访问到内部的 Pod，且是每一个 Node 都开启了这个端口，所以也可以实现负载均衡</li>
</ol>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="NodePort测试一"></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="NodePort测试一"></p>
<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="NodePort测试三"></p>
<ol start="3">
<li>在 iptables &#x2F; IPVS 规则中可以看到开启该端口的规则</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -nvl | grep 31419</span><br><span class="line">ipvsadm -Ln | grep 31419</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/NodePort%E6%B5%8B%E8%AF%95%E5%9B%9B.png" alt="NodePort测试四"></p>
<h3 id="5-7-LoadBalancer"><a href="#5-7-LoadBalancer" class="headerlink" title="5.7 LoadBalancer"></a>5.7 LoadBalancer</h3><p>LoadBalancer 就是在 NodePort 的基础上，通过 LAAS 来实现负载均衡，用户指要访问 LAAS即可，LAAS 会将请求通过调度转发给不同的 Node。</p>
<h3 id="5-8-ExternalName"><a href="#5-8-ExternalName" class="headerlink" title="5.8 ExternalName"></a>5.8 ExternalName</h3><p>ExternalName 通过返回 CNAME 和它的值，将服务映射到 ExternalName 字段的内容，ExternalName 没有 selector，也没有端口的设置，对于运行在集群之外的服务，ExternalName 是通过该外部服务的别名来提供服务的。</p>
<p>当这个 Service 创建成功时，就会有 <code>externalname-service.default.svc.cluster.local</code> 的 fqdn 被创建，如果有用户访问到这个 fqdn，就会被改写成 <code>my.database.example.com</code>，这就是 DNS 内部的一个 CNAME 记录，也就是别名记录。</p>
<p><strong>示例</strong></p>
<ol>
<li>创建测试用的 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">curl-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">curl-pod-container</span></span><br><span class="line">    <span class="comment"># curl镜像包含测试网络和DNS的工具</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/appropriate/curl</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;curl test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 ExternalName</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">externalname-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">externalname</span></span><br><span class="line">  <span class="comment"># 引入百度的网址</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">www.baidu.com</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入 Pod 内部测试可以看到，通过 nslookup 可以解析到百度的地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nolookup SVC名称.命名空间.svc.集群域</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/externalname%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="externalname测试一"></p>
<h3 id="5-9-ingress"><a href="#5-9-ingress" class="headerlink" title="5.9 ingress"></a>5.9 ingress</h3><h4 id="5-9-1-什么是ingress"><a href="#5-9-1-什么是ingress" class="headerlink" title="5.9.1 什么是ingress"></a>5.9.1 什么是ingress</h4><p>ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。</p>
<p>ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p>
<p>ingress 由两部分构成：</p>
<ul>
<li>ingress controller：将新加入的 ingress 转化成 Nginx 的配置文件并使之生效。</li>
<li>ingress 服务：将 Nginx 的配置抽象成一个 ingress 对象，每添加一个新的服务只需写一个新的 ingress 的 yaml 文件即可。</li>
</ul>
<p>ingress controller 主要有两种，<code>nginx-ingress</code>和<code>traefik-ingress</code>，这里主要讲<code>nginx-ingress</code>。</p>
<p>ingress 官方网址：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/nginx-ingress">https://kubernetes.github.io/nginx-ingress</a></p>
<p>ingress GitHub 网址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/nginx-ingress">https://github.com/kubernetes/nginx-ingress</a></p>
<p><strong>nginx-ingress功能</strong></p>
<p><code>nginx-ingress</code>主要负责向外暴露服务，同时提供负载均衡的功能。</p>
<p>Nginx 对后端运行的服务（Service1、Service2）提供反向代理，在配置文件中配置了域名与后端服务 Endpoints 的对应关系。客户端通过使用 DNS 服务或者直接配置本地的 hosts 文件，将域名都映射到 Nginx 代理服务器。当客户端访问 service1.com 时，浏览器会把包含域名的请求发送给 Nginx 服务器，Nginx 服务器根据传来的域名，选择对应的 Service，这里就是选择 Service1 后端服务，然后根据一定的负载均衡策略，选择 Service1 中的某个容器接收来自客户端的请求并作出响应。过程很简单，Nginx 在整个过程中仿佛是一台根据域名进行请求转发的“路由器”。</p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%80.png" alt="nginx-ingress一"></p>
<p><strong>nginx-ingress工作过程</strong></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%BA%8C.png" alt="nginx-ingress二"></p>
<p><code>nginx-ingress</code>模块在运行时主要分为三个主体：</p>
<ul>
<li>Store：Store 会与 APIServer 以协程的 Pod 方式进行一个监听状态，发生新的事件会写入循环队列里。</li>
<li>NginxController：NginxController 会监听循环队列里的事件，发生一个循环就会更新一个事件，并写入 SyncQueue 里。</li>
<li>SyncQueue：SyncQueue 协程会定期拉取需要执行的任务（如果有必要的则直接从 Store 拉取过来进行修改），接着判断是否需要 reload nginx，最后会以 nginx 模块运行。</li>
</ul>
<h4 id="5-9-2-ingress规则"><a href="#5-9-2-ingress规则" class="headerlink" title="5.9.2 ingress规则"></a>5.9.2 ingress规则</h4><p>每个 HTTP 规则都包含以下信息：</p>
<ul>
<li>可选的 <code>host</code>。在此示例中，未指定 <code>host</code>，因此该规则适用于通过指定 IP 地址的所有入站 HTTP 通信。 如果提供了 <code>host</code>（例如 <a target="_blank" rel="noopener" href="http://www.cqm.com),则/">www.cqm.com），则</a> <code>rules</code> 适用于该 <code>host</code>。</li>
<li>路径列表 paths（例如，<code>/testpath</code>）,每个路径都有一个由 <code>serviceName</code> 和 <code>servicePort</code> 定义的关联后端。 在负载均衡器将流量定向到引用的服务之前，主机和路径都必须匹配传入请求的内容。</li>
<li><code>backend</code>（后端）是 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">Service 文档</a> 中所述的服务和端口名称的组合。 与规则的 <code>host</code> 和 <code>path</code> 匹配的对 Ingress 的 HTTP（和 HTTPS ）请求将发送到列出的 <code>backend</code>。</li>
</ul>
<p><strong>路径类型</strong></p>
<p>Ingress 中的每个路径都需要有对应的路径类型（Path Type）。未明确设置 <code>pathType</code> 的路径无法通过合法性检查。当前支持的路径类型有三种：</p>
<ul>
<li><code>ImplementationSpecific</code>：对于这种路径类型，匹配方法取决于 IngressClass。 具体实现可以将其作为单独的 <code>pathType</code> 处理或者与 <code>Prefix</code> 或 <code>Exact</code> 类型作相同处理。</li>
<li><code>Exact</code>：精确匹配 URL 路径，且区分大小写。</li>
<li><code>Prefix</code>：基于以 <code>/</code> 分隔的 URL 路径前缀匹配。匹配区分大小写，并且对路径中的元素逐个完成。 路径元素指的是由 <code>/</code> 分隔符分隔的路径中的标签列表。 如果每个 <em>p</em> 都是请求路径 <em>p</em> 的元素前缀，则请求与路径 <em>p</em> 匹配。</li>
</ul>
<h4 id="5-9-3-部署nginx-ingress"><a href="#5-9-3-部署nginx-ingress" class="headerlink" title="5.9.3 部署nginx-ingress"></a>5.9.3 部署nginx-ingress</h4><ol>
<li>通过 Bare-metal（NodePort） 方式部署，先下载 yaml 文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">地址一</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.46.0/deploy/static/provider/baremetal/deploy.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">地址二</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/baremetal/deploy.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于镜像地址也在国外，所以通过国内镜像源拉取</span></span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/nginx-ingress-controller:v0.46.0</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/nginx-ingress-controller:v0.46.0 k8s.gcr.io/ingress-nginx/controller:v0.46.0</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取镜像地址，下载好需要的镜像，并导入镜像到其它 node 上</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%89.png" alt="nginx-ingress三"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%9B%9B.png" alt="nginx-ingress四"></p>
<ol start="3">
<li>通过 deploy.yaml 文件生成 svc</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f deploy.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%BA%94.png" alt="nginx-ingress五"></p>
<h4 id="5-9-4-ingress-HTTP代理访问"><a href="#5-9-4-ingress-HTTP代理访问" class="headerlink" title="5.9.4 ingress HTTP代理访问"></a>5.9.4 ingress HTTP代理访问</h4><p> <img src="/2024/02/18/kubernetes/nginx-ingress%E5%85%AD.png" alt="nginx-ingress六"></p>
<p><code>ingress-nginx</code>会根据配置好的 yaml 文件，自动配置 nginx.conf 和虚拟主机文件。</p>
<ol>
<li>创建 deployment1、deployment2、service1、service2</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx2</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 nginx-ingress1、nginx-ingress2</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># 设置虚拟主机，通过该域名访问</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm1.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="comment"># 路径列表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="comment"># 路径类型</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="comment"># 后端</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="comment"># 指定连接哪个SVC</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm2.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment_svc1.yaml</span><br><span class="line">kubectl create -f nginx_deployment_svc2.yaml</span><br><span class="line">kubectl create -f nginx_ingress.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>给每个 Pod 写入信息，方便查看负载均衡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-deployment-... -- /bin/bash</span><br><span class="line">echo &#x27;this is nginx-pod-1&#x27; &gt; /usr/share/nginx/html/pod.html</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>查看 ingress-nginx 所创建的 svc 暴露的端口，以及 service1、service2、nginx-ingress1、nginx-ingress2</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl get ingress</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B8%83.png" alt="nginx-ingress七"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%85%AB.png" alt="nginx-ingress八"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E4%B9%9D.png" alt="nginx-ingress九"></p>
<ol start="6">
<li>在 &#x2F;etc&#x2F;hosts 文件下写入域名与 IP 绑定，访问测试，可以看到实现了负载均衡</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81.png" alt="nginx-ingress十"></p>
<ol start="7">
<li>可以进入 ingress 控制器内部查看 nginx 配置，可以看到自动添加的代理配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it -n ingress-nginx ingress-nginx-controller-... -- /bin/bash</span><br><span class="line">cat nginx.conf</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%80.png" alt="nginx-ingress十一"></p>
<h4 id="5-9-5-ingress-HTTPS代理访问"><a href="#5-9-5-ingress-HTTPS代理访问" class="headerlink" title="5.9.5 ingress HTTPS代理访问"></a>5.9.5 ingress HTTPS代理访问</h4><p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%BA%8C.png" alt="nginx-ingress十二"></p>
<ol>
<li>创建私钥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=nginxsvc/O=nginxsvc&quot;</span><br><span class="line">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 deployment3、service3、nginx-ingress3</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_deployment_svc3.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx3</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">www.cqm3.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm3.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service3</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx_deployment_svc3.yaml nginx_ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%89.png" alt="nginx-ingress十三"></p>
<ol start="5">
<li>在每个 Pod 写入 pod.html，便于查看负载均衡效果，并测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it ingress-nginx-... -- /bin/bash</span><br><span class="line">echo &#x27;this is node01-pod&#x27; &gt; /usr/share/nginx/html/pod.html</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%9B%9B.png" alt="nginx-ingress十四"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%BA%94.png" alt="nginx-ingress十五"></p>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%85%AD.png" alt="nginx-ingress十六"></p>
<h4 id="5-9-5-Nginx进行基础认证（BasicAuth）"><a href="#5-9-5-Nginx进行基础认证（BasicAuth）" class="headerlink" title="5.9.5 Nginx进行基础认证（BasicAuth）"></a>5.9.5 Nginx进行基础认证（BasicAuth）</h4><ol>
<li>通过 Apache 创建用户认证文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">htpasswd -c auth cqm</span><br><span class="line">kubectl create secret generic basic-auth --from-file=auth</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 ingress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nginx_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-auth</span></span><br><span class="line">  <span class="comment"># 添加基础认证字段</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required - cqm&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.cqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="comment"># 这里使用HTTP代理实验的service1</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建 ingress 后测试</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B8%83.png" alt="nginx-ingress十七"></p>
<h4 id="5-9-6-Nginx重写"><a href="#5-9-6-Nginx重写" class="headerlink" title="5.9.6  Nginx重写"></a>5.9.6  Nginx重写</h4><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;rewrite-target</td>
<td>必须重定向流量的目标 URI</td>
<td>string</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-redirect</td>
<td>指示位置部分是否仅可访问 SSL（当 Ingress 包含证书时默认为 True）</td>
<td>bool</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;force-ssl-redirect</td>
<td>即使 Ingress 未启用 TLS，也强制重定向到 HTTPS</td>
<td>bool</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;app-root</td>
<td>定义控制器必须重定向的应用程序根，如果它在“&#x2F;”上下文中</td>
<td>string</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;use-regex</td>
<td>指示 Ingress 上定义的路径是否使用正则表达式</td>
<td>bool</td>
</tr>
</tbody></table>
<ol>
<li>先准备好转发后的 deployment、ingress等，这里用上边的 ingress1，用户访问 <a target="_blank" rel="noopener" href="http://www.rewritecqm.com/">www.rewritecqm.com</a> 时就跳转到 <a target="_blank" rel="noopener" href="http://www.cqm1.com/">www.cqm1.com</a></li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E5%85%AB.png" alt="nginx-ingress十八"></p>
<ol start="2">
<li>编写重写 ingress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">rewrite_ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rewrite-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 访问 www.rewritecqm.com:30779 将跳转到 http://www.cqm1.com:30779/pod.html</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">http://www.cqm1.com:30779/pod.html</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.rewritecqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/pod.html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/kubernetes/nginx-ingress%E5%8D%81%E4%B9%9D.png" alt="nginx-ingress十九"></p>
<h2 id="六、k8s存储"><a href="#六、k8s存储" class="headerlink" title="六、k8s存储"></a>六、k8s存储</h2><h3 id="6-1-配置存储卷"><a href="#6-1-配置存储卷" class="headerlink" title="6.1 配置存储卷"></a>6.1 配置存储卷</h3><p>配置存储卷并不是用来进行容器间相互交互或 Pod 间数据共享的，而是用于向各个 Pod 注入配置信息的，主要分为以下三种：</p>
<p>ConfigMap：可传递普通信息</p>
<p>Secret：可传递密码等敏感的配置信息</p>
<p>DownwardAPI：可传递 Pod 和容器自身的运行信息</p>
<h4 id="6-1-1-ConfigMap"><a href="#6-1-1-ConfigMap" class="headerlink" title="6.1.1 ConfigMap"></a>6.1.1 ConfigMap</h4><p>许多应用程序都会从配置文件、命令行参数或环境变量中读取配置信息。</p>
<p>ConfigMap API 给我们提供了向容器内部注入信息的机制，ConfigMap 可以被用来保存单个属性，也可以用来保存整个配置文件或者 JSON 二进制对象。</p>
<p>ConfigMap 的创建方式有三种，分别为基于目录、文件和字面值来创建。</p>
<p><strong>基于目录创建 ConfigMap</strong></p>
<ol>
<li>创建指定目录，下载官方测试文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/k8s/plugin/configmap/dir || cd /root/k8s/plugin/configmap/dir</span><br><span class="line">wget https://kubernetes.io/examples/configmap/game.properties</span><br><span class="line">wget https://kubernetes.io/examples/configmap/ui.properties</span><br><span class="line">kubectl create configmap configmap1 --from-file=./</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe cm configmap1</span><br><span class="line">kubectl get cm configmap1 -o yaml</span><br></pre></td></tr></table></figure>

<p><strong>基于文件创建 ConfigMap</strong></p>
<ol>
<li>通过 game.properties 和 ui.properties 创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap configmap2 --from-file=game.properties --from-file=ui.properties</span><br></pre></td></tr></table></figure>

<p><strong>基于字面值创建 ConfigMap</strong></p>
<ol>
<li>通过<code>--from-literal=键名=键值</code>来创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap configmap3 --from-literal=special.how=very</span><br></pre></td></tr></table></figure>

<h5 id="6-1-1-1-Pod中使用ConfigMap"><a href="#6-1-1-1-Pod中使用ConfigMap" class="headerlink" title="6.1.1.1 Pod中使用ConfigMap"></a>6.1.1.1 Pod中使用ConfigMap</h5><p><strong>使用 ConfigMap 代替环境变量</strong></p>
<ol>
<li>创建两个 ConfigMap</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">special_cm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">special.how:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">special.type:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">env_cm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将这两个 ConfigMap 注入到 Pod中</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod1-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span>]</span><br><span class="line">      <span class="comment"># env:取某个 ConfigMap 中的某个键值</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_HOW_KEY</span></span><br><span class="line">          <span class="comment"># 定义环境变量</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="comment"># 表示从 ConfigMap 中引用</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="comment"># 要引用的 ConfigMap 名称</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="comment"># 引用 ConfigMap 中的哪个键值对</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">      <span class="comment"># envFrom:取某个 ConfigMap 的所有键值</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>生成 Pod 后查看日志，可以看到注入成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs pod1</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%B8%80.png" alt="ConfigMap一"></p>
<p><strong>使用 ConfigMap 设置命令行参数</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod2-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo $(SPECIAL_HOW_KEY) $(SPECIAL_TYPE_KEY)&quot;</span>]</span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_HOW_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">env-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p><strong>将 ConfigMap 数据添加到一个卷中</strong></p>
<ol>
<li>创建 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod3.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod3-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 1200&quot;</span> ]</span><br><span class="line">      <span class="comment"># 挂载config-volume，挂载在/etc/config目录下</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="comment"># 创建一个卷，将special-cm内容写入config-volume卷</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-cm</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 Pod，在挂载目录下查看是否写入到 config 文件里</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%BA%8C.png" alt="ConfigMap二"></p>
<h5 id="6-1-1-2-ConfigMap热更新"><a href="#6-1-1-2-ConfigMap热更新" class="headerlink" title="6.1.1.2 ConfigMap热更新"></a>6.1.1.2 ConfigMap热更新</h5><p>本例子通过 ConfigMap 来实现热更新，可以实现热更新 nginx.conf，但需进入容器内部重载配置文件，所以通过热更新一个 html 来展示效果。</p>
<ol>
<li>编写 yaml 文件，并创建</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">hotupdate.yaml</span></span><br><span class="line"><span class="comment"># ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-hotupdate-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">test.html:</span> <span class="string">&#x27;this is the fist test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># 挂载下边创建的volume</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-html-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="comment"># 创建一个volume，通过ConfigMap方式挂载，使用上面创建的nginx-hotupdate-cm</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-html-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-hotupdate-cm</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hotupdate.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试是否能够访问到</li>
</ol>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%B8%89.png" alt="ConfigMap三"></p>
<ol start="3">
<li>修改 ConfigMap，并再次访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm nginx-hotupdate-cm</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/ConfigMap%E5%9B%9B.png" alt="ConfigMap四"></p>
<p><img src="/2024/02/18/kubernetes/ConfigMap%E4%BA%94.png" alt="ConfigMap五"></p>
<h4 id="6-1-2-Secret"><a href="#6-1-2-Secret" class="headerlink" title="6.1.2 Secret"></a>6.1.2 Secret</h4><p><code>Secret</code> 对象类型用来保存敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 将这些信息放在 <code>secret</code> 中比放在 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 的定义或者 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-image">容器镜像</a> 中来说更加安全和灵活。</p>
<p><strong>Secret 的类型</strong></p>
<table>
<thead>
<tr>
<th>内置类型</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td><code>Opaque</code></td>
<td>用户定义的任意数据</td>
</tr>
<tr>
<td><code>kubernetes.io/service-account-token</code></td>
<td>服务账号令牌</td>
</tr>
<tr>
<td><code>kubernetes.io/dockercfg</code></td>
<td><code>~/.dockercfg</code> 文件的序列化形式</td>
</tr>
<tr>
<td><code>kubernetes.io/dockerconfigjson</code></td>
<td><code>~/.docker/config.json</code> 文件的序列化形式</td>
</tr>
<tr>
<td><code>kubernetes.io/basic-auth</code></td>
<td>用于基本身份认证的凭据</td>
</tr>
<tr>
<td><code>kubernetes.io/ssh-auth</code></td>
<td>用于 SSH 身份认证的凭据</td>
</tr>
<tr>
<td><code>kubernetes.io/tls</code></td>
<td>用于 TLS 客户端或者服务器端的数据</td>
</tr>
<tr>
<td><code>bootstrap.kubernetes.io/token</code></td>
<td>启动引导令牌数据</td>
</tr>
</tbody></table>
<h5 id="6-1-2-1-Opaque"><a href="#6-1-2-1-Opaque" class="headerlink" title="6.1.2.1 Opaque"></a>6.1.2.1 Opaque</h5><p>Opaque 使用base64编码存储信息，可以通过 <code>base64 --decode</code> 解码获得原始数据，因此安全性弱。</p>
<p>使用示例</p>
<ol>
<li>生成 base64 编码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;admin&#x27; | base64</span><br><span class="line">YWRtaW4K</span><br><span class="line">echo &#x27;12345&#x27; | base64</span><br><span class="line">MTIzNDUK</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4K</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIzNDUK</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f opaque.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>挂载到 volume 中使用，查看测试可以看到挂载后的信息被解码了</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque-pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opaque-pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opaque-pod1-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="comment"># 挂载下边创建的volume-opaque</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-opaque</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/secrets</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># 创建一个secret类型的volume，引用上边创建好的secret-opaque</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-opaque</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">secret-opaque</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%B8%80.png" alt="secret一"></p>
<ol start="4">
<li>导入到环境变量中并测试</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">opaque-pod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opaque-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">opaque-pod2</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opaque-pod2-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># 将secret导入环境变量中</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># 命名变量</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER</span></span><br><span class="line">          <span class="comment"># 引用secret-opaque中的username的键值</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PASSWORD</span></span><br><span class="line">          <span class="comment"># 引用secret-opaque中的password的键值</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">secret-opaque</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%BA%8C.png" alt="secret二"></p>
<h5 id="6-1-2-2-ImagePullSecret"><a href="#6-1-2-2-ImagePullSecret" class="headerlink" title="6.1.2.2 ImagePullSecret"></a>6.1.2.2 ImagePullSecret</h5><p>可以使用下面两种 <code>type</code> 值之一来创建 Secret，用以存放访问 Docker 仓库来下载镜像的凭据。</p>
<ul>
<li><code>kubernetes.io/dockercfg</code></li>
<li><code>kubernetes.io/dockerconfigjson</code></li>
</ul>
<p><code>kubernetes.io/dockerconfigjson</code> 创建 Secret 示例</p>
<ol>
<li>创建 Secret</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry cqmregistry --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/secret%E4%B8%89.png" alt="secret三"></p>
<ol start="2">
<li>在 Pod 中运用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">  <span class="comment"># 调用创建好的Secret</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cqmregistry</span></span><br></pre></td></tr></table></figure>

<h5 id="6-1-2-3-Downward-API"><a href="#6-1-2-3-Downward-API" class="headerlink" title="6.1.2.3 Downward API"></a>6.1.2.3 Downward API</h5><p>有时候 Pod 需要获取自身的信息，这时候 Downward API 就派上用场了。</p>
<p>Downward API 是通过 fieldRef 参数获取信息的。</p>
<p><strong>示例一</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod1-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;EnvPodName:$&#123;EnvPodName&#125; EnvNodeName:$&#123;EnvNodeName&#125;&quot;, sleep 3600&#x27;</span> ]</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EnvPodName</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EnvNodeName</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br></pre></td></tr></table></figure>

<p><strong>示例二</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod2-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;EnvPodName:$&#123;EnvPodName&#125; EnvNodeName:$&#123;EnvNodeName&#125;&quot;, sleep 3600&#x27;</span> ]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">downwardAPI:</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;PodName&#x27;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;NodeName&#x27;</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-本地存储卷"><a href="#6-2-本地存储卷" class="headerlink" title="6.2 本地存储卷"></a>6.2 本地存储卷</h3><p>Container 中的文件在磁盘上是临时存放的，这给 Container 中运行的较重要的应用程序带来一些问题。问题之一是当容器崩溃时文件丢失。kubelet 会重新启动容器， 但容器会以干净的状态重启。 第二个问题会在同一 <code>Pod</code> 中运行多个容器并共享文件时出现。 Kubernetes <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">Volume</a> 这一抽象概念能够解决这两个问题。</p>
<p>Kubernetes 支持很多类型的卷。 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 可以同时使用任意数目的卷类型。 临时卷类型的生命周期与 Pod 相同，但持久卷可以比 Pod 的存活期长。 当 Pod 不再存在时，Kubernetes 也会销毁临时卷；不过 Kubernetes 不会销毁持久卷。对于给定 Pod 中任何类型的卷，在容器重启期间数据都不会丢失。</p>
<p><img src="/2024/02/18/kubernetes/volume%E4%B8%80.png" alt="volume一"></p>
<p>卷的类型分为很多种，可通过官方文档查看：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">https://kubernetes.io/zh/docs/concepts/storage/volumes/</a></p>
<h4 id="6-2-1-emptyDir"><a href="#6-2-1-emptyDir" class="headerlink" title="6.2.1 emptyDir"></a>6.2.1 emptyDir</h4><p>当 Pod 分派到某个 Node 上时，<code>emptyDir</code> 卷会被创建，并且在 Pod 在该节点上运行期间，卷一直存在。 就像其名称表示的那样，卷最初是空的。 尽管 Pod 中的容器挂载 <code>emptyDir</code> 卷的路径可能相同也可能不同，这些容器都可以读写 <code>emptyDir</code> 卷中相同的文件。 当 Pod 因为某些原因被从节点上删除时，<code>emptyDir</code> 卷中的数据也会被永久删除。</p>
<p>需要注意的是，容器崩溃并不会导致 Pod 被从节点上移除，因此容器崩溃期间 <code>emptyDir</code> 卷中的数据是安全的。</p>
<p><code>emptyDir</code> 的一些用途：</p>
<ul>
<li>缓存空间，例如基于磁盘的归并排序。</li>
<li>为耗时较长的计算任务提供检查点，以便任务能方便地从崩溃前状态恢复执行。</li>
<li>在 Web 服务器容器服务数据时，保存内容管理器容器获取的文件。</li>
</ul>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">emptydir-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-container1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/empty1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-container2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;sleep 6000&#x27;</span>]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/empty2</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">emptydir-volume</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 Pod 中的不同容器查看是否共享同一个 volume，</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E4%BA%8C.png" alt="volume二"></p>
<p><img src="/2024/02/18/kubernetes/volume%E4%B8%89.png" alt="volume三"></p>
<h4 id="6-2-2-hostPath"><a href="#6-2-2-hostPath" class="headerlink" title="6.2.2 hostPath"></a>6.2.2 hostPath</h4><p><code>hostPath</code> 卷能将主机节点文件系统上的文件或目录挂载到你的 Pod 中，类似 docker 中的 volume 挂载。</p>
<p><code>hostPath</code> 的一些用法有：</p>
<ul>
<li>运行一个需要访问 Docker 内部机制的容器；可使用 <code>hostPath</code> 挂载 <code>/var/lib/docker</code> 路径。</li>
<li>在容器中运行 cAdvisor（容器监控工具） 时，以 <code>hostPath</code> 方式挂载 <code>/sys</code>。</li>
<li>允许 Pod 指定给定的 <code>hostPath</code> 在运行 Pod 之前是否应该存在，是否应该创建以及应该以什么方式存在。</li>
</ul>
<p>除了必需的 <code>path</code> 属性之外，用户可以选择性地为 <code>hostPath</code> 卷指定 <code>type</code>。</p>
<p>支持的 <code>type</code> 值如下：</p>
<table>
<thead>
<tr>
<th align="left">取值</th>
<th align="left">行为</th>
</tr>
</thead>
<tbody><tr>
<td align="left"></td>
<td align="left">空字符串（默认）用于向后兼容，这意味着在安装 hostPath 卷之前不会执行任何检查。</td>
</tr>
<tr>
<td align="left"><code>DirectoryOrCreate</code></td>
<td align="left">如果在给定路径上什么都不存在，那么将根据需要创建空目录，权限设置为 0755，具有与 kubelet 相同的组和属主信息。</td>
</tr>
<tr>
<td align="left"><code>Directory</code></td>
<td align="left">在给定路径上必须存在的目录。</td>
</tr>
<tr>
<td align="left"><code>FileOrCreate</code></td>
<td align="left">如果在给定路径上什么都不存在，那么将在那里根据需要创建空文件，权限设置为 0644，具有与 kubelet 相同的组和所有权。</td>
</tr>
<tr>
<td align="left"><code>File</code></td>
<td align="left">在给定路径上必须存在的文件。</td>
</tr>
<tr>
<td align="left"><code>Socket</code></td>
<td align="left">在给定路径上必须存在的 UNIX 套接字。</td>
</tr>
<tr>
<td align="left"><code>CharDevice</code></td>
<td align="left">在给定路径上必须存在的字符设备。</td>
</tr>
<tr>
<td align="left"><code>BlockDevice</code></td>
<td align="left">在给定路径上必须存在的块设备。</td>
</tr>
</tbody></table>
<p>注意：具有相同配置（例如基于同一 PodTemplate 创建）的多个 Pod 会由于节点上文件的不同而在不同节点上有不同的行为，即假如同一个 template 创建出来的 Pod 分配在了不同的 Node 上时，会因为节点的不同而产生不同的行为。</p>
<ol>
<li>编写 yaml 文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hostpath-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># 宿主机被挂载目录</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># 如果没有/data目录则会被创建</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看是否挂载成功</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%9B%9B.png" alt="volume四"></p>
<p>需要注意的是，在<code>FileOrCreate</code>下，如果被挂载的目录不存在，那么不会自动创建该目录， 为了确保这种模式能够工作，可以尝试把文件和它对应的目录分开挂载。</p>
<p><strong>hostPath FileOrCreate 配置示例</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath-fileorcreate-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostpath-fileorcreate-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mydir</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test/test.txt</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myfile</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydir</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># 如果宿主机没有/data目录则会自动创建</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfile</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/test.txt</span></span><br><span class="line">      <span class="comment"># 因为上面已经确保会有/data目录，所以该文件的挂载不受影响</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-持久存储卷"><a href="#6-3-持久存储卷" class="headerlink" title="6.3 持久存储卷"></a>6.3 持久存储卷</h3><h4 id="6-3-1-PV和PVC"><a href="#6-3-1-PV和PVC" class="headerlink" title="6.3.1 PV和PVC"></a>6.3.1 PV和PVC</h4><p>PV 和 PVC 是 k8s 提供的两个 api 资源。</p>
<p><strong>PV</strong></p>
<p>持久卷（PersistentVolume，PV）是集群中的一块存储，可以由管理员事先供应，或者使用<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">存储类</a>来动态供应，PV 是集群资源，和普通的 Volume 一样，也是使用卷插件来实现的，只是它们拥有独立于任何使用 PV 的 Pod 的生命周期。</p>
<p><img src="/2024/02/18/kubernetes/volume%E4%BA%94.png" alt="volume五"></p>
<p><strong>PVC</strong></p>
<p>持久卷申领（PersistentVolumeClaim，PVC）表达的是用户对存储的请求。概念上与 Pod 类似。Pod 会耗用 Node 资源，而 PVC 申领会耗用 PV 资源。Pod 可以请求特定数量的资源（CPU 和内存），同样 PVC 申领也可以请求特定的大小和访问模式。</p>
<p><img src="/2024/02/18/kubernetes/volume%E5%85%AD.png" alt="volume六"></p>
<p><strong>PV 的供应方式有两种：</strong></p>
<p><strong>静态供应</strong></p>
<p>集群管理员创建若干 PV 卷。这些卷对象带有真实存储的细节信息，并且对集群用户可用（可见）。PV 卷对象存在于 Kubernetes API 中，可供用户消费（使用）。</p>
<p><strong>动态供应</strong></p>
<p>如果管理员所创建的所有静态 PV 卷都无法与用户的 PersistentVolumeClaim 匹配， 集群可以尝试为该 PVC 申领动态供应一个存储卷。 这一供应操作是基于 StorageClass 来实现的：PVC 申领必须请求某个 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">存储类</a>，同时集群管理员必须 已经创建并配置了该类，这样动态供应卷的动作才会发生。 如果 PVC 申领指定存储类为 <code>&quot;&quot;</code>，则相当于为自身禁止使用动态供应的卷。</p>
<p>为了基于存储类完成动态的存储供应，集群管理员需要在 API 服务器上启用 <code>DefaultStorageClass</code> <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#defaultstorageclass">准入控制器</a>。 举例而言，可以通过保证 <code>DefaultStorageClass</code> 出现在 API 服务器组件的 <code>--enable-admission-plugins</code> 标志值中实现这点；该标志的值可以是逗号 分隔的有序列表。关于 API 服务器标志的更多信息，可以参考 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver</a> 文档。</p>
<p><strong>绑定</strong></p>
<p>通俗理解就是一旦 PV 与 PVC 进行了绑定，那么该 PV 就无法与其它 PVC 进行绑定了。</p>
<p><strong>保护</strong></p>
<p>当一个 PV 与 PVC 绑定之后，假设 Pod 被删除，那么该 PV 与 PVC 依旧会是一个绑定的关系。</p>
<p><strong>持久卷的类型</strong></p>
<p>PV 持久卷是用插件的形式来实现的。Kubernetes 目前支持以下插件：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#awselasticblockstore"><code>awsElasticBlockStore</code></a> - AWS 弹性块存储（EBS）</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#azuredisk"><code>azureDisk</code></a> - Azure Disk</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#azurefile"><code>azureFile</code></a> - Azure File</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#cephfs"><code>cephfs</code></a> - CephFS volume</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#csi"><code>csi</code></a> - 容器存储接口 (CSI)</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#fc"><code>fc</code></a> - Fibre Channel (FC) 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#flexVolume"><code>flexVolume</code></a> - FlexVolume</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#flocker"><code>flocker</code></a> - Flocker 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#gcepersistentdisk"><code>gcePersistentDisk</code></a> - GCE 持久化盘</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#glusterfs"><code>glusterfs</code></a> - Glusterfs 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath"><code>hostPath</code></a> - HostPath 卷 （仅供单节点测试使用；不适用于多节点集群； 请尝试使用 <code>local</code> 卷作为替代）</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#iscsi"><code>iscsi</code></a> - iSCSI (SCSI over IP) 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local"><code>local</code></a> - 节点上挂载的本地存储设备</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#nfs"><code>nfs</code></a> - 网络文件系统 (NFS) 存储</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#portworxvolume"><code>portworxVolume</code></a> - Portworx 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#quobyte"><code>quobyte</code></a> - Quobyte 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#rbd"><code>rbd</code></a> - Rados 块设备 (RBD) 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#storageos"><code>storageos</code></a> - StorageOS 卷</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#vspherevolume"><code>vsphereVolume</code></a> - vSphere VMDK 卷</li>
</ul>
<p><strong>访问模式</strong></p>
<p>PV 卷可以用资源提供者所支持的任何方式挂载到宿主系统上。 如下表所示，提供者（驱动）的能力不同，每个 PV 卷的访问模式都会设置为 对应卷所支持的模式值。 例如，NFS 可以支持多个读写客户，但是某个特定的 NFS PV 卷可能在服务器 上以只读的方式导出。每个 PV 卷都会获得自身的访问模式集合，描述的是 特定 PV 卷的能力。</p>
<p>访问模式有：</p>
<ul>
<li>ReadWriteOnce：卷可以被一个节点以读写方式挂载；</li>
<li>ReadOnlyMany：卷可以被多个节点以只读方式挂载；</li>
<li>ReadWriteMany：卷可以被多个节点以读写方式挂载。</li>
</ul>
<p>对于不同类型的存储卷访问模式也有不同，如下表</p>
<table>
<thead>
<tr>
<th align="left">卷插件</th>
<th align="center">ReadWriteOnce</th>
<th align="center">ReadOnlyMany</th>
<th align="center">ReadWriteMany</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AWSElasticBlockStore</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">AzureFile</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">AzureDisk</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">CephFS</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">Cinder</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">CSI</td>
<td align="center">取决于驱动</td>
<td align="center">取决于驱动</td>
<td align="center">取决于驱动</td>
</tr>
<tr>
<td align="left">FC</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">FlexVolume</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">取决于驱动</td>
</tr>
<tr>
<td align="left">Flocker</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">GCEPersistentDisk</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">Glusterfs</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">HostPath</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">iSCSI</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">Quobyte</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">NFS</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">RBD</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">VsphereVolume</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">- (Pod 运行于同一节点上时可行)</td>
</tr>
<tr>
<td align="left">PortworxVolume</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">ScaleIO</td>
<td align="center">✓</td>
<td align="center">✓</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">StorageOS</td>
<td align="center">✓</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<p><strong>类</strong></p>
<p>每个 PV 可以属于某个类（Class），通过将其 <code>storageClassName</code> 属性设置为某个 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">StorageClass</a> 的名称来指定。 特定类的 PV 卷只能绑定到请求该类存储卷的 PVC 申领。 未设置 <code>storageClassName</code> 的 PV 卷没有类设定，只能绑定到那些没有指定特定存储类的 PVC 申领。</p>
<p><strong>回收策略</strong></p>
<p>目前的回收策略有：</p>
<ul>
<li>Retain（保留） – 手动回收</li>
<li>Recycle（回收）– 基本擦除 (<code>rm -rf /thevolume/*</code>)</li>
<li>Delete（删除）– 诸如 AWS EBS、GCE PD、Azure Disk 或 OpenStack Cinder 卷这类关联存储资产也被删除</li>
</ul>
<p>目前，仅 NFS 和 HostPath 支持回收（Recycle）。 AWS EBS、GCE PD、Azure Disk 和 Cinder 卷都支持删除（Delete）。</p>
<p><strong>阶段（状态）</strong></p>
<p>每个卷会处于以下阶段（Phase）之一：</p>
<ul>
<li>Available（可用）– 卷是一个空闲资源，尚未绑定到任何申领；</li>
<li>Bound（已绑定）– 该卷已经绑定到某申领；</li>
<li>Released（已释放）– 所绑定的申领已被删除，但是资源尚未被集群回收；</li>
<li>Failed（失败）– 卷的自动回收操作失败。</li>
</ul>
<p><strong>示例一</strong></p>
<p>这个实例是先后创建 PV、PVC、Deployment</p>
<ol>
<li>创建 PV</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 PVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建 Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-deployment-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-deployment-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">test-pvc</span></span><br></pre></td></tr></table></figure>

<p><strong>示例二</strong></p>
<p>这个实例会由 StatefulSet 自动创建 PVC</p>
<p><img src="/2024/02/18/kubernetes/%E6%8C%81%E4%B9%85%E5%AD%98%E5%82%A8%E5%8D%B7%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="持久存储卷示例图"></p>
<ol>
<li>部署 NFS 服务器，并在每个节点安装<code>nfs-utils</code></li>
<li>部署 PV，这里创建了四个 PV</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># PV容量大小</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="comment"># 服务模式为RWO，卷可以被一个节点以读写方式挂载</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="comment"># 回收策略为Retain，即手动回收</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="comment"># 类为nfs</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="comment"># 制定nfs服务器地址和被挂载目录</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadOnlyMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">slow-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/slow</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/volume%E4%B8%83.png" alt="volume七"></p>
<ol start="2">
<li>创建无头 SVC、StatefulSet</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-svc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># 不分配ip地址，为StatefulSet使用</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="comment"># 匹配标签</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 匹配标签</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nfs-pv-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-pv-pod</span></span><br><span class="line">      <span class="comment"># pod标签</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pv-pod-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># 挂载持久卷</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pv-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="comment"># PVC模板</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-pv-volume</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 匹配规则</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&#x27;ReadWriteOnce&#x27;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>先后创建后查看 Pod 创建情况，可以看到只创建了一个 Pod，因为现有的 PV 只有一个符合匹配条件，而 StatefulSet 是前一个 Pod 创建成功才会创建下一个，因为第二个 Pod 创建不成功，所以第三个 Pod 不会被创建</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%85%AB.png" alt="volume八"></p>
<ol start="4">
<li>进入容器内部可以看到挂载成功，去到 NFS 服务器的<code>/nfs1</code>目录下创建<code>test.html</code>文件测试成功</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E4%B9%9D.png" alt="volume九"></p>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81.png" alt="volume十"></p>
<ol start="5">
<li>删除创建失败的 Pod 以及对应的 PVC，创建新的两个 PV，以满足 StatefulSet 的挂载要求，剩下的 Pod 就会逐一创建成功</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%80.png" alt="volume十一"></p>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%BA%8C.png" alt="volume十二"></p>
<ol start="6">
<li>删除上面测试的 Pod，StatefulSet 会重新创建一个 Pod，且数据不会丢失</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%89.png" alt="volume十三"></p>
<p>这里会有个问题，如果删除了 StatefulSet，那么对应的 Pod 也会被删除，可是已经绑定的 PV 并不会删除，这里就需要手动回收了。</p>
<p><strong>手动回收</strong></p>
<ul>
<li><p>删除 StatefulSet</p>
</li>
<li><p>删除 PVC</p>
</li>
<li><p>修改 PV</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit pv pv名称</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除ClaimRef的信息</span></span><br><span class="line">ClainRef:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="6-3-2-StorageClass"><a href="#6-3-2-StorageClass" class="headerlink" title="6.3.2 StorageClass"></a>6.3.2 StorageClass</h4><p>以上的方法都是静态创建的 PV，会出现 PVC 找不到条件符合的 PV 进行绑定。</p>
<p>而 StorageClass 的作用是根据 PVC 的需求动态创建 PV。</p>
<p><strong>示例一</strong></p>
<p><img src="/2024/02/18/kubernetes/NFS%E5%AD%98%E5%82%A8%E5%88%86%E9%85%8D%E5%99%A8%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="NFS存储分配器示例图"></p>
<ol>
<li>k8s 在 1.20 版本开始就禁用了 selfLink，所以需在配置文件添加以下内容</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E5%9B%9B.png" alt="volume十四"></p>
<ol start="2">
<li>StorageClass 是通过存储分配器来动态创建 PV 的，但 k8s 内部的存储分配器不支持 NFS，所以首先要安装 NFS 存储分配器</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="comment"># 设置升级策略为删除再创建(默认为滚动更新)</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nfs-provision</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="comment"># nfs存储分配器名称</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">nfs-client</span></span><br><span class="line">            <span class="comment"># nfs服务器地址</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">            <span class="comment"># nfs共享目录</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>给 NFS 存储分配器授权</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner_rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建 StorageClass</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_storageclass.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># storageclass名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storageclass</span></span><br><span class="line"><span class="comment"># nfs存储分配器名称</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">nfs-client</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># 表示pvc删除时，所绑定的pv不会被保留，true相反</span></span><br><span class="line">  <span class="attr">archieveOnDelete:</span> <span class="string">&#x27;false&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>创建 PVC，可以看到 NFS 存储分配器已经自动创建了 PV 与之绑定</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_storageclass_pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="comment"># storageclass名称</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs-client&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%BA%94.png" alt="volume十五"></p>
<ol start="6">
<li>创建一个 Deployment 测试是否能用这个 PVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">nfs_provisioner_deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-provisioner-deployment-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/test</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-storageclass-pvc</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nfs-storageclass-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>在 NFS 服务器的共享目录下创建一个 test.html</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E5%85%AD.png" alt="volume十六"></p>
<ol start="8">
<li>访问 Deployment 创建出来的 Pod，可以看到是可以访问的</li>
</ol>
<p><img src="/2024/02/18/kubernetes/volume%E5%8D%81%E4%B8%83.png" alt="volume十七"></p>
<h3 id="6-4-StatefulSet"><a href="#6-4-StatefulSet" class="headerlink" title="6.4 StatefulSet"></a>6.4 StatefulSet</h3><p>StatefulSet 是一种提供排序和唯一性保证的特殊 Pod 控制器，当有部署顺序、持久数据或固定网络等相关的特殊需求时，可以用 StatefulSet 控制器来进行控制。</p>
<p>StatefulSet 提供有状态服务，主要功能如下：</p>
<ol>
<li>实现稳定的持久化存储：通过 PVC 来实现，Pod 之间不能共用一个存储卷，每个 Pod 都要有一个自己专用的存储卷。</li>
<li>实现稳定的网络标识：Pod 重新调度后其 PodName 和 HostName 不变，通过无头 SVC 来实现。</li>
<li>实现有序部署、有序伸缩：Pod 是有顺序的，只有前一个 Pod 创建成功才会创建下一个，直到最后。</li>
<li>实现有序收缩、有序删除：从最后一个开始，依次删除到第一个。</li>
<li>无头 SVC ：为 Pod 生成可以解析的 DNS 记录。</li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%B8%80.png" alt="statefulset一"></p>
<p><strong>示例一</strong></p>
<ol>
<li>创建无头 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">statefulset_nginx_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-nginx-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 StatefulSet</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">statefulset_nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 匹配无头SVC</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">statefulset-nginx-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">statefulset-nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># PVC模板</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">statefulset-nginx-pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&#x27;ReadWriteOnce&#x27;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&#x27;nfs-storageclass&#x27;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">50Mi</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到 Pod 是有序创建的，且每个 Pod 都是单独使用一个 PVC 和 PV，删除 StatefulSet 也可以看到 Pod 是有序删除的，且删除后 PVC 与 PV 依旧存在，重新生成 StatefulSet 可以继续使用这些 PVC 和 PV</li>
</ol>
<p><strong>有序创建</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%BA%8C.png" alt="statefulset二"></p>
<p><strong>PVC 与 PV</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%B8%89.png" alt="statefulset三"></p>
<p><strong>有序删除</strong></p>
<p><img src="/2024/02/18/kubernetes/statefulset%E5%9B%9B.png" alt="statefulset四"></p>
<ol start="4">
<li>创建一个 Pod 用来测试无头 SVC 提供的 DNS 服务</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span> ]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;echo &quot;this is test&quot;; sleep 36000&#x27;</span> ]</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>进入 Pod 后可以通过<code>nslookup</code>测试，形式为<code>&#123;ServiceName&#125;.&#123;NameSpace&#125;.svc.&#123;ClusterDomain&#125;</code></li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E4%BA%94.png" alt="statefulset五"></p>
<ol start="6">
<li>通过域名也可以访问各个 Pod，形式为<code>&#123;PodName&#125;&#123;ServiceName&#125;.&#123;NameSpace&#125;.svc.&#123;ClusterDomain&#125;</code></li>
</ol>
<p><img src="/2024/02/18/kubernetes/statefulset%E5%85%AD.png" alt="statefulset六"></p>
<h2 id="七、k8s调度器"><a href="#七、k8s调度器" class="headerlink" title="七、k8s调度器"></a>七、k8s调度器</h2><p>scheduler 是 k8s 集群的调度器，对每一个新创建的 Pod 或者是未被调度的 Pod，scheduler 会选择一个最优的 Node 去运行这个 Pod。然而，Pod 内的每一个容器对资源都有不同的需求，而且 Pod 本身也有不同的资源需求。因此，Pod 在被调度到 Node 上之前， 根据这些特定的资源调度需求，需要对集群中的 Node 进行一次过滤。</p>
<p>在做调度决定时需要考虑的因素包括：单独和整体的资源请求、硬件&#x2F;软件&#x2F;策略限制、 亲和以及反亲和要求、数据局域性、负载间的干扰等等。</p>
<p><strong>调度流程：</strong></p>
<ul>
<li>过滤：调度器会将所有满足 Pod 调度需求的 Node 选出来。</li>
<li>打分：调度器会为 Pod 从所有可调度节点中选取一个最合适的 Node。</li>
</ul>
<h3 id="7-1-亲和性与反亲和性"><a href="#7-1-亲和性与反亲和性" class="headerlink" title="7.1 亲和性与反亲和性"></a>7.1 亲和性与反亲和性</h3><h4 id="7-1-1-Node亲和性"><a href="#7-1-1-Node亲和性" class="headerlink" title="7.1.1 Node亲和性"></a>7.1.1 Node亲和性</h4><p>节点亲和性是通过<code>pod.spec.nodeAffinity</code>来实现的，包括以下两种：</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策略</li>
</ul>
<p><strong>requiredDuringSchedulingIgnoredDuringExecution硬策略</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-required-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-required-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># 亲和性设置</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="comment"># 节点亲和性设置</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="comment"># 硬策略</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="comment"># 节点选择器</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="comment"># 匹配表达式</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="comment"># 制定key，即以这个key的键值为匹配条件</span></span><br><span class="line">          <span class="comment"># 通过kubectl get node --show-labels可以获得更多标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="comment"># In:label的值在某个列表中</span></span><br><span class="line">            <span class="comment"># NotIn:label的值不在某个列表中</span></span><br><span class="line">            <span class="comment"># Gt:label的值大于某个值</span></span><br><span class="line">            <span class="comment"># Lt:label的值小于某个值</span></span><br><span class="line">            <span class="comment"># Exists:某个label存在</span></span><br><span class="line">            <span class="comment"># DoesNotExist:某个label不存在</span></span><br><span class="line">            <span class="comment"># 这里设置的意思是，根据kubernetes.io/hostname的键值，永远不分配到键值为k8s-node01的节点上</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node01</span></span><br></pre></td></tr></table></figure>

<p>创建后可以看到 Pod 不会被创建在 k8s-node01 节点上<img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%80.png" alt="Node亲和性一"></p>
<p><strong>preferredDuringSchedulingIgnoredDuringExecution软策略</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-preferred-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-preferred-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="comment"># 软策略</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="comment"># 权重，范围为1-100</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># 偏向于</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="comment"># 匹配表达式</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node03</span></span><br></pre></td></tr></table></figure>

<p>可以看到虽然要求部署到 k8s-node03 节点上，但由于本环境没有该节点，所以就被分配到其它的节点了</p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BA%8C.png" alt="Node亲和性二"></p>
<p><strong>软硬合体版</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-preandreq-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-preandreq-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">cpu</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">4core</span>] &#125;</span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">disktype</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">ssd</span>] &#125;</span><br></pre></td></tr></table></figure>

<p>软策略和硬策略一起使用就会先满足硬策略再分析软策略，可以看到现有的节点没有可以满足以上条件的，所以 Pod 一直处于 Pending 状态</p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%89.png" alt="Node亲和性三"></p>
<p><img src="/2024/02/18/kubernetes/Node%E4%BA%B2%E5%92%8C%E6%80%A7%E5%9B%9B.png" alt="Node亲和性四"></p>
<h4 id="7-1-2-Pod亲和性"><a href="#7-1-2-Pod亲和性" class="headerlink" title="7.1.2 Pod亲和性"></a>7.1.2 Pod亲和性</h4><p>有时候需要将某些 Pod 与正在运行的已具有某些特质的 Pod 调度到一起，因此就需要 Pod 亲和性调度方式。</p>
<p>Pod 亲和性是通过<code>spec.affinity.podAffinity/podAntiAffinity</code>来实现的，前者为<strong>亲和性</strong>，后者为<strong>反亲和性</strong>，包括以下两种：</p>
<ul>
<li>preferredDuringSchedulingIgnoredDuringExecution：软策略</li>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬策略</li>
</ul>
<p><strong>requiredDuringSchedulingIgnoredDuringExecution硬策略</strong></p>
<ol>
<li>首先创建一个标签为<code>app:nginx</code>的 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod-container-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建硬策略亲和性 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-required</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-required-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># 亲和性设置</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="comment"># Pod亲和性设置</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="comment"># 硬策略</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="comment"># 列出规则</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="comment"># 甄选app这个标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="comment"># In:label的值在某个列表中</span></span><br><span class="line">            <span class="comment"># NotIn:label的值不在某个列表中</span></span><br><span class="line">            <span class="comment"># Exists:某个label存在</span></span><br><span class="line">            <span class="comment"># DoesNotExist:某个label不存在</span></span><br><span class="line">            <span class="comment"># 表示硬性匹配标签为app=nginx的这个Pod</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="comment"># 键值</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="comment"># 分配到与这个Pod所属的节点kubernetes.io/hostname值相同的节点上，可以理解为分配到同一节点上，但可能有多个</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>可以看到会分配在同一节点上</p>
<p><img src="/2024/02/18/kubernetes/Pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%80.png" alt="Pod亲和性一"></p>
<ol start="3">
<li>删除该 Pod，将<code>podAffinity</code>改为<code>podAntiAffinity</code>，将不会分配到一起</li>
</ol>
<p><img src="/2024/02/18/kubernetes/Pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BA%8C.png" alt="Pod亲和性二"></p>
<h3 id="7-2-污点和容忍度"><a href="#7-2-污点和容忍度" class="headerlink" title="7.2 污点和容忍度"></a>7.2 污点和容忍度</h3><p>污点（taint）表示一个节点上存在不良状况，污点会影响 Pod 的调度，其定义方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node &#123;节点名称&#125; &#123;污点名称&#125;=&#123;污点值&#125;:&#123;污点的影响&#125;</span><br></pre></td></tr></table></figure>

<p>污点的影响有三种：</p>
<ul>
<li>NoExecute：不将 Pod 调度到具备该污点的节点上，如果 Pod 已经在该节点运行，则会被驱逐。</li>
<li>NoSchedule：不将 Pod 调度到具备该污点的节点上，如果 Pod 已经在该节点运行，不会被驱逐。</li>
<li>PreferNoSchedule：不推荐将 Pod 调度到具备该污点的节点上。</li>
</ul>
<p><strong>添加污点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E4%B8%80.png" alt="污点和容忍一"></p>
<p><strong>删除污点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute-</span><br></pre></td></tr></table></figure>

<p><strong>示例一</strong></p>
<ol>
<li>给 k8s-node01 打上污点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-node01 cpu=1:NoExecute</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建 Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">toleration-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">toleration-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># 添加节点亲和性硬策略，让该Pod调度到k8s-node01上</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">k8s-node01</span></span><br><span class="line">  <span class="comment"># 容忍设置</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="comment"># 容忍污点</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;cpu&quot;</span></span><br><span class="line">    <span class="comment"># Equal:指等于该值</span></span><br><span class="line">    <span class="comment"># Exist:指有该key就可，值无所谓</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="comment"># 污点影响</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">    <span class="comment"># 容忍时间，超过该事件就会被驱除，只有污点影响设置为NoExecute才可用</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">36</span></span><br></pre></td></tr></table></figure>

<p>可以看到该 Pod 依旧可以调度到 k8s-node01 节点上，但超过 3600 秒后就被驱除了</p>
<p><img src="/2024/02/18/kubernetes/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E4%BA%8C.png" alt="污点和容忍二"></p>
<p>容忍度设置一般用于 DaemonSet 控制器，因为 DaemonSet 控制器下的应用一般是为节点本身提供服务的。</p>
<h3 id="7-3-优先级和抢占式调度"><a href="#7-3-优先级和抢占式调度" class="headerlink" title="7.3 优先级和抢占式调度"></a>7.3 优先级和抢占式调度</h3><p>当集群的资源（CPU、内存、磁盘等）不足时，新 Pod 的创建会一直处于 Pending 的状态，默认情况下，除了系统外的 Pod，其它 Pod 的优先级都是相同的，如果调高了 Pod 的优先级，那么节点就会将低优先级的 Pod 驱逐，腾出空间给优先级高的 Pod，这就被称为<strong>抢占式调度</strong>。</p>
<p><strong>示例一</strong></p>
<ol>
<li>要调整优先级，需要先创建 PriorityClass</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-priorityclass</span></span><br><span class="line"><span class="comment"># 优先级设置</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000000</span></span><br><span class="line"><span class="comment"># 是否在全局下使用，只可设置一个</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 描述</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;this priorityclass is test&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在 Pod 中调用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">priorityclass-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">priorityclass-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">priorityClassName:</span> <span class="string">test-priorityclass</span></span><br></pre></td></tr></table></figure>

<h3 id="7-4-为Pod设置计算资源"><a href="#7-4-为Pod设置计算资源" class="headerlink" title="7.4 为Pod设置计算资源"></a>7.4 为Pod设置计算资源</h3><p>容器运行时会提供一些机制来限制容器可以使用的计算资源（CPU、内存和磁盘等），Pod 模板中也提供了这个功能，主要如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算资源设置</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="comment"># 资源限制设置，超过设置的值容器会被停止</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="comment"># cpu限制</span></span><br><span class="line">    <span class="attr">cpu:</span></span><br><span class="line">    <span class="comment"># 内存限制</span></span><br><span class="line">    <span class="attr">memory:</span></span><br><span class="line">  <span class="comment"># 资源请求设置，至少需要多少资源容器才会被运行</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="comment"># cpu请求</span></span><br><span class="line">    <span class="attr">cpu:</span></span><br><span class="line">    <span class="comment"># 内存请求</span></span><br><span class="line">    <span class="attr">memory:</span></span><br></pre></td></tr></table></figure>

<p><strong>示例一</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resources-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">resources-container</span></span><br><span class="line">    <span class="comment"># 压测工具</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">vish/stress</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="comment"># 进行压测，阈值为150Mi,每一秒增加5Mi压力</span></span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&#x27;-mem-total&#x27;</span>,<span class="string">&#x27;150Mi&#x27;</span>,<span class="string">&#x27;-mem-alloc-size&#x27;</span>,<span class="string">&#x27;5Mi&#x27;</span>,<span class="string">&#x27;-mem-alloc-sleep&#x27;</span>,<span class="string">&#x27;1s&#x27;</span> ]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&#x27;100Mi&#x27;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&#x27;200m&#x27;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&#x27;50Mi&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以看到 Pod 最初可以运行，但20秒后就不行了</p>
<p><img src="/2024/02/18/kubernetes/%E4%B8%BAPod%E8%AE%BE%E7%BD%AE%E8%AE%A1%E7%AE%97%E8%B5%84%E6%BA%90%E4%B8%80.png" alt="为Pod设置计算资源一"></p>
<h3 id="7-5-命名空间管理"><a href="#7-5-命名空间管理" class="headerlink" title="7.5 命名空间管理"></a>7.5 命名空间管理</h3><p>命名空间的主要作用是对 k8s 集群的资源进行划分，这种划分是一种逻辑划分，用于实现多租户的资源隔离。</p>
<p><strong>命名空间的创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace 命名空间名称</span><br></pre></td></tr></table></figure>

<p><strong>命名空间的资源配额</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span></span><br><span class="line">  <span class="attr">namespace:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="comment"># 计算资源配额</span></span><br><span class="line">    <span class="attr">limits.cpu:</span></span><br><span class="line">    <span class="attr">limits.memory:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span></span><br><span class="line">    <span class="attr">requests.memory:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 存储资源配额</span></span><br><span class="line">    <span class="comment"># 在所有PVC中，存储资源的需求不能超过该值</span></span><br><span class="line">    <span class="attr">requests.storage:</span></span><br><span class="line">    <span class="comment"># 允许存在的PVC数量</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span></span><br><span class="line">    <span class="comment"># 允许与&#123;storage-class-name&#125;相关的PVC总量</span></span><br><span class="line">    &#123;<span class="string">storage-class-name</span>&#125;<span class="string">.storageclass.storage.k8s.io/requests.storage:</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment"># 对象数量配额</span></span><br><span class="line">    <span class="comment"># 允许存在ConfigMap数量</span></span><br><span class="line">    <span class="attr">configmaps:</span></span><br><span class="line">    <span class="comment"># 允许存在的非终止状态的Pod数量</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">    <span class="comment"># 允许存在的RC数量</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span></span><br><span class="line">    <span class="comment"># 允许存在的资源配额数量</span></span><br><span class="line">    <span class="attr">resourcequotas:</span></span><br><span class="line">    <span class="comment"># 允许存在的SVC数量</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">    <span class="comment"># 允许存在的LoadBalancer类型的SVC数量</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span></span><br><span class="line">    <span class="comment"># 允许存在的NodePort类型的SVC数量</span></span><br><span class="line">    <span class="attr">services.nodeports:</span></span><br><span class="line">    <span class="comment"># 允许存在的Secret数量</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br></pre></td></tr></table></figure>

<h4 id="7-5-1-命名空间的资源配额"><a href="#7-5-1-命名空间的资源配额" class="headerlink" title="7.5.1 命名空间的资源配额"></a>7.5.1 命名空间的资源配额</h4><p><strong>示例一</strong></p>
<ol>
<li>先创建一个命名空间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace test-ns</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建资源配额</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-rq</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&#x27;4&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建一个 Deployment</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-ns-depolyment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-ns-depolyment-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>配额限制的 Pod 数量是2，但 Deployment 设置的副本数是3，可以看到是创建不了第三个 Pod 的</p>
<p><img src="/2024/02/18/kubernetes/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E4%B8%80.png" alt="命名空间资源配额一"></p>
<h4 id="7-5-2-命名空间单个资源的资源配额"><a href="#7-5-2-命名空间单个资源的资源配额" class="headerlink" title="7.5.2 命名空间单个资源的资源配额"></a>7.5.2 命名空间单个资源的资源配额</h4><p>通过设置资源配额，可以限定一个命名空间下使用的资源总量，但这只是总量限制，对于单个资源没有限制，有时候一个 Pod 就可能用完整个命名空间所指定的资源，为了避免，可以通过<code>LimitRange</code>来对单个资源进行限定。</p>
<p><strong>设置容器的限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-container</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;200m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;300Mi&#x27;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;150Mi&#x27;</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;180m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;250Mi&#x27;</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;110m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;160Mi&#x27;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E4%BA%8C.png" alt="命名空间资源配额二"></p>
<p>当 LimitRange 创建成功后，创建该命名空间下的 Pod 时，各个容器的<code>resource.limits</code>和<code>resource.requests</code>必须满足 Max 和 Min 之间的范围。</p>
<p>而<code>default</code>和<code>defaultRequest</code>是指，当创建 Pod 时没用设置限额，则根据此属性来设置限额。</p>
<p><strong>设置 Pod 的限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;600Mi&#x27;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&#x27;500m&#x27;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&#x27;300Mi&#x27;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<p>当 LimitRange 创建成功后，创建该命名空间下的 Pod 时，各个 Pod 的<code>resource.limits</code>和<code>resource.requests</code>必须满足 Max 和 Min 之间的范围。</p>
<p><strong>设置 PVC 的限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">200Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">PersistentVolumeClaim</span></span><br></pre></td></tr></table></figure>

<p><strong>设置 Pod 或容器的比例限额范围</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limitrange-ratio</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">maxLimitRequestRatio:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<p>设置比例限额可以限制 Pod 或容器设置的请求资源和上限资源的比值，在该示例中，Pod 所有容器的<code>resources.limits.memory</code>的总和要 &#x3D; Pod 所有容器的<code>resources.requests.memory</code>的总和的两倍，<strong>即上限必须是需求的两倍</strong>，Pod 才能够创建成功。</p>
<h3 id="7-6-标签、选择器、注解"><a href="#7-6-标签、选择器、注解" class="headerlink" title="7.6 标签、选择器、注解"></a>7.6 标签、选择器、注解</h3><h4 id="7-6-1-标签"><a href="#7-6-1-标签" class="headerlink" title="7.6.1 标签"></a>7.6.1 标签</h4><p>k8s 的标签（label）是一种语义化标记标签，可以附加到 k8s 对象上，对它们进行标记和划分。</p>
<p>标签的形式是键值对，每个资源对象都可以拥有多个标签，但每个键都只能有一个值。</p>
<p>对于标签的设置，是通过<code>metadata</code>属性中实现的，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">key1:</span> <span class="string">value1</span></span><br><span class="line">    <span class="attr">key2:</span> <span class="string">value2</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>而对于已有的资源，可以通过以下命令添加或删除标签</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label 资源类型 资源名称 标签名=标签值</span><br><span class="line">kubectl label 资源类型 资源名称 标签名=标签值-</span><br></pre></td></tr></table></figure>

<h4 id="7-6-2-选择器"><a href="#7-6-2-选择器" class="headerlink" title="7.6.2 选择器"></a>7.6.2 选择器</h4><p>通过标签选择器（selector）就可以快速查找到指定标签的资源。</p>
<p>通过<code>-l</code>查找方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l 标签名=/!=标签值</span><br></pre></td></tr></table></figure>

<p>通过<code>in</code> <code>notin</code>查找</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l &#x27;标签名1 in/notin (标签值1,标签值2)&#x27;</span><br></pre></td></tr></table></figure>

<p>每种基于控制器的对象也可以使用标签来选择需要操作的 Pod，如 Job、Deployment、DaemonSet 等都可以在<code>spec</code>中指定选择器，以查找到符合条件的 Pod，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">stable</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">env</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">dev</span>] &#125;</span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">key:</span> <span class="string">track</span>, <span class="attr">operator:</span> <span class="string">Exists</span> &#125;</span><br></pre></td></tr></table></figure>

<p>在创建 SVC 时，都需要制定标签选择器来确定需要控制的资源，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">stable</span></span><br></pre></td></tr></table></figure>

<p>在创建 PVC 时，除了用类匹配之外，也可以用标签来匹配适合的 PV，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">pvnumber:</span> <span class="string">pv01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">pvnumber:</span> <span class="string">pv01</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="7-6-3-注解"><a href="#7-6-3-注解" class="headerlink" title="7.6.3 注解"></a>7.6.3 注解</h4><p>注解（annotation）也是一种类似标签的机制，但只是给资源添加更多信息的方式，类似注释。</p>
<p>设置注解，是通过<code>metadata</code>来实现的，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod</span></span><br><span class="line">  <span class="attr">annotation:</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">&#x27;cqm&#x27;</span></span><br><span class="line">    <span class="attr">phone:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">&#x27;123456@789.com&#x27;</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>



<h2 id="八、API-Server"><a href="#八、API-Server" class="headerlink" title="八、API Server"></a>八、API Server</h2><p>API Server 是集群内布各个组件通信的中介，也是外部控制的入口，k8s 的安全机制基本都是围绕着保护 API Server 来设计的，通过<strong>认证、鉴权、准入控制</strong>三步来保证 API Server 的安全。</p>
<p>我们在使用 k8s 时，都是通过<code>kubectl</code>工具来访问 API Server 的，<code>kubectl</code>把命令转换为对 API Server 的 REST API 调用。</p>
<p><img src="/2024/02/18/kubernetes/apiserver%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B.svg" alt="apiserver访问流程"></p>
<h3 id="8-1-身份认证"><a href="#8-1-身份认证" class="headerlink" title="8.1 身份认证"></a>8.1 身份认证</h3><p>身份认证主要用于确定用户能不能访问，是访问 API Server 的第一个关卡。</p>
<p>通过命令可以看到认证情况，可以看到是通过 6443 端口进行访问的。</p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%80.png" alt="身份认证一"></p>
<p>要访问 API Server，首先就要进行身份认证，k8s 的身份认证分为以下两类：</p>
<ul>
<li>常规用户认证：主要提供于普通用户或独立于 k8s 之外的其他外部应用使用，以便能从外部访问 API Server。</li>
<li>ServiceAccount 认证：主要提供于内部的 Pod 使用。</li>
</ul>
<h4 id="8-1-1-常规用户认证"><a href="#8-1-1-常规用户认证" class="headerlink" title="8.1.1 常规用户认证"></a>8.1.1 常规用户认证</h4><p>常规用户认证主要有三种方式：</p>
<ul>
<li><p>HTTPS 证书认证：基于 CA 证书签名的数字证书认证。</p>
</li>
<li><p>HTTP 令牌认证：通过令牌来识别用户。</p>
</li>
<li><p>HTTP Base 认证：通过用户名和密码认证。</p>
</li>
</ul>
<ol>
<li>令牌认证是最实用也最普及的方式，首先生成一个随机令牌</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>接着给 k8s 创建令牌认证文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/pki/token_auth_file</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式为:令牌1,用户1,用户ID</span></span><br><span class="line">ec0f09bf9a3c40f9db1cc0f8e6664c12,cqm,1</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>认证文件创建好后，在 API Server 启动文件中进行引用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line"><span class="comment"># 在spec中添加</span></span><br><span class="line"><span class="string">--token-auth-file=/etc/kubernetes/pki/token_auth_file</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>接着就可以用认证好的用户访问 API Server 来获取 Pod 的信息了</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer ec0f09bf9a3c40f9db1cc0f8e6664c12&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%BA%8C.png" alt="身份认证二"></p>
<p>但可以看到还是失败，因为还没有进行授权，后边将进行授权。</p>
<h4 id="8-1-2-ServiceAccount认证"><a href="#8-1-2-ServiceAccount认证" class="headerlink" title="8.1.2 ServiceAccount认证"></a>8.1.2 ServiceAccount认证</h4><p>ServiceAccount 认证主要提供于集群内布的 Pod 中的进程使用，常规用户认证是不限制命名空间的，但 ServiceAccount 认证的局限于它所在的命名空间中。</p>
<p><strong>默认 ServiceAccount</strong></p>
<p>每个命名空间都有个默认的 ServiceAccount，如果创建 Pod 时没用指定，那么就会使用默认的 ServiceAccount。</p>
<ol>
<li>通过命令可以看到默认的 ServiceAccount</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%89.png" alt="身份认证三"></p>
<ol start="2">
<li>创建一个 Pod 进行测试</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sa-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sa-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;this is sa test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看 Pod 的详细信息，可以看到被挂载了一个 Secret 类型的卷，实际上这里面就存放了 ServiceAccount 的认证信息</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%9B%9B.png" alt="身份认证四"></p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%BA%94.png" alt="身份认证五"></p>
<p>进入容器内部，通过以上地址映射令牌在进行访问 API Server，可以看到由于未授权依旧不行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorizat</span><br><span class="line">ion:Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%85%AD.png" alt="身份认证六"></p>
<p><strong>自定义 ServiceAccount</strong></p>
<p>如果某些 Pod 需要访问 API Server，通常会让它引用自定义 ServiceAccount，并为其授权。</p>
<ol>
<li>首先创建一个自定义 ServiceAccount</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建好后可以查看详细信息，包含了证书和令牌等</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%83.png" alt="身份认证七"></p>
<ol start="3">
<li>创建 Pod 引用</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-sa-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-sa-pod-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">appropriate/curl:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&#x27;echo &quot;this is sa test&quot;; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>就可以看到 Pod 中已经引用了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%85%AB.png" alt="身份认证八"></p>
<p><img src="/2024/02/18/kubernetes/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B9%9D.png" alt="身份认证九"></p>
<h3 id="8-2-RBAC授权"><a href="#8-2-RBAC授权" class="headerlink" title="8.2 RBAC授权"></a>8.2 RBAC授权</h3><p>k8s 中有基于属性的访问控制（ABAC），基于角色的访问控制（RBAC），基于 HTTP 回调机制的访问控制（Webhook）、Node 认证等授权模式，但1.6版本开始就默认启用 RBAC 模式。</p>
<p>RBAC 授权主要分为两步：</p>
<ul>
<li>角色定义：指定角色名称，定义允许访问哪些资源以及允许的访问方式。</li>
<li>角色绑定：将角色与用户（常规用户或 ServiceAccount）进行绑定。</li>
</ul>
<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E5%8E%9F%E7%90%86.png" alt="RBAC授权原理"></p>
<p>而角色定义和角色绑定又分为两种：</p>
<ul>
<li>只有单一指定命名空间访问权限的角色：角色定义关键字为 Role，角色绑定关键字为 RoleBinding。</li>
<li>拥有集群级别（不限命名空间）访问权限的角色：角色定义为 ClusterRole，角色绑定关键字为 ClusterRoleBinding。</li>
</ul>
<h4 id="8-2-1-普通角色的定义与绑定"><a href="#8-2-1-普通角色的定义与绑定" class="headerlink" title="8.2.1 普通角色的定义与绑定"></a>8.2.1 普通角色的定义与绑定</h4><p><strong>普通角色定义</strong></p>
<ol>
<li>创建一个普通角色</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 角色名</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># 角色规则定义</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># 表示可以对哪些API组的资源进行操作，这里为空即不限制</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="comment"># 可以访问的资源列表，这里为Pod</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="comment"># 可以进行的访问方式</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>访问方式可以通过开启<code>kubectl</code>反向代理查看，其中的<code>verb</code>就是可以访问的方式</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --port:8080</span><br><span class="line">curl http://localhost:8080/&#123;APIVersion&#125;</span><br></pre></td></tr></table></figure>

<p><strong>普通角色绑定</strong></p>
<p>定义角色后就可以进行绑定角色，绑定可以针对常规用户认证，也可以这对 ServiceAccount 认证。</p>
<ol>
<li>创建角色绑定</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># 将角色绑定给那些认证主体，它是一个数组，将常规用户认证cqm和ServiceAccount认证my-serviceaccount加入到rabc-role角色中</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="comment"># 常规用户认证绑定</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># ServiceAccount认证绑定</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 要绑定的角色</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="comment"># 普通角色</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E4%B8%80.png" alt="RBAC授权一"></p>
<ol start="2">
<li>尝试用之前创建的常规用户认证和 ServiceAccount 认证来访问 API Server，可以发现就可以访问了</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer ec0f09bf9a3c40f9db1cc0f8e6664c12&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure https://192.168.88.10:6443/api/v1/namespaces/default/pods -H &quot;Authorization:Bearer $(cat /var/run/secrets/kubern</span><br><span class="line">etes.io/serviceaccount/token)&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/RBAC%E6%8E%88%E6%9D%83%E4%BA%8C.png" alt="RBAC授权二"></p>
<h4 id="8-2-2-集群角色的定义与绑定"><a href="#8-2-2-集群角色的定义与绑定" class="headerlink" title="8.2.2 集群角色的定义与绑定"></a>8.2.2 集群角色的定义与绑定</h4><p>集群角色与普通角色的区别如下：</p>
<ul>
<li>使用的关键字不同：普通角色使用 Role，绑定使用 RoleBinding，集群角色使用 ClusterRole，绑定使用 ClusterRoleBinding。</li>
<li>集群角色不属于任何命名空间，模板也不需要指定命名空间，普通角色要求指定命名空间，如果没指定九默认 default。</li>
<li>集群角色可以访问所有命名空间下的资源，也可以访问不在命名空间下的资源。</li>
</ul>
<p>集群角色创建和绑定如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群角色定义</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 集群角色名</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrole</span></span><br><span class="line"><span class="comment"># 规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 集群角色绑定</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrolebinding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-serviceaccount</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># 由于my-serviceaccount是某个命名空间下的，所以要指定命名空间</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">clusterrole</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>这样一来用户（cqm，my-serviceaccount）都可以访问全局的资源，当然 ClusterRole 也可以和 RoleBinding 绑定在一起，因为 ClusterRole 是不限命名空间的，如果既想给某个认证主体绑定 ClusterRole，又想限制它能访问的命名空间，就可以通过与 RoleBinding 绑定来实现，本例中是指<code>rbac-clusterrole</code>的角色在绑定<code>rbac-rolebinding</code>后，可以访问在<code>default</code>命名空间下的任何资源，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-clusterrole</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbac-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-创建一个用户只能管理指定的命名空间"><a href="#8-3-创建一个用户只能管理指定的命名空间" class="headerlink" title="8.3 创建一个用户只能管理指定的命名空间"></a>8.3 创建一个用户只能管理指定的命名空间</h3><p>在实际的生产环境中，Master 的管理者可能有很多个，但不可能给人人都赋予 root 的权限，那么就可以创建新用户给其管理指定命名空间的权限。</p>
<ol>
<li>创建新用户，这时候该用户是使用不了 k8s 的</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd cqm</span><br><span class="line">passwd cqm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E7%BB%99%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%9F%90%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%80.png" alt="给用户管理某个命名空间一"></p>
<ol start="2">
<li>创建证书请求</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim cqm-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cqm&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ShenZhen&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ShenZhen&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k8s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>下载证书生成工具</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssl_1.6.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssljson_1.6.0_linux_amd64</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssl-certinfo_1.6.0_linux_amd64</span><br><span class="line">mv cfssl_1.6.0_linux_amd64 cfssl</span><br><span class="line">mv cfssl-certinfo_1.6.0_linux_amd64 cfssl-certinfo</span><br><span class="line">mv cfssljson_1.6.0_linux_amd64 cfssljson</span><br><span class="line">chmod a+x cfssl*</span><br><span class="line">mv cfssl* /usr/local/bin</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>生成证书</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/pki</span><br><span class="line">cfssl gencert -ca=ca.crt -ca-key=ca.key -profile=kubernetes ~/cqm-csr.json | cfssljson -bare cqm</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>设置集群参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export KUBE_APISERVER=&quot;192.168.88.10:6443&quot;</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>设置客户端认证参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials cqm \</span><br><span class="line">--client-certificate=/etc/kubernetes/pki/cqm.pem  \</span><br><span class="line">--client-key=/etc/kubernetes/pki/cqm-key.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>设置上下文参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=cqm \</span><br><span class="line">--namespace=dev \</span><br><span class="line">--kubeconfig=cqm.kubeconfig</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>进行 RoleBinding，这里的意思是指将常规用户 cqm 与 ClusterRole 的 admin 角色进行绑定，且指定 dev 的命名空间给 cqm，最终效果是 cqm 只能够访问和管理 dev 命名空间下的所有资源</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm-rolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/%E7%BB%99%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%9F%90%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%BA%8C.png" alt="给用户管理某个命名空间二"></p>
<ol start="9">
<li>设置默认上下文</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/cqm/.kube</span><br><span class="line">cp cqm.kubeconfig /home/cqm/.kube/config</span><br><span class="line">chown cqm:cqm /home/cqm/.kube/config</span><br><span class="line">su cqm</span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=/home/cqm/.kube/config</span><br></pre></td></tr></table></figure>



<h2 id="九、k8s扩展"><a href="#九、k8s扩展" class="headerlink" title="九、k8s扩展"></a>九、k8s扩展</h2><h3 id="9-1-可视化管理——Kubernetes-Dashboard"><a href="#9-1-可视化管理——Kubernetes-Dashboard" class="headerlink" title="9.1 可视化管理——Kubernetes Dashboard"></a>9.1 可视化管理——Kubernetes Dashboard</h3><p>Kubernetes Dashboard 可以实现 k8s 的可视化管理，可以实现对 Pod、控制器、Service 等资源的创建和维护，并对它们进行持续监控。</p>
<h4 id="9-1-1-安装Kubernetes-Dashboard"><a href="#9-1-1-安装Kubernetes-Dashboard" class="headerlink" title="9.1.1 安装Kubernetes Dashboard"></a>9.1.1 安装Kubernetes Dashboard</h4><ol>
<li>下载</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>模板文件如下，将拉取镜像的地址改为国内地址，同时修改 SVC 模式为 NodePort，这样在集群之外也可以访问 Dashboard</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-csrf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">csrf:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-key-holder</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-settings</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="string">&quot;kubernetes-dashboard-certs&quot;</span>, <span class="string">&quot;kubernetes-dashboard-csrf&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-settings&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services/proxy&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;http:heapster:&quot;</span>, <span class="string">&quot;https:heapster:&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>, <span class="string">&quot;http:dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;metrics.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registery.cn-hangzhou.aliyuncs.com/google_containers/dashboard:v2.3.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--namespace=kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">seccomp.security.alpha.kubernetes.io/pod:</span> <span class="string">&#x27;runtime/default&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registery.cn-hangzhou.aliyuncs.com/google_containers/metrics-scraper:v1.0.6</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f Kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建完之后可以查看对应的 SVC，就可以通过浏览器访问了</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%B8%80.png" alt="dashboard一"></p>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%BA%8C.png" alt="dashboard二"></p>
<ol start="5">
<li>RBAC 授权</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建ServiceAccount认证</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># 创建ClusterRoleBinding将dashboard-admin与集群角色cluster-admin进行绑定</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboardadmin-rbac</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>获取令牌并填入</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe secret dashboard-admin -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/dashboard%E4%B8%89.png" alt="dashboard三"></p>
<h4 id="9-1-2-Kubernetes-Dashboard使用"><a href="#9-1-2-Kubernetes-Dashboard使用" class="headerlink" title="9.1.2 Kubernetes Dashboard使用"></a>9.1.2 Kubernetes Dashboard使用</h4><ol>
<li>创建一个简单的 Pod</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E5%9B%9B.png" alt="dashboard四"></p>
<ol start="2">
<li>查看 Pod 状态</li>
</ol>
<p><img src="/2024/02/18/kubernetes/dashboard%E4%BA%94.png" alt="dashboard五"></p>
<h3 id="9-2-资源监控——Prometheus和Grafana"><a href="#9-2-资源监控——Prometheus和Grafana" class="headerlink" title="9.2 资源监控——Prometheus和Grafana"></a>9.2 资源监控——Prometheus和Grafana</h3><h4 id="9-2-1-安装Prometheus"><a href="#9-2-1-安装Prometheus" class="headerlink" title="9.2.1 安装Prometheus"></a>9.2.1 安装Prometheus</h4><ol>
<li>进行 RBAC 授权</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.rbac.yml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 ConfigMap</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.configmap.yml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.deployment.yml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/prometheus.service.yml</span><br></pre></td></tr></table></figure>

<h4 id="9-2-2-安装Grafana"><a href="#9-2-2-安装Grafana" class="headerlink" title="9.2.2 安装Grafana"></a>9.2.2 安装Grafana</h4><ol>
<li>配置 Deployment</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/grafana.deployment.yml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/realdigit/PrometheusAndGrafanaForK8S/blob/master/grafana.service.yml</span><br></pre></td></tr></table></figure>

<h4 id="9-2-3-Prometheus和Grafana的使用"><a href="#9-2-3-Prometheus和Grafana的使用" class="headerlink" title="9.2.3 Prometheus和Grafana的使用"></a>9.2.3 Prometheus和Grafana的使用</h4><ol>
<li>添加数据源</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%B8%80.png" alt="监控一"></p>
<ol start="2">
<li>使用模板，这里使用代号为 315 的 k8s 监控模板</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%BA%8C.png" alt="监控二"></p>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%B8%89.png" alt="监控三"></p>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E5%9B%9B.png" alt="监控四"></p>
<ol start="3">
<li>效果</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E7%9B%91%E6%8E%A7%E4%BA%94.png" alt="监控五"></p>
<h3 id="9-3-日志管理——ElasticSearch、Fluentd、Kibana"><a href="#9-3-日志管理——ElasticSearch、Fluentd、Kibana" class="headerlink" title="9.3 日志管理——ElasticSearch、Fluentd、Kibana"></a>9.3 日志管理——ElasticSearch、Fluentd、Kibana</h3><p>k8s 推荐采用 ElasticSearch、Fluentd、Kibana（简称EFK）三者组合的方式，对集群的日志进行手机和查询，关系如下：</p>
<ul>
<li>ElasticSearch 是一种搜索引擎，用于存储日志并进行查询。</li>
<li>Fluentd 用于将日志消息从 k8s 发送到 ElasticSearch。</li>
<li>Kibana 是一种图形界面，用于查询 ElasticSearch 中的日志。</li>
</ul>
<p><img src="/2024/02/18/kubernetes/%E6%97%A5%E5%BF%97%E6%9E%B6%E6%9E%84.png" alt="日志架构"></p>
<p>EFK 之间的交互如下：</p>
<ul>
<li>容器运行时会将日志输出到控制台，并以 ”-json.log“ 结尾将日志文件存放到 <code>/var/lib/docker/containers</code> 目录中，而 <code>/var/log</code> 是 linux 系统的日志。</li>
<li>在各个 Node 上运行的 Fluentd 将是收集这些日志，并发送给 ElasticSearch。</li>
<li>Kibana 是直接与用户交互的界面，可以查询 ElasticSearch 中的日志。</li>
</ul>
<h4 id="9-3-1-安装EFK"><a href="#9-3-1-安装EFK" class="headerlink" title="9.3.1 安装EFK"></a>9.3.1 安装EFK</h4><ol>
<li>配置命名空间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/create-logging-namespace.yaml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 Fluentd 的 ConfigMap</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/fluentd-es-configmap.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装 Fluentd</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/fluentd-es-ds.yaml</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装 ElasticSearch</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/es-statefulset.yaml</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>配置 ElasticSearch 的 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/es-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>安装 Kibana</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/kibana-deployment.yaml</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>配置 Kibana 的 SVC</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl applt -f https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/kibana-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>获取 Kibana 访问地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info | grep Kibana</span><br></pre></td></tr></table></figure>



<h2 id="十、项目部署"><a href="#十、项目部署" class="headerlink" title="十、项目部署"></a>十、项目部署</h2><h3 id="10-1-无状态项目部署"><a href="#10-1-无状态项目部署" class="headerlink" title="10.1 无状态项目部署"></a>10.1 无状态项目部署</h3><p>Guestbook 是一个无状态的多层 Web 应用程序，是一个简单的留言板程序，包含一下三个部分，并拥有读写分离机制：</p>
<ol>
<li>前端应用：Guestbook 留言板应用，将部署多个实例供用户访问。</li>
<li>后端存储（写）：Redis 主应用，用于写入留言信息，只部署一个案例。</li>
<li>后端存储（读）：Redis 从属应用，用域读取留言信息，将部署多个案例。</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%97%A0%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" alt="无状态服务架构"></p>
<ol>
<li>部署 Redis 主实例</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-master-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-master-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>部署 Redis 主实例 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>部署 Redis 从属实例</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-slave-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-slave-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-slave-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>部署 Redis 从属实例 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-slave-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">slave</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>部署 Guestbook</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">guestbook-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">guestbook-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">guestbook-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubeguide/guestbook-php-frontend</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>部署 Guestbook 的 SVC</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">guestbook-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30222</span></span><br></pre></td></tr></table></figure>

<h3 id="10-2-有状态项目部署"><a href="#10-2-有状态项目部署" class="headerlink" title="10.2 有状态项目部署"></a>10.2 有状态项目部署</h3><p>WordPress 是使用 PHP 开发的开源个人博客平台，是一套非常完善的内容管理系统，支持非常丰富的插件和模板，主要包含以下两个部分：</p>
<ul>
<li>前端应用：WordPress。</li>
<li>后端应用：MySQL 数据库，使用 PVC 来存储博客的数据。</li>
</ul>
<p><img src="/2024/02/18/kubernetes/%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" alt="有状态服务架构"></p>
<ol>
<li>首先生成一个数据库密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &#x27;toortoor&#x27; | base64</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建一个 Secret 存放密码</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Qpaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mysql_password:</span> <span class="string">dG9vcnRvb3I=</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>部署 nfs-client，实现自动分配 PV 给 PVC，步骤参照 6.3.2</li>
<li>部署 MySQL</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storageclass</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/library/mysql:5.7</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_password</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-datadir</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>部署 WordPress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30111</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-pvc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storageclass</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">wordpress-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/daocloud/dao-wordpress:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="comment"># 这里用到了MySQL的变量参数</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># Mysql的SVC名称</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">mysql-service</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_password</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/www/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress-datadir</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">wordpress-pvc</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>部署 Ingress，通过 <code>www.cqm.com:30111</code> 就能访问 WordPress</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.cqm.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/var/www/html</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">wordpress-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">30111</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/kubernetes/%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E4%B8%80.png" alt="有状态服务一"></p>
<h3 id="10-3-使用Helm部署项目"><a href="#10-3-使用Helm部署项目" class="headerlink" title="10.3 使用Helm部署项目"></a>10.3 使用Helm部署项目</h3><p>Helm 是 k8s 的一个子项目，是一种 k8s 包管理平台，它能够定义、部署、升级非常复杂的 k8s 应用集合，并进行版本管理。</p>
<p><img src="/2024/02/18/kubernetes/Helm%E6%9E%B6%E6%9E%84.png" alt="Helm架构"></p>
<ul>
<li>Helm 客户端：是一种远程命令客户端工具，主要用于 Chart 文件的创建、打包和发布部署，以及和 Chart 仓库的管理。Helm 发出的请求，根据 Chart 结构生成发布对象，并将 Chart 解析成各个 k8s 资源的实际部署文件，供 k8s 创建相应资源，同时还提供发布对象的更新、回滚、统一删除等功能。</li>
<li>Chart：是应用程序的部署定义，包含各种 yaml 文件，可以采用 TAR 格式打包。</li>
<li>Chart 仓库：Helm 中存放了各种应用程序的 Chart 包以供用户下载，Helm 可以同时管理多个 Chart 仓库，默认情况下管理一个本地仓库和一个远程仓库。</li>
<li>发布对象：在 k8s 集群中部署的 Chart 称为发布对象，Chart 和发布对象的关系类似于镜像和容器，前者是部署的定义，后者是实际部署好的应用程序。</li>
</ul>
<h4 id="10-3-1-Helm安装"><a href="#10-3-1-Helm安装" class="headerlink" title="10.3.1 Helm安装"></a>10.3.1 Helm安装</h4><ol>
<li>安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.6.2-linux-amd64.tar.gz</span><br><span class="line">tar -xf helm-v3.6.2-linux-amd64.tar.gz</span><br><span class="line">cp linux-amd64/helm /usr/local/bin/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置环境变量 KUBECONFIG 来指定存有 ApiServre 的地址与 token 的配置文件地址，默认为~&#x2F;.kube&#x2F;config</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/root/.kube/config</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 Helm 仓库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">helm repo add incubator https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/</span><br></pre></td></tr></table></figure>

<h4 id="10-3-2-Helm-Chart的基本操作"><a href="#10-3-2-Helm-Chart的基本操作" class="headerlink" title="10.3.2 Helm Chart的基本操作"></a>10.3.2 Helm Chart的基本操作</h4><p><strong>Chart 的创建</strong></p>
<ol>
<li>创建 Chart</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create chart名称</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行后会在当前目录下创建一个文件，可用 tree 命令查看该目录结构</li>
</ol>
<p><img src="/2024/02/18/kubernetes/Helm%E4%B8%80.png" alt="Helm一"></p>
<ul>
<li>chars：存放该 Chart 以来的所有子 Chart 的目录，这些子 Chart 也拥有这 4 个部分，如果有子 Chart ，则需要在父 Chart 创建一个 <code>requirements.yaml</code> 文件，在文件中记录这些子 Chart。</li>
<li>Chart.yaml：记录该 Chart 的相关信息，并定义在文件中的 <code>.Chart</code> 开头的属性值。</li>
<li>template：存放了 k8s 部署文件的 Helm 模板，其中扩展了 Go Template 语法。</li>
<li>values.yaml：定义在文件中的 <code>.Values</code> 开头的属性值。</li>
<li>_helpers.tpl：它是一个i模板助手文件，用于定义通用信息，然后在其他地方使用。</li>
<li>NOTES.txt：会在 Chart 部署命令后，代入具体的参数值，产生说明信息。</li>
<li>test-connection.yaml：用于定义部署完成后需要执行的测试内容，以便测试是否部署成功。</li>
</ul>
<p><strong>Chart 的验证</strong></p>
<ol>
<li>在发布 Chart 之前，可以通过命令检查 Chart 文件是否有误，如下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm lint chart目录/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>同时也可以用命令将各项值组合为 k8s 的 yaml 文件，查看是否为预期内容，比如下图就是其中 Deployment 的内容</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install --dry-run --debug 发布名称 -name chart目录名称</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/kubernetes/Helm%E4%BA%8C.png" alt="Helm二"></p>
<p><strong>Chart 的发布</strong></p>
<ol>
<li>Chart 的发布命令如下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install 发布版本名称 chart文件目录</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看目前发布的版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm list</span><br></pre></td></tr></table></figure>

<p><strong>将 Chart 打包到仓库中</strong></p>
<ol>
<li>查看仓库命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看仓库中的包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm search repo/hub</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以在后面加上应用名，如</span></span><br><span class="line">helm search repo/hub nginx</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>首先打包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm package chart目录</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装 Push 插件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm plugin install https://github.com/chartmuseum/helm-push.git</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>上传</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm push tar包名 仓库</span><br></pre></td></tr></table></figure>

<p><strong>发布版本的更新、回滚和删除</strong></p>
<ol>
<li>更新</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade 发布版本名称 chart目录或tar flags</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看历史版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm history 发布版本名称</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>回滚</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm rollback 发布版本名称 版本号</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>删除</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete 发布版本名称</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:10:45.064Z" title="2/18/2024, 5:10:45 PM">2024-02-18</time></span><span class="level-item">19 minutes read (About 2891 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/cisco/">Cisco</a></p><div class="content"><p>在 Cisco 中，交换机设备主要分为以下几种模式：</p>
<ol>
<li>用户模式，刚进入设备都是用户模式，只能用来看一些统计信息</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Switch&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>特权模式，可以查看并修改配置</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Switch&gt;enable</span><br><span class="line">Switch#</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>全局配置模式，可以修改主机名等</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Switch#config terminal</span><br><span class="line">Switch(config)#</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>接口模式，可以对指定接口进行配置</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Switch(config)#int f0/1</span><br><span class="line">Switch(config-if)#</span><br></pre></td></tr></table></figure>

<h2 id="1-Vlan划分"><a href="#1-Vlan划分" class="headerlink" title="1. Vlan划分"></a>1. Vlan划分</h2><p>Vlan 即虚拟局域网，能够有效防止广播风暴的发生。</p>
<p>Vlan 的划分是在交换机上进行，实际上就是给指定端口进行划分。</p>
<ol>
<li>在划分 vlan 前，可以看到左边的主机与右边的主机都是能够通信的</li>
</ol>
<p><img src="/2024/02/18/cisco/%E5%88%92%E5%88%86vlan%E4%B8%80.png" alt="划分vlan一"></p>
<ol start="2">
<li>接下来将左右边的主机分别划分为 vlan10、vlan20，进入全局配置模式</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建vlan</span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">vlan 10</span></span><br><span class="line"><span class="meta prompt_">Switch(config-vlan)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">vlan 20</span></span><br><span class="line"><span class="meta prompt_">Switch(config-vlan)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">划分vlan</span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">int range f0/1-3</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport mode access</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport access vlan 10</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">int range f0/4-6</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport mode access</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport access vlan 20</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看配置</span></span><br><span class="line"><span class="meta prompt_">Switch#</span><span class="language-bash">show running-config</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>再去进行 ping 测试连通性，会发现只能 ping 通同一 vlan 下的主机</li>
</ol>
<p><img src="/2024/02/18/cisco/%E5%88%92%E5%88%86vlan%E4%BA%8C.png" alt="划分vlan二"></p>
<h2 id="2-分类地址的通信"><a href="#2-分类地址的通信" class="headerlink" title="2. 分类地址的通信"></a>2. 分类地址的通信</h2><p>IP 地址分为五类，如果不是同一网络号下的地址则不能实现通信，如下图</p>
<p><img src="/2024/02/18/cisco/%E5%88%86%E7%B1%BB%E5%9C%B0%E5%9D%80%E4%B8%80.png" alt="分类地址一"></p>
<p>这时候可以在中间添加一台路由器，来作为各主机之间的默认网关（默认路由），即可实现通信。</p>
<ol>
<li>路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router&gt;</span><span class="language-bash">en</span></span><br><span class="line"><span class="meta prompt_">Router#</span><span class="language-bash">conf t</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入端口进行配置</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">int g0/0</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">ip add 192.168.88.1 255.255.255.0</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">no shutdown</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">int g0/1</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">ip add 172.16.0.1 255.255.0.0</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">no shutdown</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>主机配置默认网关</li>
</ol>
<p><img src="/2024/02/18/cisco/%E5%88%86%E7%B1%BB%E5%9C%B0%E5%9D%80%E4%BA%8C.png" alt="分类地址二"></p>
<ol start="3">
<li>连通性测试，第一个 ICMP 包会丢失是因为路由器会发送 ARP 包去寻找目标主机的 Mac 地址，所以在规定时间内没有收到回送报文就会超时</li>
</ol>
<p><img src="/2024/02/18/cisco/%E5%88%86%E7%B1%BB%E5%9C%B0%E5%9D%80%E4%B8%89.png" alt="分类地址三"></p>
<h2 id="3-划分子网"><a href="#3-划分子网" class="headerlink" title="3. 划分子网"></a>3. 划分子网</h2><p>子网的划分实际上就是在原有的基础上进行更小的划分，划分子网后，通过使用掩码，把子网隐藏起来，使得从外部看网络没有变化，这就是子网掩码。</p>
<p>如下图，左右边主机看似好像是在同一网络号下，但由于子网掩码是 255.255.255.192，所以之间是不能够通信的，只有 IP 地址与子网掩码进行位与的操作之后网络号相同的才能够进行通信，例如右边两台主机与子网掩码进行位与后网络号都是 192.168.88.64，即处于同一网络号下能够进行通信。</p>
<p><img src="/2024/02/18/cisco/%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86%E4%B8%80.png" alt="子网划分一"></p>
<p>每个子网内可以使用的 IP 个数由子网号来判断，例如 255.255.255.192，192 转化为二进制为 <code>11000000</code>，有 6 个 0，即 IP 个数为 2 ** 6 &#x3D; 64 个，常见子网掩码有以下几个（子网掩码：可用主机 IP 个数）：</p>
<ul>
<li>255.255.255.128：126</li>
<li>255.255.255.192：62</li>
<li>255.255.255.224：30</li>
<li>255.255.255.240：14</li>
<li>255.255.255.248：6</li>
<li>255.255.255.252：2</li>
</ul>
<p>要解决上图网络通信问题，只需要在中间添加个路由器即可。</p>
<ol>
<li>路由器配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router&gt;</span><span class="language-bash">en</span></span><br><span class="line"><span class="meta prompt_">Router#</span><span class="language-bash">conf t</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">int g0/0</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">ip add 192.168.88.12 255.255.255.192</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">no shutdown</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">int g0/1</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">ip add 192.168.88.102 255.255.255.192</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">no shutdown</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>主机添加默认网关</li>
<li>测试连通性</li>
</ol>
<p><img src="/2024/02/18/cisco/%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86%E4%BA%8C.png" alt="子网划分二"></p>
<h2 id="4-构造超网（路由聚合）"><a href="#4-构造超网（路由聚合）" class="headerlink" title="4. 构造超网（路由聚合）"></a>4. 构造超网（路由聚合）</h2><p>CIDR 地址格式为 xxx.xxx.xxx.xxx&#x2F;xx，如 192.168.88.10&#x2F;24，24 用来判断地址块信息，二进制后的 IP 前 24 位不变，后 8 位为 0，即可得出最小地址，后 8 位为 1 时，即可得出最大地址，即 192.168.88.0、192.168.88.255。</p>
<p>如下图，再没有配置静态路由时，上下网络的主机是不能够与右边的主机通信的，这时候添加静态路由，设置下一跳地址即可实现通信。</p>
<p><img src="/2024/02/18/cisco/%E8%B7%AF%E7%94%B1%E8%81%9A%E5%90%88%E4%B8%80.png" alt="路由聚合一"></p>
<ol>
<li>左边路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.88.196 255.255.255.252 192.168.88.194</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>右边路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.88.0 255.255.255.128 192.168.88.193</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.88.128 255.255.255.192 192.168.88.193</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试连通性</li>
</ol>
<p><img src="/2024/02/18/cisco/%E8%B7%AF%E7%94%B1%E8%81%9A%E5%90%88%E4%BA%8C.png" alt="路由聚合二"></p>
<ol start="4">
<li>从右边路由配置可以看出，两条静态路由可以进行路由聚合，即 192.168.88 前三个字节是相同的，那么聚合后的地址块为 192.168.88.0&#x2F;24，路由配置为</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.88.0 255.255.255.0 192.168.88.193</span></span><br></pre></td></tr></table></figure>

<h2 id="5-特定路由和默认路由"><a href="#5-特定路由和默认路由" class="headerlink" title="5. 特定路由和默认路由"></a>5. 特定路由和默认路由</h2><p>特定路由即将数据报转发给特定的目标地址，而默认路由即除了特定的目标地址外都转发给默认的路由，流程如下图。</p>
<p><img src="/2024/02/18/cisco/%E7%89%B9%E5%AE%9A%E8%B7%AF%E7%94%B1%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1%E4%B8%80.png" alt="特定路由默认路由一"></p>
<p>在以下网络中，目的地址只要是 192.168.4 网段，都会下一跳给 R1 路由器，再由 R2 进行路由转发。</p>
<p><img src="/2024/02/18/cisco/%E7%89%B9%E5%AE%9A%E8%B7%AF%E7%94%B1%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1%E4%BA%8C.png" alt="特定路由默认路由二"></p>
<ol>
<li>R1 路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.4.1 255.255.255.255 10.0.1.1</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 0.0.0.0 0.0.0.0 10.0.0.1</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>R2 路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 0.0.0.0 0.0.0.0 10.0.1.2</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>R3 路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.0.0 255.255.255.0 10.0.0.2</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.4.0 255.255.255.0 10.0.0.2</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 0.0.0.0 0.0.0.0 10.0.2.2</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>R4 路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 0.0.0.0 0.0.0.0 10.0.2.1</span></span><br></pre></td></tr></table></figure>

<h2 id="6-黑洞路由"><a href="#6-黑洞路由" class="headerlink" title="6. 黑洞路由"></a>6. 黑洞路由</h2><p>如果静态路由配置了不存在的网段，那么就可能会导致路由环路的问题，这时候可以添加一个黑洞路由进行解决，如下，只要目的地址是 192.168.88.0&#x2F;24 地址快的数据包都会被丢弃。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">ip route 192.168.88.0 255.255.255.0 null0</span></span><br></pre></td></tr></table></figure>

<h2 id="7-路由信息协议RIP"><a href="#7-路由信息协议RIP" class="headerlink" title="7. 路由信息协议RIP"></a>7. 路由信息协议RIP</h2><p>RIP 是一种分布式的基于距离向量的路由选择协议，属于内部网关协议，主要适用于小规模的网络环境。</p>
<p>在 RIP 协议中，每次数据的发送都会选择跳数最少的路由，即经过节点最少的路由线路。</p>
<p>如下网络中，在给所有主机和路由端口配好 IP 后，还是不能够通信的，给每个路由器设置宣告地址段，即配置 RIP，路由器就会发送 RIP 报文来算出每个网段之间的最短路径，并写入路由表中，最终路径为 PC1 -&gt; R1 -&gt; R3 -&gt; PC2。</p>
<p><img src="/2024/02/18/cisco/RIP%E4%B8%80.png" alt="RIP一"></p>
<ol>
<li>在每个路由器设置 RIP</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">router rip</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.0.0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 192.168.2.0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 192.168.1.0</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>路由表中 R 代表的就是 RIP 协议写入的路由</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router#</span><span class="language-bash">show ip route</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/cisco/RIP%E4%BA%8C.png" alt="RIP二"></p>
<h2 id="8-开放最短路径优先OSFP"><a href="#8-开放最短路径优先OSFP" class="headerlink" title="8. 开放最短路径优先OSFP"></a>8. 开放最短路径优先OSFP</h2><p>OSPF 也属于内部网关协议，用于在单一自治系统 AS 内决策路由，是基于链路状态的动态路由选择协议。</p>
<p>在 OSPF 中，当链路状态发生变化就会采用洪泛法去更新信息，每个路由器都与相邻的路由器成邻居关系，邻居再相互发送链路状态信息形成邻接关系，之后各自根据最短路径算法算出路由，放在OSPF路由表，OSPF路由与其他路由比较后优的加入全局路由表。整个过程使用了五种报文、三个阶段、四张表。</p>
<p>在以下网络中，通过 OSPF 配置路由后的路径为 PC1 -&gt; R1 -&gt; R2 -&gt; R3 -&gt; PC2，因为 R1 与 R3 之间采用的是串行接口，是低速链路。</p>
<p><img src="/2024/02/18/cisco/OSPF%E4%B8%80.png" alt="OSPF一"></p>
<ol>
<li>R1 路由器配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">100为指定进程，可在1-65535之间选择</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">route ospf 100</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">0.0.0.255为反子网掩码，area为地区号</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.0.0 0.0.0.255 area 0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 192.168.1.0 0.0.0.255 area 0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.1.0 0.0.0.255 area 0</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>R2 路由器配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">route ospf 100</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.0.0 0.0.0.255 area 0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.1.0 0.0.0.255 area 0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.2.0 0.0.0.255 area 0</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>R3 路由器配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">route ospf 100</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.1.0 0.0.0.255 area 0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 10.0.2.0 0.0.0.255 area 0</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 192.168.2.0 0.0.0.255 area 0</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过测试可以看到路由线路的选择</li>
</ol>
<p><img src="/2024/02/18/cisco/OSPF%E4%BA%8C.png" alt="OSPF二"></p>
<ol start="5">
<li>如果线路断了会自动更新路由表，这时候再看线路的选择就会不一样，但依旧可以联通</li>
</ol>
<p><img src="/2024/02/18/cisco/OSPF%E4%B8%89.png" alt="OSPF三"></p>
<h2 id="9-边界网关协议BGP"><a href="#9-边界网关协议BGP" class="headerlink" title="9. 边界网关协议BGP"></a>9. 边界网关协议BGP</h2><p>BGP 是一种外部网关协议，是基于自治系统 AS 之间的路由协议，BGP交换的网络可达性信息提供了足够的信息来检测路由回路并根据性能优先和策略约束对路由进行决策。</p>
<p>每个 AS 会设置一个 BGP 发言人，即一个路由器，用来与相邻 AS 的 BGP 发言人交换网络可达性的信息。</p>
<p>如下图网络，分别有三个 AS，要将不同 AS 之间进行联通，就可以通过 BGP 来实现。</p>
<p><img src="/2024/02/18/cisco/BGP%E4%B8%80.png" alt="BGP一"></p>
<ol>
<li>AS 100 中路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">100为自治系统编号</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">route bgp 100</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定邻居，IP即与相邻路由器的连接端口IP，200/300为相邻AS的编号</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">neighbor 10.0.1.2 remote-as 200</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">neighbor 10.0.0.2 remote-as 300</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将自身AS中的网络信息通报出去</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 192.168.10.0 mask 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AS 200 中路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">route bgp 200</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">neighbor 10.0.1.1 remote-as 100</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 192.168.20.0 mask 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>AS 300 中路由配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">route bgp 300</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">neighbor 10.0.0.1 remote-as 100</span></span><br><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash">network 192.168.30.0 mask 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>查看 BGP 路由信息，可以看到 B 代表的 BGP 路由信息</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Router(config-router)#</span><span class="language-bash"><span class="keyword">do</span> show ip route</span></span><br><span class="line">...</span><br><span class="line">B    192.168.10.0/24 [20/0] via 10.0.1.1, 00:00:00</span><br><span class="line">B    192.168.30.0/24 [20/0] via 10.0.1.1, 00:00:00</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="10-多臂路由实现vlan之间的通信"><a href="#10-多臂路由实现vlan之间的通信" class="headerlink" title="10. 多臂路由实现vlan之间的通信"></a>10. 多臂路由实现vlan之间的通信</h2><p>vlan 之间如果网段不同，就无法进行通信，可以在中间添加一台路由器来做双方的网关，已多臂路由的方式实现不同 vlan 不同网段之间的通信。</p>
<p>多臂路由即一个端口对应一个 vlan，如下图。</p>
<p><img src="/2024/02/18/cisco/%E5%A4%9A%E8%87%82%E8%B7%AF%E7%94%B1%E4%B8%80.png" alt="多臂路由一"></p>
<h2 id="11-单臂路由实现vlan之间的通信"><a href="#11-单臂路由实现vlan之间的通信" class="headerlink" title="11. 单臂路由实现vlan之间的通信"></a>11. 单臂路由实现vlan之间的通信</h2><p>单臂路由与多臂路由的原理是相同的，区别在于在多臂路由中，交换机到路由器的链路配置的是 access，在单臂路由中用一个主干 trunk 链路替代。</p>
<ol>
<li>在连接交换机的路由器上配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建逻辑子接口</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">int g0/0.1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可接受<span class="built_in">id</span>为10的vlan数据包，并封装成802.1q桢进行转发</span></span><br><span class="line"><span class="meta prompt_">Router(config-subif)#</span><span class="language-bash">encapsulation dot1Q 10</span></span><br><span class="line"><span class="meta prompt_">Router(config-subif)#</span><span class="language-bash">ip add 192.168.1.254 255.255.255.0</span></span><br><span class="line"><span class="meta prompt_">Router(config-subif)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">int g0/0.2</span></span><br><span class="line"><span class="meta prompt_">Router(config-subif)#</span><span class="language-bash">encapsulation dot1Q 20</span></span><br><span class="line"><span class="meta prompt_">Router(config-subif)#</span><span class="language-bash">ip add 192.168.2.254 255.255.255.0</span></span><br><span class="line"><span class="meta prompt_">Router(config-subif)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启接口</span></span><br><span class="line"><span class="meta prompt_">Router(config)#</span><span class="language-bash">int g0/0</span></span><br><span class="line"><span class="meta prompt_">Router(config-if)#</span><span class="language-bash">no shutdown</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在交换机上将与路由器相接的端口设置为 trunk 口</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">int f0/7</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if)#</span><span class="language-bash">switchport mode trunk</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>连通性测试</li>
</ol>
<p><img src="/2024/02/18/cisco/%E5%8D%95%E8%87%82%E8%B7%AF%E7%94%B1%E4%B8%80.png" alt="单臂路由一"></p>
<h2 id="12-三层交换机实现vlan之间的通信"><a href="#12-三层交换机实现vlan之间的通信" class="headerlink" title="12. 三层交换机实现vlan之间的通信"></a>12. 三层交换机实现vlan之间的通信</h2><p>三层交换机就是具有部分路由器功能的交换机。</p>
<ol>
<li>三层交换机配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">vlan 10</span></span><br><span class="line"><span class="meta prompt_">Switch(config-vlan)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入vlan添加IP</span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">int vlan10</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if)#</span><span class="language-bash">ip add 192.168.1.254 255.255.255.0</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if)#</span><span class="language-bash">no shutdown</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">vlan 20</span></span><br><span class="line"><span class="meta prompt_">Switch(config-vlan)#</span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">int vlan20</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if)#</span><span class="language-bash">ip add 192.168.2.254 255.255.255.0</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if)#</span><span class="language-bash">no shutdown</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if)#</span><span class="language-bash"><span class="built_in">exit</span></span>	</span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">int range f0/1-3</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport mode access</span> </span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport access vlan 10</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">Switch(config-if-range)<span class="comment">#exit</span></span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">int range f0/4-6</span></span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport mode access</span> </span><br><span class="line"><span class="meta prompt_">Switch(config-if-range)#</span><span class="language-bash">switchport access vlan 20</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启路由功能</span></span><br><span class="line"><span class="meta prompt_">Switch(config)#</span><span class="language-bash">ip routing</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试连通性</li>
</ol>
<p><img src="/2024/02/18/cisco/%E4%B8%89%E5%B1%82%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%B8%80.png" alt="三层交换机一"></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">Previous</a></div><div class="pagination-next"><a href="/page/3/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/NUX_Octodex.gif" alt="Warner"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">16</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqmmm/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-11T09:15:48.000Z">2024-03-11</time></p><p class="title"><a href="/2024/03/11/Pod%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%9E%E7%94%9F%E7%9A%84/">Pod是怎么诞生的</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-29T05:08:36.000Z">2024-02-29</time></p><p class="title"><a href="/2024/02/29/%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85containerd%E5%92%8Cnerdctl/">快速安装containerd和nerdctl</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T09:39:48.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/%E9%A6%96%E9%A1%B5/">首页</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/ansible/">Ansible</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/cka/">CKA</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/containerd/"><span class="tag">containerd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">首页</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2024 Warner</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>