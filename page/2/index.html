<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Warner&#039;s Wiki"><meta property="og:url" content="https://cqmmm.github.io/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cqmmm.github.io/img/og_image.png"><meta property="article:author" content="Warner"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cqmmm.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqmmm.github.io"},"headline":"Warner's Wiki","image":["https://cqmmm.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Warner"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://cqmmm.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:14:58.446Z" title="2/18/2024, 5:14:58 PM">2024-02-18</time></span><span class="level-item">6 minutes read (About 850 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/nexus/">Nexus</a></p><div class="content"><p>Nexus 是一个用于专门搭建 Maven 仓库的软件，除了作为 Maven 仓库，它还能够作为 Docker 镜像仓库、Yum 仓库等等。</p>
<h2 id="Nexus-部署"><a href="#Nexus-部署" class="headerlink" title="Nexus 部署"></a>Nexus 部署</h2><p><strong>deploy.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-mount-hack</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;-c&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;chown -R 200:200 /nexus-data&#x27;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nexus-data</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">sonatype/nexus3:3.37.3</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INSTALL4J_ADD_VM_PARAMS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;-Xms2703m -Xmx2703m -XX:MaxDirectMemorySize=2703m -Djava.util.prefs.userRoot=$&#123;NEXUS_DATA&#125;/javaprefs&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2048Mi</span>      </span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2048Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/nexus-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus-data</span></span><br><span class="line">        <span class="comment"># 自行修改挂载类型，不修改则需创建对应PV和PVC👇</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nexus-data</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br></pre></td></tr></table></figure>

<p>部署后，在容器内部获取 admin 密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $(cat /nexus-data/admin.password)</span><br></pre></td></tr></table></figure>

<h2 id="默认仓库说明"><a href="#默认仓库说明" class="headerlink" title="默认仓库说明"></a>默认仓库说明</h2><ul>
<li>maven-central：中央仓库，默认从 <code>https://repo1.maven.org/maven2/</code> 拉取 jar 包</li>
<li>maven-releases：私库发行 jar，建议将设置改为 <code>Allow redeploy</code></li>
<li>maven-snapshots：私库快照 jar，即库中的 jar 均为调试版本</li>
<li>maven-public：仓库分组，把上面三个仓库组合在一起对外提供服务，在本地 maven 的 settings.xml 文件或项目的 pom.xml 文件设置为该仓库地址，即可调用</li>
</ul>
<h2 id="仓库类型说明"><a href="#仓库类型说明" class="headerlink" title="仓库类型说明"></a>仓库类型说明</h2><ul>
<li>group：仓库组，起到了聚合的作用，在该组中的仓库都可以通过该组的 URL 进行访问</li>
<li>hosted：私有仓库，顾名思义，用来存储自己的 jar 包</li>
<li>snapshot：快照仓库</li>
<li>release：本地项目的正式版本仓库</li>
<li>proxy：代理，Nexus 的 maven-central 就是这种类型，代理地址为 <code>https://repo1.maven.org/maven2/</code> ，默认会去该地址下拉取 jar 包</li>
<li>central：中央仓库</li>
</ul>
<h2 id="新增代理仓库"><a href="#新增代理仓库" class="headerlink" title="新增代理仓库"></a>新增代理仓库</h2><p>创建仓库选择 <code>maven2(proxy)</code> 类型</p>
<p><img src="/2024/02/18/nexus/%E6%96%B0%E5%A2%9E%E4%BB%A3%E7%90%86%E4%BB%93%E5%BA%93.png" alt="新增代理仓库"></p>
<p>添加到 <code>maven-public</code></p>
<p><img src="/2024/02/18/nexus/%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%BB%84.png" alt="添加到组"></p>
<h2 id="Maven-配置使用私服"><a href="#Maven-配置使用私服" class="headerlink" title="Maven 配置使用私服"></a>Maven 配置使用私服</h2><p>要在本地 Maven 在私服拉取 jar 的方式有两种：</p>
<ul>
<li>settings.xml：全局配置模式</li>
<li>pom.xml：项目独享模式</li>
</ul>
<p>如果两种方式都配置了，那么以 pom.xml 文件配置为准。</p>
<p>当我们通过 Maven 使用 Nexus 的 <code>maven-public</code> 的时候，会按照以下方式顺序访问：</p>
<ol>
<li><p>本地仓库</p>
</li>
<li><p>私服 maven-releases</p>
</li>
<li><p>私服 maven-snapshots</p>
</li>
<li><p>远程阿里 maven 仓库</p>
</li>
<li><p>远程中央仓库</p>
</li>
</ol>
<h3 id="通过-settings-xml-文件配置"><a href="#通过-settings-xml-文件配置" class="headerlink" title="通过 settings.xml 文件配置"></a>通过 settings.xml 文件配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- servers块中添加用户认证信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">password</span>&gt;</span>changeme<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mirrors块中添加maven-public信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 唯一标识符 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line">   <span class="comment">&lt;!-- 名称 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>cqm maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- maven-public地址 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.159.11:35826/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- *指的是访问任何仓库都使用我们的私服，可设置为central等等 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以设置为阿里的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="通过-pom-xml-文件配置"><a href="#通过-pom-xml-文件配置" class="headerlink" title="通过 pom.xml 文件配置"></a>通过 pom.xml 文件配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>mnexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>cqm nexus<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.159.11:35826/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同样也可以设置为阿里的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>fail<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用-Maven-批量向-Nexus-上传"><a href="#使用-Maven-批量向-Nexus-上传" class="headerlink" title="使用 Maven 批量向 Nexus 上传"></a>使用 Maven 批量向 Nexus 上传</h2><p>首先需要将 <code>.m2/repository</code> 下的相应 jar 包和 pom 文件 cp 出来，再进行 deploy。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-DrepositoryId 参数调用了 settings.xml 中 servers 块的账号密码进行认证</span></span><br><span class="line">find . -name &quot;*.jar&quot; | awk &#x27;&#123; gsub(&quot;\.jar$&quot;,&quot;&quot;,$0); print &quot;mvn deploy:deploy-file -Dfile=&quot;$0&quot;.jar -DpomFile=&quot;$0&quot;.pom -Dpackaging=jar -DrepositoryId=nexus -Durl=\&quot;http://nexus-path\&quot;&quot;&#125;&#x27;	</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:58.270Z" title="2/18/2024, 7:02:58 PM">2024-02-18</time></span><span class="level-item">18 minutes read (About 2754 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/zookeeper/">Zookeeper</a></p><div class="content"><p><img src="/2024/02/18/zookeeper/logo.jpg" alt="logo"></p>
<p>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务，是 Hadoop 和 Hbase 的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。</p>
<h2 id="一、Zookeeper基础"><a href="#一、Zookeeper基础" class="headerlink" title="一、Zookeeper基础"></a>一、Zookeeper基础</h2><h3 id="1-1-使用场景"><a href="#1-1-使用场景" class="headerlink" title="1.1 使用场景"></a>1.1 使用场景</h3><ul>
<li>分布式协调组件：通过 watch 机制可以协调好节点之间的数据一致性</li>
<li>分布式锁：通过分布式锁可以做到强一致性</li>
<li>无状态化实现</li>
<li>负载均衡</li>
<li>数据发布&#x2F;订阅</li>
<li>命名服务</li>
</ul>
<h3 id="1-2-部署"><a href="#1-2-部署" class="headerlink" title="1.2 部署"></a>1.2 部署</h3><p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>zoo.cfg</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/datalog</span><br><span class="line"><span class="comment"># 基本时间配置（毫秒）</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># 初始化连接到leader的最大时长，单位为倍数，即初始化时间为tickTime * initLimit</span></span><br><span class="line">initLimit=5</span><br><span class="line"><span class="comment"># follower与leader数据同步的最大时长</span></span><br><span class="line">syncLimit=2</span><br><span class="line"><span class="comment"># 保存数据的快照数量</span></span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line"><span class="comment"># 自动触发清除任务时间间隔，以小时为单位，默认为0，表不清除</span></span><br><span class="line">autopurge.purgeInterval=0</span><br><span class="line"><span class="comment"># 客户端与zk的最大并发连接数</span></span><br><span class="line">maxClientCnxns=60</span><br><span class="line"><span class="comment"># 开启standaloneEnabled模式，即独立部署</span></span><br><span class="line">standaloneEnabled=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启adminServer</span></span><br><span class="line">admin.enableServer=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 2181是为客户端提供的端口</span></span><br><span class="line">server.1=zk01:2888:3888;2181</span><br></pre></td></tr></table></figure>

<h3 id="1-3-基本命令"><a href="#1-3-基本命令" class="headerlink" title="1.3 基本命令"></a>1.3 基本命令</h3><ol>
<li>启动|关闭|查看状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start|stop|status</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 zk</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看内部数据结构</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls [path]</span><br></pre></td></tr></table></figure>



<h2 id="二、内部数据结构"><a href="#二、内部数据结构" class="headerlink" title="二、内部数据结构"></a>二、内部数据结构</h2><h3 id="2-1-是如何存储数据的"><a href="#2-1-是如何存储数据的" class="headerlink" title="2.1 是如何存储数据的"></a>2.1 是如何存储数据的</h3><p>Zookeeper 中的数据是保存在节点上的，即 znode，多个 znode 就构成一个树的结构。</p>
<p><img src="/2024/02/18/zookeeper/zk%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png" alt="zk数据存储结构"></p>
<p>如图，a 和 b 就是 Zookeeper 的 znode，创建 znode 方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create /[znode_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建节点并创建一个数据</span></span><br><span class="line">create /[znode_name] [data_name]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取数据</span></span><br><span class="line">get [znode_name]</span><br></pre></td></tr></table></figure>

<h3 id="2-2-znode结构"><a href="#2-2-znode结构" class="headerlink" title="2.2 znode结构"></a>2.2 znode结构</h3><p>Zookeeper 中的 zonode，包含以下几个部分：</p>
<ul>
<li>data：保存数据</li>
<li>acl：权限<ul>
<li>c：创建权限</li>
<li>w：写权限</li>
<li>r：读权限</li>
<li>d：删除权限</li>
<li>a：admin 管理者权限</li>
</ul>
</li>
<li>stat：描述当前 znode 的元数据</li>
<li>child：当前节点的子节点</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看znode详细信息</span></span><br><span class="line">get -s /[znode_name]</span><br><span class="line">cZxid:创建节点的事务ID</span><br><span class="line">ctime:创建节点时间</span><br><span class="line">mZxid:修改节点的事务ID</span><br><span class="line">mtime:修改节点时间</span><br><span class="line">pZxid:添加和删除子节点的事务ID</span><br><span class="line">cversion:当前节点的子节点版本号，初始值为-1，每对该节点的子节点进行操作，这个cversion都会自动增加</span><br><span class="line">dataVersion:数据版本初识版本为0，每对该节点的数据进行操作，这个dataVersion都会自动增加</span><br><span class="line">aclVersion:权限版本</span><br><span class="line">ephemeralOwne:如果当前节点是临时节点，该值是当前节点的session id，如果不是临时节点则为0</span><br><span class="line">dataLength:数据长度</span><br><span class="line">numChildren:该节点的子节点个数</span><br></pre></td></tr></table></figure>

<h3 id="2-3-znode类型"><a href="#2-3-znode类型" class="headerlink" title="2.3 znode类型"></a>2.3 znode类型</h3><ul>
<li>持久节点：在会话结束后仍会存在</li>
<li>持久序号节点：根据先后顺序，会在结点之后带上一个数值，适用于分布式锁的场景（单调递增）</li>
<li>临时节点：会话结束后会自动删除，适用于注册与服务发现的场景</li>
<li>临时序号节点：跟持久序号节点相同，适用于分布式锁的场景</li>
<li>容器节点：当容器节点中没有任何子节点时，该容器节点会被定期删除（60s）</li>
<li>TTL 节点：可以指定节点的到期时间</li>
</ul>
<p><strong>持久序号节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>临时节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>临时序号节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e -s /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>容器节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -c /[znode_name]</span><br></pre></td></tr></table></figure>

<p><strong>TTL 节点创建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过系统配置开启</span></span><br><span class="line">zookeeper.extendedTypesEnabled=true</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/zookeeper/%E6%8C%81%E4%B9%85%E4%B8%8E%E4%B8%B4%E6%97%B6%E8%8A%82%E7%82%B9.png" alt="持久与临时节点"></p>
<p><strong>持久节点</strong></p>
<p>持久节点在创建后服务端会发送一个 <code>session id</code>，并一直保留着。</p>
<p><strong>临时节点</strong></p>
<p>临时节点在创建时后服务器也会发送一个 <code>session id</code>，在会话持续的过程中客户端会不断向服务端续约 <code>session id</code> 的时间，当客户端没有继续续约，而服务端内部的计时器到期时，就会将该 <code>session id</code> 所对应的 znode 全部删除。</p>
<h3 id="2-4-持久化机制"><a href="#2-4-持久化机制" class="headerlink" title="2.4 持久化机制"></a>2.4 持久化机制</h3><p>Zookeeper 的数据是运行在内存中的，所以提供了两种持久化机制：</p>
<ul>
<li>事务日志：Zookeeper 将执行过的命令以日志的形式存储在 dataLogDir &#x2F; dataDir 中，类似于 redis 的 AOF</li>
<li>数据快照：在一定时间间隔内做一次数据快照，存储在快照文件中（snapshot），类似于 redis 的RDB</li>
</ul>
<p>Zookeeper 通过这两种持久化机制，在恢复数据时先将快照文件中的数据恢复到内存中，再用日志文件中的数据做增量恢复，可以实现高效的持久化。</p>
<h2 id="三、zkCli的使用"><a href="#三、zkCli的使用" class="headerlink" title="三、zkCli的使用"></a>三、zkCli的使用</h2><ol>
<li>递归查询</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -R /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>删除节点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deleteall /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>乐观锁删除</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete -v [version] /[znode_name]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>给当前会话注册用户，并创建节点赋予该用户权限</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addauth digest [user]:[password]</span><br><span class="line">create /[znode_name] auth:[user]:[password]:[privileges]</span><br></pre></td></tr></table></figure>



<h2 id="四、分布式锁"><a href="#四、分布式锁" class="headerlink" title="四、分布式锁"></a>四、分布式锁</h2><p>在分布式的环境下，如果在一个节点去上了个锁，当请求被负载均衡分配到了其它节点，那么锁就无法形成互斥，所以节点之间使用 Zookeeper，做一个协调中心，将锁上传到 Zookeeper，其它节点要用到就去 Zookeeper 拿这个锁，这就是分布式锁。</p>
<p>Zookeeper 锁的分类：</p>
<ul>
<li>读锁：大家都可以读，前提是之前没有写锁。（读锁比喻成约会，大家都有机会和女神约会，约会前提是女神没结婚）</li>
<li>写锁：只有写锁才能写，前提是不能有任何锁。（写锁比喻成结婚，结婚后只有老公能和女神约会，结婚前提是女神和其他人的关系断干净了）</li>
</ul>
<h3 id="4-1-上读锁"><a href="#4-1-上读锁" class="headerlink" title="4.1 上读锁"></a>4.1 上读锁</h3><ul>
<li>创建一个临时序号节点，节点数据是 read，表示为读锁</li>
<li>获取当前 Zookeeper 中序号比自己小的所有节点</li>
<li>判断最小节点是否为读锁：<ul>
<li>如果是读锁：则上锁失败，因为如果最小节点是读锁，那么后面就不可能有写锁，接着为最小节点设置监听，Zookeeper 的 watch 机制会在最小节点发生变化时通知当前节点，再进行后面的步骤，被称为阻塞等待</li>
<li>如果不是读锁：则上锁成功</li>
</ul>
</li>
</ul>
<h3 id="4-2-上写锁"><a href="#4-2-上写锁" class="headerlink" title="4.2 上写锁"></a>4.2 上写锁</h3><ul>
<li>创建一个临时序号节点，节点数据是 write，表示为写锁</li>
<li>获取 Zookeeper 中的所有节点</li>
<li>判断自己是否为最小节点：<ul>
<li>如果是：上锁成功</li>
<li>如果不是：说明前面还有锁，所以上锁失败，接着监听最小节点，如果最小节点发生变化，则重新进行第二步</li>
</ul>
</li>
</ul>
<p><strong>羊群效应</strong></p>
<p>假设有一百个请求都是要去写锁，那么就会有一百个请求去监听最小节点，那么 Zookeeper 的压力就会非常大，解决方法是将这一百个请求按请求顺序排列，后一个请求去监听前一个请求即可，实现链式监听。</p>
<h3 id="4-3-watch机制"><a href="#4-3-watch机制" class="headerlink" title="4.3 watch机制"></a>4.3 watch机制</h3><p>Zookeeper 的 watch 可以看作是一个触发器，当监控的 znode 发生改变，就会触发 znode 上注册的对应事件，请求 watch 的客户端就会接收到异步通知。</p>
<p><strong>zkCli.sh 中使用 watch</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一次性监听，监听节点内容</span></span><br><span class="line">get -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听目录，但所监听节点下创建和删除子节点不会触发监听</span></span><br><span class="line">ls -w /test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">与上面相对，都会触发监听</span></span><br><span class="line">ls -R -w /test</span><br></pre></td></tr></table></figure>



<h2 id="五、集群部署"><a href="#五、集群部署" class="headerlink" title="五、集群部署"></a>五、集群部署</h2><p>Zookeeper 的集群角色有三个：</p>
<ul>
<li>Leader：处理集群所有事务的请求，集群只有一个 Leader</li>
<li>Follower：只处理读请求，参与 Leader 选举</li>
<li>Observer：只处理读请求，提升集群的性能，但不能参与 Leader 选举</li>
</ul>
<p><strong>docker-compose.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zk01:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="comment"># 2888:用于集群内zk之间的通信</span></span><br><span class="line">      <span class="comment"># 3888:用于选举投票</span></span><br><span class="line">      <span class="comment"># 2181:客户端使用</span></span><br><span class="line">      <span class="comment"># 要创建observer则在2181端口后加:observer</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">zk02:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk02</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2182</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">zk03:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper:3.7.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zk03</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2183</span><span class="string">:2181</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOO_MY_ID:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zk01:2888:3888;2181</span> <span class="string">server.2=zk02:2888:3888;2181</span> <span class="string">server.3=zk03:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p><strong>通过命令查看节点角色</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh status</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure>

<p><strong>连接集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh -server zk01:2181,zk02:2181,zk03:2181</span><br></pre></td></tr></table></figure>

<h3 id="5-1-ZAB协议"><a href="#5-1-ZAB协议" class="headerlink" title="5.1 ZAB协议"></a>5.1 ZAB协议</h3><p>ZAB（Zookeeper Atomic Broadcast）即 Zookeeper 原子广播协议，通过这个协议解决了集群数据一致性和崩溃恢复的问题。</p>
<p><strong>ZAB 协议中节点的四种状态</strong></p>
<ul>
<li>Looking：选举状态</li>
<li>Following</li>
<li>Leading</li>
<li>Observing</li>
</ul>
<p><strong>初始化集群时 leader 的选举</strong></p>
<ul>
<li>当集群中两台节点启动时，就会开始 leader 的选举，选票的格式为 <code>(myid,zXid)</code></li>
<li>第一轮投票时，每个节点会生成自己的选票，即自己的 <code>(myid,zXid)</code>，然后将选票给到对方，这时候每个节点就会有两张选票，即自己的和对方节点的</li>
<li>接着就会比较两张选票的 <code>zXid</code>，如果都相同就对比 <code>myid</code>，将大的一票投到投票箱中</li>
<li>第二轮投票时，每个节点会将上一轮投出去的选票给到其它节点，然后再对比 <code>(myid,zXid)</code>，将大的一票投出去，就能够选出 leader</li>
<li>后来新启动的节点会发现已经有 leader了，就不用做选举的过程了</li>
<li>可以看出初始化集群时，leader 的选举主要看 <code>myid</code></li>
</ul>
<p><strong>崩溃恢复时的 leader 选举</strong></p>
<p>在 leader 确定了之后，leader 会周期性地向 follower 发送心跳包，当 follower 没有收到 leader 发送过来的心跳包，就会进入选举过程，这时候集群不能对外提供服务。</p>
<ul>
<li>当 leader 挂了之后，follower 的状态会变成 looking</li>
<li>接着就进行选举投票，过程和初始化集群时一样</li>
</ul>
<h3 id="5-2-主从同步原理"><a href="#5-2-主从同步原理" class="headerlink" title="5.2 主从同步原理"></a>5.2 主从同步原理</h3><p><img src="/2024/02/18/zookeeper/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86.png" alt="主从同步原理"></p>
<h3 id="5-3-NIO和BIO"><a href="#5-3-NIO和BIO" class="headerlink" title="5.3 NIO和BIO"></a>5.3 NIO和BIO</h3><p><strong>NIO</strong></p>
<p>用于被客户端连接的 2181 端口，使用的就是 NIO 的连接模式；客户端开启 watch 时，使用的也是 NIO。</p>
<p><strong>BIO</strong></p>
<p>集群在进行选举时，多个节点之间的通信端口，使用的是 BIO 的连接模式。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:24.353Z" title="2/18/2024, 7:02:24 PM">2024-02-18</time></span><span class="level-item">an hour read (About 10192 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/web/">Web</a></p><div class="content"><h2 id="一、Apache"><a href="#一、Apache" class="headerlink" title="一、Apache"></a>一、Apache</h2><h3 id="1-1-Apache介绍"><a href="#1-1-Apache介绍" class="headerlink" title="1.1 Apache介绍"></a>1.1 Apache介绍</h3><p>Apache HTTP Server（简称Apache）是Apache软件基金会的一个开放源码的网页服务器，是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。它快速、可靠并且可通过简单的API扩充，将Perl&#x2F;Python等解释器编译到服务器中。</p>
<p>Apache HTTP服务器是一个模块化的服务器，源于NCSAhttpd服务器，经过多次修改，成为世界使用排名第一的Web服务器软件。</p>
<p>Apache官方文档：<a target="_blank" rel="noopener" href="http://httpd.apache.org/docs/">http://httpd.apache.org/docs/</a></p>
<h3 id="1-2-通过脚本源码安装Apache"><a href="#1-2-通过脚本源码安装Apache" class="headerlink" title="1.2 通过脚本源码安装Apache"></a>1.2 通过脚本源码安装Apache</h3><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -r www</span><br><span class="line">vim apache-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apr_version=1.7.0</span><br><span class="line">apr_iconv_version=1.2.2</span><br><span class="line">apr_util_version=1.6.1</span><br><span class="line">apache_version=2.4.46</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否为root用户</span></span><br><span class="line">   if [ $USER != &#x27;root&#x27; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否安装了wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装依赖</span></span><br><span class="line">   if [ ! `yum -y install zlib-devel pcre-devel libxml2 expat-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/apr/apr-$&#123;apr_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-$&#123;apr_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-$&#123;apr_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-$&#123;apr_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-$&#123;apr_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-$&#123;apr_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr</span></span><br><span class="line">   echo &quot;apr configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">	   echo -e &quot;\e[1;32m apr installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">	   echo -e &quot;\e[1;31m apr installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr-iconv</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-iconv-$&#123;apr_iconv_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-iconv-$&#123;apr_iconv_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-iconv-$&#123;apr_iconv_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr-iconv</span></span><br><span class="line">   echo &quot;apr-iconv configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-iconv --with-apr=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then </span><br><span class="line">       echo &quot;apr-iconv make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-iconv installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-iconv installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-iconv configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr-util</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-util-$&#123;apr_util_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-util-$&#123;apr_util_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-util-$&#123;apr_util_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-util-$&#123;apr_util_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-util-$&#123;apr_util_version&#125;</span><br><span class="line">       fi  </span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-util-$&#123;apr_util_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr-util</span></span><br><span class="line">   echo &quot;apr-util configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr-util make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-util installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-util installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-util configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载安装Apache</span></span><br><span class="line">function apache_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载Apache</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/httpd/httpd-$&#123;apache_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf httpd-$&#123;apache_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d httpd-$&#123;apache_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd httpd-$&#123;apache_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装Apache</span></span><br><span class="line">   echo &quot;Apache configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apache --enable-mpms-shared=all --with-mpm=event --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-so --enable-remoteip --enable-proxy --enable-proxy-fcgi --enable-proxy-uwsgi --enable-deflate=shared --enable-expires=shared --enable-rewrite=shared --enable-cache --enable-file-cache --enable-mem-cache --enable-disk-cache --enable-static-support --enable-static-ab --disable-userdir --enable-nonportable-atomics --disable-ipv6 --with-sendfile &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;Apache make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m Apache installed sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m Apache installed failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m Apache configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">apache_install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写启动脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apache_doc=/usr/local/apache/bin</span><br><span class="line">apache_pid=/usr/local/apache/logs/httpd.pid</span><br><span class="line"></span><br><span class="line">function apache_start()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $apache_num -eq 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall httpd</span><br><span class="line">   fi</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl</span><br><span class="line">   echo -e &quot;start Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_stop()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       killall httpd</span><br><span class="line">       echo -e &quot;stop Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_restart()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl restart</span><br><span class="line">   echo -e &quot;restart Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_status()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_reload()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       cd /usr/local/apache/bin;./apachectl graceful</span><br><span class="line">       echo -e &quot;reload Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        apache_start</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        apache_stop</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">restart)</span><br><span class="line">        apache_restart</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">status)</span><br><span class="line">        apache_status</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">reload)</span><br><span class="line">        apache_reload</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="1-3-多处理模块MPM"><a href="#1-3-多处理模块MPM" class="headerlink" title="1.3 多处理模块MPM"></a>1.3 多处理模块MPM</h3><p>Apache HTTP 服务器被设计为一个功能强大，并且灵活的 web 服务器， 可以在很多平台与环境中工作。不同平台和不同的环境往往需要不同 的特性，或可能以不同的方式实现相同的特性最有效率。Apache 通过模块化的设计来适应各种环境。这种设计允许网站管理员通过在 编译时或运行时，选择哪些模块将会加载在服务器中，来选择服务器特性。</p>
<p>实际上就是用来<strong>接受请求</strong>和<strong>处理请求</strong>的。</p>
<p>Apache的三种工作方式：</p>
<ol>
<li>Prefork MPM：使用多个进程，每个进程只有一个线程，每个进程再某个确定的时间只能维持一个连接，有点是稳定，缺点是内存消耗过高。</li>
</ol>
<p>![Prefork MPM](Prefork MPM.png)</p>
<ol>
<li>Worker MPM：使用多个进程，每个进程有多个线程，每个线程在某个确定的时间只能维持一个连接，内存占用比较小，是个大并发、高流量的场景，缺点是一个线程崩溃，整个进程就会连同其任何线程一起挂掉。</li>
</ol>
<p>![Worker MPM](Worker MPM.png)</p>
<ol start="3">
<li>Event MPM：使用多进程多线程+epoll的模式。</li>
</ol>
<p>![Event MPM](Event MPM.png)</p>
<h3 id="1-4-虚拟主机"><a href="#1-4-虚拟主机" class="headerlink" title="1.4 虚拟主机"></a>1.4 虚拟主机</h3><p>默认情况下，一个web服务器只能发布一个默认网站，也就是只能发布一个web站点，对于大网站来说还好，但对于访问量较少的小网站那就显得有点浪费了。</p>
<p>而虚拟主机就可以实现在一个web服务器上发布多个站点，分为基于IP地址、域名和端口三种。</p>
<p>Apache的虚拟主机和默认网站不能够同时存在，如果设置了虚拟主机那么默认网站也就失效了，需要在用虚拟主机发布默认站点才可解决。</p>
<p>基于IP：基于IP的虚拟主机需要耗费大量的IP地址，只适合IP地址充足的环境。</p>
<p>基于端口：需要耗费较多的端口，适合私网环境。</p>
<p>基于域名：需要耗费较多的域名，适合公网环境。</p>
<h4 id="1-4-1-基于IP的虚拟主机"><a href="#1-4-1-基于IP的虚拟主机" class="headerlink" title="1.4.1 基于IP的虚拟主机"></a>1.4.1 基于IP的虚拟主机</h4><ol>
<li>在主配文件中调用虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Virtual hosts</span></span><br><span class="line">Include conf/extra/httpd-vhosts.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个逻辑网卡，重启即失效</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost 49.232.160.75:80&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">管理员邮箱</span></span><br><span class="line">    # ServerAdmin webmaster@dummy-host.example.com</span><br><span class="line">    # web目录</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    # 域名</span><br><span class="line">    # ServerName dummy-host.example.com</span><br><span class="line">    # 给域名起别名，起到重定向作用</span><br><span class="line">    # ServerAlias www.dummy-host.example.com</span><br><span class="line">    # 错误日子</span><br><span class="line">    # ErrorLog &quot;logs/dummy-host.example.com-error_log&quot;</span><br><span class="line">    # 访问日志</span><br><span class="line">    # CustomLog &quot;logs/dummy-host.example.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.88.100:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建站点目录和文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/apache/htdocs/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/apache/htdocs/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/apache/htdocs/web2/index.html</span><br><span class="line">./apache start</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8EIP%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于IP虚拟主机测试"></p>
<h4 id="1-4-2-基于端口的虚拟主机"><a href="#1-4-2-基于端口的虚拟主机" class="headerlink" title="1.4.2 基于端口的虚拟主机"></a>1.4.2 基于端口的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">Listen 81</span><br><span class="line">&lt;VirtualHost *:81&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E7%AB%AF%E5%8F%A3%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于端口虚拟主机测试"></p>
<h4 id="1-4-3-基于域名的虚拟主机"><a href="#1-4-3-基于域名的虚拟主机" class="headerlink" title="1.4.3 基于域名的虚拟主机"></a>1.4.3 基于域名的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    ServerName www.cqm1.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">    ServerName www.cqm2.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于域名虚拟主机测试"></p>
<h3 id="1-5-LAMP"><a href="#1-5-LAMP" class="headerlink" title="1.5 LAMP"></a>1.5 LAMP</h3><p>LAMP：Linux + Apache + Mysql + PHP</p>
<p>作用就是构建一个PHP业务环境，用来发布PHP网站。</p>
<h4 id="1-5-1-Mysql通过脚本源码安装"><a href="#1-5-1-Mysql通过脚本源码安装" class="headerlink" title="1.5.1 Mysql通过脚本源码安装"></a>1.5.1 Mysql通过脚本源码安装</h4><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mysql_version=5.7.35</span><br><span class="line">install_dir=/opt</span><br><span class="line">data_dir=/data</span><br><span class="line">wget_url=&quot;https://mirrors.tuna.tsinghua.edu.cn/mysql/downloads/MySQL-5.7/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz&quot;</span><br><span class="line"></span><br><span class="line">function loginfo()&#123;</span><br><span class="line">    if [[ $? -eq 0 ]];then</span><br><span class="line">        echo -e &quot;\033[32m[INFO][$(date +&quot;%F %T&quot;)] $1 succeed! \033[0m&quot;</span><br><span class="line">    else</span><br><span class="line">        echo -e &quot;\033[31m[ERROR][$(date +&quot;%F %T&quot;)] $1 failed! \033[0m&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mysql_install()&#123;</span><br><span class="line">    echo -e &quot;\033[32mBegin install mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    </span><br><span class="line">    # 安装依赖</span><br><span class="line">    sudo yum -y install libaio &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;libaio install&quot;</span><br><span class="line"></span><br><span class="line">    # 下载mysql</span><br><span class="line">    echo -e &quot;\033[32mBegin download mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    curl -O $wget_url &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    mv ./mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz $install_dir</span><br><span class="line">    loginfo &quot;mysql software download&quot;</span><br><span class="line"></span><br><span class="line">    # 解压缩mysql</span><br><span class="line">    sudo tar -xf $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz -C $install_dir</span><br><span class="line">    loginfo &quot;mysql software decompression&quot;</span><br><span class="line"></span><br><span class="line">    # 创建配置文件目录和数据目录</span><br><span class="line">    if [[ -d $install_dir/mysql ]];then</span><br><span class="line">        rm -rf $install_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo ln -s $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64 $install_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql config dir soft link&quot;</span><br><span class="line">    if [[ -d $data_dir/mysql ]];then</span><br><span class="line">        rm -rf $data_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo mkdir -p $data_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql data dir&quot;</span><br><span class="line"></span><br><span class="line">    # 修改启动脚本</span><br><span class="line">    sudo sed -i &quot;46s#basedir=#basedir=$&#123;install_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo sed -i &quot;47s#datadir=#datadir=$&#123;data_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo cp $&#123;install_dir&#125;/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">    sudo chmod 755 /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # 创建用户组及用户</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/group</span><br><span class="line">    then</span><br><span class="line">        sudo groupadd mysql</span><br><span class="line">        loginfo &quot;create user mysql&quot;</span><br><span class="line">    fi</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/passwd</span><br><span class="line">    then</span><br><span class="line">        sudo useradd -r -g mysql -s /bin/false mysql</span><br><span class="line">        loginfo &quot;create group mysql&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 授权</span><br><span class="line">    sudo chown -R mysql:mysql $install_dir/mysql</span><br><span class="line">    sudo chown -R mysql:mysql $data_dir/mysql</span><br><span class="line"></span><br><span class="line">    # 为二进制文件创建软连接</span><br><span class="line">    if [ ! -f /usr/bin/mysql ]</span><br><span class="line">    then</span><br><span class="line">        sudo ln -s /opt/mysql/bin/mysql /usr/bin/</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 创建配置文件</span><br><span class="line">    if [ -f /etc/my.cnf ]</span><br><span class="line">    then</span><br><span class="line">        sudo rm -f /etc/my.cnf</span><br><span class="line">    fi</span><br><span class="line">    sudo bash -c &quot;cat &gt;&gt; /etc/my.cnf&quot; &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">datadir                             = /data/mysql</span><br><span class="line">basedir                             = /opt/mysql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">tmpdir                              = /data/mysql/tmp_mysql</span></span><br><span class="line">port                                = 3306</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">pid-file                            = /data/mysql/mysql.pid</span><br><span class="line">max_connections                     = 8000</span><br><span class="line">max_connect_errors                  = 100000</span><br><span class="line">max_user_connections                = 3000</span><br><span class="line">check_proxy_users                   = on</span><br><span class="line">mysql_native_password_proxy_users   = on</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">symbolic-links                      = FALSE</span><br><span class="line">group_concat_max_len                = 4294967295</span><br><span class="line">max_join_size                       = 18446744073709551615</span><br><span class="line">max_execution_time                  = 20000</span><br><span class="line">lock_wait_timeout                   = 60</span><br><span class="line">autocommit                          = 1</span><br><span class="line">lower_case_table_names              = 1</span><br><span class="line">thread_cache_size                   = 64</span><br><span class="line">disabled_storage_engines            = &quot;MyISAM,FEDERATED&quot;</span><br><span class="line">character_set_server                = utf8mb4</span><br><span class="line">character-set-client-handshake      = FALSE</span><br><span class="line">collation_server                    = utf8mb4_general_ci</span><br><span class="line">init_connect                        = &#x27;SET NAMES utf8mb4&#x27;</span><br><span class="line">transaction-isolation               = &quot;READ-COMMITTED&quot;</span><br><span class="line">skip_name_resolve                   = ON</span><br><span class="line">explicit_defaults_for_timestamp     = ON</span><br><span class="line">log_timestamps                      = SYSTEM</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">event_scheduler                     = OFF</span><br><span class="line">query_cache_type                    = OFF</span><br><span class="line">query_cache_size                    = 0</span><br><span class="line">sql_mode                            = NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO</span><br><span class="line">log_error                           = /data/mysql/mysql.err</span><br><span class="line">slow_query_log                      = ON</span><br><span class="line">slow_query_log_file                 = /data/mysql/slow.log</span><br><span class="line">long_query_time                     = 1</span><br><span class="line">general_log                         = OFF</span><br><span class="line">general_log_file                    = /data/mysql/general.log</span><br><span class="line">expire_logs_days                    = 99</span><br><span class="line">log-bin                             = /data/mysql/mysql-bin</span><br><span class="line">log-bin-index                       = /data/mysql/mysql-bin.index</span><br><span class="line">max_binlog_size                     = 500M</span><br><span class="line">binlog_format                       = mixed</span><br><span class="line">binlog_rows_query_log_events        = ON</span><br><span class="line">binlog_cache_size                   = 128k</span><br><span class="line">binlog_stmt_cache_size              = 128k</span><br><span class="line">log-bin-trust-function-creators     = 1</span><br><span class="line">max_binlog_cache_size               = 2G</span><br><span class="line">max_binlog_stmt_cache_size          = 2G</span><br><span class="line">relay_log                           = /data/mysql/relay</span><br><span class="line">relay_log_index                     = /data/mysql/relay.index</span><br><span class="line">max_relay_log_size                  = 500M</span><br><span class="line">relay_log_purge                     = ON</span><br><span class="line">relay_log_recovery                  = ON</span><br><span class="line">server_id                           = 1</span><br><span class="line">read_buffer_size                    = 1M</span><br><span class="line">read_rnd_buffer_size                = 2M</span><br><span class="line">sort_buffer_size                    = 64M</span><br><span class="line">join_buffer_size                    = 64M</span><br><span class="line">tmp_table_size                      = 64M</span><br><span class="line">max_allowed_packet                  = 128M</span><br><span class="line">max_heap_table_size                 = 64M</span><br><span class="line">connect_timeout                     = 43200</span><br><span class="line">wait_timeout                        = 43200</span><br><span class="line">back_log                            = 512</span><br><span class="line">interactive_timeout                 = 300</span><br><span class="line">net_read_timeout                    = 30</span><br><span class="line">net_write_timeout                   = 30</span><br><span class="line">skip_external_locking               = ON</span><br><span class="line">key_buffer_size                     = 16M</span><br><span class="line">bulk_insert_buffer_size             = 16M</span><br><span class="line">concurrent_insert                   = ALWAYS</span><br><span class="line">open_files_limit                    = 65000</span><br><span class="line">table_open_cache                    = 16000</span><br><span class="line">table_definition_cache              = 16000</span><br><span class="line">default_storage_engine              = InnoDB</span><br><span class="line">default_tmp_storage_engine          = InnoDB</span><br><span class="line">internal_tmp_disk_storage_engine    = InnoDB</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[ndatad default]</span><br><span class="line">TransactionDeadLockDetectionTimeOut = 20000</span><br><span class="line">EOF</span><br><span class="line">    sudo chown -R mysql:mysql /etc/my.cnf</span><br><span class="line">    loginfo &quot;configure my.cnf&quot;</span><br><span class="line"></span><br><span class="line">    # 创建SSL证书</span><br><span class="line">    # sudo mkdir -p $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line">    # sudo $&#123;install_dir&#125;/mysql/bin/mysql_ssl_rsa_setup -d $&#123;install_dir&#125;/mysql/ca-pem/ --uid=mysql</span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line"></span><br><span class="line">    # sudo bash -c &quot;cat &gt;&gt; $&#123;data_dir&#125;/mysql/init_file.sql&quot; &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_safe_updates=0;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_select_limit=50000;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">EOF</span></span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;data_dir&#125;/mysql/init_file.sql</span><br><span class="line">    # sudo chown -R mysql:mysql /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # 初始化</span><br><span class="line">    $&#123;install_dir&#125;/mysql/bin/mysqld --initialize --user=mysql --basedir=$&#123;DEPLOY_PATH&#125;/mysql --datadir=/data/mysql </span><br><span class="line">    loginfo &quot;initialize mysql&quot;</span><br><span class="line"></span><br><span class="line">    # 客户端环境变量</span><br><span class="line">    echo &quot;export PATH=\$PATH:$&#123;install_dir&#125;/mysql/bin&quot; | sudo tee /etc/profile.d/mysql.sh</span><br><span class="line">    source /etc/profile.d/mysql.sh</span><br><span class="line">    loginfo &quot;configure envirement&quot;</span><br><span class="line"></span><br><span class="line">    # 获取初始密码</span><br><span class="line">    mysql_init_passwd=$(grep &#x27;A temporary password is generated&#x27; $&#123;data_dir&#125;/mysql/mysql.err | awk &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    # 启动服务</span><br><span class="line">    chkconfig --add mysqld</span><br><span class="line">    sudo systemctl start mysqld</span><br><span class="line">    loginfo &quot;start mysqld&quot;</span><br><span class="line"></span><br><span class="line">    # 修改密码</span><br><span class="line">    mysql --connect-expired-password -uroot -p$&#123;mysql_init_passwd&#125; -e &#x27;alter user user() identified by &quot;toortoor&quot;;&#x27; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;edit mysql root password&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_install</span><br></pre></td></tr></table></figure>

<h4 id="1-5-2-PHP通过脚本源码安装"><a href="#1-5-2-PHP通过脚本源码安装" class="headerlink" title="1.5.2 PHP通过脚本源码安装"></a>1.5.2 PHP通过脚本源码安装</h4><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cmake_version=3.22.0</span><br><span class="line">libzip_version=1.8.0</span><br><span class="line">php_version=7.4.16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否为root用户</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否安装了wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装依赖包</span></span><br><span class="line">   if [ ! `yum -y install gcc-c++ libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel gd net-snmp-* sqlite-devel oniguruma-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载最新版cmake</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://github.com/Kitware/CMake/releases/download/v$&#123;cmake_version&#125;/cmake-$&#123;cmake_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">      tar -xf cmake-$&#123;cmake_version&#125;.tar.gz</span><br><span class="line">      if [ ! -d cmake-$&#123;cmake_version&#125; ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;31m error:no found cmake-$&#123;cmake_version&#125;  \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      else</span><br><span class="line">         cd cmake-$&#123;cmake_version&#125;</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:Failed to download cmake-$&#123;cmake_version&#125; \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装cmake</span></span><br><span class="line">   echo &quot;cmake configure...&quot;</span><br><span class="line">   ./configure &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">      echo &quot;cmake make &amp;&amp; make install...&quot;</span><br><span class="line">      make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">      if [ `echo $?` -eq 0 ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;32m cmake installed sucessfully \e[0m&quot;</span><br><span class="line">      else</span><br><span class="line">         echo -e &quot;\e[1;31m cmake installed failed \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:cmake configure failed \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载libzip1.1以上版本</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget --no-check-certificate https://libzip.org/download/libzip-$&#123;libzip_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar libzip...&quot;</span><br><span class="line">       tar -xf libzip-$&#123;libzip_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d libzip-$&#123;libzip_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found libzip-$&#123;libzip_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd libzip-$&#123;libzip_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download libzip-$&#123;libzip_version&#125;.tar.gz \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装libzip</span></span><br><span class="line">   mkdir build;cd build</span><br><span class="line">   echo &quot;cmake libzip...&quot;</span><br><span class="line">   cmake .. &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install libzip...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m libzip install sucessfully \e[0m&quot;</span><br><span class="line">           echo -e &#x27;/usr/local/lib64\n/usr/local/lib\n/usr/lib\n/usr/lib64&#x27;&gt;&gt; /etc/ld.so.conf</span><br><span class="line">           ldconfig -v &amp;&gt; /dev/null</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:libzip install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:lipzip cmake failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载php</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.php.net/distributions/php-$&#123;php_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar php...&quot;</span><br><span class="line">       tar -xf php-$&#123;php_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d php-$&#123;php_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found php-$&#123;php_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd php-$&#123;php_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download php-$&#123;php_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装php</span></span><br><span class="line">   echo &quot;configure php...&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">要php以apache模块运行需加上--with-apxs2=/usr/localapache/bin/apxs参数</span></span><br><span class="line">   ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-mysqli=mysqlnd --enable-pdo --with-pdo-mysql=mysqlnd --with-iconv-dir=/usr/local/ --enable-fpm --with-fpm-user=www --with-fpm-group=www --with-pcre-regex --with-zlib --with-bz2 --enable-calendar --disable-phar --with-curl --enable-dba --with-libxml-dir --enable-ftp --with-gd --with-jpeg-dir --with-png-dir --with-zlib-dir --with-freetype-dir --enable-gd-jis-conv --with-mhash --enable-mbstring --enable-opcache=yes --enable-pcntl --enable-xml --disable-rpath --enable-shmop --enable-sockets --enable-zip --enable-bcmath --with-snmp --disable-ipv6 --with-gettext --disable-rpath --disable-debug --enable-embedded-mysqli --with-mysql-sock=/var/lib/mysql/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install php...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m php install sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m php install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m configure php failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_set()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -f /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service ]</span><br><span class="line">    then</span><br><span class="line">        echo -e &quot;\e[1;31m No found php-fpm.service \e[0m&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    else</span><br><span class="line">        cp /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service /etc/systemd/system</span><br><span class="line">        if [ `echo $?` -ne 0 ]</span><br><span class="line">        then</span><br><span class="line">            echo -e &quot;\e[1;31m Copy php-fpm.service failed \e[0m&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        else</span><br><span class="line">            sed -i &#x27;/PrivateTmp=true/a\ProtectSystem=false&#x27; /etc/systemd/system/php-fpm.service</span><br><span class="line">            systemctl daemon-reload</span><br><span class="line">            echo -e &quot;\e[1;32m php set sucessfully \e[0m&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">pre</span><br><span class="line">php_install</span><br><span class="line">php_set</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置PHP</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/php/etc</span><br><span class="line">cp php-fpm.conf.default php-fpm.conf</span><br><span class="line">cp php-fpm.d/www.conf.default php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.conf</span><br><span class="line">[global]</span><br><span class="line">pid = run/php-fpm.pid</span><br><span class="line">error_log = log/php-fpm.log</span><br><span class="line">daemonize = yes</span><br><span class="line">include=/usr/local/php/etc/php-fpm.d/*.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.d/www.conf</span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line">listen.mode = 0660</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 5</span><br><span class="line">pm.start_servers = 2</span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line">pm.max_spare_servers = 3</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm</span><br></pre></td></tr></table></figure>

<h4 id="1-5-3-PHP作为Apache模块运行"><a href="#1-5-3-PHP作为Apache模块运行" class="headerlink" title="1.5.3 PHP作为Apache模块运行"></a>1.5.3 PHP作为Apache模块运行</h4><ol>
<li>在apache主配置文件中调用子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/php.con</span><br><span class="line">LoadModule php7_module modules/libphp7.so</span><br><span class="line">AddType application/x-httpd-php .php</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置虚拟主机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>写web目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;this is cqm web&#x27; &gt; /usr/local/apache/htdocs/web/index.html</span><br><span class="line">vim /usr/local/apache/htdocs/web/phpinfo.php</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/php%E4%BB%A5%E6%A8%A1%E5%9D%97%E8%BF%90%E8%A1%8C.png" alt="php以模块运行"></p>
<h4 id="1-5-4-PHP作为独立服务运行"><a href="#1-5-4-PHP作为独立服务运行" class="headerlink" title="1.5.4 PHP作为独立服务运行"></a>1.5.4 PHP作为独立服务运行</h4><p>PHP作为独立服务运行有两种模式：</p>
<ul>
<li>TCP socket模式</li>
<li>UNIX socket模式</li>
</ul>
<p><strong>TCP socket模式</strong></p>
<ol>
<li>修改<a target="_blank" rel="noopener" href="http://www.conf文件/">www.conf文件</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = 127.0.0.1:9000</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web&quot;&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">	AllowOverride None</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">	DirectoryIndex index.php index.html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">	SetHandler &quot;proxy:fcgi://127.0.0.1:9000&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在apache主配文件添加关联</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php-fpm.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置子配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/php-fpm.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">载入需要的模块</span></span><br><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</span><br></pre></td></tr></table></figure>

<p><strong>UNIX socket模式</strong></p>
<ol>
<li>修改<a target="_blank" rel="noopener" href="http://www.conf文件/">www.conf文件</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = /usr/local/php/etc/php-fpm.socket</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置虚拟主机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">        SetHandler &quot;proxy:unix:/usr/local/php/etc/php-fpm.socket|fcgi://localhost/&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-6-Apache常用模块"><a href="#1-6-Apache常用模块" class="headerlink" title="1.6 Apache常用模块"></a>1.6 Apache常用模块</h3><h4 id="1-6-1-长连接"><a href="#1-6-1-长连接" class="headerlink" title="1.6.1 长连接"></a>1.6.1 长连接</h4><p>HTTP采用TCP进行传输，是面向连接的协议，每完成一次请求就要经历以下过程：</p>
<ul>
<li>三次握手</li>
<li>发起请求</li>
<li>响应请求</li>
<li>四次挥手</li>
</ul>
<p>那么N个请求就要建立N次连接，如果希望用户能够更快的拿到数据，服务器的压力降到最低，那么靠长连接就可以解决。</p>
<p>长连接实际上就是优化了TCP连接。</p>
<p>Apache默认开启了长连接，持续时间为5秒，在httpd-default.conf中可以定义。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-default.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启长连接</span></span><br><span class="line">KeepAlive On</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">限制每个连接允许的请求数</span></span><br><span class="line">MaxKeepAliveRequests 500</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">长连接时间</span></span><br><span class="line">KeepAliveTimeout 5</span><br></pre></td></tr></table></figure>

<h4 id="1-6-2-静态缓存"><a href="#1-6-2-静态缓存" class="headerlink" title="1.6.2 静态缓存"></a>1.6.2 静态缓存</h4><p>用户每次访问网站都会将页面中的所有元素都请求一遍，全部下载后通过浏览器渲染，展示到浏览器中。但是，网站中的某些元素我们一般都是固定不变的，比如logo、框架文件等。用户每次访问都需要加载这些元素。这样做好处是保证了数据的新鲜，可是这些数据不是常变化的，很久才变化一次。每次都请求、下载浪费了用户时间和公司带宽。</p>
<p>所以我们通过静态缓存的方式，将这些不常变化的数据缓存到用户本地磁盘，用户以后再访问这些请求，直接从本地磁盘打开加载，这样的好处是加载速度快，且节约公司带宽及成本。</p>
<ol>
<li>在apache主配文件中加载缓存模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule expires_module modules/mod_expires.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle expires_module&gt;</span><br><span class="line">    #开启缓存</span><br><span class="line">    ExpiresActive on</span><br><span class="line">    #针对不同类型元素设置缓存时间</span><br><span class="line">    ExpiresByType image/gif  &quot;access plus 1 days&quot;</span><br><span class="line">    ExpiresByType image/jpeg &quot;access plus 24 hours&quot;</span><br><span class="line">    ExpiresByType image/png &quot;access plus 24 hours&quot;</span><br><span class="line">    #now 相当于 access</span><br><span class="line">    ExpiresByType text/css &quot;now plus 2 hour&quot;</span><br><span class="line">    ExpiresByType application/x-javascript &quot;now plus 2 hours&quot;</span><br><span class="line">    ExpiresByType application/x-shockwave-flash &quot;now plus 2 hours”</span><br><span class="line">    #其他数据不缓存</span><br><span class="line">    ExpiresDefault &quot;now plus 0 min&quot;</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-3-数据压缩"><a href="#1-6-3-数据压缩" class="headerlink" title="1.6.3 数据压缩"></a>1.6.3 数据压缩</h4><p>数据从服务器传输到客户端，需要传输时间，文件越大传输时间就越长，为了减少传输时间，我们一般把数据压缩后在传给客户端。</p>
<p>apache支持两种模式的压缩：</p>
<ul>
<li>default</li>
<li>gzip</li>
</ul>
<p>两者的区别：</p>
<ul>
<li>mod_deflate 压缩速度快。</li>
<li>mod_gzip 的压缩比略高。</li>
<li>一般情况下，mod_gzip 会比 mod_deflate 多出 4%~6％ 的压缩量。</li>
<li>mod_gzip 对服务器CPU的占用要高一些，所以 mod_deflate 是专门为确保服务器的性能而使用的一个压缩模块，只需较少的资源来进行压缩。</li>
</ul>
<ol>
<li>在apache主配文件中加载压缩模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule deflate_module modules/mod_deflate.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle deflate_module&gt;</span><br><span class="line">    #压缩等级1-9，数字越大压缩能力越好，相应地也越耗CPU性能</span><br><span class="line">    DeflateCompressionLevel 4</span><br><span class="line">    #压缩类型，html、xml、php、css、js</span><br><span class="line">	AddOutputFilterByType DEFLATE text/html text/plain text/xml application/x-javascript application/x-httpd-php</span><br><span class="line">	AddOutputFilter DEFLATE js css</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">浏览器匹配为IE1-6的不压缩</span></span><br><span class="line">	BrowserMatch \bMSIE\s[1-6] dont-vary</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">设置不压缩的文件</span></span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:pdf|doc)$ no-gzip dont-vary</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-4-限速"><a href="#1-6-4-限速" class="headerlink" title="1.6.4 限速"></a>1.6.4 限速</h4><p>网站除了能共享页面给用户外，还能作为下载服务器存在。但是作为下载服务器时，我们应该考虑服务器的带宽和IO的性能，防止部分邪恶分子会通过大量下载的方式来攻击你的带宽和服务器IO性能。</p>
<p>问题：</p>
<ul>
<li>假如你的服务器被邪恶分子通过下载的方式把带宽占满了，那么你或其他用户在访问的时候就会造成访问慢或者根本无法访问。</li>
<li>假如你的服务器被邪恶分子通过下载的方式把服务器IO占满了，那么你的服务器将会无法处理用户请求或宕机。</li>
</ul>
<p>以上问题可以通过限速来解决，apache自带了基于宽带限速的模块：</p>
<ul>
<li>ratelimit_module：只能对连接下载速度做限制，且是单线程的下载，迅雷等下载工具使用的是多线程下载。</li>
<li>mod_limitipconn：限制每 IP 的连接数，需要额外安装该模块。</li>
</ul>
<p><strong>ratelimit_module模块</strong></p>
<ol>
<li>在apache主配文件中加载压缩模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule ratelimit_module modules/mod_ratelimit.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Location相对路径：/usr/local/apache/htdocs/...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Directory绝对路径：...</span></span><br><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限速100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<p><strong>mod_limitipconn模块</strong></p>
<ol>
<li>下载安装模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://dominia.org/djao/limit/mod_limitipconn-0.24.tar.bz2</span><br><span class="line">tar -xf mod_limitipconn-0.24.tar.bz2</span><br><span class="line">cd mod_limitipconn-0.24</span><br><span class="line">vim Makefile</span><br><span class="line">    apxs = &quot;/usr/local/apache/bin/apxs&quot;</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在apache主配文件启用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule limitipconn_module modules/mod_limitipconn.so</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限速100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限制线程数</span></span><br><span class="line">	MaxConnPerIP 3</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">对index.html文件不作限制</span></span><br><span class="line">	NoIPLimit index.html</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-5-访问控制"><a href="#1-6-5-访问控制" class="headerlink" title="1.6.5 访问控制"></a>1.6.5 访问控制</h4><p>在生产环境中，网站分为公站和私站，公站允许所有人访问，但私站就只允许内部人员访问，Require就可以实现访问控制的功能。</p>
<p>容器：</p>
<ul>
<li>RequireAny：一个符合即可通过</li>
<li>RequireAll：所有符合才可通过</li>
<li>Requirenone：所有都不符合才可通过</li>
</ul>
<p><strong>普通的访问控制</strong></p>
<ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line">	AllowOverride None</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">拒绝所有人访问</span></span><br><span class="line">	Require all denied</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">允许该地址段的用户访问</span></span><br><span class="line">	Require ip 192.168.88</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">允许该主机访问</span></span><br><span class="line">	Require host www.cqm.com</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p><strong>用户登录验证访问控制</strong></p>
<ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义提示信息，用户访问时提示信息会出现在认证的对话框中</span></span><br><span class="line">	AuthName &quot;Private&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义认证类型，在HTTP1.0中，只有一种认证类型：basic。在HTTP1.1中有几种认证类型，如：MD5</span></span><br><span class="line">	AuthType Basic</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义包含用户名和密码的文本文件，每行一对</span></span><br><span class="line">	AuthUserFile &quot;/usr/local/apache/user.dbm&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">配合容器使用，只有条件全部符合才能通过</span></span><br><span class="line">	&lt;RequireAll&gt;</span><br><span class="line">		Require not ip 192.168.88</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　require user user1 user2 (只有用户user1和user2可以访问)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　requires <span class="built_in">groups</span> group1 (只有group1中的成员可以访问)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　require valid-user (在AuthUserFile指定的文件中的所有用户都可以访问)</span></span><br><span class="line">		Require valid-user</span><br><span class="line">	&lt;/RequireAll&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成用户文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成cqm用户</span></span><br><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/apache/user.dbm cqm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="1-6-6-URL重写"><a href="#1-6-6-URL重写" class="headerlink" title="1.6.6 URL重写"></a>1.6.6 URL重写</h4><p>Apache通过mod_rewrite模块可以实现URL重写的功能，URL重写其实就是改写用户浏览器中的URL地址。</p>
<ol>
<li>在主配文件开启模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    # 开启URL重写功能</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    # 重写规则，跳转到百度</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://www.baidu.com&quot; [NC,L]</span><br><span class="line">    # 匹配条件，根据请求头进行匹配</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;chrome&quot; [NC,OR]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;curl&quot;</span><br><span class="line">    # 重写规则，和匹配到的条件配合使用，请求头匹配到chrome或curl则返回403状态码</span><br><span class="line">    RewriteRule &quot;^/$&quot; - [F]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">RewreteRule [flag] 部分标记规则</span><br><span class="line">R:强制外部重定向</span><br><span class="line">F:禁用URL，返回403HTTP状态码</span><br><span class="line">G:强制URL为GONE，返回410HTTP状态码</span><br><span class="line">P:强制使用代理转发</span><br><span class="line">L:表明当前规则是最后一条规则，停止分析以后规则的重写</span><br><span class="line">N:重新从第一条规则开始运行重写过程</span><br><span class="line">C:与下一条规则关联</span><br><span class="line">NS:只用于不是内部子请求</span><br><span class="line">NC:不区分大小写</span><br></pre></td></tr></table></figure>

<p><strong>通过URL重写实现分流功能</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(chrome|curl)&quot; [NC,OR]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://pc.cqm.com&quot; [NC]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(iPhone|Blackberry|Android|ipad)&quot; [NC]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://phone.cqm.com&quot; [NC]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-7-压力测试"><a href="#1-6-7-压力测试" class="headerlink" title="1.6.7 压力测试"></a>1.6.7 压力测试</h4><p>Apache压力测试使用ab命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ab</span><br><span class="line">-A:指定连接服务器的基本的认证凭据</span><br><span class="line">-c:指定一次向服务器发出请求数</span><br><span class="line">-C:添加cookie</span><br><span class="line">-g:将测试结果输出为“gnuolot”文件</span><br><span class="line">-h:显示帮助信息</span><br><span class="line">-H:为请求追加一个额外的头</span><br><span class="line">-i:使用“head”请求方式</span><br><span class="line">-k:激活HTTP中的“keepAlive”特性</span><br><span class="line">-n:指定测试会话使用的请求数</span><br><span class="line">-p:指定包含数据的文件</span><br><span class="line">-q:不显示进度百分比</span><br><span class="line">-T:使用POST数据时，设置内容类型头</span><br><span class="line">-v:设置详细模式等级</span><br><span class="line">-w:以HTML表格方式打印结果</span><br><span class="line">-x:以表格方式输出时，设置表格的属性</span><br><span class="line">-X:使用指定的代理服务器发送请求</span><br><span class="line">-y:以表格方式输出时，设置表格属性</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/ab -n 10000 -c 200 http:...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">并发数</span></span><br><span class="line">per second...</span><br></pre></td></tr></table></figure>



<h2 id="二、Nginx"><a href="#二、Nginx" class="headerlink" title="二、Nginx"></a>二、Nginx</h2><h3 id="2-1-Nginx介绍"><a href="#2-1-Nginx介绍" class="headerlink" title="2.1 Nginx介绍"></a>2.1 Nginx介绍</h3><p>Nginx是一款是由俄罗斯的程序设计师Igor Sysoev所开发高性能的 Web和 反向代理服务器，也是一个 IMAP&#x2F;POP3&#x2F;SMTP 代理服务器。和apache一样，都是web服务器软件，因为其性能优异，所以被广大运维喜欢。又因为nginx是一个轻量级的web服务器，相比apache来说资源消耗更低。</p>
<p>Nginx中文文档：<a target="_blank" rel="noopener" href="https://www.nginx.cn/doc/index.html">https://www.nginx.cn/doc/index.html</a></p>
<h3 id="2-2-通过脚本源码安装Nginx"><a href="#2-2-通过脚本源码安装Nginx" class="headerlink" title="2.2 通过脚本源码安装Nginx"></a>2.2 通过脚本源码安装Nginx</h3><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">nginx_version=1.21.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检测</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检测是否为root</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检测wget是否安装</span></span><br><span class="line">   if [ ! -e /usr/bin/wget ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found command /usr/bin/wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">安装依赖</span></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">0:stdin标准输入   1:stdout标准输出   2:stderr错误输出</span></span><br><span class="line">   if [ ! `yum -y install gcc-* pcre-devel zlib-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载源码包</span></span><br><span class="line">   cd /usr/local/</span><br><span class="line">   if [ ! `wget http://nginx.org/download/nginx-$&#123;nginx_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf nginx-$&#123;nginx_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d nginx-$&#123;nginx_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found nginx-$&#123;nginx_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:wget file nginx-$&#123;nginx_version&#125;.tar.gz failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">function install_nginx()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/nginx-$&#123;nginx_version&#125;</span><br><span class="line">   echo &quot;nginx configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/nginx &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;nginx make...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m nginx install success \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:nginx install fail \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:nginx configure fail \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">install_nginx</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写启动脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Source <span class="keyword">function</span> libiary</span></span><br><span class="line">if [ -f /etc/init.d/functions ]</span><br><span class="line">then</span><br><span class="line">    . /etc/init.d/functions</span><br><span class="line">else</span><br><span class="line">    echo &quot;Not found file /etc/init.d/functions&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">nginxd=/usr/local/nginx/sbin/nginx</span><br><span class="line">nginx_pid=/usr/local/nginx/logs/nginx.pid</span><br><span class="line"></span><br><span class="line">function nginx_start()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -eq 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">nginxd</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_stop()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -gt 1 ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_status()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_restart()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_stop</span><br><span class="line">   nginx_start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_reload()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       $nginxd -s reload</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        nginx_start</span><br><span class="line">        echo -e &quot;nginx start [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        nginx_stop</span><br><span class="line">        echo -e &quot;nginx stop [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line">        nginx_status</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        nginx_restart</span><br><span class="line">        echo -e &quot;nginx restart [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">reload)</span><br><span class="line">        nginx_reload</span><br><span class="line">        echo -e &quot;nginx reload [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Nginx的Server块"><a href="#2-3-Nginx的Server块" class="headerlink" title="2.3 Nginx的Server块"></a>2.3 Nginx的Server块</h3><p>当Nginx配置文件只有一个Server块时，那么该Server块就被Nginx认为是默认网站，所有发给Nginx的请求都会传给该Server块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">监听80端口</span></span><br><span class="line">        listen       80;</span><br><span class="line">        # 域名</span><br><span class="line">        server_name  localhost;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">字符集</span></span><br><span class="line">        charset koi8-r;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">访问日志路径</span></span><br><span class="line">        access_log  logs/host.access.log  main;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">web根路径</span></span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">/代表相对路劲，这里代表/usr/local/nginx</span></span><br><span class="line">        location / &#123;</span><br><span class="line">        	# 根目录路径，这里代表/usr/local/nginx/html</span><br><span class="line">            root   html;</span><br><span class="line">            # 索引页</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">404状态码</span></span><br><span class="line">        error_page  404              /404.html;</span><br><span class="line">        location = /404.html&#123;</span><br><span class="line">        	root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        # 50x状态码</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Nginx的访问控制"><a href="#2-4-Nginx的访问控制" class="headerlink" title="2.4 Nginx的访问控制"></a>2.4 Nginx的访问控制</h3><ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    # 允许192.168.88.0/24的用户访问</span><br><span class="line">    allow 192.168.88.0/24;</span><br><span class="line">    # 拒绝所有</span><br><span class="line">    deny all;</span><br><span class="line">    # 基于客户端IP做过滤，符合条件的允许访问，不符合的返回404</span><br><span class="line">    # 这里为不是192.168.88的就返回404</span><br><span class="line">    if ( $remote_addr !~ &quot;192.168.88&quot; )&#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-Nginx的用户验证"><a href="#2-5-Nginx的用户验证" class="headerlink" title="2.5 Nginx的用户验证"></a>2.5 Nginx的用户验证</h3><ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	root   html;</span><br><span class="line">	index  index.html index.htm;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">欢迎词</span></span><br><span class="line">	auth_basic &quot;welcome to cqm&#x27;s web&quot;;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">存放用户文件</span></span><br><span class="line">	auth_basic_user_file /usr/local/nginx/htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成用户文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/nginx/htpasswd cqm</span><br></pre></td></tr></table></figure>

<h3 id="2-6-Nginx参数"><a href="#2-6-Nginx参数" class="headerlink" title="2.6 Nginx参数"></a>2.6 Nginx参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx中的log_format可以用来自定义日志格式</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">log_format变量：</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_addr:记录访问网站的客户端地址</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_user:远程客户端用户名</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">time_local:记录访问时间与时区</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request:用户的http请求起始行信息</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">status:http状态码，记录请求返回的状态码，例如：200、301、404等</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">body_bytes_sent:服务器发送给客户端的响应body字节数</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_referer:记录此次请求是从哪个连接访问过来的，可以根据该参数进行防盗链设置。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_user_agent:记录客户端访问信息，例如：浏览器、手机客户端等</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_x_forwarded_for:当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置</span></span><br></pre></td></tr></table></figure>

<h3 id="2-7-Nginx防盗链"><a href="#2-7-Nginx防盗链" class="headerlink" title="2.7 Nginx防盗链"></a>2.7 Nginx防盗链</h3><p>盗链用大白话讲就是抓取别人网站的资源，加以利用，以至于被抓取资源的网站消耗了带宽，而收益的是抓取资源的人。</p>
<p>而反盗链就可以防止别人抓取自身网站的资源。</p>
<ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    # 除了www.cqm.com之外，都返回403</span><br><span class="line">    valid_referers none blocked www.cqm.com;</span><br><span class="line">    if ($invalid_referer)&#123;</span><br><span class="line">       return 403;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-8-Nginx虚拟主机"><a href="#2-8-Nginx虚拟主机" class="headerlink" title="2.8 Nginx虚拟主机"></a>2.8 Nginx虚拟主机</h3><p>Nginx的虚拟主机是通过server块来实现的。</p>
<h4 id="2-8-1-基于IP的虚拟主机"><a href="#2-8-1-基于IP的虚拟主机" class="headerlink" title="2.8.1 基于IP的虚拟主机"></a>2.8.1 基于IP的虚拟主机</h4><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">include /usr/local/nginx/conf/conf.d/nginx_vhosts.conf;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.100;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.101;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>其它配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个逻辑网卡，重启即失效</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">mkdir /usr/local/nginx/html/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/nginx/html/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/nginx/html/web2/index.html</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.88.100/</span><br><span class="line">this is web1</span><br><span class="line">curl http://192.168.88.101/</span><br><span class="line">this is web2</span><br></pre></td></tr></table></figure>

<h4 id="2-8-2-基于端口的虚拟主机"><a href="#2-8-2-基于端口的虚拟主机" class="headerlink" title="2.8.2 基于端口的虚拟主机"></a>2.8.2 基于端口的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-8-3-基于域名的虚拟主机"><a href="#2-8-3-基于域名的虚拟主机" class="headerlink" title="2.8.3 基于域名的虚拟主机"></a>2.8.3 基于域名的虚拟主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm1.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm2.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-9-Nginx反向代理"><a href="#2-9-Nginx反向代理" class="headerlink" title="2.9 Nginx反向代理"></a>2.9 Nginx反向代理</h3><p>代理最常见的使用方式就是翻墙，能够实现让国内的用户访问国外的网站。</p>
<p>原理：</p>
<ul>
<li>用户讲请求发给代理服务器</li>
<li>代理服务器代替用户去获取数据</li>
<li>代理服务器将数据发送给用户</li>
</ul>
<p><strong>正常没有代理的上网</strong></p>
<p><img src="/2024/02/18/web/%E6%AD%A3%E5%B8%B8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="正常上网流程"></p>
<p><strong>使用代理服务器的上网</strong></p>
<p>&#x3D;<img src="/2024/02/18/web/%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="使用代理服务器上网流程"></p>
<p>代理服务器又分为两种：正向代理、反向代理</p>
<p>正向代理：代理用户向服务器获取资源</p>
<p>反向代理：代理服务器去管理网络资源，用户有请求找反向代理就可以了</p>
<ol>
<li>编写反向代理服务器主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">location / &#123;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    # 访问代理服务器就会跳转到http://192.168.88.100</span><br><span class="line">    proxy_pass http://192.168.88.100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>反向代理其它配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">client_max_body_size 10m; #允许客户端请求的最大单文件字节数</span><br><span class="line"></span><br><span class="line">client_body_buffer_size 128k; #缓冲区代理缓冲用户端请求的最大字节数，</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 90; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line"></span><br><span class="line">proxy_send_timeout 90; #后端服务器数据回传时间(代理发送超时)</span><br><span class="line"></span><br><span class="line">proxy_read_timeout 90; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line"></span><br><span class="line">proxy_buffer_size 4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line"></span><br><span class="line">proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line"></span><br><span class="line">proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line"></span><br><span class="line">proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br></pre></td></tr></table></figure>

<h3 id="2-10-Nginx下载限速"><a href="#2-10-Nginx下载限速" class="headerlink" title="2.10 Nginx下载限速"></a>2.10 Nginx下载限速</h3><p>限速方法主要分为：</p>
<ul>
<li>下载速度限制</li>
<li>单位时间内请求数限制</li>
<li>基于客户端的并发数限制</li>
</ul>
<p>Nginx官方提供的限制IP连接和并发的模块有两个：</p>
<p>limit_req_zone：用来限制单位时间内的请求数，即速率限制，采用的漏桶算法</p>
<p>limit_req_conn：来限制同一时间连接数，即并发限制</p>
<p><strong>单位时间内请求数限制</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在http快下调用模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:基于ip地址做限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:创建缓存域和缓存大小</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rate:设置访问频数</span></span><br><span class="line">limit_req_zone $binary_remote_addr zone=cqm:10m rate=1r/s;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server块</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">调用模块</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">当请求数超过5次时，就拒绝访问，并返回503状态码</span></span><br><span class="line">	limit_req zone=cqm burst=5 nodelay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>限制并发连接数</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在http快下调用模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:基于ip地址做限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:创建缓存域和缓存大小</span></span><br><span class="line">limit_req_conn $binary_remote_addr zone=cqm:10m;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server块</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">限制同一时间内下载数为1个</span></span><br><span class="line">	limit_conn cqm 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>限制下载速度</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">限制下载速度为1k</span></span><br><span class="line">	limit_rate 1k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-11-Nginx的URL重写"><a href="#2-11-Nginx的URL重写" class="headerlink" title="2.11 Nginx的URL重写"></a>2.11 Nginx的URL重写</h3><p>rewrite的主要功能是实现URL地址的重定向。Nginx的rewrite功能需要PCRE软件的支持，即通过perl兼容正则表达式语句进行规则匹配的。默认参数编译nginx就会支持rewrite的模块，但是也必须要PCRE的支持。</p>
<p>URL模板语块：</p>
<ul>
<li>set：设置变量</li>
<li>if：判断</li>
<li>return：返回值或URL</li>
<li>break：终止</li>
<li>rewrite：重定向URL</li>
</ul>
<p><strong>例一：根据不同域名跳转到主域名的不同目录下</strong></p>
<ol>
<li>创建测试目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/nginx/html/&#123;cn,jp,us&#125;</span><br><span class="line">echo &#x27;this is China&#x27; &gt; /usr/local/nginx/html/cn/index.html</span><br><span class="line">echo &#x27;this is Japan&#x27; &gt; /usr/local/nginx/html/jp/index.html</span><br><span class="line">echo &#x27;this is America&#x27; &gt; /usr/local/nginx/html/us/index.html</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改hosts文件，以便解析</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.88.100 www.cqm.com</span><br><span class="line">192.168.88.100 www.cqm.com.cn</span><br><span class="line">192.168.88.100 www.cqm.com.jp</span><br><span class="line">192.168.88.100 www.cqm.com.us</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /usr/local/nginx/conf/conf.d/rewrite.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改重定向文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置重定向server</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com.cn www.cqm.com.jp www.cqm.com.us;</span><br><span class="line">    location / &#123;</span><br><span class="line">        # 模糊匹配到cn的话，就跳转到http://www.cqm.com/cn下</span><br><span class="line">        if ($http_host ~ (cn)$)&#123;</span><br><span class="line">            set $nation cn;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (jp)$)&#123;</span><br><span class="line">            set $nation jp;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (us)$)&#123;</span><br><span class="line">            set $nation us;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://www.cqm.com.cn</span><br><span class="line">this is China</span><br><span class="line">curl -L http://www.cqm.com.jp</span><br><span class="line">this is Japan</span><br><span class="line">curl -L http://www.cqm.com.us</span><br><span class="line">this is America</span><br><span class="line">-L:自动获取重定向</span><br></pre></td></tr></table></figure>

<p><strong>例二：retuen以及break的简单实用</strong></p>
<ol>
<li>修改重定向文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">        # 模糊匹配 ~</span><br><span class="line">        # 精确匹配 =</span><br><span class="line">        # 不匹配 !~</span><br><span class="line">        # 如果匹配请求头不是chrome的话，就返回403</span><br><span class="line">        if ($http_user_agent !~ &#x27;chrome&#x27;)&#123;</span><br><span class="line">            return 403;</span><br><span class="line">            # break放在return上面的话就不会执行return操作</span><br><span class="line">            # break;</span><br><span class="line">            # return http://www.baidu.com;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>flag</strong></p>
<p>flag是放在rewrite重定向的URL后边的，格式为：rewrite URL flag</p>
<p>flag的选项有：</p>
<ol>
<li>last：本条规则匹配完成后继续执行到最后。</li>
<li>break：本条规则匹配完成即终止。</li>
<li>redirect：返回302临时重定向。</li>
<li>permanent：返回301永久重定向。</li>
</ol>
<p>redirect和permanent的区别：设置permanent的话，新网址就会完全继承旧网址，旧网址的排名等完全清零，如果不是暂时迁移的情况下都建议使用permanent；设置redirect的话，新网址对旧网址没有影响，且新网址也不会有排名。</p>
<h3 id="2-12-Nginx优化"><a href="#2-12-Nginx优化" class="headerlink" title="2.12 Nginx优化"></a>2.12 Nginx优化</h3><h4 id="2-12-1-大并发"><a href="#2-12-1-大并发" class="headerlink" title="2.12.1 大并发"></a>2.12.1 大并发</h4><p>Nginx的工作模式：主进程 + 工作进程</p>
<p>假如Nginx服务器有4个CPU</p>
<ol>
<li>设置主配文件来实现高并发</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">worker_processes  4;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定运行的核的编号，采用掩码的方式设置编号</span></span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br><span class="line">events &#123;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">单个工作进程维护的请求队列长度，根据实际情况调整</span></span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-2-长连接"><a href="#2-12-2-长连接" class="headerlink" title="2.12.2 长连接"></a>2.12.2 长连接</h4><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">keepalive_timeout用来设置长连接，0代表关闭</span></span><br><span class="line">keepalive_timeout  0;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置长连接时间100s</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_timeout  100;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置每秒可以接受的请求数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_requests 8192;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-12-3-压缩"><a href="#2-12-3-压缩" class="headerlink" title="2.12.3 压缩"></a>2.12.3 压缩</h4><p>Nginx是采用gzip进行压缩。</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启缓存</span></span><br><span class="line">gzip on;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginx做为反向代理的时候启用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">off:关闭所有的代理结果数据压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">expired:如果header中包含”Expires”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-cache:如果header中包含”Cache-Control:no-cache”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-store:如果header中包含”Cache-Control:no-store”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">private:如果header中包含”Cache-Control:private”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_last_modified:启用压缩，如果header中包含”Last_Modified”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_etag:启用压缩，如果header中包含“ETag”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">auth:启用压缩，如果header中包含“Authorization”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">any:无条件压缩所有结果数据</span></span><br><span class="line">gzip_proxied any;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span><br><span class="line">gzip_min_length 1k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置压缩所需要的缓冲区大小</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">32 4K表示按照内存页（one memory page）大小以4K为单位（即一个系统中内存页为4K），申请32倍的内存空间</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建议此项不设置，使用默认值</span></span><br><span class="line">gzip_buffers 32 4k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置gzip压缩级别，级别越底压缩速度越快文件压缩比越小，反之速度越慢文件压缩比越大</span></span><br><span class="line">gzip_comp_level 1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于识别http协议的版本，早期的浏览器不支持gzip压缩，用户会看到乱码，所以为了支持前期版本加了此选项。默认在http/1.0的协议下不开启gzip压缩</span></span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置需要压缩的MIME类型,如果不在设置类型范围内的请求不进行压缩</span></span><br><span class="line">gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-4-静态缓存"><a href="#2-12-4-静态缓存" class="headerlink" title="2.12.4 静态缓存"></a>2.12.4 静态缓存</h4><p>将部分数据缓存在用户本地磁盘，用户加载时，如果本地和服务器的数据一致，则从本地加载。提升用户访问速度，提升体验度。节省公司带宽成本。</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模糊匹配以png或gif结尾的文件</span></span><br><span class="line">location ~*  \.(png|gif)$ &#123;</span><br><span class="line">    # 缓存时间为1小时</span><br><span class="line">    expires 1h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="三、Tomcat"><a href="#三、Tomcat" class="headerlink" title="三、Tomcat"></a>三、Tomcat</h2><h3 id="3-1-Tomcat介绍"><a href="#3-1-Tomcat介绍" class="headerlink" title="3.1 Tomcat介绍"></a>3.1 Tomcat介绍</h3><p>Tomcat 服务器是一个免费的开放源代码的 Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试 JSP 程序的首选。</p>
<p>实际上 Tomcat 是 Apache 服务器的扩展，但运行时它是独立运行的，所以当你运行 tomcat 时，它实际上作为一个与 Apache 独立的进程单独运行的。</p>
<p>Tomcat 官方文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/">https://tomcat.apache.org/</a></p>
<h3 id="3-2-Tomcat安装"><a href="#3-2-Tomcat安装" class="headerlink" title="3.2 Tomcat安装"></a>3.2 Tomcat安装</h3><ol>
<li>安装jdk和tomcat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk*</span><br><span class="line">wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.43/bin/apache-tomcat-9.0.43.tar.gz</span><br><span class="line">tar -xf apache-tomcat-9.0.43.tar.gz</span><br><span class="line">mkdir /root/tomcat</span><br><span class="line">mv apache-tomcat-9.0.43.tar.gz/* /root/tomcat</span><br><span class="line">./root/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:01:00.205Z" title="2/18/2024, 7:01:00 PM">2024-02-18</time></span><span class="level-item">28 minutes read (About 4127 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/redis/">Redis</a></p><div class="content"><h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>REmote DIctionary Server（Redis）是一个由 Salvatore Sanfilippo 写的 key-value 存储系统，是跨平台的非关系型数据库。</p>
<p><img src="/2024/02/18/redis/redis_logo.jpeg" alt="redis_logo"></p>
<p>Redis 就是一款 NoSQL，而 NoSQL 就是指非关系型数据库，主要分为四种：</p>
<ol>
<li>键值型：Redis</li>
<li>文档型：ElasticSearch、Mongdb</li>
<li>面向列：Hbase</li>
<li>图形化：Neo4j</li>
</ol>
<h2 id="二、Redis基础"><a href="#二、Redis基础" class="headerlink" title="二、Redis基础"></a>二、Redis基础</h2><h3 id="2-1-Redis安装"><a href="#2-1-Redis安装" class="headerlink" title="2.1 Redis安装"></a>2.1 Redis安装</h3><ol>
<li>通过 docker-compose 安装 redis</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入容器内部测试 redis</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接redis</span></span><br><span class="line">redis-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span>新建键值对</span></span><br><span class="line">set key value</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get获取键值</span></span><br><span class="line">get key</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Redis常用命令"><a href="#2-2-Redis常用命令" class="headerlink" title="2.2 Redis常用命令"></a>2.2 Redis常用命令</h3><p>redis 的数据存储结构有以下几种：</p>
<ul>
<li>key-string（字符串）：一个 key 对应一个值</li>
<li>key-hash（哈希）：一个 key 对应一个 map</li>
<li>key-list（列表）：一个 key 对应一个列表</li>
<li>key-set（集合）：一个 key 对应一个集合</li>
<li>key-zset（有序集合）：一个 key 对应一个有序的集合</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%80.png" alt="redis一"></p>
<h4 id="2-2-1-string常用命令"><a href="#2-2-1-string常用命令" class="headerlink" title="2.2.1 string常用命令"></a>2.2.1 string常用命令</h4><ol>
<li>设置值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set key value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>取值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>批量操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mset key1 value1 key2 value2 ...</span><br><span class="line">mget key1 key2 ... </span><br></pre></td></tr></table></figure>

<ol start="4">
<li>自增</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incr key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>自减</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decr key</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>自增自减指定数量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">incrby key number</span><br><span class="line">decrby key number</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>设置值的同时指定生存时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key seconds value</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>设置值，如果当前 key 不存在如同 set，如果存在则说明都不做</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key value</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>在 key 对应的 value 后追加内容</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key value</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>查看 value 字符串长度</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-hash常用命令"><a href="#2-2-2-hash常用命令" class="headerlink" title="2.2.2 hash常用命令"></a>2.2.2 hash常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hset key field value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hget key field</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>批量操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hmset key1 field1 value1 field2 value2 ...</span><br><span class="line">hmget key1 firle1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>指定自增</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hincrby key field number</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>设置值，如果当前 key 不存在如同 set，如果存在则说明都不做</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hsetnx key field value</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>检查 field 是否存在</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexists key field</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>删除某个 field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdel key field1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>获取当前 hash 结构中的全部 field 和 value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgetall key</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>获取当前 hash 结构中的全部 field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hkeys key</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>获取当前 hash 结构中的全部 value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hvals key</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>获取当前 hash 中 field 的数量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-list常用命令"><a href="#2-2-3-list常用命令" class="headerlink" title="2.2.3 list常用命令"></a>2.2.3 list常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从左侧插入数据</span></span><br><span class="line">lpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从右侧插入数据</span></span><br><span class="line">rpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果key不存在，什么都不做，如果key存在但不是list结构，也什么都不做</span></span><br><span class="line">lpushx key value1 value2 ...</span><br><span class="line">rpushx key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过索引位置添加value</span></span><br><span class="line">lset key index value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">左侧弹出数据并移除</span></span><br><span class="line">lpop key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">右侧弹出数据并移除</span></span><br><span class="line">rpop key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取一定范围的数据，start从0开始，stop为-1时为最后一个value，-2时为倒数第二个value</span></span><br><span class="line">lrange key start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据索引位置获取value</span></span><br><span class="line">lindex key index</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取整个list的长度</span></span><br><span class="line">llen key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除list中count个value的值，当count&gt;0，从左向右删除，但count&lt;0，从右向左删除，但count==0，全部删除</span></span><br><span class="line">lrem key count value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保留列表中指定范围内的数据，超出这个范围的都会被移除</span></span><br><span class="line">ltrim start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将list1中的最后一个数据弹出，插入到list2中的第一个位置</span></span><br><span class="line">rpoplpush key1 key2</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-set常用命令"><a href="#2-2-4-set常用命令" class="headerlink" title="2.2.4 set常用命令"></a>2.2.4 set常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">value不允许重复，且数据无序排列</span></span><br><span class="line">sadd key value1 value2 ...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取全部数据</span></span><br><span class="line">smembers key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">随机获取数据，并移除，可加弹出数量</span></span><br><span class="line">spop key number</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的交集</span></span><br><span class="line">sinter key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的并集</span></span><br><span class="line">sunion key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的差集</span></span><br><span class="line">sdiff key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前<span class="built_in">set</span>是否包含某个值</span></span><br><span class="line">sismember key value</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5-zset常用命令"><a href="#2-2-5-zset常用命令" class="headerlink" title="2.2.5 zset常用命令"></a>2.2.5 zset常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">score必须是数值，value不允许重复</span></span><br><span class="line">zadd key score1 value1 score2 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改score，如果value存在则增加分数，如果不存在则相当于zadd</span></span><br><span class="line">zincrby key number value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看指定value的分数</span></span><br><span class="line">zscore key value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取value数量</span></span><br><span class="line">zcard key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据score范围查询value数量</span></span><br><span class="line">zcount key min max</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据分数从小到大排序，获取指定范围内的数据，添加了withscores参数会返回value的具体score</span></span><br><span class="line">zrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从大到小</span></span><br><span class="line">zrevrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据分数的范围获取数据，如果不希望包括min和max的值可以用(min max)的方式，最大最小值用±inf表示</span></span><br><span class="line">zrangebyscore key min max withscores [limit,offset,count]</span><br><span class="line">zrevrangebyscore key max min withscores [limit,offset,count]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-6-key常用命令"><a href="#2-2-6-key常用命令" class="headerlink" title="2.2.6 key常用命令"></a>2.2.6 key常用命令</h4><ol>
<li>查看所有key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看某个key是否存在</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del key</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>设置key的生存时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位为s</span></span><br><span class="line">expire key seconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位为ms</span></span><br><span class="line">pexpire key milliseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定生存到某个时间点</span></span><br><span class="line">expireat key timestamp</span><br><span class="line">pexpireat key millseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看key的剩余生存时间，返回-2则key不存在，-1则没设置生存时间</span></span><br><span class="line">ttl key</span><br><span class="line">pttl key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除生存时间</span></span><br><span class="line">persist key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>选择操作的库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis默认有16个库</span></span><br><span class="line">select 0~15</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动key到另一个库中</span></span><br><span class="line">move key db</span><br></pre></td></tr></table></figure>

<h4 id="2-2-7-库的常用命令"><a href="#2-2-7-库的常用命令" class="headerlink" title="2.2.7 库的常用命令"></a>2.2.7 库的常用命令</h4><ol>
<li>清空当前所在数据库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdb</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>清空所有数据库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdball</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看当前库有多少key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbsize</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>查看最后一次操作的时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lastsave</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>实时监控redis接收到的命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monitor</span><br></pre></td></tr></table></figure>



<h2 id="三、Redis配置"><a href="#三、Redis配置" class="headerlink" title="三、Redis配置"></a>三、Redis配置</h2><h3 id="3-1-Redis的AUTH"><a href="#3-1-Redis的AUTH" class="headerlink" title="3.1 Redis的AUTH"></a>3.1 Redis的AUTH</h3><ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置 Redis 连接密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">requirepass toortoor</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入 Redis 之后都需要输入密码才可以创建 key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">auth toortoor</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Redis的事务"><a href="#3-2-Redis的事务" class="headerlink" title="3.2 Redis的事务"></a>3.2 Redis的事务</h3><p>Redis 事务可以一次执行多个命令， 并且带有以下三个重要的保证：</p>
<ul>
<li>批量操作在发送 EXEC 命令前被放入队列缓存</li>
<li>收到 EXEC 命令后进入事务执行，事务中任意命令执行失败，其余的命令依然被执行</li>
<li>在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中</li>
</ul>
<p>一个事务从开始到执行会经历以下几个阶段：</p>
<ul>
<li>开始事务：multi</li>
<li>命令入队：……</li>
<li>执行事务：exec</li>
<li>取消事务：discard</li>
<li>监听：在开启事务之前，先通过 watch 监听事务中要操作的 key，如果在事务过程中有其他的客户端修改了 key，那么事务将会被取消</li>
</ul>
<p>事务可以理解为一个打包的批量执行脚本，但批量指令并非原子化的操作，中间某条指令的失败不会导致前面已做指令的回滚，也不会造成后续的指令不做。</p>
<ol>
<li>监听</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch name age gander</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>开始事务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>命令入队</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line">set gander male</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>执行事务&#x2F;取消事务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec/discard</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Redis的持久化"><a href="#3-3-Redis的持久化" class="headerlink" title="3.3 Redis的持久化"></a>3.3 Redis的持久化</h3><h4 id="3-3-1-RDB持久化"><a href="#3-3-1-RDB持久化" class="headerlink" title="3.3.1 RDB持久化"></a>3.3.1 RDB持久化</h4><p>Redis 的配置文件位于 Redis 安装目录,	ROB 是默认的持久化机制。</p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="comment"># 加载redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis.conf</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">redis.conf</span></span><br><span class="line"><span class="comment"># 在900秒内有1一个 key 发生了变化，就执行 RDB 持久化</span></span><br><span class="line"><span class="string">save</span> <span class="number">900</span> <span class="number">1</span></span><br><span class="line"><span class="string">save</span> <span class="number">300</span> <span class="number">10</span></span><br><span class="line"><span class="string">save</span> <span class="number">60</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># 开启RDB持久化</span></span><br><span class="line"><span class="string">rdbchecksum</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># RDB持久化名称</span></span><br><span class="line"><span class="string">dbfilename</span> <span class="string">dump.rdb</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试持久化</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭redis并保存</span></span><br><span class="line">shutdown save</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>可以看到 data 目录下多了个 rdb 文件，即使 redis 容器重启也不会造成 key 的丢失</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%8C.png" alt="redis二"></p>
<h4 id="3-3-2-AOF持久化"><a href="#3-3-2-AOF持久化" class="headerlink" title="3.3.2 AOF持久化"></a>3.3.2 AOF持久化</h4><p>AOF 比起 RDB 有更高的数据安全性，如果同时开启了 AOF 和 RDB，那么前者比后者的优先级更高，且如果先开启了 RDB 在开启 AOF，那么 RDB 中的内容会被 AOF 的内容覆盖。</p>
<ol>
<li>redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启AOF持久化</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF文件名</span></span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF持久化执行策略</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">always:每次执行写操作都调用fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">everysec:最多每秒调用一次fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no:根据环境的不同在不确定的时间调用fsync</span></span><br><span class="line">appendfsync always|everysec|no</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>重启 docker-compose 测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set gander male</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不RDB持久化</span></span><br><span class="line">shutdown nosave</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到 data 目录下多了个 aof 文件，即 AOF 持久化生成的文件</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%B8%89.png" alt="redis三"></p>
<h3 id="3-4-Redis主从架构"><a href="#3-4-Redis主从架构" class="headerlink" title="3.4 Redis主从架构"></a>3.4 Redis主从架构</h3><p>Redis 的主从架构是指 Master 节点负责写操作，而其余的 Slave 节点负责读操作。</p>
<p><img src="/2024/02/18/redis/redis%E5%9B%9B.png" alt="redis四"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="comment"># 连接redis-master容器，并将该容器ip地址映射为master</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>从节点 redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slaveof &lt;主节点地址&gt; &lt;端口&gt;</span></span><br><span class="line">slaveof master 6379</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动后进入容器内部通过 <code>info</code> 可看到节点信息</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%94.png" alt="redis五"></p>
<h3 id="3-5-Redis哨兵模式"><a href="#3-5-Redis哨兵模式" class="headerlink" title="3.5 Redis哨兵模式"></a>3.5 Redis哨兵模式</h3><p>Redis 的主从架构有一个很明显的问题，就是当 Master 节点出现问题宕机后，那么 Redis 集群就没有可以进行写操作的 Redis 了，而哨兵就可以解决该问题。</p>
<p>在每个节点中都会有个哨兵与 Redis 进行连接，且哨兵与哨兵之间也会进行连接，如果 Master 节点出现故障宕机了，那么哨兵们就会选出一个 Slave 来作为新的 Master 来提供写的操作。</p>
<p><img src="/2024/02/18/redis/redis%E5%85%AD.png" alt="redis六"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel1.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel2.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel3.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Master 节点 sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以守护进程的方式运行redis</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定Master节点，sentinel monitor &lt;名称&gt; &lt;ip&gt; &lt;端口&gt; &lt;Slave个数&gt;</span></span><br><span class="line">sentinel monitor master localhost 6379 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定哨兵每隔多久检测一次redis主从架构</span></span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Slave 节点 sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">sentinel monitor master master 6379 2</span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>进入容器启动哨兵，当 Master 节点出现问题后，就会在两个 Slave 中选出一个作为新的 Master，而旧的 Master 启动后就会变为新的 Slave</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel /data/sentinel.conf</span><br></pre></td></tr></table></figure>

<h3 id="3-6-Redis集群"><a href="#3-6-Redis集群" class="headerlink" title="3.6 Redis集群"></a>3.6 Redis集群</h3><p>Redis 集群在保证主从和哨兵的基本功能之外，还能提高 Redis 存储数据的能力，主要的特点如下</p>
<ul>
<li>Redis 集群是无中心的</li>
<li>Redis 集群有ping-pang的机制</li>
<li>投票机制，集群节点的数量必须是 2n+1</li>
<li>分配了 16484 个 hash 槽，在存储数据时，会对 key 进行 crc16 的算法，并对 16384 进行取余，通过结果分配到对应的节点上，每个节点都有自己维护的 hash 槽</li>
<li>每个主节点都要跟一个从节点，但这里的从节点只管备份，不管查询</li>
<li>集群中半数的节点宕机后，那么集群就瘫痪</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%83.png" alt="redis七"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17001</span><span class="string">:17001</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17002</span><span class="string">:17002</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis3:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17003</span><span class="string">:17003</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis4:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis4</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7004</span><span class="string">:7004</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17004</span><span class="string">:17004</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis4.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis5:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis5</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7005</span><span class="string">:7005</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17005</span><span class="string">:17005</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis5.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis6:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7006</span><span class="string">:7006</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17006</span><span class="string">:17006</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis6.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis{1..6}.conf，x 为 {1..6}</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定redis端口</span></span><br><span class="line"><span class="string">port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line"><span class="string">cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># 集群信息文件</span></span><br><span class="line"><span class="string">cluster-config-file</span> <span class="string">nodes-700x.conf</span></span><br><span class="line"><span class="comment"># 集群对外ip</span></span><br><span class="line"><span class="string">cluster-announce-ip</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.135</span></span><br><span class="line"><span class="comment"># 集群对外端口</span></span><br><span class="line"><span class="string">cluster-announce-port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># 集群总线端口</span></span><br><span class="line"><span class="string">cluster-announce-bus-port</span> <span class="string">1700x</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入任意 reids 容器创建集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--cluster-replicas:每个主节点分配的从节点个数</span></span><br><span class="line">redis-cli --cluster create 192.168.88.135:7001 192.168.88.135:7002 192.168.88.135:7003 192.168.88.135:7004 192.168.88.135:7005 192.168.88.135:7006 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>由于每个主节点都被分配了不同的 hash 槽，所以要在容器内任意切换不同的 redis 节点需要加参数 <code>-c</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.88.135 -p 7001 -c</span><br></pre></td></tr></table></figure>



<h2 id="四、Redis常见问题"><a href="#四、Redis常见问题" class="headerlink" title="四、Redis常见问题"></a>四、Redis常见问题</h2><h3 id="4-1-Redis的删除策略"><a href="#4-1-Redis的删除策略" class="headerlink" title="4.1 Redis的删除策略"></a>4.1 Redis的删除策略</h3><p>当 key 的生存时间到了，Redis 并不会立即删除该 key，而是遵守以下删除策略来进行删除</p>
<ul>
<li>定期删除：Redis 每隔一段时间就回去查看设置了生存时间的 key，默认是 100ms 查看 3 个 key</li>
<li>惰性删除：当用户去查询已经超过了生存时间的 key，Redis 会先查看该 key 是否已经超过了生存时间，如果超过，那么 Redis 会将该 key 删除并给用户返回一个空值</li>
</ul>
<h3 id="4-2-Redis的淘汰机制"><a href="#4-2-Redis的淘汰机制" class="headerlink" title="4.2 Redis的淘汰机制"></a>4.2 Redis的淘汰机制</h3><p>当 Redis 内存满的时候添加了一个新的数据，那么就会执行 Redis 的淘汰机制，通过 <code>maxmemory-policy</code> 来设置，参数如下</p>
<ol>
<li><p>volatile-lru：当内存不足时，会删除一个设置了生存时间且最近最少使用的 key</p>
</li>
<li><p>allkeys-lru：当内存不足时，会删除一个设置了最近最少使用的 key</p>
</li>
<li><p>volatile-lfu：当内存不足时，会删除一个设置了生存时间且最近使用频率最低的 key</p>
</li>
<li><p>allkeys-lfu：当内存不足时，会删除一个设置了最近使用频率最低的 key</p>
</li>
<li><p>volatile-random：当内存不足时，会随机删除一个设置了生存时间的 key</p>
</li>
<li><p>allkeys-random：当内存不足时，会随机删除一个 key</p>
</li>
<li><p>volatile-ttl：当内存不足时，会删除一个生存时间最少的 key</p>
</li>
<li><p>noeviction：内存不足时，直接报错</p>
</li>
</ol>
<h3 id="4-3-缓存问题"><a href="#4-3-缓存问题" class="headerlink" title="4.3 缓存问题"></a>4.3 缓存问题</h3><p><strong>缓存穿透</strong></p>
<p>当客户查询的数据 Redis 中没有，数据库中也没有，且请求量特别大时，就会导致数据库的压力过大，解决方法如下</p>
<ul>
<li>根据 id 查询时，如果 id 是自增的，那么可以将最大的 id 放到 Reids 中，当查询数据时直接对比 id 即可</li>
<li>如果 id 不是 int 型，那么可以将全部的 id 放入 set 中，用户查询之前可以先到 set 查看是否有该 id</li>
<li>获取用户的 ip 地址，对该地址进行访问限制</li>
</ul>
<p><strong>缓存击穿</strong></p>
<p>当用户查询的是热点数据时，那么并发量肯定是很高的，当 Redis 中的热点数据过期了，那么数据库的压力就会很大，甚至宕机，解决方法如下</p>
<ul>
<li>在访问热点数据时，缓存中没有的时候，可以添加一把锁，让几个请求去访问数据库，避免数据库宕机</li>
<li>把热点数据的生存时间去掉</li>
</ul>
<p><strong>缓存雪崩</strong></p>
<p>当大量缓存同时到期时，导致请求都去到了数据库，也很容易导致数据库宕机，解决方法如下</p>
<ul>
<li>对缓存中的数据设置一个随机的生存时间，避免同时过期</li>
</ul>
<p><strong>缓存倾斜</strong></p>
<p>如果将热点数据放在集群中的某一 Redis 节点上时，那么大量的数据都会去到该 Redis 节点，导致节点宕机，解决方法如下</p>
<ul>
<li>主从架构，准备大量的从节点</li>
<li>在 Tomcat 中做 JVM 缓存，在查询 Redis 前先查询 JVM 缓存</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:00:41.990Z" title="2/18/2024, 7:00:41 PM">2024-02-18</time></span><span class="level-item">31 minutes read (About 4642 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/prometheus/">Prometheus</a></p><div class="content"><p><img src="/prometheus_logo.png" alt="prometheus_logo"></p>
<p>Prometheus是一个开源的<strong>云原生</strong>监控系统和时间序列数据库。</p>
<h2 id="一、Prometheus概述"><a href="#一、Prometheus概述" class="headerlink" title="一、Prometheus概述"></a>一、Prometheus概述</h2><p>Prometheus 作为新一代的云原生监控系统，目前已经有超过 650+位贡献者参与到 Prometheus 的研发工作上，并且超过 120+项的第三方集成。</p>
<h3 id="1-1-Prometheus的优点"><a href="#1-1-Prometheus的优点" class="headerlink" title="1.1 Prometheus的优点"></a>1.1 Prometheus的优点</h3><ol>
<li><strong>提供多维度数据模型和灵活的查询方式</strong>，通过将监控指标关联多个 tag，来将监控数据进行任意维度的组合，并且提供简单的 PromQL 查询方式，还提供 HTTP 查询接口，可以很方便地结合 Grafana 等 GUI 组件展示数据。</li>
<li>在不依赖外部存储的情况下，<strong>支持服务器节点的本地存储</strong>，通过 Prometheus 自带的时序数据库，可以完成每秒千万级的数据存储；不仅如此，在保存大量历史数据的场景中，Prometheus 可以对接第三方时序数据库和 OpenTSDB 等。</li>
<li><strong>定义了开放指标数据标准</strong>，以基于 HTTP 的 Pull 方式采集时序数据，只有实现了 Prometheus 监控数据才可以被 Prometheus 采集、汇总、并支持 Push 方式向中间网关推送时序列数据，能更加灵活地应对多种监控场景。</li>
<li><strong>支持通过静态文件配置和动态发现机制发现监控对象，自动完成数据采集</strong>。</li>
<li>Prometheus 目前已经支持 Kubernetes、etcd、Consul 等多种服务发现机制。<strong>易于维护</strong>，可以通过二进制文件直接启动，并且提供了容器化部署镜像。</li>
<li><strong>支持数据的分区采样和联邦部署，支持大规模集群监控。</strong></li>
</ol>
<h3 id="1-2-Prometheus基本组件"><a href="#1-2-Prometheus基本组件" class="headerlink" title="1.2 Prometheus基本组件"></a>1.2 Prometheus基本组件</h3><ol>
<li>Prometheus Server：是 Prometheus 组件中的核心部分，负责实现对监控数据的获取，存储以及查询。收集到的数据统称为<strong>metrics</strong>。</li>
<li>Push Gateway：当网络需求无法直接满足时，就可以利用 Push Gateway 来进行中转。可以通过 Push Gateway 将内部网络的监控数据主动 <strong>Push</strong> 到 Gateway 当中。而 Prometheus Server 则可以采用同样 <strong>Pull</strong> 的方式从 Push Gateway 中获取到监控数据。</li>
<li>Exporter：主要用来采集数据，并通过 HTTP 服务的形式暴露给 Prometheus Server，Prometheus Server 通过访问该 Exporter 提供的接口，即可获取到需要采集的监控数据。</li>
<li>Alert manager：管理告警，主要是负责实现报警功能。现在grafana也能实现报警功能，所以也慢慢被取代。</li>
</ol>
<p><img src="/2024/02/18/prometheus/Prometheus%E6%9E%B6%E6%9E%84.png" alt="Prometheus架构"></p>
<h3 id="1-3-Prometheus数据类型"><a href="#1-3-Prometheus数据类型" class="headerlink" title="1.3 Prometheus数据类型"></a>1.3 Prometheus数据类型</h3><ol>
<li>Counter（计数器类型）：Counter类型的指标的工作方式和计数器一样，只增不减（除非系统发生了重置）。</li>
<li>Gauge（仪表盘类型）：Gauge是可增可减的指标类，可以用于反应当前应用的状态。</li>
<li>Histogram（直方图类型）：主要用于表示一段时间范围内对数据进行采样（通常是请求持续时间或响应大小），并能够对其指定区间以及总数进行统计，通常它采集的数据展示为直方图。</li>
<li>Summary（摘要类型）：主要用于表示一段时间内数据采样结果（通常是请求持续时间或响应大小）。</li>
</ol>
<h2 id="二、Prometheus安装"><a href="#二、Prometheus安装" class="headerlink" title="二、Prometheus安装"></a>二、Prometheus安装</h2><h3 id="2-1-Prometheus-server安装"><a href="#2-1-Prometheus-server安装" class="headerlink" title="2.1 Prometheus server安装"></a>2.1 Prometheus server安装</h3><ol>
<li>Prometheus安装较为简单，下载解压即可</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.26.0-rc.0/prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.26.0-rc.0.linux-amd64 prometheus</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>prometheus.yml配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> <span class="comment"># 设置抓取间隔，默认为1分钟</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># 估算规则的默认周期，每15秒计算一次规则，默认1分钟</span></span><br><span class="line">  <span class="comment"># scrape_timeout # 默认抓取超时，默认为10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报警配置</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则文件列表，使用&#x27;evaluation_interval&#x27; 参数去抓取</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置列表</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># 任务名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="comment"># 要被监控的客户端</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建Prometheus的用户及数据存储目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd prometheus</span><br><span class="line">useradd -g prometheus -s /sbin/nologin prometheus</span><br><span class="line">mkdir /root/prometheus/data</span><br><span class="line">chown -R prometheus:prometheus /root/prometheus</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Prometheus的启动很简单，只需要直接启动解压目录的二进制文件Prometheus即可，但是为了更加方便对Prometheus进行管理，这里编写脚本或者使用screen工具来进行启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /root/prometheus/start.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">prometheus_dir=/root/prometheus</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;prometheus_dir&#125;/prometheus --config.file=<span class="variable">$&#123;prometheus_dir&#125;</span>/prometheus.yml --storage.tsdb.path=<span class="variable">$&#123;prometheus_dir&#125;</span>/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--config.file:指定配置文件路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.path:指定tsdb路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.retention.time:指定数据存储时间</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--web.enable-lifecycle:类似nginx的reload功能</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.no-lockfile:如果用k8s的deployment管理需加此项</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动Prometheus后访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">nohup</span>英文全称no hang up（不挂起），用于在系统后台不挂断地运行命令，退出终端不会影响程序的运行。</span></span><br><span class="line">nohup sh start.sh 2&gt;&amp;1 &gt; prometheus.log</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/Prometheus%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="Prometheus安装一"></p>
<ol start="6">
<li>用screen工具进行启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入后台</span></span><br><span class="line">screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行脚本</span></span><br><span class="line">/root/prometheus/prometheus --config.file=/root/prometheus/prometheus.yml --storage.tsdb.path=/root/prometheus/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入CTRL + A + D撤回前台</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看后台运行的脚本</span></span><br><span class="line">screen -ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回后台</span></span><br><span class="line">screen -r 后台id</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除后台</span></span><br><span class="line">screen -S 后台id -X quit</span><br></pre></td></tr></table></figure>

<h3 id="2-2-node-exporter安装"><a href="#2-2-node-exporter安装" class="headerlink" title="2.2 node exporter安装"></a>2.2 node exporter安装</h3><p>在Prometheus架构中，exporter是负责收集数据并将信息汇报给Prometheus Server的组件。官方提供了node_exporter内置了对主机系统的基础监控。</p>
<ol>
<li>下载node exporter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">tar -xf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">mv node_exporter-1.1.2.linux-amd64.tar.gz node_exporter</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在prometheus.yml中添加被监控主机</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>,<span class="string">&#x27;localhost:9100&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>后台启动exporter和重启prometheus</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过curl命令获取收集到的数据key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9100/metrics</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>用其中的一个key在Prometheus测试是否被监控</li>
</ol>
<p><img src="/2024/02/18/prometheus/node_exporter%E6%B5%8B%E8%AF%95.png" alt="node_exporter测试"></p>
<h2 id="三、Prometheus命令行的使用"><a href="#三、Prometheus命令行的使用" class="headerlink" title="三、Prometheus命令行的使用"></a>三、Prometheus命令行的使用</h2><h3 id="3-1-计算cpu使用率"><a href="#3-1-计算cpu使用率" class="headerlink" title="3.1 计算cpu使用率"></a>3.1 计算cpu使用率</h3><p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png" alt="计算cpu使用率一"></p>
<p>通过上图可以知道，linux的cpu使用是分为很多种状态的，例如用户态user，空闲态idle。</p>
<p>要计算cpu的使用率有两种粗略的公式：</p>
<ol>
<li>除去idle状态的所有cpu状态时间之和 &#x2F; cpu时间总和</li>
<li>100% - （idle状态 &#x2F; cpu时间总和）</li>
</ol>
<p>但这两种方式都存在两个问题：</p>
<ol>
<li>如何计算某一时间段的cpu使用率？例如精确到每一分钟。</li>
<li>实际工作中cpu大多数都是多核的，node exporter截取到的数据精确到了每个核，如何监控所有核加起来的数据？</li>
</ol>
<p>Prometheus提供了许多的函数，其中 increase 和 sum 就很好的解决了以上两个问题。</p>
<ol>
<li>提取cpu的key，即node_cpu_seconds_total</li>
<li>把idle空闲时间和总时间过滤出来，在Prometheus中使用{}进行过滤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用increase函数取一分钟内的增量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用sum函数将每个核的数整合起来</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m]))</span><br></pre></td></tr></table></figure>

<p>到这里又出现一个问题，sum函数会将所有数据整合起来，不光将一台机器的所有cpu加到一起，也将所有机器的cpu都加到了一起，最终显示的是集群cpu的总平均值，by(instance)可以解决这个问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)</span><br></pre></td></tr></table></figure>

<p>这样就得到了空闲时cpu的数据了，用上边第一个公式即可得到单台主机cpu在一分钟内的使用率。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png" alt="计算cpu使用率二"></p>
<h3 id="3-2-计算内存使用率"><a href="#3-2-计算内存使用率" class="headerlink" title="3.2 计算内存使用率"></a>3.2 计算内存使用率</h3><p>内存使用率公式为 &#x3D; (available &#x2F; total) * 100</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87.png" alt="计算内存使用率"></p>
<h3 id="3-3-rate函数"><a href="#3-3-rate函数" class="headerlink" title="3.3 rate函数"></a>3.3 rate函数</h3><p>rate函数是专门搭配counter类型数据使用的函数，功能是按照设置的一个时间段，取counter在这个时间段中平均每秒的增量。</p>
<p>举个栗子，假设我们要取ens33这个网卡在一分钟内字节的接受数量，假如一分钟内接收到的是1000bytes，那么平均每秒接收到就是1000bytes &#x2F; 1m * 60s ≈ 16bytes&#x2F;s。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_network_receive_bytes_total&#123;device=&#x27;ens33&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<p>如果是五分钟的话即为5000bytes &#x2F; 5m * 60s ≈ 16bytes&#x2F;s，结果是一样的，但曲线图就不一样了，上图为一分钟，下图为五分钟，因为五分钟的密度要更底，所以可以看到五分钟的曲线图更加平缓。</p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%B8%80.png" alt="rate函数一"></p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%BA%8C.png" alt="rate函数二"></p>
<p>rate和increase的概念有些类似，但rate取的是一段时间增量的平均每秒数量，increase取的是一段时间增量的总量，即：</p>
<ul>
<li>rate(1m)：总量 &#x2F; 60s</li>
<li>increase(1m)：总量</li>
</ul>
<h3 id="3-4-sum函数"><a href="#3-4-sum函数" class="headerlink" title="3.4 sum函数"></a>3.4 sum函数</h3><p>sum函数就是将收到的数据全部进行整合。</p>
<p>假如一个集群里有20台服务器，分别为5台web服务器，10台db服务器，还有5台其他服务的服务器，这时候sum就可以分为三条曲线来代表不同功能服务器的总和数据。</p>
<h3 id="3-5-topk函数"><a href="#3-5-topk函数" class="headerlink" title="3.5 topk函数"></a>3.5 topk函数</h3><p>topk函数的作用就是取前几位的最高值。</p>
<p><img src="/2024/02/18/prometheus/topk%E5%87%BD%E6%95%B0%E4%B8%80.png" alt="topk函数一"></p>
<h3 id="3-6-count函数"><a href="#3-6-count函数" class="headerlink" title="3.6 count函数"></a>3.6 count函数</h3><p>count函数的作用是把符合条件的数值进行整合。</p>
<p>假如我们要查看集群中cpu使用率超过80%的主机数量的话</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count((1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100 &gt; 80)</span><br></pre></td></tr></table></figure>



<h2 id="四、Push-gateway"><a href="#四、Push-gateway" class="headerlink" title="四、Push gateway"></a>四、Push gateway</h2><p>Push gateway实际上就是一种被动推送数据的方式，与exporter主动获取不同。</p>
<h3 id="4-1-Push-gateway安装"><a href="#4-1-Push-gateway安装" class="headerlink" title="4.1 Push gateway安装"></a>4.1 Push gateway安装</h3><ol>
<li>下载安装Push gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/pushgateway/releases/download/v1.4.0/pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">mv pushgateway-1.4.0.linux-amd64 pushgateway</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>后台运行Push gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/pushgateway/pushgateway</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在prometheus.yml中加上</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;pushgateway&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&#x27;localhost:9091&#x27;]</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E6%B7%BB%E5%8A%A0pushgateway.png" alt="添加pushgateway"></p>
<h3 id="4-2-自定义编写脚本"><a href="#4-2-自定义编写脚本" class="headerlink" title="4.2 自定义编写脚本"></a>4.2 自定义编写脚本</h3><p>由于Push gateway自己本身是没有任何抓取数据的功能的，所以用户需要自行编写脚本来抓取数据。</p>
<p>举个例子：编写脚本抓取 TCP waiting_connection 的数量</p>
<ol>
<li>编写自定义脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取监控主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果主机名为localhost，则退出</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;不能监控主机名为localhost的主机&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取TCP CONNECTED数量</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">抓取TCP CONNECTED数量，定义为一个新key</span></span><br><span class="line">lable_tcp_connected=&quot;count_netstat_connected_connections&quot;</span><br><span class="line">count_netstat_connected_connections=`netstat -an | grep &#x27;CONNECTED&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_connected $count_netstat_connected_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该脚本是通过post的方式将key推送给pushgateway</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://localhost:9091 即推送给哪台pushgateway主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">job/pushgateway 即推送给prometheus.yml中定义的job为pushgateway的主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">instance/<span class="variable">$instance_name</span> 推送后显示的主机名</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>因为脚本都是运行一次后就结束了，可以配合crontab反复运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每分钟执行一次脚本</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每10s执行一次脚本</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC.png" alt="自定义编写脚本"></p>
<h3 id="4-3-编写抓取ping丢包和延迟时间数据"><a href="#4-3-编写抓取ping丢包和延迟时间数据" class="headerlink" title="4.3 编写抓取ping丢包和延迟时间数据"></a>4.3 编写抓取ping丢包和延迟时间数据</h3><p>在node_exporter_shell.sh中加入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取ping某网站丢包率和延迟时间</span></span><br><span class="line"></span><br><span class="line">site_address=&quot;www.baidu.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取丢包率和延迟时间，定义为两个新key</span></span><br><span class="line">lable_ping_packet_loss=&quot;ping_packet_loss&quot;</span><br><span class="line">ping_packet_loss_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $6&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串截取，%?为去除最后一个字符</span></span><br><span class="line">ping_packet_loss=`echo $&#123;ping_packet_loss_test%?&#125;`</span><br><span class="line"></span><br><span class="line">lable_ping_time=&quot;ping_time&quot;</span><br><span class="line">ping_time_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $10&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串截取，%??为去除最后两个字符</span></span><br><span class="line">ping_time=`echo $&#123;ping_time_test%??&#125;`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至push_ping_timegateway</span></span><br><span class="line">echo &quot;$lable_ping_packet_loss $ping_packet_loss&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"></span><br><span class="line">echo &quot;$lable_ping_time $ping_time&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>



<h2 id="五、Grafana的使用"><a href="#五、Grafana的使用" class="headerlink" title="五、Grafana的使用"></a>五、Grafana的使用</h2><p>Grafana是一款用Go语言开发的开源数据可视化工具，可以做数据监控和数据统计，带有告警功能。</p>
<h3 id="5-1-Grafana安装"><a href="#5-1-Grafana安装" class="headerlink" title="5.1 Grafana安装"></a>5.1 Grafana安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">yum -y install grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl enable grafana-server</span><br></pre></td></tr></table></figure>

<h3 id="5-2-设置数据源"><a href="#5-2-设置数据源" class="headerlink" title="5.2 设置数据源"></a>5.2 设置数据源</h3><ol>
<li>Grafana -&gt; Configuration -&gt; Date Sources -&gt; Prometheus</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="Grafana安装一"></p>
<ol start="2">
<li>New dashboard</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%BA%8C.png" alt="Grafana安装二"></p>
<ol start="3">
<li>添加一个监控和CPU内存使用率的仪表盘</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%89.png" alt="Grafana安装三"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E5%9B%9B.png" alt="Grafana安装四"></p>
<h3 id="5-3-json备份和还原"><a href="#5-3-json备份和还原" class="headerlink" title="5.3 json备份和还原"></a>5.3 json备份和还原</h3><ol>
<li>备份：dashboard -&gt; Settings -&gt; JSON Model，将里面内容保存为json文件</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E5%A4%87%E4%BB%BD.png" alt="JSON备份"></p>
<ol start="2">
<li>恢复：Create -&gt; import</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E8%BF%98%E5%8E%9F.png" alt="JSON还原"></p>
<h3 id="5-4-Grafana实现报警功能"><a href="#5-4-Grafana实现报警功能" class="headerlink" title="5.4 Grafana实现报警功能"></a>5.4 Grafana实现报警功能</h3><ol>
<li>配置Grafana文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖和图形显示插件</span></span><br><span class="line">yum -y install libatk-bridge* libXss* libgtk*</span><br><span class="line">grafana-cli plugins install grafana-image-renderer</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置</span></span><br><span class="line">vim /etc/grafana/grafana.ini</span><br><span class="line">enabled = true</span><br><span class="line">host = smtp.163.com:25</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送报警邮件的邮箱</span></span><br><span class="line">user = chenqiming13@163.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">授权码</span></span><br><span class="line">password = QXQALYMTRYRWIOOS</span><br><span class="line">skip_verify = true</span><br><span class="line">from_address = chenqiming13@163.com</span><br><span class="line">from_name = Grafana</span><br><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建报警规则</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%80.png" alt="Grafana实现报警功能一"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%8C.png" alt="Grafana实现报警功能二"></p>
<ol start="3">
<li>针对具体监控项，设置发送邮件阈值等，这里设置为发现超过阈值起5分钟后触发报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%89.png" alt="Grafana实现报警功能三"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%9B%9B.png" alt="Grafana实现报警功能四"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%94.png" alt="Grafana实现报警功能五"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%85%AD.png" alt="Grafana实现报警功能六"></p>
<p>![Grafana实现报警功能七](Grafana实现报警功能七.png</p>
<h2 id="六、Prometheus-Grafana实际案例"><a href="#六、Prometheus-Grafana实际案例" class="headerlink" title="六、Prometheus + Grafana实际案例"></a>六、Prometheus + Grafana实际案例</h2><h3 id="6-1-predict-linear函数实现硬盘监控"><a href="#6-1-predict-linear函数实现硬盘监控" class="headerlink" title="6.1 predict_linear函数实现硬盘监控"></a>6.1 predict_linear函数实现硬盘监控</h3><p>硬盘使用率公式为：（（总容量 - 剩余容量）&#x2F;  总容量）* 100，在Prometheus中表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes) * 100</span><br></pre></td></tr></table></figure>

<p>通过df -m可以看出计算出来的值是正确的</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png" alt="计算硬盘使用率一"></p>
<p>Prometheus提供了一个predict_linear函数可以预计多长时间磁盘爆满，例如当前这1个小时的磁盘可用率急剧下降，这种情况可能导致磁盘很快被写满，这时可以使用该函数，用当前1小时的数据去预测未来几个小时的状态，实现提前报警。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该式子表示用当前1小时的值来预测未来4小时后如果根目录下容量小于0则触发报警</span></span><br><span class="line">predict_linear(node_filesystem_free_bytes &#123;mountpoint =&quot;/&quot;&#125;[1h], 4*3600) &lt; 0</span><br></pre></td></tr></table></figure>

<p>在Grafana添加监控硬盘使用率和预测硬盘使用率的仪表盘</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png" alt="计算硬盘使用率二"></p>
<h3 id="6-2-监控硬盘IO"><a href="#6-2-监控硬盘IO" class="headerlink" title="6.2 监控硬盘IO"></a>6.2 监控硬盘IO</h3><p>公式为：（读取时间 &#x2F; 写入时间）&#x2F; 1024 &#x2F; 1024，用rate函数取一分钟内读和写的字节增长率来计算，用Prometheus表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((rate(node_disk_read_bytes_total[1m]) + rate(node_disk_written_bytes_total[1m])) / 1024 / 1024) &gt; 0</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7IO%E7%8A%B6%E6%80%81.png" alt="监控IO状态"></p>
<h3 id="6-3-监控TCP-WAIT状态的数量"><a href="#6-3-监控TCP-WAIT状态的数量" class="headerlink" title="6.3 监控TCP_WAIT状态的数量"></a>6.3 监控TCP_WAIT状态的数量</h3><p>在被监控主机上编写监控脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取监控主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果主机名为localhost，则退出</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;不能监控主机名为localhost的主机&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取TCP WAIT数量</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">抓取TCP WAIT数量，定义为一个新key</span></span><br><span class="line">lable_tcp_wait=&quot;count_netstat_wait_connections&quot;</span><br><span class="line">count_netstat_wait_connections=`netstat -an | grep &#x27;WAIT&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_wait $count_netstat_wait_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-监控文件描述符使用率"><a href="#6-4-监控文件描述符使用率" class="headerlink" title="6.4 监控文件描述符使用率"></a>6.4 监控文件描述符使用率</h3><p>在linux中，每当进程打开一个文件时，系统就会为其分配一个唯一的整型文件描述符，用来标识这个文件，每个进程默认打开的文件描述符有三个，分别为标准输入、标准输出、标准错误，即stdin、stout、steer，用文件描述符来表示为0、1、2。</p>
<p>用命令可以查看目前系统的最大文件描述符限制，一般默认设置是1024。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n</span><br></pre></td></tr></table></figure>

<p>文件描述符使用率公式为：（已分配的文件描述符数量 &#x2F; 最大文件描述符数量）* 100，在Prometheus中则表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_filefd_allocated / node_filefd_maximum) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%BD%BF%E7%94%A8%E7%8E%87.png" alt="监控文件描述符使用率"></p>
<h3 id="6-5-网络延迟和丢包率监控"><a href="#6-5-网络延迟和丢包率监控" class="headerlink" title="6.5 网络延迟和丢包率监控"></a>6.5 网络延迟和丢包率监控</h3><p>前面我们采用的都是简单的ping + ip地址来进行测试，实际上这样测试发出去的icmp数据包是非常小的，只适合用来测试网络是否连通，因此用以下命令来进行优化：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ping -q ip地址 -s 500 -W 1000 -c 100</span><br><span class="line">-q:不显示指令执行过程，开头和结尾的相关信息除外。</span><br><span class="line">-s:设置数据包的大小。</span><br><span class="line">-W:在等待 timeout 秒后开始执行。</span><br><span class="line">-c:设置完成要求回应的次数。</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E5%92%8C%E4%B8%A2%E5%8C%85%E7%8E%87%E7%9B%91%E6%8E%A7.png" alt="网络延迟和丢包率监控"></p>
<h3 id="6-6-使用Pageduty实现报警"><a href="#6-6-使用Pageduty实现报警" class="headerlink" title="6.6 使用Pageduty实现报警"></a>6.6 使用Pageduty实现报警</h3><p>Pagerduty是一套付费监控报警系统，经常作为SRE&#x2F;运维人员的监控报警工具，可以和市面上常见的监控工具直接整合。</p>
<ol>
<li>创建新service</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%80.png" alt="pateduty实现报警一"><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%8C.png" alt="pateduty实现报警二"></p>
<ol start="2">
<li>在Grafana新建报警渠道，并在仪表盘中设置为Pageduty报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%89.png" alt="pateduty实现报警三"></p>
<ol start="3">
<li>设置报警信息</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%9B%9B.png" alt="pateduty实现报警四"></p>
<ol start="4">
<li>查看是否收到报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%94.png" alt="pateduty实现报警五"></p>
<ol start="5">
<li>当问题解决可以点击已解决</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%85%AD.png" alt="pateduty实现报警六"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T09:27:23.375Z" title="2/18/2024, 5:27:23 PM">2024-02-18</time></span><span class="level-item">40 minutes read (About 6006 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/ansible/">Ansible</a></p><div class="content"><h2 id="一、Ansible简介"><a href="#一、Ansible简介" class="headerlink" title="一、Ansible简介"></a>一、Ansible简介</h2><p>ansbile是一个IT自动化的配置管理工具，自动化主要体现在Ansible集成了丰富的模块，可以通过一个命令完成一系列的操作，进而减少运维重复性的工作和维护成本，提高工作效率。</p>
<p><img src="/2024/02/18/ansible/ansible%E5%9B%BE%E6%A0%87.jpg" alt="ansible图标"></p>
<h3 id="1-1-为什么需要ansible"><a href="#1-1-为什么需要ansible" class="headerlink" title="1.1 为什么需要ansible"></a>1.1 为什么需要ansible</h3><p>思考：假设我们要在10台服务器上安装并运行nginx，要如何操作？</p>
<ol>
<li>ssh远程登录到服务器</li>
<li>执行yum -y install nginx</li>
<li>执行systemctl start nginx</li>
<li>执行systemctl enable nginx</li>
<li>重复十次。。。</li>
</ol>
<p>可以看到简单的工作要做十次是很浪费时间的，这时候我们就需要ansible了。</p>
<h3 id="1-2-ansible有哪些功能"><a href="#1-2-ansible有哪些功能" class="headerlink" title="1.2 ansible有哪些功能"></a>1.2 ansible有哪些功能</h3><ol>
<li>批量执行远程命令，可以同时对N台主机执行命令</li>
<li>批量配置软件服务，可以用自动化的方式配置和管理服务</li>
<li>实现软件开发功能，jumpserver底层使用ansible来实现自动化管理</li>
<li>编排高级的IT任务，playbook是ansbile的一门编程语言，可以用来描绘一套IT架构</li>
</ol>
<p><img src="/2024/02/18/ansible/ansbile%E6%9E%B6%E6%9E%84.png" alt="ansbile架构"></p>
<h2 id="二、Ansible安装"><a href="#二、Ansible安装" class="headerlink" title="二、Ansible安装"></a>二、Ansible安装</h2><h3 id="2-1-在控制端上安装ansible"><a href="#2-1-在控制端上安装ansible" class="headerlink" title="2.1 在控制端上安装ansible"></a>2.1 在控制端上安装ansible</h3><p>直接利用yum源安装即可，ansible配置文件一般不需要做变动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure>

<h3 id="2-2-ansible配置文件的优先级"><a href="#2-2-ansible配置文件的优先级" class="headerlink" title="2.2 ansible配置文件的优先级"></a>2.2 ansible配置文件的优先级</h3><ol>
<li>如果当前目录不存在ansible.cfg，会采用默认的配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br><span class="line">...</span><br><span class="line">config file = /etc/ansible/ansible.cfg</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>如果当前目录存在ansible.cfg，则会采用当前目录的配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br><span class="line">...</span><br><span class="line">config file = /root/project1/ansible.cfg</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="2-3-ansible的Inventory"><a href="#2-3-ansible的Inventory" class="headerlink" title="2.3 ansible的Inventory"></a>2.3 ansible的Inventory</h3><p>利用密钥来连接被控端</p>
<ol>
<li>在项目目录下创建hosts文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd project1</span><br><span class="line">vim hosts</span><br><span class="line">[cqm]</span><br><span class="line">192.168.88.133</span><br><span class="line">192.168.88.134</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建密钥</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ls /root/.ssh/</span><br><span class="line">authorized_keys id_rsa id_rsa.pub known_hosts</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将公钥传送至被控端主机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.88.133</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.88.134</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试是否不需要密码就可以连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.88.133</span><br><span class="line">ssh root@192.168.88.134</span><br></pre></td></tr></table></figure>

<h2 id="三、Ansible的ad-hoc和常用模块"><a href="#三、Ansible的ad-hoc和常用模块" class="headerlink" title="三、Ansible的ad-hoc和常用模块"></a>三、Ansible的ad-hoc和常用模块</h2><h3 id="3-1-ansible的ad-hoc"><a href="#3-1-ansible的ad-hoc" class="headerlink" title="3.1 ansible的ad-hoc"></a>3.1 ansible的ad-hoc</h3><p><strong>ad-hoc简而言之就是“临时命令”，执行完就结束，并不会保存</strong></p>
<p><strong>主要格式为：ansible + -i + 指定主机清单 + 指定主机组名称 + -m + 指定模块 + -a + 具体命令</strong></p>
<p>使用ad-hoc后返回结果的颜色：</p>
<ol>
<li>绿色：被控端主机没有发生变化</li>
<li>黄色：被控端主机发生了变化</li>
<li>红色：出现故障</li>
</ol>
<h3 id="3-2-ansible基本命令"><a href="#3-2-ansible基本命令" class="headerlink" title="3.2 ansible基本命令"></a>3.2 ansible基本命令</h3><ol>
<li>直接执行命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts 主机组名 -m 模块 -a 命令</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>列出某个主机组的主机清单</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts 主机组名 --list-hosts</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看某个模块使用教程</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc 模块名称</span><br><span class="line">/EX</span><br></pre></td></tr></table></figure>

<h3 id="3-2-shell和command模块"><a href="#3-2-shell和command模块" class="headerlink" title="3.2 shell和command模块"></a>3.2 shell和command模块</h3><p>shell和command本质上都是用来执行linux的基础命令，如cat、ls等等，但command不支持用|这种管道符命令</p>
<p>例子，同样的命令在command上会报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m shell -a &#x27;ps -ef | grep nginx&#x27;</span><br><span class="line">ansible -i hosts cqm -m command -a &#x27;ps -ef | grep nginx&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/ansible/shell%E5%92%8Ccommand.png" alt="shell和command"></p>
<h3 id="3-3-yum模块"><a href="#3-3-yum模块" class="headerlink" title="3.3 yum模块"></a>3.3 yum模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m yum -a &#x27;name=httpd state=latest enablerepo=epel&#x27;</span><br><span class="line">name:指定安装软件名称</span><br><span class="line">state:</span><br><span class="line">	1.latest为安装最新版本</span><br><span class="line">	2.absent为卸载</span><br><span class="line">	3.present为安装</span><br><span class="line">enablerepo:指定在哪个yum源下安装</span><br></pre></td></tr></table></figure>

<h3 id="3-4-copy模块"><a href="#3-4-copy模块" class="headerlink" title="3.4 copy模块"></a>3.4 copy模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m copy -a &#x27;src=./httpd.conf dest=/etc/httpd/conf/httpd.conf owner=www group=www mode=0755&#x27;</span><br><span class="line">src:表示要复制的文件路径</span><br><span class="line">dest:要复制到被控端的哪个路径</span><br><span class="line">owner:复制文件的属主</span><br><span class="line">group:复制文件的属组</span><br><span class="line">mode:文件的权限，0755为rwxr-xr-x(r:4,w:2,x:1)，也可以写成(u+rwx,g+x,o-rwx)的形式</span><br><span class="line">backup:如果被控端有同名文件，是否保留</span><br></pre></td></tr></table></figure>

<h3 id="3-5-file模块"><a href="#3-5-file模块" class="headerlink" title="3.5 file模块"></a>3.5 file模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">更改文件权限</span></span><br><span class="line">ansible -i hosts cqm -m file -a &#x27;path=/etc/nginx/nginx.conf owner=www group=www mode=0644&#x27;</span><br><span class="line">path:代表要改变文件的路径(被控端)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建符号连接(软连接)</span></span><br><span class="line">ansible -i hosts cqm -m file -a &#x27;src=/root/test1 dest=/root/test2 mode=0755 state=link&#x27;</span><br><span class="line">src:源文件路径(被控端)</span><br><span class="line">dest:软连接路径(被控端)</span><br><span class="line">state:link创建软连接</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建文件和文件夹</span></span><br><span class="line">ansible -i hosts cqm -m file -a &#x27;path=/root/text state=touch/directory mode=0644 recurse=yes&#x27;</span><br><span class="line">path:要创建在哪</span><br><span class="line">state:</span><br><span class="line">	1.touch表创建文件</span><br><span class="line">	2.directory表创建文件夹</span><br><span class="line">	3.absent表删除</span><br><span class="line">recurse: 递归授权</span><br></pre></td></tr></table></figure>

<h3 id="3-6-service模块"><a href="#3-6-service模块" class="headerlink" title="3.6 service模块"></a>3.6 service模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m service -a &#x27;name=httpd state=started enabled=yes&#x27;</span><br><span class="line">name:服务名称</span><br><span class="line">state:</span><br><span class="line">	1.started启动</span><br><span class="line">	2.stopped关闭</span><br><span class="line">	3.restarted重启</span><br><span class="line">	4.reloaded重载</span><br><span class="line">enabled:是否开机自启</span><br></pre></td></tr></table></figure>

<h3 id="3-7-group模块"><a href="#3-7-group模块" class="headerlink" title="3.7 group模块"></a>3.7 group模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m group -a &#x27;name=cqm state=present gid=1000 system=yes/no&#x27;</span><br><span class="line">name:创建组名称</span><br><span class="line">state:</span><br><span class="line">	1.present创建组</span><br><span class="line">	2.absent删除组</span><br><span class="line">gid:组id</span><br><span class="line">system:是否设置为系统组</span><br></pre></td></tr></table></figure>

<h3 id="3-8-user模块"><a href="#3-8-user模块" class="headerlink" title="3.8 user模块"></a>3.8 user模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m user -a &#x27;name=cqm uid=1000 group=cqm shell=/bin/bash state=present create_home=no&#x27;</span><br><span class="line">name:创建用户名称</span><br><span class="line">uid:用户id</span><br><span class="line">group:添加到哪个组</span><br><span class="line">shell:使用/bin/bash创建用户，或/sbin/nologin</span><br><span class="line">state:</span><br><span class="line">	1.present创建用户</span><br><span class="line">	2.absent删除用户</span><br><span class="line">create_home:是否创建家目录，默认为yes</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m user -a &#x27;name=cqm uid=1000 groups=cqm1,cqm2 append=yes state=present system:yes&#x27;</span><br><span class="line">groups:添加到哪些组</span><br><span class="line">append:添加到多个组时添加该项</span><br><span class="line">system:是否设置为系统用户</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m user -a &#x27;name=cqm state=absent remove=yes&#x27;</span><br><span class="line">remove:是否删除家目录</span><br></pre></td></tr></table></figure>

<h3 id="3-9-cron模块"><a href="#3-9-cron模块" class="headerlink" title="3.9 cron模块"></a>3.9 cron模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m cron -a &#x27;name=&quot;check dirs&quot; minute=0 hour=5,2 job=&quot;ls -al &gt; /dev/null&quot;&#x27;</span><br><span class="line">name:创建定时任务名称</span><br><span class="line">minute:分钟</span><br><span class="line">hour:小时</span><br><span class="line">job:任务</span><br><span class="line">state:删除定时任务用absent</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在被控端可查看</span></span><br><span class="line">crontab -l</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Ansible: check <span class="built_in">dirs</span></span></span><br><span class="line">0 5,2 * * * ls -al &gt; /dev/null</span><br></pre></td></tr></table></figure>

<h3 id="3-10-mount模块"><a href="#3-10-mount模块" class="headerlink" title="3.10 mount模块"></a>3.10 mount模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m mount -a &#x27;path=/root/data src=/dev/sr0 fstype=iso9660 opts=&quot;ro&quot; state=present&#x27;</span><br><span class="line">path:挂载到哪</span><br><span class="line">src:被挂载的目录，可以是以下形式</span><br><span class="line">	1.UUID形式:src=&quot;UUID=......&quot;</span><br><span class="line">	2.ip形式:src=&quot;192.168.88.128:/data&quot;，一般用于挂载nfs服务器的目录</span><br><span class="line">fstype:挂载类型</span><br><span class="line">	1.iso9660:文件系统是一个标准CD-ROM文件系统</span><br><span class="line">	2.ext4:Linux系统下的日志文件系统</span><br><span class="line">	3.xfs:高性能的日志文件系统</span><br><span class="line">	4.none</span><br><span class="line">state:挂载类型</span><br><span class="line">	1.present:开机挂载，仅将挂载配置写入/etc/fstab</span><br><span class="line">	2.mounted:挂载设备，并将配置写入/etc/fstab</span><br><span class="line">	3.unmounted:卸载设备，不会清除/etc/fstab写入的配置</span><br><span class="line">	4.absent:卸载设备，会清理/etc/fstab写入的配置</span><br><span class="line">opts:权限等，默认填defaults</span><br><span class="line">/etc/fstab:磁盘被手动挂载之后都必须把挂载信息写入/etc/fstab这个文件中，否则下次开机启动时仍然需要重新挂载。</span><br></pre></td></tr></table></figure>

<h3 id="3-11-firewalld模块"><a href="#3-11-firewalld模块" class="headerlink" title="3.11 firewalld模块"></a>3.11 firewalld模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m firewalld -a &#x27;service=https permanent=yes enable=yes immediate=yes state=enabled&#x27;</span><br><span class="line">service:放行服务</span><br><span class="line">port:放行端口，如80/tcp</span><br><span class="line">source:放行指定ip地址范围，如192.168.88.0/24</span><br><span class="line">state:表防火墙策略状态</span><br><span class="line">	1.enabled策略生效</span><br><span class="line">	2.disabled禁用策略</span><br><span class="line">	3.present添加策略</span><br><span class="line">	4.absent删除策略</span><br><span class="line">zone:指定防火墙信任级别</span><br><span class="line">	1.drop:丢弃所有进入的包，而不给出任何响应</span><br><span class="line">	2.block:拒绝所有外部发起的连接，允许内部发起的连接</span><br><span class="line">	3.public:允许指定的进入连接</span><br><span class="line">	4.internal:范围针对所有互联网用户</span><br><span class="line">permanent:yes为永久生效</span><br><span class="line">immediate:yes为立即生效</span><br></pre></td></tr></table></figure>

<h3 id="3-12-unarchive模块"><a href="#3-12-unarchive模块" class="headerlink" title="3.12 unarchive模块"></a>3.12 unarchive模块</h3><p>unarchive模块能够实现解压再拷贝的功能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m unarchive -a &#x27;src=./apache.tar.gz dest=/etc/httpd mode=0755 owner=www group=www&#x27;</span><br><span class="line">src:压缩文件路径</span><br><span class="line">dest:解压到哪</span><br><span class="line">remote_src:设置为yes时表示压缩包已经在被控端主机上，而不是ansible控制端本地</span><br></pre></td></tr></table></figure>

<h3 id="3-13-get-url模块"><a href="#3-13-get-url模块" class="headerlink" title="3.13 get_url模块"></a>3.13 get_url模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">url:下载链接</span><br><span class="line">dest:保存文件地址</span><br><span class="line">mode:设置权限</span><br></pre></td></tr></table></figure>

<h3 id="3-14-template模块"><a href="#3-14-template模块" class="headerlink" title="3.14 template模块"></a>3.14 template模块</h3><p>template与copy用法相同，但template可以实别变量，而copy不行。</p>
<h3 id="3-15-yum-repository模块"><a href="#3-15-yum-repository模块" class="headerlink" title="3.15 yum_repository模块"></a>3.15 yum_repository模块</h3><p>yum_repository可以用来配置yum源</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">  <span class="attr">yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/7/$basearch/</span></span><br><span class="line">    <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="string">name:相当于.repo文件中括号的[仓库名]</span></span><br><span class="line"><span class="string">description:相当于.repo文件中的name</span></span><br><span class="line"><span class="string">file:相当于.repo文件的名称</span></span><br><span class="line"><span class="string">baseurl:相当于.repo文件中baseurl</span></span><br><span class="line"><span class="string">gpgcheck:相当于.repo文件中gpgcheck</span></span><br><span class="line"><span class="string">enabled:相当于.repo文件中enabled</span></span><br></pre></td></tr></table></figure>

<h2 id="四、Ansible的Playbook"><a href="#四、Ansible的Playbook" class="headerlink" title="四、Ansible的Playbook"></a>四、Ansible的Playbook</h2><p>playbook是ansible的另一种使用方式，被称为“剧本”，与ad-hoc不同的是，playbook可以实现持久使用。</p>
<p>playbook是由一个或多个play组成的列表，play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色，从根本上来讲，所谓的task无非就是调用ansible的一个module，将多个play组织在一个playbook中，即可实现同时完成多项任务。</p>
<p><strong>playbook的核心元素</strong></p>
<ol>
<li>hosts：被控主机清单</li>
<li>tasks：任务集</li>
<li>vars：变量</li>
<li>templates：模板</li>
<li>handlers和notify：触发器</li>
<li>tags：标签</li>
</ol>
<h3 id="4-1-利用playbook安装apache"><a href="#4-1-利用playbook安装apache" class="headerlink" title="4.1 利用playbook安装apache"></a>4.1 利用playbook安装apache</h3><p>playbook采用的是yml语法，举个栗子</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/project1</span><br><span class="line">vim httpd.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">#安装apache服务</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#创建www组</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">www</span> <span class="string">Group</span></span><br><span class="line">      <span class="attr">group:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#创建www用户</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">www</span> <span class="string">User</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#修改apache配置文件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Httpd</span> <span class="string">Conf</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./httpd.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#启动服务并设为开机自启</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#放行端口</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Firewall</span></span><br><span class="line">      <span class="attr">firewalld:</span></span><br><span class="line">        <span class="attr">zone:</span> <span class="string">public</span></span><br><span class="line">        <span class="attr">ports:</span> <span class="number">8080</span><span class="string">/tcp</span></span><br><span class="line">        <span class="attr">permanent:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">enabled</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查语法</span></span><br><span class="line">ansible-playbook --syntax -i hosts httpd.yml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行playbook</span></span><br><span class="line">ansible-playbook -i hosts httpd.yml</span><br></pre></td></tr></table></figure>

<h3 id="4-2-利用playbook部署nfs"><a href="#4-2-利用playbook部署nfs" class="headerlink" title="4.2 利用playbook部署nfs"></a>4.2 利用playbook部署nfs</h3><ol>
<li>准备好nfs配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /root/project1</span><br><span class="line">cat exports</span><br><span class="line">/root/nfs_data 192.168.88.0/24(rw,no_root_squash)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写nfs.yml文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nfs主机</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.133</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/nfs_data</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0744</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">recurse:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">NFS</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./exports</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/exports</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Stop</span> <span class="string">Firewall</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">firewalld</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">stopped</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#挂载nfs目录的主机</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.134</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/nfs_data</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Mount</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">mount:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/nfs_data</span></span><br><span class="line">        <span class="attr">src:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.133</span><span class="string">:/root/nfs_data</span></span><br><span class="line">        <span class="attr">fstype:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">opts:</span> <span class="string">defaults</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">mounted</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行playbook</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts nfs.yml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/ansible/nfs%E6%8C%82%E8%BD%BD.png" alt="nfs挂载"></p>
<h2 id="五、Ansible的变量"><a href="#五、Ansible的变量" class="headerlink" title="五、Ansible的变量"></a>五、Ansible的变量</h2><h3 id="5-1-在play中设置变量"><a href="#5-1-在play中设置变量" class="headerlink" title="5.1 在play中设置变量"></a>5.1 在play中设置变量</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web_package:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ftp_package:</span> <span class="string">vsftpd</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> &#123;&#123; <span class="string">web_package</span> &#125;&#125; <span class="string">and</span> &#123;&#123; <span class="string">ftp_package</span> &#125;&#125; <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ftp_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-在vars-file中设置变量"><a href="#5-2-在vars-file中设置变量" class="headerlink" title="5.2 在vars_file中设置变量"></a>5.2 在vars_file中设置变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat vars.yml</span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">vars_files:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">./vars.yml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> &#123;&#123; <span class="string">web_package</span> &#125;&#125; <span class="string">and</span> &#123;&#123; <span class="string">ftp_package</span> &#125;&#125; <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ftp_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-通过inventory主机清单设置变量"><a href="#5-3-通过inventory主机清单设置变量" class="headerlink" title="5.3 通过inventory主机清单设置变量"></a>5.3 通过inventory主机清单设置变量</h3><ol>
<li>创建两个变量目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir hosts_vars</span><br><span class="line">mkdir groups_vars</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在groups_vars目录中针对某个组创建变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat group_vars/cqm</span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">groups_vars目录中也可以新建all来设置变量，这样所有的主机组都可以调用</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在hosts_vars目录中针对某个主机创建变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat hosts_vars/192.168.88.133</span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br></pre></td></tr></table></figure>

<h3 id="5-4-在执行playbook时通过-e-参数设置变量"><a href="#5-4-在执行playbook时通过-e-参数设置变量" class="headerlink" title="5.4 在执行playbook时通过 -e 参数设置变量"></a>5.4 在执行playbook时通过 -e 参数设置变量</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> &#123;&#123; <span class="string">web_package</span> &#125;&#125; <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts -e &#x27;web_package=httpd&#x27; test.yml</span><br></pre></td></tr></table></figure>

<h3 id="5-5-ansible变量的优先级"><a href="#5-5-ansible变量的优先级" class="headerlink" title="5.5 ansible变量的优先级"></a>5.5 ansible变量的优先级</h3><p>优先级由上至下递减</p>
<ol>
<li>-e（外置传参）</li>
<li>vars_files</li>
<li>play中的vars</li>
<li>hosts_vars</li>
<li>groups_vars中的某个主机组</li>
<li>groups_vars中的all</li>
</ol>
<h3 id="5-6-register注册变量"><a href="#5-6-register注册变量" class="headerlink" title="5.6 register注册变量"></a>5.6 register注册变量</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Apache</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Apache</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Apache</span> <span class="string">Process</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">ps</span> <span class="string">-ef</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">httpd</span></span><br><span class="line">      <span class="comment">#将结果储存到变量里</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_apache</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#利用debug模块调用</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Output</span> <span class="string">check_apache</span></span><br><span class="line">      <span class="attr">debug:</span> </span><br><span class="line">        <span class="comment">#输出msg中的stdout_lines</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; check_apache.stdout_lines &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-7-facts变量"><a href="#5-7-facts变量" class="headerlink" title="5.7 facts变量"></a>5.7 facts变量</h3><p>facts变量是ansible控制端采集被控端的变量，可以直接调用</p>
<p>为了方便可以将facts变量写到文本里</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i hosts cqm -m setup &gt; fasts.txt</span><br></pre></td></tr></table></figure>

<h2 id="六、Ansible语句"><a href="#六、Ansible语句" class="headerlink" title="六、Ansible语句"></a>六、Ansible语句</h2><h3 id="6-1-条件判断when"><a href="#6-1-条件判断when" class="headerlink" title="6.1 条件判断when"></a>6.1 条件判断when</h3><p>centos安装apache是httpd，而ubuntu安装apache则是httpd2，所以这时候就需要条件判断了</p>
<p><strong>例一：不同系统安装apache</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="string">tasks</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Centos</span> <span class="string">Install</span> <span class="string">Apache</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span> <span class="string">)</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Utunbu</span> <span class="string">Install</span> <span class="string">Apache2</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd2</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;Utunbu&quot;</span> <span class="string">)</span></span><br></pre></td></tr></table></figure>

<p><strong>例二：给主机名带有web的主机配置yum源</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Cqm</span> <span class="string">Yum</span> <span class="string">Repo</span></span><br><span class="line">      <span class="attr">yum_repository:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cqm</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">cqm</span> <span class="string">yum</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">baseurl:</span> <span class="string">http://www.cqmmmmm.com</span></span><br><span class="line">        <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">ansible_fqdn</span> <span class="string">is</span> <span class="string">match</span> <span class="string">(&quot;web*&quot;)</span> <span class="string">)</span></span><br></pre></td></tr></table></figure>

<p><strong>例三：判断nfs服务是否启动，没有则启动，否则重启</strong></p>
<p>利用echo $？的返回值来查看是否启动</p>
<p><img src="/2024/02/18/ansible/when%E5%88%A4%E6%96%AD%E4%B8%80.png" alt="when判断一"></p>
<p><img src="/2024/02/18/ansible/when%E5%88%A4%E6%96%AD%E4%BA%8C.png" alt="when判断二"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">NFS</span> <span class="string">Service</span> <span class="string">Status</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">is-active</span> <span class="string">nfs</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_nfs</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">check_nfs.rc</span> <span class="string">==</span> <span class="number">0</span> <span class="string">)</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-循环语句with-items"><a href="#6-2-循环语句with-items" class="headerlink" title="6.2 循环语句with_items"></a>6.2 循环语句with_items</h3><p>with_items可以实现循环，可以减少playbook中同样模块的使用次数</p>
<p><strong>例一：利用with_items重启nginx和php服务</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure>

<p><strong>例二：利用变量循环安装多个服务</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">Mysql</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">pack</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">pack:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mysql-server</span></span><br></pre></td></tr></table></figure>

<p><strong>例三：利用循环创建多个用户</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Multiple</span> <span class="string">Users</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item.name</span> &#125;&#125;</span><br><span class="line">        <span class="attr">group:</span> &#123;&#123; <span class="string">item.group</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;aaa&#x27;</span>, <span class="attr">group:</span> <span class="string">&#x27;aaa&#x27;</span> &#125;</span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;bbb&#x27;</span>, <span class="attr">group:</span> <span class="string">&#x27;bbb&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-触发器handlers"><a href="#6-3-触发器handlers" class="headerlink" title="6.3 触发器handlers"></a>6.3 触发器handlers</h3><p>handlers是ansible的触发器，配合notify使用。</p>
<p>handlers只有在playbook执行到最后才会执行，简单来说可以将handlers看作一个特殊的tasks，只有在notify指定的某个模块运行了才会触发handlers中的模块。</p>
<p><strong>例一：修改nginx.conf的话就重启nginx服务</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-tags标签"><a href="#6-4-tags标签" class="headerlink" title="6.4 tags标签"></a>6.4 tags标签</h3><p>对tasks指定标签，可以在执行playbook的时候指定执行哪个tags的任务。</p>
<p><strong>例一：利用tags来执行开启nginx和php服务</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">php-fpm</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">start_services</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts cqm -t &#x27;start_services&#x27; test.yml</span><br></pre></td></tr></table></figure>

<p>如果要指定不执行哪个标签的任务，添加参数–skip-tags</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts cqm --skip-tags &#x27;start_services&#x27; test.yml</span><br></pre></td></tr></table></figure>

<h3 id="6-5-包含include"><a href="#6-5-包含include" class="headerlink" title="6.5 包含include"></a>6.5 包含include</h3><p>如果每个playbook都会用到重启某个服务的任务，那么每个playbook都要写一次，利用include就只用写一次，让每个playbook调用即可。</p>
<p><strong>例一：准备一个重启nginx的yml文件来给各个playbook调用</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx_restart.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">include:</span> <span class="string">./restart_nginx.yml</span></span><br></pre></td></tr></table></figure>

<h3 id="6-6-错误忽略ignore-errors"><a href="#6-6-错误忽略ignore-errors" class="headerlink" title="6.6 错误忽略ignore_errors"></a>6.6 错误忽略ignore_errors</h3><p>就是字面意思- -，尽管某个任务出错了，也会继续执行下面的任务。</p>
<p><strong>例一：忽略某个任务</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- hosts: cqm</span><br><span class="line">  tasks:</span><br><span class="line">    - name: ignore errors test</span><br><span class="line">      command: /bin/false</span><br><span class="line">      ignore_errors: yes</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="6-7-错误模块fail"><a href="#6-7-错误模块fail" class="headerlink" title="6.7 错误模块fail"></a>6.7 错误模块fail</h3><p>fail模块是一个专门用来“执行失败”的模块，我们都知道在shell中只要添加exit就可以停止执行，而playbook只有在某个任务出错了才会停止执行，这时候就可以利用fail来停止playbook的执行。</p>
<p><strong>例一：利用fail来实现exit的功能</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug2</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#执行该模块后后面的debug都会执行</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fail</span></span><br><span class="line">      <span class="attr">fail:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot; this is fail module test &quot;</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug3</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug4</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;4&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-8-错误改变failed-when"><a href="#6-8-错误改变failed-when" class="headerlink" title="6.8 错误改变failed_when"></a>6.8 错误改变failed_when</h3><p>failed_when的作用就是将条件成立的任务状态设置为失败。</p>
<p><strong>例一：判断是否输出了error，是则设置为任务失败</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;i am debug1&quot;</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#因为输出里包含了error，所以条件成立将该任务设置为了fail，playbook中止  </span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Output</span> <span class="string">Error</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#x27;this is error&#x27;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">output_error</span></span><br><span class="line">      <span class="attr">failed_when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(</span> <span class="string">&#x27;error&#x27;</span> <span class="string">in</span> <span class="string">output_error.stdout</span> <span class="string">)</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug2</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;i am debug2&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-9-错误处理changed-when"><a href="#6-9-错误处理changed-when" class="headerlink" title="6.9 错误处理changed_when"></a>6.9 错误处理changed_when</h3><p>changed_when的作用就是将条件成立的任务状态设置为changed。</p>
<p>我们在调用handlers的时候，只有任务状态为changed才会调用，这时候就可以用changed_when改变任务状态为changed，就可以实现调用handlers了。</p>
<p><strong>例一：改变任务状态为changed而调用触发器</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="comment">#尽管文件没有改变，任务状态为ok也会被改为changed而调用handlers</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<p>changed_when也可以使任务永远不会是changed。</p>
<p><strong>例二：使任务永远为ok</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cqm</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="comment">#尽管文件发生了改变，任务状态为changed也会被改为ok,永远不会调用handlers</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">false</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h2 id="七、Ansible的roles"><a href="#七、Ansible的roles" class="headerlink" title="七、Ansible的roles"></a>七、Ansible的roles</h2><p>roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中、并可以便捷地include它们的一种机制。</p>
<p>roles的目录结构：</p>
<p><img src="/2024/02/18/ansible/role%E7%BB%93%E6%9E%84.png" alt="role结构"></p>
<ol>
<li>files：存放普通文件，比如copy调用的文件</li>
<li>handlers：触发器</li>
<li>meta：依赖关系</li>
<li>tasks：任务</li>
<li>templates：存放含有变量的文件</li>
<li>vars：变量</li>
<li>在每个目录里的yml文件都必须命名为main.yml</li>
</ol>
<p><strong>一键生成roles目录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-galaxy role init test</span><br></pre></td></tr></table></figure>

<h2 id="八、利用Ansible搭建Kodcloud"><a href="#八、利用Ansible搭建Kodcloud" class="headerlink" title="八、利用Ansible搭建Kodcloud"></a>八、利用Ansible搭建Kodcloud</h2><p><strong>项目架构图</strong></p>
<p><img src="/2024/02/18/ansible/ansible%E9%83%A8%E7%BD%B2kod%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="ansible部署kod架构图.png"></p>
<h3 id="8-1-准备项目环境"><a href="#8-1-准备项目环境" class="headerlink" title="8.1 准备项目环境"></a>8.1 准备项目环境</h3><ol>
<li>基本配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/project/&#123;host_vars,group_vars&#125;</span><br><span class="line">cd /root/project</span><br><span class="line">cp /etc/ansible/ansible.cfg .</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置inventory</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim hosts</span><br><span class="line">[web]</span><br><span class="line">192.168.88.133</span><br><span class="line">[db]</span><br><span class="line">192.168.88.134</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置通用变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim group_vars/all</span><br><span class="line">nfs_server_ip: 192.168.88.134</span><br><span class="line">redis_server_ip: 192.168.88.134</span><br><span class="line">ip_address_range: 192.168.88.0/24</span><br><span class="line">web_user: www</span><br><span class="line">web_group: www</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建各个role文件目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#123;db_base,redis,mariadb,nfs_server,web_base,nginx,php,nfs_client,kodcloud&#125;/&#123;files,handlers,tasks,templates,vars&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-配置roles文件"><a href="#8-2-配置roles文件" class="headerlink" title="8.2 配置roles文件"></a>8.2 配置roles文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kod.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">db_base</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">db_base</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">mariadb</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">mariadb</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nfs_server</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">nfs_server</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">web_base</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">web_base</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">php</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">php</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nfs_client</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">nfs_client</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">kodcloud</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">kodcloud</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-配置db端基本环境"><a href="#8-3-配置db端基本环境" class="headerlink" title="8.3 配置db端基本环境"></a>8.3 配置db端基本环境</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim db_base/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Stop</span> <span class="string">Firewall</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">firewalld</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">stopped</span></span><br></pre></td></tr></table></figure>

<h3 id="8-4-配置db端redis服务"><a href="#8-4-配置db端redis服务" class="headerlink" title="8.4 配置db端redis服务"></a>8.4 配置db端redis服务</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim redis/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">redis.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/redis.conf</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写templates</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim redis/temlpates/redis.conf.j2</span><br><span class="line">egrep -v &#x27;^#|^$&#x27; redis/templates/redis.conf.j2</span><br><span class="line">bind &#123;&#123; ansible_default_ipv4.address &#125;&#125;</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat redis/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Redis</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h3 id="8-5-配置db端mariadb服务"><a href="#8-5-配置db端mariadb服务" class="headerlink" title="8.5 配置db端mariadb服务"></a>8.5 配置db端mariadb服务</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mariadb/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Mariadb</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb-server</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">MySQL-python</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Mariadb</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">my.cnf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Mariadb</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Mariadb</span> <span class="string">Root</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">mysql_user:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">toortoor</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">website</span> &#125;&#125; <span class="string">Databases</span></span><br><span class="line">  <span class="attr">mysql_db:</span></span><br><span class="line">    <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">login_password:</span> <span class="string">toortoor</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; website &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">collation:</span> <span class="string">utf8_bin</span></span><br><span class="line">    <span class="attr">encoding:</span> <span class="string">utf8</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">website</span> &#125;&#125; <span class="string">DB</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">mysql_user:</span></span><br><span class="line">    <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">login_password:</span> <span class="string">toortoor</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_db_user &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_db_pass &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&#x27;192.168.88.%&#x27;</span></span><br><span class="line">    <span class="attr">priv:</span> <span class="string">&#x27;*.*:ALL,GRANT&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写files</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mariadb/files/my.cnf.j2</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">mysqld</span>]</span><br><span class="line"><span class="string">datadir=/var/lib/mysql</span></span><br><span class="line"><span class="string">socket=/var/lib/mysql/mysql.sock</span></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line"><span class="string">symbolic-links=0</span></span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line"></span><br><span class="line">[<span class="string">mysqld_safe</span>]</span><br><span class="line"><span class="string">log-error=/var/log/mariadb/mariadb.log</span></span><br><span class="line"><span class="string">pid-file=/var/run/mariadb/mariadb.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="type">!includedir</span> <span class="string">/etc/my.cnf.d</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mariadb/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">website:</span> <span class="string">kodcloud</span></span><br><span class="line"><span class="attr">web_db_user:</span> <span class="string">kodcloud</span></span><br><span class="line"><span class="attr">web_db_pass:</span> <span class="string">toortoor</span></span><br></pre></td></tr></table></figure>

<h3 id="8-6-配置db端nfs服务"><a href="#8-6-配置db端nfs服务" class="headerlink" title="8.6 配置db端nfs服务"></a>8.6 配置db端nfs服务</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0757</span></span><br><span class="line">    <span class="attr">recurse:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">NFS</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">exports.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/exports</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restarted</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restarted</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nfs_share_directory:</span> <span class="string">/root/nfs_share</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写temlpates</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_server/templates/exports.j2</span><br><span class="line">&#123;&#123; nfs_share_directory &#125;&#125; &#123;&#123; ip_address_range &#125;&#125;(rw)</span><br></pre></td></tr></table></figure>

<h3 id="8-7-配置web端基本环境"><a href="#8-7-配置web端基本环境" class="headerlink" title="8.7 配置web端基本环境"></a>8.7 配置web端基本环境</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim web_base/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">web_group</span> &#125;&#125; <span class="string">Group</span></span><br><span class="line">  <span class="attr">group:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_group &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> &#123;&#123; <span class="string">web_user</span> &#125;&#125; <span class="string">User</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_user &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; web_group &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">create_home:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/sbin/nologin</span></span><br></pre></td></tr></table></figure>

<h3 id="8-8-配置web端nginx服务"><a href="#8-8-配置web端nginx服务" class="headerlink" title="8.8 配置web端nginx服务"></a>8.8 配置web端nginx服务</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Firewall</span></span><br><span class="line">  <span class="attr">firewalld:</span></span><br><span class="line">    <span class="attr">zone:</span> <span class="string">public</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span><span class="string">/tcp</span></span><br><span class="line">    <span class="attr">permanent:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">enabled</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">  <span class="attr">yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/7/$basearch/</span></span><br><span class="line">    <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item.src &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item.dest &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">src:</span> <span class="string">&#x27;nginx.conf.j2&#x27;</span>, <span class="attr">dest:</span> <span class="string">&#x27;/etc/nginx/nginx.conf&#x27;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">src:</span> <span class="string">&#x27;default.conf.j2&#x27;</span>, <span class="attr">dest:</span> <span class="string">&#x27;/etc/nginx/conf.d/default.conf&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Started</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写templates</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/templates/nginx.conf.j2</span><br><span class="line">user  &#123;&#123; web_user &#125;&#125;;</span><br><span class="line">worker_processes  &#123;&#123; ansible_processor_count * 1 &#125;&#125;;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  &#123;&#123; ansible_processor_count * 1024 &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/templates/default.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen       &#123;&#123; nginx_port &#125;&#125;;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           /usr/share/nginx/html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_pass   unix:/etc/nginx/php-fpm.sock;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">    # concurs with nginx&#x27;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx_port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="8-9-配置web端php服务"><a href="#8-9-配置web端php服务" class="headerlink" title="8.9 配置web端php服务"></a>8.9 配置web端php服务</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim php/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">PHP</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http://rpms.remirepo.net/enterprise/remi-release-7.rpm</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; php &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-cli&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-common&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-devel&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-embedded&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-gd&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-mcrypt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-mbstring&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pdo&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-xml&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-mysqlnd&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-opcache&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pecl-memcached&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pecl-redis&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-pecl-mongodb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">www.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_route &#125;&#125;</span>/php-fpm.d/www.conf&quot;</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim php/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写files</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim php/files/www.conf.j2</span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = /etc/nginx/php-fpm.sock</span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line">listen.mode = 0660</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim php/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">php:</span> <span class="string">php74</span></span><br><span class="line"><span class="attr">php_version:</span> <span class="string">php74-php</span></span><br><span class="line"><span class="attr">php_route:</span> <span class="string">/etc/opt/remi/php74</span></span><br></pre></td></tr></table></figure>

<h3 id="8-10-配置web端nfs服务"><a href="#8-10-配置web端nfs服务" class="headerlink" title="8.10 配置web端nfs服务"></a>8.10 配置web端nfs服务</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_client/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Mount</span> <span class="string">NFS</span> <span class="string">Share</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">mount:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; nfs_server_ip &#125;&#125;</span>:<span class="template-variable">&#123;&#123; nfs_share_directory &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">opts:</span> <span class="string">defaults</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">mounted</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_client/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nfs_share_directory:</span> <span class="string">/root/nfs_share</span></span><br></pre></td></tr></table></figure>

<h3 id="8-11-配置web端kodcloud"><a href="#8-11-配置web端kodcloud" class="headerlink" title="8.11 配置web端kodcloud"></a>8.11 配置web端kodcloud</h3><ol>
<li>编写tasks</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/tasks/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Kodcloud</span> <span class="string">Directory</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/usr/share/nginx/html/kodcloud</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0777</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Input</span> <span class="string">Kodcloud</span> <span class="string">File</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; kod_version &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/usr/share/nginx/html/kodcloud</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0777</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">Virtual</span> <span class="string">Host</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">kodcloud.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/conf.d/kodcloud.conf</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写handlers</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/handlers/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">and</span> <span class="string">PHP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; php_version &#125;&#125;</span>-fpm&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写vars</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/vars/main.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kod_version:</span> <span class="string">kodbox.1.15.zip</span></span><br><span class="line"><span class="attr">php_version:</span> <span class="string">php74-php</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写files</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://static.kodcloud.com/update/download/kodbox.1.15.zip kodcloud/files/kodbox.1.15.zip</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim kodcloud/files/kodcloud.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html/kodcloud;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-12-执行playbook"><a href="#8-12-执行playbook" class="headerlink" title="8.12 执行playbook"></a>8.12 执行playbook</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts kod.yml</span><br></pre></td></tr></table></figure>

<h3 id="8-13-测试"><a href="#8-13-测试" class="headerlink" title="8.13 测试"></a>8.13 测试</h3><ol>
<li>登录到web安装kodcloud</li>
</ol>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%B8%80.png" alt="kod安装一"></p>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%BA%8C.png" alt="kod安装二"></p>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%B8%89.png" alt="kod安装三"></p>
<ol start="2">
<li>登录kodcloud</li>
</ol>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E5%9B%9B.png" alt="kod安装四"></p>
<p><img src="/2024/02/18/ansible/kod%E5%AE%89%E8%A3%85%E4%BA%94.png" alt="kod安装五"></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">Previous</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/page/3/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Warner"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">16</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">15</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqmmm/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T09:39:48.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/%E9%A6%96%E9%A1%B5/">首页</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/cka/">CKA</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/docker/">Docker</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/elk/">ELK</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/jenkins/">Jenkins</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">首页</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2024 Warner</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>