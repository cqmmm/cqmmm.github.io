<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Warner&#039;s Wiki"><meta property="og:url" content="https://cqmmm.github.io/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cqmmm.github.io/img/og_image.png"><meta property="article:author" content="Warner"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cqmmm.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cqmmm.github.io"},"headline":"Warner's Wiki","image":["https://cqmmm.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Warner"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://cqmmm.github.io/logo.jpg"}},"description":""}</script><link rel="icon" href="/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:01:00.205Z" title="2/18/2024, 7:01:00 PM">2024-02-18</time></span><span class="level-item">28 minutes read (About 4127 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/redis/">Redis</a></p><div class="content"><h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>REmote DIctionary Server（Redis）是一个由 Salvatore Sanfilippo 写的 key-value 存储系统，是跨平台的非关系型数据库。</p>
<p><img src="/2024/02/18/redis/redis_logo.jpeg" alt="redis_logo"></p>
<p>Redis 就是一款 NoSQL，而 NoSQL 就是指非关系型数据库，主要分为四种：</p>
<ol>
<li>键值型：Redis</li>
<li>文档型：ElasticSearch、Mongdb</li>
<li>面向列：Hbase</li>
<li>图形化：Neo4j</li>
</ol>
<h2 id="二、Redis基础"><a href="#二、Redis基础" class="headerlink" title="二、Redis基础"></a>二、Redis基础</h2><h3 id="2-1-Redis安装"><a href="#2-1-Redis安装" class="headerlink" title="2.1 Redis安装"></a>2.1 Redis安装</h3><ol>
<li>通过 docker-compose 安装 redis</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入容器内部测试 redis</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接redis</span></span><br><span class="line">redis-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span>新建键值对</span></span><br><span class="line">set key value</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get获取键值</span></span><br><span class="line">get key</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Redis常用命令"><a href="#2-2-Redis常用命令" class="headerlink" title="2.2 Redis常用命令"></a>2.2 Redis常用命令</h3><p>redis 的数据存储结构有以下几种：</p>
<ul>
<li>key-string（字符串）：一个 key 对应一个值</li>
<li>key-hash（哈希）：一个 key 对应一个 map</li>
<li>key-list（列表）：一个 key 对应一个列表</li>
<li>key-set（集合）：一个 key 对应一个集合</li>
<li>key-zset（有序集合）：一个 key 对应一个有序的集合</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%80.png" alt="redis一"></p>
<h4 id="2-2-1-string常用命令"><a href="#2-2-1-string常用命令" class="headerlink" title="2.2.1 string常用命令"></a>2.2.1 string常用命令</h4><ol>
<li>设置值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set key value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>取值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>批量操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mset key1 value1 key2 value2 ...</span><br><span class="line">mget key1 key2 ... </span><br></pre></td></tr></table></figure>

<ol start="4">
<li>自增</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incr key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>自减</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decr key</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>自增自减指定数量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">incrby key number</span><br><span class="line">decrby key number</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>设置值的同时指定生存时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key seconds value</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>设置值，如果当前 key 不存在如同 set，如果存在则说明都不做</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setex key value</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>在 key 对应的 value 后追加内容</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append key value</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>查看 value 字符串长度</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-hash常用命令"><a href="#2-2-2-hash常用命令" class="headerlink" title="2.2.2 hash常用命令"></a>2.2.2 hash常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hset key field value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hget key field</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>批量操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hmset key1 field1 value1 field2 value2 ...</span><br><span class="line">hmget key1 firle1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>指定自增</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hincrby key field number</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>设置值，如果当前 key 不存在如同 set，如果存在则说明都不做</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hsetnx key field value</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>检查 field 是否存在</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexists key field</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>删除某个 field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdel key field1 field2 ...</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>获取当前 hash 结构中的全部 field 和 value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgetall key</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>获取当前 hash 结构中的全部 field</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hkeys key</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>获取当前 hash 结构中的全部 value</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hvals key</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>获取当前 hash 中 field 的数量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hlen key</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-list常用命令"><a href="#2-2-3-list常用命令" class="headerlink" title="2.2.3 list常用命令"></a>2.2.3 list常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从左侧插入数据</span></span><br><span class="line">lpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从右侧插入数据</span></span><br><span class="line">rpush key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果key不存在，什么都不做，如果key存在但不是list结构，也什么都不做</span></span><br><span class="line">lpushx key value1 value2 ...</span><br><span class="line">rpushx key value1 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过索引位置添加value</span></span><br><span class="line">lset key index value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">左侧弹出数据并移除</span></span><br><span class="line">lpop key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">右侧弹出数据并移除</span></span><br><span class="line">rpop key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取一定范围的数据，start从0开始，stop为-1时为最后一个value，-2时为倒数第二个value</span></span><br><span class="line">lrange key start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据索引位置获取value</span></span><br><span class="line">lindex key index</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取整个list的长度</span></span><br><span class="line">llen key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除list中count个value的值，当count&gt;0，从左向右删除，但count&lt;0，从右向左删除，但count==0，全部删除</span></span><br><span class="line">lrem key count value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保留列表中指定范围内的数据，超出这个范围的都会被移除</span></span><br><span class="line">ltrim start stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将list1中的最后一个数据弹出，插入到list2中的第一个位置</span></span><br><span class="line">rpoplpush key1 key2</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-set常用命令"><a href="#2-2-4-set常用命令" class="headerlink" title="2.2.4 set常用命令"></a>2.2.4 set常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">value不允许重复，且数据无序排列</span></span><br><span class="line">sadd key value1 value2 ...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取全部数据</span></span><br><span class="line">smembers key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">随机获取数据，并移除，可加弹出数量</span></span><br><span class="line">spop key number</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的交集</span></span><br><span class="line">sinter key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的并集</span></span><br><span class="line">sunion key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取多个<span class="built_in">set</span>的差集</span></span><br><span class="line">sdiff key1 key2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前<span class="built_in">set</span>是否包含某个值</span></span><br><span class="line">sismember key value</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5-zset常用命令"><a href="#2-2-5-zset常用命令" class="headerlink" title="2.2.5 zset常用命令"></a>2.2.5 zset常用命令</h4><ol>
<li>存储数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">score必须是数值，value不允许重复</span></span><br><span class="line">zadd key score1 value1 score2 value2 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改score，如果value存在则增加分数，如果不存在则相当于zadd</span></span><br><span class="line">zincrby key number value</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看指定value的分数</span></span><br><span class="line">zscore key value</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取value数量</span></span><br><span class="line">zcard key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据score范围查询value数量</span></span><br><span class="line">zcount key min max</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据分数从小到大排序，获取指定范围内的数据，添加了withscores参数会返回value的具体score</span></span><br><span class="line">zrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从大到小</span></span><br><span class="line">zrevrange key start stop withscores</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据分数的范围获取数据，如果不希望包括min和max的值可以用(min max)的方式，最大最小值用±inf表示</span></span><br><span class="line">zrangebyscore key min max withscores [limit,offset,count]</span><br><span class="line">zrevrangebyscore key max min withscores [limit,offset,count]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrem key value1 value2 ...</span><br></pre></td></tr></table></figure>

<h4 id="2-2-6-key常用命令"><a href="#2-2-6-key常用命令" class="headerlink" title="2.2.6 key常用命令"></a>2.2.6 key常用命令</h4><ol>
<li>查看所有key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看某个key是否存在</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del key</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>设置key的生存时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位为s</span></span><br><span class="line">expire key seconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位为ms</span></span><br><span class="line">pexpire key milliseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定生存到某个时间点</span></span><br><span class="line">expireat key timestamp</span><br><span class="line">pexpireat key millseconds</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看key的剩余生存时间，返回-2则key不存在，-1则没设置生存时间</span></span><br><span class="line">ttl key</span><br><span class="line">pttl key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除生存时间</span></span><br><span class="line">persist key</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>选择操作的库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis默认有16个库</span></span><br><span class="line">select 0~15</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动key到另一个库中</span></span><br><span class="line">move key db</span><br></pre></td></tr></table></figure>

<h4 id="2-2-7-库的常用命令"><a href="#2-2-7-库的常用命令" class="headerlink" title="2.2.7 库的常用命令"></a>2.2.7 库的常用命令</h4><ol>
<li>清空当前所在数据库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdb</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>清空所有数据库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flushdball</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看当前库有多少key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbsize</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>查看最后一次操作的时间</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lastsave</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>实时监控redis接收到的命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monitor</span><br></pre></td></tr></table></figure>



<h2 id="三、Redis配置"><a href="#三、Redis配置" class="headerlink" title="三、Redis配置"></a>三、Redis配置</h2><h3 id="3-1-Redis的AUTH"><a href="#3-1-Redis的AUTH" class="headerlink" title="3.1 Redis的AUTH"></a>3.1 Redis的AUTH</h3><ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置 Redis 连接密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">requirepass toortoor</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入 Redis 之后都需要输入密码才可以创建 key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">auth toortoor</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Redis的事务"><a href="#3-2-Redis的事务" class="headerlink" title="3.2 Redis的事务"></a>3.2 Redis的事务</h3><p>Redis 事务可以一次执行多个命令， 并且带有以下三个重要的保证：</p>
<ul>
<li>批量操作在发送 EXEC 命令前被放入队列缓存</li>
<li>收到 EXEC 命令后进入事务执行，事务中任意命令执行失败，其余的命令依然被执行</li>
<li>在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中</li>
</ul>
<p>一个事务从开始到执行会经历以下几个阶段：</p>
<ul>
<li>开始事务：multi</li>
<li>命令入队：……</li>
<li>执行事务：exec</li>
<li>取消事务：discard</li>
<li>监听：在开启事务之前，先通过 watch 监听事务中要操作的 key，如果在事务过程中有其他的客户端修改了 key，那么事务将会被取消</li>
</ul>
<p>事务可以理解为一个打包的批量执行脚本，但批量指令并非原子化的操作，中间某条指令的失败不会导致前面已做指令的回滚，也不会造成后续的指令不做。</p>
<ol>
<li>监听</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch name age gander</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>开始事务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>命令入队</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line">set gander male</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>执行事务&#x2F;取消事务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec/discard</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Redis的持久化"><a href="#3-3-Redis的持久化" class="headerlink" title="3.3 Redis的持久化"></a>3.3 Redis的持久化</h3><h4 id="3-3-1-RDB持久化"><a href="#3-3-1-RDB持久化" class="headerlink" title="3.3.1 RDB持久化"></a>3.3.1 RDB持久化</h4><p>Redis 的配置文件位于 Redis 安装目录,	ROB 是默认的持久化机制。</p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="comment"># 加载redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis.conf</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">redis.conf</span></span><br><span class="line"><span class="comment"># 在900秒内有1一个 key 发生了变化，就执行 RDB 持久化</span></span><br><span class="line"><span class="string">save</span> <span class="number">900</span> <span class="number">1</span></span><br><span class="line"><span class="string">save</span> <span class="number">300</span> <span class="number">10</span></span><br><span class="line"><span class="string">save</span> <span class="number">60</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># 开启RDB持久化</span></span><br><span class="line"><span class="string">rdbchecksum</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># RDB持久化名称</span></span><br><span class="line"><span class="string">dbfilename</span> <span class="string">dump.rdb</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试持久化</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set name cqm</span><br><span class="line">set age 22</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭redis并保存</span></span><br><span class="line">shutdown save</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>可以看到 data 目录下多了个 rdb 文件，即使 redis 容器重启也不会造成 key 的丢失</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%8C.png" alt="redis二"></p>
<h4 id="3-3-2-AOF持久化"><a href="#3-3-2-AOF持久化" class="headerlink" title="3.3.2 AOF持久化"></a>3.3.2 AOF持久化</h4><p>AOF 比起 RDB 有更高的数据安全性，如果同时开启了 AOF 和 RDB，那么前者比后者的优先级更高，且如果先开启了 RDB 在开启 AOF，那么 RDB 中的内容会被 AOF 的内容覆盖。</p>
<ol>
<li>redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启AOF持久化</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF文件名</span></span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF持久化执行策略</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">always:每次执行写操作都调用fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">everysec:最多每秒调用一次fsync</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no:根据环境的不同在不确定的时间调用fsync</span></span><br><span class="line">appendfsync always|everysec|no</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>重启 docker-compose 测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set gander male</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不RDB持久化</span></span><br><span class="line">shutdown nosave</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以看到 data 目录下多了个 aof 文件，即 AOF 持久化生成的文件</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%B8%89.png" alt="redis三"></p>
<h3 id="3-4-Redis主从架构"><a href="#3-4-Redis主从架构" class="headerlink" title="3.4 Redis主从架构"></a>3.4 Redis主从架构</h3><p>Redis 的主从架构是指 Master 节点负责写操作，而其余的 Slave 节点负责读操作。</p>
<p><img src="/2024/02/18/redis/redis%E5%9B%9B.png" alt="redis四"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="comment"># 连接redis-master容器，并将该容器ip地址映射为master</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>从节点 redis.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slaveof &lt;主节点地址&gt; &lt;端口&gt;</span></span><br><span class="line">slaveof master 6379</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动后进入容器内部通过 <code>info</code> 可看到节点信息</li>
</ol>
<p><img src="/2024/02/18/redis/redis%E4%BA%94.png" alt="redis五"></p>
<h3 id="3-5-Redis哨兵模式"><a href="#3-5-Redis哨兵模式" class="headerlink" title="3.5 Redis哨兵模式"></a>3.5 Redis哨兵模式</h3><p>Redis 的主从架构有一个很明显的问题，就是当 Master 节点出现问题宕机后，那么 Redis 集群就没有可以进行写操作的 Redis 了，而哨兵就可以解决该问题。</p>
<p>在每个节点中都会有个哨兵与 Redis 进行连接，且哨兵与哨兵之间也会进行连接，如果 Master 节点出现故障宕机了，那么哨兵们就会选出一个 Slave 来作为新的 Master 来提供写的操作。</p>
<p><img src="/2024/02/18/redis/redis%E5%85%AD.png" alt="redis六"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data1:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel1.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data2:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel2.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data3:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sentinel3.conf:/data/sentinel.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-master:master</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Master 节点 sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以守护进程的方式运行redis</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定Master节点，sentinel monitor &lt;名称&gt; &lt;ip&gt; &lt;端口&gt; &lt;Slave个数&gt;</span></span><br><span class="line">sentinel monitor master localhost 6379 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定哨兵每隔多久检测一次redis主从架构</span></span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Slave 节点 sentinel.conf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">sentinel monitor master master 6379 2</span><br><span class="line">sentinel down-after-milliseconds master 10000</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>进入容器启动哨兵，当 Master 节点出现问题后，就会在两个 Slave 中选出一个作为新的 Master，而旧的 Master 启动后就会变为新的 Slave</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel /data/sentinel.conf</span><br></pre></td></tr></table></figure>

<h3 id="3-6-Redis集群"><a href="#3-6-Redis集群" class="headerlink" title="3.6 Redis集群"></a>3.6 Redis集群</h3><p>Redis 集群在保证主从和哨兵的基本功能之外，还能提高 Redis 存储数据的能力，主要的特点如下</p>
<ul>
<li>Redis 集群是无中心的</li>
<li>Redis 集群有ping-pang的机制</li>
<li>投票机制，集群节点的数量必须是 2n+1</li>
<li>分配了 16484 个 hash 槽，在存储数据时，会对 key 进行 crc16 的算法，并对 16384 进行取余，通过结果分配到对应的节点上，每个节点都有自己维护的 hash 槽</li>
<li>每个主节点都要跟一个从节点，但这里的从节点只管备份，不管查询</li>
<li>集群中半数的节点宕机后，那么集群就瘫痪</li>
</ul>
<p><img src="/2024/02/18/redis/redis%E4%B8%83.png" alt="redis七"></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis1:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17001</span><span class="string">:17001</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis1.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17002</span><span class="string">:17002</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis2.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis3:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17003</span><span class="string">:17003</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis3.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis4:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis4</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7004</span><span class="string">:7004</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17004</span><span class="string">:17004</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis4.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis5:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis5</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7005</span><span class="string">:7005</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17005</span><span class="string">:17005</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis5.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br><span class="line">  <span class="attr">redis6:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/library/redis:5.0.9</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7006</span><span class="string">:7006</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17006</span><span class="string">:17006</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/redis6.conf:/usr/local/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/redis/redis.conf&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>redis{1..6}.conf，x 为 {1..6}</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定redis端口</span></span><br><span class="line"><span class="string">port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line"><span class="string">cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># 集群信息文件</span></span><br><span class="line"><span class="string">cluster-config-file</span> <span class="string">nodes-700x.conf</span></span><br><span class="line"><span class="comment"># 集群对外ip</span></span><br><span class="line"><span class="string">cluster-announce-ip</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.135</span></span><br><span class="line"><span class="comment"># 集群对外端口</span></span><br><span class="line"><span class="string">cluster-announce-port</span> <span class="string">700x</span></span><br><span class="line"><span class="comment"># 集群总线端口</span></span><br><span class="line"><span class="string">cluster-announce-bus-port</span> <span class="string">1700x</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入任意 reids 容器创建集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--cluster-replicas:每个主节点分配的从节点个数</span></span><br><span class="line">redis-cli --cluster create 192.168.88.135:7001 192.168.88.135:7002 192.168.88.135:7003 192.168.88.135:7004 192.168.88.135:7005 192.168.88.135:7006 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>由于每个主节点都被分配了不同的 hash 槽，所以要在容器内任意切换不同的 redis 节点需要加参数 <code>-c</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.88.135 -p 7001 -c</span><br></pre></td></tr></table></figure>



<h2 id="四、Redis常见问题"><a href="#四、Redis常见问题" class="headerlink" title="四、Redis常见问题"></a>四、Redis常见问题</h2><h3 id="4-1-Redis的删除策略"><a href="#4-1-Redis的删除策略" class="headerlink" title="4.1 Redis的删除策略"></a>4.1 Redis的删除策略</h3><p>当 key 的生存时间到了，Redis 并不会立即删除该 key，而是遵守以下删除策略来进行删除</p>
<ul>
<li>定期删除：Redis 每隔一段时间就回去查看设置了生存时间的 key，默认是 100ms 查看 3 个 key</li>
<li>惰性删除：当用户去查询已经超过了生存时间的 key，Redis 会先查看该 key 是否已经超过了生存时间，如果超过，那么 Redis 会将该 key 删除并给用户返回一个空值</li>
</ul>
<h3 id="4-2-Redis的淘汰机制"><a href="#4-2-Redis的淘汰机制" class="headerlink" title="4.2 Redis的淘汰机制"></a>4.2 Redis的淘汰机制</h3><p>当 Redis 内存满的时候添加了一个新的数据，那么就会执行 Redis 的淘汰机制，通过 <code>maxmemory-policy</code> 来设置，参数如下</p>
<ol>
<li><p>volatile-lru：当内存不足时，会删除一个设置了生存时间且最近最少使用的 key</p>
</li>
<li><p>allkeys-lru：当内存不足时，会删除一个设置了最近最少使用的 key</p>
</li>
<li><p>volatile-lfu：当内存不足时，会删除一个设置了生存时间且最近使用频率最低的 key</p>
</li>
<li><p>allkeys-lfu：当内存不足时，会删除一个设置了最近使用频率最低的 key</p>
</li>
<li><p>volatile-random：当内存不足时，会随机删除一个设置了生存时间的 key</p>
</li>
<li><p>allkeys-random：当内存不足时，会随机删除一个 key</p>
</li>
<li><p>volatile-ttl：当内存不足时，会删除一个生存时间最少的 key</p>
</li>
<li><p>noeviction：内存不足时，直接报错</p>
</li>
</ol>
<h3 id="4-3-缓存问题"><a href="#4-3-缓存问题" class="headerlink" title="4.3 缓存问题"></a>4.3 缓存问题</h3><p><strong>缓存穿透</strong></p>
<p>当客户查询的数据 Redis 中没有，数据库中也没有，且请求量特别大时，就会导致数据库的压力过大，解决方法如下</p>
<ul>
<li>根据 id 查询时，如果 id 是自增的，那么可以将最大的 id 放到 Reids 中，当查询数据时直接对比 id 即可</li>
<li>如果 id 不是 int 型，那么可以将全部的 id 放入 set 中，用户查询之前可以先到 set 查看是否有该 id</li>
<li>获取用户的 ip 地址，对该地址进行访问限制</li>
</ul>
<p><strong>缓存击穿</strong></p>
<p>当用户查询的是热点数据时，那么并发量肯定是很高的，当 Redis 中的热点数据过期了，那么数据库的压力就会很大，甚至宕机，解决方法如下</p>
<ul>
<li>在访问热点数据时，缓存中没有的时候，可以添加一把锁，让几个请求去访问数据库，避免数据库宕机</li>
<li>把热点数据的生存时间去掉</li>
</ul>
<p><strong>缓存雪崩</strong></p>
<p>当大量缓存同时到期时，导致请求都去到了数据库，也很容易导致数据库宕机，解决方法如下</p>
<ul>
<li>对缓存中的数据设置一个随机的生存时间，避免同时过期</li>
</ul>
<p><strong>缓存倾斜</strong></p>
<p>如果将热点数据放在集群中的某一 Redis 节点上时，那么大量的数据都会去到该 Redis 节点，导致节点宕机，解决方法如下</p>
<ul>
<li>主从架构，准备大量的从节点</li>
<li>在 Tomcat 中做 JVM 缓存，在查询 Redis 前先查询 JVM 缓存</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T10:59:55.157Z" title="2/18/2024, 6:59:55 PM">2024-02-18</time></span><span class="level-item">41 minutes read (About 6094 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/mysql/">MySQL</a></p><div class="content"><p>MySQL 是一款关系型数据库管理系统。</p>
<p><img src="/2024/02/18/mysql/logo.png" alt="logo"></p>
<h2 id="一、MySQL基础"><a href="#一、MySQL基础" class="headerlink" title="一、MySQL基础"></a>一、MySQL基础</h2><h3 id="1-1-安装MySQL"><a href="#1-1-安装MySQL" class="headerlink" title="1.1 安装MySQL"></a>1.1 安装MySQL</h3><p><strong>docker-compose</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7.35</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">toortoor</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">adminer:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">adminer:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-基础SQL语句"><a href="#1-2-基础SQL语句" class="headerlink" title="1.2 基础SQL语句"></a>1.2 基础SQL语句</h3><ol>
<li>刷新权限</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>数据库基本操作</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建</span></span><br><span class="line"><span class="keyword">create</span> database [if <span class="keyword">not</span> <span class="keyword">exists</span>] `db_name`;</span><br><span class="line"><span class="comment">-- 删除</span></span><br><span class="line"><span class="keyword">drop</span> database [if <span class="keyword">exists</span>] `db_name`;</span><br><span class="line"><span class="comment">-- 使用</span></span><br><span class="line">use `db_name`;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>表基本操作</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> [if <span class="keyword">not</span> <span class="keyword">exists</span>] `table_name`;</span><br><span class="line"><span class="comment">-- 删除</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> [if <span class="keyword">exists</span>] `table_name`;</span><br><span class="line"><span class="comment">-- 查看</span></span><br><span class="line"><span class="keyword">describe</span> `table_name`;</span><br><span class="line"><span class="comment">-- 创建一个学生表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> `students`(</span><br><span class="line">    <span class="comment">-- 创建id列，数据类型为4位的int类型，不允许为空，自增 </span></span><br><span class="line">    `id` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment comment <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    <span class="comment">-- 创建name列，数据类型为30位的varchar类型，不允许为空，默认值为匿名</span></span><br><span class="line">    `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;匿名&#x27;</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    `pwd` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;123456&#x27;</span> comment <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">    `gender` <span class="type">varchar</span>(<span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;女&#x27;</span> comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    <span class="comment">-- 创建birthday列，datetime类型，默认为空</span></span><br><span class="line">    `brithday` datetime <span class="keyword">default</span> <span class="keyword">null</span> comment <span class="string">&#x27;出生日期&#x27;</span>,</span><br><span class="line">    `address` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="keyword">null</span> comment <span class="string">&#x27;家庭住址&#x27;</span>,</span><br><span class="line">    `email` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">default</span> <span class="keyword">null</span> comment <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">    <span class="comment">-- 设置主键，一般一个表只有一个主键</span></span><br><span class="line">    <span class="keyword">primary</span> key(`id`)</span><br><span class="line">)</span><br><span class="line"><span class="comment">-- 设置引擎</span></span><br><span class="line">engine<span class="operator">=</span>innodb</span><br><span class="line"><span class="comment">-- 默认编码</span></span><br><span class="line"><span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改表</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改表名称</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` rename <span class="keyword">as</span> new_`table_name`;</span><br><span class="line"><span class="comment">-- 增加字段</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` <span class="keyword">add</span> age <span class="type">int</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">-- 修改约束</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` modify age <span class="type">varchar</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">-- 重命名字段</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` change age new_age <span class="type">int</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">-- 删除字段</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` <span class="keyword">drop</span> age;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>查看创建语句</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> database `db_name`;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> `table_name`;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-引擎INNODB和MYISAM区别"><a href="#1-3-引擎INNODB和MYISAM区别" class="headerlink" title="1.3 引擎INNODB和MYISAM区别"></a>1.3 引擎INNODB和MYISAM区别</h3><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="center">INNODB</th>
<th align="center">MYISAM</th>
</tr>
</thead>
<tbody><tr>
<td align="center">事务</td>
<td align="center">支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td align="center">数据行锁定</td>
<td align="center">支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td align="center">外键</td>
<td align="center">支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td align="center">全文索引</td>
<td align="center">不支持</td>
<td align="center">支持</td>
</tr>
<tr>
<td align="center">空间占用</td>
<td align="center">约为MYSIAM的2倍</td>
<td align="center">较小</td>
</tr>
</tbody></table>
<p><strong>不同引擎在文件上的区别</strong></p>
<ul>
<li>innodb：<ul>
<li><code>*.frm</code>：表结构定义文件</li>
<li><code>ibdata1</code>：数据文件</li>
</ul>
</li>
<li>mysiam：<ul>
<li><code>*.frm</code>：表结构定义文件</li>
<li><code>*.MYD</code>：数据文件</li>
<li><code>*.MYI</code>：索引文件</li>
</ul>
</li>
</ul>
<h2 id="二、MySQL数据操作"><a href="#二、MySQL数据操作" class="headerlink" title="二、MySQL数据操作"></a>二、MySQL数据操作</h2><h3 id="2-1-外键"><a href="#2-1-外键" class="headerlink" title="2.1 外键"></a>2.1 外键</h3><p>外键就是一个表的某一列去引用另一个表的某一列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 该示例为students中的grade_id列引用grade中的grade_id列</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `grade`(</span><br><span class="line">    `grade_id` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment comment <span class="string">&#x27;年级&#x27;</span></span><br><span class="line">    <span class="keyword">primary</span> key(`grade_id`)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `students`(  </span><br><span class="line">    `id` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment comment <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;匿名&#x27;</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    `grade_id` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;年级&#x27;</span>,</span><br><span class="line">    <span class="keyword">primary</span> key(`id`),</span><br><span class="line">    <span class="comment">-- 定义外键</span></span><br><span class="line">    key `FK_grade_id` (`grade_id`),</span><br><span class="line">    <span class="comment">-- 给外键添加约束</span></span><br><span class="line">    <span class="keyword">constraint</span> `FK_grade_id` <span class="keyword">foreign</span> key (`grade_id`) <span class="keyword">references</span> `grade` (`grade_id`)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8</span><br></pre></td></tr></table></figure>

<p>如果要给已经存在的表添加外键</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` <span class="keyword">add</span> <span class="keyword">constraint</span> `FK_name` <span class="keyword">foreign</span> key (`列名称`) <span class="keyword">references</span> `引用的表名` (`引用的列名称`)</span><br></pre></td></tr></table></figure>

<p>删除外键</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` <span class="keyword">drop</span> <span class="keyword">foreign</span> key <span class="string">&#x27;FK_name&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-DML数据操纵语言"><a href="#2-2-DML数据操纵语言" class="headerlink" title="2.2 DML数据操纵语言"></a>2.2 DML数据操纵语言</h3><h4 id="2-2-1-insert"><a href="#2-2-1-insert" class="headerlink" title="2.2.1 insert"></a>2.2.1 insert</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `table_name`(`字段<span class="number">1</span>`,`字段<span class="number">2</span>`,`字段<span class="number">3</span>`) <span class="keyword">values</span>(<span class="string">&#x27;值1&#x27;</span>),(<span class="string">&#x27;值2&#x27;</span>),(<span class="string">&#x27;值3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `students`(`name`) <span class="keyword">values</span>(<span class="string">&#x27;cqm&#x27;</span>),(<span class="string">&#x27;lwt&#x27;</span>);</span><br><span class="line"><span class="comment">-- 字段可以省略，但后面的值必须一一对应</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `students`(`name`,`pwd`,`email`) <span class="keyword">values</span>(<span class="string">&#x27;lwt&#x27;</span>,<span class="string">&#x27;111&#x27;</span>,<span class="string">&#x27;lwt@qq.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-update"><a href="#2-2-2-update" class="headerlink" title="2.2.2 update"></a>2.2.2 update</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 如果不指定条件，那么会修改所有的值</span></span><br><span class="line"><span class="keyword">update</span> `table_name` <span class="keyword">set</span> `字段`<span class="operator">=</span><span class="string">&#x27;值&#x27;</span> <span class="keyword">where</span> 条件;</span><br><span class="line"><span class="comment">-- 条件可以是 =|&lt;|&gt;|!=|between|and|or 等等</span></span><br><span class="line"><span class="keyword">update</span> `students` <span class="keyword">set</span> `name`<span class="operator">=</span><span class="string">&#x27;handsome_cqm&#x27;</span> <span class="keyword">where</span> `id`<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">update</span> `students` <span class="keyword">set</span> `name`<span class="operator">=</span><span class="string">&#x27;cqm&#x27;</span> <span class="keyword">where</span> `name`<span class="operator">=</span><span class="string">&#x27;handsome_cqm&#x27;</span></span><br><span class="line"><span class="keyword">update</span> `students` <span class="keyword">set</span> `name`<span class="operator">=</span><span class="string">&#x27;newlwt&#x27;</span>,`email`<span class="operator">=</span><span class="string">&#x27;new@qq.com&#x27;</span> <span class="keyword">where</span> `name`<span class="operator">=</span><span class="string">&#x27;lwt&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> `students` <span class="keyword">set</span> `name`<span class="operator">=</span><span class="string">&#x27;cqm&#x27;</span> <span class="keyword">where</span> id <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">and</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-delete"><a href="#2-2-3-delete" class="headerlink" title="2.2.3 delete"></a>2.2.3 delete</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> `table_name` <span class="keyword">where</span> 条件;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> `students` <span class="keyword">where</span> `id`<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 清空表</span></span><br><span class="line"><span class="keyword">truncate</span> `table_name`;</span><br></pre></td></tr></table></figure>

<p><strong>delete</strong> 和 <strong>truncate</strong> 区别：</p>
<ul>
<li>都可以清空表，都不会删除表结构</li>
<li><strong>truncate</strong> 可以重置自增列，且不会影响事务</li>
<li><strong>delete</strong> 清空表后，如果引擎是 <strong>innodb</strong>，重启数据库自增列就会变回1，因为是存储在内存中的；如果引擎是 <strong>myisam</strong>，则不会，因为是存储在文件中的</li>
</ul>
<h3 id="2-3-DQL数据库查询语言"><a href="#2-3-DQL数据库查询语言" class="headerlink" title="2.3 DQL数据库查询语言"></a>2.3 DQL数据库查询语言</h3><h4 id="2-3-1-select"><a href="#2-3-1-select" class="headerlink" title="2.3.1 select"></a>2.3.1 select</h4><ol>
<li>查询所有数据</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `table_name`;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查询某列数据</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> `name`,`gander` <span class="keyword">from</span> `students`;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>给字段结果起别名</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> `name` <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,`gender` <span class="keyword">as</span> <span class="string">&#x27;性别&#x27;</span> <span class="keyword">from</span> `students`;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>concat 函数</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> concat(<span class="string">&#x27;姓名：&#x27;</span>,`name`) <span class="keyword">from</span> `students`;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>去重</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> `字段` <span class="keyword">from</span> `table_name`</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>批量操作数据</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> `score`<span class="operator">+</span><span class="number">1</span> <span class="keyword">as</span> `new_score` <span class="keyword">from</span> `table_name`;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-where"><a href="#2-3-2-where" class="headerlink" title="2.3.2 where"></a>2.3.2 where</h4><ol>
<li>逻辑运算符运用</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> `score` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> `score` <span class="operator">&gt;=</span> <span class="number">95</span> <span class="keyword">and</span> `score` <span class="operator">&lt;=</span> <span class="number">100</span>;</span><br><span class="line"><span class="keyword">select</span> `score` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> `score` <span class="keyword">between</span> <span class="number">95</span> <span class="keyword">and</span> <span class="number">100</span>;</span><br><span class="line"><span class="keyword">select</span> `score` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> <span class="keyword">not</span> `score` <span class="operator">!=</span> <span class="number">95</span> <span class="keyword">and</span> `score` <span class="operator">!=</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>模糊查询</li>
</ol>
<table>
<thead>
<tr>
<th align="center">运算符</th>
<th align="center">语法</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">is null</td>
<td align="center">a is null</td>
<td align="center">a 为空，结果为真</td>
</tr>
<tr>
<td align="center">is not null</td>
<td align="center">a is not null</td>
<td align="center">a 不为空，结果为真</td>
</tr>
<tr>
<td align="center">between</td>
<td align="center">a between b and c</td>
<td align="center">若 a 在 b 和 c 之间，结果为真</td>
</tr>
<tr>
<td align="center">like</td>
<td align="center">a like b</td>
<td align="center">如果 a 匹配 b，结果为真</td>
</tr>
<tr>
<td align="center">in</td>
<td align="center">a in ( b,c,d,e )</td>
<td align="center">如果 a 在某个集合中的值相同，结果为真</td>
</tr>
</tbody></table>
<p>查找花名册中姓陈的名字</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- %:匹配一个或多个字符</span></span><br><span class="line"><span class="comment">-- _:匹配一个字符</span></span><br><span class="line"><span class="keyword">select</span> `name` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> `name` <span class="keyword">like</span> <span class="string">&#x27;陈%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> `name` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> `name` <span class="keyword">like</span> <span class="string">&#x27;陈_明&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>查找特定学号的信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> `name` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> `id` <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>查找地址为空或不空的同学</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> `name` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> `address` <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">select</span> `name` <span class="keyword">from</span> `table_name` <span class="keyword">where</span> `address` <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-联表查询"><a href="#2-3-3-联表查询" class="headerlink" title="2.3.3 联表查询"></a>2.3.3 联表查询</h4><p>联表查询包括：</p>
<ul>
<li>inner（内连接）：如果表中有至少一个匹配，则返回行</li>
<li>left（外连接）：即使右表中没有匹配，也从左表返回所有的行</li>
<li>right（外连接）：即使左表中没有匹配，也从右表返回所有的行</li>
<li>full（外连接）：只要其中一个表中存在匹配，则返回行</li>
</ul>
<p><strong>inner</strong> 实际就是取两个表的交集，例如有两个表，一个表有学生的基本信息，另一个表有学生的成绩，两个表都有学生的学号列，那么就可以联合起来查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> `name`,`subjectno`,`score` <span class="keyword">from</span> `students` <span class="keyword">inner</span> <span class="keyword">join</span> `<span class="keyword">result</span>` <span class="keyword">where</span> student.id <span class="operator">=</span> result.id</span><br></pre></td></tr></table></figure>

<p><strong>left</strong> 假设学生表中有 ccc 这么一个学生，但成绩表里没有 ccc 学生的成绩，如果使用了左连接，左表是学生表，右表是成绩表，那么也会返回 cqm 学生的值，显示为空</p>
<p><img src="/2024/02/18/mysql/leftjoin.png" alt="leftjoin"></p>
<p><strong>right</strong> 相反，如果成绩表里有个 ddd 学生的成绩，但学生表里没有这个学生的信息，如果使用了右连接，左表是学生表，右表是成绩表，那么也会返回 ddd 学生的成绩，注意这时候就看不到 ccc 学生的成绩信息了，因为左表中没有 ccc 学生的成绩信息</p>
<p><img src="/2024/02/18/mysql/rightjoin.png" alt="rightjoin"></p>
<p>通过联表查询就可以查出缺考的同学</p>
<p><img src="/2024/02/18/mysql/%E6%9F%A5%E8%AF%A2%E7%BC%BA%E8%80%83%E5%90%8C%E5%AD%A6.png" alt="查询缺考同学"></p>
<p>查询参加考试了的同学信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> `name` <span class="keyword">from</span> `students` <span class="keyword">right</span> <span class="keyword">join</span> `<span class="keyword">result</span>` <span class="keyword">on</span> students.id <span class="operator">=</span> result.id <span class="keyword">where</span> `score` <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>查询参加了考试的同学以及所对应的学科成绩</p>
<p><img src="/2024/02/18/mysql/%E6%9F%A5%E8%AF%A2%E5%AD%A6%E7%94%9F%E5%AF%B9%E5%BA%94%E5%AD%A6%E7%A7%91%E6%88%90%E7%BB%A9.png" alt="查询学生对应学科成绩"></p>
<h4 id="2-3-4-where和on的区别"><a href="#2-3-4-where和on的区别" class="headerlink" title="2.3.4 where和on的区别"></a>2.3.4 where和on的区别</h4><p>在进行联表查询的时候，数据库都会在中间生成一张临时表，在使用外连接时，on 和 where 区别如下：</p>
<ul>
<li><strong>on</strong> 条件是在生成临时表时使用的条件，它不管 <strong>on</strong> 中的条件是否为真，都会返回左边表中的记录。</li>
<li><strong>where</strong> 条件是在临时表生成好后，再对临时表进行过滤的条件。这时已经没有 <strong>left join</strong> 的含义（必须返回左边表的记录）了，条件不为真的就全部过滤掉。</li>
<li>如果是 <strong>inner join</strong>，则无区别</li>
</ul>
<h4 id="2-3-5-自连接"><a href="#2-3-5-自连接" class="headerlink" title="2.3.5 自连接"></a>2.3.5 自连接</h4><p>自连接实际上就是一张表与自己连接，将一张表拆为两张表</p>
<p><strong>原表</strong></p>
<table>
<thead>
<tr>
<th align="center">categoryid</th>
<th align="center">pid</th>
<th align="center">categoryname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">计算机科学与技术学院</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">心理学院</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">1</td>
<td align="center">体育学院</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">2</td>
<td align="center">python</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">3</td>
<td align="center">心理学</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">4</td>
<td align="center">短跑</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">4</td>
<td align="center">篮球</td>
</tr>
</tbody></table>
<p><strong>父类表</strong></p>
<table>
<thead>
<tr>
<th align="center">category</th>
<th align="center">categoryname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">2</td>
<td align="center">计算机科学与技术学院</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">心理学院</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">体育学院</td>
</tr>
</tbody></table>
<p><strong>子类表</strong></p>
<table>
<thead>
<tr>
<th align="center">category</th>
<th align="center">所属父类</th>
<th align="center">categoryname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">5</td>
<td align="center">计算机科学与技术学院</td>
<td align="center">python</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">心理学院</td>
<td align="center">心理学</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">体育学院</td>
<td align="center">短跑</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">体育学院</td>
<td align="center">篮球</td>
</tr>
</tbody></table>
<p><strong>自查询结果</strong></p>
<p><img src="/2024/02/18/mysql/%E8%87%AA%E8%BF%9E%E6%8E%A5.png" alt="自连接"></p>
<h4 id="2-3-6-分页和排序"><a href="#2-3-6-分页和排序" class="headerlink" title="2.3.6 分页和排序"></a>2.3.6 分页和排序</h4><p><strong>排序 order by</strong></p>
<ul>
<li>desc：降序</li>
<li>asc：升序</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 语法</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">desc</span><span class="operator">|</span><span class="keyword">asc</span></span><br></pre></td></tr></table></figure>

<p>查询语文成绩并排序</p>
<p><img src="/2024/02/18/mysql/%E6%8E%92%E5%BA%8F.png" alt="排序"></p>
<p><strong>分页 limit</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 语法</span></span><br><span class="line">limit 起始值,页面显示多少条数据</span><br></pre></td></tr></table></figure>

<p>打印第一页语文成绩</p>
<p><img src="/2024/02/18/mysql/%E5%88%86%E9%A1%B5%E7%AC%AC%E4%B8%80%E9%A1%B5.png" alt="分页第一页"></p>
<p>打印第二页数学成绩</p>
<p><img src="/2024/02/18/mysql/%E5%88%86%E9%A1%B5%E7%AC%AC%E4%BA%8C%E9%A1%B5.png" alt="分页第二页"></p>
<p>分页和排序配合起来就可以查询学生的前几名成绩，例如语文成绩前三名</p>
<p><img src="/2024/02/18/mysql/%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%96%87%E6%88%90%E7%BB%A9%E5%89%8D%E4%B8%89%E5%90%8D.png" alt="查询语文成绩前三名"></p>
<h4 id="2-3-7-子查询"><a href="#2-3-7-子查询" class="headerlink" title="2.3.7 子查询"></a>2.3.7 子查询</h4><p>本质上就是在判断语句里嵌套一个查询语句，例如要查询所有语文成绩并降序排序，可以通过联表查询和子查询两种方式实现</p>
<p><img src="/2024/02/18/mysql/%E5%AD%90%E6%9F%A5%E8%AF%A2.png" alt="子查询"></p>
<h3 id="2-4-聚合函数"><a href="#2-4-聚合函数" class="headerlink" title="2.4 聚合函数"></a>2.4 聚合函数</h3><h4 id="2-4-1-count"><a href="#2-4-1-count" class="headerlink" title="2.4.1 count"></a>2.4.1 count</h4><p>count 函数用于计数，例如查询有多少学生</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(`name`) <span class="keyword">from</span> students;</span><br></pre></td></tr></table></figure>

<p>函数内所带的参数不同，背后运行也不同：</p>
<ul>
<li>count(字段)：会忽略空值，不计数</li>
<li>count(*)：不会忽略空值</li>
<li>count(1)：不会忽略空值</li>
<li>从效率上看：如果查询的列为主键，那么 count(字段) 比 count(1) 快，不为主键则反之；如果表中只有一列，则 count(*) 最快</li>
</ul>
<h4 id="2-4-2-sum"><a href="#2-4-2-sum" class="headerlink" title="2.4.2 sum"></a>2.4.2 sum</h4><p>顾名思义，用于求和，例如查询所有成绩之和</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(`score`) <span class="keyword">as</span> <span class="string">&#x27;总分&#x27;</span> <span class="keyword">from</span> <span class="keyword">result</span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-avg"><a href="#2-4-3-avg" class="headerlink" title="2.4.3 avg"></a>2.4.3 avg</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(`score`) <span class="keyword">as</span> <span class="string">&#x27;平均分&#x27;</span> <span class="keyword">from</span> <span class="keyword">result</span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-4-max和min"><a href="#2-4-4-max和min" class="headerlink" title="2.4.4 max和min"></a>2.4.4 max和min</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(`score`) <span class="keyword">as</span> <span class="string">&#x27;最高分&#x27;</span> <span class="keyword">from</span> <span class="keyword">result</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">min</span>(`score`) <span class="keyword">as</span> <span class="string">&#x27;最低分&#x27;</span> <span class="keyword">from</span> <span class="keyword">result</span></span><br></pre></td></tr></table></figure>

<p>查询所有科目的平均分、最高分和最低分</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> subjectname, <span class="built_in">avg</span>(studentresult), <span class="built_in">max</span>(studentresult), <span class="built_in">min</span>(studentresult)</span><br><span class="line"><span class="keyword">from</span> `<span class="keyword">result</span>`</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> `subject`</span><br><span class="line"><span class="keyword">on</span> `<span class="keyword">result</span>`.subjectno <span class="operator">=</span> `subject`.subjectno</span><br><span class="line"><span class="comment">-- 定义字段进行分组</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> result.subjectno;</span><br></pre></td></tr></table></figure>

<p>通过分组后的次要条件，查询平均分大于 80 分的科目</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> subjectname, <span class="built_in">avg</span>(studentresult) <span class="keyword">as</span> 平均分</span><br><span class="line"><span class="keyword">from</span> `<span class="keyword">result</span>`</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> `subject`</span><br><span class="line"><span class="keyword">on</span> `<span class="keyword">result</span>`.subjectno <span class="operator">=</span> `subject`.subjectno</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> `<span class="keyword">result</span>`.subjectno</span><br><span class="line"><span class="comment">-- 分组后的次要条件</span></span><br><span class="line"><span class="keyword">having</span> 平均分 <span class="operator">&gt;</span> <span class="number">80</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-MD5加密"><a href="#2-5-MD5加密" class="headerlink" title="2.5 MD5加密"></a>2.5 MD5加密</h3><p>在数据库中，密码等敏感信息都不会以明文的形式存储的，可以通过md5 进行加密</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更新密码以达成加密</span></span><br><span class="line"><span class="keyword">update</span> students <span class="keyword">set</span> pwd<span class="operator">=</span>md5(pwd);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入的时候就进行加密</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> students <span class="keyword">values</span>(<span class="number">1</span>, <span class="string">&#x27;cqm&#x27;</span>, md5(<span class="string">&#x27;12345&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="2-6-事务"><a href="#2-6-事务" class="headerlink" title="2.6 事务"></a>2.6 事务</h3><p>事务就是一系列 SQL 语句，要么全部执行，要么全部不执行。</p>
<p>事务的特性（ACID）：</p>
<ul>
<li>原子性（Atomicity）：所有操作要么全部成功，要么全部失败</li>
<li>一致性（Consistency）：事务的执行的前后数据的完整性保持一致</li>
<li>隔离性（Isolation）：一个事务执行的过程中，不受到别的事务的干扰</li>
<li>持久性（Durability）：事务一旦结束，就会持久到数据库</li>
</ul>
<p>隔离所导致的一些问题：</p>
<ul>
<li>脏读：一个事务读取到了另一个事务没提交的数据</li>
<li>不可重复读：一个事务的多次查询结果不同，是因为查询期间数据被另一个事务提交而修改了</li>
<li>虚读：一个事务A在进行修改数据的操作时，另一个事务B插入了新的一行数据，而对于事务A来看事务B添加的那行就没有做修改，就发生了虚读</li>
</ul>
<ol>
<li>事务关闭自动提交</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>事务开启</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> transaction;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>事务提交</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>事务回滚</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>事务结束</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>保存点</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加保存点</span></span><br><span class="line"><span class="keyword">savepoint</span> 保存点名称</span><br><span class="line"><span class="comment">-- 回滚到保存点</span></span><br><span class="line"><span class="keyword">rollback</span> <span class="keyword">to</span> <span class="keyword">savepoint</span> 保存点名称</span><br><span class="line"><span class="comment">-- 删除保存点</span></span><br><span class="line"><span class="keyword">release</span> <span class="keyword">savepoint</span> 保存点名称</span><br></pre></td></tr></table></figure>

<h3 id="2-7-索引"><a href="#2-7-索引" class="headerlink" title="2.7 索引"></a>2.7 索引</h3><p>索引是帮助 MySQL 高效获取数据的数据结构。</p>
<p><strong>索引的分类：</strong></p>
<ul>
<li>主键索引（primary key）：只有一列可以作为主键，且主键的值不可重复，一般用于用户ID之类的</li>
<li>唯一索引（unique key）：唯一索引可以有多个，且值唯一</li>
<li>常规索引（key）：例如一个表中的数据经常用到，就可以添加个常规索引</li>
<li>全文索引（fulltext）：快速定位数据</li>
</ul>
<ol>
<li>查看某个表的所有索引</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> `table_name`;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加全文索引</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `table_name` <span class="keyword">add</span> fulltext index `index_name`(`要添加索引的字段名`);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>添加常规索引</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 这样会给表中某个字段的数据全部都添加上索引，在数据量大的时候可以提高查询效率</span></span><br><span class="line"><span class="keyword">create</span> index `id_table_name_字段名` <span class="keyword">on</span> `table_name`(<span class="string">&#x27;字段名&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>索引使用原则：</strong></p>
<ul>
<li>并不是索引越多越好</li>
<li>不要对进程变动的数据添加索引</li>
<li>数据量小的表不需要索引</li>
<li>索引一般用于常查询的字段上</li>
</ul>
<h3 id="2-8-权限管理"><a href="#2-8-权限管理" class="headerlink" title="2.8 权限管理"></a>2.8 权限管理</h3><p>在 MySQL 中，用户表为 mysql.user，而权限管理其实都是在该表上操作。</p>
<ol>
<li>创建用户</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- host可以为以下的值</span></span><br><span class="line"><span class="comment">-- %:允许所有ip连接</span></span><br><span class="line"><span class="comment">-- localhost:只允许本地连接</span></span><br><span class="line"><span class="comment">-- 192.168.88.%:只允许给网段连接</span></span><br><span class="line"><span class="comment">-- 192.168.88.10:只允许该ip连接</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;user_name&#x27;</span>@<span class="string">&#x27;host&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;user_password&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改当前用户密码</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> password <span class="operator">=</span> password(<span class="string">&#x27;new_password&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改指定用户密码</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> password <span class="keyword">for</span> user_name <span class="operator">=</span> password(<span class="string">&#x27;new_password&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>重命名</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="keyword">user</span> user_name <span class="keyword">to</span> new_user_name;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>授权</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 权限:select、insert、delete等等，所有权限则为all</span></span><br><span class="line"><span class="keyword">grant</span> 权限 <span class="keyword">on</span> `db_name`.`table_name` <span class="keyword">to</span> <span class="string">&#x27;user_name&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>授予某个用户部分权限</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>,<span class="keyword">insert</span> <span class="keyword">on</span> mysql.user <span class="keyword">to</span> <span class="string">&#x27;cqm&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>给某个用户授予全部数据库的权限</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基本权限都有，但不会给grant权限</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;cqm&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>删除用户</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;user_name&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>取消权限</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> 权限 <span class="keyword">on</span> `db_name`.`table_name` <span class="keyword">from</span> <span class="string">&#x27;user_name&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>查询用户权限</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;user_name&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-9-备份"><a href="#2-9-备份" class="headerlink" title="2.9 备份"></a>2.9 备份</h3><p>备份文件都是以 <code>.sql</code> 为后缀的文件。</p>
<ol>
<li>导出</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-d:要操作的数据库</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-h:指定主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-P:指定端口</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--all-databases:操作所有数据库</span></span><br><span class="line">mysqldump -uroot -ppassword -d db1_name db2_name &gt; db_backup.sql</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>导入</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -ppassword -d db_name &lt; db_backup.sql</span><br></pre></td></tr></table></figure>

<h2 id="三、MySQL配置"><a href="#三、MySQL配置" class="headerlink" title="三、MySQL配置"></a>三、MySQL配置</h2><h3 id="3-1-主从同步-复制"><a href="#3-1-主从同步-复制" class="headerlink" title="3.1 主从同步&#x2F;复制"></a>3.1 主从同步&#x2F;复制</h3><p>MySQL 主从同步即每当主数据库进行了数据的操作后，就会将操作写入 binlog 文件，从数据库会启动一个 IO 线程去监控主数据库的 binlog 文件，并将 binlog 文件的内容写入自己的 relaylog 文件中，同时会启动一个 SQL 线程去监控 relaylog 文件，如果发生变化就更新数据。</p>
<p><img src="/2024/02/18/mysql/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="主从同步流程图"></p>
<p><strong>主从复制的类型：</strong></p>
<ul>
<li>statement模式（sbr）：只有修改数据的 SQL 语句会记录到 binlog 中，优点是减少了日志量，节省 IO，提高性能，不足是可能会导致主从节点之间的数据有差异。</li>
<li>row模式（rbr）：仅记录被修改的数据，不怕无法正确复制的问题，但会产生大量的 binlog。</li>
<li>mixed模式（mbr）：sbr 和 rbr 的混合模式，一般复制用 sbr，sbr 无法复制的用 rbr。</li>
</ul>
<p><strong>主从同步实现</strong></p>
<ol>
<li>docker-compose.yaml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql_master:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7.35</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">toortoor</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./master/my.cnf:/etc/mysql/my.cnf</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">mysql_slave:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7.35</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">toortoor</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3307</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./slave/my.cnf:/etc/mysql/my.cnf</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>master&#x2F;my.cnf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id = 1                   #节点ID，确保唯一</span><br><span class="line">log-bin = mysql-bin             #开启mysql的binlog日志功能</span><br><span class="line">sync_binlog = 1                 #控制数据库的binlog刷到磁盘上去，0不控制，性能最好；1每次事物提交都会刷到日志文件中，性能最差，最安全</span><br><span class="line">binlog_format = mixed           #binlog日志格式，mysql默认采用statement，建议使用mixed</span><br><span class="line">expire_logs_days = 7            #binlog过期清理时间</span><br><span class="line">max_binlog_size = 100m          #binlog每个日志文件大小</span><br><span class="line">binlog_cache_size = 4m          #binlog缓存大小</span><br><span class="line">max_binlog_cache_size= 512m     #最大binlog缓存大</span><br><span class="line">binlog-ignore-db=mysql          #不生成日志文件的数据库，多个忽略数据库可以用逗号拼接，或者复制这句话，写多行</span><br><span class="line">auto-increment-offset = 1       #自增值的偏移量</span><br><span class="line">auto-increment-increment = 1    #自增值的自增量</span><br><span class="line">slave-skip-errors = all         #跳过从库错误</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>slave&#x2F;my.cnf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id = 2</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">relay-log = mysql-relay-bin</span><br><span class="line">replicate-wild-ignore-table=mysql.%</span><br><span class="line">replicate-wild-ignore-table=test.%</span><br><span class="line">replicate-wild-ignore-table=information_schema.%</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在 master 创建复制用户并授权</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;toortoor&#x27;</span>;</span><br><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;toortoor&#x27;</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>查看 master 状态</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+...</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span>...</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+...</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">844</span> <span class="operator">|</span>...</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+...</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>在从数据库配置</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span></span><br><span class="line">MASTER_HOST <span class="operator">=</span> <span class="string">&#x27;172.19.0.3&#x27;</span>,</span><br><span class="line">MASTER_USER <span class="operator">=</span> <span class="string">&#x27;repl_user&#x27;</span>, </span><br><span class="line">MASTER_PASSWORD <span class="operator">=</span> <span class="string">&#x27;toortoor&#x27;</span>,</span><br><span class="line">MASTER_PORT <span class="operator">=</span> <span class="number">3306</span>,</span><br><span class="line">MASTER_LOG_FILE<span class="operator">=</span><span class="string">&#x27;mysql-bin.000003&#x27;</span>,</span><br><span class="line">MASTER_LOG_POS<span class="operator">=</span><span class="number">844</span>,</span><br><span class="line">MASTER_RETRY_COUNT <span class="operator">=</span> <span class="number">60</span>,</span><br><span class="line">MASTER_HEARTBEAT_PERIOD <span class="operator">=</span> <span class="number">10000</span>; </span><br></pre></td></tr></table></figure>

<ol start="7">
<li>启动从配置</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> slave;</span><br><span class="line"><span class="keyword">show</span> slave status\G;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>如果配置失败，可以执行</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> sql_slave_skip_counter<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Mycat读写分离"><a href="#3-2-Mycat读写分离" class="headerlink" title="3.2 Mycat读写分离"></a>3.2 Mycat读写分离</h3><p>在一般项目中，对于数据库的操作读要远大于写，而如果所有的操作都放在一个节点上，那么就很容易出现压力过大而宕机，读写分离就可以很好解决该问题，主要通过 mycat 的中间件来实现。</p>
<p><img src="/2024/02/18/mysql/mycat%E6%9E%B6%E6%9E%84.png" alt="mycat架构"></p>
<p><strong>分库分表类型：</strong></p>
<ul>
<li>水平拆分：将不同等级的会员信息写到不同的表中</li>
<li>垂直拆分：将买家信息、卖家信息、商品信息、支付信息等不同信息写到不同的表中</li>
</ul>
<p><strong>Mycat的主要文件：</strong></p>
<table>
<thead>
<tr>
<th align="center">文件</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">server.xml</td>
<td align="center">设置 Mycat 账号、参数等</td>
</tr>
<tr>
<td align="center">schema.xml</td>
<td align="center">设置 Mycat 对应的物理数据库和表等</td>
</tr>
<tr>
<td align="center">rule.xml</td>
<td align="center">分库分表设置</td>
</tr>
</tbody></table>
<ol>
<li>server.xml</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Mycat用户名 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    			<span class="comment">&lt;!-- 密码 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    			<span class="comment">&lt;!-- 逻辑库名 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    			<span class="comment">&lt;!-- 默认逻辑库 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultSchema&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--No MyCAT Database selected 错误前会尝试使用该schema作为schema，不设置则为null,报</span></span><br><span class="line"><span class="comment">错 --&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">    			<span class="comment">&lt;!-- 0为禁止，1为开启 --&gt;</span></span><br><span class="line">    			<span class="comment">&lt;!-- 按顺序分别为insert、update、select、delete --&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                &lt;privileges check=&quot;false&quot;&gt;</span></span><br><span class="line"><span class="comment">                        &lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &gt;</span></span><br><span class="line"><span class="comment">                                &lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">                                &lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">                        &lt;/schema&gt;</span></span><br><span class="line"><span class="comment">                &lt;/privileges&gt;</span></span><br><span class="line"><span class="comment">                 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 其他用户设置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>user<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultSchema&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>schema.xml</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">			 name为逻辑库名称，与server.xml文件对应 </span></span><br><span class="line"><span class="comment">             checkSQLschema为true，sql为select * from table_name</span></span><br><span class="line"><span class="comment">			 checkSQLschema为false，sql为select * from TESTDB.table_name</span></span><br><span class="line"><span class="comment">			 sqlMaxLimit是指如果sql中没有limit，则自动添加，如果有则不添加</span></span><br><span class="line"><span class="comment">		--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">randomDataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">					 name为逻辑表名</span></span><br><span class="line"><span class="comment">					 dataNode为数据节点名称</span></span><br><span class="line"><span class="comment">				     rule为规则</span></span><br><span class="line"><span class="comment">				--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-intfile&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">fetchStoreNodeByJdbc</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;customer_addr&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;customer_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">childTable</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">			 name为数据节点名称</span></span><br><span class="line"><span class="comment">			 dataHost为数据库地址</span></span><br><span class="line"><span class="comment">			 database为mysql中的database</span></span><br><span class="line"><span class="comment">			 实际就是将TESTDB逻辑库拆成dn1和dn2，而dn1和dn2又对应db1和db2</span></span><br><span class="line"><span class="comment">		--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db3&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">			 balance:</span></span><br><span class="line"><span class="comment">				0:不开启读写分离，所有操作都在writeHost上</span></span><br><span class="line"><span class="comment">				1:所有读操作都随机发送到当前的writeHost对应的readHost和备用的writeHost</span></span><br><span class="line"><span class="comment">				2:所有读操作都随机发送到所有的主机上</span></span><br><span class="line"><span class="comment">				3:所有读操作只发送到readHost上</span></span><br><span class="line"><span class="comment">			 writeType:</span></span><br><span class="line"><span class="comment">				0:所有写操作都在第一台writeHost上，第一台挂了再切到第二台</span></span><br><span class="line"><span class="comment">				1:所有写操作都随机分配到writeHost</span></span><br><span class="line"><span class="comment">			 switchType: 用于是否允许writeHost和readHost之间自动切换</span></span><br><span class="line"><span class="comment">				-1:不允许</span></span><br><span class="line"><span class="comment">				1:允许</span></span><br><span class="line"><span class="comment">				2:基于mysql的主从同步的状态决定是否切换</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">            	<span class="comment">&lt;!-- 用此命令来进行心跳检测 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 设置读写分离 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>rule.xml</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 平均分算法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 根据id值平均分 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 切片个数 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在 master 节点创建数据库</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 与schema.xml中的database参数相同</span></span><br><span class="line"><span class="keyword">create</span> database db1;</span><br><span class="line"><span class="keyword">create</span> database db2;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在每个库里创建表</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> students(</span><br><span class="line">	id <span class="type">int</span>(<span class="number">4</span>),</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">10</span>),</span><br><span class="line">	<span class="keyword">primary</span> key(`id`)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>开启 Mycat，默认开启8066服务端端口和9066管理端端口</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mycat start</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>在有安装 mysql 的主机登录 Mycat，也可以通过 navicat 连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -ptoortoor -h 192.168.88.136 -P 8066</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/mysql/mycat%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="mycat测试一"></p>
<ol start="8">
<li>只要在 Mycat 进行 SQL 操作，都会流到 mysql 集群中被处理，也可以看到已经实现了分库分表</li>
</ol>
<p><img src="/2024/02/18/mysql/mycat%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="mycat测试二"></p>
<h3 id="3-3-使用haproxy实现Mycat高可用"><a href="#3-3-使用haproxy实现Mycat高可用" class="headerlink" title="3.3 使用haproxy实现Mycat高可用"></a>3.3 使用haproxy实现Mycat高可用</h3><p>haproxy 可以实现 Mycat 集群的高可用和负载均衡，而 haproxy 的高可用通过 keepalived 来实现。</p>
<p><img src="/2024/02/18/mysql/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="高可用集群架构图"></p>
<ol>
<li>安装 haproxy</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改日志文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyslog.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Provides UDP syslog reception</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ModLoad imudp</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">UDPServerRun 514</span></span><br><span class="line">systemctl restart rsyslog</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 haproxy</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">haproxy的配置文件由两个部分构成，全局设定和代理设定</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分为五段:global、defaults、frontend、backend、listen</span></span><br><span class="line">global</span><br><span class="line">    # 定义全局的syslog服务器</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    # 设置haproxy后台守护进程形式运行</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    # 处理模式</span><br><span class="line">    # http:七层</span><br><span class="line">    # tcp:四层</span><br><span class="line">    # health:状态检查,只会返回OK</span><br><span class="line">    mode                    tcp</span><br><span class="line">    # 继承global中log的定义</span><br><span class="line">    log                     global</span><br><span class="line">    option                  tcplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    # option forwardfor       except 127.0.0.0/8</span><br><span class="line">    # serverId对应的服务器挂掉后,强制定向到其他健康的服务器</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend  mycat</span><br><span class="line">    # 开启本地监控端口</span><br><span class="line">    bind             0.0.0.0:8066</span><br><span class="line">    bind             0.0.0.0:9066</span><br><span class="line">    mode             tcp</span><br><span class="line">    log              global</span><br><span class="line">    default_backend  mycat</span><br><span class="line">backend mycat</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    # 监控的Mycat</span><br><span class="line">    server      mycat1 192.168.88.135:8066 check inter 5s rise 2 fall 3</span><br><span class="line">    server      mycat2 192.168.88.135:8066 check inter 5s rise 2 fall 3</span><br><span class="line">    server      mycatadmin1 192.168.88.136:9066 check inter 5s rise 2 fall 3</span><br><span class="line">    server      mycatadmin2 192.168.88.136:9066 check inter 5s rise 2 fall 3</span><br><span class="line">    listen      stats</span><br><span class="line">    mode        http</span><br><span class="line">    # 访问haproxy的端口</span><br><span class="line">    bind        0.0.0.0:9999</span><br><span class="line">    stats       enable</span><br><span class="line">    stats       hide-version</span><br><span class="line">    # url路径</span><br><span class="line">    stats uri   /haproxy</span><br><span class="line">    stats realm Haproxy\ Statistics</span><br><span class="line">    # 用户名/密码</span><br><span class="line">    stats auth  admin:admin</span><br><span class="line">    stats admin if TRUE</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>访问 haproxy</li>
</ol>
<p><img src="/2024/02/18/mysql/haproxy%E7%95%8C%E9%9D%A2.png" alt="haproxy界面"></p>
<h3 id="3-4-使用keepalived实现去中心化"><a href="#3-4-使用keepalived实现去中心化" class="headerlink" title="3.4 使用keepalived实现去中心化"></a>3.4 使用keepalived实现去中心化</h3><ol>
<li>安装 keepalived</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 Master 节点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    # 识别节点的id</span><br><span class="line">    router_id haproxy01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    # 设置角色，由于抢占容易出现 VIP 切换而闪断带来的风险，所以该配置为不抢占模式</span><br><span class="line">    state BACKUP</span><br><span class="line">    # VIP所绑定的网卡</span><br><span class="line">    interface ens33</span><br><span class="line">    # 虚拟路由ID号，两个节点必须一样</span><br><span class="line">    virtual_router_id 30</span><br><span class="line">    # 权重</span><br><span class="line">    priority 100</span><br><span class="line">    # 开启不抢占</span><br><span class="line">    # nopreempt</span><br><span class="line">    # 组播信息发送间隔，两个节点必须一样</span><br><span class="line">    advert_int 1</span><br><span class="line">    # 设置验证信息</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    # VIP地址池，可以多个</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.88.200</span><br><span class="line">    &#125;</span><br><span class="line">    # 将 track_script 块加入 instance 配置块</span><br><span class="line">    track_script&#123;</span><br><span class="line">        chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义监控脚本</span></span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;/etc/keepalived/haproxy_check.sh&quot;</span><br><span class="line">    # 时间间隔</span><br><span class="line">    interval 2</span><br><span class="line">    # 条件成立权重+2</span><br><span class="line">    weight 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置 Slave 节点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id haproxy02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 30</span><br><span class="line">    priority 80</span><br><span class="line">    # nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.88.200</span><br><span class="line">    &#125;</span><br><span class="line">    track_script&#123;</span><br><span class="line">        chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;/etc/keepalived/haproxy_check.sh&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写监控脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/haproxy_check.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">START_HAPROXY=&quot;systemctl start haproxy&quot;</span><br><span class="line">STOP_KEEPALIVED=&quot;systemctl stop keepalived&quot;</span><br><span class="line">LOG_DIR=&quot;/etc/keepalived/haproxy_check.log&quot;</span><br><span class="line">HAPS=`ps -C haproxy --no-header | wc -l`</span><br><span class="line"></span><br><span class="line">date &quot;+%F %H:%M:%S&quot; &gt; $LOG_DIR</span><br><span class="line">echo &quot;Check haproxy status&quot; &gt;&gt; $LOG_DIR</span><br><span class="line">if [ $HAPS -eq 0 ];</span><br><span class="line">then</span><br><span class="line">    echo &quot;Haproxy is down&quot; &gt;&gt; $LOG_DIR</span><br><span class="line">    echo &quot;Try to turn on Haproxy...&quot; &gt;&gt; $LOG_DIR</span><br><span class="line">    echo $START_HAPROXY | sh</span><br><span class="line">    sleep 3</span><br><span class="line">    if [ `ps -C haproxy --no-header | wc -l` -eq 0 ];</span><br><span class="line">    then</span><br><span class="line">        echo -e &quot;Start Haproxy failed, killall keepalived\n&quot; &gt;&gt; $LOG_DIR</span><br><span class="line">        echo $STOP_KEEPALIVED | sh</span><br><span class="line">    else</span><br><span class="line">        echo -e &quot;Start Haproxy successed\n&quot; &gt;&gt; $LOG_DIR</span><br><span class="line">    fi</span><br><span class="line">else</span><br><span class="line">    echo -e &quot;Haproxy is running\n&quot; &gt;&gt; $LOG_DIR</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动 keepalived 后可以看到 VIP 被哪台服务器抢占了，通过该 VIP 就可以访问到对应的 haproxy，haproxy 就会将流量流到后面的 Mycat，再由 Mycat 来实现分表分库；haproxy 停止后 keepalived 也会通过脚本尝试去重新开启，如果开启不成功就会停止 keepalived，VIP 就由 slave 节点抢占，用户依旧可以通过 VIP 来操控数据库，且无感知。</li>
</ol>
<p><img src="/2024/02/18/mysql/keepalived%E6%B5%8B%E8%AF%95%E4%B8%80.png" alt="keepalived测试一"></p>
<ol start="6">
<li>通过 VIP 去连接 Mycat 插入数据，尝试能否实现分库分表</li>
</ol>
<p><img src="/2024/02/18/mysql/keepalived%E6%B5%8B%E8%AF%95%E4%BA%8C.png" alt="keepalived测试二"></p>
<p>可以看到插入的数据都分到了 db1、db2 中</p>
<p><img src="/2024/02/18/mysql/keepalived%E6%B5%8B%E8%AF%95%E4%B8%89.png" alt="keepalived测试三"></p>
<h3 id="3-5-Sharding-JDBC读写分离"><a href="#3-5-Sharding-JDBC读写分离" class="headerlink" title="3.5 Sharding JDBC读写分离"></a>3.5 Sharding JDBC读写分离</h3><p>Apache ShardingSphere 是一套开源的分布式数据库解决方案组成的生态圈，它由 JDBC、Proxy 和 Sidecar（规划中）这 3 款既能够独立部署，又支持混合部署配合使用的产品组成。 </p>
<p>Sharding JDBC 同样也可以实现分库分表、数据分片、读写分离等功能，但与 Mycat 不同的是，Mycat 是一个独立的程序，而 Sharding JDBC 是以 jar 包的形式与应用程序融合在一起运行的。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-02-18T11:02:24.353Z" title="2/18/2024, 7:02:24 PM">2024-02-18</time></span><span class="level-item">an hour read (About 10192 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/02/18/web/">Web</a></p><div class="content"><h2 id="一、Apache"><a href="#一、Apache" class="headerlink" title="一、Apache"></a>一、Apache</h2><h3 id="1-1-Apache介绍"><a href="#1-1-Apache介绍" class="headerlink" title="1.1 Apache介绍"></a>1.1 Apache介绍</h3><p>Apache HTTP Server（简称Apache）是Apache软件基金会的一个开放源码的网页服务器，是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。它快速、可靠并且可通过简单的API扩充，将Perl&#x2F;Python等解释器编译到服务器中。</p>
<p>Apache HTTP服务器是一个模块化的服务器，源于NCSAhttpd服务器，经过多次修改，成为世界使用排名第一的Web服务器软件。</p>
<p>Apache官方文档：<a target="_blank" rel="noopener" href="http://httpd.apache.org/docs/">http://httpd.apache.org/docs/</a></p>
<h3 id="1-2-通过脚本源码安装Apache"><a href="#1-2-通过脚本源码安装Apache" class="headerlink" title="1.2 通过脚本源码安装Apache"></a>1.2 通过脚本源码安装Apache</h3><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -r www</span><br><span class="line">vim apache-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apr_version=1.7.0</span><br><span class="line">apr_iconv_version=1.2.2</span><br><span class="line">apr_util_version=1.6.1</span><br><span class="line">apache_version=2.4.46</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否为root用户</span></span><br><span class="line">   if [ $USER != &#x27;root&#x27; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否安装了wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装依赖</span></span><br><span class="line">   if [ ! `yum -y install zlib-devel pcre-devel libxml2 expat-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/apr/apr-$&#123;apr_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-$&#123;apr_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-$&#123;apr_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-$&#123;apr_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-$&#123;apr_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-$&#123;apr_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr</span></span><br><span class="line">   echo &quot;apr configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">	   echo -e &quot;\e[1;32m apr installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">	   echo -e &quot;\e[1;31m apr installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr-iconv</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-iconv-$&#123;apr_iconv_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-iconv-$&#123;apr_iconv_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-iconv-$&#123;apr_iconv_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-iconv-$&#123;apr_iconv_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr-iconv</span></span><br><span class="line">   echo &quot;apr-iconv configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-iconv --with-apr=/usr/local/apr &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then </span><br><span class="line">       echo &quot;apr-iconv make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-iconv installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-iconv installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-iconv configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载apr-util</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.apache.org/dist/apr/apr-util-$&#123;apr_util_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf apr-util-$&#123;apr_util_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d apr-util-$&#123;apr_util_version&#125; ]</span><br><span class="line">       then </span><br><span class="line">           echo -e &quot;\e[1;31m error:not found apr-util-$&#123;apr_util_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd apr-util-$&#123;apr_util_version&#125;</span><br><span class="line">       fi  </span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download apr-util-$&#123;apr_util_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装apr-util</span></span><br><span class="line">   echo &quot;apr-util configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;apr-util make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m apr-util installed successfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m apr-util installed failed \e[0m&quot;</span><br><span class="line">	   exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:apr-util configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载安装Apache</span></span><br><span class="line">function apache_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载Apache</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://downloads.apache.org/httpd/httpd-$&#123;apache_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf httpd-$&#123;apache_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d httpd-$&#123;apache_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd httpd-$&#123;apache_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download httpd-$&#123;apache_version&#125; \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装Apache</span></span><br><span class="line">   echo &quot;Apache configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/apache --enable-mpms-shared=all --with-mpm=event --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-so --enable-remoteip --enable-proxy --enable-proxy-fcgi --enable-proxy-uwsgi --enable-deflate=shared --enable-expires=shared --enable-rewrite=shared --enable-cache --enable-file-cache --enable-mem-cache --enable-disk-cache --enable-static-support --enable-static-ab --disable-userdir --enable-nonportable-atomics --disable-ipv6 --with-sendfile &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;Apache make &amp;&amp; make install...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m Apache installed sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m Apache installed failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m Apache configure failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">apache_install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写启动脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">apache_doc=/usr/local/apache/bin</span><br><span class="line">apache_pid=/usr/local/apache/logs/httpd.pid</span><br><span class="line"></span><br><span class="line">function apache_start()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $apache_num -eq 1 ] &amp;&amp; [ -f $apache_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall httpd</span><br><span class="line">   fi</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl</span><br><span class="line">   echo -e &quot;start Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_stop()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       killall httpd</span><br><span class="line">       echo -e &quot;stop Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_restart()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/apache/bin;./apachectl restart</span><br><span class="line">   echo -e &quot;restart Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_status()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;Apache [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function apache_reload()</span><br><span class="line">&#123;</span><br><span class="line">   apache_num=`ps -ef | grep httpd | wc -l`</span><br><span class="line">   if [ $apache_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       cd /usr/local/apache/bin;./apachectl graceful</span><br><span class="line">       echo -e &quot;reload Apache [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;Apache [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        apache_start</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        apache_stop</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">restart)</span><br><span class="line">        apache_restart</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">status)</span><br><span class="line">        apache_status</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">reload)</span><br><span class="line">        apache_reload</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="1-3-多处理模块MPM"><a href="#1-3-多处理模块MPM" class="headerlink" title="1.3 多处理模块MPM"></a>1.3 多处理模块MPM</h3><p>Apache HTTP 服务器被设计为一个功能强大，并且灵活的 web 服务器， 可以在很多平台与环境中工作。不同平台和不同的环境往往需要不同 的特性，或可能以不同的方式实现相同的特性最有效率。Apache 通过模块化的设计来适应各种环境。这种设计允许网站管理员通过在 编译时或运行时，选择哪些模块将会加载在服务器中，来选择服务器特性。</p>
<p>实际上就是用来<strong>接受请求</strong>和<strong>处理请求</strong>的。</p>
<p>Apache的三种工作方式：</p>
<ol>
<li>Prefork MPM：使用多个进程，每个进程只有一个线程，每个进程再某个确定的时间只能维持一个连接，有点是稳定，缺点是内存消耗过高。</li>
</ol>
<p>![Prefork MPM](Prefork MPM.png)</p>
<ol>
<li>Worker MPM：使用多个进程，每个进程有多个线程，每个线程在某个确定的时间只能维持一个连接，内存占用比较小，是个大并发、高流量的场景，缺点是一个线程崩溃，整个进程就会连同其任何线程一起挂掉。</li>
</ol>
<p>![Worker MPM](Worker MPM.png)</p>
<ol start="3">
<li>Event MPM：使用多进程多线程+epoll的模式。</li>
</ol>
<p>![Event MPM](Event MPM.png)</p>
<h3 id="1-4-虚拟主机"><a href="#1-4-虚拟主机" class="headerlink" title="1.4 虚拟主机"></a>1.4 虚拟主机</h3><p>默认情况下，一个web服务器只能发布一个默认网站，也就是只能发布一个web站点，对于大网站来说还好，但对于访问量较少的小网站那就显得有点浪费了。</p>
<p>而虚拟主机就可以实现在一个web服务器上发布多个站点，分为基于IP地址、域名和端口三种。</p>
<p>Apache的虚拟主机和默认网站不能够同时存在，如果设置了虚拟主机那么默认网站也就失效了，需要在用虚拟主机发布默认站点才可解决。</p>
<p>基于IP：基于IP的虚拟主机需要耗费大量的IP地址，只适合IP地址充足的环境。</p>
<p>基于端口：需要耗费较多的端口，适合私网环境。</p>
<p>基于域名：需要耗费较多的域名，适合公网环境。</p>
<h4 id="1-4-1-基于IP的虚拟主机"><a href="#1-4-1-基于IP的虚拟主机" class="headerlink" title="1.4.1 基于IP的虚拟主机"></a>1.4.1 基于IP的虚拟主机</h4><ol>
<li>在主配文件中调用虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Virtual hosts</span></span><br><span class="line">Include conf/extra/httpd-vhosts.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个逻辑网卡，重启即失效</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost 49.232.160.75:80&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">管理员邮箱</span></span><br><span class="line">    # ServerAdmin webmaster@dummy-host.example.com</span><br><span class="line">    # web目录</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    # 域名</span><br><span class="line">    # ServerName dummy-host.example.com</span><br><span class="line">    # 给域名起别名，起到重定向作用</span><br><span class="line">    # ServerAlias www.dummy-host.example.com</span><br><span class="line">    # 错误日子</span><br><span class="line">    # ErrorLog &quot;logs/dummy-host.example.com-error_log&quot;</span><br><span class="line">    # 访问日志</span><br><span class="line">    # CustomLog &quot;logs/dummy-host.example.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.88.100:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建站点目录和文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/apache/htdocs/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/apache/htdocs/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/apache/htdocs/web2/index.html</span><br><span class="line">./apache start</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8EIP%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于IP虚拟主机测试"></p>
<h4 id="1-4-2-基于端口的虚拟主机"><a href="#1-4-2-基于端口的虚拟主机" class="headerlink" title="1.4.2 基于端口的虚拟主机"></a>1.4.2 基于端口的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">Listen 81</span><br><span class="line">&lt;VirtualHost *:81&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E7%AB%AF%E5%8F%A3%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于端口虚拟主机测试"></p>
<h4 id="1-4-3-基于域名的虚拟主机"><a href="#1-4-3-基于域名的虚拟主机" class="headerlink" title="1.4.3 基于域名的虚拟主机"></a>1.4.3 基于域名的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web1&quot;</span><br><span class="line">    ServerName www.cqm1.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web2&quot;</span><br><span class="line">    ServerName www.cqm2.com</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95.png" alt="基于域名虚拟主机测试"></p>
<h3 id="1-5-LAMP"><a href="#1-5-LAMP" class="headerlink" title="1.5 LAMP"></a>1.5 LAMP</h3><p>LAMP：Linux + Apache + Mysql + PHP</p>
<p>作用就是构建一个PHP业务环境，用来发布PHP网站。</p>
<h4 id="1-5-1-Mysql通过脚本源码安装"><a href="#1-5-1-Mysql通过脚本源码安装" class="headerlink" title="1.5.1 Mysql通过脚本源码安装"></a>1.5.1 Mysql通过脚本源码安装</h4><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mysql_version=5.7.35</span><br><span class="line">install_dir=/opt</span><br><span class="line">data_dir=/data</span><br><span class="line">wget_url=&quot;https://mirrors.tuna.tsinghua.edu.cn/mysql/downloads/MySQL-5.7/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz&quot;</span><br><span class="line"></span><br><span class="line">function loginfo()&#123;</span><br><span class="line">    if [[ $? -eq 0 ]];then</span><br><span class="line">        echo -e &quot;\033[32m[INFO][$(date +&quot;%F %T&quot;)] $1 succeed! \033[0m&quot;</span><br><span class="line">    else</span><br><span class="line">        echo -e &quot;\033[31m[ERROR][$(date +&quot;%F %T&quot;)] $1 failed! \033[0m&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mysql_install()&#123;</span><br><span class="line">    echo -e &quot;\033[32mBegin install mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    </span><br><span class="line">    # 安装依赖</span><br><span class="line">    sudo yum -y install libaio &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;libaio install&quot;</span><br><span class="line"></span><br><span class="line">    # 下载mysql</span><br><span class="line">    echo -e &quot;\033[32mBegin download mysql V$&#123;mysql_version&#125; ...\033[0m&quot;</span><br><span class="line">    curl -O $wget_url &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    mv ./mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz $install_dir</span><br><span class="line">    loginfo &quot;mysql software download&quot;</span><br><span class="line"></span><br><span class="line">    # 解压缩mysql</span><br><span class="line">    sudo tar -xf $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64.tar.gz -C $install_dir</span><br><span class="line">    loginfo &quot;mysql software decompression&quot;</span><br><span class="line"></span><br><span class="line">    # 创建配置文件目录和数据目录</span><br><span class="line">    if [[ -d $install_dir/mysql ]];then</span><br><span class="line">        rm -rf $install_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo ln -s $install_dir/mysql-$&#123;mysql_version&#125;-linux-glibc2.12-x86_64 $install_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql config dir soft link&quot;</span><br><span class="line">    if [[ -d $data_dir/mysql ]];then</span><br><span class="line">        rm -rf $data_dir/mysql</span><br><span class="line">    fi</span><br><span class="line">    sudo mkdir -p $data_dir/mysql</span><br><span class="line">    loginfo &quot;create mysql data dir&quot;</span><br><span class="line"></span><br><span class="line">    # 修改启动脚本</span><br><span class="line">    sudo sed -i &quot;46s#basedir=#basedir=$&#123;install_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo sed -i &quot;47s#datadir=#datadir=$&#123;data_dir&#125;/mysql#&quot; $&#123;install_dir&#125;/mysql/support-files/mysql.server</span><br><span class="line">    sudo cp $&#123;install_dir&#125;/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">    sudo chmod 755 /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # 创建用户组及用户</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/group</span><br><span class="line">    then</span><br><span class="line">        sudo groupadd mysql</span><br><span class="line">        loginfo &quot;create user mysql&quot;</span><br><span class="line">    fi</span><br><span class="line">    if ! grep -q &#x27;^mysql:&#x27; /etc/passwd</span><br><span class="line">    then</span><br><span class="line">        sudo useradd -r -g mysql -s /bin/false mysql</span><br><span class="line">        loginfo &quot;create group mysql&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 授权</span><br><span class="line">    sudo chown -R mysql:mysql $install_dir/mysql</span><br><span class="line">    sudo chown -R mysql:mysql $data_dir/mysql</span><br><span class="line"></span><br><span class="line">    # 为二进制文件创建软连接</span><br><span class="line">    if [ ! -f /usr/bin/mysql ]</span><br><span class="line">    then</span><br><span class="line">        sudo ln -s /opt/mysql/bin/mysql /usr/bin/</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 创建配置文件</span><br><span class="line">    if [ -f /etc/my.cnf ]</span><br><span class="line">    then</span><br><span class="line">        sudo rm -f /etc/my.cnf</span><br><span class="line">    fi</span><br><span class="line">    sudo bash -c &quot;cat &gt;&gt; /etc/my.cnf&quot; &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">datadir                             = /data/mysql</span><br><span class="line">basedir                             = /opt/mysql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">tmpdir                              = /data/mysql/tmp_mysql</span></span><br><span class="line">port                                = 3306</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">pid-file                            = /data/mysql/mysql.pid</span><br><span class="line">max_connections                     = 8000</span><br><span class="line">max_connect_errors                  = 100000</span><br><span class="line">max_user_connections                = 3000</span><br><span class="line">check_proxy_users                   = on</span><br><span class="line">mysql_native_password_proxy_users   = on</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">symbolic-links                      = FALSE</span><br><span class="line">group_concat_max_len                = 4294967295</span><br><span class="line">max_join_size                       = 18446744073709551615</span><br><span class="line">max_execution_time                  = 20000</span><br><span class="line">lock_wait_timeout                   = 60</span><br><span class="line">autocommit                          = 1</span><br><span class="line">lower_case_table_names              = 1</span><br><span class="line">thread_cache_size                   = 64</span><br><span class="line">disabled_storage_engines            = &quot;MyISAM,FEDERATED&quot;</span><br><span class="line">character_set_server                = utf8mb4</span><br><span class="line">character-set-client-handshake      = FALSE</span><br><span class="line">collation_server                    = utf8mb4_general_ci</span><br><span class="line">init_connect                        = &#x27;SET NAMES utf8mb4&#x27;</span><br><span class="line">transaction-isolation               = &quot;READ-COMMITTED&quot;</span><br><span class="line">skip_name_resolve                   = ON</span><br><span class="line">explicit_defaults_for_timestamp     = ON</span><br><span class="line">log_timestamps                      = SYSTEM</span><br><span class="line">local_infile                        = OFF</span><br><span class="line">event_scheduler                     = OFF</span><br><span class="line">query_cache_type                    = OFF</span><br><span class="line">query_cache_size                    = 0</span><br><span class="line">sql_mode                            = NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO</span><br><span class="line">log_error                           = /data/mysql/mysql.err</span><br><span class="line">slow_query_log                      = ON</span><br><span class="line">slow_query_log_file                 = /data/mysql/slow.log</span><br><span class="line">long_query_time                     = 1</span><br><span class="line">general_log                         = OFF</span><br><span class="line">general_log_file                    = /data/mysql/general.log</span><br><span class="line">expire_logs_days                    = 99</span><br><span class="line">log-bin                             = /data/mysql/mysql-bin</span><br><span class="line">log-bin-index                       = /data/mysql/mysql-bin.index</span><br><span class="line">max_binlog_size                     = 500M</span><br><span class="line">binlog_format                       = mixed</span><br><span class="line">binlog_rows_query_log_events        = ON</span><br><span class="line">binlog_cache_size                   = 128k</span><br><span class="line">binlog_stmt_cache_size              = 128k</span><br><span class="line">log-bin-trust-function-creators     = 1</span><br><span class="line">max_binlog_cache_size               = 2G</span><br><span class="line">max_binlog_stmt_cache_size          = 2G</span><br><span class="line">relay_log                           = /data/mysql/relay</span><br><span class="line">relay_log_index                     = /data/mysql/relay.index</span><br><span class="line">max_relay_log_size                  = 500M</span><br><span class="line">relay_log_purge                     = ON</span><br><span class="line">relay_log_recovery                  = ON</span><br><span class="line">server_id                           = 1</span><br><span class="line">read_buffer_size                    = 1M</span><br><span class="line">read_rnd_buffer_size                = 2M</span><br><span class="line">sort_buffer_size                    = 64M</span><br><span class="line">join_buffer_size                    = 64M</span><br><span class="line">tmp_table_size                      = 64M</span><br><span class="line">max_allowed_packet                  = 128M</span><br><span class="line">max_heap_table_size                 = 64M</span><br><span class="line">connect_timeout                     = 43200</span><br><span class="line">wait_timeout                        = 43200</span><br><span class="line">back_log                            = 512</span><br><span class="line">interactive_timeout                 = 300</span><br><span class="line">net_read_timeout                    = 30</span><br><span class="line">net_write_timeout                   = 30</span><br><span class="line">skip_external_locking               = ON</span><br><span class="line">key_buffer_size                     = 16M</span><br><span class="line">bulk_insert_buffer_size             = 16M</span><br><span class="line">concurrent_insert                   = ALWAYS</span><br><span class="line">open_files_limit                    = 65000</span><br><span class="line">table_open_cache                    = 16000</span><br><span class="line">table_definition_cache              = 16000</span><br><span class="line">default_storage_engine              = InnoDB</span><br><span class="line">default_tmp_storage_engine          = InnoDB</span><br><span class="line">internal_tmp_disk_storage_engine    = InnoDB</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket                              = /data/mysql/mysql.sock</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default_character_set               = utf8mb4</span><br><span class="line"></span><br><span class="line">[ndatad default]</span><br><span class="line">TransactionDeadLockDetectionTimeOut = 20000</span><br><span class="line">EOF</span><br><span class="line">    sudo chown -R mysql:mysql /etc/my.cnf</span><br><span class="line">    loginfo &quot;configure my.cnf&quot;</span><br><span class="line"></span><br><span class="line">    # 创建SSL证书</span><br><span class="line">    # sudo mkdir -p $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line">    # sudo $&#123;install_dir&#125;/mysql/bin/mysql_ssl_rsa_setup -d $&#123;install_dir&#125;/mysql/ca-pem/ --uid=mysql</span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;install_dir&#125;/mysql/ca-pem/</span><br><span class="line"></span><br><span class="line">    # sudo bash -c &quot;cat &gt;&gt; $&#123;data_dir&#125;/mysql/init_file.sql&quot; &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_safe_updates=0;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> global sql_select_limit=50000;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">EOF</span></span><br><span class="line">    # sudo chown -R mysql:mysql $&#123;data_dir&#125;/mysql/init_file.sql</span><br><span class="line">    # sudo chown -R mysql:mysql /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">    # 初始化</span><br><span class="line">    $&#123;install_dir&#125;/mysql/bin/mysqld --initialize --user=mysql --basedir=$&#123;DEPLOY_PATH&#125;/mysql --datadir=/data/mysql </span><br><span class="line">    loginfo &quot;initialize mysql&quot;</span><br><span class="line"></span><br><span class="line">    # 客户端环境变量</span><br><span class="line">    echo &quot;export PATH=\$PATH:$&#123;install_dir&#125;/mysql/bin&quot; | sudo tee /etc/profile.d/mysql.sh</span><br><span class="line">    source /etc/profile.d/mysql.sh</span><br><span class="line">    loginfo &quot;configure envirement&quot;</span><br><span class="line"></span><br><span class="line">    # 获取初始密码</span><br><span class="line">    mysql_init_passwd=$(grep &#x27;A temporary password is generated&#x27; $&#123;data_dir&#125;/mysql/mysql.err | awk &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">    # 启动服务</span><br><span class="line">    chkconfig --add mysqld</span><br><span class="line">    sudo systemctl start mysqld</span><br><span class="line">    loginfo &quot;start mysqld&quot;</span><br><span class="line"></span><br><span class="line">    # 修改密码</span><br><span class="line">    mysql --connect-expired-password -uroot -p$&#123;mysql_init_passwd&#125; -e &#x27;alter user user() identified by &quot;toortoor&quot;;&#x27; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    loginfo &quot;edit mysql root password&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_install</span><br></pre></td></tr></table></figure>

<h4 id="1-5-2-PHP通过脚本源码安装"><a href="#1-5-2-PHP通过脚本源码安装" class="headerlink" title="1.5.2 PHP通过脚本源码安装"></a>1.5.2 PHP通过脚本源码安装</h4><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cmake_version=3.22.0</span><br><span class="line">libzip_version=1.8.0</span><br><span class="line">php_version=7.4.16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否为root用户</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检查是否安装了wget</span></span><br><span class="line">   if [ `rpm -qa | grep wget | wc -l` -lt 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装依赖包</span></span><br><span class="line">   if [ ! `yum -y install gcc-c++ libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel gd net-snmp-* sqlite-devel oniguruma-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载最新版cmake</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://github.com/Kitware/CMake/releases/download/v$&#123;cmake_version&#125;/cmake-$&#123;cmake_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">      tar -xf cmake-$&#123;cmake_version&#125;.tar.gz</span><br><span class="line">      if [ ! -d cmake-$&#123;cmake_version&#125; ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;31m error:no found cmake-$&#123;cmake_version&#125;  \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      else</span><br><span class="line">         cd cmake-$&#123;cmake_version&#125;</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:Failed to download cmake-$&#123;cmake_version&#125; \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装cmake</span></span><br><span class="line">   echo &quot;cmake configure...&quot;</span><br><span class="line">   ./configure &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">      echo &quot;cmake make &amp;&amp; make install...&quot;</span><br><span class="line">      make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">      if [ `echo $?` -eq 0 ]</span><br><span class="line">      then</span><br><span class="line">         echo -e &quot;\e[1;32m cmake installed sucessfully \e[0m&quot;</span><br><span class="line">      else</span><br><span class="line">         echo -e &quot;\e[1;31m cmake installed failed \e[0m&quot;</span><br><span class="line">         exit 1</span><br><span class="line">      fi</span><br><span class="line">   else</span><br><span class="line">      echo -e &quot;\e[1;31m error:cmake configure failed \e[0m&quot;</span><br><span class="line">      exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载libzip1.1以上版本</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget --no-check-certificate https://libzip.org/download/libzip-$&#123;libzip_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar libzip...&quot;</span><br><span class="line">       tar -xf libzip-$&#123;libzip_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d libzip-$&#123;libzip_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found libzip-$&#123;libzip_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd libzip-$&#123;libzip_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download libzip-$&#123;libzip_version&#125;.tar.gz \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装libzip</span></span><br><span class="line">   mkdir build;cd build</span><br><span class="line">   echo &quot;cmake libzip...&quot;</span><br><span class="line">   cmake .. &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install libzip...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m libzip install sucessfully \e[0m&quot;</span><br><span class="line">           echo -e &#x27;/usr/local/lib64\n/usr/local/lib\n/usr/lib\n/usr/lib64&#x27;&gt;&gt; /etc/ld.so.conf</span><br><span class="line">           ldconfig -v &amp;&gt; /dev/null</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:libzip install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:lipzip cmake failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_install()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载php</span></span><br><span class="line">   cd /usr/local</span><br><span class="line">   if [ ! `wget https://www.php.net/distributions/php-$&#123;php_version&#125;.tar.bz2 &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;tar php...&quot;</span><br><span class="line">       tar -xf php-$&#123;php_version&#125;.tar.bz2</span><br><span class="line">       if [ ! -d php-$&#123;php_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found php-$&#123;php_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       else</span><br><span class="line">           cd php-$&#123;php_version&#125;</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:Failed to download php-$&#123;php_version&#125;.tar.bz2 \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">安装php</span></span><br><span class="line">   echo &quot;configure php...&quot;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">要php以apache模块运行需加上--with-apxs2=/usr/localapache/bin/apxs参数</span></span><br><span class="line">   ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-mysqli=mysqlnd --enable-pdo --with-pdo-mysql=mysqlnd --with-iconv-dir=/usr/local/ --enable-fpm --with-fpm-user=www --with-fpm-group=www --with-pcre-regex --with-zlib --with-bz2 --enable-calendar --disable-phar --with-curl --enable-dba --with-libxml-dir --enable-ftp --with-gd --with-jpeg-dir --with-png-dir --with-zlib-dir --with-freetype-dir --enable-gd-jis-conv --with-mhash --enable-mbstring --enable-opcache=yes --enable-pcntl --enable-xml --disable-rpath --enable-shmop --enable-sockets --enable-zip --enable-bcmath --with-snmp --disable-ipv6 --with-gettext --disable-rpath --disable-debug --enable-embedded-mysqli --with-mysql-sock=/var/lib/mysql/ &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;make &amp;&amp; make install php...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m php install sucessfully \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m php install failed \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m configure php failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function php_set()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -f /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service ]</span><br><span class="line">    then</span><br><span class="line">        echo -e &quot;\e[1;31m No found php-fpm.service \e[0m&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    else</span><br><span class="line">        cp /usr/local/php-$&#123;php_version&#125;/sapi/fpm/php-fpm.service /etc/systemd/system</span><br><span class="line">        if [ `echo $?` -ne 0 ]</span><br><span class="line">        then</span><br><span class="line">            echo -e &quot;\e[1;31m Copy php-fpm.service failed \e[0m&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        else</span><br><span class="line">            sed -i &#x27;/PrivateTmp=true/a\ProtectSystem=false&#x27; /etc/systemd/system/php-fpm.service</span><br><span class="line">            systemctl daemon-reload</span><br><span class="line">            echo -e &quot;\e[1;32m php set sucessfully \e[0m&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">pre</span><br><span class="line">php_install</span><br><span class="line">php_set</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置PHP</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/php/etc</span><br><span class="line">cp php-fpm.conf.default php-fpm.conf</span><br><span class="line">cp php-fpm.d/www.conf.default php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.conf</span><br><span class="line">[global]</span><br><span class="line">pid = run/php-fpm.pid</span><br><span class="line">error_log = log/php-fpm.log</span><br><span class="line">daemonize = yes</span><br><span class="line">include=/usr/local/php/etc/php-fpm.d/*.conf</span><br><span class="line"></span><br><span class="line">egrep -v &#x27;^;|^$&#x27; php-fpm.d/www.conf</span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line">listen.mode = 0660</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 5</span><br><span class="line">pm.start_servers = 2</span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line">pm.max_spare_servers = 3</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm</span><br></pre></td></tr></table></figure>

<h4 id="1-5-3-PHP作为Apache模块运行"><a href="#1-5-3-PHP作为Apache模块运行" class="headerlink" title="1.5.3 PHP作为Apache模块运行"></a>1.5.3 PHP作为Apache模块运行</h4><ol>
<li>在apache主配置文件中调用子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置子配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/php.con</span><br><span class="line">LoadModule php7_module modules/libphp7.so</span><br><span class="line">AddType application/x-httpd-php .php</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置虚拟主机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>写web目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;this is cqm web&#x27; &gt; /usr/local/apache/htdocs/web/index.html</span><br><span class="line">vim /usr/local/apache/htdocs/web/phpinfo.php</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<p><img src="/2024/02/18/web/php%E4%BB%A5%E6%A8%A1%E5%9D%97%E8%BF%90%E8%A1%8C.png" alt="php以模块运行"></p>
<h4 id="1-5-4-PHP作为独立服务运行"><a href="#1-5-4-PHP作为独立服务运行" class="headerlink" title="1.5.4 PHP作为独立服务运行"></a>1.5.4 PHP作为独立服务运行</h4><p>PHP作为独立服务运行有两种模式：</p>
<ul>
<li>TCP socket模式</li>
<li>UNIX socket模式</li>
</ul>
<p><strong>TCP socket模式</strong></p>
<ol>
<li>修改<a target="_blank" rel="noopener" href="http://www.conf文件/">www.conf文件</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = 127.0.0.1:9000</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web&quot;&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">	AllowOverride None</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">	DirectoryIndex index.php index.html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">	SetHandler &quot;proxy:fcgi://127.0.0.1:9000&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在apache主配文件添加关联</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">include conf/extra/php-fpm.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置子配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/php-fpm.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">载入需要的模块</span></span><br><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</span><br></pre></td></tr></table></figure>

<p><strong>UNIX socket模式</strong></p>
<ol>
<li>修改<a target="_blank" rel="noopener" href="http://www.conf文件/">www.conf文件</a></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/php/etc/php-fpm.d/www.conf</span><br><span class="line">listen = /usr/local/php/etc/php-fpm.socket</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置虚拟主机</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch \.php$&gt;</span><br><span class="line">        SetHandler &quot;proxy:unix:/usr/local/php/etc/php-fpm.socket|fcgi://localhost/&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-6-Apache常用模块"><a href="#1-6-Apache常用模块" class="headerlink" title="1.6 Apache常用模块"></a>1.6 Apache常用模块</h3><h4 id="1-6-1-长连接"><a href="#1-6-1-长连接" class="headerlink" title="1.6.1 长连接"></a>1.6.1 长连接</h4><p>HTTP采用TCP进行传输，是面向连接的协议，每完成一次请求就要经历以下过程：</p>
<ul>
<li>三次握手</li>
<li>发起请求</li>
<li>响应请求</li>
<li>四次挥手</li>
</ul>
<p>那么N个请求就要建立N次连接，如果希望用户能够更快的拿到数据，服务器的压力降到最低，那么靠长连接就可以解决。</p>
<p>长连接实际上就是优化了TCP连接。</p>
<p>Apache默认开启了长连接，持续时间为5秒，在httpd-default.conf中可以定义。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-default.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启长连接</span></span><br><span class="line">KeepAlive On</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">限制每个连接允许的请求数</span></span><br><span class="line">MaxKeepAliveRequests 500</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">长连接时间</span></span><br><span class="line">KeepAliveTimeout 5</span><br></pre></td></tr></table></figure>

<h4 id="1-6-2-静态缓存"><a href="#1-6-2-静态缓存" class="headerlink" title="1.6.2 静态缓存"></a>1.6.2 静态缓存</h4><p>用户每次访问网站都会将页面中的所有元素都请求一遍，全部下载后通过浏览器渲染，展示到浏览器中。但是，网站中的某些元素我们一般都是固定不变的，比如logo、框架文件等。用户每次访问都需要加载这些元素。这样做好处是保证了数据的新鲜，可是这些数据不是常变化的，很久才变化一次。每次都请求、下载浪费了用户时间和公司带宽。</p>
<p>所以我们通过静态缓存的方式，将这些不常变化的数据缓存到用户本地磁盘，用户以后再访问这些请求，直接从本地磁盘打开加载，这样的好处是加载速度快，且节约公司带宽及成本。</p>
<ol>
<li>在apache主配文件中加载缓存模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule expires_module modules/mod_expires.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle expires_module&gt;</span><br><span class="line">    #开启缓存</span><br><span class="line">    ExpiresActive on</span><br><span class="line">    #针对不同类型元素设置缓存时间</span><br><span class="line">    ExpiresByType image/gif  &quot;access plus 1 days&quot;</span><br><span class="line">    ExpiresByType image/jpeg &quot;access plus 24 hours&quot;</span><br><span class="line">    ExpiresByType image/png &quot;access plus 24 hours&quot;</span><br><span class="line">    #now 相当于 access</span><br><span class="line">    ExpiresByType text/css &quot;now plus 2 hour&quot;</span><br><span class="line">    ExpiresByType application/x-javascript &quot;now plus 2 hours&quot;</span><br><span class="line">    ExpiresByType application/x-shockwave-flash &quot;now plus 2 hours”</span><br><span class="line">    #其他数据不缓存</span><br><span class="line">    ExpiresDefault &quot;now plus 0 min&quot;</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-3-数据压缩"><a href="#1-6-3-数据压缩" class="headerlink" title="1.6.3 数据压缩"></a>1.6.3 数据压缩</h4><p>数据从服务器传输到客户端，需要传输时间，文件越大传输时间就越长，为了减少传输时间，我们一般把数据压缩后在传给客户端。</p>
<p>apache支持两种模式的压缩：</p>
<ul>
<li>default</li>
<li>gzip</li>
</ul>
<p>两者的区别：</p>
<ul>
<li>mod_deflate 压缩速度快。</li>
<li>mod_gzip 的压缩比略高。</li>
<li>一般情况下，mod_gzip 会比 mod_deflate 多出 4%~6％ 的压缩量。</li>
<li>mod_gzip 对服务器CPU的占用要高一些，所以 mod_deflate 是专门为确保服务器的性能而使用的一个压缩模块，只需较少的资源来进行压缩。</li>
</ul>
<ol>
<li>在apache主配文件中加载压缩模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule deflate_module modules/mod_deflate.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    </span><br><span class="line">    &lt;IfMoudle deflate_module&gt;</span><br><span class="line">    #压缩等级1-9，数字越大压缩能力越好，相应地也越耗CPU性能</span><br><span class="line">    DeflateCompressionLevel 4</span><br><span class="line">    #压缩类型，html、xml、php、css、js</span><br><span class="line">	AddOutputFilterByType DEFLATE text/html text/plain text/xml application/x-javascript application/x-httpd-php</span><br><span class="line">	AddOutputFilter DEFLATE js css</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">浏览器匹配为IE1-6的不压缩</span></span><br><span class="line">	BrowserMatch \bMSIE\s[1-6] dont-vary</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">设置不压缩的文件</span></span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary</span><br><span class="line">	SetEnvIfNoCase Request_URI .(?:pdf|doc)$ no-gzip dont-vary</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-4-限速"><a href="#1-6-4-限速" class="headerlink" title="1.6.4 限速"></a>1.6.4 限速</h4><p>网站除了能共享页面给用户外，还能作为下载服务器存在。但是作为下载服务器时，我们应该考虑服务器的带宽和IO的性能，防止部分邪恶分子会通过大量下载的方式来攻击你的带宽和服务器IO性能。</p>
<p>问题：</p>
<ul>
<li>假如你的服务器被邪恶分子通过下载的方式把带宽占满了，那么你或其他用户在访问的时候就会造成访问慢或者根本无法访问。</li>
<li>假如你的服务器被邪恶分子通过下载的方式把服务器IO占满了，那么你的服务器将会无法处理用户请求或宕机。</li>
</ul>
<p>以上问题可以通过限速来解决，apache自带了基于宽带限速的模块：</p>
<ul>
<li>ratelimit_module：只能对连接下载速度做限制，且是单线程的下载，迅雷等下载工具使用的是多线程下载。</li>
<li>mod_limitipconn：限制每 IP 的连接数，需要额外安装该模块。</li>
</ul>
<p><strong>ratelimit_module模块</strong></p>
<ol>
<li>在apache主配文件中加载压缩模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule ratelimit_module modules/mod_ratelimit.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Location相对路径：/usr/local/apache/htdocs/...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Directory绝对路径：...</span></span><br><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限速100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<p><strong>mod_limitipconn模块</strong></p>
<ol>
<li>下载安装模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://dominia.org/djao/limit/mod_limitipconn-0.24.tar.bz2</span><br><span class="line">tar -xf mod_limitipconn-0.24.tar.bz2</span><br><span class="line">cd mod_limitipconn-0.24</span><br><span class="line">vim Makefile</span><br><span class="line">    apxs = &quot;/usr/local/apache/bin/apxs&quot;</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在apache主配文件启用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule limitipconn_module modules/mod_limitipconn.so</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改虚拟主机文件调用模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;Location /download&gt;</span><br><span class="line">	SetOutputFiler RATE_LIMIT</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限速100k</span></span><br><span class="line">	SetEnv rate-limit 100</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">限制线程数</span></span><br><span class="line">	MaxConnPerIP 3</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">对index.html文件不作限制</span></span><br><span class="line">	NoIPLimit index.html</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-5-访问控制"><a href="#1-6-5-访问控制" class="headerlink" title="1.6.5 访问控制"></a>1.6.5 访问控制</h4><p>在生产环境中，网站分为公站和私站，公站允许所有人访问，但私站就只允许内部人员访问，Require就可以实现访问控制的功能。</p>
<p>容器：</p>
<ul>
<li>RequireAny：一个符合即可通过</li>
<li>RequireAll：所有符合才可通过</li>
<li>Requirenone：所有都不符合才可通过</li>
</ul>
<p><strong>普通的访问控制</strong></p>
<ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line">	AllowOverride None</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">拒绝所有人访问</span></span><br><span class="line">	Require all denied</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">允许该地址段的用户访问</span></span><br><span class="line">	Require ip 192.168.88</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">允许该主机访问</span></span><br><span class="line">	Require host www.cqm.com</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p><strong>用户登录验证访问控制</strong></p>
<ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;/usr/local/apache/htdocs/web/test&quot;&gt;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义提示信息，用户访问时提示信息会出现在认证的对话框中</span></span><br><span class="line">	AuthName &quot;Private&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义认证类型，在HTTP1.0中，只有一种认证类型：basic。在HTTP1.1中有几种认证类型，如：MD5</span></span><br><span class="line">	AuthType Basic</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">定义包含用户名和密码的文本文件，每行一对</span></span><br><span class="line">	AuthUserFile &quot;/usr/local/apache/user.dbm&quot;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">配合容器使用，只有条件全部符合才能通过</span></span><br><span class="line">	&lt;RequireAll&gt;</span><br><span class="line">		Require not ip 192.168.88</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　require user user1 user2 (只有用户user1和user2可以访问)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　requires <span class="built_in">groups</span> group1 (只有group1中的成员可以访问)</span></span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">　require valid-user (在AuthUserFile指定的文件中的所有用户都可以访问)</span></span><br><span class="line">		Require valid-user</span><br><span class="line">	&lt;/RequireAll&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成用户文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成cqm用户</span></span><br><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/apache/user.dbm cqm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="1-6-6-URL重写"><a href="#1-6-6-URL重写" class="headerlink" title="1.6.6 URL重写"></a>1.6.6 URL重写</h4><p>Apache通过mod_rewrite模块可以实现URL重写的功能，URL重写其实就是改写用户浏览器中的URL地址。</p>
<ol>
<li>在主配文件开启模块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/httpd.conf</span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    # 开启URL重写功能</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    # 重写规则，跳转到百度</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://www.baidu.com&quot; [NC,L]</span><br><span class="line">    # 匹配条件，根据请求头进行匹配</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;chrome&quot; [NC,OR]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;curl&quot;</span><br><span class="line">    # 重写规则，和匹配到的条件配合使用，请求头匹配到chrome或curl则返回403状态码</span><br><span class="line">    RewriteRule &quot;^/$&quot; - [F]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">RewreteRule [flag] 部分标记规则</span><br><span class="line">R:强制外部重定向</span><br><span class="line">F:禁用URL，返回403HTTP状态码</span><br><span class="line">G:强制URL为GONE，返回410HTTP状态码</span><br><span class="line">P:强制使用代理转发</span><br><span class="line">L:表明当前规则是最后一条规则，停止分析以后规则的重写</span><br><span class="line">N:重新从第一条规则开始运行重写过程</span><br><span class="line">C:与下一条规则关联</span><br><span class="line">NS:只用于不是内部子请求</span><br><span class="line">NC:不区分大小写</span><br></pre></td></tr></table></figure>

<p><strong>通过URL重写实现分流功能</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/web&quot;</span><br><span class="line">    RewriteEngine on</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(chrome|curl)&quot; [NC,OR]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://pc.cqm.com&quot; [NC]</span><br><span class="line">    RewriteCond &quot;%&#123;HTTP_USER_AGENT&#125;&quot; &quot;(iPhone|Blackberry|Android|ipad)&quot; [NC]</span><br><span class="line">    RewriteRule &quot;^/$&quot; &quot;http://phone.cqm.com&quot; [NC]</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-6-7-压力测试"><a href="#1-6-7-压力测试" class="headerlink" title="1.6.7 压力测试"></a>1.6.7 压力测试</h4><p>Apache压力测试使用ab命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ab</span><br><span class="line">-A:指定连接服务器的基本的认证凭据</span><br><span class="line">-c:指定一次向服务器发出请求数</span><br><span class="line">-C:添加cookie</span><br><span class="line">-g:将测试结果输出为“gnuolot”文件</span><br><span class="line">-h:显示帮助信息</span><br><span class="line">-H:为请求追加一个额外的头</span><br><span class="line">-i:使用“head”请求方式</span><br><span class="line">-k:激活HTTP中的“keepAlive”特性</span><br><span class="line">-n:指定测试会话使用的请求数</span><br><span class="line">-p:指定包含数据的文件</span><br><span class="line">-q:不显示进度百分比</span><br><span class="line">-T:使用POST数据时，设置内容类型头</span><br><span class="line">-v:设置详细模式等级</span><br><span class="line">-w:以HTML表格方式打印结果</span><br><span class="line">-x:以表格方式输出时，设置表格的属性</span><br><span class="line">-X:使用指定的代理服务器发送请求</span><br><span class="line">-y:以表格方式输出时，设置表格属性</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/ab -n 10000 -c 200 http:...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">并发数</span></span><br><span class="line">per second...</span><br></pre></td></tr></table></figure>



<h2 id="二、Nginx"><a href="#二、Nginx" class="headerlink" title="二、Nginx"></a>二、Nginx</h2><h3 id="2-1-Nginx介绍"><a href="#2-1-Nginx介绍" class="headerlink" title="2.1 Nginx介绍"></a>2.1 Nginx介绍</h3><p>Nginx是一款是由俄罗斯的程序设计师Igor Sysoev所开发高性能的 Web和 反向代理服务器，也是一个 IMAP&#x2F;POP3&#x2F;SMTP 代理服务器。和apache一样，都是web服务器软件，因为其性能优异，所以被广大运维喜欢。又因为nginx是一个轻量级的web服务器，相比apache来说资源消耗更低。</p>
<p>Nginx中文文档：<a target="_blank" rel="noopener" href="https://www.nginx.cn/doc/index.html">https://www.nginx.cn/doc/index.html</a></p>
<h3 id="2-2-通过脚本源码安装Nginx"><a href="#2-2-通过脚本源码安装Nginx" class="headerlink" title="2.2 通过脚本源码安装Nginx"></a>2.2 通过脚本源码安装Nginx</h3><ol>
<li>编写安装脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-install.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">nginx_version=1.21.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检测</span></span><br><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检测是否为root</span></span><br><span class="line">   if [ $USER != &quot;root&quot; ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:need to be root so that \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">检测wget是否安装</span></span><br><span class="line">   if [ ! -e /usr/bin/wget ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:not found command /usr/bin/wget \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装前准备</span></span><br><span class="line">function install_pre()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">安装依赖</span></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">0:stdin标准输入   1:stdout标准输出   2:stderr错误输出</span></span><br><span class="line">   if [ ! `yum -y install gcc-* pcre-devel zlib-devel &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;\e[1;31m error:yum install dependency package failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">下载源码包</span></span><br><span class="line">   cd /usr/local/</span><br><span class="line">   if [ ! `wget http://nginx.org/download/nginx-$&#123;nginx_version&#125;.tar.gz &amp;&gt; /dev/null` ]</span><br><span class="line">   then</span><br><span class="line">       tar -xf nginx-$&#123;nginx_version&#125;.tar.gz</span><br><span class="line">       if [ ! -d nginx-$&#123;nginx_version&#125; ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;31m error:not found nginx-$&#123;nginx_version&#125; \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:wget file nginx-$&#123;nginx_version&#125;.tar.gz failed \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">function install_nginx()</span><br><span class="line">&#123;</span><br><span class="line">   cd /usr/local/nginx-$&#123;nginx_version&#125;</span><br><span class="line">   echo &quot;nginx configure...&quot;</span><br><span class="line">   ./configure --prefix=/usr/local/nginx &amp;&gt; /dev/null</span><br><span class="line">   if [ `echo $?` -eq 0 ]</span><br><span class="line">   then</span><br><span class="line">       echo &quot;nginx make...&quot;</span><br><span class="line">       make &amp;&amp; make install &amp;&gt; /dev/null</span><br><span class="line">       if [ `echo $?` -eq 0 ]</span><br><span class="line">       then</span><br><span class="line">           echo -e &quot;\e[1;32m nginx install success \e[0m&quot;</span><br><span class="line">       else</span><br><span class="line">           echo -e &quot;\e[1;31m error:nginx install fail \e[0m&quot;</span><br><span class="line">           exit 1</span><br><span class="line">       fi</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;\e[1;31m error:nginx configure fail \e[0m&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_pre</span><br><span class="line">install_nginx</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写启动脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Source <span class="keyword">function</span> libiary</span></span><br><span class="line">if [ -f /etc/init.d/functions ]</span><br><span class="line">then</span><br><span class="line">    . /etc/init.d/functions</span><br><span class="line">else</span><br><span class="line">    echo &quot;Not found file /etc/init.d/functions&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">nginxd=/usr/local/nginx/sbin/nginx</span><br><span class="line">nginx_pid=/usr/local/nginx/logs/nginx.pid</span><br><span class="line"></span><br><span class="line">function nginx_start()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -eq 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">nginxd</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_stop()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -eq 1 ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">       exit 1</span><br><span class="line">   elif [ $nginx_num -gt 1 ]</span><br><span class="line">   then</span><br><span class="line">       killall nginx</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_status()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       echo -e &quot;nginx [\e[1;32m running \e[0m]&quot;</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_restart()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_stop</span><br><span class="line">   nginx_start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function nginx_reload()</span><br><span class="line">&#123;</span><br><span class="line">   nginx_num=`ps -ef | grep nginx | wc -l`</span><br><span class="line">   if [ $nginx_num -gt 1 ] &amp;&amp; [ -f $nginx_pid ]</span><br><span class="line">   then</span><br><span class="line">       $nginxd -s reload</span><br><span class="line">   else</span><br><span class="line">       echo -e &quot;nginx [\e[1;31m stopping \e[0m]&quot;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        nginx_start</span><br><span class="line">        echo -e &quot;nginx start [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        nginx_stop</span><br><span class="line">        echo -e &quot;nginx stop [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line">        nginx_status</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        nginx_restart</span><br><span class="line">        echo -e &quot;nginx restart [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">;;</span><br><span class="line">reload)</span><br><span class="line">        nginx_reload</span><br><span class="line">        echo -e &quot;nginx reload [\e[1;32m OK \e[0m]&quot;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Nginx的Server块"><a href="#2-3-Nginx的Server块" class="headerlink" title="2.3 Nginx的Server块"></a>2.3 Nginx的Server块</h3><p>当Nginx配置文件只有一个Server块时，那么该Server块就被Nginx认为是默认网站，所有发给Nginx的请求都会传给该Server块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">监听80端口</span></span><br><span class="line">        listen       80;</span><br><span class="line">        # 域名</span><br><span class="line">        server_name  localhost;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">字符集</span></span><br><span class="line">        charset koi8-r;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">访问日志路径</span></span><br><span class="line">        access_log  logs/host.access.log  main;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">web根路径</span></span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">/代表相对路劲，这里代表/usr/local/nginx</span></span><br><span class="line">        location / &#123;</span><br><span class="line">        	# 根目录路径，这里代表/usr/local/nginx/html</span><br><span class="line">            root   html;</span><br><span class="line">            # 索引页</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">404状态码</span></span><br><span class="line">        error_page  404              /404.html;</span><br><span class="line">        location = /404.html&#123;</span><br><span class="line">        	root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        # 50x状态码</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Nginx的访问控制"><a href="#2-4-Nginx的访问控制" class="headerlink" title="2.4 Nginx的访问控制"></a>2.4 Nginx的访问控制</h3><ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    # 允许192.168.88.0/24的用户访问</span><br><span class="line">    allow 192.168.88.0/24;</span><br><span class="line">    # 拒绝所有</span><br><span class="line">    deny all;</span><br><span class="line">    # 基于客户端IP做过滤，符合条件的允许访问，不符合的返回404</span><br><span class="line">    # 这里为不是192.168.88的就返回404</span><br><span class="line">    if ( $remote_addr !~ &quot;192.168.88&quot; )&#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-Nginx的用户验证"><a href="#2-5-Nginx的用户验证" class="headerlink" title="2.5 Nginx的用户验证"></a>2.5 Nginx的用户验证</h3><ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	root   html;</span><br><span class="line">	index  index.html index.htm;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">欢迎词</span></span><br><span class="line">	auth_basic &quot;welcome to cqm&#x27;s web&quot;;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">存放用户文件</span></span><br><span class="line">	auth_basic_user_file /usr/local/nginx/htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成用户文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache/bin/htpasswd -cm /usr/local/nginx/htpasswd cqm</span><br></pre></td></tr></table></figure>

<h3 id="2-6-Nginx参数"><a href="#2-6-Nginx参数" class="headerlink" title="2.6 Nginx参数"></a>2.6 Nginx参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx中的log_format可以用来自定义日志格式</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">log_format变量：</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_addr:记录访问网站的客户端地址</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_user:远程客户端用户名</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">time_local:记录访问时间与时区</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request:用户的http请求起始行信息</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">status:http状态码，记录请求返回的状态码，例如：200、301、404等</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">body_bytes_sent:服务器发送给客户端的响应body字节数</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_referer:记录此次请求是从哪个连接访问过来的，可以根据该参数进行防盗链设置。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_user_agent:记录客户端访问信息，例如：浏览器、手机客户端等</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_x_forwarded_for:当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置</span></span><br></pre></td></tr></table></figure>

<h3 id="2-7-Nginx防盗链"><a href="#2-7-Nginx防盗链" class="headerlink" title="2.7 Nginx防盗链"></a>2.7 Nginx防盗链</h3><p>盗链用大白话讲就是抓取别人网站的资源，加以利用，以至于被抓取资源的网站消耗了带宽，而收益的是抓取资源的人。</p>
<p>而反盗链就可以防止别人抓取自身网站的资源。</p>
<ol>
<li>编写主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    # 除了www.cqm.com之外，都返回403</span><br><span class="line">    valid_referers none blocked www.cqm.com;</span><br><span class="line">    if ($invalid_referer)&#123;</span><br><span class="line">       return 403;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-8-Nginx虚拟主机"><a href="#2-8-Nginx虚拟主机" class="headerlink" title="2.8 Nginx虚拟主机"></a>2.8 Nginx虚拟主机</h3><p>Nginx的虚拟主机是通过server块来实现的。</p>
<h4 id="2-8-1-基于IP的虚拟主机"><a href="#2-8-1-基于IP的虚拟主机" class="headerlink" title="2.8.1 基于IP的虚拟主机"></a>2.8.1 基于IP的虚拟主机</h4><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">include /usr/local/nginx/conf/conf.d/nginx_vhosts.conf;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.100;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.88.101;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>其它配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个逻辑网卡，重启即失效</span></span><br><span class="line">ifconfig eth0:1 192.168.88.100/24 up</span><br><span class="line">mkdir /usr/local/nginx/html/web&#123;1..2&#125;</span><br><span class="line">echo &#x27;this is web1&#x27; &gt; /usr/local/nginx/html/web1/index.html</span><br><span class="line">echo &#x27;this is web2&#x27; &gt; /usr/local/nginx/html/web2/index.html</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.88.100/</span><br><span class="line">this is web1</span><br><span class="line">curl http://192.168.88.101/</span><br><span class="line">this is web2</span><br></pre></td></tr></table></figure>

<h4 id="2-8-2-基于端口的虚拟主机"><a href="#2-8-2-基于端口的虚拟主机" class="headerlink" title="2.8.2 基于端口的虚拟主机"></a>2.8.2 基于端口的虚拟主机</h4><ol>
<li>修改虚拟主机文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-8-3-基于域名的虚拟主机"><a href="#2-8-3-基于域名的虚拟主机" class="headerlink" title="2.8.3 基于域名的虚拟主机"></a>2.8.3 基于域名的虚拟主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/nginx_vhosts.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm1.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web1;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm2.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html/web2;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-9-Nginx反向代理"><a href="#2-9-Nginx反向代理" class="headerlink" title="2.9 Nginx反向代理"></a>2.9 Nginx反向代理</h3><p>代理最常见的使用方式就是翻墙，能够实现让国内的用户访问国外的网站。</p>
<p>原理：</p>
<ul>
<li>用户讲请求发给代理服务器</li>
<li>代理服务器代替用户去获取数据</li>
<li>代理服务器将数据发送给用户</li>
</ul>
<p><strong>正常没有代理的上网</strong></p>
<p><img src="/2024/02/18/web/%E6%AD%A3%E5%B8%B8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="正常上网流程"></p>
<p><strong>使用代理服务器的上网</strong></p>
<p>&#x3D;<img src="/2024/02/18/web/%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%BD%91%E6%B5%81%E7%A8%8B.png" alt="使用代理服务器上网流程"></p>
<p>代理服务器又分为两种：正向代理、反向代理</p>
<p>正向代理：代理用户向服务器获取资源</p>
<p>反向代理：代理服务器去管理网络资源，用户有请求找反向代理就可以了</p>
<ol>
<li>编写反向代理服务器主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">location / &#123;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    # 访问代理服务器就会跳转到http://192.168.88.100</span><br><span class="line">    proxy_pass http://192.168.88.100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>反向代理其它配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">client_max_body_size 10m; #允许客户端请求的最大单文件字节数</span><br><span class="line"></span><br><span class="line">client_body_buffer_size 128k; #缓冲区代理缓冲用户端请求的最大字节数，</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 90; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line"></span><br><span class="line">proxy_send_timeout 90; #后端服务器数据回传时间(代理发送超时)</span><br><span class="line"></span><br><span class="line">proxy_read_timeout 90; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line"></span><br><span class="line">proxy_buffer_size 4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line"></span><br><span class="line">proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line"></span><br><span class="line">proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line"></span><br><span class="line">proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br></pre></td></tr></table></figure>

<h3 id="2-10-Nginx下载限速"><a href="#2-10-Nginx下载限速" class="headerlink" title="2.10 Nginx下载限速"></a>2.10 Nginx下载限速</h3><p>限速方法主要分为：</p>
<ul>
<li>下载速度限制</li>
<li>单位时间内请求数限制</li>
<li>基于客户端的并发数限制</li>
</ul>
<p>Nginx官方提供的限制IP连接和并发的模块有两个：</p>
<p>limit_req_zone：用来限制单位时间内的请求数，即速率限制，采用的漏桶算法</p>
<p>limit_req_conn：来限制同一时间连接数，即并发限制</p>
<p><strong>单位时间内请求数限制</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在http快下调用模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:基于ip地址做限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:创建缓存域和缓存大小</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rate:设置访问频数</span></span><br><span class="line">limit_req_zone $binary_remote_addr zone=cqm:10m rate=1r/s;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server块</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">调用模块</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">当请求数超过5次时，就拒绝访问，并返回503状态码</span></span><br><span class="line">	limit_req zone=cqm burst=5 nodelay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>限制并发连接数</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在http快下调用模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$binary_remote_addr</span>:基于ip地址做限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zone:创建缓存域和缓存大小</span></span><br><span class="line">limit_req_conn $binary_remote_addr zone=cqm:10m;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server块</span></span><br><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">限制同一时间内下载数为1个</span></span><br><span class="line">	limit_conn cqm 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>限制下载速度</strong></p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /test &#123;</span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">限制下载速度为1k</span></span><br><span class="line">	limit_rate 1k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-11-Nginx的URL重写"><a href="#2-11-Nginx的URL重写" class="headerlink" title="2.11 Nginx的URL重写"></a>2.11 Nginx的URL重写</h3><p>rewrite的主要功能是实现URL地址的重定向。Nginx的rewrite功能需要PCRE软件的支持，即通过perl兼容正则表达式语句进行规则匹配的。默认参数编译nginx就会支持rewrite的模块，但是也必须要PCRE的支持。</p>
<p>URL模板语块：</p>
<ul>
<li>set：设置变量</li>
<li>if：判断</li>
<li>return：返回值或URL</li>
<li>break：终止</li>
<li>rewrite：重定向URL</li>
</ul>
<p><strong>例一：根据不同域名跳转到主域名的不同目录下</strong></p>
<ol>
<li>创建测试目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/nginx/html/&#123;cn,jp,us&#125;</span><br><span class="line">echo &#x27;this is China&#x27; &gt; /usr/local/nginx/html/cn/index.html</span><br><span class="line">echo &#x27;this is Japan&#x27; &gt; /usr/local/nginx/html/jp/index.html</span><br><span class="line">echo &#x27;this is America&#x27; &gt; /usr/local/nginx/html/us/index.html</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改hosts文件，以便解析</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.88.100 www.cqm.com</span><br><span class="line">192.168.88.100 www.cqm.com.cn</span><br><span class="line">192.168.88.100 www.cqm.com.jp</span><br><span class="line">192.168.88.100 www.cqm.com.us</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /usr/local/nginx/conf/conf.d/rewrite.conf</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改重定向文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置重定向server</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com.cn www.cqm.com.jp www.cqm.com.us;</span><br><span class="line">    location / &#123;</span><br><span class="line">        # 模糊匹配到cn的话，就跳转到http://www.cqm.com/cn下</span><br><span class="line">        if ($http_host ~ (cn)$)&#123;</span><br><span class="line">            set $nation cn;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (jp)$)&#123;</span><br><span class="line">            set $nation jp;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($http_host ~ (us)$)&#123;</span><br><span class="line">            set $nation us;</span><br><span class="line">            rewrite ^/$ http://www.cqm.com/$nation;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://www.cqm.com.cn</span><br><span class="line">this is China</span><br><span class="line">curl -L http://www.cqm.com.jp</span><br><span class="line">this is Japan</span><br><span class="line">curl -L http://www.cqm.com.us</span><br><span class="line">this is America</span><br><span class="line">-L:自动获取重定向</span><br></pre></td></tr></table></figure>

<p><strong>例二：retuen以及break的简单实用</strong></p>
<ol>
<li>修改重定向文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/conf.d/rewrite.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.cqm.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">        # 模糊匹配 ~</span><br><span class="line">        # 精确匹配 =</span><br><span class="line">        # 不匹配 !~</span><br><span class="line">        # 如果匹配请求头不是chrome的话，就返回403</span><br><span class="line">        if ($http_user_agent !~ &#x27;chrome&#x27;)&#123;</span><br><span class="line">            return 403;</span><br><span class="line">            # break放在return上面的话就不会执行return操作</span><br><span class="line">            # break;</span><br><span class="line">            # return http://www.baidu.com;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>flag</strong></p>
<p>flag是放在rewrite重定向的URL后边的，格式为：rewrite URL flag</p>
<p>flag的选项有：</p>
<ol>
<li>last：本条规则匹配完成后继续执行到最后。</li>
<li>break：本条规则匹配完成即终止。</li>
<li>redirect：返回302临时重定向。</li>
<li>permanent：返回301永久重定向。</li>
</ol>
<p>redirect和permanent的区别：设置permanent的话，新网址就会完全继承旧网址，旧网址的排名等完全清零，如果不是暂时迁移的情况下都建议使用permanent；设置redirect的话，新网址对旧网址没有影响，且新网址也不会有排名。</p>
<h3 id="2-12-Nginx优化"><a href="#2-12-Nginx优化" class="headerlink" title="2.12 Nginx优化"></a>2.12 Nginx优化</h3><h4 id="2-12-1-大并发"><a href="#2-12-1-大并发" class="headerlink" title="2.12.1 大并发"></a>2.12.1 大并发</h4><p>Nginx的工作模式：主进程 + 工作进程</p>
<p>假如Nginx服务器有4个CPU</p>
<ol>
<li>设置主配文件来实现高并发</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">worker_processes  4;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定运行的核的编号，采用掩码的方式设置编号</span></span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br><span class="line">events &#123;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">单个工作进程维护的请求队列长度，根据实际情况调整</span></span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-2-长连接"><a href="#2-12-2-长连接" class="headerlink" title="2.12.2 长连接"></a>2.12.2 长连接</h4><ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">keepalive_timeout用来设置长连接，0代表关闭</span></span><br><span class="line">keepalive_timeout  0;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置长连接时间100s</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_timeout  100;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置每秒可以接受的请求数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keepalive_requests 8192;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-12-3-压缩"><a href="#2-12-3-压缩" class="headerlink" title="2.12.3 压缩"></a>2.12.3 压缩</h4><p>Nginx是采用gzip进行压缩。</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启缓存</span></span><br><span class="line">gzip on;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginx做为反向代理的时候启用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">off:关闭所有的代理结果数据压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">expired:如果header中包含”Expires”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-cache:如果header中包含”Cache-Control:no-cache”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no-store:如果header中包含”Cache-Control:no-store”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">private:如果header中包含”Cache-Control:private”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_last_modified:启用压缩，如果header中包含”Last_Modified”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_etag:启用压缩，如果header中包含“ETag”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">auth:启用压缩，如果header中包含“Authorization”头信息，启用压缩</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">any:无条件压缩所有结果数据</span></span><br><span class="line">gzip_proxied any;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span><br><span class="line">gzip_min_length 1k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置压缩所需要的缓冲区大小</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">32 4K表示按照内存页（one memory page）大小以4K为单位（即一个系统中内存页为4K），申请32倍的内存空间</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建议此项不设置，使用默认值</span></span><br><span class="line">gzip_buffers 32 4k;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置gzip压缩级别，级别越底压缩速度越快文件压缩比越小，反之速度越慢文件压缩比越大</span></span><br><span class="line">gzip_comp_level 1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于识别http协议的版本，早期的浏览器不支持gzip压缩，用户会看到乱码，所以为了支持前期版本加了此选项。默认在http/1.0的协议下不开启gzip压缩</span></span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置需要压缩的MIME类型,如果不在设置类型范围内的请求不进行压缩</span></span><br><span class="line">gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-4-静态缓存"><a href="#2-12-4-静态缓存" class="headerlink" title="2.12.4 静态缓存"></a>2.12.4 静态缓存</h4><p>将部分数据缓存在用户本地磁盘，用户加载时，如果本地和服务器的数据一致，则从本地加载。提升用户访问速度，提升体验度。节省公司带宽成本。</p>
<ol>
<li>修改主配文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模糊匹配以png或gif结尾的文件</span></span><br><span class="line">location ~*  \.(png|gif)$ &#123;</span><br><span class="line">    # 缓存时间为1小时</span><br><span class="line">    expires 1h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="三、Tomcat"><a href="#三、Tomcat" class="headerlink" title="三、Tomcat"></a>三、Tomcat</h2><h3 id="3-1-Tomcat介绍"><a href="#3-1-Tomcat介绍" class="headerlink" title="3.1 Tomcat介绍"></a>3.1 Tomcat介绍</h3><p>Tomcat 服务器是一个免费的开放源代码的 Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试 JSP 程序的首选。</p>
<p>实际上 Tomcat 是 Apache 服务器的扩展，但运行时它是独立运行的，所以当你运行 tomcat 时，它实际上作为一个与 Apache 独立的进程单独运行的。</p>
<p>Tomcat 官方文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/">https://tomcat.apache.org/</a></p>
<h3 id="3-2-Tomcat安装"><a href="#3-2-Tomcat安装" class="headerlink" title="3.2 Tomcat安装"></a>3.2 Tomcat安装</h3><ol>
<li>安装jdk和tomcat</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk*</span><br><span class="line">wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.43/bin/apache-tomcat-9.0.43.tar.gz</span><br><span class="line">tar -xf apache-tomcat-9.0.43.tar.gz</span><br><span class="line">mkdir /root/tomcat</span><br><span class="line">mv apache-tomcat-9.0.43.tar.gz/* /root/tomcat</span><br><span class="line">./root/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>

</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/3/">Previous</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/page/5/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link is-current" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/NUX_Octodex.gif" alt="Warner"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">16</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cqmmm/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-11T09:15:48.000Z">2024-03-11</time></p><p class="title"><a href="/2024/03/11/Pod%E6%98%AF%E6%80%8E%E4%B9%88%E8%AF%9E%E7%94%9F%E7%9A%84/">Pod是怎么诞生的</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-29T05:08:36.000Z">2024-02-29</time></p><p class="title"><a href="/2024/02/29/%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85containerd%E5%92%8Cnerdctl/">快速安装containerd和nerdctl</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T09:39:48.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/%E9%A6%96%E9%A1%B5/">首页</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/ansible/">Ansible</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-18T08:06:41.000Z">2024-02-18</time></p><p class="title"><a href="/2024/02/18/cisco/">Cisco</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/containerd/"><span class="tag">containerd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">首页</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2024 Warner</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/cqmmm/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>